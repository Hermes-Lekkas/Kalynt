# Kalynt v1.0.3-beta Release Notes

**Release Date:** February 3, 2026

## Overview

This release focuses entirely on fixing critical team collaboration issues that prevented users from properly sharing workspaces and communicating via encrypted chat.

---

## Bug Fixes

### 1. Workspace Name Not Shared

**Symptom:** When User A shared their workspace "test" with User B, User B would join a workspace called "Shared Space" instead.

**Root Cause:** The invite link only contained the room ID (UUID), not the workspace name. The join code hardcoded `'Shared Space'` as the name.

**Solution:**
- Invite links now include the workspace name in the URL fragment: `kalynt://join/{roomId}#n={encodedName}`
- The fragment is client-side only (never sent to servers) for privacy
- When joining, the workspace name is extracted and used

**Files Changed:**
- `apps/desktop/src/services/p2pService.ts` - `generateRoomLink()` and `parseRoomLink()` updated
- `apps/desktop/src/components/CollaborationPanel.tsx` - `InviteView` passes workspace name, `JoinView` uses it

---

### 2. Chat Messages Appearing Encrypted

**Symptom:** Messages sent in the collaboration chat appeared as encrypted gibberish on the receiver's end instead of readable text.

**Root Cause:** The encryption system uses a salt combined with the password to derive the encryption key via PBKDF2. Each peer was independently generating their own random 16-byte salt, resulting in:
- User A: derives key with Salt A
- User B: derives key with Salt B
- Different salts → Different keys → User B cannot decrypt User A's messages

**Solution:**
Implemented salt sharing via the Yjs awareness protocol:

1. **Room Creator (First Peer):**
   - Generates a random salt
   - Initializes encryption with that salt
   - Broadcasts salt via `awareness.setLocalStateField('roomSalt', ...)`

2. **Joiner (Second Peer):**
   - Connects to the room
   - Waits briefly (500ms) for awareness sync
   - Checks if any existing peer has broadcast a salt
   - If salt received → uses that salt for key derivation
   - If no salt → generates own and broadcasts (becomes the "creator")

3. **Late Joiners:**
   - Listen for salt via awareness change events
   - Adopt the first received salt

**Files Changed:**
- `apps/desktop/src/hooks/useYjs.ts` - Complete rewrite of encryption initialization flow

---

### 3. Connection Race Condition

**Symptom:** Even when both users entered the same password, they sometimes couldn't see each other's messages or files.

**Root Cause:** In the join flow, the password was stored in localStorage AFTER calling `setCurrentSpace()`. This triggered a React re-render, which caused `useYDoc` to attempt connection before the password was available.

Result:
- User A: connects to room `kalynt-abc123#password`
- User B: connects to room `kalynt-abc123` (no password suffix)
- Different rooms = no shared data

**Solution:**
Moved `localStorage.setItem()` to execute BEFORE `setCurrentSpace()`:

```typescript
// BEFORE (buggy):
setCurrentSpace(newSpace)
localStorage.setItem(`space-settings-${spaceId}`, ...)

// AFTER (fixed):
localStorage.setItem(`space-settings-${spaceId}`, ...)
setCurrentSpace(newSpace)
```

**Files Changed:**
- `apps/desktop/src/components/CollaborationPanel.tsx` - `handleJoin()` reordered

---

## Technical Details

### Encryption Flow (After Fix)

```
┌─────────────────────────────────────────────────────────────────┐
│                        ROOM CREATOR                             │
├─────────────────────────────────────────────────────────────────┤
│ 1. Connect to room (kalynt-{spaceId}#{password})               │
│ 2. Wait 500ms for awareness sync                                │
│ 3. No peers found → Generate random salt                        │
│ 4. Initialize encryption: PBKDF2(password, salt) → AES key     │
│ 5. Broadcast salt via awareness.setLocalStateField('roomSalt') │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                          JOINER                                 │
├─────────────────────────────────────────────────────────────────┤
│ 1. Store password in localStorage                               │
│ 2. Connect to room (same name as creator)                       │
│ 3. Wait 500ms for awareness sync                                │
│ 4. Check awareness states for 'roomSalt' from other peers      │
│ 5. Salt found → Use it; Not found → Generate own               │
│ 6. Initialize encryption with shared salt                       │
│ 7. Broadcast salt (confirms adoption or shares new)            │
└─────────────────────────────────────────────────────────────────┘
```

### Link Format

**Before:**
```
kalynt://join/abc123-def456-789
```

**After:**
```
kalynt://join/abc123-def456-789#n=My%20Workspace
```

With password (sent separately):
```
kalynt://join/abc123-def456-789#p=secretpass&n=My%20Workspace
```

---

## TURN Servers

TURN servers were verified to be working correctly. No changes were needed.

Current configuration:
- 5 Google STUN servers for NAT discovery
- OpenRelay TURN servers (ports 80, 443, and TCP) for relay
- Environment variable support for custom TURN servers (`VITE_TURN_*`)

---

## Upgrade Notes

This is a client-side update. Users should:
1. Update to v1.0.3-beta
2. Generate new invite links (old links without workspace name still work, but will show "Shared Space")
3. Both users must be on v1.0.3-beta for salt sharing to work

---

## Known Limitations

- The 500ms wait for awareness sync may not be sufficient on very slow networks
- If a peer goes offline and comes back, they may need to rejoin to resync the salt
- Workspace name in URL is URL-encoded, so special characters are supported but may look ugly in the link
