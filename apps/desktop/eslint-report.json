[{"filePath":"C:\\Kalynt\\apps\\desktop\\electron\\handlers\\app-info.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\electron\\handlers\\build.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ProblemPattern' is defined but never used. Allowed unused vars must match /^_/u.","line":14,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":17,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ProblemPattern"},"fix":{"range":[313,331],"text":""},"desc":"Remove unused variable \"ProblemPattern\"."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":43,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":43,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[1198,1249],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":72,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":72,"endColumn":22,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[2185,2239],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":410,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":410,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[10933,10978],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'getWorkspacePath' is defined but never used. Allowed unused args must match /^_/u.","line":598,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":598,"endColumn":19},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":605,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":605,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16245,16248],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16245,16248],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":606,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":606,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[16258,16303],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":621,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":621,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16783,16786],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16783,16786],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":622,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":622,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[16796,16844],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":632,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":632,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17105,17108],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17105,17108],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":633,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":633,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[17118,17163],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":9,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\nimport { ipcMain, BrowserWindow } from 'electron';\nimport { spawn, ChildProcessWithoutNullStreams } from 'child_process';\nimport * as fs from 'fs';\nimport * as path from 'path';\nimport {\n  Task,\n  TasksConfiguration,\n  TaskExecution,\n  Problem,\n  ProblemMatcher,\n  ProblemPattern,\n} from '../../src/types/tasks';\n\ninterface RunningTask {\n  process: ChildProcessWithoutNullStreams;\n  execution: TaskExecution;\n}\n\nclass BuildTaskManager {\n  private runningTasks: Map<string, RunningTask> = new Map();\n  private taskIdCounter = 0;\n\n  /**\n   * Load tasks.json from workspace\n   */\n  async loadTasksConfiguration(workspacePath: string): Promise<TasksConfiguration | null> {\n    const tasksJsonPath = path.join(workspacePath, '.vscode', 'tasks.json');\n\n    if (!fs.existsSync(tasksJsonPath)) {\n      return null;\n    }\n\n    try {\n      const content = fs.readFileSync(tasksJsonPath, 'utf-8');\n      // Remove comments (simple approach, doesn't handle all cases)\n      const jsonContent = content.replace(/\\/\\*[\\s\\S]*?\\*\\/|\\/\\/.*/g, '');\n      const config: TasksConfiguration = JSON.parse(jsonContent);\n      return config;\n    } catch (error) {\n      console.error('Failed to load tasks.json:', error);\n      return null;\n    }\n  }\n\n  /**\n   * Auto-detect tasks from common build files\n   */\n  async autoDetectTasks(workspacePath: string): Promise<Task[]> {\n    const detectedTasks: Task[] = [];\n\n    // Detect npm/yarn scripts\n    const packageJsonPath = path.join(workspacePath, 'package.json');\n    if (fs.existsSync(packageJsonPath)) {\n      try {\n        const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, 'utf-8'));\n        if (packageJson.scripts) {\n          for (const [scriptName, scriptCommand] of Object.entries(packageJson.scripts)) {\n            detectedTasks.push({\n              label: `npm: ${scriptName}`,\n              type: 'npm',\n              command: scriptName,\n              detail: scriptCommand as string,\n              group: this.inferTaskGroup(scriptName),\n              problemMatcher: this.inferProblemMatcher(scriptName),\n            });\n          }\n        }\n      } catch (error) {\n        console.error('Failed to parse package.json:', error);\n      }\n    }\n\n    // Detect Cargo (Rust)\n    const cargoTomlPath = path.join(workspacePath, 'Cargo.toml');\n    if (fs.existsSync(cargoTomlPath)) {\n      detectedTasks.push(\n        {\n          label: 'cargo: build',\n          type: 'shell',\n          command: 'cargo',\n          args: ['build'],\n          group: { kind: 'build', isDefault: true },\n          problemMatcher: '$rustc',\n        },\n        {\n          label: 'cargo: test',\n          type: 'shell',\n          command: 'cargo',\n          args: ['test'],\n          group: 'test',\n          problemMatcher: '$rustc',\n        },\n        {\n          label: 'cargo: run',\n          type: 'shell',\n          command: 'cargo',\n          args: ['run'],\n        }\n      );\n    }\n\n    // Detect Go\n    const goModPath = path.join(workspacePath, 'go.mod');\n    if (fs.existsSync(goModPath)) {\n      detectedTasks.push(\n        {\n          label: 'go: build',\n          type: 'shell',\n          command: 'go',\n          args: ['build', '-v', './...'],\n          group: { kind: 'build', isDefault: true },\n          problemMatcher: '$go',\n        },\n        {\n          label: 'go: test',\n          type: 'shell',\n          command: 'go',\n          args: ['test', '-v', './...'],\n          group: 'test',\n        }\n      );\n    }\n\n    // Detect Maven (Java)\n    const pomXmlPath = path.join(workspacePath, 'pom.xml');\n    if (fs.existsSync(pomXmlPath)) {\n      detectedTasks.push(\n        {\n          label: 'maven: clean install',\n          type: 'shell',\n          command: 'mvn',\n          args: ['clean', 'install'],\n          group: { kind: 'build', isDefault: true },\n        },\n        {\n          label: 'maven: test',\n          type: 'shell',\n          command: 'mvn',\n          args: ['test'],\n          group: 'test',\n        }\n      );\n    }\n\n    // Detect Gradle (Java/Kotlin)\n    const gradleFiles = ['build.gradle', 'build.gradle.kts'];\n    const hasGradle = gradleFiles.some((file) =>\n      fs.existsSync(path.join(workspacePath, file))\n    );\n    if (hasGradle) {\n      const gradleCmd = process.platform === 'win32' ? 'gradlew.bat' : './gradlew';\n      detectedTasks.push(\n        {\n          label: 'gradle: build',\n          type: 'shell',\n          command: gradleCmd,\n          args: ['build'],\n          group: { kind: 'build', isDefault: true },\n        },\n        {\n          label: 'gradle: test',\n          type: 'shell',\n          command: gradleCmd,\n          args: ['test'],\n          group: 'test',\n        }\n      );\n    }\n\n    // Detect Make\n    const makefilePath = path.join(workspacePath, 'Makefile');\n    if (fs.existsSync(makefilePath)) {\n      detectedTasks.push(\n        {\n          label: 'make: build',\n          type: 'shell',\n          command: 'make',\n          group: { kind: 'build', isDefault: true },\n          problemMatcher: '$gcc',\n        },\n        {\n          label: 'make: clean',\n          type: 'shell',\n          command: 'make',\n          args: ['clean'],\n          group: 'clean',\n        }\n      );\n    }\n\n    // Detect CMake\n    const cmakePath = path.join(workspacePath, 'CMakeLists.txt');\n    if (fs.existsSync(cmakePath)) {\n      detectedTasks.push(\n        {\n          label: 'cmake: configure',\n          type: 'shell',\n          command: 'cmake',\n          args: ['-B', 'build', '-S', '.'],\n        },\n        {\n          label: 'cmake: build',\n          type: 'shell',\n          command: 'cmake',\n          args: ['--build', 'build'],\n          group: { kind: 'build', isDefault: true },\n          problemMatcher: '$gcc',\n        }\n      );\n    }\n\n    return detectedTasks;\n  }\n\n  /**\n   * Get all tasks (auto-detected + configured)\n   */\n  async getAllTasks(workspacePath: string): Promise<Task[]> {\n    const autoDetected = await this.autoDetectTasks(workspacePath);\n    const config = await this.loadTasksConfiguration(workspacePath);\n\n    if (config && config.tasks) {\n      // Merge, with configured tasks taking precedence\n      const configuredLabels = new Set(config.tasks.map((t) => t.label));\n      const filteredAutoDetected = autoDetected.filter(\n        (t) => !configuredLabels.has(t.label)\n      );\n      return [...config.tasks, ...filteredAutoDetected];\n    }\n\n    return autoDetected;\n  }\n\n  /**\n   * Execute a task\n   */\n  async executeTask(\n    task: Task,\n    workspacePath: string,\n    window: BrowserWindow\n  ): Promise<string> {\n    const taskId = `task-${++this.taskIdCounter}`;\n\n    const execution: TaskExecution = {\n      taskId,\n      taskLabel: task.label,\n      startTime: Date.now(),\n      problems: [],\n    };\n\n    // Resolve command and args\n    let command = task.command;\n    let args = task.args || [];\n    let shell = true;\n\n    if (task.type === 'npm') {\n      command = process.platform === 'win32' ? 'npm.cmd' : 'npm';\n      args = ['run', task.command, ...args];\n      shell = false;\n    }\n\n    // Resolve working directory\n    const cwd = task.options?.cwd\n      ? path.resolve(workspacePath, task.options.cwd)\n      : workspacePath;\n\n    // Resolve environment variables\n    const env = {\n      ...process.env,\n      ...task.options?.env,\n    };\n\n    // Send start message\n    window.webContents.send('build:output', {\n      taskId,\n      type: 'start',\n      data: `\\x1b[1m> Executing task: ${task.label}\\x1b[0m\\n`,\n    });\n\n    // Spawn process\n    const childProcess = spawn(command, args, {\n      cwd,\n      env,\n      shell,\n      windowsHide: true,\n    });\n\n    execution.processId = childProcess.pid;\n\n    // Store running task\n    this.runningTasks.set(taskId, {\n      process: childProcess,\n      execution,\n    });\n\n    // Create problem matcher\n    const problemMatcher = this.createProblemMatcher(task.problemMatcher);\n\n    // Handle stdout\n    childProcess.stdout.on('data', (data: Buffer) => {\n      const output = data.toString();\n      window.webContents.send('build:output', {\n        taskId,\n        type: 'stdout',\n        data: output,\n      });\n\n      // Parse problems\n      if (problemMatcher) {\n        const problems = this.parseProblems(output, problemMatcher, workspacePath);\n        execution.problems.push(...problems);\n        if (problems.length > 0) {\n          window.webContents.send('build:problems', {\n            taskId,\n            problems: execution.problems,\n          });\n        }\n      }\n    });\n\n    // Handle stderr\n    childProcess.stderr.on('data', (data: Buffer) => {\n      const output = data.toString();\n      window.webContents.send('build:output', {\n        taskId,\n        type: 'stderr',\n        data: output,\n      });\n\n      // Parse problems from stderr too\n      if (problemMatcher) {\n        const problems = this.parseProblems(output, problemMatcher, workspacePath);\n        execution.problems.push(...problems);\n        if (problems.length > 0) {\n          window.webContents.send('build:problems', {\n            taskId,\n            problems: execution.problems,\n          });\n        }\n      }\n    });\n\n    // Handle process exit\n    childProcess.on('close', (code) => {\n      execution.endTime = Date.now();\n      execution.exitCode = code ?? undefined;\n\n      const duration = ((execution.endTime - execution.startTime) / 1000).toFixed(2);\n      const status = code === 0 ? '\\x1b[32mâœ“\\x1b[0m' : '\\x1b[31mâœ—\\x1b[0m';\n\n      window.webContents.send('build:output', {\n        taskId,\n        type: 'end',\n        data: `\\n${status} Task \"${task.label}\" ${\n          code === 0 ? 'completed successfully' : `failed with exit code ${code}`\n        } (${duration}s)\\n`,\n      });\n\n      window.webContents.send('build:end', {\n        taskId,\n        exitCode: code,\n        problems: execution.problems,\n      });\n\n      this.runningTasks.delete(taskId);\n    });\n\n    childProcess.on('error', (error) => {\n      window.webContents.send('build:output', {\n        taskId,\n        type: 'error',\n        data: `\\x1b[31mError: ${error.message}\\x1b[0m\\n`,\n      });\n\n      window.webContents.send('build:end', {\n        taskId,\n        exitCode: 1,\n        problems: execution.problems,\n      });\n\n      this.runningTasks.delete(taskId);\n    });\n\n    return taskId;\n  }\n\n  /**\n   * Kill a running task\n   */\n  killTask(taskId: string): boolean {\n    const runningTask = this.runningTasks.get(taskId);\n    if (!runningTask) {\n      return false;\n    }\n\n    try {\n      if (process.platform === 'win32') {\n        // On Windows, use taskkill to kill the entire process tree\n        spawn('taskkill', ['/pid', runningTask.process.pid!.toString(), '/f', '/t']);\n      } else {\n        // On Unix, kill the process group\n        process.kill(-runningTask.process.pid!, 'SIGTERM');\n      }\n      this.runningTasks.delete(taskId);\n      return true;\n    } catch (error) {\n      console.error('Failed to kill task:', error);\n      return false;\n    }\n  }\n\n  /**\n   * Create problem matcher from configuration\n   */\n  private createProblemMatcher(\n    matcher: string | string[] | ProblemMatcher | ProblemMatcher[] | undefined\n  ): ProblemMatcher | null {\n    if (!matcher) return null;\n\n    // Handle built-in problem matchers\n    if (typeof matcher === 'string') {\n      return this.getBuiltInProblemMatcher(matcher);\n    }\n\n    // Handle array of matchers (use first one for simplicity)\n    if (Array.isArray(matcher)) {\n      if (matcher.length === 0) return null;\n      const first = matcher[0];\n      if (typeof first === 'string') {\n        return this.getBuiltInProblemMatcher(first);\n      }\n      return first;\n    }\n\n    return matcher;\n  }\n\n  /**\n   * Get built-in problem matchers\n   */\n  private getBuiltInProblemMatcher(name: string): ProblemMatcher | null {\n    const matchers: Record<string, ProblemMatcher> = {\n      '$tsc': {\n        owner: 'typescript',\n        pattern: {\n          regexp: '^([^\\\\s].*?)\\\\((\\\\d+),(\\\\d+)\\\\):\\\\s+(error|warning|info)\\\\s+(TS\\\\d+)\\\\s*:\\\\s*(.*)$',\n          file: 1,\n          line: 2,\n          column: 3,\n          severity: 4,\n          code: 5,\n          message: 6,\n        },\n      },\n      '$eslint-compact': {\n        owner: 'eslint',\n        pattern: {\n          regexp: '^(.+?):\\\\s+line\\\\s+(\\\\d+),\\\\s+col\\\\s+(\\\\d+),\\\\s+(Error|Warning)\\\\s+-\\\\s+(.+?)\\\\s+\\\\((.+?)\\\\)$',\n          file: 1,\n          line: 2,\n          column: 3,\n          severity: 4,\n          message: 5,\n          code: 6,\n        },\n      },\n      '$rustc': {\n        owner: 'rustc',\n        pattern: {\n          regexp: '^(error|warning|help|note)(?:\\\\[(.+?)\\\\])?:\\\\s+(.+)$',\n          severity: 1,\n          code: 2,\n          message: 3,\n        },\n      },\n      '$cargo': {\n        owner: 'cargo',\n        pattern: {\n          regexp: '^\\\\s*(error|warning):\\\\s+(.+)$',\n          severity: 1,\n          message: 2,\n        },\n      },\n      '$gcc': {\n        owner: 'gcc',\n        pattern: {\n          regexp: '^(.+?):(\\\\d+):(\\\\d+):\\\\s+(error|warning|note):\\\\s+(.+)$',\n          file: 1,\n          line: 2,\n          column: 3,\n          severity: 4,\n          message: 5,\n        },\n      },\n      '$go': {\n        owner: 'go',\n        pattern: {\n          regexp: '^(.+?):(\\\\d+):(\\\\d+)?:?\\\\s+(.+)$',\n          file: 1,\n          line: 2,\n          column: 3,\n          message: 4,\n        },\n      },\n    };\n\n    return matchers[name] || null;\n  }\n\n  /**\n   * Parse problems from output using problem matcher\n   */\n  private parseProblems(\n    output: string,\n    matcher: ProblemMatcher,\n    workspacePath: string\n  ): Problem[] {\n    const problems: Problem[] = [];\n    const pattern = matcher.pattern;\n\n    if (!pattern || Array.isArray(pattern)) {\n      // Multi-line patterns not implemented yet\n      return problems;\n    }\n\n    const lines = output.split('\\n');\n    const regex = new RegExp(pattern.regexp);\n\n    for (const line of lines) {\n      const match = regex.exec(line);\n      if (!match) continue;\n\n      const problem: Problem = {\n        file: pattern.file ? match[pattern.file] : 'unknown',\n        line: pattern.line ? parseInt(match[pattern.line], 10) : 1,\n        column: pattern.column ? parseInt(match[pattern.column], 10) : 1,\n        severity: this.parseSeverity(\n          pattern.severity ? match[pattern.severity] : 'error'\n        ),\n        message: pattern.message ? match[pattern.message] : line,\n        code: pattern.code ? match[pattern.code] : undefined,\n        source: matcher.owner,\n      };\n\n      // Resolve relative file paths\n      if (problem.file && !path.isAbsolute(problem.file)) {\n        problem.file = path.join(workspacePath, problem.file);\n      }\n\n      problems.push(problem);\n    }\n\n    return problems;\n  }\n\n  /**\n   * Parse severity from string\n   */\n  private parseSeverity(severity: string): 'error' | 'warning' | 'info' {\n    const lower = severity.toLowerCase();\n    if (lower.includes('error')) return 'error';\n    if (lower.includes('warning')) return 'warning';\n    return 'info';\n  }\n\n  /**\n   * Infer task group from task name\n   */\n  private inferTaskGroup(taskName: string): string | undefined {\n    const lower = taskName.toLowerCase();\n    if (lower.includes('build') || lower === 'compile') return 'build';\n    if (lower.includes('test')) return 'test';\n    if (lower.includes('clean')) return 'clean';\n    return undefined;\n  }\n\n  /**\n   * Infer problem matcher from task name\n   */\n  private inferProblemMatcher(taskName: string): string | undefined {\n    const lower = taskName.toLowerCase();\n    if (lower.includes('tsc') || lower.includes('typescript')) return '$tsc';\n    if (lower.includes('eslint')) return '$eslint-compact';\n    if (lower.includes('build') && lower.includes('rust')) return '$rustc';\n    return undefined;\n  }\n}\n\n// Singleton instance\nconst buildTaskManager = new BuildTaskManager();\n\nexport function setupBuildHandlers(\n  ipc: typeof ipcMain,\n  getMainWindow: () => BrowserWindow | null,\n  getWorkspacePath: () => string | null\n) {\n  // Get all tasks\n  ipc.handle('build:getTasks', async (_, workspacePath: string) => {\n    try {\n      const tasks = await buildTaskManager.getAllTasks(workspacePath);\n      return { success: true, tasks };\n    } catch (error: any) {\n      console.error('Failed to get tasks:', error);\n      return { success: false, error: error.message };\n    }\n  });\n\n  // Execute a task\n  ipc.handle('build:executeTask', async (_, task: Task, workspacePath: string) => {\n    try {\n      const mainWindow = getMainWindow();\n      if (!mainWindow) {\n        return { success: false, error: 'Main window not available' };\n      }\n\n      const taskId = await buildTaskManager.executeTask(task, workspacePath, mainWindow);\n      return { success: true, taskId };\n    } catch (error: any) {\n      console.error('Failed to execute task:', error);\n      return { success: false, error: error.message };\n    }\n  });\n\n  // Kill a task\n  ipc.handle('build:killTask', async (_, taskId: string) => {\n    try {\n      const success = buildTaskManager.killTask(taskId);\n      return { success };\n    } catch (error: any) {\n      console.error('Failed to kill task:', error);\n      return { success: false, error: error.message };\n    }\n  });\n}\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\electron\\handlers\\code-execution.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'execSync' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":39,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"execSync"},"fix":{"range":[122,132],"text":""},"desc":"Remove unused variable \"execSync\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'localAppData' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":41,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":41,"endColumn":23},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":104,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":104,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[3650,3707],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":116,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":116,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[4067,4123],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":122,"column":34,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":122,"endColumn":63},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":133,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":133,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[4742,4795],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":212,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":212,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[8195,8253],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":221,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":221,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[8430,8481],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":260,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":260,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[10003,10127],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":273,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":273,"endColumn":30,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[10625,10687],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":282,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":282,"endColumn":34,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[11076,11139],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":576,"column":35,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":576,"endColumn":54},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":604,"column":118,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":604,"endColumn":121,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[21989,21992],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[21989,21992],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":611,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":611,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[22192,22267],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-async-promise-executor","severity":2,"message":"Promise executor functions should not be async.","line":617,"column":36,"nodeType":"Identifier","messageId":"async","endLine":617,"endColumn":41},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'compileOutput' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":618,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":618,"endColumn":38},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":744,"column":25,"nodeType":"MemberExpression","messageId":"unexpected","endLine":744,"endColumn":38,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[29033,29113],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":885,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":885,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[34840,34891],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":892,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":892,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[35059,35113],"text":""},"desc":"Remove the console.log()."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":13,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/*\n * SPDX-License-Identifier: AGPL-3.0-only\n */\n\nimport path from 'path'\nimport fs from 'fs'\nimport { spawn, ChildProcess, execSync } from 'child_process'\nimport type { BrowserWindow as BrowserWindowType } from 'electron'\nimport treeKill from 'tree-kill'\n\n// Stateful map for running processes\nconst runningProcesses = new Map<string, ChildProcess>()\n\n// Binary path cache for faster subsequent executions\n// Maps binary name -> resolved path (or null if not found)\nconst binaryPathCache = new Map<string, string | null>()\n\n// Path validation helper - prevents path traversal attacks\nfunction validatePath(base: string, target: string): string {\n    const resolvedTarget = path.resolve(base, target)\n    if (!resolvedTarget.startsWith(path.resolve(base))) {\n        throw new Error('Path traversal detected')\n    }\n    return resolvedTarget\n}\n\n/**\n * Get enhanced PATH with common development tool locations\n * Ensures tools like cargo, rustc, etc. are found even if not in system PATH\n */\nfunction getEnhancedPATH(): string {\n    const currentPath = process.env.PATH || ''\n\n    if (process.platform !== 'win32') {\n        return currentPath\n    }\n\n    const userProfile = process.env.USERPROFILE || 'C:\\\\Users\\\\Default'\n    const programFiles = process.env['ProgramFiles'] || 'C:\\\\Program Files'\n    const appData = process.env.APPDATA || `${userProfile}\\\\AppData\\\\Roaming`\n    const localAppData = process.env.LOCALAPPDATA || `${userProfile}\\\\AppData\\\\Local`\n\n    const additionalPaths = [\n        // Python\n        `${userProfile}\\\\AppData\\\\Local\\\\Programs\\\\Python\\\\Python313`,\n        `${userProfile}\\\\AppData\\\\Local\\\\Programs\\\\Python\\\\Python313\\\\Scripts`,\n        `${userProfile}\\\\AppData\\\\Local\\\\Programs\\\\Python\\\\Python312`,\n        `${userProfile}\\\\AppData\\\\Local\\\\Programs\\\\Python\\\\Python312\\\\Scripts`,\n        `${userProfile}\\\\AppData\\\\Local\\\\Programs\\\\Python\\\\Python311`,\n        `${userProfile}\\\\AppData\\\\Local\\\\Programs\\\\Python\\\\Python311\\\\Scripts`,\n\n        // Rust/Cargo\n        `${userProfile}\\\\.cargo\\\\bin`,\n\n        // Node.js / npm\n        `${programFiles}\\\\nodejs`,\n        `${appData}\\\\npm`,\n\n        // Java\n        `${programFiles}\\\\Java\\\\jdk-21\\\\bin`,\n        `${programFiles}\\\\Eclipse Adoptium\\\\jdk-21\\\\bin`,\n\n        // Go\n        `${userProfile}\\\\go\\\\bin`,\n        `${programFiles}\\\\Go\\\\bin`,\n\n        // Git\n        `${programFiles}\\\\Git\\\\cmd`,\n        `${programFiles}\\\\Git\\\\bin`,\n    ]\n\n    let enhancedPath = currentPath\n    for (const p of additionalPaths) {\n        if (fs.existsSync(p) && !enhancedPath.toLowerCase().includes(p.toLowerCase())) {\n            enhancedPath = `${p};${enhancedPath}`\n        }\n    }\n\n    return enhancedPath\n}\n\n/**\n * Find a binary in the system PATH or common locations.\n * Uses caching to avoid repeated filesystem lookups.\n * @param name Binary name (e.g., 'tsx', 'node', 'python')\n * @param workspacePath Optional workspace path to check local node_modules/.bin\n * @returns Resolved path or null if not found\n */\nasync function findBinary(name: string, workspacePath?: string | null): Promise<string | null> {\n    // Check cache first\n    const cacheKey = workspacePath ? `${name}:${workspacePath}` : name\n    if (binaryPathCache.has(cacheKey)) {\n        return binaryPathCache.get(cacheKey)!\n    }\n\n    const isWindows = process.platform === 'win32'\n    const ext = isWindows ? '.cmd' : ''\n\n    // Priority 1: Check workspace-local node_modules/.bin (fastest for project tools)\n    if (workspacePath) {\n        const localBin = path.join(workspacePath, 'node_modules', '.bin', name + ext)\n        try {\n            await fs.promises.access(localBin, fs.constants.X_OK)\n            console.log(`[CodeExec] Found local binary: ${localBin}`)\n            binaryPathCache.set(cacheKey, localBin)\n            return localBin\n        } catch {\n            // Not found locally, continue\n        }\n    }\n\n    // Priority 2: Try to find in PATH using where/which\n    try {\n        // SECURITY FIX: Validate binary name to prevent command injection\n        if (!/^[a-zA-Z0-9._-]+$/.test(name)) {\n            console.error(`[CodeExec] Invalid binary name: ${name}`)\n            return null\n        }\n\n        const cmd = isWindows ? 'where' : 'which'\n        // SECURITY FIX: Use execFileSync instead of execSync to avoid shell interpolation\n        const { execFileSync } = require('node:child_process')\n        const result = execFileSync(cmd, [name + ext], {\n            encoding: 'utf8',\n            timeout: 2000,\n            stdio: ['pipe', 'pipe', 'pipe']\n        }).trim()\n\n        if (result) {\n            // 'where' on Windows can return multiple lines, take the first\n            const firstPath = result.split('\\n')[0].trim()\n            if (firstPath) {\n                console.log(`[CodeExec] Found in PATH: ${firstPath}`)\n                binaryPathCache.set(cacheKey, firstPath)\n                return firstPath\n            }\n        }\n    } catch {\n        // Not found in PATH\n    }\n\n    // Priority 3: Check common global npm/node locations AND language-specific paths\n    const userProfile = process.env.USERPROFILE || 'C:\\\\Users\\\\Default'\n    const localAppData = process.env.LOCALAPPDATA || `${userProfile}\\\\AppData\\\\Local`\n    const appData = process.env.APPDATA || `${userProfile}\\\\AppData\\\\Roaming`\n    const programFiles = process.env.ProgramFiles || 'C:\\\\Program Files'\n\n    const commonPaths = isWindows\n        ? [\n            // npm paths\n            path.join(appData, 'npm', name + ext),\n            path.join(localAppData, 'npm', name + ext),\n\n            // Python paths (check both python and py)\n            ...(name === 'python' || name === 'python3' ? [\n                path.join(localAppData, 'Programs', 'Python', 'Python314', 'python.exe'),\n                path.join(localAppData, 'Programs', 'Python', 'Python312', 'python.exe'),\n                path.join(localAppData, 'Programs', 'Python', 'Python311', 'python.exe'),\n                path.join(localAppData, 'Programs', 'Python', 'Python310', 'python.exe'),\n                path.join(programFiles, 'Python314', 'python.exe'),\n                path.join(programFiles, 'Python312', 'python.exe'),\n                path.join(programFiles, 'Python311', 'python.exe'),\n                'C:\\\\Python314\\\\python.exe',\n                'C:\\\\Python312\\\\python.exe',\n                'C:\\\\Python311\\\\python.exe',\n            ] : []),\n\n            // Rust / Cargo\n            ...(name === 'rustc' || name === 'cargo' ? [\n                path.join(userProfile, '.cargo', 'bin', name + '.exe'),\n            ] : []),\n\n            // Java\n            ...(name === 'java' || name === 'javac' ? [\n                path.join(programFiles, 'Java', 'jdk-21', 'bin', name + '.exe'),\n                path.join(programFiles, 'Eclipse Adoptium', 'jdk-21', 'bin', name + '.exe'),\n                path.join(programFiles, 'Microsoft', 'jdk-17', 'bin', name + '.exe'),\n            ] : []),\n\n            // Go\n            ...(name === 'go' ? [\n                path.join(programFiles, 'Go', 'bin', 'go.exe'),\n                path.join(userProfile, 'go', 'bin', 'go.exe'),\n            ] : []),\n\n            // Node.js\n            ...(name === 'node' || name === 'npm' || name === 'npx' ? [\n                path.join(programFiles, 'nodejs', name + '.exe'),\n                path.join(programFiles, 'nodejs', name + '.cmd'),\n            ] : []),\n        ]\n        : [\n            `/usr/local/bin/${name}`,\n            `/usr/bin/${name}`,\n            path.join(process.env.HOME || '', '.npm-global', 'bin', name),\n            path.join(process.env.HOME || '', '.nvm', 'current', 'bin', name),\n            // Python on Unix\n            ...(name === 'python' || name === 'python3' ? [\n                '/usr/bin/python3',\n                '/usr/local/bin/python3',\n                path.join(process.env.HOME || '', '.pyenv', 'shims', 'python'),\n            ] : []),\n            // Rust on Unix\n            ...(name === 'rustc' || name === 'cargo' ? [\n                path.join(process.env.HOME || '', '.cargo', 'bin', name),\n            ] : []),\n        ]\n\n    for (const binPath of commonPaths) {\n        try {\n            await fs.promises.access(binPath, fs.constants.X_OK)\n            console.log(`[CodeExec] Found at common path: ${binPath}`)\n            binaryPathCache.set(cacheKey, binPath)\n            return binPath\n        } catch {\n            // Continue checking\n        }\n    }\n\n    // Not found anywhere\n    console.log(`[CodeExec] Binary not found: ${name}`)\n    binaryPathCache.set(cacheKey, null)\n    return null\n}\n\n/**\n * Wrap command for Windows .cmd/.bat files\n * On Windows with shell:false, .cmd files must be run through cmd.exe\n */\nfunction wrapWindowsCommand(command: string, args: string[]): { command: string; args: string[] } {\n    if (process.platform === 'win32' && (command.endsWith('.cmd') || command.endsWith('.bat'))) {\n        return {\n            command: process.env.COMSPEC || 'cmd.exe',\n            args: ['/d', '/s', '/c', command, ...args]\n        }\n    }\n    return { command, args }\n}\n\n/**\n * Get the best TypeScript runner available.\n * Priority: tsx (fastest) -> ts-node with --transpile-only -> ts-node -> npx ts-node (slowest)\n */\nasync function getTypeScriptRunner(workspacePath?: string | null): Promise<{ command: string; args: string[]; usesNpx: boolean }> {\n    // Try tsx first (5-10x faster than ts-node, uses esbuild)\n    const tsxPath = await findBinary('tsx', workspacePath)\n    if (tsxPath) {\n        const wrapped = wrapWindowsCommand(tsxPath, [])\n        return { command: wrapped.command, args: wrapped.args, usesNpx: false }\n    }\n\n    // Try ts-node with --transpile-only (skips type checking, faster)\n    const tsNodePath = await findBinary('ts-node', workspacePath)\n    if (tsNodePath) {\n        const wrapped = wrapWindowsCommand(tsNodePath, ['--transpile-only'])\n        return { command: wrapped.command, args: wrapped.args, usesNpx: false }\n    }\n\n    // Fallback to npx (slowest but always available if npm is installed)\n    console.log('[CodeExec] Warning: Using npx ts-node fallback (slower). Consider installing tsx globally: npm install -g tsx')\n    const npx = process.platform === 'win32' ? 'npx.cmd' : 'npx'\n    const wrapped = wrapWindowsCommand(npx, ['--yes', 'tsx'])\n    return { command: wrapped.command, args: wrapped.args, usesNpx: true }\n}\n\n// Helper to kill process tree (including children)\nfunction killProcessTree(proc: ChildProcess): Promise<void> {\n    if (!proc.pid) return Promise.resolve()\n\n    return new Promise<void>((resolve) => {\n        treeKill(proc.pid!, 'SIGKILL', (err) => {\n            if (err) {\n                console.error('[Main] tree-kill failed, using fallback:', err)\n                // Fallback to platform-specific methods\n                try {\n                    if (process.platform === 'win32') {\n                        spawn('taskkill', ['/pid', String(proc.pid), '/f', '/t'])\n                    } else {\n                        process.kill(-proc.pid!, 'SIGKILL')\n                    }\n                } catch (fallbackErr) {\n                    console.error('[Main] Fallback kill also failed:', fallbackErr)\n                    proc.kill('SIGKILL')\n                }\n            }\n            resolve()\n        })\n    })\n}\n\n/**\n * Get the optimal command and args for a given language.\n * Uses binary caching and smart fallbacks for performance.\n */\nasync function getLanguageCommand(\n    normalizedLang: string,\n    tempFile: string,\n    tempDir: string,\n    workspacePath?: string | null\n): Promise<{ command: string; args: string[]; postCompileRun?: string; postCompileArgs?: string[] } | null> {\n    const isWindows = process.platform === 'win32'\n\n    switch (normalizedLang) {\n        case 'javascript':\n        case 'node': {\n            const nodePath = await findBinary('node', workspacePath) || 'node'\n            return { command: nodePath, args: [tempFile] }\n        }\n\n        case 'typescript': {\n            const tsRunner = await getTypeScriptRunner(workspacePath)\n            return {\n                command: tsRunner.command,\n                args: [...tsRunner.args, tempFile]\n            }\n        }\n\n        case 'python': {\n            // Try python3 first (more explicit), then python\n            const python3 = await findBinary('python3', workspacePath)\n            const python = await findBinary('python', workspacePath)\n            const pythonCmd = python3 || python || (isWindows ? 'python' : 'python3')\n            return { command: pythonCmd, args: [tempFile] }\n        }\n\n        case 'deno': {\n            const denoPath = await findBinary('deno', workspacePath) || 'deno'\n            // Security: Use minimal permissions instead of --allow-all\n            return {\n                command: denoPath,\n                args: [\n                    'run',\n                    '--allow-read',  // Allow reading files (for imports)\n                    '--allow-write', // Allow writing to stdout/stderr\n                    tempFile\n                ]\n            }\n        }\n\n        case 'bun': {\n            const bunPath = await findBinary('bun', workspacePath) || 'bun'\n            return { command: bunPath, args: ['run', tempFile] }\n        }\n\n        case 'rust': {\n            const rustcPath = await findBinary('rustc', workspacePath) || 'rustc'\n            const rustBinary = path.join(tempDir, `kalynt_run${isWindows ? '.exe' : ''}`)\n\n            // BUG #2: Use array args instead of shell string to prevent injection\n            return {\n                command: rustcPath,\n                args: [tempFile, '-o', rustBinary],\n                postCompileRun: rustBinary\n            }\n        }\n\n        case 'go': {\n            const goPath = await findBinary('go', workspacePath) || 'go'\n            return { command: goPath, args: ['run', tempFile] }\n        }\n\n        case 'java': {\n            const javacPath = await findBinary('javac', workspacePath) || 'javac'\n            return {\n                command: javacPath,\n                args: [tempFile],\n                postCompileRun: 'java',\n                postCompileArgs: ['-cp', tempDir, 'Main']\n            }\n        }\n\n        case 'dotnet':\n        case 'csharp': {\n            const dotnetPath = await findBinary('dotnet', workspacePath) || 'dotnet'\n            return { command: dotnetPath, args: ['script', tempFile] }\n        }\n\n        case 'fsharp': {\n            const dotnetPath = await findBinary('dotnet', workspacePath) || 'dotnet'\n            return { command: dotnetPath, args: ['fsi', tempFile] }\n        }\n\n        case 'ruby': {\n            const rubyPath = await findBinary('ruby', workspacePath) || 'ruby'\n            return { command: rubyPath, args: [tempFile] }\n        }\n\n        case 'php': {\n            const phpPath = await findBinary('php', workspacePath) || 'php'\n            return { command: phpPath, args: [tempFile] }\n        }\n\n        case 'c':\n        case 'gcc': {\n            const gccPath = await findBinary('gcc', workspacePath) || 'gcc'\n            const binaryPath = path.join(tempDir, `kalynt_run${isWindows ? '.exe' : ''}`)\n            return {\n                command: gccPath,\n                args: [tempFile, '-o', binaryPath],\n                postCompileRun: binaryPath\n            }\n        }\n\n        case 'cpp': {\n            const gppPath = await findBinary('g++', workspacePath) || 'g++'\n            const binaryPath = path.join(tempDir, `kalynt_run${isWindows ? '.exe' : ''}`)\n            return {\n                command: gppPath,\n                args: [tempFile, '-o', binaryPath],\n                postCompileRun: binaryPath\n            }\n        }\n\n        case 'kotlin': {\n            const kotlinPath = await findBinary('kotlin', workspacePath) || 'kotlin'\n            return { command: kotlinPath, args: [tempFile] }\n        }\n\n        case 'swift': {\n            const swiftPath = await findBinary('swift', workspacePath) || 'swift'\n            return { command: swiftPath, args: [tempFile] }\n        }\n\n        case 'scala': {\n            const scalaPath = await findBinary('scala', workspacePath) || 'scala'\n            return { command: scalaPath, args: [tempFile] }\n        }\n\n        case 'perl': {\n            const perlPath = await findBinary('perl', workspacePath) || 'perl'\n            return { command: perlPath, args: [tempFile] }\n        }\n\n        case 'lua': {\n            const luaPath = await findBinary('lua', workspacePath) || 'lua'\n            return { command: luaPath, args: [tempFile] }\n        }\n\n        case 'haskell': {\n            const runghcPath = await findBinary('runghc', workspacePath) || 'runghc'\n            return { command: runghcPath, args: [tempFile] }\n        }\n\n        case 'elixir': {\n            const elixirPath = await findBinary('elixir', workspacePath) || 'elixir'\n            return { command: elixirPath, args: [tempFile] }\n        }\n\n        case 'r': {\n            const rscriptPath = await findBinary('Rscript', workspacePath) || 'Rscript'\n            return { command: rscriptPath, args: [tempFile] }\n        }\n\n        case 'julia': {\n            const juliaPath = await findBinary('julia', workspacePath) || 'julia'\n            return { command: juliaPath, args: [tempFile] }\n        }\n\n        case 'dart': {\n            const dartPath = await findBinary('dart', workspacePath) || 'dart'\n            return { command: dartPath, args: ['run', tempFile] }\n        }\n\n        case 'zig': {\n            const zigPath = await findBinary('zig', workspacePath) || 'zig'\n            return { command: zigPath, args: ['run', tempFile] }\n        }\n\n        case 'clojure': {\n            const clojurePath = await findBinary('clojure', workspacePath) || 'clojure'\n            return { command: clojurePath, args: [tempFile] }\n        }\n\n        case 'groovy': {\n            const groovyPath = await findBinary('groovy', workspacePath) || 'groovy'\n            return { command: groovyPath, args: [tempFile] }\n        }\n\n        case 'ocaml': {\n            const ocamlPath = await findBinary('ocaml', workspacePath) || 'ocaml'\n            return { command: ocamlPath, args: [tempFile] }\n        }\n\n        case 'erlang': {\n            const escriptPath = await findBinary('escript', workspacePath) || 'escript'\n            return { command: escriptPath, args: [tempFile] }\n        }\n\n        case 'v': {\n            const vPath = await findBinary('v', workspacePath) || 'v'\n            return { command: vPath, args: ['run', tempFile] }\n        }\n\n        case 'nim': {\n            const nimPath = await findBinary('nim', workspacePath) || 'nim'\n            return { command: nimPath, args: ['compile', '--run', '--hints:off', tempFile] }\n        }\n\n        case 'html':\n            // HTML is handled separately (opens in browser)\n            return null\n\n        default:\n            return null\n    }\n}\n\n/**\n * Get the file extension for a given language\n */\nfunction getFileExtension(language: string): string {\n    const extensions: Record<string, string> = {\n        javascript: '.js',\n        node: '.js',\n        typescript: '.ts',\n        python: '.py',\n        deno: '.ts',\n        bun: '.js',\n        rust: '.rs',\n        go: '.go',\n        java: '.java',\n        dotnet: '.cs',\n        csharp: '.cs',\n        fsharp: '.fsx',\n        ruby: '.rb',\n        php: '.php',\n        c: '.c',\n        gcc: '.c',\n        cpp: '.cpp',\n        kotlin: '.kt',\n        swift: '.swift',\n        scala: '.scala',\n        perl: '.pl',\n        lua: '.lua',\n        haskell: '.hs',\n        elixir: '.exs',\n        r: '.r',\n        julia: '.jl',\n        dart: '.dart',\n        zig: '.zig',\n        clojure: '.clj',\n        groovy: '.groovy',\n        ocaml: '.ml',\n        erlang: '.erl',\n        v: '.v',\n        nim: '.nim',\n        html: '.html'\n    }\n    return extensions[language] || '.txt'\n}\n\nexport function registerCodeExecutionHandlers(\n    ipcMain: Electron.IpcMain,\n    app: Electron.App,\n    getMainWindow: () => BrowserWindowType | null,\n    getCurrentWorkspacePath: () => string | null\n) {\n    // Execute code in a temporary file\n    ipcMain.handle('code:execute', async (_event, options: {\n        id: string\n        code: string\n        language: string\n        cwd?: string\n    }) => {\n        const startTime = Date.now()\n        try {\n            const { id, code, language, cwd } = options\n            const tempDir = app.getPath('temp')\n            const normalizedLang = language.toLowerCase()\n            const currentWorkspacePath = getCurrentWorkspacePath()\n\n            // Handle HTML specially (open in browser)\n            if (normalizedLang === 'html') {\n                const tempFile = path.join(tempDir, `kalynt_${id}.html`)\n                await fs.promises.writeFile(tempFile, code)\n                const { shell } = require('electron')\n                try {\n                    await shell.openExternal(`file://${tempFile}`)\n                    return {\n                        success: true,\n                        stdout: `HTML file opened in browser: ${tempFile}`,\n                        stderr: '',\n                        exitCode: 0\n                    }\n                } catch (err) {\n                    return {\n                        success: false,\n                        error: `Failed to open HTML file: ${err instanceof Error ? err.message : String(err)}`\n                    }\n                }\n            }\n\n            // Get file extension and create temp file\n            const ext = getFileExtension(normalizedLang)\n            // Java requires specific filename\n            const tempFile = normalizedLang === 'java'\n                ? path.join(tempDir, 'Main.java')\n                : path.join(tempDir, `kalynt_${id}${ext}`)\n\n            // Write code to temp file\n            await fs.promises.writeFile(tempFile, code)\n\n            // Get the optimal command for this language\n            const langCommand = await getLanguageCommand(normalizedLang, tempFile, tempDir, currentWorkspacePath) as any\n\n            if (!langCommand) {\n                return { success: false, error: `Unsupported language: ${language}` }\n            }\n\n            const setupTime = Date.now() - startTime\n            console.log(`[CodeExec] Setup completed in ${setupTime}ms for ${language}`)\n\n            const mainWindow = getMainWindow()\n\n            // BUG #2: Handle compilation + execution separately\n            if (langCommand.postCompileRun) {\n                return new Promise(async (resolve) => {\n                    let compileOutput = ''\n                    // Wrap Windows .cmd files for compilation\n                    const wrappedCompile = wrapWindowsCommand(langCommand.command, langCommand.args)\n                    const compileProc = spawn(wrappedCompile.command, wrappedCompile.args, {\n                        cwd: tempDir,\n                        shell: false,\n                        env: {\n                            ...process.env,\n                            PATH: getEnhancedPATH()\n                        }\n                    })\n\n                    // BUG #8: Add to running processes\n                    runningProcesses.set(`${id}_compile`, compileProc)\n\n                    compileProc.stdout?.on('data', (data) => {\n                        const output = data.toString()\n                        compileOutput += output\n                        mainWindow?.webContents.send('code:output', { id, type: 'stdout', data: output })\n                    })\n\n                    compileProc.stderr?.on('data', (data) => {\n                        const output = data.toString()\n                        compileOutput += output\n                        mainWindow?.webContents.send('code:output', { id, type: 'stderr', data: output })\n                    })\n\n                    compileProc.on('error', (err) => {\n                        runningProcesses.delete(`${id}_compile`)\n                        resolve({ success: false, error: `Compilation error: ${err.message}` })\n                    })\n\n                    compileProc.on('close', async (code) => {\n                        runningProcesses.delete(`${id}_compile`)\n                        if (code !== 0) {\n                            resolve({ success: false, error: 'Compilation failed', exitCode: code })\n                            return\n                        }\n\n                        // Now run the compiled binary\n                        const runCommand = langCommand.postCompileRun\n                        const runArgs = langCommand.postCompileArgs || []\n                        // Wrap Windows .cmd files for execution\n                        const wrappedRun = wrapWindowsCommand(runCommand, runArgs)\n                        const proc = spawn(wrappedRun.command, wrappedRun.args, {\n                            cwd: tempDir,\n                            shell: false,\n                            env: {\n                                ...process.env,\n                                PATH: getEnhancedPATH()\n                            }\n                        })\n\n                        runningProcesses.set(id, proc)\n\n                        let stdout = ''\n                        let stderr = ''\n\n                        // BUG FIX: Add 5-minute timeout for the runner (was missing!)\n                        const RUN_TIMEOUT = 300000 // 5 minutes\n                        const runTimer = setTimeout(async () => {\n                            if (runningProcesses.has(id)) {\n                                await killProcessTree(proc)\n                                runningProcesses.delete(id)\n                                mainWindow?.webContents.send('code:output', { id, type: 'stderr', data: '\\nProcess timed out (5 min)\\n' })\n                                mainWindow?.webContents.send('code:exit', { id, exitCode: 1 })\n                                try { fs.unlinkSync(tempFile) } catch { /* ignore */ }\n                                resolve({ success: false, error: 'Execution timed out (5 min)' })\n                            }\n                        }, RUN_TIMEOUT)\n\n                        proc.stdout?.on('data', (data) => {\n                            const output = data.toString()\n                            stdout += output\n                            mainWindow?.webContents.send('code:output', { id, type: 'stdout', data: output })\n                        })\n\n                        proc.stderr?.on('data', (data) => {\n                            const output = data.toString()\n                            stderr += output\n                            mainWindow?.webContents.send('code:output', { id, type: 'stderr', data: output })\n                        })\n\n                        proc.on('close', async (exitCode) => {\n                            clearTimeout(runTimer) // Clear timeout on normal completion\n                            runningProcesses.delete(id)\n                            try { await fs.promises.unlink(tempFile) } catch { /* ignore */ }\n                            mainWindow?.webContents.send('code:exit', { id, exitCode })\n                            resolve({ success: true, stdout, stderr, exitCode })\n                        })\n\n                        proc.on('error', (error) => {\n                            clearTimeout(runTimer) // Clear timeout on error\n                            runningProcesses.delete(id)\n                            const errorMsg = `Error spawning compiled binary: ${error.message}\\n`\n                            mainWindow?.webContents.send('code:output', { id, type: 'stderr', data: errorMsg })\n                            mainWindow?.webContents.send('code:exit', { id, exitCode: 1 })\n                            resolve({ success: false, error: error.message })\n                        })\n                    })\n\n                    // 30 second timeout for COMPILATION only\n                    // (Runner has its own 5-minute timeout defined above)\n                    setTimeout(() => {\n                        if (runningProcesses.has(`${id}_compile`)) {\n                            compileProc.kill('SIGKILL')\n                            runningProcesses.delete(`${id}_compile`)\n                            mainWindow?.webContents.send('code:output', { id, type: 'stderr', data: '\\nCompilation timed out (30s)\\n' })\n                            mainWindow?.webContents.send('code:exit', { id, exitCode: 1 })\n                            resolve({ success: false, error: 'Compilation timed out (30s)' })\n                        }\n                    }, 30000)\n                })\n            }\n\n            // Direct execution (no compilation)\n            return new Promise((resolve) => {\n                let stdout = ''\n                let stderr = ''\n                let safeCwd = cwd || tempDir\n                const { command, args } = langCommand\n\n                if (cwd && currentWorkspacePath) {\n                    try {\n                        safeCwd = validatePath(currentWorkspacePath, cwd)\n                    } catch (e) {\n                        console.error('[Main] Invalid CWD for code execution, falling back to temp:', e)\n                        safeCwd = tempDir\n                    }\n                }\n\n                // Wrap Windows .cmd files\n                const wrapped = wrapWindowsCommand(command, args)\n\n                const proc = spawn(wrapped.command, wrapped.args, {\n                    cwd: safeCwd,\n                    shell: false,\n                    env: {\n                        ...process.env,\n                        PATH: getEnhancedPATH(),\n                        NODE_NO_WARNINGS: '1',\n                        NO_UPDATE_NOTIFIER: '1'\n                    }\n                })\n\n                runningProcesses.set(id, proc)\n\n                proc.stdout?.on('data', (data) => {\n                    const output = data.toString()\n                    stdout += output\n                    mainWindow?.webContents.send('code:output', { id, type: 'stdout', data: output })\n                })\n\n                proc.stderr?.on('data', (data) => {\n                    const output = data.toString()\n                    stderr += output\n                    mainWindow?.webContents.send('code:output', { id, type: 'stderr', data: output })\n                })\n\n                proc.on('close', async (exitCode) => {\n                    // BUG #8: Clean up process map\n                    runningProcesses.delete(id)\n                    try { await fs.promises.unlink(tempFile) } catch { /* ignore */ }\n                    mainWindow?.webContents.send('code:exit', { id, exitCode })\n                    resolve({ success: true, stdout, stderr, exitCode })\n                })\n\n                proc.on('error', (error) => {\n                    // BUG #8: Clean up process map\n                    runningProcesses.delete(id)\n                    const errorMsg = `Error spawning ${language}: ${error.message}\\n`\n                    mainWindow?.webContents.send('code:output', { id, type: 'stderr', data: errorMsg })\n                    mainWindow?.webContents.send('code:exit', { id, exitCode: 1 })\n                    resolve({ success: false, error: error.message })\n                })\n\n                // 5 minute timeout (can be killed manually before this)\n                setTimeout(() => {\n                    if (runningProcesses.has(id)) {\n                        proc.kill('SIGKILL')\n                        runningProcesses.delete(id)\n                        try { fs.unlinkSync(tempFile) } catch { /* ignore */ }\n                        resolve({ success: false, error: 'Execution timed out (5 min)' })\n                    }\n                }, 300000)\n            })\n        } catch (error) {\n            return { success: false, error: String(error) }\n        }\n    })\n\n    // Run a shell command (with allowlist)\n    ipcMain.handle('code:runCommand', async (_event, cwd: string, commandString: string) => {\n        try {\n            const ALLOWED = [\n                'npm', 'git', 'node', 'python', 'ls', 'dir', 'echo', 'cat', 'type',\n                'pip', 'python3', 'yarn', 'pnpm', 'npx', 'tsc', 'vite', 'tsx', 'bun'\n            ]\n            const [cmd, ...args] = commandString.trim().split(/\\s+/)\n            if (!ALLOWED.includes(cmd)) {\n                return { success: false, error: `Command '${cmd}' is not in the allowlist.` }\n            }\n\n            let safeCwd = cwd\n            const currentWorkspacePath = getCurrentWorkspacePath()\n            if (currentWorkspacePath) {\n                try {\n                    safeCwd = validatePath(currentWorkspacePath, cwd)\n                } catch (_e) {\n                    return { success: false, error: 'Invalid Working Directory' }\n                }\n            }\n\n            // Try to find the optimal binary path\n            const binaryPath = await findBinary(cmd, currentWorkspacePath)\n            let executable = binaryPath || cmd\n\n            // Windows: add .cmd extension for npm packages\n            if (process.platform === 'win32' && !binaryPath) {\n                if (['npm', 'npx', 'yarn', 'pnpm', 'tsc', 'vite', 'tsx'].includes(cmd)) {\n                    executable = cmd + '.cmd'\n                }\n            }\n\n            return new Promise((resolve) => {\n                const proc = spawn(executable, args, {\n                    cwd: safeCwd,\n                    shell: false,\n                    env: {\n                        ...process.env,\n                        NO_UPDATE_NOTIFIER: '1'\n                    }\n                })\n                let output = ''\n                proc.stdout?.on('data', (data) => output += data.toString())\n                proc.stderr?.on('data', (data) => output += data.toString())\n                proc.on('close', (code) => {\n                    resolve({ success: code === 0, output })\n                })\n                proc.on('error', (err) => {\n                    resolve({ success: false, error: err.message })\n                })\n                // 30 second timeout\n                setTimeout(async () => {\n                    await killProcessTree(proc)\n                    resolve({ success: false, error: 'Command timed out' })\n                }, 30000)\n            })\n        } catch (_err) {\n            return { success: false, error: String(_err) }\n        }\n    })\n\n    // Kill a running process\n    ipcMain.handle('code:kill', async (_event, id: string) => {\n        const proc = runningProcesses.get(id)\n        if (proc) {\n            await killProcessTree(proc)\n            runningProcesses.delete(id)\n            return { success: true }\n        }\n        return { success: false, error: 'Process not found' }\n    })\n\n    // Clear binary cache (useful if user installs new tools)\n    ipcMain.handle('code:clearBinaryCache', async () => {\n        binaryPathCache.clear()\n        console.log('[CodeExec] Binary path cache cleared')\n        return { success: true }\n    })\n\n    // BUG #10: Clear both caches\n    ipcMain.handle('code:clearCache', async () => {\n        binaryPathCache.clear()\n        console.log('[CodeExec] Code execution cache cleared')\n        return { success: true }\n    })\n}\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\electron\\handlers\\debug.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'DebugSessionState' is defined but never used. Allowed unused vars must match /^_/u.","line":14,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":20,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"DebugSessionState"},"fix":{"range":[337,358],"text":""},"desc":"Remove unused variable \"DebugSessionState\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Scope' is defined but never used. Allowed unused vars must match /^_/u.","line":17,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":17,"endColumn":8,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Scope"},"fix":{"range":[384,393],"text":""},"desc":"Remove unused variable \"Scope\"."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":53,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":53,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[1503,1555],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":93,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":93,"endColumn":22,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[2819,2873],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'mainPy' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":102,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":102,"endColumn":19},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":231,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":231,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6814,6817],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6814,6817],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'window' is defined but never used. Allowed unused args must match /^_/u.","line":247,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":247,"endColumn":11},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":326,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":326,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[9212,9267],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":334,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":334,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[9439,9492],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-constant-condition","severity":2,"message":"Unexpected constant condition.","line":343,"column":12,"nodeType":"Literal","messageId":"unexpected","endLine":343,"endColumn":16},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":363,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":363,"endColumn":22,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[10451,10504],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":423,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":423,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12171,12174],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12171,12174],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":594,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":594,"endColumn":22,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[16673,16730],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":641,"column":84,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":641,"endColumn":87,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17823,17826],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17823,17826],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":680,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":680,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19201,19204],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19201,19204],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":680,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":680,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19207,19210],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19207,19210],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":690,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":690,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19590,19593],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19590,19593],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'getWorkspacePath' is defined but never used. Allowed unused args must match /^_/u.","line":709,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":709,"endColumn":19},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":716,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":716,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20328,20331],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20328,20331],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":717,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":717,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[20341,20401],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":739,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":739,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[21030,21033],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[21030,21033],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":740,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":740,"endColumn":22,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[21045,21100],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":751,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":751,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[21381,21384],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[21381,21384],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":752,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":752,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[21394,21448],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":764,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":764,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[21807,21810],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[21807,21810],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":765,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":765,"endColumn":22,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[21822,21873],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":776,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":776,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[22180,22183],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[22180,22183],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":785,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":785,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[22464,22467],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[22464,22467],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":794,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":794,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[22748,22751],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[22748,22751],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":803,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":803,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[23030,23033],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[23030,23033],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":812,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":812,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[23308,23311],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[23308,23311],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":822,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":822,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[23649,23652],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[23649,23652],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":837,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":837,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[24055,24058],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[24055,24058],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":850,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":850,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[24443,24446],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[24443,24446],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":28,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\n * SPDX-License-Identifier: AGPL-3.0-only\n */\nimport { ipcMain, BrowserWindow } from 'electron';\nimport { spawn, ChildProcessWithoutNullStreams } from 'child_process';\nimport * as fs from 'fs';\nimport * as path from 'path';\nimport * as net from 'net';\nimport {\n  DebugConfiguration,\n  LaunchConfiguration,\n  Breakpoint,\n  DebugSession,\n  DebugSessionState,\n  StackFrame,\n  Variable,\n  Scope,\n  DAPRequest,\n  DAPResponse,\n  DAPEvent,\n} from '../../src/types/debug';\n\ninterface DebugAdapter {\n  process?: ChildProcessWithoutNullStreams;\n  socket?: net.Socket;\n  messageBuffer: string;\n  sequenceNumber: number;\n  pendingRequests: Map<number, { resolve: (response: DAPResponse) => void; reject: (error: Error) => void }>;\n}\n\nclass DebugSessionManager {\n  private sessions: Map<string, DebugSession> = new Map();\n  private adapters: Map<string, DebugAdapter> = new Map();\n  private sessionIdCounter = 0;\n\n  /**\n   * Load launch.json from workspace\n   */\n  async loadLaunchConfiguration(workspacePath: string): Promise<LaunchConfiguration | null> {\n    const launchJsonPath = path.join(workspacePath, '.vscode', 'launch.json');\n\n    if (!fs.existsSync(launchJsonPath)) {\n      return null;\n    }\n\n    try {\n      const content = fs.readFileSync(launchJsonPath, 'utf-8');\n      // Remove comments (simple approach)\n      const jsonContent = content.replace(/\\/\\*[\\s\\S]*?\\*\\/|\\/\\/.*/g, '');\n      const config: LaunchConfiguration = JSON.parse(jsonContent);\n      return config;\n    } catch (error) {\n      console.error('Failed to load launch.json:', error);\n      return null;\n    }\n  }\n\n  /**\n   * Auto-detect debug configurations\n   */\n  async autoDetectConfigurations(workspacePath: string): Promise<DebugConfiguration[]> {\n    const configs: DebugConfiguration[] = [];\n\n    // Detect Node.js/TypeScript\n    const packageJsonPath = path.join(workspacePath, 'package.json');\n    if (fs.existsSync(packageJsonPath)) {\n      try {\n        const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, 'utf-8'));\n        const mainFile = packageJson.main || 'index.js';\n\n        configs.push({\n          type: 'node',\n          request: 'launch',\n          name: 'Launch Node.js Program',\n          program: '${workspaceFolder}/' + mainFile,\n          skipFiles: ['<node_internals>/**'],\n        });\n\n        // Check for TypeScript\n        const tsconfigPath = path.join(workspacePath, 'tsconfig.json');\n        if (fs.existsSync(tsconfigPath)) {\n          configs.push({\n            type: 'node',\n            request: 'launch',\n            name: 'Launch TypeScript Program',\n            program: '${workspaceFolder}/src/index.ts',\n            runtimeArgs: ['-r', 'ts-node/register'],\n            skipFiles: ['<node_internals>/**'],\n            sourceMaps: true,\n          });\n        }\n      } catch (error) {\n        console.error('Failed to parse package.json:', error);\n      }\n    }\n\n    // Detect Python\n    const pythonFiles = fs\n      .readdirSync(workspacePath)\n      .filter((f) => f.endsWith('.py') && f !== '__init__.py');\n    if (pythonFiles.length > 0) {\n      const mainPy = pythonFiles.find((f) => f === 'main.py') || pythonFiles[0];\n      configs.push({\n        type: 'debugpy',\n        request: 'launch',\n        name: 'Python: Current File',\n        program: '${file}',\n        console: 'integratedTerminal',\n      });\n    }\n\n    // Detect Rust\n    const cargoTomlPath = path.join(workspacePath, 'Cargo.toml');\n    if (fs.existsSync(cargoTomlPath)) {\n      configs.push({\n        type: 'lldb',\n        request: 'launch',\n        name: 'Debug Rust',\n        program: '${workspaceFolder}/target/debug/${workspaceFolderBasename}',\n        args: [],\n        cwd: '${workspaceFolder}',\n        preLaunchTask: 'cargo build',\n      });\n    }\n\n    // Detect Go\n    const goModPath = path.join(workspacePath, 'go.mod');\n    if (fs.existsSync(goModPath)) {\n      configs.push({\n        type: 'delve',\n        request: 'launch',\n        name: 'Launch Go Program',\n        mode: 'debug',\n        program: '${workspaceFolder}',\n      });\n    }\n\n    // Detect C/C++\n    const cppFiles = fs\n      .readdirSync(workspacePath)\n      .filter((f) => f.endsWith('.cpp') || f.endsWith('.c') || f.endsWith('.cc'));\n    if (cppFiles.length > 0) {\n      configs.push({\n        type: 'cppdbg',\n        request: 'launch',\n        name: 'Debug C/C++',\n        program: '${workspaceFolder}/a.out',\n        args: [],\n        cwd: '${workspaceFolder}',\n        MIMode: process.platform === 'darwin' ? 'lldb' : 'gdb',\n      });\n    }\n\n    return configs;\n  }\n\n  /**\n   * Get all debug configurations\n   */\n  async getAllConfigurations(workspacePath: string): Promise<DebugConfiguration[]> {\n    const autoDetected = await this.autoDetectConfigurations(workspacePath);\n    const config = await this.loadLaunchConfiguration(workspacePath);\n\n    if (config && config.configurations) {\n      return [...config.configurations, ...autoDetected];\n    }\n\n    return autoDetected;\n  }\n\n  /**\n   * Start a debug session\n   */\n  async startSession(\n    configuration: DebugConfiguration,\n    workspacePath: string,\n    window: BrowserWindow,\n    activeFile?: string\n  ): Promise<string> {\n    const sessionId = `debug-${++this.sessionIdCounter}`;\n\n    // Create session\n    const session: DebugSession = {\n      id: sessionId,\n      configuration,\n      state: 'initializing',\n      breakpoints: new Map(),\n      variables: [],\n      callStack: [],\n    };\n\n    this.sessions.set(sessionId, session);\n\n    // Resolve configuration variables\n    const resolvedConfig = this.resolveConfigurationVariables(configuration, workspacePath, activeFile);\n\n    try {\n      // Launch debug adapter\n      const adapter = await this.launchDebugAdapter(resolvedConfig, workspacePath, window);\n      this.adapters.set(sessionId, adapter);\n\n      // Set up message handling with sessionId for response tracking\n      this.setupAdapterCommunication(adapter, window, sessionId);\n\n      // Send initialize request\n      await this.sendDAPRequest(sessionId, 'initialize', {\n        clientID: 'kalynt-ide',\n        clientName: 'Kalynt IDE',\n        adapterID: resolvedConfig.type,\n        pathFormat: 'path',\n        linesStartAt1: true,\n        columnsStartAt1: true,\n        supportsVariableType: true,\n        supportsVariablePaging: true,\n        supportsRunInTerminalRequest: true,\n        locale: 'en-US',\n      });\n\n      // Send launch/attach request\n      const requestType = resolvedConfig.request;\n      await this.sendDAPRequest(sessionId, requestType, resolvedConfig);\n\n      // Send configuration done\n      await this.sendDAPRequest(sessionId, 'configurationDone', {});\n\n      session.state = 'running';\n\n      window.webContents.send('debug:started', { sessionId, configuration: resolvedConfig });\n\n      return sessionId;\n    } catch (error: any) {\n      session.state = 'error';\n      window.webContents.send('debug:error', {\n        sessionId,\n        error: error.message,\n      });\n      throw error;\n    }\n  }\n\n  /**\n   * Launch debug adapter process\n   */\n  private async launchDebugAdapter(\n    configuration: DebugConfiguration,\n    workspacePath: string,\n    window: BrowserWindow\n  ): Promise<DebugAdapter> {\n    const adapter: DebugAdapter = {\n      messageBuffer: '',\n      sequenceNumber: 1,\n      pendingRequests: new Map(),\n    };\n\n    const { type } = configuration;\n\n    let debuggerPath: string;\n    let debuggerArgs: string[];\n\n    // Determine debugger executable based on type\n    switch (type) {\n      case 'node':\n      case 'node-terminal':\n        // Use Node's built-in inspector protocol\n        debuggerPath = process.execPath; // Node.js executable\n        debuggerArgs = ['--inspect-brk=0', configuration.program || ''];\n        break;\n\n      case 'debugpy':\n      case 'python':\n        debuggerPath = 'python';\n        debuggerArgs = ['-m', 'debugpy', '--listen', '5678', '--wait-for-client'];\n        if (configuration.program) {\n          debuggerArgs.push(configuration.program);\n        }\n        break;\n\n      case 'lldb':\n      case 'rust-lldb':\n        debuggerPath = 'lldb-vscode';\n        debuggerArgs = [];\n        break;\n\n      case 'gdb':\n      case 'cppdbg':\n        debuggerPath = 'gdb';\n        debuggerArgs = ['--interpreter=mi'];\n        break;\n\n      case 'delve':\n      case 'go':\n        debuggerPath = 'dlv';\n        debuggerArgs = ['dap', '--listen=127.0.0.1:0'];\n        break;\n\n      default:\n        throw new Error(`Unsupported debug type: ${type}`);\n    }\n\n    // Spawn debugger process\n    const childProcess = spawn(debuggerPath, debuggerArgs, {\n      cwd: configuration.cwd || workspacePath,\n      env: {\n        ...process.env,\n        ...configuration.env,\n      },\n    });\n\n    adapter.process = childProcess;\n\n    return adapter;\n  }\n\n  /**\n   * Set up communication with debug adapter\n   */\n  private setupAdapterCommunication(adapter: DebugAdapter, window: BrowserWindow, sessionId: string) {\n    if (!adapter.process) return;\n\n    adapter.process.stdout?.on('data', (data: Buffer) => {\n      adapter.messageBuffer += data.toString();\n      this.processAdapterMessages(adapter, window, sessionId);\n    });\n\n    adapter.process.stderr?.on('data', (data: Buffer) => {\n      console.error('Debug adapter error:', data.toString());\n      window.webContents.send('debug:output', {\n        type: 'stderr',\n        data: data.toString(),\n      });\n    });\n\n    adapter.process.on('exit', (code) => {\n      console.log('Debug adapter exited with code:', code);\n      window.webContents.send('debug:terminated', { exitCode: code });\n    });\n  }\n\n  /**\n   * Process messages from debug adapter\n   */\n  private processAdapterMessages(adapter: DebugAdapter, window: BrowserWindow, sessionId: string) {\n    while (true) {\n      const headerMatch = /Content-Length: (\\d+)\\r\\n\\r\\n/.exec(adapter.messageBuffer);\n      if (!headerMatch) break;\n\n      const contentLength = Number.parseInt(headerMatch[1], 10);\n      const headerLength = headerMatch[0].length;\n      const totalLength = headerLength + contentLength;\n\n      if (adapter.messageBuffer.length < totalLength) break;\n\n      const messageContent = adapter.messageBuffer.substring(\n        headerLength,\n        totalLength\n      );\n      adapter.messageBuffer = adapter.messageBuffer.substring(totalLength);\n\n      try {\n        const message = JSON.parse(messageContent);\n        this.handleAdapterMessage(message, window, sessionId);\n      } catch (error) {\n        console.error('Failed to parse DAP message:', error);\n      }\n    }\n  }\n\n  /**\n   * Handle messages from debug adapter\n   */\n  private handleAdapterMessage(\n    message: DAPResponse | DAPEvent,\n    window: BrowserWindow,\n    sessionId: string\n  ) {\n    if (message.type === 'event') {\n      const event = message as DAPEvent;\n      window.webContents.send('debug:event', event);\n\n      // Handle specific events\n      switch (event.event) {\n        case 'stopped':\n          window.webContents.send('debug:stopped', event.body);\n          break;\n        case 'continued':\n          window.webContents.send('debug:continued', event.body);\n          break;\n        case 'terminated':\n          window.webContents.send('debug:terminated', event.body);\n          break;\n        case 'output':\n          window.webContents.send('debug:output', event.body);\n          break;\n        case 'breakpoint':\n          window.webContents.send('debug:breakpoint', event.body);\n          break;\n      }\n    } else if (message.type === 'response') {\n      const response = message as DAPResponse;\n      window.webContents.send('debug:response', response);\n\n      // Resolve pending request if exists\n      const adapter = this.adapters.get(sessionId);\n      if (adapter) {\n        const pending = adapter.pendingRequests.get(response.request_seq);\n        if (pending) {\n          if (response.success) {\n            pending.resolve(response);\n          } else {\n            pending.reject(new Error(response.message || 'DAP request failed'));\n          }\n        }\n      }\n    }\n  }\n\n  /**\n   * Send DAP request to debug adapter and await response\n   */\n  private sendDAPRequest(\n    sessionId: string,\n    command: string,\n    args?: any,\n    timeout: number = 10000\n  ): Promise<DAPResponse> {\n    return new Promise((resolve, reject) => {\n      const adapter = this.adapters.get(sessionId);\n      if (!adapter) {\n        reject(new Error('Debug adapter not found'));\n        return;\n      }\n\n      const request: DAPRequest = {\n        seq: adapter.sequenceNumber++,\n        type: 'request',\n        command,\n        arguments: args,\n      };\n\n      // Set up timeout\n      const timeoutId = setTimeout(() => {\n        adapter.pendingRequests.delete(request.seq);\n        reject(new Error(`DAP request '${command}' timed out after ${timeout}ms`));\n      }, timeout);\n\n      // Store pending request with resolver\n      adapter.pendingRequests.set(request.seq, {\n        resolve: (response: DAPResponse) => {\n          clearTimeout(timeoutId);\n          adapter.pendingRequests.delete(request.seq);\n          resolve(response);\n        },\n        reject: (error: Error) => {\n          clearTimeout(timeoutId);\n          adapter.pendingRequests.delete(request.seq);\n          reject(error);\n        },\n      });\n\n      const message = JSON.stringify(request);\n      const header = `Content-Length: ${Buffer.byteLength(message, 'utf8')}\\r\\n\\r\\n`;\n      const packet = header + message;\n\n      if (adapter.process?.stdin) {\n        adapter.process.stdin.write(packet);\n      } else if (adapter.socket) {\n        adapter.socket.write(packet);\n      } else {\n        clearTimeout(timeoutId);\n        adapter.pendingRequests.delete(request.seq);\n        reject(new Error('No communication channel available'));\n      }\n    });\n  }\n\n  /**\n   * Set breakpoints\n   */\n  async setBreakpoints(\n    sessionId: string,\n    file: string,\n    breakpoints: Breakpoint[]\n  ): Promise<void> {\n    const session = this.sessions.get(sessionId);\n    if (!session) {\n      throw new Error('Debug session not found');\n    }\n\n    session.breakpoints.set(file, breakpoints);\n\n    await this.sendDAPRequest(sessionId, 'setBreakpoints', {\n      source: { path: file },\n      breakpoints: breakpoints.map((bp) => ({\n        line: bp.line,\n        column: bp.column,\n        condition: bp.condition,\n        hitCondition: bp.hitCondition,\n        logMessage: bp.logMessage,\n      })),\n    });\n  }\n\n  /**\n   * Continue execution\n   */\n  async continue(sessionId: string, threadId?: number): Promise<void> {\n    const session = this.sessions.get(sessionId);\n    if (!session) {\n      throw new Error('Debug session not found');\n    }\n\n    await this.sendDAPRequest(sessionId, 'continue', {\n      threadId: threadId || session.threadId || 1,\n    });\n\n    session.state = 'running';\n  }\n\n  /**\n   * Step over\n   */\n  async stepOver(sessionId: string, threadId?: number): Promise<void> {\n    const session = this.sessions.get(sessionId);\n    if (!session) {\n      throw new Error('Debug session not found');\n    }\n\n    await this.sendDAPRequest(sessionId, 'next', {\n      threadId: threadId || session.threadId || 1,\n    });\n  }\n\n  /**\n   * Step into\n   */\n  async stepInto(sessionId: string, threadId?: number): Promise<void> {\n    const session = this.sessions.get(sessionId);\n    if (!session) {\n      throw new Error('Debug session not found');\n    }\n\n    await this.sendDAPRequest(sessionId, 'stepIn', {\n      threadId: threadId || session.threadId || 1,\n    });\n  }\n\n  /**\n   * Step out\n   */\n  async stepOut(sessionId: string, threadId?: number): Promise<void> {\n    const session = this.sessions.get(sessionId);\n    if (!session) {\n      throw new Error('Debug session not found');\n    }\n\n    await this.sendDAPRequest(sessionId, 'stepOut', {\n      threadId: threadId || session.threadId || 1,\n    });\n  }\n\n  /**\n   * Pause execution\n   */\n  async pause(sessionId: string, threadId?: number): Promise<void> {\n    const session = this.sessions.get(sessionId);\n    if (!session) {\n      throw new Error('Debug session not found');\n    }\n\n    await this.sendDAPRequest(sessionId, 'pause', {\n      threadId: threadId || session.threadId || 1,\n    });\n\n    session.state = 'stopped';\n  }\n\n  /**\n   * Stop debug session\n   */\n  async stopSession(sessionId: string): Promise<void> {\n    const session = this.sessions.get(sessionId);\n    const adapter = this.adapters.get(sessionId);\n\n    if (session) {\n      session.state = 'terminated';\n    }\n\n    if (adapter) {\n      // Send terminate request\n      try {\n        await this.sendDAPRequest(sessionId, 'terminate', {});\n        await this.sendDAPRequest(sessionId, 'disconnect', {});\n      } catch (error) {\n        console.error('Error terminating debug session:', error);\n      }\n\n      // Kill adapter process\n      if (adapter.process) {\n        adapter.process.kill();\n      }\n      if (adapter.socket) {\n        adapter.socket.destroy();\n      }\n\n      this.adapters.delete(sessionId);\n    }\n\n    this.sessions.delete(sessionId);\n  }\n\n  /**\n   * Get call stack\n   */\n  async getCallStack(sessionId: string, threadId?: number): Promise<StackFrame[]> {\n    const session = this.sessions.get(sessionId);\n    if (!session) {\n      throw new Error('Debug session not found');\n    }\n\n    const response = await this.sendDAPRequest(sessionId, 'stackTrace', {\n      threadId: threadId || session.threadId || 1,\n    });\n\n    return response.body?.stackFrames || [];\n  }\n\n  /**\n   * Get variables\n   */\n  async getVariables(sessionId: string, variablesReference: number): Promise<Variable[]> {\n    const response = await this.sendDAPRequest(sessionId, 'variables', {\n      variablesReference,\n    });\n\n    return response.body?.variables || [];\n  }\n\n  /**\n   * Evaluate expression\n   */\n  async evaluate(sessionId: string, expression: string, frameId?: number): Promise<any> {\n    const response = await this.sendDAPRequest(sessionId, 'evaluate', {\n      expression,\n      frameId,\n      context: 'watch',\n    });\n\n    return response.body;\n  }\n\n  /**\n   * Resolve configuration variables like ${workspaceFolder}\n   */\n  private resolveConfigurationVariables(\n    config: DebugConfiguration,\n    workspacePath: string,\n    activeFile?: string\n  ): DebugConfiguration {\n    const resolved = structuredClone(config);\n\n    // Compute file-related variables\n    const filePath = activeFile || '';\n    const fileBasename = filePath ? path.basename(filePath) : '';\n    const fileExtension = filePath ? path.extname(filePath) : '';\n    const fileBasenameNoExtension = fileBasename ? fileBasename.slice(0, -fileExtension.length || undefined) : '';\n    const fileDirname = filePath ? path.dirname(filePath) : '';\n    const relativeFile = filePath && workspacePath ? path.relative(workspacePath, filePath) : '';\n\n    const replacements: Record<string, string> = {\n      '${workspaceFolder}': workspacePath,\n      '${workspaceFolderBasename}': path.basename(workspacePath),\n      '${file}': filePath,\n      '${fileBasename}': fileBasename,\n      '${fileBasenameNoExtension}': fileBasenameNoExtension,\n      '${fileDirname}': fileDirname,\n      '${relativeFile}': relativeFile,\n      '${fileExtname}': fileExtension,\n    };\n\n    const replaceVariables = (obj: any): any => {\n      if (typeof obj === 'string') {\n        let result = obj;\n        for (const [variable, value] of Object.entries(replacements)) {\n          result = result.replace(variable, value);\n        }\n        return result;\n      } else if (Array.isArray(obj)) {\n        return obj.map(replaceVariables);\n      } else if (obj && typeof obj === 'object') {\n        const newObj: any = {};\n        for (const [key, value] of Object.entries(obj)) {\n          newObj[key] = replaceVariables(value);\n        }\n        return newObj;\n      }\n      return obj;\n    };\n\n    return replaceVariables(resolved);\n  }\n}\n\n// Singleton instance\nconst debugSessionManager = new DebugSessionManager();\n\nexport function setupDebugHandlers(\n  ipc: typeof ipcMain,\n  getMainWindow: () => BrowserWindow | null,\n  getWorkspacePath: () => string | null\n) {\n  // Get all debug configurations\n  ipc.handle('debug:getConfigurations', async (_, workspacePath: string) => {\n    try {\n      const configurations = await debugSessionManager.getAllConfigurations(workspacePath);\n      return { success: true, configurations };\n    } catch (error: any) {\n      console.error('Failed to get debug configurations:', error);\n      return { success: false, error: error.message };\n    }\n  });\n\n  // Start debug session\n  ipc.handle(\n    'debug:start',\n    async (_, configuration: DebugConfiguration, workspacePath: string, activeFile?: string) => {\n      try {\n        const mainWindow = getMainWindow();\n        if (!mainWindow) {\n          return { success: false, error: 'Main window not available' };\n        }\n\n        const sessionId = await debugSessionManager.startSession(\n          configuration,\n          workspacePath,\n          mainWindow,\n          activeFile\n        );\n        return { success: true, sessionId };\n      } catch (error: any) {\n        console.error('Failed to start debug session:', error);\n        return { success: false, error: error.message };\n      }\n    }\n  );\n\n  // Stop debug session\n  ipc.handle('debug:stop', async (_, sessionId: string) => {\n    try {\n      await debugSessionManager.stopSession(sessionId);\n      return { success: true };\n    } catch (error: any) {\n      console.error('Failed to stop debug session:', error);\n      return { success: false, error: error.message };\n    }\n  });\n\n  // Set breakpoints\n  ipc.handle(\n    'debug:setBreakpoints',\n    async (_, sessionId: string, file: string, breakpoints: Breakpoint[]) => {\n      try {\n        await debugSessionManager.setBreakpoints(sessionId, file, breakpoints);\n        return { success: true };\n      } catch (error: any) {\n        console.error('Failed to set breakpoints:', error);\n        return { success: false, error: error.message };\n      }\n    }\n  );\n\n  // Debug controls\n  ipc.handle('debug:continue', async (_, sessionId: string, threadId?: number) => {\n    try {\n      await debugSessionManager.continue(sessionId, threadId);\n      return { success: true };\n    } catch (error: any) {\n      return { success: false, error: error.message };\n    }\n  });\n\n  ipc.handle('debug:stepOver', async (_, sessionId: string, threadId?: number) => {\n    try {\n      await debugSessionManager.stepOver(sessionId, threadId);\n      return { success: true };\n    } catch (error: any) {\n      return { success: false, error: error.message };\n    }\n  });\n\n  ipc.handle('debug:stepInto', async (_, sessionId: string, threadId?: number) => {\n    try {\n      await debugSessionManager.stepInto(sessionId, threadId);\n      return { success: true };\n    } catch (error: any) {\n      return { success: false, error: error.message };\n    }\n  });\n\n  ipc.handle('debug:stepOut', async (_, sessionId: string, threadId?: number) => {\n    try {\n      await debugSessionManager.stepOut(sessionId, threadId);\n      return { success: true };\n    } catch (error: any) {\n      return { success: false, error: error.message };\n    }\n  });\n\n  ipc.handle('debug:pause', async (_, sessionId: string, threadId?: number) => {\n    try {\n      await debugSessionManager.pause(sessionId, threadId);\n      return { success: true };\n    } catch (error: any) {\n      return { success: false, error: error.message };\n    }\n  });\n\n  // Get call stack\n  ipc.handle('debug:getCallStack', async (_, sessionId: string, threadId?: number) => {\n    try {\n      const callStack = await debugSessionManager.getCallStack(sessionId, threadId);\n      return { success: true, callStack };\n    } catch (error: any) {\n      return { success: false, error: error.message };\n    }\n  });\n\n  // Get variables\n  ipc.handle(\n    'debug:getVariables',\n    async (_, sessionId: string, variablesReference: number) => {\n      try {\n        const variables = await debugSessionManager.getVariables(\n          sessionId,\n          variablesReference\n        );\n        return { success: true, variables };\n      } catch (error: any) {\n        return { success: false, error: error.message };\n      }\n    }\n  );\n\n  // Evaluate expression\n  ipc.handle(\n    'debug:evaluate',\n    async (_, sessionId: string, expression: string, frameId?: number) => {\n      try {\n        const result = await debugSessionManager.evaluate(sessionId, expression, frameId);\n        return { success: true, result };\n      } catch (error: any) {\n        return { success: false, error: error.message };\n      }\n    }\n  );\n}\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\electron\\handlers\\dependency.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":99,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":99,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[3597,3661],"text":""},"desc":"Remove the console.log()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n/**\r\n * IPC handlers for Dependency Manager\r\n */\r\n\r\nimport { ipcMain, BrowserWindow } from 'electron'\r\nimport { getDependencyManager } from '../terminal/dependencyManager'\r\n\r\nexport function registerDependencyHandlers(getMainWindow: () => BrowserWindow | null): void {\r\n    const dependencyManager = getDependencyManager()\r\n\r\n    // Set main window when available\r\n    const mainWindow = getMainWindow()\r\n    if (mainWindow) {\r\n        dependencyManager.setMainWindow(mainWindow)\r\n    }\r\n\r\n    // Detect package manager in workspace\r\n    ipcMain.handle('deps:detect', async (_event, workspacePath: string) => {\r\n        const manager = await dependencyManager.detectPackageManager(workspacePath)\r\n        return manager ? {\r\n            success: true,\r\n            manager: {\r\n                name: manager.name,\r\n                command: manager.command,\r\n                manifestFile: manager.manifestFile,\r\n                lockFile: manager.lockFile,\r\n                languageId: manager.languageId\r\n            }\r\n        } : { success: false, error: 'No package manager detected' }\r\n    })\r\n\r\n    // Get package manager for language\r\n    ipcMain.handle('deps:getForLanguage', async (_event, languageId: string) => {\r\n        const manager = dependencyManager.getPackageManagerForLanguage(languageId)\r\n        return manager ? {\r\n            success: true,\r\n            manager: {\r\n                name: manager.name,\r\n                command: manager.command,\r\n                manifestFile: manager.manifestFile,\r\n                languageId: manager.languageId\r\n            }\r\n        } : { success: false, error: `No package manager for language: ${languageId}` }\r\n    })\r\n\r\n    // Install a package\r\n    ipcMain.handle('deps:install', async (_event, packageName: string, options: {\r\n        workspacePath: string\r\n        global?: boolean\r\n        dev?: boolean\r\n        version?: string\r\n    }) => {\r\n        return dependencyManager.installPackage(packageName, options)\r\n    })\r\n\r\n    // Install all dependencies from manifest\r\n    ipcMain.handle('deps:installAll', async (_event, workspacePath: string) => {\r\n        return dependencyManager.installAllDependencies(workspacePath)\r\n    })\r\n\r\n    // Uninstall a package\r\n    ipcMain.handle('deps:uninstall', async (_event, packageName: string, workspacePath: string) => {\r\n        return dependencyManager.uninstallPackage(packageName, workspacePath)\r\n    })\r\n\r\n    // Update package(s)\r\n    ipcMain.handle('deps:update', async (_event, packageName: string | null, workspacePath: string) => {\r\n        return dependencyManager.updatePackage(packageName, workspacePath)\r\n    })\r\n\r\n    // List installed packages\r\n    ipcMain.handle('deps:list', async (_event, workspacePath: string) => {\r\n        return dependencyManager.listPackages(workspacePath)\r\n    })\r\n\r\n    // Initialize new project\r\n    ipcMain.handle('deps:init', async (_event, managerName: string, workspacePath: string) => {\r\n        return dependencyManager.initProject(managerName, workspacePath)\r\n    })\r\n\r\n    // Get supported package managers\r\n    ipcMain.handle('deps:getSupportedManagers', async () => {\r\n        return dependencyManager.getSupportedManagers().map(m => ({\r\n            name: m.name,\r\n            command: m.command,\r\n            languageId: m.languageId,\r\n            manifestFile: m.manifestFile\r\n        }))\r\n    })\r\n\r\n    // Kill running operation\r\n    ipcMain.handle('deps:kill', async (_event, operationId: string) => {\r\n        return dependencyManager.killOperation(operationId)\r\n    })\r\n\r\n    console.log('[Main] Dependency manager IPC handlers registered')\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\electron\\handlers\\file-system.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":39,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":39,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[1308,1362],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":54,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":54,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[1906,1966],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":128,"column":25,"nodeType":"MemberExpression","messageId":"unexpected","endLine":128,"endColumn":38,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[4974,5041],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":342,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":342,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[13495,13540],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/*\n * SPDX-License-Identifier: AGPL-3.0-only\n */\n\nimport path from 'node:path'\nimport fs from 'node:fs'\nimport * as chokidar from 'chokidar'\nimport type { BrowserWindow as BrowserWindowType } from 'electron'\n\n// Stateful maps for file watchers\nconst watchers = new Map<string, chokidar.FSWatcher>()\n\n// Path validation helper - prevents path traversal attacks\nfunction validatePath(base: string, target: string): string {\n    const resolvedTarget = path.resolve(base, target)\n    if (!resolvedTarget.startsWith(path.resolve(base))) {\n        throw new Error('Path traversal detected')\n    }\n    return resolvedTarget\n}\n\nexport function registerFileSystemHandlers(\n    ipcMain: Electron.IpcMain,\n    dialog: Electron.Dialog,\n    getMainWindow: () => BrowserWindowType | null,\n    getCurrentWorkspacePath: () => string | null,\n    setCurrentWorkspacePath: (path: string) => void,\n    getModelsDir: () => string\n) {\n    // Set workspace and clear all watchers\n    ipcMain.handle('fs:setWorkspace', async (_event, workspacePath: string) => {\n        setCurrentWorkspacePath(workspacePath)\n        const closePromises: Promise<void>[] = []\n        watchers.forEach((watcher) => {\n            closePromises.push(watcher.close())\n        })\n        await Promise.all(closePromises)\n        watchers.clear()\n        console.log('[Main] Workspace set to:', workspacePath)\n        return { success: true }\n    })\n\n    // Open folder dialog\n    ipcMain.handle('fs:openFolder', async () => {\n        const mainWindow = getMainWindow()\n        if (!mainWindow) return { success: false, error: 'No main window' }\n        const result = await dialog.showOpenDialog(mainWindow, {\n            properties: ['openDirectory']\n        })\n        if (result.canceled || result.filePaths.length === 0) {\n            return { success: false, canceled: true }\n        }\n        setCurrentWorkspacePath(result.filePaths[0])\n        console.log('[Main] Workspace opened:', result.filePaths[0])\n        return { success: true, path: result.filePaths[0] }\n    })\n\n    // Check if file exists\n    ipcMain.handle('file-exists', async (_event, filePath: string) => {\n        try {\n            // Try models directory first (essential for absolute paths from model store)\n            const MODELS_DIR = getModelsDir()\n            try {\n                const filename = path.basename(filePath)\n                const safeModelPath = validatePath(MODELS_DIR, filename)\n                if (fs.existsSync(safeModelPath)) {\n                    return true\n                }\n            } catch {\n                // Ignore validation errors for models and fall through\n            }\n\n            // Try current workspace\n            const currentWorkspacePath = getCurrentWorkspacePath()\n            if (currentWorkspacePath) {\n                const safePath = validatePath(currentWorkspacePath, filePath)\n                return fs.existsSync(safePath)\n            }\n\n            return false\n        } catch {\n            return false\n        }\n    })\n\n    // Delete model file (restricted to models directory)\n    ipcMain.handle('delete-model', async (_event, filePath: string) => {\n        try {\n            const MODELS_DIR = getModelsDir()\n            const safePath = validatePath(MODELS_DIR, filePath)\n            if (!safePath.startsWith(MODELS_DIR)) {\n                return { success: false, error: 'Access denied: Invalid model path' }\n            }\n            if (fs.existsSync(safePath)) {\n                fs.unlinkSync(safePath)\n            }\n            return { success: true }\n        } catch (error) {\n            return { success: false, error: String(error) }\n        }\n    })\n\n    // Read directory contents\n    ipcMain.handle('fs:readDir', async (_event, dirPath: string) => {\n        try {\n            const currentWorkspacePath = getCurrentWorkspacePath()\n            if (!currentWorkspacePath) {\n                return { success: false, error: 'No workspace open' }\n            }\n            const safePath = validatePath(currentWorkspacePath, dirPath)\n            const entries = await fs.promises.readdir(safePath, { withFileTypes: true })\n            const items = await Promise.all(entries\n                .filter(entry => {\n                    const name = entry.name\n                    if (name === '.env' || name === '.git' || name === 'node_modules') return false\n                    if (name.endsWith('.key') || name.endsWith('.pem')) return false\n                    return true\n                })\n                .map(async entry => {\n                    const entryPath = path.join(dirPath, entry.name)\n                    let stats = { size: 0, mtimeMs: Date.now() }\n                    try {\n                        if (entry.isFile()) {\n                            const fullPath = path.join(safePath, entry.name)\n                            stats = await fs.promises.stat(fullPath)\n                        }\n                    } catch (error_) {\n                        console.error('[Main] Failed to stat file during readDir:', error_)\n                    }\n                    return {\n                        name: entry.name,\n                        path: entryPath,\n                        isDirectory: entry.isDirectory(),\n                        isFile: entry.isFile(),\n                        size: stats.size,\n                        lastModified: stats.mtimeMs\n                    }\n                }))\n            return { success: true, items }\n        } catch (error) {\n            return { success: false, error: String(error) }\n        }\n    })\n\n    // Read file contents\n    ipcMain.handle('fs:readFile', async (_event, filePath: string) => {\n        try {\n            const currentWorkspacePath = getCurrentWorkspacePath()\n            if (!currentWorkspacePath) {\n                return { success: false, error: 'No workspace open' }\n            }\n            const safePath = validatePath(currentWorkspacePath, filePath)\n            const content = await fs.promises.readFile(safePath, 'utf-8')\n            return { success: true, content }\n        } catch (error) {\n            return { success: false, error: String(error) }\n        }\n    })\n\n    // Get file stats\n    ipcMain.handle('fs:stat', async (_event, filePath: string) => {\n        try {\n            const currentWorkspacePath = getCurrentWorkspacePath()\n            if (!currentWorkspacePath) {\n                return { success: false, error: 'No workspace open' }\n            }\n            const safePath = validatePath(currentWorkspacePath, filePath)\n            const stats = await fs.promises.stat(safePath)\n            return {\n                success: true,\n                size: stats.size,\n                mtimeMs: stats.mtimeMs,\n                isDirectory: stats.isDirectory(),\n                isFile: stats.isFile()\n            }\n        } catch (error) {\n            return { success: false, error: String(error) }\n        }\n    })\n\n    // Write file contents\n    ipcMain.handle('fs:writeFile', async (_event, options: { path: string, content: string, encoding?: BufferEncoding }) => {\n        try {\n            const currentWorkspacePath = getCurrentWorkspacePath()\n            if (!currentWorkspacePath) {\n                return { success: false, error: 'No workspace open' }\n            }\n            const safePath = validatePath(currentWorkspacePath, options.path)\n            await fs.promises.mkdir(path.dirname(safePath), { recursive: true })\n            await fs.promises.writeFile(safePath, options.content, options.encoding || 'utf-8')\n            return { success: true }\n        } catch (error) {\n            return { success: false, error: String(error) }\n        }\n    })\n\n    // Create empty file\n    ipcMain.handle('fs:createFile', async (_event, filePath: string) => {\n        try {\n            const currentWorkspacePath = getCurrentWorkspacePath()\n            if (!currentWorkspacePath) {\n                return { success: false, error: 'No workspace open' }\n            }\n            const safePath = validatePath(currentWorkspacePath, filePath)\n            await fs.promises.writeFile(safePath, '', 'utf-8')\n            return { success: true }\n        } catch (error) {\n            return { success: false, error: String(error) }\n        }\n    })\n\n    // Create directory\n    ipcMain.handle('fs:createDir', async (_event, dirPath: string) => {\n        try {\n            const currentWorkspacePath = getCurrentWorkspacePath()\n            if (!currentWorkspacePath) {\n                return { success: false, error: 'No workspace open' }\n            }\n            const safePath = validatePath(currentWorkspacePath, dirPath)\n            await fs.promises.mkdir(safePath, { recursive: true })\n            return { success: true }\n        } catch (error) {\n            return { success: false, error: String(error) }\n        }\n    })\n\n    // Delete file or directory\n    ipcMain.handle('fs:delete', async (_event, itemPath: string) => {\n        try {\n            const currentWorkspacePath = getCurrentWorkspacePath()\n            if (!currentWorkspacePath) {\n                return { success: false, error: 'No workspace open' }\n            }\n            const safePath = validatePath(currentWorkspacePath, itemPath)\n            const stat = await fs.promises.stat(safePath)\n            if (stat.isDirectory()) {\n                await fs.promises.rm(safePath, { recursive: true })\n            } else {\n                await fs.promises.unlink(safePath)\n            }\n            return { success: true }\n        } catch (error) {\n            return { success: false, error: String(error) }\n        }\n    })\n\n    // Rename file or directory\n    ipcMain.handle('fs:rename', async (_event, options: { oldPath: string, newPath: string }) => {\n        try {\n            const currentWorkspacePath = getCurrentWorkspacePath()\n            if (!currentWorkspacePath) {\n                return { success: false, error: 'No workspace open' }\n            }\n            const safeOld = validatePath(currentWorkspacePath, options.oldPath)\n            const safeNew = validatePath(currentWorkspacePath, options.newPath)\n            await fs.promises.rename(safeOld, safeNew)\n            return { success: true }\n        } catch (error) {\n            return { success: false, error: String(error) }\n        }\n    })\n\n    // Watch directory for changes\n    ipcMain.handle('fs:watchDir', async (_event, options: { id: string, dirPath: string }) => {\n        try {\n            const currentWorkspacePath = getCurrentWorkspacePath()\n            const mainWindow = getMainWindow()\n            if (!currentWorkspacePath) {\n                return { success: false, error: 'No workspace open' }\n            }\n            const safePath = validatePath(currentWorkspacePath, options.dirPath)\n            const existingWatcher = watchers.get(options.id)\n            if (existingWatcher) {\n                await existingWatcher.close()\n            }\n            const watcher = chokidar.watch(safePath, {\n                ignored: /(^|[\\\\/])\\../,\n                persistent: true,\n                ignoreInitial: true\n            })\n            watcher.on('all', (event, filePath) => {\n                mainWindow?.webContents.send('fs:change', {\n                    id: options.id,\n                    event,\n                    path: filePath\n                })\n            })\n            watchers.set(options.id, watcher)\n            return { success: true }\n        } catch (error) {\n            return { success: false, error: String(error) }\n        }\n    })\n\n    // Unwatch directory\n    ipcMain.handle('fs:unwatchDir', async (_event, id: string) => {\n        const watcher = watchers.get(id)\n        if (watcher) {\n            await watcher.close()\n            watchers.delete(id)\n        }\n        return { success: true }\n    })\n\n    // NEW: Backup workspace\n    ipcMain.handle('fs:backup', async () => {\n        try {\n            const currentWorkspace = getCurrentWorkspacePath()\n            const mainWindow = getMainWindow()\n            if (!currentWorkspace || !mainWindow) return { success: false, error: 'No workspace or window' }\n\n            const { canceled, filePath: destPath } = await dialog.showSaveDialog(mainWindow, {\n                title: 'Select Backup Destination',\n                defaultPath: `backup-${path.basename(currentWorkspace)}-${Date.now()}`,\n                buttonLabel: 'Restore'\n            })\n\n            if (canceled || !destPath) return { success: false, canceled: true }\n\n            await fs.promises.mkdir(destPath, { recursive: true })\n\n            const copyRecursive = async (src: string, dest: string) => {\n                const entries = await fs.promises.readdir(src, { withFileTypes: true })\n                for (const entry of entries) {\n                    const srcPath = path.join(src, entry.name)\n                    const destPath = path.join(dest, entry.name)\n\n                    if (entry.name === 'node_modules' || entry.name === '.git') continue\n\n                    if (entry.isDirectory()) {\n                        await fs.promises.mkdir(destPath, { recursive: true })\n                        await copyRecursive(srcPath, destPath)\n                    } else {\n                        await fs.promises.copyFile(srcPath, destPath)\n                    }\n                }\n            }\n\n            await copyRecursive(currentWorkspace, destPath)\n            return { success: true, path: destPath }\n        } catch (error) {\n            console.error('[Main] Backup failed:', error)\n            return { success: false, error: String(error) }\n        }\n    })\n}\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\electron\\handlers\\git.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\electron\\handlers\\llm-inference.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":51,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":51,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[1602,1655],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":52,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":52,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[1664,1711],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":53,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":53,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[1720,1780],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":54,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":54,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[1789,1870],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":60,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":60,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[2073,2124],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":65,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":65,"endColumn":30,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[2300,2333],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":72,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":72,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[2598,2665],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":93,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":93,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[3755,3801],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":101,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":101,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[4097,4165],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":104,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":104,"endColumn":32,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[4274,4333],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":105,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":105,"endColumn":32,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[4354,4445],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":107,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":107,"endColumn":34,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[4496,4555],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":114,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":114,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4909,4912],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4909,4912],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":116,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":116,"endColumn":30,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[4958,5018],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":117,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":117,"endColumn":30,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[5035,5115],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":122,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":122,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[5305,5356],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":123,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":123,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[5369,5412],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":124,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":124,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[5425,5485],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":125,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":125,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[5498,5552],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":130,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":130,"endColumn":32,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[5695,5747],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":132,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":132,"endColumn":32,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[5821,5865],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":140,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":140,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[6217,6260],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":141,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":141,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[6277,6328],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":142,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":142,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[6345,6407],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":156,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":156,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[7029,7076],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":157,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":157,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[7093,7171],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":168,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":168,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[7754,7852],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":169,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":169,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[7869,7936],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":170,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":170,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[7953,8004],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":171,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":171,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[8021,8071],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":174,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":174,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8171,8174],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8171,8174],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":197,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":197,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[9183,9270],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":198,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":198,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[9287,9335],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":201,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":201,"endColumn":30,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[9471,9519],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":204,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":204,"endColumn":30,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[9691,9737],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":207,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":207,"endColumn":30,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[9817,10051],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":226,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":226,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[11155,11206],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":230,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":230,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[11362,11417],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":231,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":231,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[11430,11519],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":249,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":249,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[12375,12428],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":268,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":268,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[12960,13029],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":276,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":276,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13339,13342],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13339,13342],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":280,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":280,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[13450,13529],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":284,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":284,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[13627,13866],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":319,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":319,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15165,15168],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15165,15168],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":322,"column":76,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":322,"endColumn":79,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15340,15343],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15340,15343],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":325,"column":29,"nodeType":"MemberExpression","messageId":"unexpected","endLine":325,"endColumn":40,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[15526,15600],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":328,"column":25,"nodeType":"MemberExpression","messageId":"unexpected","endLine":328,"endColumn":37,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[15694,15785],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":332,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":332,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15866,15869],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15866,15869],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":351,"column":25,"nodeType":"MemberExpression","messageId":"unexpected","endLine":351,"endColumn":36,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[16609,16665],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":374,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":374,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[17443,17489],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":422,"column":25,"nodeType":"MemberExpression","messageId":"unexpected","endLine":422,"endColumn":36,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[19335,19389],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":443,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":443,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20173,20176],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20173,20176],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":446,"column":76,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":446,"endColumn":79,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20348,20351],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20348,20351],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":449,"column":29,"nodeType":"MemberExpression","messageId":"unexpected","endLine":449,"endColumn":40,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[20534,20608],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":452,"column":25,"nodeType":"MemberExpression","messageId":"unexpected","endLine":452,"endColumn":37,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[20702,20793],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":456,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":456,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20874,20877],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20874,20877],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":484,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":484,"endColumn":32,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[21985,22033],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":495,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":495,"endColumn":34,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[22582,22653],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":504,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":504,"endColumn":34,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[23209,23265],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":513,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":513,"endColumn":34,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[23776,23831],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":530,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":530,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[24378,24434],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":559,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":559,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[25656,25710],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":564,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":564,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[25871,25924],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":64,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Copyright 2026 Hermes Lekkas.\n * PROPRIETARY & CONFIDENTIAL.\n * \n * This file is part of the Kalynt \"Pro\" Edition.\n * Unauthorized copying, distribution, or modification of this file, \n * via any medium, is strictly prohibited.\n */\n\nimport path from 'path'\nimport fs from 'fs'\nimport type { Llama, LlamaModel, LlamaContext } from 'node-llama-cpp'\n\n// Path validation helper - prevents path traversal attacks\nfunction validatePath(base: string, target: string): string {\n    const resolvedTarget = path.resolve(base, target)\n    if (!resolvedTarget.startsWith(path.resolve(base))) {\n        throw new Error('Path traversal detected')\n    }\n    return resolvedTarget\n}\n\n// State management for LLM inference\nlet loadedModelId: string | null = null\nlet llamaModel: LlamaModel | null = null\nlet llamaContext: LlamaContext | null = null\nlet nodeLlamaCpp: typeof import('node-llama-cpp')\nlet llamaInstance: Llama | null = null\n\n// Track active generation requests for cancellation\nconst activeGenerations = new Map<string, AbortController>()\n\nexport function registerLLMInferenceHandlers(\n    ipcMain: Electron.IpcMain,\n    getModelsDir: () => string\n) {\n    // Load model into memory\n    ipcMain.handle('load-model', async (_event, options: {\n        modelId: string\n        path: string\n        contextLength: number\n        expectedSizeBytes?: number\n        aimeConfig?: {\n            kvCacheQuantization?: 'none' | 'fp16' | 'q8' | 'q4'\n            gpuLayers?: number\n            useMemoryMapping?: boolean\n            batchSize?: number\n            threads?: number\n        }\n    }) => {\n        console.log('[Main] Loading model:', options.modelId)\n        console.log('[Main] Model path:', options.path)\n        console.log('[Main] Context length:', options.contextLength)\n        console.log('[Main] AIME Config:', options.aimeConfig || 'None (using defaults)')\n\n        try {\n            const MODELS_DIR = getModelsDir()\n            // Validate and get the safe path\n            const safePath = validatePath(MODELS_DIR, path.basename(options.path))\n            console.log('[Main] Safe path resolved:', safePath)\n\n            // Check if model file exists\n            if (!fs.existsSync(safePath)) {\n                const errorMsg = `Model file not found at: ${safePath}`\n                console.error('[Main]', errorMsg)\n                return { success: false, error: errorMsg }\n            }\n\n            // Check file size to ensure it's not corrupted or incomplete\n            const stats = fs.statSync(safePath)\n            const fileSizeMB = stats.size / 1024 / 1024\n            console.log('[Main] Model file size:', fileSizeMB.toFixed(2), 'MB')\n\n            if (stats.size < 1024 * 1024) { // Less than 1MB is definitely corrupted\n                return { success: false, error: 'Model file appears to be corrupted (too small). Please re-download.' }\n            }\n\n            // Check if file size is significantly smaller than expected (incomplete download)\n            // Allow 10% variance for compression differences and small models\n            if (options.expectedSizeBytes && options.expectedSizeBytes > 0) {\n                const minExpectedSize = options.expectedSizeBytes * 0.90\n                if (stats.size < minExpectedSize) {\n                    const expectedMB = (options.expectedSizeBytes / 1024 / 1024).toFixed(2)\n                    return {\n                        success: false,\n                        error: `Model file is incomplete (${fileSizeMB.toFixed(2)} MB of expected ${expectedMB} MB). Please delete the file and re-download the model from settings.`\n                    }\n                }\n            }\n\n            // Unload previous model if loaded\n            if (llamaModel) {\n                console.log('[Main] Unloading previous model')\n                llamaContext = null\n                llamaModel = null\n            }\n\n            // Import node-llama-cpp if not already imported\n            // Must use dynamic import because node-llama-cpp is an ESM module with top-level await\n            if (!nodeLlamaCpp) {\n                console.log('[Main] Importing node-llama-cpp via dynamic import...')\n                try {\n                    nodeLlamaCpp = await import('node-llama-cpp')\n                    console.log('[Main] node-llama-cpp v3 loaded successfully')\n                    console.log('[Main] Available exports:', Object.keys(nodeLlamaCpp).slice(0, 10).join(', '))\n                } catch (e) {\n                    console.error('[Main] Failed to import node-llama-cpp:', e)\n                    const errMsg = e instanceof Error ? e.message : String(e)\n                    return { success: false, error: `Failed to load AI engine: ${errMsg}. The library may not be properly installed.` }\n                }\n            }\n\n            // Get or create Llama instance using v3 API\n            const { getLlama } = nodeLlamaCpp as any\n            if (!getLlama) {\n                console.error('[Main] getLlama not found in node-llama-cpp')\n                console.error('[Main] Available exports:', Object.keys(nodeLlamaCpp).join(', '))\n                return { success: false, error: 'AI engine is incompatible. Please reinstall the application.' }\n            }\n\n            // Load the model using v3 async API\n            console.log('[Main] Loading model using v3 API...')\n            console.log('[Main] Model path:', safePath)\n            console.log('[Main] Model exists:', fs.existsSync(safePath))\n            console.log('[Main] Model size:', stats.size, 'bytes')\n\n            try {\n                // Initialize Llama instance if not already done\n                if (!llamaInstance) {\n                    console.log('[Main] Initializing Llama instance...')\n                    llamaInstance = await getLlama()\n                    console.log('[Main] Llama instance created')\n                }\n\n                // Load model with v3 API - uses llama.loadModel() instead of new LlamaModel()\n                // Apply AIME GPU layer offloading if configured\n                const gpuLayers = options.aimeConfig?.gpuLayers ?? 0\n                const useMemoryMapping = options.aimeConfig?.useMemoryMapping ?? true\n\n                console.log('[Main] Loading model file...')\n                console.log('[Main] AIME - GPU Layers:', gpuLayers)\n                console.log('[Main] AIME - Memory Mapping:', useMemoryMapping)\n\n                if (!llamaInstance) {\n                    return { success: false, error: 'Failed to initialize Llama instance' }\n                }\n                llamaModel = await llamaInstance.loadModel({\n                    modelPath: safePath,\n                    gpuLayers: gpuLayers,  // AIME: Dynamic GPU/CPU splitting\n                    useMmap: useMemoryMapping  // AIME: Use mmap for efficient memory usage\n                })\n\n                if (!llamaModel) {\n                    return { success: false, error: 'Failed to load model. The model file may be corrupted.' }\n                }\n                console.log('[Main] Model loaded successfully')\n                console.log('[Main] Model trained context size:', llamaModel.trainContextSize)\n\n                // Create context for inference using v3 API with auto-sizing and AIME optimizations\n                const requestedContext = options.contextLength || 4096\n                const maxSafeContext = Math.min(requestedContext, llamaModel.trainContextSize || requestedContext)\n\n                // AIME: Apply KV cache quantization\n                const kvQuantization = options.aimeConfig?.kvCacheQuantization || 'q8'\n                const batchSize = options.aimeConfig?.batchSize || 512\n                const threads = options.aimeConfig?.threads || 4\n\n                console.log('[Main] Creating context - requested:', requestedContext, 'safe max:', maxSafeContext)\n                console.log('[Main] AIME - KV Cache Quantization:', kvQuantization)\n                console.log('[Main] AIME - Batch Size:', batchSize)\n                console.log('[Main] AIME - CPU Threads:', threads)\n\n                // Build context options with AIME features\n                const contextOptions: any = {\n                    contextSize: {\n                        min: 512,\n                        max: maxSafeContext\n                    },\n                    failedCreationRemedy: {\n                        retries: 3,\n                        autoContextSizeShrink: 0.75\n                    },\n                    batchSize: batchSize,\n                    threads: threads\n                }\n\n                // Apply KV cache quantization (if supported by node-llama-cpp)\n                // Note: KV cache quantization support varies by llama.cpp version\n                if (kvQuantization === 'q8') {\n                    contextOptions.flashAttention = true  // Enable flash attention for efficiency\n                } else if (kvQuantization === 'q4') {\n                    contextOptions.flashAttention = true\n                    // Q4 quantization might need additional flags when supported\n                }\n\n                llamaContext = await llamaModel.createContext(contextOptions)\n                console.log('[Main] Context created successfully with size:', llamaContext.contextSize)\n                console.log('[Main] AIME optimizations applied')\n                // Note: We get fresh sequences for each generation to avoid KV cache issues\n            } catch (e) {\n                console.error('[Main] Failed to load model:', e)\n                const errMsg = e instanceof Error ? e.message : String(e)\n                const errStack = e instanceof Error ? e.stack : 'No stack trace'\n                console.error('[Main] Error stack:', errStack)\n\n                // Log context creation details for debugging\n                console.error('[Main] Context creation details:', {\n                    requestedSize: options.contextLength,\n                    modelTrainSize: llamaModel?.trainContextSize,\n                    modelPath: safePath\n                })\n\n                // Provide specific error messages\n                if (errMsg.includes('AVX') || errMsg.includes('CPU') || errMsg.includes('instruction')) {\n                    return { success: false, error: 'Your CPU does not support the required instructions (AVX2). Try using a different model or system.' }\n                } else if (errMsg.includes('memory') || errMsg.includes('RAM') || errMsg.includes('allocation') || errMsg.includes('context')) {\n                    return { success: false, error: `Not enough RAM to create context for this model. Try closing other applications, use a smaller model, or reduce context size in settings.` }\n                } else if (errMsg.includes('gguf') || errMsg.includes('format') || errMsg.includes('magic')) {\n                    return { success: false, error: `Invalid or corrupted model file. Please re-download the model. Details: ${errMsg}` }\n                } else {\n                    return { success: false, error: `Failed to load model: ${errMsg}` }\n                }\n            }\n\n            loadedModelId = options.modelId\n            console.log('[Main] Model ready:', options.modelId)\n            return { success: true }\n        } catch (err) {\n            const errorMessage = err instanceof Error ? err.message : String(err)\n            console.error('[Main] Model load error:', errorMessage)\n            console.error('[Main] Error stack:', err instanceof Error ? err.stack : 'No stack trace')\n\n            // Provide more helpful error messages\n            let userFriendlyError = errorMessage\n            if (errorMessage.includes('Cannot find module')) {\n                userFriendlyError = 'AI engine not properly installed. Please reinstall the application.'\n            } else if (errorMessage.includes('invalid model file')) {\n                userFriendlyError = 'Model file is corrupted or invalid. Please re-download the model.'\n            } else if (errorMessage.includes('out of memory') || errorMessage.includes('OOM')) {\n                userFriendlyError = 'Not enough RAM to load this model. Try closing other applications or use a smaller model.'\n            }\n\n            return { success: false, error: userFriendlyError }\n        }\n    })\n\n    // Unload model from memory\n    ipcMain.handle('unload-model', async () => {\n        console.log('[Main] Unloading model:', loadedModelId)\n        llamaContext = null\n        llamaModel = null\n        loadedModelId = null\n        return { success: true }\n    })\n\n    // Generate completion (non-streaming)\n    ipcMain.handle('generate-completion', async (_event, options: {\n        prompt: string\n        maxTokens: number\n        temperature: number\n        topP: number\n        stopSequences: string[]\n        jsonSchema?: object\n    }) => {\n        if (!llamaContext || !llamaModel) {\n            return { success: false, error: 'No model loaded' }\n        }\n        console.log('[Main] Generating completion for model:', loadedModelId)\n        try {\n            // Validate that we have the required classes\n            if (!nodeLlamaCpp) {\n                return { success: false, error: 'AI engine not loaded' }\n            }\n\n            // Use v3 API - LlamaChat instead of LlamaChatSession\n            const { LlamaChat } = nodeLlamaCpp as any\n\n            if (!LlamaChat) {\n                // Fallback: use direct sequence evaluation\n                console.log('[Main] LlamaChat not available, using direct sequence evaluation')\n            }\n\n            // Generate completion using sequence API (v3 compatible)\n            console.log('[Main] Prompt options:', {\n                maxTokens: options.maxTokens,\n                temperature: options.temperature,\n                topP: options.topP,\n                stopSequences: options.stopSequences\n            })\n\n            const abortController = new AbortController()\n            let accumulatedText = ''\n            const stopSequences = options.stopSequences || []\n\n            const shouldStop = (text: string): string | null => {\n                for (const stopSeq of stopSequences) {\n                    if (text.includes(stopSeq)) {\n                        return stopSeq\n                    }\n                }\n                return null\n            }\n\n            try {\n                // IMPORTANT: The prompt is already formatted by offlineLLMService.formatPrompt()\n                // We must NOT use LlamaChat which would apply formatting again\n                // Instead, use the low-level sequence.evaluate() API directly\n\n                // Get a FRESH sequence for each generation to avoid KV cache position errors\n                // This is safer than trying to clear/reuse - prevents \"sequence positions inconsistent\" errors\n                const sequence = llamaContext!.getSequence()\n                if (!sequence) {\n                    throw new Error('Failed to get sequence from context')\n                }\n\n                const tokens = llamaModel.tokenize(options.prompt)\n\n                // Grammar-based sampling for 100% reliable JSON (like Cursor)\n                let grammar: any = undefined\n                if (options.jsonSchema && nodeLlamaCpp) {\n                    try {\n                        const { LlamaJsonSchemaGrammar } = nodeLlamaCpp as any\n                        if (LlamaJsonSchemaGrammar) {\n                            grammar = new LlamaJsonSchemaGrammar(llamaInstance, options.jsonSchema)\n                            console.log('[Main] Using JSON schema grammar for constrained generation')\n                        }\n                    } catch (grammarErr) {\n                        console.warn('[Main] Failed to create grammar, falling back to unconstrained:', grammarErr)\n                    }\n                }\n\n                const evaluateOptions: any = {\n                    temperature: options.temperature,\n                    topP: options.topP,\n                    signal: abortController.signal\n                }\n\n                // Add grammar if available\n                if (grammar) {\n                    evaluateOptions.grammar = grammar\n                }\n\n                for await (const token of sequence.evaluate(tokens, evaluateOptions)) {\n                    const text = llamaModel.detokenize([token])\n                    accumulatedText += text\n\n                    if (accumulatedText.length > options.maxTokens * 4) break // Rough char limit\n\n                    const foundStop = shouldStop(accumulatedText)\n                    if (foundStop) {\n                        console.log('[Main] Stop sequence detected:', foundStop)\n                        break\n                    }\n                }\n            } catch (e: unknown) {\n                // Ignore abort errors\n                const err = e as Error\n                if (err.name !== 'AbortError' && !err.message?.includes('abort')) {\n                    throw e\n                }\n            }\n\n            // Trim response at stop sequence if found\n            let finalResponse = accumulatedText\n            for (const stopSeq of stopSequences) {\n                const idx = finalResponse.indexOf(stopSeq)\n                if (idx !== -1) {\n                    finalResponse = finalResponse.substring(0, idx)\n                }\n            }\n\n            return { success: true, text: finalResponse.trim() }\n        } catch (err) {\n            console.error('[Main] Generation error:', err)\n            const errorMessage = err instanceof Error ? err.message : String(err)\n            return { success: false, error: errorMessage }\n        }\n    })\n\n    // Generate completion with streaming\n    ipcMain.on('generate-completion-stream', async (event, options: {\n        prompt: string\n        maxTokens: number\n        temperature: number\n        topP: number\n        stopSequences: string[]\n        jsonSchema?: object\n        requestId: string\n    }) => {\n        const { requestId } = options\n        if (!llamaContext || !llamaModel) {\n            event.sender.send('generate-completion-complete', { requestId, error: 'No model loaded' })\n            return\n        }\n        try {\n            // Validate that we have the required classes\n            if (!nodeLlamaCpp) {\n                throw new Error('node-llama-cpp not loaded')\n            }\n\n            // Generate completion with streaming using v3 API\n            // Check if sender is still valid before each send to prevent \"Object has been destroyed\" errors\n            const safeSend = (channel: string, data: unknown) => {\n                try {\n                    if (!event.sender.isDestroyed()) {\n                        event.sender.send(channel, data)\n                    }\n                } catch (_error) {\n                    // Silently ignore if sender is destroyed\n                }\n            }\n\n            const abortController = new AbortController()\n            activeGenerations.set(requestId, abortController)\n            let accumulatedText = ''\n            const stopSequences = options.stopSequences || []\n\n            // Helper to check if we should stop\n            const shouldStop = (text: string): boolean => {\n                for (const stopSeq of stopSequences) {\n                    if (text.includes(stopSeq)) {\n                        console.log('[Main] Stop sequence detected:', stopSeq)\n                        return true\n                    }\n                }\n                return false\n            }\n\n            // Use low-level sequence API for pre-formatted prompts\n            let aborted = false\n\n            try {\n                // IMPORTANT: Prompt is already formatted, use low-level sequence API\n                // Get a FRESH sequence for each generation to avoid KV cache position errors\n                const sequence = llamaContext!.getSequence()\n                if (!sequence) {\n                    throw new Error('Failed to get sequence from context')\n                }\n\n                const tokens = llamaModel.tokenize(options.prompt)\n\n                // Grammar-based sampling for 100% reliable JSON (like Cursor)\n                let grammar: any = undefined\n                if (options.jsonSchema && nodeLlamaCpp) {\n                    try {\n                        const { LlamaJsonSchemaGrammar } = nodeLlamaCpp as any\n                        if (LlamaJsonSchemaGrammar) {\n                            grammar = new LlamaJsonSchemaGrammar(llamaInstance, options.jsonSchema)\n                            console.log('[Main] Using JSON schema grammar for constrained generation')\n                        }\n                    } catch (grammarErr) {\n                        console.warn('[Main] Failed to create grammar, falling back to unconstrained:', grammarErr)\n                    }\n                }\n\n                const evaluateOptions: any = {\n                    temperature: options.temperature,\n                    topP: options.topP,\n                    signal: abortController.signal\n                }\n\n                // Add grammar if available\n                if (grammar) {\n                    evaluateOptions.grammar = grammar\n                }\n\n                for await (const token of sequence.evaluate(tokens, evaluateOptions)) {\n                    const text = llamaModel.detokenize([token])\n                    accumulatedText += text\n\n                    // Check for stop sequences\n                    if (shouldStop(accumulatedText)) {\n                        break\n                    }\n\n                    if (accumulatedText.length > options.maxTokens * 4) break\n\n                    safeSend('generate-completion-token', { requestId, token: text })\n                }\n            } catch (err: unknown) {\n                const e = err as Error\n                // Handle abort errors - they're expected when user clicks stop\n                if (e.name === 'AbortError' || e.message?.includes('abort')) {\n                    console.log('[Main] Generation aborted by user')\n                    aborted = true\n                    // CRITICAL: Send completion event even on abort\n                    safeSend('generate-completion-complete', {\n                        requestId,\n                        error: 'Aborted by user'\n                    })\n                    return // Exit cleanly\n                }\n                // Handle assertion failures (NaN errors from ggml-cpu)\n                else if (e.message?.includes('assert') || e.message?.includes('NaN') || e.message?.includes('llsnan')) {\n                    console.error('[Main] Model assertion failure (NaN error):', e.message)\n                    safeSend('generate-completion-complete', {\n                        requestId,\n                        error: '⚠️ Model numerical error. This model has corrupted weights or incompatible quantization. Please try a different model (Qwen2.5-Coder recommended).'\n                    })\n                    return // Exit cleanly with error message\n                }\n                // Handle GPU memory errors\n                else if (e.message?.includes('OutOfDeviceMemory') || e.message?.includes('allocateMemory')) {\n                    console.error('[Main] GPU memory exhausted:', e.message)\n                    safeSend('generate-completion-complete', {\n                        requestId,\n                        error: '⚠️ GPU memory exhausted. Try closing other applications or use a smaller context size.'\n                    })\n                    return\n                }\n                // Handle Eval failed / decode errors\n                else if (e.message?.includes('Eval has failed') || e.message?.includes('llama_decode') || e.message?.includes('No sequences left')) {\n                    console.error('[Main] Eval/sequence error:', e.message)\n                    safeSend('generate-completion-complete', {\n                        requestId,\n                        error: '⚠️ Generation failed. Please try again.'\n                    })\n                    return\n                }\n                else {\n                    throw err\n                }\n            }\n\n            // Generation completed successfully (only if not aborted)\n            if (!aborted) {\n                safeSend('generate-completion-complete', { requestId })\n            }\n        } catch (err) {\n            console.error('[Main] Streaming generation error:', err)\n            const errorMessage = err instanceof Error ? err.message : String(err)\n            try {\n                if (!event.sender.isDestroyed()) {\n                    event.sender.send('generate-completion-complete', { requestId, error: errorMessage })\n                }\n            } catch (_error) {\n                // Silently ignore if sender is destroyed\n            }\n        } finally {\n            // Clean up the active generation tracker\n            activeGenerations.delete(requestId)\n\n            // Ensure completion is sent if not already sent\n            // This is a safety net for unexpected errors\n            if (!event.sender.isDestroyed()) {\n                // Note: safeSend already checks if sender is destroyed, but we check here for clarity\n                // The completion event should have been sent in the try block, this is just a failsafe\n            }\n        }\n    })\n\n    // Cancel generation\n    ipcMain.handle('cancel-generation', async (_event, requestId: string) => {\n        try {\n            const controller = activeGenerations.get(requestId)\n            if (controller) {\n                controller.abort()\n                activeGenerations.delete(requestId)\n                console.log('[Main] Cancelled generation:', requestId)\n                return { success: true }\n            }\n            return { success: false, error: 'Generation not found' }\n        } catch (err) {\n            console.error('[Main] Cancel generation error:', err)\n            return { success: false, error: err instanceof Error ? err.message : String(err) }\n        }\n    })\n}\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\electron\\handlers\\model-download.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":51,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":51,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[1573,1625],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":55,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":55,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[1716,1773],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":62,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":62,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[1988,2050],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":91,"column":33,"nodeType":"MemberExpression","messageId":"unexpected","endLine":91,"endColumn":44,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[3637,3697],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":101,"column":29,"nodeType":"MemberExpression","messageId":"unexpected","endLine":101,"endColumn":40,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[4174,4227],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":150,"column":29,"nodeType":"MemberExpression","messageId":"unexpected","endLine":150,"endColumn":40,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[6677,6726],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":158,"column":25,"nodeType":"MemberExpression","messageId":"unexpected","endLine":158,"endColumn":36,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[7026,7078],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":186,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":186,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[8041,8090],"text":""},"desc":"Remove the console.log()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\nimport path from 'path'\nimport fs from 'fs'\nimport http, { ClientRequest as HttpClientRequest } from 'http'\nimport https, { ClientRequest as HttpsClientRequest } from 'https'\nimport type { BrowserWindow as BrowserWindowType } from 'electron'\n\n// Stateful map for active downloads\nconst activeDownloads = new Map<string, {\n    request?: HttpClientRequest | HttpsClientRequest,\n    destPath?: string,\n    abort: () => void\n}>()\n\n// Path validation helper - prevents path traversal attacks\nfunction validatePath(base: string, target: string): string {\n    const resolvedTarget = path.resolve(base, target)\n    if (!resolvedTarget.startsWith(path.resolve(base))) {\n        throw new Error('Path traversal detected')\n    }\n    return resolvedTarget\n}\n\ninterface DownloadOptions {\n    modelId: string\n    url: string\n    filename: string\n    expectedSize: number\n    redirectCount?: number\n}\n\nexport function registerModelDownloadHandlers(\n    ipcMain: Electron.IpcMain,\n    getMainWindow: () => BrowserWindowType | null,\n    getModelsDir: () => string\n) {\n    // Download model file with resume support\n    ipcMain.handle('download-model', async (event, options: DownloadOptions) => {\n        const { modelId, filename, expectedSize } = options\n        const currentUrl = options.url\n        let redirectCount = 0\n        const MAX_REDIRECTS = 5\n        const MODELS_DIR = getModelsDir()\n\n        let destPath: string\n        try {\n            destPath = validatePath(MODELS_DIR, filename)\n        } catch (err) {\n            console.error('[Main] Invalid model filename:', err)\n            return { success: false, error: 'Invalid model filename' }\n        }\n\n        console.log('[Main] Starting download session:', modelId)\n\n        // Check if partial file exists for resuming\n        let startByte = 0\n        if (fs.existsSync(destPath)) {\n            const stats = fs.statSync(destPath)\n            startByte = stats.size\n            console.log(`[Main] Resuming download from byte ${startByte}`)\n        }\n\n        const downloadWithRedirects = async (url: string): Promise<{ success: boolean, path?: string, error?: string }> => {\n            return new Promise((resolve) => {\n                const file = fs.createWriteStream(destPath, { flags: 'a' })\n                let downloadedBytes = startByte\n                let lastProgressUpdate = Date.now()\n                let lastBytesRecorded = startByte\n                let request: HttpClientRequest | HttpsClientRequest\n                const mainWindow = getMainWindow()\n\n                const performRequest = (reqUrl: string) => {\n                    const protocol = reqUrl.startsWith('https') ? https : http\n                    const requestOptions = {\n                        headers: startByte > 0 ? { 'Range': `bytes=${startByte}-` } : {}\n                    }\n\n                    request = protocol.get(reqUrl, requestOptions, (response) => {\n                        // Handle Redirects\n                        if (response.statusCode === 301 || response.statusCode === 302 || response.statusCode === 307 || response.statusCode === 308) {\n                            const nextUrl = response.headers.location\n                            if (nextUrl) {\n                                if (redirectCount >= MAX_REDIRECTS) {\n                                    file.close()\n                                    resolve({ success: false, error: 'Too many redirects' })\n                                    return\n                                }\n                                redirectCount++\n                                console.log(`[Main] Redirect ${redirectCount} to:`, nextUrl)\n                                request.destroy()\n                                performRequest(nextUrl.startsWith('http') ? nextUrl : new URL(nextUrl, reqUrl).toString())\n                                return\n                            }\n                        }\n\n                        // Handle Range Not Satisfiable (completed or invalid)\n                        if (response.statusCode === 416) {\n                            file.close()\n                            console.log('[Main] Download already complete (416)')\n                            activeDownloads.delete(modelId)\n                            resolve({ success: true, path: destPath })\n                            return\n                        }\n\n                        if (response.statusCode !== 200 && response.statusCode !== 206) {\n                            file.close()\n                            // Don't delete on error, allow resume later\n                            activeDownloads.delete(modelId)\n                            resolve({ success: false, error: `HTTP ${response.statusCode}` })\n                            return\n                        }\n\n                        response.on('data', (chunk) => {\n                            downloadedBytes += chunk.length\n                            const now = Date.now()\n                            const timeDelta = now - lastProgressUpdate\n\n                            // Update progress every 500ms for smooth UI updates\n                            if (timeDelta >= 500) {\n                                const bytesDelta = downloadedBytes - lastBytesRecorded\n                                // Calculate speed in bytes per second\n                                const speed = bytesDelta > 0 ? Math.round(bytesDelta / (timeDelta / 1000)) : 0\n\n                                lastProgressUpdate = now\n                                lastBytesRecorded = downloadedBytes\n\n                                // Determine total bytes from response header or expected size\n                                let totalBytes = expectedSize\n                                if (response.headers['content-length']) {\n                                    const contentLength = Number(response.headers['content-length'])\n                                    totalBytes = contentLength + startByte\n                                }\n\n                                mainWindow?.webContents.send('download-progress', {\n                                    modelId,\n                                    bytesDownloaded: downloadedBytes,\n                                    totalBytes: totalBytes,\n                                    speed: speed\n                                })\n                            }\n                        })\n\n                        response.pipe(file)\n\n                        file.on('finish', () => {\n                            file.close()\n                            activeDownloads.delete(modelId)\n                            console.log('[Main] Download complete:', modelId)\n                            resolve({ success: true, path: destPath })\n                        })\n                    })\n\n                    request.on('error', (error: Error) => {\n                        file.close()\n                        activeDownloads.delete(modelId)\n                        console.log('[Main] Download request error:', error)\n                        resolve({ success: false, error: error.message })\n                    })\n\n                    activeDownloads.set(modelId, {\n                        request,\n                        destPath,\n                        abort: () => {\n                            request.destroy()\n                            file.close()\n                            // Keep file for resume\n                        }\n                    })\n                }\n\n                performRequest(url)\n            })\n        }\n\n        return await downloadWithRedirects(currentUrl);\n    })\n\n    // Pause download (aborts request but keeps partial file)\n    ipcMain.handle('pause-download', async (_event, modelId: string) => {\n        const download = activeDownloads.get(modelId)\n        if (download) {\n            download.abort() // This aborts the request and closes the file, but keeps the partial file\n            activeDownloads.delete(modelId)\n            console.log(`[Main] Paused download: ${modelId}`)\n            return { success: true }\n        }\n        return { success: false, error: 'Download not found' }\n    })\n\n    // Resume download (re-trigger from frontend)\n    ipcMain.handle('resume-download', async (_event, modelId: string) => {\n        // Resume is handled by re-triggering download-model from frontend\n        // The frontend should call downloadModel(id) again, which calls IPC download-model\n        // And our new logic detects existing file and sends Range header.\n        // This handler checks if it's already running.\n        if (activeDownloads.has(modelId)) {\n            return { success: false, error: 'Download already active' }\n        }\n        return { success: true }\n    })\n\n    // Cancel download (aborts and removes partial file)\n    ipcMain.handle('cancel-download', async (_event, modelId: string) => {\n        const download = activeDownloads.get(modelId)\n        if (download) {\n            download.abort()\n            activeDownloads.delete(modelId)\n            return { success: true }\n        }\n        return { success: false, error: 'Download not found' }\n    })\n}\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\electron\\handlers\\nuke-handler.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":11,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":11,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[335,383],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":28,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":28,"endColumn":32,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[1104,1174],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":30,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":30,"endColumn":34,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[1227,1287],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":49,"column":54,"nodeType":"Identifier","messageId":"unusedVar","endLine":49,"endColumn":55},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":55,"column":29,"nodeType":"MemberExpression","messageId":"unexpected","endLine":55,"endColumn":42,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[2603,2650],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":70,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":70,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3260,3263],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3260,3263],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":71,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":71,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[3280,3318],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\nimport { ipcMain } from 'electron'\r\nimport { exec } from 'child_process'\r\nimport os from 'os'\r\nimport { killAllTerminals } from './terminal'\r\n\r\nexport function registerNukeHandlers() {\r\n    ipcMain.handle('nuke-processes', async (_, level: 'soft' | 'hard' | 'factory') => {\r\n        console.log(`[NUKE] Initiating Level: ${level}`)\r\n\r\n        try {\r\n            if (level === 'soft') {\r\n                // Soft: Just kill known heavy tools or PTYs if tracked\r\n                // For now, we'll just return true as we don't have a PID tracker yet\r\n                return { success: true, message: 'Soft reset complete.' }\r\n            }\r\n\r\n            if (level === 'hard' || level === 'factory') {\r\n                // Hard: Kill common dev ports and hanging node processes\r\n                // This is aggressive. Be careful.\r\n                const portsToKill = [3000, 3001, 3002, 5173, 8080]\r\n\r\n                // 1. Kill internal terminals first\r\n                try {\r\n                    const killedCount = killAllTerminals()\r\n                    console.log(`[NUKE] Killed ${killedCount} internal terminal sessions`)\r\n                } catch (e) {\r\n                    console.error('[NUKE] Failed to kill internal terminals', e)\r\n                }\r\n\r\n                if (os.platform() === 'win32') {\r\n                    // Windows: Kill node.exe, python.exe, etc.\r\n                    // This is VERY aggressive.\r\n                    // Instead, let's focus on ports first.\r\n                    for (const port of portsToKill) {\r\n                        try {\r\n                            // Find PID by port\r\n                            exec(`netstat -ano | findstr :${port}`, (err, stdout) => {\r\n                                if (stdout) {\r\n                                    const lines = stdout.trim().split('\\n')\r\n                                    lines.forEach(line => {\r\n                                        const parts = line.trim().split(/\\s+/)\r\n                                        const pid = parts[parts.length - 1]\r\n                                        if (pid && parseInt(pid) > 0) {\r\n                                            try {\r\n                                                process.kill(parseInt(pid), 'SIGKILL')\r\n                                            } catch (e) { /* ignore */ }\r\n                                        }\r\n                                    })\r\n                                }\r\n                            })\r\n                        } catch (e) {\r\n                            console.error(`Failed to kill port ${port}`, e)\r\n                        }\r\n                    }\r\n\r\n                    // Also kill dangling node.pty processes if we can identify them\r\n                    // For now, we'll rely on the user manually killing if it's really bad,\r\n                    // or we implement a more sophisticated tracking system later.\r\n                } else {\r\n                    // Unix/Mac behavior (lsof -i :port)\r\n                    // ... implementation skipped for windows-focused user ...\r\n                }\r\n            }\r\n\r\n            return { success: true, message: 'Processes nuked.' }\r\n\r\n        } catch (error: any) {\r\n            console.error('[NUKE] Failed:', error)\r\n            return { success: false, message: error.message }\r\n        }\r\n    })\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\electron\\handlers\\runtime.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\electron\\handlers\\safeStorage.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":31,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":31,"endColumn":22,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[874,932],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":41,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":41,"endColumn":22,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[1205,1263],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":58,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":58,"endColumn":29,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[1766,1843],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":71,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":71,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[2438,2503],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":74,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":74,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[2599,2647],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":100,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":100,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[3592,3640],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":112,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":112,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[3987,4035],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":115,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":115,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[4114,4165],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":126,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":126,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[4524,4577],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":9,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\nimport { safeStorage } from 'electron'\r\nimport type { IpcMain } from 'electron'\r\nimport * as fs from 'node:fs'\r\nimport * as path from 'node:path'\r\n\r\n// Store encrypted keys in a JSON file in userData\r\nlet keysFilePath: string = ''\r\n\r\ninterface EncryptedKeys {\r\n    [key: string]: string // Base64 encoded encrypted values\r\n}\r\n\r\nfunction getKeysFilePath(userDataPath: string): string {\r\n    if (!keysFilePath) {\r\n        keysFilePath = path.join(userDataPath, 'secure-keys.json')\r\n    }\r\n    return keysFilePath\r\n}\r\n\r\nfunction loadKeys(userDataPath: string): EncryptedKeys {\r\n    try {\r\n        const filePath = getKeysFilePath(userDataPath)\r\n        if (fs.existsSync(filePath)) {\r\n            const data = fs.readFileSync(filePath, 'utf-8')\r\n            return JSON.parse(data)\r\n        }\r\n    } catch (error) {\r\n        console.error('[SafeStorage] Failed to load keys:', error)\r\n    }\r\n    return {}\r\n}\r\n\r\nfunction saveKeys(userDataPath: string, keys: EncryptedKeys): void {\r\n    try {\r\n        const filePath = getKeysFilePath(userDataPath)\r\n        fs.writeFileSync(filePath, JSON.stringify(keys, null, 2), 'utf-8')\r\n    } catch (error) {\r\n        console.error('[SafeStorage] Failed to save keys:', error)\r\n    }\r\n}\r\n\r\nexport function registerSafeStorageHandlers(\r\n    ipcMain: IpcMain,\r\n    getUserDataPath: () => string\r\n) {\r\n    // Check if safeStorage is available\r\n    ipcMain.handle('safeStorage:isAvailable', () => {\r\n        return safeStorage.isEncryptionAvailable()\r\n    })\r\n\r\n    // Store an encrypted value\r\n    ipcMain.handle('safeStorage:set', async (_event, options: { key: string; value: string }) => {\r\n        try {\r\n            if (!safeStorage.isEncryptionAvailable()) {\r\n                console.warn('[SafeStorage] Encryption not available, storing in plain text')\r\n                // Fallback: store base64 encoded (not secure, but works)\r\n                const keys = loadKeys(getUserDataPath())\r\n                keys[options.key] = Buffer.from(options.value).toString('base64')\r\n                saveKeys(getUserDataPath(), keys)\r\n                return { success: true, encrypted: false }\r\n            }\r\n\r\n            const encrypted = safeStorage.encryptString(options.value)\r\n            const keys = loadKeys(getUserDataPath())\r\n            keys[options.key] = encrypted.toString('base64')\r\n            saveKeys(getUserDataPath(), keys)\r\n\r\n            console.log(`[SafeStorage] Stored encrypted key: ${options.key}`)\r\n            return { success: true, encrypted: true }\r\n        } catch (error) {\r\n            console.error('[SafeStorage] Set error:', error)\r\n            return { success: false, error: String(error) }\r\n        }\r\n    })\r\n\r\n    // Retrieve and decrypt a value\r\n    ipcMain.handle('safeStorage:get', async (_event, key: string) => {\r\n        try {\r\n            const keys = loadKeys(getUserDataPath())\r\n            const encryptedBase64 = keys[key]\r\n\r\n            if (!encryptedBase64) {\r\n                return { success: true, value: null }\r\n            }\r\n\r\n            if (!safeStorage.isEncryptionAvailable()) {\r\n                // Fallback: decode base64\r\n                const value = Buffer.from(encryptedBase64, 'base64').toString('utf-8')\r\n                return { success: true, value, encrypted: false }\r\n            }\r\n\r\n            const encrypted = Buffer.from(encryptedBase64, 'base64')\r\n            const decrypted = safeStorage.decryptString(encrypted)\r\n\r\n            return { success: true, value: decrypted, encrypted: true }\r\n        } catch (error) {\r\n            console.error('[SafeStorage] Get error:', error)\r\n            return { success: false, error: String(error) }\r\n        }\r\n    })\r\n\r\n    // Delete a stored key\r\n    ipcMain.handle('safeStorage:delete', async (_event, key: string) => {\r\n        try {\r\n            const keys = loadKeys(getUserDataPath())\r\n            delete keys[key]\r\n            saveKeys(getUserDataPath(), keys)\r\n\r\n            console.log(`[SafeStorage] Deleted key: ${key}`)\r\n            return { success: true }\r\n        } catch (error) {\r\n            console.error('[SafeStorage] Delete error:', error)\r\n            return { success: false, error: String(error) }\r\n        }\r\n    })\r\n\r\n    // Get all stored key names (not values)\r\n    ipcMain.handle('safeStorage:listKeys', async () => {\r\n        try {\r\n            const keys = loadKeys(getUserDataPath())\r\n            return { success: true, keys: Object.keys(keys) }\r\n        } catch (error) {\r\n            console.error('[SafeStorage] ListKeys error:', error)\r\n            return { success: false, error: String(error) }\r\n        }\r\n    })\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\electron\\handlers\\terminal.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":241,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":241,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9497,9500],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9497,9500],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":324,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":324,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[12059,12118],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n\nimport { ipcMain } from 'electron'\nimport type { BrowserWindow as BrowserWindowType } from 'electron'\nimport { TerminalService } from '../terminal/terminalService'\n\nlet terminalService: TerminalService | null = null\n\nexport function registerTerminalHandlers(\n    _ipcMain: Electron.IpcMain, // We use the global ipcMain in the implementation below or pass it (it's passed but we can close over it)\n    getMainWindow: () => BrowserWindowType | null,\n    getCurrentWorkspacePath: () => string | null\n) {\n    // Initialize Terminal Service\n    if (!terminalService) {\n        terminalService = new TerminalService(getMainWindow, getCurrentWorkspacePath)\n    }\n\n    // ==========================================\n    // Terminal APIs\n    // ==========================================\n    ipcMain.handle('terminal:spawn', async (_event, options) => {\n        return terminalService!.spawnTerminal(options)\n    })\n\n    ipcMain.handle('terminal:write', async (_event, options) => {\n        return terminalService!.writeToTerminal(options.id, options.data)\n    })\n\n    // Alias for writeOutput - same as write for compatibility\n    ipcMain.handle('terminal:writeOutput', async (_event, options) => {\n        return terminalService!.writeToTerminal(options.id, options.data)\n    })\n\n    ipcMain.handle('terminal:resize', async (_event, options) => {\n        return terminalService!.resizeTerminal(options.id, options.cols, options.rows)\n    })\n\n    ipcMain.handle('terminal:kill', async (_event, id) => {\n        // Handle object form {id, signal} or string id\n        if (typeof id === 'object') {\n            return terminalService!.killTerminal(id.id, id.signal)\n        }\n        return terminalService!.killTerminal(id)\n    })\n\n    ipcMain.handle('terminal:sendSignal', async (_event, options) => {\n        return terminalService!.sendSignal(options.id, options.signal)\n    })\n\n    ipcMain.handle('terminal:getInfo', async (_event, id) => {\n        const info = await terminalService!.getTerminalInfo(id)\n        return { success: !!info, info }\n    })\n\n    ipcMain.handle('terminal:getAll', async () => {\n        const terminals = terminalService!.getAllTerminals()\n        // Map to serializable format\n        const serialized = await Promise.all(terminals.map(t => terminalService!.getTerminalInfo(t.id)))\n        return { success: true, terminals: serialized }\n    })\n\n    ipcMain.handle('terminal:fork', async (_event, options) => {\n        const success = await terminalService!.forkTerminal(options.sourceId, options.newId)\n        return { success }\n    })\n\n    ipcMain.handle('terminal:sendSequence', async (_event, options) => {\n        const success = await terminalService!.sendTerminalSequence(options.id, options.sequence)\n        return { success }\n    })\n\n    ipcMain.handle('terminal:clearHistory', async (_event, id) => {\n        const success = await terminalService!.clearTerminalHistory(id)\n        return { success }\n    })\n\n    ipcMain.handle('terminal:saveState', async (_event, id) => {\n        return terminalService!.saveTerminalState(id)\n    })\n\n    ipcMain.handle('terminal:restoreState', async (_event, state) => {\n        return terminalService!.restoreTerminalState(state)\n    })\n\n    ipcMain.handle('terminal:broadcast', async (_event, options) => {\n        const count = await terminalService!.broadcastToTerminals(options.data)\n        return { success: true, count }\n    })\n\n    ipcMain.handle('terminal:getCommandHistory', async (_event, terminalId) => {\n        const history = terminalService!.shellIntegration.getCommandHistory(terminalId)\n        return { success: true, history }\n    })\n\n    ipcMain.handle('terminal:getCurrentCommand', async (_event, terminalId) => {\n        const command = terminalService!.shellIntegration.getCurrentCommand(terminalId)\n        return { success: true, command }\n    })\n\n    // ==========================================\n    // Language Runtime APIs\n    // ==========================================\n    ipcMain.handle('runtime:startLSP', async (_event, options) => {\n        return terminalService!.languageGateway.loadLanguageServer(options)\n    })\n\n    ipcMain.handle('runtime:stopLSP', async (_event, sessionId) => {\n        return terminalService!.languageGateway.stopLanguageServer(sessionId)\n    })\n\n    ipcMain.handle('runtime:sendLSPRequest', async (_event, options) => {\n        return terminalService!.languageGateway.sendLSPRequest(options.sessionId, options.method, options.params)\n    })\n\n    ipcMain.handle('runtime:getLanguageServers', async () => {\n        const servers = await terminalService!.languageGateway.getLanguageServers()\n        return { success: true, servers }\n    })\n\n    ipcMain.handle('runtime:startDebug', async (_event, options) => {\n        return terminalService!.languageGateway.startDebugSession(options)\n    })\n\n    ipcMain.handle('runtime:stopDebug', async (_event, sessionId) => {\n        return terminalService!.languageGateway.stopDebugSession(sessionId)\n    })\n\n    ipcMain.handle('runtime:sendDebugRequest', async (_event, options) => {\n        return terminalService!.languageGateway.sendDebugRequest(options.sessionId, options.method, options.params)\n    })\n\n    ipcMain.handle('runtime:getDebugSessions', async () => {\n        const sessions = await terminalService!.languageGateway.getDebugSessions()\n        return { success: true, sessions }\n    })\n\n    // ==========================================\n    // Task Runner APIs\n    // ==========================================\n    ipcMain.handle('tasks:detectTasks', async (_event, workspacePath) => {\n        const tasks = await terminalService!.taskRunner.detectTasks(workspacePath)\n        return { success: true, tasks }\n    })\n\n    ipcMain.handle('tasks:executeTask', async (_event, options) => {\n        return terminalService!.taskRunner.executeTask({\n            ...options,\n            terminalService: terminalService,\n            getMainWindow: getMainWindow\n        })\n    })\n\n    ipcMain.handle('tasks:killTask', async (_event, executionId) => {\n        const success = await terminalService!.taskRunner.killTaskExecution(executionId)\n        return { success }\n    })\n\n    ipcMain.handle('tasks:getExecutions', async () => {\n        const executions = await terminalService!.taskRunner.getTaskExecutions()\n        return { success: true, executions }\n    })\n\n    ipcMain.handle('tasks:getExecution', async (_event, executionId) => {\n        const execution = await terminalService!.taskRunner.getTaskExecution(executionId)\n        return { success: !!execution, execution }\n    })\n\n    // ==========================================\n    // Session Management APIs\n    // ==========================================\n    ipcMain.handle('sessions:createSession', async (_event, options) => {\n        const session = terminalService!.sessionManager.createSession(options)\n        return { success: true, session }\n    })\n\n    ipcMain.handle('sessions:getSession', async (_event, sessionId) => {\n        const session = terminalService!.sessionManager.getSession(sessionId)\n        return { success: !!session, session }\n    })\n\n    ipcMain.handle('sessions:updateSession', async (_event, options) => {\n        const success = terminalService!.sessionManager.updateSession(options.sessionId, options.updates)\n        return { success }\n    })\n\n    ipcMain.handle('sessions:deleteSession', async (_event, sessionId) => {\n        const success = terminalService!.sessionManager.deleteSession(sessionId)\n        return { success }\n    })\n\n    ipcMain.handle('sessions:getAllSessions', async () => {\n        const sessions = terminalService!.sessionManager.getAllSessions()\n        return { success: true, sessions }\n    })\n\n    ipcMain.handle('sessions:getActiveSessions', async () => {\n        const sessions = terminalService!.sessionManager.getActiveSessions()\n        return { success: true, sessions }\n    })\n\n    ipcMain.handle('sessions:saveSession', async (_event, sessionId) => {\n        const success = terminalService!.sessionManager.saveSession(sessionId)\n        return { success }\n    })\n\n    ipcMain.handle('sessions:loadSession', async (_event, sessionId) => {\n        const session = terminalService!.sessionManager.loadSession(sessionId)\n        return { success: !!session, session }\n    })\n\n    ipcMain.handle('sessions:exportSession', async (_event, options) => {\n        const success = terminalService!.sessionManager.exportSession(options.sessionId, options.exportPath)\n        return { success }\n    })\n\n    ipcMain.handle('sessions:importSession', async (_event, importPath) => {\n        const sessionId = terminalService!.sessionManager.importSession(importPath)\n        return { success: !!sessionId, sessionId }\n    })\n\n    ipcMain.handle('sessions:getStats', async () => {\n        const stats = terminalService!.sessionManager.getSessionStats()\n        return { success: true, stats }\n    })\n\n    ipcMain.handle('sessions:clearOldSessions', async (_event, maxAgeHours) => {\n        const count = terminalService!.sessionManager.clearOldSessions(maxAgeHours)\n        return { success: true, count }\n    })\n\n    // ==========================================\n    // Event Forwarding\n    // ==========================================\n    setupEventForwarding(terminalService, getMainWindow)\n}\n\nfunction setupEventForwarding(service: TerminalService, getMainWindow: () => BrowserWindowType | null) {\n    const send = (channel: string, data: any) => {\n        const win = getMainWindow()\n        if (win && !win.isDestroyed()) {\n            win.webContents.send(channel, data)\n        }\n    }\n\n    // Shell Integration Events\n    service.shellIntegration.on('command_recorded', (command) => {\n        send('terminal:commandFinished', command)\n    })\n    service.shellIntegration.on('decorations_available', (data) => {\n        send('terminal:decorationsAvailable', data)\n    })\n\n    // Language Gateway Events\n    service.languageGateway.on('language_server_started', (data) => {\n        send('runtime:languageServerStarted', data)\n    })\n    service.languageGateway.on('language_server_stopped', (data) => {\n        send('runtime:languageServerStopped', data)\n    })\n    service.languageGateway.on('debug_session_started', (data) => {\n        send('runtime:debugSessionStarted', data)\n    })\n    service.languageGateway.on('debug_session_stopped', (data) => {\n        send('runtime:debugSessionStopped', data)\n    })\n    service.languageGateway.on('debug_session_error', (data) => {\n        send('runtime:debugSessionError', data)\n    })\n\n    // Task Runner Events\n    service.taskRunner.on('task_output', (data) => {\n        send('tasks:output', data)\n    })\n    service.taskRunner.on('task_completed', (data) => {\n        send('tasks:completed', data)\n    })\n    service.taskRunner.on('task_error', (data) => {\n        send('tasks:error', data)\n    })\n    service.taskRunner.on('task_cancelled', (data) => {\n        send('tasks:cancelled', data)\n    })\n\n    // Session Manager Events\n    service.sessionManager.on('session_created', (session) => {\n        send('sessions:created', session)\n    })\n    service.sessionManager.on('session_updated', (data) => {\n        send('sessions:updated', data)\n    })\n    service.sessionManager.on('session_deleted', (sessionId) => {\n        send('sessions:deleted', { sessionId })\n    })\n\n    // Group Events\n    service.sessionManager.on('group_created', (group) => {\n        send('sessions:groupCreated', group)\n    })\n    service.sessionManager.on('group_updated', (data) => {\n        send('sessions:groupUpdated', data)\n    })\n}\n\n/**\n * Kill all active terminal sessions\n * @returns Number of terminals killed\n */\nexport function killAllTerminals(): number {\n    if (!terminalService) {\n        return 0\n    }\n\n    const terminals = terminalService.getAllTerminals()\n    let killedCount = 0\n\n    for (const terminal of terminals) {\n        try {\n            terminalService.killTerminal(terminal.id)\n            killedCount++\n        } catch (e) {\n            console.error(`Failed to kill terminal ${terminal.id}:`, e)\n        }\n    }\n\n    return killedCount\n}\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\electron\\handlers\\update-handler.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":20,"column":32,"nodeType":"MemberExpression","messageId":"unexpected","endLine":20,"endColumn":43},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":21,"column":32,"nodeType":"MemberExpression","messageId":"unexpected","endLine":21,"endColumn":44},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":22,"column":33,"nodeType":"MemberExpression","messageId":"unexpected","endLine":22,"endColumn":46},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":23,"column":33,"nodeType":"MemberExpression","messageId":"unexpected","endLine":23,"endColumn":44},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":48,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":48,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1346,1349],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1346,1349],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":74,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":74,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[2243,2308],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":85,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":85,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[2497,2551],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":100,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":100,"endColumn":29,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[3037,3108],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":108,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":108,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[3420,3479],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":129,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":129,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[4027,4074],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":150,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":150,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[4855,4914],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":161,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":161,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[5355,5407],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":198,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":198,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[7130,7181],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":205,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":205,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[7352,7400],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":218,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":218,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[7708,7767],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":227,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":227,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[8019,8066],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":256,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":256,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[8713,8776],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":265,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":265,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[9023,9078],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":279,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":279,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[9528,9603],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":298,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":298,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[10198,10272],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":307,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":307,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[10532,10588],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":322,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":322,"endColumn":22,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[11056,11095],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":336,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":336,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[11504,11551],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'mainWindow' is defined but never used. Allowed unused args must match /^_/u.","line":348,"column":45,"nodeType":"Identifier","messageId":"unusedVar","endLine":348,"endColumn":55},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":353,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":353,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[12025,12085],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":356,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":356,"endColumn":30,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[12187,12243],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":365,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":365,"endColumn":32,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[12621,12680],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":369,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":369,"endColumn":30,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[12805,12860],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":374,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":374,"endColumn":22,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[12937,12991],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":28,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\nimport { autoUpdater } from 'electron-updater'\r\nimport type { IpcMain, BrowserWindow } from 'electron'\r\n\r\n/**\r\n * Secure Auto-Update Handler for Kalynt\r\n *\r\n * Security Features:\r\n * - Uses HTTPS for all GitHub communications\r\n * - Supports code signature verification (when configured)\r\n * - GitHub token stored securely via safeStorage\r\n * - No sensitive data exposed to renderer process\r\n * - All update operations happen in main process\r\n */\r\n\r\n// Simple logger for electron-updater\r\nconst updateLogger = {\r\n    info: (message: string) => console.log('[Update]', message),\r\n    warn: (message: string) => console.warn('[Update]', message),\r\n    error: (message: string) => console.error('[Update]', message),\r\n    debug: (message: string) => console.log('[Update][Debug]', message)\r\n}\r\n\r\ninterface UpdateInfo {\r\n    version: string\r\n    releaseNotes?: string\r\n    releaseDate: string\r\n    releaseName?: string\r\n}\r\n\r\ninterface UpdateProgress {\r\n    bytesPerSecond: number\r\n    percent: number\r\n    transferred: number\r\n    total: number\r\n}\r\n\r\nlet updateCheckInProgress = false\r\nlet downloadInProgress = false\r\n\r\n/**\r\n * Configure auto-updater with security settings\r\n */\r\nfunction configureAutoUpdater(githubToken?: string) {\r\n    // Enable logging\r\n    autoUpdater.logger = updateLogger as any\r\n\r\n    // Security: Only allow HTTPS\r\n    autoUpdater.forceDevUpdateConfig = false\r\n\r\n    // Auto-download is disabled - user must explicitly approve\r\n    autoUpdater.autoDownload = false\r\n\r\n    // Auto-install is disabled - user must explicitly approve\r\n    autoUpdater.autoInstallOnAppQuit = false\r\n\r\n    // Set update channel (latest, beta, alpha, etc.)\r\n    autoUpdater.channel = process.env.UPDATE_CHANNEL || 'latest'\r\n\r\n    // Allow prerelease if channel is not 'latest'\r\n    autoUpdater.allowPrerelease = autoUpdater.channel !== 'latest'\r\n\r\n    // Configure GitHub token if provided\r\n    if (githubToken) {\r\n        autoUpdater.setFeedURL({\r\n            provider: 'github',\r\n            owner: process.env.GITHUB_REPO_OWNER || 'HermesLekkas',\r\n            repo: process.env.GITHUB_REPO_NAME || 'kalynt',\r\n            private: false,\r\n            token: githubToken\r\n        })\r\n        console.log('[Update] GitHub token configured for update checks')\r\n    }\r\n}\r\n\r\n/**\r\n * Register all update-related IPC handlers\r\n */\r\nexport function registerUpdateHandlers(\r\n    ipcMain: IpcMain,\r\n    getMainWindow: () => BrowserWindow | null\r\n) {\r\n    console.log('[Update] Registering update handlers...')\r\n\r\n    // Configure auto-updater with default settings\r\n    configureAutoUpdater()\r\n\r\n    // Set up event listeners to forward to renderer\r\n    setupAutoUpdaterEvents(getMainWindow)\r\n\r\n    /**\r\n     * Configure GitHub token for updates\r\n     * Token is passed from renderer after being retrieved from safeStorage\r\n     */\r\n    ipcMain.handle('update:configure-token', async (_event, token: string) => {\r\n        try {\r\n            if (!token || token.trim() === '') {\r\n                console.warn('[Update] Empty token provided, using public access only')\r\n                configureAutoUpdater()\r\n                return { success: true, message: 'Using public access for updates' }\r\n            }\r\n\r\n            configureAutoUpdater(token)\r\n            return { success: true, message: 'GitHub token configured successfully' }\r\n        } catch (error) {\r\n            console.error('[Update] Token configuration error:', error)\r\n            return {\r\n                success: false,\r\n                error: error instanceof Error ? error.message : String(error)\r\n            }\r\n        }\r\n    })\r\n\r\n    /**\r\n     * Check for updates manually\r\n     */\r\n    ipcMain.handle('update:check', async () => {\r\n        try {\r\n            if (updateCheckInProgress) {\r\n                return {\r\n                    success: false,\r\n                    error: 'Update check already in progress'\r\n                }\r\n            }\r\n\r\n            updateCheckInProgress = true\r\n            console.log('[Update] Checking for updates...')\r\n\r\n            const result = await autoUpdater.checkForUpdates()\r\n            updateCheckInProgress = false\r\n\r\n            if (!result) {\r\n                return {\r\n                    success: true,\r\n                    updateAvailable: false,\r\n                    currentVersion: autoUpdater.currentVersion.version,\r\n                    message: 'No updates available or repository not found'\r\n                }\r\n            }\r\n\r\n            const updateInfo: UpdateInfo = {\r\n                version: result.updateInfo.version,\r\n                releaseNotes: result.updateInfo.releaseNotes as string | undefined,\r\n                releaseDate: result.updateInfo.releaseDate,\r\n                releaseName: result.updateInfo.releaseName ?? undefined\r\n            }\r\n\r\n            console.log('[Update] Update check completed:', updateInfo)\r\n\r\n            return {\r\n                success: true,\r\n                updateAvailable: result.updateInfo.version !== autoUpdater.currentVersion.version,\r\n                updateInfo,\r\n                currentVersion: autoUpdater.currentVersion.version\r\n            }\r\n        } catch (error) {\r\n            updateCheckInProgress = false\r\n            const errorMessage = error instanceof Error ? error.message : String(error)\r\n            console.error('[Update] Check error:', errorMessage)\r\n\r\n            // Provide helpful error messages for common issues\r\n            let userFriendlyError = errorMessage\r\n            if (errorMessage.includes('404') || errorMessage.includes('Not Found')) {\r\n                userFriendlyError = 'GitHub repository or releases not found. Make sure the repository exists and has published releases.'\r\n            } else if (errorMessage.includes('401') || errorMessage.includes('Unauthorized')) {\r\n                userFriendlyError = 'GitHub token is invalid or expired. Please update your token in Settings > Security.'\r\n            } else if (errorMessage.includes('403') || errorMessage.includes('Forbidden')) {\r\n                userFriendlyError = 'Access denied. Check that your GitHub token has the required permissions.'\r\n            } else if (errorMessage.includes('ENOTFOUND') || errorMessage.includes('network')) {\r\n                userFriendlyError = 'Network error. Please check your internet connection.'\r\n            } else if (errorMessage.includes('no published releases')) {\r\n                userFriendlyError = 'No releases found. Publish a release on GitHub first.'\r\n            }\r\n\r\n            return {\r\n                success: false,\r\n                error: userFriendlyError,\r\n                currentVersion: autoUpdater.currentVersion?.version || 'unknown'\r\n            }\r\n        }\r\n    })\r\n\r\n    /**\r\n     * Download update\r\n     */\r\n    ipcMain.handle('update:download', async () => {\r\n        try {\r\n            if (downloadInProgress) {\r\n                return {\r\n                    success: false,\r\n                    error: 'Download already in progress'\r\n                }\r\n            }\r\n\r\n            downloadInProgress = true\r\n            console.log('[Update] Starting update download...')\r\n\r\n            await autoUpdater.downloadUpdate()\r\n\r\n            return { success: true }\r\n        } catch (error) {\r\n            downloadInProgress = false\r\n            console.error('[Update] Download error:', error)\r\n            return {\r\n                success: false,\r\n                error: error instanceof Error ? error.message : String(error)\r\n            }\r\n        }\r\n    })\r\n\r\n    /**\r\n     * Install update and restart app\r\n     */\r\n    ipcMain.handle('update:install', async () => {\r\n        try {\r\n            console.log('[Update] Installing update and restarting...')\r\n\r\n            // This will quit the app and install the update\r\n            setImmediate(() => {\r\n                autoUpdater.quitAndInstall(false, true)\r\n            })\r\n\r\n            return { success: true }\r\n        } catch (error) {\r\n            console.error('[Update] Install error:', error)\r\n            return {\r\n                success: false,\r\n                error: error instanceof Error ? error.message : String(error)\r\n            }\r\n        }\r\n    })\r\n\r\n    /**\r\n     * Get current version\r\n     */\r\n    ipcMain.handle('update:get-version', () => {\r\n        return {\r\n            success: true,\r\n            version: autoUpdater.currentVersion.version\r\n        }\r\n    })\r\n\r\n    /**\r\n     * Get update status\r\n     */\r\n    ipcMain.handle('update:get-status', () => {\r\n        return {\r\n            success: true,\r\n            checking: updateCheckInProgress,\r\n            downloading: downloadInProgress\r\n        }\r\n    })\r\n\r\n    console.log('[Update] Update handlers registered successfully')\r\n}\r\n\r\n/**\r\n * Set up auto-updater event listeners and forward to renderer\r\n */\r\nfunction setupAutoUpdaterEvents(getMainWindow: () => BrowserWindow | null) {\r\n    // Update is available\r\n    autoUpdater.on('update-available', (info) => {\r\n        console.log('[Update] Update available:', info.version)\r\n        const mainWindow = getMainWindow()\r\n        if (mainWindow) {\r\n            mainWindow.webContents.send('update:available', {\r\n                version: info.version,\r\n                releaseNotes: info.releaseNotes,\r\n                releaseDate: info.releaseDate,\r\n                releaseName: info.releaseName\r\n            })\r\n        }\r\n    })\r\n\r\n    // No update available\r\n    autoUpdater.on('update-not-available', (info) => {\r\n        console.log('[Update] No update available, current version:', info.version)\r\n        updateCheckInProgress = false\r\n        const mainWindow = getMainWindow()\r\n        if (mainWindow) {\r\n            mainWindow.webContents.send('update:not-available', {\r\n                version: info.version\r\n            })\r\n        }\r\n    })\r\n\r\n    // Download progress\r\n    autoUpdater.on('download-progress', (progressObj) => {\r\n        const progress: UpdateProgress = {\r\n            bytesPerSecond: progressObj.bytesPerSecond,\r\n            percent: progressObj.percent,\r\n            transferred: progressObj.transferred,\r\n            total: progressObj.total\r\n        }\r\n\r\n        console.log(`[Update] Download progress: ${progress.percent.toFixed(2)}%`)\r\n        const mainWindow = getMainWindow()\r\n        if (mainWindow) {\r\n            mainWindow.webContents.send('update:download-progress', progress)\r\n        }\r\n    })\r\n\r\n    // Update downloaded\r\n    autoUpdater.on('update-downloaded', (info) => {\r\n        console.log('[Update] Update downloaded:', info.version)\r\n        downloadInProgress = false\r\n        const mainWindow = getMainWindow()\r\n        if (mainWindow) {\r\n            mainWindow.webContents.send('update:downloaded', {\r\n                version: info.version,\r\n                releaseNotes: info.releaseNotes,\r\n                releaseDate: info.releaseDate,\r\n                releaseName: info.releaseName\r\n            })\r\n        }\r\n    })\r\n\r\n    // Error occurred\r\n    autoUpdater.on('error', (error) => {\r\n        console.error('[Update] Error:', error)\r\n        updateCheckInProgress = false\r\n        downloadInProgress = false\r\n        const mainWindow = getMainWindow()\r\n        if (mainWindow) {\r\n            mainWindow.webContents.send('update:error', {\r\n                message: error.message,\r\n                stack: error.stack\r\n            })\r\n        }\r\n    })\r\n\r\n    // Checking for updates\r\n    autoUpdater.on('checking-for-update', () => {\r\n        console.log('[Update] Checking for updates...')\r\n        const mainWindow = getMainWindow()\r\n        if (mainWindow) {\r\n            mainWindow.webContents.send('update:checking')\r\n        }\r\n    })\r\n}\r\n\r\n/**\r\n * Initialize auto-update on app startup\r\n * Call this from main.ts after the app is ready\r\n */\r\nexport async function initializeAutoUpdater(mainWindow: BrowserWindow) {\r\n    try {\r\n        // Wait a bit after app launch to check for updates\r\n        setTimeout(async () => {\r\n            try {\r\n                console.log('[Update] Performing automatic update check...')\r\n                await autoUpdater.checkForUpdates()\r\n            } catch (error) {\r\n                console.error('[Update] Automatic check failed:', error)\r\n            }\r\n        }, 5000) // Check 5 seconds after app starts\r\n\r\n        // Set up periodic checks (every hour by default)\r\n        const checkInterval = Number.parseInt(process.env.UPDATE_CHECK_INTERVAL_MS || '3600000', 10)\r\n        setInterval(async () => {\r\n            try {\r\n                if (!updateCheckInProgress && !downloadInProgress) {\r\n                    console.log('[Update] Performing periodic update check...')\r\n                    await autoUpdater.checkForUpdates()\r\n                }\r\n            } catch (error) {\r\n                console.error('[Update] Periodic check failed:', error)\r\n            }\r\n        }, checkInterval)\r\n\r\n    } catch (error) {\r\n        console.error('[Update] Initialization error:', error)\r\n    }\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\electron\\main.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":48,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":48,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[1930,1987],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":59,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":59,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[2247,2306],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":238,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":238,"endColumn":30,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[7373,7436],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\nimport { app, BrowserWindow, ipcMain, dialog } from 'electron'\r\nimport type { BrowserWindow as BrowserWindowType } from 'electron'\r\nimport path from 'node:path'\r\nimport fs from 'node:fs'\r\n\r\n// Import services\r\nimport { RuntimeManager } from './services/runtime-manager'\r\n\r\n// Import handlers\r\nimport { registerAppInfoHandlers } from './handlers/app-info'\r\nimport { registerRuntimeHandlers } from './handlers/runtime'\r\nimport { registerTerminalHandlers } from './handlers/terminal'\r\nimport { registerGitHandlers } from './handlers/git'\r\nimport { registerFileSystemHandlers } from './handlers/file-system'\r\nimport { registerCodeExecutionHandlers } from './handlers/code-execution'\r\nimport { registerModelDownloadHandlers } from './handlers/model-download'\r\nimport { registerLLMInferenceHandlers } from './handlers/llm-inference'\r\nimport { registerSafeStorageHandlers } from './handlers/safeStorage'\r\nimport { registerNukeHandlers } from './handlers/nuke-handler'\r\nimport { registerDependencyHandlers } from './handlers/dependency'\r\nimport { setupBuildHandlers } from './handlers/build'\r\nimport { setupDebugHandlers } from './handlers/debug'\r\nimport { registerUpdateHandlers, initializeAutoUpdater } from './handlers/update-handler'\r\n\r\n// Window and workspace state\r\nlet mainWindow: BrowserWindowType | null = null\r\nlet currentWorkspacePath: string | null = null\r\n\r\n// Environment\r\nconst VITE_DEV_SERVER_URL = process.env['VITE_DEV_SERVER_URL']\r\n\r\n// Directory constants (initialized after app is ready)\r\nlet MODELS_DIR: string\r\nlet RUNTIMES_DIR: string\r\n\r\n// Initialize services (will be set after app is ready)\r\nlet runtimeManager: RuntimeManager\r\n\r\n// Ensure models directory exists\r\nfunction ensureModelsDir() {\r\n    try {\r\n        fs.mkdirSync(MODELS_DIR, { recursive: true })\r\n    } catch (err) {\r\n        if ((err as NodeJS.ErrnoException).code !== 'EEXIST') {\r\n            console.error('[Main] Failed to ensure models dir:', err)\r\n        }\r\n    }\r\n}\r\n\r\n// Ensure runtimes directory exists\r\nfunction ensureRuntimesDir() {\r\n    try {\r\n        fs.mkdirSync(RUNTIMES_DIR, { recursive: true })\r\n    } catch (err) {\r\n        if ((err as NodeJS.ErrnoException).code !== 'EEXIST') {\r\n            console.error('[Main] Failed to ensure runtimes dir:', err)\r\n        }\r\n    }\r\n}\r\n\r\n// Window management\r\nfunction createWindow() {\r\n    const win = new BrowserWindow({\r\n        width: 1400,\r\n        height: 900,\r\n        minWidth: 800,\r\n        minHeight: 600,\r\n        frame: false,\r\n        titleBarStyle: process.platform === 'darwin' ? 'hiddenInset' : 'default',\r\n        ...(process.platform === 'darwin' && { trafficLightPosition: { x: 16, y: 16 } }),\r\n        icon: path.join(__dirname, VITE_DEV_SERVER_URL ? '../public/Kalynt_256x256.ico' : '../dist/Kalynt_256x256.ico'),\r\n        webPreferences: {\r\n            preload: path.join(__dirname, 'preload.js'),\r\n            nodeIntegration: false,\r\n            contextIsolation: true,\r\n            sandbox: false\r\n        },\r\n        transparent: true,\r\n        backgroundColor: '#00000000',\r\n        show: false\r\n    })\r\n\r\n    mainWindow = win\r\n\r\n    win.once('ready-to-show', () => {\r\n        win.show()\r\n    })\r\n\r\n    if (VITE_DEV_SERVER_URL) {\r\n        void win.loadURL(VITE_DEV_SERVER_URL)\r\n        win.webContents.openDevTools()\r\n    } else {\r\n        void win.loadFile(path.join(__dirname, '../dist/index.html'))\r\n    }\r\n\r\n    win.on('closed', () => {\r\n        mainWindow = null\r\n    })\r\n}\r\n\r\n// Register all IPC handlers\r\nfunction registerAllHandlers() {\r\n    // App info and hardware\r\n    registerAppInfoHandlers(ipcMain, app, MODELS_DIR)\r\n\r\n    // Runtime management\r\n    registerRuntimeHandlers(ipcMain, runtimeManager)\r\n\r\n    // Terminal operations\r\n    registerTerminalHandlers(\r\n        ipcMain,\r\n        () => mainWindow,\r\n        () => currentWorkspacePath\r\n    )\r\n\r\n    // Git operations\r\n    registerGitHandlers(ipcMain, () => currentWorkspacePath)\r\n\r\n    // File system operations\r\n    registerFileSystemHandlers(\r\n        ipcMain,\r\n        dialog,\r\n        () => mainWindow,\r\n        () => currentWorkspacePath,\r\n        (path) => currentWorkspacePath = path,\r\n        () => MODELS_DIR\r\n    )\r\n\r\n    // Code execution\r\n    registerCodeExecutionHandlers(\r\n        ipcMain,\r\n        app,\r\n        () => mainWindow,\r\n        () => currentWorkspacePath\r\n    )\r\n\r\n    // Model downloads\r\n    registerModelDownloadHandlers(\r\n        ipcMain,\r\n        () => mainWindow,\r\n        () => MODELS_DIR\r\n    )\r\n\r\n    // LLM inference\r\n    registerLLMInferenceHandlers(ipcMain, () => MODELS_DIR)\r\n\r\n    // Secure storage for API keys\r\n    registerSafeStorageHandlers(ipcMain, () => app.getPath('userData'))\r\n\r\n    // Nuke Button (Emergency Process Cleanup)\r\n    registerNukeHandlers()\r\n\r\n    // Dependency management (npm, pip, cargo, etc.)\r\n    registerDependencyHandlers(() => mainWindow)\r\n\r\n    // Build/Task system\r\n    setupBuildHandlers(ipcMain, () => mainWindow, () => currentWorkspacePath)\r\n\r\n    // Debug system\r\n    setupDebugHandlers(ipcMain, () => mainWindow, () => currentWorkspacePath)\r\n\r\n    // Auto-update system\r\n    registerUpdateHandlers(ipcMain, () => mainWindow)\r\n\r\n    // Window controls\r\n    ipcMain.handle('minimize-window', () => {\r\n        if (mainWindow && !mainWindow.isDestroyed()) {\r\n            mainWindow.minimize()\r\n        }\r\n    })\r\n\r\n    ipcMain.handle('maximize-window', () => {\r\n        if (mainWindow && !mainWindow.isDestroyed()) {\r\n            if (mainWindow.isMaximized()) {\r\n                mainWindow.unmaximize()\r\n            } else {\r\n                mainWindow.maximize()\r\n            }\r\n        }\r\n    })\r\n\r\n    ipcMain.handle('close-window', () => {\r\n        if (mainWindow && !mainWindow.isDestroyed()) {\r\n            mainWindow.close()\r\n        }\r\n    })\r\n}\r\n\r\n// App lifecycle\r\n// Register protocol client\r\nif (process.defaultApp) {\r\n    if (process.argv.length >= 2) {\r\n        app.setAsDefaultProtocolClient('kalynt', process.execPath, [path.resolve(process.argv[1])])\r\n    }\r\n} else {\r\n    app.setAsDefaultProtocolClient('kalynt')\r\n}\r\n\r\n// Force Single Instance Application\r\nconst gotTheLock = app.requestSingleInstanceLock()\r\n\r\nif (!gotTheLock) {\r\n    app.quit()\r\n} else {\r\n    app.on('second-instance', (_event, commandLine, _workingDirectory) => {\r\n        // Someone tried to run a second instance, we should focus our window.\r\n        if (mainWindow) {\r\n            if (mainWindow.isMinimized()) mainWindow.restore()\r\n            mainWindow.focus()\r\n\r\n            // Handle deep link on Windows/Linux\r\n            const deepLink = commandLine.find((arg) => arg.startsWith('kalynt://'))\r\n            if (deepLink) {\r\n                mainWindow.webContents.send('deep-link', deepLink)\r\n            }\r\n        }\r\n    })\r\n\r\n    app.whenReady().then(() => {\r\n        // Initialize directory paths\r\n        MODELS_DIR = path.join(app.getPath('userData'), 'models')\r\n        RUNTIMES_DIR = path.join(app.getPath('userData'), 'runtimes')\r\n\r\n        // Initialize services\r\n        runtimeManager = new RuntimeManager(RUNTIMES_DIR)\r\n\r\n        ensureModelsDir()\r\n        ensureRuntimesDir()\r\n        createWindow()\r\n        registerAllHandlers()\r\n\r\n        // Initialize auto-updater (after window is created)\r\n        if (mainWindow) {\r\n            initializeAutoUpdater(mainWindow).catch(err => {\r\n                console.error('[Main] Failed to initialize auto-updater:', err)\r\n            })\r\n        }\r\n    })\r\n}\r\n\r\n// Handle deep link on macOS\r\napp.on('open-url', (event, url) => {\r\n    event.preventDefault()\r\n    if (mainWindow) {\r\n        if (mainWindow.isMinimized()) mainWindow.restore()\r\n        mainWindow.focus()\r\n        mainWindow.webContents.send('deep-link', url)\r\n    }\r\n})\r\n\r\napp.on('window-all-closed', () => {\r\n    if (process.platform !== 'darwin') {\r\n        app.quit()\r\n    }\r\n})\r\n\r\napp.on('activate', () => {\r\n    if (BrowserWindow.getAllWindows().length === 0) {\r\n        createWindow()\r\n    }\r\n})\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\electron\\preload.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":18,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":18,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[477,480],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[477,480],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":31,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":31,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1138,1141],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1138,1141],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":33,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":33,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1222,1225],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1222,1225],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":41,"column":68,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":41,"endColumn":71,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1597,1600],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1597,1600],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":43,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":43,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1649,1652],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1649,1652],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":48,"column":86,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":48,"endColumn":89,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1945,1948],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1945,1948],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":50,"column":86,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":50,"endColumn":89,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2058,2061],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2058,2061],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":61,"column":73,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":61,"endColumn":76,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2604,2607],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2604,2607],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":63,"column":101,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":63,"endColumn":104,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2731,2734],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2731,2734],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":71,"column":88,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":71,"endColumn":91,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2965,2968],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2965,2968],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":75,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":75,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3171,3174],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3171,3174],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":75,"column":110,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":75,"endColumn":113,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3216,3219],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3216,3219],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":77,"column":69,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":77,"endColumn":72,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3310,3313],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3310,3313],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":80,"column":84,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":80,"endColumn":87,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3444,3447],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3444,3447],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":84,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":84,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3669,3672],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3669,3672],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":84,"column":112,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":84,"endColumn":115,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3714,3717],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3714,3717],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":86,"column":68,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":86,"endColumn":71,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3807,3810],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3807,3810],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":89,"column":103,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":89,"endColumn":106,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3952,3955],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3952,3955],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":93,"column":116,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":93,"endColumn":119,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4202,4205],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4202,4205],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":104,"column":81,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":104,"endColumn":84,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4602,4605],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4602,4605],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":106,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":106,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4670,4673],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4670,4673],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":110,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":110,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4903,4906],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4903,4906],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":112,"column":84,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":112,"endColumn":87,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5014,5017],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5014,5017],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":128,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":128,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5617,5620],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5617,5620],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":128,"column":76,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":128,"endColumn":79,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5663,5666],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5663,5666],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":130,"column":78,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":130,"endColumn":81,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5766,5769],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5766,5769],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":132,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":132,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5840,5843],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5840,5843],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":136,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":136,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6053,6056],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6053,6056],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":138,"column":69,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":138,"endColumn":72,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6149,6152],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6149,6152],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":142,"column":79,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":142,"endColumn":82,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6344,6347],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6344,6347],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":148,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":148,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6649,6652],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6649,6652],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":153,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":153,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6854,6857],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6854,6857],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":155,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":155,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6951,6954],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6951,6954],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'UpdateAPI' is defined but never used. Allowed unused vars must match /^_/u.","line":163,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":163,"endColumn":20},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":243,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":243,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9789,9792],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9789,9792],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":259,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":259,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10693,10696],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10693,10696],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":261,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":261,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10839,10842],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10839,10842],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":262,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":262,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10940,10943],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10940,10943],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":285,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":285,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12216,12219],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12216,12219],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":297,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":297,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13401,13404],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13401,13404],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":315,"column":77,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":315,"endColumn":80,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14702,14705],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14702,14705],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":318,"column":105,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":318,"endColumn":108,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14930,14933],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14930,14933],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":335,"column":92,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":335,"endColumn":95,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15769,15772],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15769,15772],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":338,"column":69,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":338,"endColumn":72,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16041,16044],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16041,16044],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":341,"column":88,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":341,"endColumn":91,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16312,16315],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16312,16315],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":344,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":344,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16586,16589],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16586,16589],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":349,"column":107,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":349,"endColumn":110,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16895,16898],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16895,16898],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":355,"column":120,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":355,"endColumn":123,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17357,17360],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17357,17360],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":378,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":378,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18632,18635],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18632,18635],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":408,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":408,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20285,20288],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20285,20288],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":410,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":410,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20499,20502],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20499,20502],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":422,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":422,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[21547,21550],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[21547,21550],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":425,"column":75,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":425,"endColumn":78,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[21737,21740],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[21737,21740],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":447,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":447,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[22883,22886],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[22883,22886],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":451,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":451,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[23221,23224],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[23221,23224],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":452,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":452,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[23300,23303],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[23300,23303],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":454,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":454,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[23467,23470],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[23467,23470],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":455,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":455,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[23553,23556],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[23553,23556],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":471,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":471,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[24116,24119],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[24116,24119],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":473,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":473,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[24274,24277],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[24274,24277],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":476,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":476,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[24417,24420],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[24417,24420],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":518,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":518,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[26894,26897],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[26894,26897],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":519,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":519,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[26967,26970],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[26967,26970],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":520,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":520,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[27040,27043],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[27040,27043],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":521,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":521,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[27115,27118],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[27115,27118],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":523,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":523,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[27278,27281],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[27278,27281],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":524,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":524,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[27357,27360],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[27357,27360],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":547,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":547,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[28386,28389],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[28386,28389],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":554,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":554,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[28720,28723],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[28720,28723],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":556,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":556,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[28935,28938],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[28935,28938],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":557,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":557,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[29021,29024],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[29021,29024],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":563,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":563,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[29265,29268],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[29265,29268],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":564,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":564,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[29351,29354],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[29351,29354],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":570,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":570,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[29594,29597],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[29594,29597],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":571,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":571,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[29680,29683],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[29680,29683],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":589,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":589,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[30423,30426],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[30423,30426],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":591,"column":72,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":591,"endColumn":75,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[30707,30710],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[30707,30710],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":600,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":600,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[31844,31847],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[31844,31847],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":601,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":601,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[31930,31933],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[31930,31933],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":607,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":607,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[32180,32183],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[32180,32183],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":608,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":608,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[32266,32269],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[32266,32269],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":614,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":614,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[32518,32521],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[32518,32521],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":615,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":615,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[32604,32607],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[32604,32607],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":621,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":621,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[32861,32864],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[32861,32864],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":622,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":622,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[32947,32950],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[32947,32950],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":628,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":628,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[33202,33205],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[33202,33205],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":629,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":629,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[33288,33291],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[33288,33291],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":635,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":635,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[33539,33542],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[33539,33542],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":636,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":636,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[33625,33628],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[33625,33628],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":642,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":642,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[33880,33883],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[33880,33883],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":643,"column":68,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":643,"endColumn":71,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[33967,33970],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[33967,33970],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":649,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":649,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[34219,34222],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[34219,34222],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":650,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":650,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[34309,34312],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[34309,34312],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":656,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":656,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[34563,34566],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[34563,34566],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":657,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":657,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[34649,34652],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[34649,34652],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":681,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":681,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[35714,35717],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[35714,35717],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":691,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":691,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[36186,36189],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[36186,36189],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":692,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":692,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[36273,36276],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[36273,36276],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":693,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":693,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[36360,36363],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[36360,36363],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":694,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":694,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[36448,36451],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[36448,36451],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":695,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":695,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[36549,36552],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[36549,36552],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":696,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":696,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[36665,36668],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[36665,36668],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":697,"column":90,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":697,"endColumn":93,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[36774,36777],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[36774,36777],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":699,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":699,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[36847,36850],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[36847,36850],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":700,"column":79,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":700,"endColumn":82,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[36945,36948],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[36945,36948],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":702,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":702,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[37015,37018],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[37015,37018],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":703,"column":76,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":703,"endColumn":79,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[37110,37113],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[37110,37113],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":727,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":727,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[38175,38178],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[38175,38178],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":728,"column":81,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":728,"endColumn":84,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[38275,38278],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[38275,38278],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":730,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":730,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[38360,38363],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[38360,38363],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":731,"column":85,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":731,"endColumn":88,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[38464,38467],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[38464,38467],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":733,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":733,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[38551,38554],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[38551,38554],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":734,"column":93,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":734,"endColumn":96,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[38663,38666],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[38663,38666],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":736,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":736,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[38750,38753],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[38750,38753],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":737,"column":82,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":737,"endColumn":85,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[38851,38854],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[38851,38854],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":739,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":739,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[38930,38933],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[38930,38933],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":740,"column":78,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":740,"endColumn":81,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[39027,39030],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[39027,39030],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":755,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":755,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[39704,39707],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[39704,39707],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":117,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n// preload/preload.ts\r\nimport { contextBridge, ipcRenderer, IpcRendererEvent } from 'electron'\r\n\r\n// Enhanced terminal interface\r\ninterface TerminalAPI {\r\n    spawn: (options: {\r\n        id: string\r\n        shell?: string\r\n        cwd?: string\r\n        cols?: number\r\n        rows?: number\r\n        env?: { [key: string]: string }\r\n        title?: string\r\n        processType?: 'shell' | 'task' | 'debug'\r\n        metadata?: any\r\n    }) => Promise<{ success: boolean; pid?: number; error?: string }>\r\n\r\n    write: (options: { id: string; data: string }) => Promise<{ success: boolean; error?: string }>\r\n\r\n    writeOutput: (options: { id: string; data: string }) => Promise<{ success: boolean; error?: string }>\r\n\r\n    resize: (options: { id: string; cols: number; rows: number }) => Promise<{ success: boolean; error?: string }>\r\n\r\n    kill: (id: string, signal?: string) => Promise<{ success: boolean; error?: string }>\r\n\r\n    sendSignal: (id: string, signal: string) => Promise<{ success: boolean; error?: string }>\r\n\r\n    getInfo: (id: string) => Promise<{ success: boolean; info?: any; error?: string }>\r\n\r\n    getAll: () => Promise<{ success: boolean; terminals?: any[]; error?: string }>\r\n\r\n    fork: (sourceId: string, newId: string) => Promise<{ success: boolean; error?: string }>\r\n\r\n    sendSequence: (id: string, sequence: string) => Promise<{ success: boolean; error?: string }>\r\n\r\n    clearHistory: (id: string) => Promise<{ success: boolean; error?: string }>\r\n\r\n    saveState: (id: string) => Promise<{ success: boolean; state?: any; error?: string }>\r\n\r\n    restoreState: (state: any) => Promise<{ success: boolean; id?: string; error?: string }>\r\n\r\n    broadcast: (data: string, filter?: string) => Promise<{ success: boolean; count?: number; error?: string }>\r\n\r\n    // Shell integration\r\n    getCommandHistory: (terminalId: string) => Promise<{ success: boolean; history?: any[]; error?: string }>\r\n\r\n    getCurrentCommand: (terminalId: string) => Promise<{ success: boolean; command?: any; error?: string }>\r\n\r\n    // Events\r\n    onData: (callback: (data: { id: string; data: string; type: string }) => void) => void\r\n\r\n    onExit: (callback: (data: { id: string; exitCode: number; signal?: number; title: string }) => void) => void\r\n\r\n    onSpawned: (callback: (data: { id: string; pid: number; title: string; cwd: string; shell: string }) => void) => void\r\n\r\n    onRestored: (callback: (data: { id: string; pid: number; title: string }) => void) => void\r\n\r\n    onCommandFinished: (callback: (data: { terminalId: string; command: any }) => void) => void\r\n\r\n    onDecorationsAvailable: (callback: (data: { terminalId: string; commandId: string; decorations: any[] }) => void) => void\r\n\r\n    removeListeners: () => void\r\n}\r\n\r\n// Language runtime interface\r\ninterface RuntimeAPI {\r\n    // Language servers\r\n    startLSP: (sessionId: string, languageId: string, workspacePath: string, options?: any) => Promise<{ success: boolean; error?: string }>\r\n\r\n    stopLSP: (sessionId: string) => Promise<{ success: boolean; error?: string }>\r\n\r\n    sendLSPRequest: (sessionId: string, method: string, params: any) => Promise<{ success: boolean; result?: any; error?: string }>\r\n\r\n    getLanguageServers: () => Promise<{ success: boolean; servers?: any[]; error?: string }>\r\n\r\n    // Debug sessions\r\n    startDebug: (sessionId: string, languageId: string, program: string, options?: any) => Promise<{ success: boolean; port?: number; error?: string }>\r\n\r\n    stopDebug: (sessionId: string) => Promise<{ success: boolean; error?: string }>\r\n\r\n    sendDebugRequest: (sessionId: string, method: string, params: any) => Promise<{ success: boolean; result?: any; error?: string }>\r\n\r\n    getDebugSessions: () => Promise<{ success: boolean; sessions?: any[]; error?: string }>\r\n\r\n    // Events\r\n    onLanguageServerStarted: (callback: (data: { sessionId: string; languageId: string; capabilities: any }) => void) => void\r\n\r\n    onLanguageServerStopped: (callback: (data: { sessionId: string; exitCode: number }) => void) => void\r\n\r\n    onDebugSessionStarted: (callback: (data: { sessionId: string; languageId: string; port: number; configuration: any }) => void) => void\r\n\r\n    onDebugSessionStopped: (callback: (data: { sessionId: string; exitCode: number }) => void) => void\r\n\r\n    onDebugSessionError: (callback: (data: { sessionId: string; error: string }) => void) => void\r\n\r\n    removeListeners: () => void\r\n}\r\n\r\n// Task runner interface\r\ninterface TasksAPI {\r\n    detectTasks: (workspacePath: string) => Promise<{ success: boolean; tasks?: any[]; error?: string }>\r\n\r\n    executeTask: (taskId: string, task: any) => Promise<{ success: boolean; executionId?: string; error?: string }>\r\n\r\n    killTask: (executionId: string) => Promise<{ success: boolean; error?: string }>\r\n\r\n    getExecutions: () => Promise<{ success: boolean; executions?: any[]; error?: string }>\r\n\r\n    getExecution: (executionId: string) => Promise<{ success: boolean; execution?: any; error?: string }>\r\n\r\n    // Events\r\n    onTaskOutput: (callback: (data: { executionId: string; type: 'stdout' | 'stderr'; data: string }) => void) => void\r\n\r\n    onTaskCompleted: (callback: (data: { executionId: string; exitCode: number; status: string; duration: number }) => void) => void\r\n\r\n    onTaskError: (callback: (data: { executionId: string; error: string }) => void) => void\r\n\r\n    onTaskCancelled: (callback: (data: { executionId: string }) => void) => void\r\n\r\n    removeListeners: () => void\r\n}\r\n\r\n// Session management interface\r\ninterface SessionsAPI {\r\n    createSession: (options: any) => Promise<{ success: boolean; session?: any; error?: string }>\r\n\r\n    getSession: (sessionId: string) => Promise<{ success: boolean; session?: any; error?: string }>\r\n\r\n    updateSession: (sessionId: string, updates: any) => Promise<{ success: boolean; error?: string }>\r\n\r\n    deleteSession: (sessionId: string) => Promise<{ success: boolean; error?: string }>\r\n\r\n    getAllSessions: () => Promise<{ success: boolean; sessions?: any[]; error?: string }>\r\n\r\n    getActiveSessions: () => Promise<{ success: boolean; sessions?: any[]; error?: string }>\r\n\r\n    saveSession: (sessionId: string) => Promise<{ success: boolean; error?: string }>\r\n\r\n    loadSession: (sessionId: string) => Promise<{ success: boolean; session?: any; error?: string }>\r\n\r\n    exportSession: (sessionId: string, exportPath: string) => Promise<{ success: boolean; error?: string }>\r\n\r\n    importSession: (importPath: string) => Promise<{ success: boolean; sessionId?: string; error?: string }>\r\n\r\n    getStats: () => Promise<{ success: boolean; stats?: any; error?: string }>\r\n\r\n    clearOldSessions: (maxAgeHours?: number) => Promise<{ success: boolean; count?: number; error?: string }>\r\n\r\n    // Events\r\n    onSessionCreated: (callback: (data: { session: any }) => void) => void\r\n\r\n    onSessionUpdated: (callback: (data: { sessionId: string; updates: any }) => void) => void\r\n\r\n    onSessionDeleted: (callback: (data: { sessionId: string }) => void) => void\r\n\r\n    removeListeners: () => void\r\n}\r\n\r\n// Auto-update interface\r\ninterface UpdateAPI {\r\n    // Configure GitHub token for authenticated updates\r\n    configureToken: (token: string) => Promise<{ success: boolean; message?: string; error?: string }>\r\n\r\n    // Check for updates manually\r\n    checkForUpdates: () => Promise<{\r\n        success: boolean\r\n        updateAvailable?: boolean\r\n        updateInfo?: {\r\n            version: string\r\n            releaseNotes?: string\r\n            releaseDate: string\r\n            releaseName?: string\r\n        }\r\n        currentVersion?: string\r\n        error?: string\r\n    }>\r\n\r\n    // Download available update\r\n    downloadUpdate: () => Promise<{ success: boolean; error?: string }>\r\n\r\n    // Install downloaded update and restart app\r\n    installUpdate: () => Promise<{ success: boolean; error?: string }>\r\n\r\n    // Get current app version\r\n    getVersion: () => Promise<{ success: boolean; version?: string; error?: string }>\r\n\r\n    // Get update status\r\n    getStatus: () => Promise<{ success: boolean; checking?: boolean; downloading?: boolean; error?: string }>\r\n\r\n    // Events\r\n    onUpdateChecking: (callback: () => void) => void\r\n\r\n    onUpdateAvailable: (callback: (info: {\r\n        version: string\r\n        releaseNotes?: string\r\n        releaseDate: string\r\n        releaseName?: string\r\n    }) => void) => void\r\n\r\n    onUpdateNotAvailable: (callback: (info: { version: string }) => void) => void\r\n\r\n    onDownloadProgress: (callback: (progress: {\r\n        bytesPerSecond: number\r\n        percent: number\r\n        transferred: number\r\n        total: number\r\n    }) => void) => void\r\n\r\n    onUpdateDownloaded: (callback: (info: {\r\n        version: string\r\n        releaseNotes?: string\r\n        releaseDate: string\r\n        releaseName?: string\r\n    }) => void) => void\r\n\r\n    onUpdateError: (callback: (error: { message: string; stack?: string }) => void) => void\r\n\r\n    removeListeners: () => void\r\n}\r\n\r\n// Enhanced Electron API with all terminal capabilities\r\ncontextBridge.exposeInMainWorld('electronAPI', {\r\n    // Platform info\r\n    platform: process.platform,\r\n\r\n    // App info\r\n    getAppPath: () => ipcRenderer.invoke('get-app-path'),\r\n    getVersion: () => ipcRenderer.invoke('get-version'),\r\n    getModelsDirectory: () => ipcRenderer.invoke('get-models-directory'),\r\n\r\n    // Hardware info\r\n    getHardwareInfo: () => ipcRenderer.invoke('get-hardware-info'),\r\n    getRealTimeStats: () => ipcRenderer.invoke('get-realtime-stats'),\r\n\r\n    // File operations\r\n    fileExists: (path: string) => ipcRenderer.invoke('file-exists', path),\r\n    deleteModel: (path: string) => ipcRenderer.invoke('delete-model', path),\r\n\r\n    // Model download\r\n    downloadModel: (options: any) => ipcRenderer.invoke('download-model', options),\r\n    cancelDownload: (modelId: string) => ipcRenderer.invoke('cancel-download', modelId),\r\n    pauseDownload: (modelId: string) => ipcRenderer.invoke('pause-download', modelId),\r\n    resumeDownload: (modelId: string) => ipcRenderer.invoke('resume-download', modelId),\r\n    onDownloadProgress: (callback: (progress: { modelId: string; bytesDownloaded: number; totalBytes: number; speed: number }) => void) => {\r\n        const listener = (_event: IpcRendererEvent, data: { modelId: string; bytesDownloaded: number; totalBytes: number; speed: number }) => {\r\n            callback(data)\r\n        }\r\n        ipcRenderer.on('download-progress', listener)\r\n        // Return cleanup function\r\n        return () => {\r\n            ipcRenderer.removeListener('download-progress', listener)\r\n        }\r\n    },\r\n\r\n    // LLM Inference\r\n    loadModel: (options: any) => ipcRenderer.invoke('load-model', options),\r\n    unloadModel: () => ipcRenderer.invoke('unload-model'),\r\n    generateCompletion: (options: any) => ipcRenderer.invoke('generate-completion', options),\r\n    generateCompletionStream: (options: any, onToken: (token: string) => void, onComplete: (error?: string) => void) => {\r\n        const requestId = Math.random().toString(36).substring(7)\r\n        const tokenListener = (_event: IpcRendererEvent, data: { requestId: string; token: string }) => {\r\n            if (data.requestId === requestId) onToken(data.token)\r\n        }\r\n        const completeListener = (_event: IpcRendererEvent, data: { requestId: string; error?: string }) => {\r\n            if (data.requestId === requestId) {\r\n                ipcRenderer.removeListener('generate-completion-token', tokenListener)\r\n                ipcRenderer.removeListener('generate-completion-complete', completeListener)\r\n                onComplete(data.error)\r\n            }\r\n        }\r\n        ipcRenderer.on('generate-completion-token', tokenListener)\r\n        ipcRenderer.on('generate-completion-complete', completeListener)\r\n        ipcRenderer.send('generate-completion-stream', { ...options, requestId })\r\n        return requestId\r\n    },\r\n    cancelGeneration: (requestId: string) => ipcRenderer.invoke('cancel-generation', requestId),\r\n\r\n    // ==========================================\r\n    // Enhanced Terminal API\r\n    // ==========================================\r\n    terminal: {\r\n        spawn: (options: any) => ipcRenderer.invoke('terminal:spawn', options),\r\n        write: (options: { id: string; data: string }) => ipcRenderer.invoke('terminal:write', options),\r\n        writeOutput: (options: { id: string; data: string }) => ipcRenderer.invoke('terminal:writeOutput', options),\r\n        resize: (options: { id: string; cols: number; rows: number }) => ipcRenderer.invoke('terminal:resize', options),\r\n        kill: (id: string, signal?: string) => ipcRenderer.invoke('terminal:kill', { id, signal }),\r\n        sendSignal: (id: string, signal: string) => ipcRenderer.invoke('terminal:sendSignal', { id, signal }),\r\n        getInfo: (id: string) => ipcRenderer.invoke('terminal:getInfo', id),\r\n        getAll: () => ipcRenderer.invoke('terminal:getAll'),\r\n        fork: (sourceId: string, newId: string) => ipcRenderer.invoke('terminal:fork', { sourceId, newId }),\r\n        sendSequence: (id: string, sequence: string) => ipcRenderer.invoke('terminal:sendSequence', { id, sequence }),\r\n        clearHistory: (id: string) => ipcRenderer.invoke('terminal:clearHistory', id),\r\n        saveState: (id: string) => ipcRenderer.invoke('terminal:saveState', id),\r\n        restoreState: (state: any) => ipcRenderer.invoke('terminal:restoreState', state),\r\n        broadcast: (data: string, filter?: string) => ipcRenderer.invoke('terminal:broadcast', { data, filter }),\r\n        getCommandHistory: (terminalId: string) => ipcRenderer.invoke('terminal:getCommandHistory', terminalId),\r\n        getCurrentCommand: (terminalId: string) => ipcRenderer.invoke('terminal:getCurrentCommand', terminalId),\r\n\r\n        // Events\r\n        onData: (callback: (data: { id: string; data: string; type: string }) => void) => {\r\n            ipcRenderer.on('terminal:data', (_event, data) => callback(data))\r\n        },\r\n        onExit: (callback: (data: { id: string; exitCode: number; signal?: number; title: string }) => void) => {\r\n            ipcRenderer.on('terminal:exit', (_event, data) => callback(data))\r\n        },\r\n        onSpawned: (callback: (data: { id: string; pid: number; title: string; cwd: string; shell: string }) => void) => {\r\n            ipcRenderer.on('terminal:spawned', (_event, data) => callback(data))\r\n        },\r\n        onRestored: (callback: (data: { id: string; pid: number; title: string }) => void) => {\r\n            ipcRenderer.on('terminal:restored', (_event, data) => callback(data))\r\n        },\r\n        onCommandFinished: (callback: (data: { terminalId: string; command: any }) => void) => {\r\n            ipcRenderer.on('terminal:commandFinished', (_event, data) => callback(data))\r\n        },\r\n        onDecorationsAvailable: (callback: (data: { terminalId: string; commandId: string; decorations: any[] }) => void) => {\r\n            ipcRenderer.on('terminal:decorationsAvailable', (_event, data) => callback(data))\r\n        },\r\n        removeListeners: () => {\r\n            ipcRenderer.removeAllListeners('terminal:data')\r\n            ipcRenderer.removeAllListeners('terminal:exit')\r\n            ipcRenderer.removeAllListeners('terminal:spawned')\r\n            ipcRenderer.removeAllListeners('terminal:restored')\r\n            ipcRenderer.removeAllListeners('terminal:commandFinished')\r\n            ipcRenderer.removeAllListeners('terminal:decorationsAvailable')\r\n        }\r\n    } as TerminalAPI,\r\n\r\n    // ==========================================\r\n    // Language Runtime API\r\n    // ==========================================\r\n    runtime: {\r\n        startLSP: (sessionId: string, languageId: string, workspacePath: string, options?: any) =>\r\n            ipcRenderer.invoke('runtime:startLSP', { sessionId, languageId, workspacePath, options }),\r\n        stopLSP: (sessionId: string) => ipcRenderer.invoke('runtime:stopLSP', sessionId),\r\n        sendLSPRequest: (sessionId: string, method: string, params: any) =>\r\n            ipcRenderer.invoke('runtime:sendLSPRequest', { sessionId, method, params }),\r\n        getLanguageServers: () => ipcRenderer.invoke('runtime:getLanguageServers'),\r\n        startDebug: (sessionId: string, languageId: string, program: string, options?: any) =>\r\n            ipcRenderer.invoke('runtime:startDebug', { sessionId, languageId, program, options }),\r\n        stopDebug: (sessionId: string) => ipcRenderer.invoke('runtime:stopDebug', sessionId),\r\n        sendDebugRequest: (sessionId: string, method: string, params: any) =>\r\n            ipcRenderer.invoke('runtime:sendDebugRequest', { sessionId, method, params }),\r\n        getDebugSessions: () => ipcRenderer.invoke('runtime:getDebugSessions'),\r\n\r\n        // Events\r\n        onLanguageServerStarted: (callback: (data: { sessionId: string; languageId: string; capabilities: any }) => void) => {\r\n            ipcRenderer.on('runtime:languageServerStarted', (_event, data) => callback(data))\r\n        },\r\n        onLanguageServerStopped: (callback: (data: { sessionId: string; exitCode: number }) => void) => {\r\n            ipcRenderer.on('runtime:languageServerStopped', (_event, data) => callback(data))\r\n        },\r\n        onDebugSessionStarted: (callback: (data: { sessionId: string; languageId: string; port: number; configuration: any }) => void) => {\r\n            ipcRenderer.on('runtime:debugSessionStarted', (_event, data) => callback(data))\r\n        },\r\n        onDebugSessionStopped: (callback: (data: { sessionId: string; exitCode: number }) => void) => {\r\n            ipcRenderer.on('runtime:debugSessionStopped', (_event, data) => callback(data))\r\n        },\r\n        onDebugSessionError: (callback: (data: { sessionId: string; error: string }) => void) => {\r\n            ipcRenderer.on('runtime:debugSessionError', (_event, data) => callback(data))\r\n        },\r\n        removeListeners: () => {\r\n            ipcRenderer.removeAllListeners('runtime:languageServerStarted')\r\n            ipcRenderer.removeAllListeners('runtime:languageServerStopped')\r\n            ipcRenderer.removeAllListeners('runtime:debugSessionStarted')\r\n            ipcRenderer.removeAllListeners('runtime:debugSessionStopped')\r\n            ipcRenderer.removeAllListeners('runtime:debugSessionError')\r\n        }\r\n    } as RuntimeAPI,\r\n\r\n    // ==========================================\r\n    // Task Runner API\r\n    // ==========================================\r\n    tasks: {\r\n        detectTasks: (workspacePath: string) => ipcRenderer.invoke('tasks:detectTasks', workspacePath),\r\n        executeTask: (taskId: string, task: any) => ipcRenderer.invoke('tasks:executeTask', { taskId, task }),\r\n        killTask: (executionId: string) => ipcRenderer.invoke('tasks:killTask', executionId),\r\n        getExecutions: () => ipcRenderer.invoke('tasks:getExecutions'),\r\n        getExecution: (executionId: string) => ipcRenderer.invoke('tasks:getExecution', executionId),\r\n\r\n        // Events\r\n        onTaskOutput: (callback: (data: { executionId: string; type: 'stdout' | 'stderr'; data: string }) => void) => {\r\n            ipcRenderer.on('tasks:output', (_event, data) => callback(data))\r\n        },\r\n        onTaskCompleted: (callback: (data: { executionId: string; exitCode: number; status: string; duration: number }) => void) => {\r\n            ipcRenderer.on('tasks:completed', (_event, data) => callback(data))\r\n        },\r\n        onTaskError: (callback: (data: { executionId: string; error: string }) => void) => {\r\n            ipcRenderer.on('tasks:error', (_event, data) => callback(data))\r\n        },\r\n        onTaskCancelled: (callback: (data: { executionId: string }) => void) => {\r\n            ipcRenderer.on('tasks:cancelled', (_event, data) => callback(data))\r\n        },\r\n        removeListeners: () => {\r\n            ipcRenderer.removeAllListeners('tasks:output')\r\n            ipcRenderer.removeAllListeners('tasks:completed')\r\n            ipcRenderer.removeAllListeners('tasks:error')\r\n            ipcRenderer.removeAllListeners('tasks:cancelled')\r\n        }\r\n    } as TasksAPI,\r\n\r\n    // ==========================================\r\n    // Session Management API\r\n    // ==========================================\r\n    sessions: {\r\n        createSession: (options: any) => ipcRenderer.invoke('sessions:createSession', options),\r\n        getSession: (sessionId: string) => ipcRenderer.invoke('sessions:getSession', sessionId),\r\n        updateSession: (sessionId: string, updates: any) => ipcRenderer.invoke('sessions:updateSession', { sessionId, updates }),\r\n        deleteSession: (sessionId: string) => ipcRenderer.invoke('sessions:deleteSession', sessionId),\r\n        getAllSessions: () => ipcRenderer.invoke('sessions:getAllSessions'),\r\n        getActiveSessions: () => ipcRenderer.invoke('sessions:getActiveSessions'),\r\n        saveSession: (sessionId: string) => ipcRenderer.invoke('sessions:saveSession', sessionId),\r\n        loadSession: (sessionId: string) => ipcRenderer.invoke('sessions:loadSession', sessionId),\r\n        exportSession: (sessionId: string, exportPath: string) => ipcRenderer.invoke('sessions:exportSession', { sessionId, exportPath }),\r\n        importSession: (importPath: string) => ipcRenderer.invoke('sessions:importSession', importPath),\r\n        getStats: () => ipcRenderer.invoke('sessions:getStats'),\r\n        clearOldSessions: (maxAgeHours?: number) => ipcRenderer.invoke('sessions:clearOldSessions', maxAgeHours),\r\n\r\n        // Events\r\n        onSessionCreated: (callback: (data: { session: any }) => void) => {\r\n            ipcRenderer.on('sessions:created', (_event, data) => callback(data))\r\n        },\r\n        onSessionUpdated: (callback: (data: { sessionId: string; updates: any }) => void) => {\r\n            ipcRenderer.on('sessions:updated', (_event, data) => callback(data))\r\n        },\r\n        onSessionDeleted: (callback: (data: { sessionId: string }) => void) => {\r\n            ipcRenderer.on('sessions:deleted', (_event, data) => callback(data))\r\n        },\r\n        removeListeners: () => {\r\n            ipcRenderer.removeAllListeners('sessions:created')\r\n            ipcRenderer.removeAllListeners('sessions:updated')\r\n            ipcRenderer.removeAllListeners('sessions:deleted')\r\n        }\r\n    } as SessionsAPI,\r\n\r\n    // ==========================================\r\n    // File System APIs (Enhanced)\r\n    // ==========================================\r\n    fs: {\r\n        openFolder: () => ipcRenderer.invoke('fs:openFolder'),\r\n        setWorkspace: (workspacePath: string) => ipcRenderer.invoke('fs:setWorkspace', workspacePath),\r\n        readDir: (dirPath: string) => ipcRenderer.invoke('fs:readDir', dirPath),\r\n        stat: (filePath: string) => ipcRenderer.invoke('fs:stat', filePath),\r\n        readFile: (filePath: string) => ipcRenderer.invoke('fs:readFile', filePath),\r\n        writeFile: (options: any) => ipcRenderer.invoke('fs:writeFile', options),\r\n        createFile: (filePath: string) => ipcRenderer.invoke('fs:createFile', filePath),\r\n        createDir: (dirPath: string) => ipcRenderer.invoke('fs:createDir', dirPath),\r\n        delete: (itemPath: string) => ipcRenderer.invoke('fs:delete', itemPath),\r\n        rename: (options: any) => ipcRenderer.invoke('fs:rename', options),\r\n        watchDir: (options: any) => ipcRenderer.invoke('fs:watchDir', options),\r\n        unwatchDir: (id: string) => ipcRenderer.invoke('fs:unwatchDir', id),\r\n        onChange: (callback: (data: any) => void) => {\r\n            const subscription = (_event: IpcRendererEvent, data: any) => callback(data)\r\n            ipcRenderer.on('fs:change', subscription)\r\n            return () => {\r\n                ipcRenderer.removeListener('fs:change', subscription)\r\n            }\r\n        },\r\n        removeListeners: () => {\r\n            ipcRenderer.removeAllListeners('fs:change')\r\n        },\r\n        backupWorkspace: () => ipcRenderer.invoke('fs:backup')\r\n    },\r\n\r\n    // ==========================================\r\n    // Code Execution APIs (Enhanced)\r\n    // ==========================================\r\n    code: {\r\n        execute: (options: any) => ipcRenderer.invoke('code:execute', options),\r\n        kill: (id: string) => ipcRenderer.invoke('code:kill', id),\r\n        onOutput: (callback: (data: any) => void) => {\r\n            ipcRenderer.on('code:output', (_event, data) => callback(data))\r\n        },\r\n        onExit: (callback: (data: any) => void) => {\r\n            ipcRenderer.on('code:exit', (_event, data) => callback(data))\r\n        },\r\n        removeListeners: () => {\r\n            ipcRenderer.removeAllListeners('code:output')\r\n            ipcRenderer.removeAllListeners('code:exit')\r\n        },\r\n        clearCache: () => ipcRenderer.invoke('code:clearCache')\r\n    },\r\n\r\n    // ==========================================\r\n    // Dependency Management APIs\r\n    // ==========================================\r\n    deps: {\r\n        detect: (workspacePath: string) => ipcRenderer.invoke('deps:detect', workspacePath),\r\n        getForLanguage: (languageId: string) => ipcRenderer.invoke('deps:getForLanguage', languageId),\r\n        install: (packageName: string, options: { workspacePath: string; global?: boolean; dev?: boolean; version?: string }) =>\r\n            ipcRenderer.invoke('deps:install', packageName, options),\r\n        installAll: (workspacePath: string) => ipcRenderer.invoke('deps:installAll', workspacePath),\r\n        uninstall: (packageName: string, workspacePath: string) => ipcRenderer.invoke('deps:uninstall', packageName, workspacePath),\r\n        update: (packageName: string | null, workspacePath: string) => ipcRenderer.invoke('deps:update', packageName, workspacePath),\r\n        list: (workspacePath: string) => ipcRenderer.invoke('deps:list', workspacePath),\r\n        init: (managerName: string, workspacePath: string) => ipcRenderer.invoke('deps:init', managerName, workspacePath),\r\n        getSupportedManagers: () => ipcRenderer.invoke('deps:getSupportedManagers'),\r\n        kill: (operationId: string) => ipcRenderer.invoke('deps:kill', operationId),\r\n        onOutput: (callback: (data: { operationId: string; type: string; data: string }) => void) => {\r\n            ipcRenderer.on('deps:output', (_event, data) => callback(data))\r\n        },\r\n        onComplete: (callback: (data: { operationId: string; success: boolean; exitCode?: number; error?: string }) => void) => {\r\n            ipcRenderer.on('deps:complete', (_event, data) => callback(data))\r\n        },\r\n        removeListeners: () => {\r\n            ipcRenderer.removeAllListeners('deps:output')\r\n            ipcRenderer.removeAllListeners('deps:complete')\r\n        }\r\n    },\r\n\r\n    // ==========================================\r\n    // Git APIs\r\n    // ==========================================\r\n    git: {\r\n        status: (repoPath: string) => ipcRenderer.invoke('git:status', repoPath),\r\n        log: (options: any) => ipcRenderer.invoke('git:log', options),\r\n        diff: (options: any) => ipcRenderer.invoke('git:diff', options),\r\n        add: (options: any) => ipcRenderer.invoke('git:add', options),\r\n        commit: (options: any) => ipcRenderer.invoke('git:commit', options),\r\n        branch: (repoPath: string) => ipcRenderer.invoke('git:branch', repoPath),\r\n        checkout: (options: any) => ipcRenderer.invoke('git:checkout', options),\r\n        reset: (options: any) => ipcRenderer.invoke('git:reset', options),\r\n        push: (repoPath: string) => ipcRenderer.invoke('git:push', repoPath),\r\n        pull: (repoPath: string) => ipcRenderer.invoke('git:pull', repoPath)\r\n    },\r\n\r\n    // ==========================================\r\n    // Shell Integration\r\n    // ==========================================\r\n    shell: {\r\n        openExternal: (url: string) => ipcRenderer.invoke('shell:openExternal', url),\r\n        showItemInFolder: (path: string) => ipcRenderer.invoke('shell:showItemInFolder', path)\r\n    },\r\n\r\n    // ==========================================\r\n    // Window Controls\r\n    // ==========================================\r\n    minimizeWindow: () => ipcRenderer.invoke('minimize-window'),\r\n    maximizeWindow: () => ipcRenderer.invoke('maximize-window'),\r\n    closeWindow: () => ipcRenderer.invoke('close-window'),\r\n\r\n    // ==========================================\r\n    // Emergency Controls\r\n    // ==========================================\r\n    nukeProcesses: (level: any) => ipcRenderer.invoke('nuke-processes', level),\r\n\r\n    // ==========================================\r\n    // Build/Task APIs (Enhanced)\r\n    // ==========================================\r\n    build: {\r\n        getTasks: (workspacePath: string) => ipcRenderer.invoke('build:getTasks', workspacePath),\r\n        executeTask: (task: any, workspacePath: string) => ipcRenderer.invoke('build:executeTask', task, workspacePath),\r\n        killTask: (taskId: string) => ipcRenderer.invoke('build:killTask', taskId),\r\n        onOutput: (callback: (data: any) => void) => {\r\n            const subscription = (_event: IpcRendererEvent, data: any) => callback(data)\r\n            ipcRenderer.on('build:output', subscription)\r\n            return () => {\r\n                ipcRenderer.removeListener('build:output', subscription)\r\n            }\r\n        },\r\n        onEnd: (callback: (data: any) => void) => {\r\n            const subscription = (_event: IpcRendererEvent, data: any) => callback(data)\r\n            ipcRenderer.on('build:end', subscription)\r\n            return () => {\r\n                ipcRenderer.removeListener('build:end', subscription)\r\n            }\r\n        },\r\n        onProblems: (callback: (data: any) => void) => {\r\n            const subscription = (_event: IpcRendererEvent, data: any) => callback(data)\r\n            ipcRenderer.on('build:problems', subscription)\r\n            return () => {\r\n                ipcRenderer.removeListener('build:problems', subscription)\r\n            }\r\n        },\r\n        removeListeners: () => {\r\n            ipcRenderer.removeAllListeners('build:output')\r\n            ipcRenderer.removeAllListeners('build:end')\r\n            ipcRenderer.removeAllListeners('build:problems')\r\n        }\r\n    },\r\n\r\n    // ==========================================\r\n    // Debug APIs (Enhanced)\r\n    // ==========================================\r\n    debug: {\r\n        getConfigurations: (workspacePath: string) => ipcRenderer.invoke('debug:getConfigurations', workspacePath),\r\n        start: (configuration: any, workspacePath: string, activeFile?: string) => ipcRenderer.invoke('debug:start', configuration, workspacePath, activeFile),\r\n        stop: (sessionId: string) => ipcRenderer.invoke('debug:stop', sessionId),\r\n        setBreakpoints: (sessionId: string, file: string, breakpoints: any) => ipcRenderer.invoke('debug:setBreakpoints', sessionId, file, breakpoints),\r\n        continue: (sessionId: string, threadId?: number) => ipcRenderer.invoke('debug:continue', sessionId, threadId),\r\n        stepOver: (sessionId: string, threadId?: number) => ipcRenderer.invoke('debug:stepOver', sessionId, threadId),\r\n        stepInto: (sessionId: string, threadId?: number) => ipcRenderer.invoke('debug:stepInto', sessionId, threadId),\r\n        stepOut: (sessionId: string, threadId?: number) => ipcRenderer.invoke('debug:stepOut', sessionId, threadId),\r\n        pause: (sessionId: string, threadId?: number) => ipcRenderer.invoke('debug:pause', sessionId, threadId),\r\n        getCallStack: (sessionId: string, threadId?: number) => ipcRenderer.invoke('debug:getCallStack', sessionId, threadId),\r\n        getVariables: (sessionId: string, variablesReference: number) => ipcRenderer.invoke('debug:getVariables', sessionId, variablesReference),\r\n        evaluate: (sessionId: string, expression: string, frameId?: number) => ipcRenderer.invoke('debug:evaluate', sessionId, expression, frameId),\r\n        onStarted: (callback: (data: any) => void) => {\r\n            const subscription = (_event: IpcRendererEvent, data: any) => callback(data)\r\n            ipcRenderer.on('debug:started', subscription)\r\n            return () => {\r\n                ipcRenderer.removeListener('debug:started', subscription)\r\n            }\r\n        },\r\n        onStopped: (callback: (data: any) => void) => {\r\n            const subscription = (_event: IpcRendererEvent, data: any) => callback(data)\r\n            ipcRenderer.on('debug:stopped', subscription)\r\n            return () => {\r\n                ipcRenderer.removeListener('debug:stopped', subscription)\r\n            }\r\n        },\r\n        onContinued: (callback: (data: any) => void) => {\r\n            const subscription = (_event: IpcRendererEvent, data: any) => callback(data)\r\n            ipcRenderer.on('debug:continued', subscription)\r\n            return () => {\r\n                ipcRenderer.removeListener('debug:continued', subscription)\r\n            }\r\n        },\r\n        onTerminated: (callback: (data: any) => void) => {\r\n            const subscription = (_event: IpcRendererEvent, data: any) => callback(data)\r\n            ipcRenderer.on('debug:terminated', subscription)\r\n            return () => {\r\n                ipcRenderer.removeListener('debug:terminated', subscription)\r\n            }\r\n        },\r\n        onOutput: (callback: (data: any) => void) => {\r\n            const subscription = (_event: IpcRendererEvent, data: any) => callback(data)\r\n            ipcRenderer.on('debug:output', subscription)\r\n            return () => {\r\n                ipcRenderer.removeListener('debug:output', subscription)\r\n            }\r\n        },\r\n        onBreakpoint: (callback: (data: any) => void) => {\r\n            const subscription = (_event: IpcRendererEvent, data: any) => callback(data)\r\n            ipcRenderer.on('debug:breakpoint', subscription)\r\n            return () => {\r\n                ipcRenderer.removeListener('debug:breakpoint', subscription)\r\n            }\r\n        },\r\n        onEvent: (callback: (event: any) => void) => {\r\n            const subscription = (_event: IpcRendererEvent, event: any) => callback(event)\r\n            ipcRenderer.on('debug:event', subscription)\r\n            return () => {\r\n                ipcRenderer.removeListener('debug:event', subscription)\r\n            }\r\n        },\r\n        onResponse: (callback: (response: any) => void) => {\r\n            const subscription = (_event: IpcRendererEvent, response: any) => callback(response)\r\n            ipcRenderer.on('debug:response', subscription)\r\n            return () => {\r\n                ipcRenderer.removeListener('debug:response', subscription)\r\n            }\r\n        },\r\n        onError: (callback: (data: any) => void) => {\r\n            const subscription = (_event: IpcRendererEvent, data: any) => callback(data)\r\n            ipcRenderer.on('debug:error', subscription)\r\n            return () => {\r\n                ipcRenderer.removeListener('debug:error', subscription)\r\n            }\r\n        },\r\n        removeListeners: () => {\r\n            ipcRenderer.removeAllListeners('debug:started')\r\n            ipcRenderer.removeAllListeners('debug:stopped')\r\n            ipcRenderer.removeAllListeners('debug:continued')\r\n            ipcRenderer.removeAllListeners('debug:terminated')\r\n            ipcRenderer.removeAllListeners('debug:output')\r\n            ipcRenderer.removeAllListeners('debug:breakpoint')\r\n            ipcRenderer.removeAllListeners('debug:event')\r\n            ipcRenderer.removeAllListeners('debug:response')\r\n            ipcRenderer.removeAllListeners('debug:error')\r\n        }\r\n    },\r\n\r\n    // ==========================================\r\n    // Secure Storage APIs\r\n    // ==========================================\r\n    safeStorage: {\r\n        isAvailable: () => ipcRenderer.invoke('safeStorage:isAvailable'),\r\n        set: (options: any) => ipcRenderer.invoke('safeStorage:set', options),\r\n        get: (key: string) => ipcRenderer.invoke('safeStorage:get', key),\r\n        delete: (key: string) => ipcRenderer.invoke('safeStorage:delete', key),\r\n        listKeys: () => ipcRenderer.invoke('safeStorage:listKeys')\r\n    },\r\n\r\n    // ==========================================\r\n    // Runtime Management APIs\r\n    // ==========================================\r\n    runtimeMgmt: {\r\n        check: (runtimeId: any) => ipcRenderer.invoke('runtime:check', runtimeId),\r\n        download: (runtimeId: any) => ipcRenderer.invoke('runtime:download', runtimeId),\r\n        install: (options: any) => ipcRenderer.invoke('runtime:install', options),\r\n        uninstall: (runtimeId: any) => ipcRenderer.invoke('runtime:uninstall', runtimeId),\r\n        downloadAndInstall: (runtimeId: any) => ipcRenderer.invoke('runtime:downloadAndInstall', runtimeId),\r\n        onDownloadProgress: (callback: (data: any) => void) => {\r\n            ipcRenderer.on('runtime:download-progress', (_event: IpcRendererEvent, data: any) => callback(data))\r\n        },\r\n        onStatus: (callback: (data: any) => void) => {\r\n            ipcRenderer.on('runtime:status', (_event: IpcRendererEvent, data: any) => callback(data))\r\n        },\r\n        onLog: (callback: (data: any) => void) => {\r\n            ipcRenderer.on('runtime:log', (_event: IpcRendererEvent, data: any) => callback(data))\r\n        },\r\n        removeListeners: () => {\r\n            ipcRenderer.removeAllListeners('runtime:download-progress')\r\n            ipcRenderer.removeAllListeners('runtime:status')\r\n            ipcRenderer.removeAllListeners('runtime:log')\r\n        }\r\n    },\r\n\r\n    // ==========================================\r\n    // Auto-Update APIs\r\n    // ==========================================\r\n    update: {\r\n        configureToken: (token: string) => ipcRenderer.invoke('update:configure-token', token),\r\n        checkForUpdates: () => ipcRenderer.invoke('update:check'),\r\n        downloadUpdate: () => ipcRenderer.invoke('update:download'),\r\n        installUpdate: () => ipcRenderer.invoke('update:install'),\r\n        getVersion: () => ipcRenderer.invoke('update:get-version'),\r\n        getStatus: () => ipcRenderer.invoke('update:get-status'),\r\n\r\n        // Events\r\n        onUpdateChecking: (callback: () => void) => {\r\n            ipcRenderer.on('update:checking', () => callback())\r\n        },\r\n        onUpdateAvailable: (callback: (info: any) => void) => {\r\n            ipcRenderer.on('update:available', (_event: IpcRendererEvent, info: any) => callback(info))\r\n        },\r\n        onUpdateNotAvailable: (callback: (info: any) => void) => {\r\n            ipcRenderer.on('update:not-available', (_event: IpcRendererEvent, info: any) => callback(info))\r\n        },\r\n        onDownloadProgress: (callback: (progress: any) => void) => {\r\n            ipcRenderer.on('update:download-progress', (_event: IpcRendererEvent, progress: any) => callback(progress))\r\n        },\r\n        onUpdateDownloaded: (callback: (info: any) => void) => {\r\n            ipcRenderer.on('update:downloaded', (_event: IpcRendererEvent, info: any) => callback(info))\r\n        },\r\n        onUpdateError: (callback: (error: any) => void) => {\r\n            ipcRenderer.on('update:error', (_event: IpcRendererEvent, error: any) => callback(error))\r\n        },\r\n        removeListeners: () => {\r\n            ipcRenderer.removeAllListeners('update:checking')\r\n            ipcRenderer.removeAllListeners('update:available')\r\n            ipcRenderer.removeAllListeners('update:not-available')\r\n            ipcRenderer.removeAllListeners('update:download-progress')\r\n            ipcRenderer.removeAllListeners('update:downloaded')\r\n            ipcRenderer.removeAllListeners('update:error')\r\n        }\r\n    },\r\n\r\n    // ==========================================\r\n    // Generic IPC listener for deep links\r\n    // ==========================================\r\n    on: (channel: string, callback: (...args: any[]) => void) => {\r\n        const validChannels = ['deep-link']\r\n        if (validChannels.includes(channel)) {\r\n            ipcRenderer.on(channel, (_event, ...args) => callback(...args))\r\n        }\r\n    }\r\n})","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\electron\\services\\hardware-service.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\electron\\services\\runtime-manager.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":267,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":267,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[10932,11004],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":272,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":272,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[11232,11310],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":417,"column":25,"nodeType":"MemberExpression","messageId":"unexpected","endLine":417,"endColumn":37,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[17677,17755],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":443,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":443,"endColumn":29,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[18961,19032],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":456,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":456,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[19422,19494],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":469,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":469,"endColumn":29,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[20069,20140],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":492,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":492,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[20844,20900],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":495,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":495,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[20976,21051],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\nimport path from 'path'\nimport fs from 'fs'\nimport https from 'https'\nimport http from 'http'\nimport { exec } from 'child_process'\n\nexport class RuntimeManager {\n    private activeDownloads = new Map<string, { abort: () => void }>()\n    private installedRuntimes = new Map<string, { version: string; path: string }>()\n    private runtimesDir: string\n\n    constructor(runtimesDir: string) {\n        this.runtimesDir = runtimesDir\n    }\n\n    getDownloadUrl(runtimeId: string, platform: NodeJS.Platform): { url: string; filename: string; size: number } | null {\n        const downloads: Record<string, Record<string, { url: string; filename: string; size: number }>> = {\n            node: {\n                win32: {\n                    url: 'https://nodejs.org/dist/v20.11.0/node-v20.11.0-win-x64.zip',\n                    filename: 'node-v20.11.0-win-x64.zip',\n                    size: 29000000\n                },\n                darwin: {\n                    url: 'https://nodejs.org/dist/v20.11.0/node-v20.11.0-darwin-x64.tar.gz',\n                    filename: 'node-v20.11.0-darwin-x64.tar.gz',\n                    size: 42000000\n                },\n                linux: {\n                    url: 'https://nodejs.org/dist/v20.11.0/node-v20.11.0-linux-x64.tar.xz',\n                    filename: 'node-v20.11.0-linux-x64.tar.xz',\n                    size: 23000000\n                }\n            },\n            python: {\n                win32: {\n                    url: 'https://www.python.org/ftp/python/3.12.1/python-3.12.1-embed-amd64.zip',\n                    filename: 'python-3.12.1-embed-amd64.zip',\n                    size: 10000000\n                },\n                darwin: {\n                    url: 'https://www.python.org/ftp/python/3.12.1/python-3.12.1-macos11.pkg',\n                    filename: 'python-3.12.1-macos11.pkg',\n                    size: 35000000\n                },\n                linux: {\n                    url: 'https://www.python.org/ftp/python/3.12.1/Python-3.12.1.tgz',\n                    filename: 'Python-3.12.1.tgz',\n                    size: 27000000\n                }\n            },\n            rust: {\n                win32: {\n                    url: 'https://static.rust-lang.org/rustup/dist/x86_64-pc-windows-msvc/rustup-init.exe',\n                    filename: 'rustup-init.exe',\n                    size: 8000000\n                }\n            },\n            go: {\n                win32: {\n                    url: 'https://go.dev/dl/go1.21.5.windows-amd64.zip',\n                    filename: 'go1.21.5.windows-amd64.zip',\n                    size: 140000000\n                },\n                darwin: {\n                    url: 'https://go.dev/dl/go1.21.5.darwin-amd64.tar.gz',\n                    filename: 'go1.21.5.darwin-amd64.tar.gz',\n                    size: 145000000\n                },\n                linux: {\n                    url: 'https://go.dev/dl/go1.21.5.linux-amd64.tar.gz',\n                    filename: 'go1.21.5.linux-amd64.tar.gz',\n                    size: 140000000\n                }\n            },\n            deno: {\n                win32: {\n                    url: 'https://github.com/denoland/deno/releases/download/v1.39.0/deno-x86_64-pc-windows-msvc.zip',\n                    filename: 'deno-x86_64-pc-windows-msvc.zip',\n                    size: 35000000\n                },\n                darwin: {\n                    url: 'https://github.com/denoland/deno/releases/download/v1.39.0/deno-x86_64-apple-darwin.zip',\n                    filename: 'deno-x86_64-apple-darwin.zip',\n                    size: 40000000\n                },\n                linux: {\n                    url: 'https://github.com/denoland/deno/releases/download/v1.39.0/deno-x86_64-unknown-linux-gnu.zip',\n                    filename: 'deno-x86_64-unknown-linux-gnu.zip',\n                    size: 38000000\n                }\n            },\n            bun: {\n                win32: {\n                    url: 'https://github.com/oven-sh/bun/releases/download/bun-v1.0.18/bun-windows-x64.zip',\n                    filename: 'bun-windows-x64.zip',\n                    size: 40000000\n                },\n                darwin: {\n                    url: 'https://github.com/oven-sh/bun/releases/download/bun-v1.0.18/bun-darwin-x64.zip',\n                    filename: 'bun-darwin-x64.zip',\n                    size: 42000000\n                },\n                linux: {\n                    url: 'https://github.com/oven-sh/bun/releases/download/bun-v1.0.18/bun-linux-x64.zip',\n                    filename: 'bun-linux-x64.zip',\n                    size: 40000000\n                }\n            },\n            zig: {\n                win32: {\n                    url: 'https://ziglang.org/download/0.11.0/zig-windows-x86_64-0.11.0.zip',\n                    filename: 'zig-windows-x86_64-0.11.0.zip',\n                    size: 90000000\n                },\n                darwin: {\n                    url: 'https://ziglang.org/download/0.11.0/zig-macos-x86_64-0.11.0.tar.xz',\n                    filename: 'zig-macos-x86_64-0.11.0.tar.xz',\n                    size: 40000000\n                },\n                linux: {\n                    url: 'https://ziglang.org/download/0.11.0/zig-linux-x86_64-0.11.0.tar.xz',\n                    filename: 'zig-linux-x86_64-0.11.0.tar.xz',\n                    size: 40000000\n                }\n            }\n        }\n\n        return downloads[runtimeId]?.[platform] || null\n    }\n\n    async downloadRuntime(\n        runtimeId: string,\n        onProgress: (progress: { bytesDownloaded: number; totalBytes: number; speed: number }) => void,\n        onLog?: (message: string) => void\n    ): Promise<{ success: boolean; path?: string; error?: string }> {\n        const downloadInfo = this.getDownloadUrl(runtimeId, process.platform)\n        if (!downloadInfo) {\n            const error = `Runtime ${runtimeId} not available for automatic download on ${process.platform}`\n            onLog?.(error)\n            return { success: false, error }\n        }\n\n        const destPath = path.join(this.runtimesDir, downloadInfo.filename)\n        onLog?.(`Download URL: ${downloadInfo.url}`)\n        onLog?.(`Destination: ${destPath}`)\n\n        // Check if already downloaded\n        if (fs.existsSync(destPath)) {\n            const stats = fs.statSync(destPath)\n            if (stats.size === downloadInfo.size) {\n                onLog?.(`File already exists with correct size, skipping download`)\n                return { success: true, path: destPath }\n            }\n            onLog?.(`Existing file size mismatch, re-downloading...`)\n        }\n\n        return new Promise((resolve) => {\n            const file = fs.createWriteStream(destPath)\n            let downloadedBytes = 0\n            let lastProgressUpdate = Date.now()\n            let lastBytesRecorded = 0\n\n            const protocol = downloadInfo.url.startsWith('https') ? https : http\n            const request = protocol.get(downloadInfo.url, (response) => {\n                if (response.statusCode !== 200) {\n                    file.close()\n                    fs.unlinkSync(destPath)\n                    resolve({ success: false, error: `HTTP ${response.statusCode}` })\n                    return\n                }\n\n                response.on('data', (chunk) => {\n                    downloadedBytes += chunk.length\n                    const now = Date.now()\n                    const timeDelta = now - lastProgressUpdate\n\n                    if (timeDelta >= 500) {\n                        const bytesDelta = downloadedBytes - lastBytesRecorded\n                        const speed = bytesDelta > 0 ? Math.round(bytesDelta / (timeDelta / 1000)) : 0\n\n                        lastProgressUpdate = now\n                        lastBytesRecorded = downloadedBytes\n\n                        onProgress({\n                            bytesDownloaded: downloadedBytes,\n                            totalBytes: downloadInfo.size,\n                            speed: speed\n                        })\n                    }\n                })\n\n                response.pipe(file)\n\n                file.on('finish', () => {\n                    file.close()\n                    this.activeDownloads.delete(runtimeId)\n                    resolve({ success: true, path: destPath })\n                })\n            })\n\n            request.on('error', (error: Error) => {\n                file.close()\n                if (fs.existsSync(destPath)) fs.unlinkSync(destPath)\n                this.activeDownloads.delete(runtimeId)\n                resolve({ success: false, error: error.message })\n            })\n\n            this.activeDownloads.set(runtimeId, {\n                abort: () => {\n                    request.destroy()\n                    file.close()\n                    if (fs.existsSync(destPath)) fs.unlinkSync(destPath)\n                }\n            })\n        })\n    }\n\n    async installRuntime(\n        runtimeId: string,\n        archivePath: string,\n        onLog?: (message: string) => void\n    ): Promise<{ success: boolean; installPath?: string; error?: string }> {\n        const installPath = path.join(this.runtimesDir, runtimeId)\n\n        try {\n            // Clean up existing installation directory to avoid conflicts\n            if (fs.existsSync(installPath)) {\n                onLog?.(`Cleaning up existing directory: ${installPath}`)\n                fs.rmSync(installPath, { recursive: true, force: true })\n            }\n\n            onLog?.(`Creating installation directory: ${installPath}`)\n            // Create install directory\n            fs.mkdirSync(installPath, { recursive: true })\n\n            // Extract archive based on extension\n            if (archivePath.endsWith('.zip')) {\n                onLog?.(`Extracting ZIP archive...`)\n                await this.extractZip(archivePath, installPath, onLog)\n            } else if (archivePath.endsWith('.tar.gz') || archivePath.endsWith('.tar.xz')) {\n                onLog?.(`Extracting TAR archive...`)\n                await this.extractTar(archivePath, installPath, onLog)\n            } else if (archivePath.endsWith('.exe')) {\n                onLog?.(`Running installer executable...`)\n                await this.runInstaller(archivePath, installPath, onLog)\n            } else {\n                const error = 'Unsupported archive format'\n                onLog?.(error)\n                return { success: false, error }\n            }\n\n            // Store installation info\n            this.installedRuntimes.set(runtimeId, {\n                version: '20.11.0', // TODO: Extract from runtime\n                path: installPath\n            })\n\n            // Add to PATH\n            onLog?.(`Adding to system PATH...`)\n            await this.addToPath(runtimeId, installPath, onLog)\n\n            onLog?.(`Successfully installed ${runtimeId} to ${installPath}`)\n            console.log(`[RuntimeManager] Installed ${runtimeId} to ${installPath}`)\n            return { success: true, installPath }\n        } catch (error) {\n            const errorMsg = error instanceof Error ? error.message : String(error)\n            onLog?.(`Installation error: ${errorMsg}`)\n            console.error(`[RuntimeManager] Installation failed for ${runtimeId}:`, error)\n            return { success: false, error: errorMsg }\n        }\n    }\n\n    async extractZip(archivePath: string, destPath: string, onLog?: (message: string) => void): Promise<void> {\n        return new Promise((resolve, reject) => {\n            // Use unzipper package if available, otherwise use system commands\n            if (process.platform === 'win32') {\n                // Windows: Use PowerShell\n                const command = `powershell -command \"Expand-Archive -Path '${archivePath}' -DestinationPath '${destPath}' -Force\"`\n                onLog?.(`Running: ${command}`)\n                onLog?.(`This may take a few minutes for large archives...`)\n\n                exec(command, {\n                    timeout: 300000, // 5 minutes timeout\n                    maxBuffer: 10 * 1024 * 1024 // 10MB buffer\n                }, (error, stdout, stderr) => {\n                    if (stdout) onLog?.(stdout)\n                    if (stderr) onLog?.(stderr)\n                    if (error) {\n                        if (error.killed) {\n                            onLog?.(`Extraction timeout - archive may be too large or extraction stuck`)\n                        }\n                        onLog?.(`Extraction error: ${error.message}`)\n                        reject(error)\n                    } else {\n                        onLog?.(`Extraction complete`)\n                        resolve()\n                    }\n                })\n            } else {\n                // macOS/Linux: Use unzip\n                const command = `unzip -q \"${archivePath}\" -d \"${destPath}\"`\n                onLog?.(`Running: ${command}`)\n                onLog?.(`This may take a few minutes for large archives...`)\n\n                exec(command, {\n                    timeout: 300000, // 5 minutes timeout\n                    maxBuffer: 10 * 1024 * 1024 // 10MB buffer\n                }, (error, stdout, stderr) => {\n                    if (stdout) onLog?.(stdout)\n                    if (stderr) onLog?.(stderr)\n                    if (error) {\n                        if (error.killed) {\n                            onLog?.(`Extraction timeout - archive may be too large or extraction stuck`)\n                        }\n                        onLog?.(`Extraction error: ${error.message}`)\n                        reject(error)\n                    } else {\n                        onLog?.(`Extraction complete`)\n                        resolve()\n                    }\n                })\n            }\n        })\n    }\n\n    async extractTar(archivePath: string, destPath: string, onLog?: (message: string) => void): Promise<void> {\n        return new Promise((resolve, reject) => {\n            const command = archivePath.endsWith('.xz')\n                ? `tar -xJf \"${archivePath}\" -C \"${destPath}\"`\n                : `tar -xzf \"${archivePath}\" -C \"${destPath}\"`\n\n            onLog?.(`Running: ${command}`)\n            onLog?.(`This may take a few minutes for large archives...`)\n\n            exec(command, {\n                timeout: 300000, // 5 minutes timeout\n                maxBuffer: 10 * 1024 * 1024 // 10MB buffer\n            }, (error, stdout, stderr) => {\n                if (stdout) onLog?.(stdout)\n                if (stderr) onLog?.(stderr)\n                if (error) {\n                    if (error.killed) {\n                        onLog?.(`Extraction timeout - archive may be too large or extraction stuck`)\n                    }\n                    onLog?.(`Extraction error: ${error.message}`)\n                    reject(error)\n                } else {\n                    onLog?.(`Extraction complete`)\n                    resolve()\n                }\n            })\n        })\n    }\n\n    async runInstaller(installerPath: string, destPath: string, onLog?: (message: string) => void): Promise<void> {\n        return new Promise((resolve, reject) => {\n            // For .exe installers like rustup-init.exe, run with silent install flags if possible\n            const command = process.platform === 'win32'\n                ? `\"${installerPath}\" -y --default-toolchain stable --profile minimal`\n                : installerPath\n\n            onLog?.(`Running installer: ${command}`)\n            onLog?.(`This may take several minutes...`)\n\n            exec(command, {\n                cwd: destPath,\n                timeout: 600000, // 10 minutes timeout for installers\n                maxBuffer: 10 * 1024 * 1024 // 10MB buffer\n            }, (error, stdout, stderr) => {\n                if (stdout) onLog?.(stdout)\n                if (stderr) onLog?.(stderr)\n                if (error) {\n                    if (error.killed) {\n                        onLog?.(`Installer timeout - installation may be stuck or requires user interaction`)\n                    }\n                    onLog?.(`Installer error: ${error.message}`)\n                    reject(error)\n                } else {\n                    onLog?.(`Installation complete`)\n                    resolve()\n                }\n            })\n        })\n    }\n\n    async addToPath(runtimeId: string, installPath: string, onLog?: (message: string) => void): Promise<void> {\n        // Find the bin directory\n        let binPath = installPath\n        if (fs.existsSync(path.join(installPath, 'bin'))) {\n            binPath = path.join(installPath, 'bin')\n            onLog?.(`Found bin directory: ${binPath}`)\n        } else {\n            onLog?.(`Using install directory as bin path: ${binPath}`)\n        }\n\n        // On Windows, add to user PATH via registry\n        // On macOS/Linux, add to shell profile\n        if (process.platform === 'win32') {\n            // Windows: Use setx to add to user PATH\n            onLog?.(`Adding to Windows PATH...`)\n            return new Promise((resolve, _reject) => {\n                exec(`setx PATH \"%PATH%;${binPath}\"`, {\n                    timeout: 30000, // 30 seconds timeout\n                    maxBuffer: 10 * 1024 * 1024 // 10MB buffer\n                }, (error, stdout, stderr) => {\n                    if (stdout) onLog?.(stdout)\n                    if (stderr) onLog?.(stderr)\n                    if (error) {\n                        if (error.killed) {\n                            onLog?.(`Warning: PATH update timeout`)\n                        }\n                        onLog?.(`Warning: Failed to add to PATH: ${error.message}`)\n                        console.warn('[RuntimeManager] Failed to add to PATH, but continuing:', error)\n                        resolve() // Don't fail installation if PATH update fails\n                    } else {\n                        onLog?.(`Successfully added to PATH`)\n                        resolve()\n                    }\n                })\n            })\n        } else {\n            // Unix: Add to .bashrc / .zshrc\n            const shellRc = process.env.SHELL?.includes('zsh') ? '.zshrc' : '.bashrc'\n            const rcPath = path.join(process.env.HOME || '', shellRc)\n            const exportLine = `\\nexport PATH=\"${binPath}:$PATH\"\\n`\n\n            onLog?.(`Updating ${shellRc}...`)\n            try {\n                const content = fs.existsSync(rcPath) ? fs.readFileSync(rcPath, 'utf-8') : ''\n                if (!content.includes(binPath)) {\n                    fs.appendFileSync(rcPath, exportLine)\n                    onLog?.(`Added PATH export to ${shellRc}`)\n                } else {\n                    onLog?.(`PATH already configured in ${shellRc}`)\n                }\n            } catch (error) {\n                const errorMsg = error instanceof Error ? error.message : String(error)\n                onLog?.(`Warning: Failed to update shell profile: ${errorMsg}`)\n                console.warn('[RuntimeManager] Failed to update shell profile:', error)\n            }\n        }\n    }\n\n    async removeFromPath(runtimeId: string): Promise<void> {\n        const installation = this.installedRuntimes.get(runtimeId)\n        if (!installation) return\n\n        const binPath = path.join(installation.path, 'bin')\n\n        if (process.platform === 'win32') {\n            // Windows: Remove from PATH via registry (complex, skip for now)\n            console.log('[RuntimeManager] Windows PATH removal not yet implemented')\n        } else {\n            // Unix: Remove from shell profile\n            const shellRc = process.env.SHELL?.includes('zsh') ? '.zshrc' : '.bashrc'\n            const rcPath = path.join(process.env.HOME || '', shellRc)\n\n            try {\n                if (fs.existsSync(rcPath)) {\n                    const content = fs.readFileSync(rcPath, 'utf-8')\n                    const lines = content.split('\\n').filter(line => !line.includes(binPath))\n                    fs.writeFileSync(rcPath, lines.join('\\n'))\n                }\n            } catch (error) {\n                console.warn('[RuntimeManager] Failed to update shell profile:', error)\n            }\n        }\n    }\n\n    async uninstallRuntime(runtimeId: string): Promise<{ success: boolean; error?: string }> {\n        const installation = this.installedRuntimes.get(runtimeId)\n        if (!installation) {\n            return { success: false, error: 'Runtime not installed via Kalynt' }\n        }\n\n        try {\n            // Remove from PATH\n            await this.removeFromPath(runtimeId)\n\n            // Delete installation directory\n            if (fs.existsSync(installation.path)) {\n                fs.rmSync(installation.path, { recursive: true, force: true })\n            }\n\n            // Remove from tracking\n            this.installedRuntimes.delete(runtimeId)\n\n            console.log(`[RuntimeManager] Uninstalled ${runtimeId}`)\n            return { success: true }\n        } catch (error) {\n            console.error(`[RuntimeManager] Uninstall failed for ${runtimeId}:`, error)\n            return { success: false, error: error instanceof Error ? error.message : String(error) }\n        }\n    }\n\n    async checkInstallation(runtimeId: string): Promise<{ isInstalled: boolean; version?: string; path?: string; managedByKalynt?: boolean }> {\n        // Check if managed by Kalynt\n        const managed = this.installedRuntimes.get(runtimeId)\n        if (managed) {\n            return {\n                isInstalled: true,\n                version: managed.version,\n                path: managed.path,\n                managedByKalynt: true\n            }\n        }\n\n        // Check system installation\n        const commands: Record<string, string> = {\n            node: 'node --version',\n            python: process.platform === 'win32' ? 'python --version' : 'python3 --version',\n            rust: 'rustc --version',\n            go: 'go version',\n            java: 'java -version',\n            dotnet: 'dotnet --version',\n            ruby: 'ruby --version',\n            php: 'php --version',\n            gcc: 'gcc --version',\n            kotlin: 'kotlin -version',\n            swift: 'swift --version',\n            scala: 'scala -version',\n            perl: 'perl --version',\n            lua: 'lua -v',\n            haskell: 'ghc --version',\n            elixir: 'elixir --version',\n            r: 'R --version',\n            julia: 'julia --version',\n            dart: 'dart --version',\n            zig: 'zig version',\n            clojure: 'clojure --version',\n            deno: 'deno --version',\n            bun: 'bun --version',\n            nasm: 'nasm -v',\n            sass: 'sass --version',\n            emscripten: 'emcc --version',\n            wabt: 'wasm2wat --version',\n            groovy: 'groovy --version',\n            ocaml: 'ocaml -version',\n            erlang: 'erl -eval \"erlang:display(erlang:system_info(otp_release)), halt().\" -noshell',\n            fsharp: 'dotnet fsi --version',\n            v: 'v version',\n            nim: 'nim --version',\n            csharp: 'dotnet --version',\n            c: 'gcc --version',\n            cpp: 'g++ --version',\n            html: 'echo HTML5'\n        }\n\n        const command = commands[runtimeId]\n        if (!command) return { isInstalled: false }\n\n        return new Promise((resolve) => {\n            exec(command, (error, stdout, stderr) => {\n                if (error) {\n                    resolve({ isInstalled: false })\n                } else {\n                    const output = stdout || stderr\n                    const versionMatch = output.match(/(\\d+\\.\\d+\\.\\d+)/)\n                    resolve({\n                        isInstalled: true,\n                        version: versionMatch ? versionMatch[1] : 'installed',\n                        managedByKalynt: false\n                    })\n                }\n            })\n        })\n    }\n}\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\electron\\terminal\\dependencyManager.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":381,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":381,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[11801,11870],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":429,"column":25,"nodeType":"MemberExpression","messageId":"unexpected","endLine":429,"endColumn":36,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[14042,14135],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":438,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":438,"endColumn":32,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[14730,14826],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":468,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":468,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[16612,16688],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":499,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":499,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[17756,17832],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":540,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":540,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[19452,19528],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":695,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":695,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[24568,24650],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":778,"column":77,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":778,"endColumn":80,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[27402,27405],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[27402,27405],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":786,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":786,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[27709,27712],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[27709,27712],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":793,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":793,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[27997,28000],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[27997,28000],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":10,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n/**\r\n * DependencyManager - Unified package manager integration for all supported languages\r\n * \r\n * Handles dependency installation, removal, listing, and detection for:\r\n * - JavaScript/TypeScript: npm, yarn, pnpm, bun\r\n * - Python: pip, pip3\r\n * - Rust: cargo\r\n * - Go: go mod\r\n * - Ruby: gem, bundler\r\n * - PHP: composer\r\n * - Java: maven, gradle\r\n * - .NET: dotnet\r\n * - Dart/Flutter: pub\r\n */\r\n\r\nimport { spawn, ChildProcess } from 'node:child_process'\r\nimport { EventEmitter } from 'node:events'\r\nimport fs from 'node:fs'\r\nimport path from 'node:path'\r\nimport type { BrowserWindow } from 'electron'\r\n\r\n// Package manager configuration\r\nexport interface PackageManagerConfig {\r\n    name: string                    // Display name (npm, pip, cargo, etc.)\r\n    command: string                 // Binary command\r\n    installArgs: string[]           // Args for install (e.g., ['install'])\r\n    installDevArgs?: string[]       // Args for dev dependency install\r\n    uninstallArgs: string[]         // Args for uninstall\r\n    updateArgs: string[]            // Args for update\r\n    listArgs: string[]              // Args for listing installed packages\r\n    manifestFile: string            // Config file (package.json, requirements.txt, etc.)\r\n    lockFile?: string               // Lock file if applicable\r\n    languageId: string              // Associated language ID\r\n    globalFlag?: string             // Flag for global install (-g, --user, etc.)\r\n    devFlag?: string                // Flag for dev dependencies (--save-dev, --dev)\r\n    initCommand?: string[]          // Command to initialize new project\r\n}\r\n\r\n// Install options\r\nexport interface InstallOptions {\r\n    global?: boolean\r\n    dev?: boolean\r\n    version?: string\r\n    workspacePath: string\r\n}\r\n\r\n// Package info\r\nexport interface PackageInfo {\r\n    name: string\r\n    version: string\r\n    isDev?: boolean\r\n    description?: string\r\n}\r\n\r\n// Operation result\r\nexport interface DependencyResult {\r\n    success: boolean\r\n    output?: string\r\n    error?: string\r\n    exitCode?: number\r\n}\r\n\r\n// Supported package managers\r\nconst PACKAGE_MANAGERS: Record<string, PackageManagerConfig> = {\r\n    // JavaScript/TypeScript\r\n    npm: {\r\n        name: 'npm',\r\n        command: 'npm',\r\n        installArgs: ['install'],\r\n        installDevArgs: ['install', '--save-dev'],\r\n        uninstallArgs: ['uninstall'],\r\n        updateArgs: ['update'],\r\n        listArgs: ['list', '--json', '--depth=0'],\r\n        manifestFile: 'package.json',\r\n        lockFile: 'package-lock.json',\r\n        languageId: 'javascript',\r\n        globalFlag: '-g',\r\n        devFlag: '--save-dev',\r\n        initCommand: ['init', '-y']\r\n    },\r\n    yarn: {\r\n        name: 'yarn',\r\n        command: 'yarn',\r\n        installArgs: ['add'],\r\n        installDevArgs: ['add', '--dev'],\r\n        uninstallArgs: ['remove'],\r\n        updateArgs: ['upgrade'],\r\n        listArgs: ['list', '--json', '--depth=0'],\r\n        manifestFile: 'package.json',\r\n        lockFile: 'yarn.lock',\r\n        languageId: 'javascript',\r\n        globalFlag: 'global',\r\n        devFlag: '--dev',\r\n        initCommand: ['init', '-y']\r\n    },\r\n    pnpm: {\r\n        name: 'pnpm',\r\n        command: 'pnpm',\r\n        installArgs: ['add'],\r\n        installDevArgs: ['add', '--save-dev'],\r\n        uninstallArgs: ['remove'],\r\n        updateArgs: ['update'],\r\n        listArgs: ['list', '--json', '--depth=0'],\r\n        manifestFile: 'package.json',\r\n        lockFile: 'pnpm-lock.yaml',\r\n        languageId: 'javascript',\r\n        globalFlag: '-g',\r\n        devFlag: '--save-dev',\r\n        initCommand: ['init']\r\n    },\r\n    bun: {\r\n        name: 'bun',\r\n        command: 'bun',\r\n        installArgs: ['add'],\r\n        installDevArgs: ['add', '--dev'],\r\n        uninstallArgs: ['remove'],\r\n        updateArgs: ['update'],\r\n        listArgs: ['pm', 'ls'],\r\n        manifestFile: 'package.json',\r\n        lockFile: 'bun.lockb',\r\n        languageId: 'javascript',\r\n        globalFlag: '-g',\r\n        devFlag: '--dev',\r\n        initCommand: ['init', '-y']\r\n    },\r\n\r\n    // Python\r\n    pip: {\r\n        name: 'pip',\r\n        command: 'pip',\r\n        installArgs: ['install'],\r\n        uninstallArgs: ['uninstall', '-y'],\r\n        updateArgs: ['install', '--upgrade'],\r\n        listArgs: ['list', '--format=json'],\r\n        manifestFile: 'requirements.txt',\r\n        languageId: 'python',\r\n        globalFlag: '--user'\r\n    },\r\n    pip3: {\r\n        name: 'pip3',\r\n        command: 'pip3',\r\n        installArgs: ['install'],\r\n        uninstallArgs: ['uninstall', '-y'],\r\n        updateArgs: ['install', '--upgrade'],\r\n        listArgs: ['list', '--format=json'],\r\n        manifestFile: 'requirements.txt',\r\n        languageId: 'python',\r\n        globalFlag: '--user'\r\n    },\r\n\r\n    // Rust\r\n    cargo: {\r\n        name: 'cargo',\r\n        command: 'cargo',\r\n        installArgs: ['add'],\r\n        uninstallArgs: ['remove'],\r\n        updateArgs: ['update'],\r\n        listArgs: ['metadata', '--format-version=1', '--no-deps'],\r\n        manifestFile: 'Cargo.toml',\r\n        lockFile: 'Cargo.lock',\r\n        languageId: 'rust',\r\n        initCommand: ['init']\r\n    },\r\n\r\n    // Go\r\n    go: {\r\n        name: 'go',\r\n        command: 'go',\r\n        installArgs: ['get'],\r\n        uninstallArgs: ['mod', 'edit', '-droprequire'],\r\n        updateArgs: ['get', '-u'],\r\n        listArgs: ['list', '-m', '-json', 'all'],\r\n        manifestFile: 'go.mod',\r\n        lockFile: 'go.sum',\r\n        languageId: 'go',\r\n        initCommand: ['mod', 'init']\r\n    },\r\n\r\n    // Ruby\r\n    gem: {\r\n        name: 'gem',\r\n        command: 'gem',\r\n        installArgs: ['install'],\r\n        uninstallArgs: ['uninstall'],\r\n        updateArgs: ['update'],\r\n        listArgs: ['list', '--local'],\r\n        manifestFile: 'Gemfile',\r\n        languageId: 'ruby'\r\n    },\r\n    bundler: {\r\n        name: 'bundler',\r\n        command: 'bundle',\r\n        installArgs: ['add'],\r\n        uninstallArgs: ['remove'],\r\n        updateArgs: ['update'],\r\n        listArgs: ['list'],\r\n        manifestFile: 'Gemfile',\r\n        lockFile: 'Gemfile.lock',\r\n        languageId: 'ruby',\r\n        initCommand: ['init']\r\n    },\r\n\r\n    // PHP\r\n    composer: {\r\n        name: 'composer',\r\n        command: 'composer',\r\n        installArgs: ['require'],\r\n        installDevArgs: ['require', '--dev'],\r\n        uninstallArgs: ['remove'],\r\n        updateArgs: ['update'],\r\n        listArgs: ['show', '--format=json'],\r\n        manifestFile: 'composer.json',\r\n        lockFile: 'composer.lock',\r\n        languageId: 'php',\r\n        devFlag: '--dev',\r\n        initCommand: ['init', '--no-interaction']\r\n    },\r\n\r\n    // Java\r\n    maven: {\r\n        name: 'maven',\r\n        command: 'mvn',\r\n        installArgs: ['dependency:resolve'],\r\n        uninstallArgs: ['dependency:purge-local-repository'],\r\n        updateArgs: ['versions:use-latest-versions'],\r\n        listArgs: ['dependency:list'],\r\n        manifestFile: 'pom.xml',\r\n        languageId: 'java',\r\n        initCommand: ['archetype:generate', '-DgroupId=com.example', '-DartifactId=app', '-DarchetypeArtifactId=maven-archetype-quickstart']\r\n    },\r\n    gradle: {\r\n        name: 'gradle',\r\n        command: 'gradle',\r\n        installArgs: ['dependencies'],\r\n        uninstallArgs: [],\r\n        updateArgs: ['dependencies', '--refresh-dependencies'],\r\n        listArgs: ['dependencies', '--console=plain'],\r\n        manifestFile: 'build.gradle',\r\n        languageId: 'java'\r\n    },\r\n\r\n    // .NET\r\n    dotnet: {\r\n        name: 'dotnet',\r\n        command: 'dotnet',\r\n        installArgs: ['add', 'package'],\r\n        uninstallArgs: ['remove', 'package'],\r\n        updateArgs: ['add', 'package'],\r\n        listArgs: ['list', 'package'],\r\n        manifestFile: '*.csproj',\r\n        languageId: 'csharp',\r\n        initCommand: ['new', 'console']\r\n    },\r\n\r\n    // Dart/Flutter\r\n    pub: {\r\n        name: 'pub',\r\n        command: 'dart',\r\n        installArgs: ['pub', 'add'],\r\n        installDevArgs: ['pub', 'add', '--dev'],\r\n        uninstallArgs: ['pub', 'remove'],\r\n        updateArgs: ['pub', 'upgrade'],\r\n        listArgs: ['pub', 'deps', '--json'],\r\n        manifestFile: 'pubspec.yaml',\r\n        lockFile: 'pubspec.lock',\r\n        languageId: 'dart',\r\n        devFlag: '--dev',\r\n        initCommand: ['create', '.']\r\n    }\r\n}\r\n\r\n// Map language to preferred package manager\r\nconst LANGUAGE_TO_MANAGER: Record<string, string> = {\r\n    javascript: 'npm',\r\n    typescript: 'npm',\r\n    python: 'pip',\r\n    rust: 'cargo',\r\n    go: 'go',\r\n    ruby: 'bundler',\r\n    php: 'composer',\r\n    java: 'maven',\r\n    kotlin: 'gradle',\r\n    csharp: 'dotnet',\r\n    fsharp: 'dotnet',\r\n    dart: 'pub'\r\n}\r\n\r\n/**\r\n * Get enhanced PATH with common development tool locations\r\n */\r\nfunction getEnhancedPATH(): string {\r\n    const currentPath = process.env.PATH || ''\r\n\r\n    if (process.platform !== 'win32') {\r\n        return currentPath\r\n    }\r\n\r\n    const userProfile = process.env.USERPROFILE || 'C:\\\\Users\\\\Default'\r\n    const programFiles = process.env['ProgramFiles'] || 'C:\\\\Program Files'\r\n    const appData = process.env.APPDATA || `${userProfile}\\\\AppData\\\\Roaming`\r\n\r\n    const additionalPaths = [\r\n        // Python\r\n        `${userProfile}\\\\AppData\\\\Local\\\\Programs\\\\Python\\\\Python313`,\r\n        `${userProfile}\\\\AppData\\\\Local\\\\Programs\\\\Python\\\\Python313\\\\Scripts`,\r\n        `${userProfile}\\\\AppData\\\\Local\\\\Programs\\\\Python\\\\Python312`,\r\n        `${userProfile}\\\\AppData\\\\Local\\\\Programs\\\\Python\\\\Python312\\\\Scripts`,\r\n        // Rust/Cargo\r\n        `${userProfile}\\\\.cargo\\\\bin`,\r\n        // Node.js / npm\r\n        `${programFiles}\\\\nodejs`,\r\n        `${appData}\\\\npm`,\r\n        // Go\r\n        `${userProfile}\\\\go\\\\bin`,\r\n        `${programFiles}\\\\Go\\\\bin`,\r\n        // Ruby\r\n        `${programFiles}\\\\Ruby32-x64\\\\bin`,\r\n        // .NET\r\n        `${programFiles}\\\\dotnet`,\r\n        `${userProfile}\\\\.dotnet\\\\tools`,\r\n        // Git\r\n        `${programFiles}\\\\Git\\\\cmd`,\r\n    ]\r\n\r\n    let enhancedPath = currentPath\r\n    for (const p of additionalPaths) {\r\n        if (fs.existsSync(p) && !enhancedPath.toLowerCase().includes(p.toLowerCase())) {\r\n            enhancedPath = `${p};${enhancedPath}`\r\n        }\r\n    }\r\n\r\n    return enhancedPath\r\n}\r\n\r\nexport class DependencyManager extends EventEmitter {\r\n    private mainWindow: BrowserWindow | null = null\r\n    private runningProcesses = new Map<string, ChildProcess>()\r\n\r\n    constructor() {\r\n        super()\r\n    }\r\n\r\n    setMainWindow(window: BrowserWindow): void {\r\n        this.mainWindow = window\r\n    }\r\n\r\n    /**\r\n     * Check if a binary is available in PATH\r\n     */\r\n    private async isBinaryAvailable(command: string): Promise<boolean> {\r\n        try {\r\n            await new Promise((resolve, reject) => {\r\n                spawn(command, ['--version'], { shell: true, env: { ...process.env, PATH: getEnhancedPATH() } })\r\n                    .on('close', (code) => code === 0 ? resolve(true) : reject())\r\n                    .on('error', reject)\r\n            })\r\n            return true\r\n        } catch {\r\n            return false\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get Python command, preferring virtual environment if available\r\n     */\r\n    private getPythonCommand(cwd: string): string {\r\n        const venvPaths = [\r\n            path.join(cwd, 'venv', 'Scripts', 'pip.exe'),    // Windows\r\n            path.join(cwd, 'venv', 'bin', 'pip'),             // Unix\r\n            path.join(cwd, '.venv', 'Scripts', 'pip.exe'),\r\n            path.join(cwd, '.venv', 'bin', 'pip'),\r\n            path.join(cwd, 'env', 'Scripts', 'pip.exe'),      // Alternative names\r\n            path.join(cwd, 'env', 'bin', 'pip')\r\n        ]\r\n\r\n        for (const p of venvPaths) {\r\n            if (fs.existsSync(p)) {\r\n                console.log(`[DependencyManager] Found virtual environment at: ${p}`)\r\n                return p\r\n            }\r\n        }\r\n\r\n        return 'pip' // fallback to system pip\r\n    }\r\n\r\n    /**\r\n     * Get installation instructions for a package manager\r\n     */\r\n    private getInstallInstructions(command: string): string {\r\n        const instructions: Record<string, string> = {\r\n            npm: 'Download Node.js from https://nodejs.org',\r\n            yarn: 'Install via npm: npm install -g yarn',\r\n            pnpm: 'Install via npm: npm install -g pnpm',\r\n            bun: 'Download from https://bun.sh',\r\n            pip: 'Download Python from https://python.org',\r\n            pip3: 'Download Python 3 from https://python.org',\r\n            cargo: 'Install Rust from https://rustup.rs',\r\n            go: 'Download Go from https://go.dev/dl',\r\n            gem: 'Download Ruby from https://www.ruby-lang.org',\r\n            bundle: 'Install via gem: gem install bundler',\r\n            composer: 'Download from https://getcomposer.org',\r\n            mvn: 'Download Maven from https://maven.apache.org',\r\n            gradle: 'Download Gradle from https://gradle.org',\r\n            dotnet: 'Download .NET SDK from https://dot.net',\r\n            dart: 'Download Dart SDK from https://dart.dev'\r\n        }\r\n        return instructions[command] || `Please install ${command} to continue`\r\n    }\r\n\r\n    /**\r\n     * Detect which package manager to use based on workspace files\r\n     */\r\n    async detectPackageManager(workspacePath: string): Promise<PackageManagerConfig | null> {\r\n        try {\r\n            const files = await fs.promises.readdir(workspacePath)\r\n\r\n            // Check package.json for packageManager field (Corepack standard)\r\n            if (files.includes('package.json')) {\r\n                try {\r\n                    const packageJsonPath = path.join(workspacePath, 'package.json')\r\n                    const packageJsonContent = await fs.promises.readFile(packageJsonPath, 'utf-8')\r\n                    const packageJson = JSON.parse(packageJsonContent)\r\n\r\n                    if (packageJson.packageManager) {\r\n                        const managerName = packageJson.packageManager.split('@')[0]\r\n                        console.log(`[DependencyManager] Detected package manager from package.json: ${managerName}`)\r\n\r\n                        if (managerName === 'yarn' && PACKAGE_MANAGERS.yarn) return PACKAGE_MANAGERS.yarn\r\n                        if (managerName === 'pnpm' && PACKAGE_MANAGERS.pnpm) return PACKAGE_MANAGERS.pnpm\r\n                        if (managerName === 'npm' && PACKAGE_MANAGERS.npm) return PACKAGE_MANAGERS.npm\r\n                        if (managerName === 'bun' && PACKAGE_MANAGERS.bun) return PACKAGE_MANAGERS.bun\r\n                    }\r\n                } catch (error) {\r\n                    // If package.json can't be parsed, continue with lock file detection\r\n                    console.log('[DependencyManager] Could not read packageManager field from package.json:', error)\r\n                }\r\n            }\r\n\r\n            // Check for lock files (more specific than just manifest files)\r\n            if (files.includes('yarn.lock')) return PACKAGE_MANAGERS.yarn\r\n            if (files.includes('pnpm-lock.yaml')) return PACKAGE_MANAGERS.pnpm\r\n            if (files.includes('bun.lockb')) return PACKAGE_MANAGERS.bun\r\n            if (files.includes('package-lock.json')) return PACKAGE_MANAGERS.npm\r\n            if (files.includes('Cargo.lock')) return PACKAGE_MANAGERS.cargo\r\n            if (files.includes('Gemfile.lock')) return PACKAGE_MANAGERS.bundler\r\n            if (files.includes('composer.lock')) return PACKAGE_MANAGERS.composer\r\n            if (files.includes('pubspec.lock')) return PACKAGE_MANAGERS.pub\r\n            if (files.includes('go.sum')) return PACKAGE_MANAGERS.go\r\n\r\n            // Check for manifest files\r\n            if (files.includes('package.json')) return PACKAGE_MANAGERS.npm\r\n            if (files.includes('Cargo.toml')) return PACKAGE_MANAGERS.cargo\r\n            if (files.includes('requirements.txt')) return PACKAGE_MANAGERS.pip\r\n            if (files.includes('pyproject.toml')) return PACKAGE_MANAGERS.pip\r\n            if (files.includes('Gemfile')) return PACKAGE_MANAGERS.bundler\r\n            if (files.includes('composer.json')) return PACKAGE_MANAGERS.composer\r\n            if (files.includes('go.mod')) return PACKAGE_MANAGERS.go\r\n            if (files.includes('pom.xml')) return PACKAGE_MANAGERS.maven\r\n            if (files.includes('build.gradle')) return PACKAGE_MANAGERS.gradle\r\n            if (files.includes('pubspec.yaml')) return PACKAGE_MANAGERS.pub\r\n            if (files.some(f => f.endsWith('.csproj'))) return PACKAGE_MANAGERS.dotnet\r\n\r\n            return null\r\n        } catch (error) {\r\n            console.error('[DependencyManager] Error detecting package manager:', error)\r\n            return null\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get package manager for a specific language\r\n     */\r\n    getPackageManagerForLanguage(languageId: string): PackageManagerConfig | null {\r\n        const managerName = LANGUAGE_TO_MANAGER[languageId]\r\n        return managerName ? PACKAGE_MANAGERS[managerName] : null\r\n    }\r\n\r\n    /**\r\n     * Install a package\r\n     */\r\n    async installPackage(\r\n        packageName: string,\r\n        options: InstallOptions\r\n    ): Promise<DependencyResult> {\r\n        const manager = await this.detectPackageManager(options.workspacePath)\r\n        if (!manager) {\r\n            return { success: false, error: 'No package manager detected in workspace' }\r\n        }\r\n\r\n        // For Python, use virtual environment if available\r\n        let commandToUse = manager.command\r\n        if (manager.name === 'pip' || manager.name === 'pip3') {\r\n            const venvCommand = this.getPythonCommand(options.workspacePath)\r\n            if (venvCommand !== 'pip') {\r\n                commandToUse = venvCommand\r\n                console.log(`[DependencyManager] Using virtual environment: ${venvCommand}`)\r\n            }\r\n        }\r\n\r\n        // Check if binary exists\r\n        if (!(await this.isBinaryAvailable(manager.command))) {\r\n            return {\r\n                success: false,\r\n                error: `${manager.name} is not installed.\\n\\nInstall instructions:\\n${this.getInstallInstructions(manager.command)}`\r\n            }\r\n        }\r\n\r\n        const args = [...(options.dev && manager.installDevArgs ? manager.installDevArgs : manager.installArgs)]\r\n\r\n        // Add global flag if requested\r\n        if (options.global && manager.globalFlag) {\r\n            args.push(manager.globalFlag)\r\n        }\r\n\r\n        // Add package name with optional version\r\n        const pkgSpec = options.version ? `${packageName}@${options.version}` : packageName\r\n        args.push(pkgSpec)\r\n\r\n        return this.runCommand(commandToUse, args, options.workspacePath)\r\n    }\r\n\r\n    /**\r\n     * Install all dependencies from manifest file\r\n     */\r\n    async installAllDependencies(workspacePath: string): Promise<DependencyResult> {\r\n        const manager = await this.detectPackageManager(workspacePath)\r\n        if (!manager) {\r\n            return { success: false, error: 'No package manager detected. Create a package.json, Cargo.toml, or requirements.txt first.' }\r\n        }\r\n\r\n        // For Python, use virtual environment if available\r\n        let commandToUse = manager.command\r\n        if (manager.name === 'pip' || manager.name === 'pip3') {\r\n            const venvCommand = this.getPythonCommand(workspacePath)\r\n            if (venvCommand !== 'pip') {\r\n                commandToUse = venvCommand\r\n                console.log(`[DependencyManager] Using virtual environment: ${venvCommand}`)\r\n            }\r\n        }\r\n\r\n        // Check if binary exists\r\n        if (!(await this.isBinaryAvailable(manager.command))) {\r\n            return {\r\n                success: false,\r\n                error: `${manager.name} is not installed.\\n\\nInstall instructions:\\n${this.getInstallInstructions(manager.command)}`\r\n            }\r\n        }\r\n\r\n        // Special handling - most managers use 'install' with no package for all deps\r\n        let args: string[]\r\n        switch (manager.name) {\r\n            case 'npm':\r\n            case 'yarn':\r\n            case 'pnpm':\r\n            case 'bun':\r\n                args = ['install']\r\n                break\r\n            case 'pip':\r\n            case 'pip3':\r\n                args = ['install', '-r', 'requirements.txt']\r\n                break\r\n            case 'cargo':\r\n                args = ['build']\r\n                break\r\n            case 'go':\r\n                args = ['mod', 'download']\r\n                break\r\n            case 'bundler':\r\n                args = ['install']\r\n                break\r\n            case 'composer':\r\n                args = ['install']\r\n                break\r\n            case 'maven':\r\n                args = ['install', '-DskipTests']\r\n                break\r\n            case 'gradle':\r\n                args = ['build', '-x', 'test']\r\n                break\r\n            case 'dotnet':\r\n                args = ['restore']\r\n                break\r\n            case 'pub':\r\n                args = ['pub', 'get']\r\n                break\r\n            default:\r\n                args = manager.installArgs\r\n        }\r\n\r\n        return this.runCommand(commandToUse, args, workspacePath)\r\n    }\r\n\r\n    /**\r\n     * Uninstall a package\r\n     */\r\n    async uninstallPackage(packageName: string, workspacePath: string): Promise<DependencyResult> {\r\n        const manager = await this.detectPackageManager(workspacePath)\r\n        if (!manager) {\r\n            return { success: false, error: 'No package manager detected in workspace' }\r\n        }\r\n\r\n        const args = [...manager.uninstallArgs, packageName]\r\n        return this.runCommand(manager.command, args, workspacePath)\r\n    }\r\n\r\n    /**\r\n     * Update a package (or all packages if no name specified)\r\n     */\r\n    async updatePackage(packageName: string | null, workspacePath: string): Promise<DependencyResult> {\r\n        const manager = await this.detectPackageManager(workspacePath)\r\n        if (!manager) {\r\n            return { success: false, error: 'No package manager detected in workspace' }\r\n        }\r\n\r\n        const args = [...manager.updateArgs]\r\n        if (packageName) {\r\n            args.push(packageName)\r\n        }\r\n        return this.runCommand(manager.command, args, workspacePath)\r\n    }\r\n\r\n    /**\r\n     * List installed packages\r\n     */\r\n    async listPackages(workspacePath: string): Promise<{ success: boolean; packages?: PackageInfo[]; error?: string }> {\r\n        const manager = await this.detectPackageManager(workspacePath)\r\n        if (!manager) {\r\n            return { success: false, error: 'No package manager detected in workspace' }\r\n        }\r\n\r\n        const result = await this.runCommand(manager.command, manager.listArgs, workspacePath, true)\r\n\r\n        if (!result.success) {\r\n            return { success: false, error: result.error }\r\n        }\r\n\r\n        // Parse output based on manager\r\n        try {\r\n            const packages = this.parsePackageList(manager.name, result.output || '')\r\n            return { success: true, packages }\r\n        } catch (error) {\r\n            return { success: false, error: `Failed to parse package list: ${error}` }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Initialize a new project with the specified package manager\r\n     */\r\n    async initProject(managerName: string, workspacePath: string): Promise<DependencyResult> {\r\n        const manager = PACKAGE_MANAGERS[managerName]\r\n        if (!manager || !manager.initCommand) {\r\n            return { success: false, error: `Cannot initialize project with ${managerName}` }\r\n        }\r\n\r\n        return this.runCommand(manager.command, manager.initCommand, workspacePath)\r\n    }\r\n\r\n    /**\r\n     * Get all supported package managers\r\n     */\r\n    getSupportedManagers(): PackageManagerConfig[] {\r\n        return Object.values(PACKAGE_MANAGERS)\r\n    }\r\n\r\n    /**\r\n     * Kill a running operation\r\n     */\r\n    killOperation(operationId: string): boolean {\r\n        const proc = this.runningProcesses.get(operationId)\r\n        if (proc) {\r\n            proc.kill('SIGTERM')\r\n            this.runningProcesses.delete(operationId)\r\n            return true\r\n        }\r\n        return false\r\n    }\r\n\r\n    /**\r\n     * Run a package manager command\r\n     */\r\n    private runCommand(\r\n        command: string,\r\n        args: string[],\r\n        cwd: string,\r\n        silent = false\r\n    ): Promise<DependencyResult> {\r\n        return new Promise((resolve) => {\r\n            const operationId = `deps_${Date.now()}`\r\n            let stdout = ''\r\n            let stderr = ''\r\n\r\n            console.log(`[DependencyManager] Running: ${command} ${args.join(' ')} in ${cwd}`)\r\n\r\n            const proc = spawn(command, args, {\r\n                cwd,\r\n                shell: true,\r\n                env: {\r\n                    ...process.env,\r\n                    PATH: getEnhancedPATH()\r\n                }\r\n            })\r\n\r\n            this.runningProcesses.set(operationId, proc)\r\n\r\n            proc.stdout?.on('data', (data: Buffer) => {\r\n                const output = data.toString()\r\n                stdout += output\r\n                if (!silent) {\r\n                    this.mainWindow?.webContents.send('deps:output', {\r\n                        operationId,\r\n                        type: 'stdout',\r\n                        data: output\r\n                    })\r\n                }\r\n            })\r\n\r\n            proc.stderr?.on('data', (data: Buffer) => {\r\n                const output = data.toString()\r\n                stderr += output\r\n                if (!silent) {\r\n                    this.mainWindow?.webContents.send('deps:output', {\r\n                        operationId,\r\n                        type: 'stderr',\r\n                        data: output\r\n                    })\r\n                }\r\n            })\r\n\r\n            proc.on('close', (exitCode: number | null) => {\r\n                this.runningProcesses.delete(operationId)\r\n                const success = exitCode === 0\r\n\r\n                this.mainWindow?.webContents.send('deps:complete', {\r\n                    operationId,\r\n                    success,\r\n                    exitCode\r\n                })\r\n\r\n                resolve({\r\n                    success,\r\n                    output: stdout,\r\n                    error: success ? undefined : stderr || `Process exited with code ${exitCode}`,\r\n                    exitCode: exitCode ?? undefined\r\n                })\r\n            })\r\n\r\n            proc.on('error', (error: Error) => {\r\n                this.runningProcesses.delete(operationId)\r\n\r\n                this.mainWindow?.webContents.send('deps:complete', {\r\n                    operationId,\r\n                    success: false,\r\n                    error: error.message\r\n                })\r\n\r\n                resolve({\r\n                    success: false,\r\n                    error: error.message\r\n                })\r\n            })\r\n        })\r\n    }\r\n\r\n    /**\r\n     * Parse package list output based on manager\r\n     */\r\n    private parsePackageList(managerName: string, output: string): PackageInfo[] {\r\n        try {\r\n            switch (managerName) {\r\n                case 'npm':\r\n                case 'yarn':\r\n                case 'pnpm': {\r\n                    const data = JSON.parse(output)\r\n                    const deps = data.dependencies || {}\r\n                    return Object.entries(deps).map(([name, info]: [string, any]) => ({\r\n                        name,\r\n                        version: info.version || info\r\n                    }))\r\n                }\r\n                case 'pip':\r\n                case 'pip3': {\r\n                    const packages = JSON.parse(output)\r\n                    return packages.map((pkg: any) => ({\r\n                        name: pkg.name,\r\n                        version: pkg.version\r\n                    }))\r\n                }\r\n                case 'cargo': {\r\n                    const data = JSON.parse(output)\r\n                    return (data.packages || []).map((pkg: any) => ({\r\n                        name: pkg.name,\r\n                        version: pkg.version\r\n                    }))\r\n                }\r\n                default:\r\n                    // For managers without JSON output, return empty\r\n                    return []\r\n            }\r\n        } catch {\r\n            return []\r\n        }\r\n    }\r\n}\r\n\r\n// Singleton instance\r\nlet dependencyManagerInstance: DependencyManager | null = null\r\n\r\nexport function getDependencyManager(): DependencyManager {\r\n    if (!dependencyManagerInstance) {\r\n        dependencyManagerInstance = new DependencyManager()\r\n    }\r\n    return dependencyManagerInstance\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\electron\\terminal\\languageGateway.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":255,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":255,"endColumn":30,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[8354,8436],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":267,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":267,"endColumn":30,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[8922,8983],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":323,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":323,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[11518,11618],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":348,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":348,"endColumn":29,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[12488,12600],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":349,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":349,"endColumn":29,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[12618,12689],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":351,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":351,"endColumn":33,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[12765,12851],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":352,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":352,"endColumn":33,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[12873,12952],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":354,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":354,"endColumn":33,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[13000,13087],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":355,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":355,"endColumn":33,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[13109,13188],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":425,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":425,"endColumn":30,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[16186,16256],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":445,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":445,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[17013,17111],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":485,"column":29,"nodeType":"MemberExpression","messageId":"unexpected","endLine":485,"endColumn":40,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[18554,18635],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":488,"column":29,"nodeType":"MemberExpression","messageId":"unexpected","endLine":488,"endColumn":42,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[18769,18854],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":567,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":567,"endColumn":25,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[21835,21920],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":602,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":602,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[23295,23381],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":622,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":622,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[24001,24085],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":662,"column":25,"nodeType":"MemberExpression","messageId":"unexpected","endLine":662,"endColumn":38,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[25522,25609],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":677,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":677,"endColumn":30,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[26065,26150],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":18,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n// main-process/languageGateway.ts\r\n// Rewritten to use vscode-jsonrpc directly (works in Electron without vscode dependency)\r\nimport { spawn, ChildProcess } from 'node:child_process'\r\nimport { EventEmitter } from 'node:events'\r\nimport {\r\n    createMessageConnection,\r\n    StreamMessageReader,\r\n    StreamMessageWriter,\r\n    MessageConnection,\r\n    InitializeRequest,\r\n    InitializeParams,\r\n    InitializedNotification,\r\n    ShutdownRequest,\r\n    ExitNotification\r\n} from 'vscode-languageserver-protocol/node'\r\nimport net from 'node:net'\r\nimport path from 'node:path'\r\n\r\nexport interface LanguageServerConfig {\r\n    command: string\r\n    args?: string[]\r\n    runtime?: string\r\n    env?: { [key: string]: string }\r\n    initializationOptions?: object\r\n}\r\n\r\nexport interface DebugAdapterConfig {\r\n    type: string\r\n    command: string\r\n    args?: string[]\r\n    runtime?: string\r\n    env?: { [key: string]: string }\r\n    configuration?: object\r\n    transport: 'stdio' | 'socket'\r\n}\r\n\r\nexport interface LanguageSession {\r\n    id: string\r\n    languageId: string\r\n    connection: MessageConnection\r\n    process: ChildProcess\r\n    workspacePath: string\r\n    capabilities?: unknown\r\n    status: 'starting' | 'running' | 'stopped' | 'error'\r\n}\r\n\r\nexport interface DebugSession {\r\n    id: string\r\n    languageId: string\r\n    process: ChildProcess\r\n    port?: number\r\n    socket?: net.Socket\r\n    configuration: object\r\n    status: 'starting' | 'running' | 'stopped' | 'error'\r\n}\r\n\r\nexport class LanguageRuntimeGateway extends EventEmitter {\r\n    private readonly languageServers = new Map<string, LanguageSession>()\r\n    private readonly debugSessions = new Map<string, DebugSession>()\r\n    private readonly languageConfigs: Map<string, LanguageServerConfig>\r\n    private readonly debugConfigs: Map<string, DebugAdapterConfig>\r\n\r\n    // Configuration for 40+ languages\r\n    // Note: Language servers are expected to be installed globally/in PATH\r\n    private readonly languageServerConfigurations: Record<string, LanguageServerConfig> = {\r\n        python: {\r\n            command: 'python',\r\n            args: ['-m', 'pylsp']\r\n            // NOTE: Removed PYTHONPATH clearing - it breaks virtualenvs\r\n        },\r\n        javascript: {\r\n            command: 'typescript-language-server',\r\n            args: ['--stdio']\r\n        },\r\n        typescript: {\r\n            command: 'typescript-language-server',\r\n            args: ['--stdio']\r\n        },\r\n        rust: {\r\n            command: 'rust-analyzer',\r\n            args: []\r\n        },\r\n        go: {\r\n            command: 'gopls',\r\n            args: ['serve']\r\n        },\r\n        java: {\r\n            command: 'jdtls',\r\n            args: []\r\n            // NOTE: jdtls may require --data and --configuration args\r\n            // User should configure via configureLanguageServer() if needed\r\n        },\r\n        cpp: {\r\n            command: 'clangd',\r\n            args: ['--background-index']\r\n        },\r\n        csharp: {\r\n            command: 'OmniSharp',\r\n            args: ['--languageserver']\r\n        },\r\n        php: {\r\n            command: 'intelephense',\r\n            args: ['--stdio']\r\n        },\r\n        ruby: {\r\n            command: 'solargraph',\r\n            args: ['stdio']\r\n        },\r\n        kotlin: {\r\n            command: 'kotlin-language-server',\r\n            args: []\r\n        },\r\n        swift: {\r\n            command: 'sourcekit-lsp',\r\n            args: []\r\n        },\r\n        haskell: {\r\n            command: 'haskell-language-server-wrapper',\r\n            args: ['--lsp']\r\n        },\r\n        scala: {\r\n            command: 'metals',\r\n            args: []\r\n        },\r\n        dart: {\r\n            command: 'dart',\r\n            args: ['language-server']\r\n        },\r\n        elixir: {\r\n            command: 'elixir-ls',\r\n            args: []\r\n        },\r\n        clojure: {\r\n            command: 'clojure-lsp',\r\n            args: []\r\n        },\r\n        lua: {\r\n            command: 'lua-language-server',\r\n            args: []\r\n        }\r\n    }\r\n\r\n    // Debug adapter configurations with transport type\r\n    private readonly debugAdapterConfigurations: Record<string, DebugAdapterConfig> = {\r\n        // NOTE: Node.js debug config needs a proper DAP adapter\r\n        // 'node' with --inspect-brk uses Chrome Inspector Protocol, NOT DAP\r\n        // Use 'js-debug' or similar DAP adapter binary instead\r\n        node: {\r\n            type: 'node',\r\n            command: 'js-debug',  // Placeholder - needs actual DAP adapter\r\n            args: ['${program}'],\r\n            transport: 'stdio'\r\n        },\r\n        python: {\r\n            type: 'python',\r\n            command: 'python',\r\n            args: ['-m', 'debugpy', '--listen', '${port}', '--wait-for-client', '${program}'],\r\n            transport: 'socket'\r\n        },\r\n        go: {\r\n            type: 'go',\r\n            command: 'dlv',\r\n            args: ['dap', '--listen', '127.0.0.1:${port}'],\r\n            transport: 'socket'\r\n        },\r\n        // NOTE: Java debug config needs a proper DAP adapter\r\n        // 'java' with -agentlib:jdwp uses JDWP protocol, NOT DAP\r\n        // Use 'java-debug-adapter' or similar DAP adapter binary instead\r\n        java: {\r\n            type: 'java',\r\n            command: 'java-debug',  // Placeholder - needs actual DAP adapter\r\n            args: ['--server', '--port', '${port}'],\r\n            transport: 'socket'\r\n        },\r\n        cpp: {\r\n            type: 'cppdbg',\r\n            command: 'lldb-vscode',\r\n            args: [],\r\n            transport: 'stdio'\r\n        },\r\n        rust: {\r\n            type: 'lldb',\r\n            command: 'lldb-vscode',\r\n            args: [],\r\n            transport: 'stdio'\r\n        },\r\n        php: {\r\n            type: 'php',\r\n            command: 'php',\r\n            args: ['-dxdebug.start_with_request=yes', '-S', 'localhost:0'],\r\n            transport: 'socket'\r\n        }\r\n    }\r\n\r\n    constructor() {\r\n        super()\r\n        this.languageConfigs = new Map(Object.entries(this.languageServerConfigurations))\r\n        this.debugConfigs = new Map(Object.entries(this.debugAdapterConfigurations))\r\n    }\r\n\r\n    /**\r\n     * Start a language server using direct JSON-RPC communication\r\n     * Works in Electron without requiring the vscode module\r\n     */\r\n    async loadLanguageServer(options: {\r\n        languageId: string\r\n        workspacePath: string\r\n        rootUri?: string\r\n        initializationOptions?: object\r\n    }): Promise<{ success: boolean; sessionId?: string; error?: string }> {\r\n        try {\r\n            const config = this.languageConfigs.get(options.languageId)\r\n            if (!config) {\r\n                return { success: false, error: `No language server configuration found for ${options.languageId}` }\r\n            }\r\n\r\n            const sessionId = `lsp_${options.languageId}_${Date.now()}`\r\n\r\n            // Check if we already have a session for this language in this workspace\r\n            for (const [existingId, existingSession] of Array.from(this.languageServers)) {\r\n                if (existingSession.languageId === options.languageId &&\r\n                    existingSession.workspacePath === options.workspacePath &&\r\n                    existingSession.status === 'running') {\r\n                    return { success: true, sessionId: existingId }\r\n                }\r\n            }\r\n\r\n            // Spawn the language server process\r\n            const serverProcess = spawn(config.command, config.args || [], {\r\n                cwd: options.workspacePath,\r\n                env: { ...process.env, ...config.env },\r\n                stdio: ['pipe', 'pipe', 'pipe']\r\n            })\r\n\r\n            // Create JSON-RPC connection over stdio\r\n            const connection = createMessageConnection(\r\n                new StreamMessageReader(serverProcess.stdout!),\r\n                new StreamMessageWriter(serverProcess.stdin!)\r\n            )\r\n\r\n            const session: LanguageSession = {\r\n                id: sessionId,\r\n                languageId: options.languageId,\r\n                connection,\r\n                process: serverProcess,\r\n                workspacePath: options.workspacePath,\r\n                status: 'starting'\r\n            }\r\n\r\n            // Handle process errors\r\n            serverProcess.on('error', (error) => {\r\n                console.error(`[LanguageGateway] Process error for ${options.languageId}:`, error)\r\n                session.status = 'error'\r\n                this.emit('language_server_error', { sessionId, error: String(error) })\r\n            })\r\n\r\n            serverProcess.on('exit', (code) => {\r\n                session.status = 'stopped'\r\n                this.languageServers.delete(sessionId)\r\n                this.emit('language_server_stopped', { sessionId, exitCode: code })\r\n            })\r\n\r\n            serverProcess.stderr?.on('data', (data: Buffer) => {\r\n                console.error(`[LSP ${options.languageId}]`, data.toString())\r\n            })\r\n\r\n            // Start listening on the connection\r\n            connection.listen()\r\n\r\n            // Send initialize request\r\n            const rootUri = options.rootUri || `file:///${options.workspacePath.replace(/\\\\/g, '/')}`\r\n            const initParams: InitializeParams = {\r\n                processId: process.pid,\r\n                capabilities: {\r\n                    textDocument: {\r\n                        synchronization: { dynamicRegistration: true, didSave: true },\r\n                        completion: { dynamicRegistration: true, completionItem: { snippetSupport: true } },\r\n                        hover: { dynamicRegistration: true },\r\n                        definition: { dynamicRegistration: true },\r\n                        references: { dynamicRegistration: true },\r\n                        documentSymbol: { dynamicRegistration: true },\r\n                        codeAction: { dynamicRegistration: true },\r\n                        formatting: { dynamicRegistration: true },\r\n                        rangeFormatting: { dynamicRegistration: true },\r\n                        rename: { dynamicRegistration: true },\r\n                        publishDiagnostics: { relatedInformation: true }\r\n                    },\r\n                    workspace: {\r\n                        workspaceFolders: true,\r\n                        applyEdit: true,\r\n                        didChangeConfiguration: { dynamicRegistration: true }\r\n                    }\r\n                },\r\n                rootUri,\r\n                workspaceFolders: [{\r\n                    uri: rootUri,\r\n                    name: path.basename(options.workspacePath)\r\n                }],\r\n                initializationOptions: options.initializationOptions || config.initializationOptions\r\n            }\r\n\r\n            const initResult = await connection.sendRequest(InitializeRequest.type, initParams)\r\n            session.capabilities = initResult.capabilities\r\n\r\n            // Send initialized notification\r\n            connection.sendNotification(InitializedNotification.type, {})\r\n\r\n            // Store session after successful initialization\r\n            this.languageServers.set(sessionId, session)\r\n            session.status = 'running'\r\n\r\n            this.emit('language_server_started', {\r\n                sessionId,\r\n                languageId: options.languageId,\r\n                capabilities: initResult.capabilities\r\n            })\r\n\r\n            return { success: true, sessionId }\r\n        } catch (error) {\r\n            console.error(`[LanguageGateway] Failed to start language server for ${options.languageId}:`, error)\r\n            return { success: false, error: String(error) }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Start a debug session with proper retry logic for socket connections\r\n     */\r\n    async startDebugSession(options: {\r\n        sessionId: string\r\n        languageId: string\r\n        program: string\r\n        args?: string[]\r\n        cwd?: string\r\n        stopOnEntry?: boolean\r\n        port?: number\r\n    }): Promise<{ success: boolean; port?: number; error?: string }> {\r\n        try {\r\n            const config = this.debugConfigs.get(options.languageId)\r\n            if (!config) {\r\n                return { success: false, error: `No debug adapter configuration found for ${options.languageId}` }\r\n            }\r\n\r\n            // Warn about placeholder configurations\r\n            if (options.languageId === 'node' || options.languageId === 'java') {\r\n                console.warn(`[LanguageGateway] WARNING: ${options.languageId} debug adapter uses a placeholder configuration.`)\r\n                console.warn(`  The command '${config.command}' may not be installed.`)\r\n                if (options.languageId === 'node') {\r\n                    console.warn(`  Node.js debugging requires 'vscode-js-debug' or similar DAP adapter.`)\r\n                    console.warn(`  Configure via: gateway.configureDebugAdapter('node', { ... })`)\r\n                } else {\r\n                    console.warn(`  Java debugging requires 'com.microsoft.java.debug.plugin' or similar.`)\r\n                    console.warn(`  Configure via: gateway.configureDebugAdapter('java', { ... })`)\r\n                }\r\n                this.emit('debug_warning', {\r\n                    languageId: options.languageId,\r\n                    message: `${options.languageId} debugger requires additional configuration`\r\n                })\r\n            }\r\n\r\n            const port = config.transport === 'socket'\r\n                ? (options.port || await this.findAvailablePort())\r\n                : undefined\r\n            const sessionId = options.sessionId || `debug_${options.languageId}_${Date.now()}`\r\n\r\n            // Replace variables in command arguments\r\n            // Handle ${args} specially to preserve array structure\r\n            const processedArgs = (config.args || []).flatMap(arg => {\r\n                if (arg === '${args}') {\r\n                    return options.args || []\r\n                }\r\n                if (arg.includes('${args}')) {\r\n                    // If ${args} is part of a larger string, join with spaces\r\n                    // This is risky with paths containing spaces but sometimes needed\r\n                    return arg\r\n                        .replace(/\\$\\{port\\}/g, String(port || 0))\r\n                        .replace(/\\$\\{program\\}/g, options.program)\r\n                        .replace(/\\$\\{args\\}/g, (options.args || []).join(' '))\r\n                }\r\n                return arg\r\n                    .replace(/\\$\\{port\\}/g, String(port || 0))\r\n                    .replace(/\\$\\{program\\}/g, options.program)\r\n            })\r\n\r\n            // Spawn debug adapter process\r\n            const debugProcess = spawn(config.command, processedArgs, {\r\n                cwd: options.cwd || process.cwd(),\r\n                env: { ...process.env, ...config.env },\r\n                stdio: config.transport === 'stdio' ? ['pipe', 'pipe', 'pipe'] : 'pipe'\r\n            })\r\n\r\n            const session: DebugSession = {\r\n                id: sessionId,\r\n                languageId: options.languageId,\r\n                process: debugProcess,\r\n                port,\r\n                configuration: {\r\n                    type: config.type,\r\n                    request: 'launch',\r\n                    name: `Debug ${path.basename(options.program)}`,\r\n                    program: options.program,\r\n                    args: options.args,\r\n                    cwd: options.cwd,\r\n                    stopOnEntry: options.stopOnEntry,\r\n                    port\r\n                },\r\n                status: 'starting'\r\n            }\r\n\r\n            this.debugSessions.set(sessionId, session)\r\n\r\n            // Handle process exit\r\n            debugProcess.on('exit', (code: number | null) => {\r\n                session.status = 'stopped'\r\n                if (session.socket) {\r\n                    session.socket.destroy()\r\n                }\r\n                this.debugSessions.delete(sessionId)\r\n                this.emit('debug_session_stopped', { sessionId, exitCode: code })\r\n            })\r\n\r\n            debugProcess.stderr?.on('data', (data: Buffer) => {\r\n                console.error(`[DebugAdapter ${options.languageId}]`, data.toString())\r\n            })\r\n\r\n            // Handle based on transport type\r\n            if (config.transport === 'stdio') {\r\n                // Stdio transport - ready immediately\r\n                session.status = 'running'\r\n                this.emit('debug_session_started', {\r\n                    sessionId,\r\n                    languageId: options.languageId,\r\n                    configuration: session.configuration,\r\n                    transport: 'stdio'\r\n                })\r\n            } else {\r\n                // Socket transport - need to connect with retry\r\n                await this.connectWithRetry(port!, session, sessionId, options, debugProcess)\r\n            }\r\n\r\n            return { success: true, port }\r\n        } catch (error) {\r\n            console.error(`[LanguageGateway] Failed to start debug session for ${options.languageId}:`, error)\r\n            return { success: false, error: String(error) }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Connect to debug adapter with retry logic\r\n     * Handles the race condition where adapter needs time to start\r\n     */\r\n    private connectWithRetry(\r\n        port: number,\r\n        session: DebugSession,\r\n        sessionId: string,\r\n        options: { languageId: string },\r\n        debugProcess: ChildProcess,\r\n        maxRetries = 15,\r\n        retryDelayMs = 200\r\n    ): Promise<void> {\r\n        return new Promise((resolve, reject) => {\r\n            let retries = 0\r\n\r\n            const attemptConnect = (): void => {\r\n                const socket = net.createConnection({ port })\r\n                    .on('connect', () => {\r\n                        session.status = 'running'\r\n                        session.socket = socket\r\n                        this.emit('debug_session_started', {\r\n                            sessionId,\r\n                            languageId: options.languageId,\r\n                            port,\r\n                            configuration: session.configuration,\r\n                            transport: 'socket'\r\n                        })\r\n                        resolve()\r\n                    })\r\n                    .on('error', (error) => {\r\n                        socket.destroy()\r\n\r\n                        if (retries < maxRetries) {\r\n                            retries++\r\n                            console.log(`[Debug] Connection retry ${retries}/${maxRetries} for port ${port}`)\r\n                            setTimeout(attemptConnect, retryDelayMs)\r\n                        } else {\r\n                            console.error(`[DebugAdapter] Failed to connect after ${maxRetries} retries:`, error)\r\n                            session.status = 'error'\r\n                            debugProcess.kill()\r\n                            this.emit('debug_session_error', {\r\n                                sessionId,\r\n                                error: `Failed to connect to debug adapter: ${error.message}`\r\n                            })\r\n                            reject(error)\r\n                        }\r\n                    })\r\n            }\r\n\r\n            // Start connection attempts\r\n            attemptConnect()\r\n        })\r\n    }\r\n\r\n    /**\r\n     * Send LSP request through the message connection\r\n     */\r\n    async sendLSPRequest(sessionId: string, method: string, params: unknown): Promise<unknown> {\r\n        const session = this.languageServers.get(sessionId)\r\n        if (!session) {\r\n            throw new Error(`Language session ${sessionId} not found`)\r\n        }\r\n\r\n        if (session.status !== 'running') {\r\n            throw new Error(`Language session ${sessionId} is not running (status: ${session.status})`)\r\n        }\r\n\r\n        return session.connection.sendRequest(method, params as object)\r\n    }\r\n\r\n    /**\r\n     * Send debug adapter request\r\n     * \r\n     * TODO: CRITICAL - This is a placeholder!\r\n     * Currently, this does NOT implement the Debug Adapter Protocol (DAP).\r\n     * \r\n     * What works:\r\n     * - Spawning debug processes\r\n     * - Socket connections with retry logic\r\n     * - Process cleanup\r\n     * \r\n     * What is missing:\r\n     * - DAP message protocol (Content-Length headers + JSON-RPC body)\r\n     * - Reading from socket/stdio streams\r\n     * - Writing commands (setBreakpoints, continue, stepOver, etc.)\r\n     * - Parsing DAP responses\r\n     * \r\n     * To implement:\r\n     * 1. Install vscode-debugprotocol package\r\n     * 2. Create DAP message reader/writer for socket/stdio\r\n     * 3. Implement request/response handling\r\n     * \r\n     * Example implementation:\r\n     * ```typescript\r\n     * if (session.socket) {\r\n     *     // For socket transport\r\n     *     const message = JSON.stringify({ seq: 1, type: 'request', command: method, arguments: params })\r\n     *     session.socket.write(`Content-Length: ${message.length}\\r\\n\\r\\n${message}`)\r\n     * } else {\r\n     *     // For stdio transport  \r\n     *     session.process.stdin.write(...)\r\n     * }\r\n     * ```\r\n     */\r\n    async sendDebugRequest(sessionId: string, method: string, params: unknown): Promise<unknown> {\r\n        const session = this.debugSessions.get(sessionId)\r\n        if (!session) {\r\n            throw new Error(`Debug session ${sessionId} not found`)\r\n        }\r\n\r\n        // TODO: Implement actual DAP protocol communication\r\n        // For socket transport, send through session.socket\r\n        // For stdio, send through session.process.stdin\r\n        // This would need full DAP protocol implementation\r\n        return new Promise((resolve, _reject) => {\r\n            // Placeholder - full DAP implementation would go here\r\n            console.warn('[LanguageGateway] sendDebugRequest not implemented - placeholder only')\r\n            resolve({ success: true, method, params })\r\n        })\r\n    }\r\n\r\n    async getLanguageServers(): Promise<Array<{ languageId: string; sessionId: string; status: string }>> {\r\n        return Array.from(this.languageServers.values()).map(session => ({\r\n            languageId: session.languageId,\r\n            sessionId: session.id,\r\n            status: session.status\r\n        }))\r\n    }\r\n\r\n    async getDebugSessions(): Promise<Array<{ languageId: string; sessionId: string; port?: number; status: string }>> {\r\n        return Array.from(this.debugSessions.values()).map(session => ({\r\n            languageId: session.languageId,\r\n            sessionId: session.id,\r\n            port: session.port,\r\n            status: session.status\r\n        }))\r\n    }\r\n\r\n    async stopLanguageServer(sessionId: string): Promise<boolean> {\r\n        const session = this.languageServers.get(sessionId)\r\n        if (!session) return false\r\n\r\n        try {\r\n            // Send shutdown request followed by exit notification (LSP protocol)\r\n            await session.connection.sendRequest(ShutdownRequest.type)\r\n            session.connection.sendNotification(ExitNotification.type)\r\n            session.connection.dispose()\r\n            session.process.kill()\r\n            this.languageServers.delete(sessionId)\r\n            return true\r\n        } catch (error) {\r\n            console.error(`[LanguageGateway] Error stopping language server ${sessionId}:`, error)\r\n            // Force kill if graceful shutdown fails\r\n            session.process.kill('SIGKILL')\r\n            this.languageServers.delete(sessionId)\r\n            return false\r\n        }\r\n    }\r\n\r\n    async stopDebugSession(sessionId: string): Promise<boolean> {\r\n        const session = this.debugSessions.get(sessionId)\r\n        if (!session) return false\r\n\r\n        try {\r\n            if (session.socket) {\r\n                session.socket.destroy()\r\n            }\r\n            session.process.kill()\r\n            this.debugSessions.delete(sessionId)\r\n            return true\r\n        } catch (error) {\r\n            console.error(`[LanguageGateway] Error stopping debug session ${sessionId}:`, error)\r\n            return false\r\n        }\r\n    }\r\n\r\n    private async findAvailablePort(): Promise<number> {\r\n        return new Promise((resolve) => {\r\n            const server = net.createServer()\r\n            server.listen(0, () => {\r\n                const port = (server.address() as net.AddressInfo).port\r\n                server.close(() => resolve(port))\r\n            })\r\n        })\r\n    }\r\n\r\n    configureLanguageServer(languageId: string, config: LanguageServerConfig): void {\r\n        this.languageConfigs.set(languageId, config)\r\n    }\r\n\r\n    configureDebugAdapter(languageId: string, config: DebugAdapterConfig): void {\r\n        this.debugConfigs.set(languageId, config)\r\n    }\r\n\r\n    getSupportedLanguages(): string[] {\r\n        return Array.from(this.languageConfigs.keys())\r\n    }\r\n\r\n    async dispose(): Promise<void> {\r\n        // Stop all language servers gracefully\r\n        const stopPromises: Promise<void>[] = []\r\n\r\n        for (const [sessionId, session] of Array.from(this.languageServers)) {\r\n            stopPromises.push(\r\n                (async () => {\r\n                    try {\r\n                        await session.connection.sendRequest(ShutdownRequest.type)\r\n                        session.connection.sendNotification(ExitNotification.type)\r\n                        session.connection.dispose()\r\n                        session.process.kill()\r\n                    } catch (error) {\r\n                        console.error(`[LanguageGateway] Error disposing language server ${sessionId}:`, error)\r\n                        session.process.kill('SIGKILL')\r\n                    }\r\n                })()\r\n            )\r\n        }\r\n\r\n        // Stop all debug sessions\r\n        for (const [sessionId, session] of Array.from(this.debugSessions)) {\r\n            try {\r\n                if (session.socket) {\r\n                    session.socket.destroy()\r\n                }\r\n                session.process.kill()\r\n            } catch (error) {\r\n                console.error(`[LanguageGateway] Error disposing debug session ${sessionId}:`, error)\r\n            }\r\n        }\r\n\r\n        await Promise.all(stopPromises)\r\n\r\n        this.languageServers.clear()\r\n        this.debugSessions.clear()\r\n        this.removeAllListeners()\r\n    }\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\electron\\terminal\\shellIntegration.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":12,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":12,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[348,351],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[348,351],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-constant-condition","severity":2,"message":"Unexpected constant condition.","line":248,"column":16,"nodeType":"Literal","messageId":"unexpected","endLine":248,"endColumn":20},{"ruleId":"no-control-regex","severity":2,"message":"Unexpected control character(s) in regular expression: \\x1b, \\x07.","line":249,"column":45,"nodeType":"Literal","messageId":"unexpected","endLine":249,"endColumn":66},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":350,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":350,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[11342,11411],"text":""},"desc":"Remove the console.log()."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n// main-process/shellIntegration.ts\r\nimport { IPty } from 'node-pty'\r\nimport { EventEmitter } from 'events'\r\n\r\nexport interface ShellIntegrationData {\r\n    type: 'command_start' | 'command_end' | 'cwd_change' | 'prompt' | 'continuation'\r\n    timestamp: number\r\n    terminalId: string\r\n    data?: any\r\n}\r\n\r\nexport interface CommandRecord {\r\n    id: string\r\n    terminalId: string\r\n    command: string\r\n    cwd: string\r\n    startTime: number\r\n    endTime?: number\r\n    exitCode?: number\r\n    output?: string\r\n    hasOutput: boolean\r\n    decorations?: Array<{\r\n        line: number\r\n        column: number\r\n        length: number\r\n        type: 'error' | 'warning' | 'info' | 'success'\r\n        message?: string\r\n    }>\r\n}\r\n\r\nexport class ShellIntegrationService extends EventEmitter {\r\n    private integrations = new Map<string, ShellIntegration>()\r\n    private commandHistory = new Map<string, CommandRecord[]>()\r\n    private maxCommandHistory = 1000\r\n\r\n    constructor() {\r\n        super()\r\n    }\r\n\r\n    attachToTerminal(terminalId: string, ptyProcess: IPty, shell: string): void {\r\n        const integration = new ShellIntegration(terminalId, shell, ptyProcess)\r\n        this.integrations.set(terminalId, integration)\r\n\r\n        integration.on('data', (data: ShellIntegrationData) => {\r\n            this.handleIntegrationData(data)\r\n        })\r\n\r\n        integration.on('command', (command: CommandRecord) => {\r\n            this.handleCommandRecord(command)\r\n        })\r\n\r\n        // Initialize shell integration\r\n        integration.initialize()\r\n    }\r\n\r\n    private handleIntegrationData(data: ShellIntegrationData): void {\r\n        this.emit('integration_data', data)\r\n\r\n        // Process based on type\r\n        switch (data.type) {\r\n            case 'command_start':\r\n                // Handle command start\r\n                break\r\n            case 'command_end':\r\n                // Handle command end\r\n                break\r\n            case 'cwd_change':\r\n                // Update current working directory\r\n                break\r\n        }\r\n    }\r\n\r\n    private handleCommandRecord(command: CommandRecord): void {\r\n        // Store in history\r\n        const history = this.commandHistory.get(command.terminalId) || []\r\n        history.push(command)\r\n\r\n        // Trim history if too long\r\n        if (history.length > this.maxCommandHistory) {\r\n            history.splice(0, history.length - this.maxCommandHistory)\r\n        }\r\n\r\n        this.commandHistory.set(command.terminalId, history)\r\n\r\n        // Emit event for UI updates\r\n        this.emit('command_recorded', command)\r\n\r\n        // Analyze command for decorations\r\n        this.analyzeCommandForDecorations(command)\r\n    }\r\n\r\n    private analyzeCommandForDecorations(command: CommandRecord): void {\r\n        // Analyze command output for errors, warnings, etc.\r\n        if (command.output) {\r\n            const decorations: Array<{\r\n                line: number\r\n                column: number\r\n                length: number\r\n                type: 'error' | 'warning' | 'info' | 'success'\r\n                message?: string\r\n            }> = []\r\n\r\n            // Example: Find error patterns\r\n            const errorPatterns = [\r\n                /error:/gi,\r\n                /failed/gi,\r\n                /syntax error/gi,\r\n                /not found/gi,\r\n                /permission denied/gi\r\n            ]\r\n\r\n            const lines = command.output.split('\\n')\r\n            lines.forEach((line, lineIndex) => {\r\n                errorPatterns.forEach(pattern => {\r\n                    const matches = line.match(pattern)\r\n                    if (matches) {\r\n                        matches.forEach(match => {\r\n                            const column = line.indexOf(match)\r\n                            decorations.push({\r\n                                line: lineIndex,\r\n                                column,\r\n                                length: match.length,\r\n                                type: 'error',\r\n                                message: 'Error detected'\r\n                            })\r\n                        })\r\n                    }\r\n                })\r\n            })\r\n\r\n            if (decorations.length > 0) {\r\n                command.decorations = decorations\r\n                this.emit('decorations_available', {\r\n                    terminalId: command.terminalId,\r\n                    commandId: command.id,\r\n                    decorations\r\n                })\r\n            }\r\n        }\r\n    }\r\n\r\n    processData(terminalId: string, data: string): void {\r\n        const integration = this.integrations.get(terminalId)\r\n        if (integration) {\r\n            integration.processData(data)\r\n        }\r\n    }\r\n\r\n    getCommandHistory(terminalId: string): CommandRecord[] {\r\n        return this.commandHistory.get(terminalId) || []\r\n    }\r\n\r\n    getCurrentCommand(terminalId: string): CommandRecord | undefined {\r\n        const history = this.commandHistory.get(terminalId)\r\n        return history ? history[history.length - 1] : undefined\r\n    }\r\n\r\n    clearHistory(terminalId: string): void {\r\n        this.commandHistory.delete(terminalId)\r\n    }\r\n\r\n    getShellIntegrationScript(shell: string): string {\r\n        const scripts = {\r\n            bash: `\r\n        __kalynt_prompt_command() {\r\n          local exit_code=$?\r\n          printf \"\\\\033]633;E;$exit_code\\\\007\"\r\n          printf \"\\\\033]633;D\\\\007\"\r\n        }\r\n        PS1=\"\\\\[\\\\033]633;A\\\\007\\\\]\\\\[\\\\033]633;C;$PWD\\\\007\\\\]\\\\[\\\\033]633;B\\\\007\\\\]$PS1\\\\[\\\\033]633;D\\\\007\\\\]\"\r\n        trap '__kalynt_prompt_command' DEBUG\r\n      `,\r\n            zsh: `\r\n        precmd() {\r\n          printf \"\\\\033]633;A\\\\007\"\r\n          printf \"\\\\033]633;C;$PWD\\\\007\"\r\n          printf \"\\\\033]633;B\\\\007\"\r\n        }\r\n        preexec() {\r\n          printf \"\\\\033]633;D\\\\007\"\r\n        }\r\n      `,\r\n            fish: `\r\n        function __kalynt_prompt --on-event fish_prompt\r\n          printf \"\\\\033]633;A\\\\007\"\r\n          printf \"\\\\033]633;C;$PWD\\\\007\"\r\n          printf \"\\\\033]633;B\\\\007\"\r\n        end\r\n        function __kalynt_preexec --on-event fish_preexec\r\n          printf \"\\\\033]633;D\\\\007\"\r\n        end\r\n      `,\r\n            pwsh: `\r\n        function prompt {\r\n          Write-Host -NoNewLine \"\\`e]633; A\\`a\"\r\n          Write-Host -NoNewLine \"\\`e]633; C; $($executionContext.SessionState.Path.CurrentLocation)\\`a\"\r\n          Write-Host -NoNewLine \"\\`e]633; B\\`a\"\r\n          \"> \"\r\n        }\r\n        function __kalynt_preexec {\r\n          Write-Host -NoNewLine \"\\`e]633; D\\`a\"\r\n        }\r\n        Set-PSBreakpoint -Command '*' -Action { __kalynt_preexec }\r\n      `\r\n        }\r\n\r\n        return scripts[shell as keyof typeof scripts] || ''\r\n    }\r\n\r\n    dispose(): void {\r\n        this.integrations.clear()\r\n        this.commandHistory.clear()\r\n        this.removeAllListeners()\r\n    }\r\n}\r\n\r\nclass ShellIntegration extends EventEmitter {\r\n    private buffer = ''\r\n    private currentCommand?: CommandRecord\r\n    private outputBuffer = ''\r\n    private inCommand = false\r\n\r\n    constructor(\r\n        private terminalId: string,\r\n        private shell: string,\r\n        private ptyProcess: IPty\r\n    ) {\r\n        super()\r\n    }\r\n\r\n    initialize(): void {\r\n        const script = this.getIntegrationScript()\r\n        if (script) {\r\n            // Send initialization script\r\n            setTimeout(() => {\r\n                this.ptyProcess.write(script + '\\r\\n')\r\n            }, 100)\r\n        }\r\n    }\r\n\r\n    processData(data: string): void {\r\n        this.buffer += data\r\n\r\n        // Look for OSC 633 sequences (VS Code shell integration protocol)\r\n        while (true) {\r\n            const match = this.buffer.match(/\\x1b\\]633;(.+?)\\x07/)\r\n            if (!match) break\r\n\r\n            const sequence = match[1]\r\n            this.buffer = this.buffer.replace(match[0], '')\r\n            this.handleSequence(sequence)\r\n        }\r\n\r\n        // Buffer output if in command\r\n        if (this.inCommand) {\r\n            this.outputBuffer += data\r\n        }\r\n\r\n        // Pass through remaining data\r\n        if (this.buffer.length > 0) {\r\n            this.emit('raw_data', this.buffer)\r\n            this.buffer = ''\r\n        }\r\n    }\r\n\r\n    private handleSequence(sequence: string): void {\r\n        const [type, ...args] = sequence.split(';')\r\n\r\n        switch (type) {\r\n            case 'A': // Command started\r\n                this.inCommand = true\r\n                this.outputBuffer = ''\r\n                this.currentCommand = {\r\n                    id: `cmd_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\r\n                    terminalId: this.terminalId,\r\n                    command: '',\r\n                    cwd: args[0] || process.cwd(),\r\n                    startTime: Date.now(),\r\n                    hasOutput: false\r\n                }\r\n                this.emit('data', {\r\n                    type: 'command_start',\r\n                    timestamp: Date.now(),\r\n                    terminalId: this.terminalId,\r\n                    data: this.currentCommand\r\n                })\r\n                break\r\n\r\n            case 'B': // Command line updated\r\n                if (this.currentCommand) {\r\n                    this.currentCommand.command = args.join(';')\r\n                }\r\n                break\r\n\r\n            case 'C': // Current working directory\r\n                if (this.currentCommand) {\r\n                    this.currentCommand.cwd = args[0] || this.currentCommand.cwd\r\n                }\r\n                this.emit('data', {\r\n                    type: 'cwd_change',\r\n                    timestamp: Date.now(),\r\n                    terminalId: this.terminalId,\r\n                    data: { cwd: args[0] }\r\n                })\r\n                break\r\n\r\n            case 'D': // Command finished\r\n                this.inCommand = false\r\n                if (this.currentCommand) {\r\n                    this.currentCommand.endTime = Date.now()\r\n                    this.currentCommand.output = this.outputBuffer\r\n                    this.currentCommand.hasOutput = this.outputBuffer.length > 0\r\n\r\n                    this.emit('command', this.currentCommand)\r\n                    this.emit('data', {\r\n                        type: 'command_end',\r\n                        timestamp: Date.now(),\r\n                        terminalId: this.terminalId,\r\n                        data: this.currentCommand\r\n                    })\r\n                }\r\n                break\r\n\r\n            case 'E': // Exit code\r\n                if (this.currentCommand && args[0]) {\r\n                    this.currentCommand.exitCode = parseInt(args[0], 10)\r\n                }\r\n                break\r\n\r\n            case 'P': // Prompt\r\n                this.emit('data', {\r\n                    type: 'prompt',\r\n                    timestamp: Date.now(),\r\n                    terminalId: this.terminalId\r\n                })\r\n                break\r\n        }\r\n    }\r\n\r\n    private getIntegrationScript(): string {\r\n        // Don't wrap PowerShell/CMD in bash syntax!\r\n        const shellName = this.shell.toLowerCase()\r\n\r\n        // PowerShell variants - disable integration for now\r\n        // Multiline scripts cause parsing issues when sent through PTY\r\n        if (shellName.includes('pwsh') || shellName.includes('powershell')) {\r\n            console.log('[ShellIntegration] Skipping integration for PowerShell')\r\n            return '' // Disable until we can send single-line scripts\r\n        }\r\n\r\n        // CMD - no integration (limited shell)\r\n        if (shellName.includes('cmd')) {\r\n            return '' // CMD doesn't support advanced prompt customization\r\n        }\r\n\r\n        // Unix shells (bash, zsh, fish)\r\n        const baseScript = `\r\n      # Kalynt Terminal Shell Integration\r\n      if [ -n \"$KALYNT_TERMINAL\" ]; then\r\n        ${this.getShellSpecificScript()}\r\n      fi\r\n    `\r\n\r\n        return baseScript\r\n    }\r\n\r\n    private getShellSpecificScript(): string {\r\n        const scripts: Record<string, string> = {\r\n            bash: `\r\n        __kalynt_cmd_start() {\r\n          printf \"\\\\033]633;A\\\\007\"\r\n          printf \"\\\\033]633;C;$PWD\\\\007\"\r\n        }\r\n        __kalynt_cmd_end() {\r\n          printf \"\\\\033]633;D\\\\007\"\r\n        }\r\n        __kalynt_update_cmd() {\r\n          printf \"\\\\033]633;B;%s\\\\007\" \"$1\"\r\n        }\r\n        trap '__kalynt_cmd_start' DEBUG\r\n        PS1=\"\\\\[\\\\$(__kalynt_update_cmd \"\\\\W\")\\\\]$PS1\"\r\n      `,\r\n            zsh: `\r\n        __kalynt_preexec() {\r\n          printf \"\\\\033]633;A\\\\007\"\r\n          printf \"\\\\033]633;C;$PWD\\\\007\"\r\n        }\r\n        __kalynt_precmd() {\r\n          printf \"\\\\033]633;D\\\\007\"\r\n        }\r\n        autoload -Uz add-zsh-hook\r\n        add-zsh-hook preexec __kalynt_preexec\r\n        add-zsh-hook precmd __kalynt_precmd\r\n      `,\r\n            fish: `\r\n        function __kalynt_fish_preexec --on-event fish_preexec\r\n          printf \"\\\\033]633;A\\\\007\"\r\n          printf \"\\\\033]633;C;$PWD\\\\007\"\r\n        end\r\n        function __kalynt_fish_postexec --on-event fish_postexec\r\n          printf \"\\\\033]633;D\\\\007\"\r\n        end\r\n      `,\r\n            pwsh: `\r\n        function __kalynt_prompt {\r\n          Write-Host -NoNewLine \"\\`e]633; A\\`a\"\r\n          Write-Host -NoNewLine \"\\`e]633; C; $PWD\\`a\"\r\n          \"> \"\r\n        }\r\n        function __kalynt_preexec {\r\n          param($Command)\r\n          Write-Host -NoNewLine \"\\`e]633; B; $Command\\`a\"\r\n        }\r\n        Set-PSBreakpoint -Command '*' -Action { __kalynt_preexec $args[0] }\r\n      `\r\n        }\r\n\r\n        return scripts[this.shell] || ''\r\n    }\r\n}","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\electron\\terminal\\taskRunner.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'os' is defined but never used. Allowed unused vars must match /^_/u.","line":9,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":10,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"os"},"fix":{"range":[273,297],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'command' is defined but never used. Allowed unused args must match /^_/u.","line":76,"column":81,"nodeType":"Identifier","messageId":"unusedVar","endLine":76,"endColumn":88},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":89,"column":25,"nodeType":"MemberExpression","messageId":"unexpected","endLine":89,"endColumn":38,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[3059,3123],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":220,"column":25,"nodeType":"MemberExpression","messageId":"unexpected","endLine":220,"endColumn":38,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[8394,8454],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":352,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":352,"endColumn":30,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[13607,13674],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":365,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":365,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13939,13942],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13939,13942],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":366,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":366,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13973,13976],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13973,13976],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":378,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":378,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14479,14482],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14479,14482],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":501,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":501,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[19060,19118],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":519,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":519,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[19638,19714],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":572,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":572,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[21523,21590],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":590,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":590,"endColumn":34,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[22173,22251],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":10,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n// main-process/taskRunner.ts\r\nimport { spawn, ChildProcess, ChildProcessWithoutNullStreams } from 'node:child_process'\r\nimport { EventEmitter } from 'node:events'\r\nimport path from 'node:path'\r\nimport fs from 'node:fs'\r\nimport os from 'node:os'\r\n\r\nexport interface TaskDefinition {\r\n    id: string\r\n    label: string\r\n    type: 'shell' | 'process' | 'npm' | 'maven' | 'gradle' | 'make' | 'python' | 'dotnet'\r\n    command: string\r\n    args?: string[]\r\n    cwd?: string\r\n    env?: { [key: string]: string }\r\n    group?: 'build' | 'test' | 'run' | 'clean'\r\n    problemMatcher?: string | string[]\r\n    presentation?: {\r\n        echo?: boolean\r\n        reveal?: 'always' | 'silent' | 'never'\r\n        focus?: boolean\r\n        panel?: 'shared' | 'dedicated' | 'new'\r\n        showReuseMessage?: boolean\r\n        clear?: boolean\r\n    }\r\n    options?: {\r\n        shell?: {\r\n            executable?: string\r\n            args?: string[]\r\n        }\r\n    }\r\n}\r\n\r\nexport interface TaskExecution {\r\n    id: string\r\n    task: TaskDefinition\r\n    process: ChildProcess\r\n    startTime: number\r\n    endTime?: number\r\n    exitCode?: number\r\n    output: string\r\n    status: 'running' | 'succeeded' | 'failed' | 'cancelled'\r\n    terminalId?: string\r\n}\r\n\r\nexport interface TaskProvider {\r\n    provideTasks(workspacePath: string): Promise<TaskDefinition[]>\r\n    resolveTask(task: TaskDefinition): Promise<TaskDefinition>\r\n}\r\n\r\nexport class TaskRunnerService extends EventEmitter {\r\n    private executions = new Map<string, TaskExecution>()\r\n    private taskProviders = new Map<string, TaskProvider>()\r\n    private detectedTasks = new Map<string, TaskDefinition[]>()\r\n\r\n    constructor() {\r\n        super()\r\n        this.registerDefaultTaskProviders()\r\n    }\r\n\r\n    private registerDefaultTaskProviders(): void {\r\n        // NPM/Node.js tasks\r\n        this.registerTaskProvider('npm', {\r\n            provideTasks: async (workspacePath: string) => {\r\n                const tasks: TaskDefinition[] = []\r\n                const packageJsonPath = path.join(workspacePath, 'package.json')\r\n\r\n                if (fs.existsSync(packageJsonPath)) {\r\n                    try {\r\n                        const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, 'utf8'))\r\n\r\n                        if (packageJson.scripts) {\r\n                            Object.entries(packageJson.scripts).forEach(([name, command]) => {\r\n                                tasks.push({\r\n                                    id: `npm.${name}`,\r\n                                    label: `npm run ${name}`,\r\n                                    type: 'npm',\r\n                                    command: 'npm',\r\n                                    args: ['run', name],\r\n                                    cwd: workspacePath,\r\n                                    group: this.determineTaskGroup(name)\r\n                                })\r\n                            })\r\n                        }\r\n                    } catch (error) {\r\n                        console.error('[TaskRunner] Error reading package.json:', error)\r\n                    }\r\n                }\r\n\r\n                return tasks\r\n            },\r\n            resolveTask: async (task: TaskDefinition) => task\r\n        })\r\n\r\n        // Maven tasks\r\n        this.registerTaskProvider('maven', {\r\n            provideTasks: async (workspacePath: string) => {\r\n                const tasks: TaskDefinition[] = []\r\n                const pomPath = path.join(workspacePath, 'pom.xml')\r\n\r\n                if (fs.existsSync(pomPath)) {\r\n                    // Common Maven tasks\r\n                    const mavenTasks = [\r\n                        { name: 'compile', label: 'Maven: Compile' },\r\n                        { name: 'test', label: 'Maven: Test' },\r\n                        { name: 'package', label: 'Maven: Package' },\r\n                        { name: 'clean', label: 'Maven: Clean' },\r\n                        { name: 'install', label: 'Maven: Install' }\r\n                    ]\r\n\r\n                    mavenTasks.forEach(({ name, label }) => {\r\n                        tasks.push({\r\n                            id: `maven.${name}`,\r\n                            label,\r\n                            type: 'maven',\r\n                            command: 'mvn',\r\n                            args: [name],\r\n                            cwd: workspacePath,\r\n                            group: this.determineTaskGroup(name)\r\n                        })\r\n                    })\r\n                }\r\n\r\n                return tasks\r\n            },\r\n            resolveTask: async (task: TaskDefinition) => task\r\n        })\r\n\r\n        // Python tasks\r\n        this.registerTaskProvider('python', {\r\n            provideTasks: async (workspacePath: string) => {\r\n                const tasks: TaskDefinition[] = []\r\n\r\n                // Check for requirements.txt\r\n                const requirementsPath = path.join(workspacePath, 'requirements.txt')\r\n                if (fs.existsSync(requirementsPath)) {\r\n                    tasks.push({\r\n                        id: 'python.install',\r\n                        label: 'Python: Install Dependencies',\r\n                        type: 'python',\r\n                        command: 'pip',\r\n                        args: ['install', '-r', 'requirements.txt'],\r\n                        cwd: workspacePath,\r\n                        group: 'build'\r\n                    })\r\n                }\r\n\r\n                // Check for setup.py\r\n                const setupPath = path.join(workspacePath, 'setup.py')\r\n                if (fs.existsSync(setupPath)) {\r\n                    tasks.push({\r\n                        id: 'python.setup',\r\n                        label: 'Python: Setup Development',\r\n                        type: 'python',\r\n                        command: 'python',\r\n                        args: ['setup.py', 'develop'],\r\n                        cwd: workspacePath,\r\n                        group: 'build'\r\n                    })\r\n                }\r\n\r\n                // Add common Python tasks\r\n                tasks.push(\r\n                    {\r\n                        id: 'python.run',\r\n                        label: 'Python: Run',\r\n                        type: 'python',\r\n                        command: 'python',\r\n                        args: ['.'],\r\n                        cwd: workspacePath,\r\n                        group: 'run'\r\n                    },\r\n                    {\r\n                        id: 'python.test',\r\n                        label: 'Python: Run Tests',\r\n                        type: 'python',\r\n                        command: 'pytest',\r\n                        args: [],\r\n                        cwd: workspacePath,\r\n                        group: 'test'\r\n                    }\r\n                )\r\n\r\n                return tasks\r\n            },\r\n            resolveTask: async (task: TaskDefinition) => task\r\n        })\r\n\r\n        // Make tasks\r\n        this.registerTaskProvider('make', {\r\n            provideTasks: async (workspacePath: string) => {\r\n                const tasks: TaskDefinition[] = []\r\n                const makefilePath = path.join(workspacePath, 'Makefile')\r\n\r\n                if (fs.existsSync(makefilePath)) {\r\n                    try {\r\n                        // Read Makefile and extract targets\r\n                        const makefileContent = fs.readFileSync(makefilePath, 'utf8')\r\n                        const targetRegex = /^([a-zA-Z0-9_.-]+):/gm\r\n                        let match\r\n\r\n                        while ((match = targetRegex.exec(makefileContent)) !== null) {\r\n                            const target = match[1]\r\n                            if (!target.includes('.PHONY') && target !== 'all') {\r\n                                tasks.push({\r\n                                    id: `make.${target}`,\r\n                                    label: `Make: ${target}`,\r\n                                    type: 'make',\r\n                                    command: 'make',\r\n                                    args: [target],\r\n                                    cwd: workspacePath,\r\n                                    group: this.determineTaskGroup(target)\r\n                                })\r\n                            }\r\n                        }\r\n                    } catch (error) {\r\n                        console.error('[TaskRunner] Error reading Makefile:', error)\r\n                    }\r\n                }\r\n\r\n                return tasks\r\n            },\r\n            resolveTask: async (task: TaskDefinition) => task\r\n        })\r\n\r\n        // .NET tasks\r\n        this.registerTaskProvider('dotnet', {\r\n            provideTasks: async (workspacePath: string) => {\r\n                const tasks: TaskDefinition[] = []\r\n\r\n                // Find .csproj files\r\n                const csprojFiles = this.findFiles(workspacePath, '*.csproj')\r\n\r\n                if (csprojFiles.length > 0) {\r\n                    const csprojPath = csprojFiles[0]\r\n                    const projectName = path.basename(csprojPath, '.csproj')\r\n\r\n                    tasks.push(\r\n                        {\r\n                            id: 'dotnet.build',\r\n                            label: '.NET: Build',\r\n                            type: 'dotnet',\r\n                            command: 'dotnet',\r\n                            args: ['build'],\r\n                            cwd: workspacePath,\r\n                            group: 'build'\r\n                        },\r\n                        {\r\n                            id: 'dotnet.run',\r\n                            label: `.NET: Run ${projectName}`,\r\n                            type: 'dotnet',\r\n                            command: 'dotnet',\r\n                            args: ['run', '--project', csprojPath],\r\n                            cwd: workspacePath,\r\n                            group: 'run'\r\n                        },\r\n                        {\r\n                            id: 'dotnet.test',\r\n                            label: '.NET: Test',\r\n                            type: 'dotnet',\r\n                            command: 'dotnet',\r\n                            args: ['test'],\r\n                            cwd: workspacePath,\r\n                            group: 'test'\r\n                        },\r\n                        {\r\n                            id: 'dotnet.clean',\r\n                            label: '.NET: Clean',\r\n                            type: 'dotnet',\r\n                            command: 'dotnet',\r\n                            args: ['clean'],\r\n                            cwd: workspacePath,\r\n                            group: 'clean'\r\n                        }\r\n                    )\r\n                }\r\n\r\n                return tasks\r\n            },\r\n            resolveTask: async (task: TaskDefinition) => task\r\n        })\r\n\r\n        // Gradle tasks\r\n        this.registerTaskProvider('gradle', {\r\n            provideTasks: async (workspacePath: string) => {\r\n                const tasks: TaskDefinition[] = []\r\n                const gradleBuildPath = path.join(workspacePath, 'build.gradle')\r\n                const gradleBuildKtsPath = path.join(workspacePath, 'build.gradle.kts')\r\n\r\n                if (fs.existsSync(gradleBuildPath) || fs.existsSync(gradleBuildKtsPath)) {\r\n                    tasks.push(\r\n                        {\r\n                            id: 'gradle.build',\r\n                            label: 'Gradle: Build',\r\n                            type: 'gradle',\r\n                            command: './gradlew',\r\n                            args: ['build'],\r\n                            cwd: workspacePath,\r\n                            group: 'build'\r\n                        },\r\n                        {\r\n                            id: 'gradle.test',\r\n                            label: 'Gradle: Test',\r\n                            type: 'gradle',\r\n                            command: './gradlew',\r\n                            args: ['test'],\r\n                            cwd: workspacePath,\r\n                            group: 'test'\r\n                        },\r\n                        {\r\n                            id: 'gradle.clean',\r\n                            label: 'Gradle: Clean',\r\n                            type: 'gradle',\r\n                            command: './gradlew',\r\n                            args: ['clean'],\r\n                            cwd: workspacePath,\r\n                            group: 'clean'\r\n                        },\r\n                        {\r\n                            id: 'gradle.run',\r\n                            label: 'Gradle: Run',\r\n                            type: 'gradle',\r\n                            command: './gradlew',\r\n                            args: ['run'],\r\n                            cwd: workspacePath,\r\n                            group: 'run'\r\n                        }\r\n                    )\r\n                }\r\n\r\n                return tasks\r\n            },\r\n            resolveTask: async (task: TaskDefinition) => task\r\n        })\r\n    }\r\n\r\n    registerTaskProvider(type: string, provider: TaskProvider): void {\r\n        this.taskProviders.set(type, provider)\r\n    }\r\n\r\n    async detectTasks(workspacePath: string): Promise<TaskDefinition[]> {\r\n        const allTasks: TaskDefinition[] = []\r\n\r\n        for (const [type, provider] of Array.from(this.taskProviders)) {\r\n            try {\r\n                const tasks = await provider.provideTasks(workspacePath)\r\n                allTasks.push(...tasks)\r\n            } catch (error) {\r\n                console.error(`[TaskRunner] Error detecting ${type} tasks:`, error)\r\n            }\r\n        }\r\n\r\n        // Cache detected tasks\r\n        this.detectedTasks.set(workspacePath, allTasks)\r\n\r\n        return allTasks\r\n    }\r\n\r\n    async executeTask(options: {\r\n        id: string\r\n        task: TaskDefinition\r\n        terminalService: any\r\n        getMainWindow: () => any\r\n    }): Promise<{ success: boolean; executionId?: string; error?: string }> {\r\n        try {\r\n            const executionId = `exec_${Date.now()}_${Math.random().toString(36).substring(2, 11)}`\r\n\r\n            // Resolve task if needed\r\n            const resolvedTask = await this.resolveTask(options.task)\r\n\r\n            // Create execution record\r\n            const execution: TaskExecution = {\r\n                id: executionId,\r\n                task: resolvedTask,\r\n                process: null as any,\r\n                startTime: Date.now(),\r\n                output: '',\r\n                status: 'running'\r\n            }\r\n\r\n            // Determine command and arguments\r\n            let command = resolvedTask.command\r\n            const args = resolvedTask.args || []\r\n            let shell = true\r\n            const currentPlatform = process.platform\r\n\r\n            // Handle different task types\r\n            switch (resolvedTask.type) {\r\n                case 'shell':\r\n                    // shell is already true\r\n                    break\r\n                case 'process':\r\n                    shell = false\r\n                    break\r\n                case 'npm':\r\n                    command = currentPlatform === 'win32' ? 'npm.cmd' : 'npm'\r\n                    break\r\n                case 'maven':\r\n                    command = currentPlatform === 'win32' ? 'mvn.cmd' : 'mvn'\r\n                    break\r\n                case 'gradle':\r\n                    command = currentPlatform === 'win32' ? 'gradlew.bat' : './gradlew'\r\n                    break\r\n                case 'python':\r\n                    command = currentPlatform === 'win32' ? 'python.exe' : 'python'\r\n                    break\r\n                case 'dotnet':\r\n                    command = currentPlatform === 'win32' ? 'dotnet.exe' : 'dotnet'\r\n                    break\r\n            }\r\n\r\n            // Spawn child process\r\n            const childProcess: ChildProcessWithoutNullStreams = spawn(command, args, {\r\n                cwd: resolvedTask.cwd || process.cwd(),\r\n                env: { ...process.env, ...resolvedTask.env },\r\n                shell: shell,\r\n                stdio: ['pipe', 'pipe', 'pipe']\r\n            })\r\n\r\n            execution.process = childProcess\r\n            this.executions.set(executionId, execution)\r\n\r\n            // Setup output handling\r\n            let output = ''\r\n\r\n            const collectOutput = (data: Buffer) => {\r\n                const text = data.toString()\r\n                output += text\r\n                execution.output += text\r\n\r\n                // Emit output event\r\n                this.emit('task_output', {\r\n                    executionId,\r\n                    type: data === childProcess.stdout ? 'stdout' : 'stderr',\r\n                    data: text\r\n                })\r\n\r\n                // Send to renderer\r\n                const mainWindow = options.getMainWindow()\r\n                if (mainWindow) {\r\n                    mainWindow.webContents.send('task:output', {\r\n                        executionId,\r\n                        type: data === childProcess.stdout ? 'stdout' : 'stderr',\r\n                        data: text\r\n                    })\r\n                }\r\n            }\r\n\r\n            childProcess.stdout.on('data', collectOutput)\r\n            childProcess.stderr.on('data', collectOutput)\r\n\r\n            // Handle process completion\r\n            childProcess.on('exit', (code: number | null) => {\r\n                execution.endTime = Date.now()\r\n                execution.exitCode = code ?? undefined\r\n                execution.status = code === 0 ? 'succeeded' : 'failed'\r\n\r\n                this.emit('task_completed', {\r\n                    executionId,\r\n                    exitCode: code,\r\n                    output,\r\n                    duration: execution.endTime - execution.startTime\r\n                })\r\n\r\n                // Send completion to renderer\r\n                const mainWindow = options.getMainWindow()\r\n                if (mainWindow) {\r\n                    mainWindow.webContents.send('task:completed', {\r\n                        executionId,\r\n                        exitCode: code,\r\n                        status: execution.status,\r\n                        duration: execution.endTime - execution.startTime\r\n                    })\r\n                }\r\n            })\r\n\r\n            childProcess.on('error', (error: Error) => {\r\n                execution.endTime = Date.now()\r\n                execution.status = 'failed'\r\n\r\n                this.emit('task_error', {\r\n                    executionId,\r\n                    error: error.message\r\n                })\r\n\r\n                // Send error to renderer\r\n                const mainWindow = options.getMainWindow()\r\n                if (mainWindow) {\r\n                    mainWindow.webContents.send('task:error', {\r\n                        executionId,\r\n                        error: error.message\r\n                    })\r\n                }\r\n            })\r\n\r\n            return { success: true, executionId }\r\n        } catch (error) {\r\n            console.error('[TaskRunner] Error executing task:', error)\r\n            return { success: false, error: String(error) }\r\n        }\r\n    }\r\n\r\n    async killTaskExecution(executionId: string): Promise<boolean> {\r\n        const execution = this.executions.get(executionId)\r\n        if (!execution) return false\r\n\r\n        try {\r\n            execution.process.kill()\r\n            execution.status = 'cancelled'\r\n            execution.endTime = Date.now()\r\n\r\n            this.emit('task_cancelled', { executionId })\r\n\r\n            return true\r\n        } catch (error) {\r\n            console.error(`[TaskRunner] Error killing execution ${executionId}:`, error)\r\n            return false\r\n        }\r\n    }\r\n\r\n    async getTaskExecutions(): Promise<TaskExecution[]> {\r\n        return Array.from(this.executions.values())\r\n    }\r\n\r\n    async getTaskExecution(executionId: string): Promise<TaskExecution | undefined> {\r\n        return this.executions.get(executionId)\r\n    }\r\n\r\n    private async resolveTask(task: TaskDefinition): Promise<TaskDefinition> {\r\n        const provider = this.taskProviders.get(task.type)\r\n        if (provider) {\r\n            return await provider.resolveTask(task)\r\n        }\r\n        return task\r\n    }\r\n\r\n    private determineTaskGroup(taskName: string): 'build' | 'test' | 'run' | 'clean' {\r\n        const lowerName = taskName.toLowerCase()\r\n\r\n        if (lowerName.includes('test') || lowerName.includes('spec')) {\r\n            return 'test'\r\n        } else if (lowerName.includes('build') || lowerName.includes('compile')) {\r\n            return 'build'\r\n        } else if (lowerName.includes('run') || lowerName.includes('start')) {\r\n            return 'run'\r\n        } else if (lowerName.includes('clean') || lowerName.includes('purge')) {\r\n            return 'clean'\r\n        }\r\n\r\n        return 'build'\r\n    }\r\n\r\n    private findFiles(dir: string, pattern: string): string[] {\r\n        const files: string[] = []\r\n\r\n        try {\r\n            const entries = fs.readdirSync(dir, { withFileTypes: true })\r\n\r\n            for (const entry of entries) {\r\n                const fullPath = path.join(dir, entry.name)\r\n\r\n                if (entry.isDirectory()) {\r\n                    files.push(...this.findFiles(fullPath, pattern))\r\n                } else if (entry.isFile() && this.globToRegex(pattern).exec(entry.name)) {\r\n                    files.push(fullPath)\r\n                }\r\n            }\r\n        } catch (error) {\r\n            console.error(`[TaskRunner] Error finding files in ${dir}:`, error)\r\n        }\r\n\r\n        return files\r\n    }\r\n\r\n    private globToRegex(pattern: string): RegExp {\r\n        const escaped = pattern.replaceAll(/[.+^${}()|[\\]\\\\]/g, '\\\\$&').replaceAll('*', '.*').replaceAll('?', '.')\r\n        return new RegExp(`^${escaped}$`)\r\n    }\r\n\r\n    dispose(): void {\r\n        // Kill all running executions\r\n        for (const [executionId, execution] of Array.from(this.executions)) {\r\n            if (execution.status === 'running') {\r\n                try {\r\n                    execution.process.kill()\r\n                } catch (error) {\r\n                    console.error(`[TaskRunner] Error disposing execution ${executionId}:`, error)\r\n                }\r\n            }\r\n        }\r\n\r\n        this.executions.clear()\r\n        this.detectedTasks.clear()\r\n        this.taskProviders.clear()\r\n        this.removeAllListeners()\r\n    }\r\n}","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\electron\\terminal\\terminalManager.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":19,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":19,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[459,462],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[459,462],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":65,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":65,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1728,1731],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1728,1731],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":261,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":261,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[7713,7788],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":282,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":282,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[8512,8588],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":298,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":298,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[9033,9097],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":317,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":317,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[9645,9723],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":344,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":344,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[10561,10626],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n// main-process/terminalManager.ts\r\nimport { EventEmitter } from 'events'\r\nimport fs from 'fs'\r\nimport path from 'path'\r\n\r\nexport interface TerminalSession {\r\n    id: string\r\n    title: string\r\n    shell: string\r\n    cwd: string\r\n    env: { [key: string]: string }\r\n    cols: number\r\n    rows: number\r\n    status: 'running' | 'stopped' | 'paused'\r\n    processType: 'shell' | 'task' | 'debug'\r\n    metadata: any\r\n    createdAt: number\r\n    lastActive: number\r\n    history: string[]\r\n    commandHistory: Array<{\r\n        command: string\r\n        timestamp: number\r\n        exitCode?: number\r\n    }>\r\n}\r\n\r\nexport interface SessionGroup {\r\n    id: string\r\n    name: string\r\n    sessionIds: string[]\r\n    layout?: 'horizontal' | 'vertical' | 'grid'\r\n    createdAt: number\r\n}\r\n\r\nexport class TerminalSessionManager extends EventEmitter {\r\n    private sessions = new Map<string, TerminalSession>()\r\n    private groups = new Map<string, SessionGroup>()\r\n    private sessionStoragePath: string\r\n\r\n    constructor(storagePath?: string) {\r\n        super()\r\n        this.sessionStoragePath = storagePath || path.join(process.cwd(), '.kalynt', 'sessions')\r\n\r\n        // Ensure storage directory exists\r\n        if (!fs.existsSync(this.sessionStoragePath)) {\r\n            fs.mkdirSync(this.sessionStoragePath, { recursive: true })\r\n        }\r\n\r\n        // Load saved sessions\r\n        this.loadSessions()\r\n    }\r\n\r\n    createSession(options: {\r\n        id?: string\r\n        title?: string\r\n        shell: string\r\n        cwd: string\r\n        env?: { [key: string]: string }\r\n        cols?: number\r\n        rows?: number\r\n        processType?: 'shell' | 'task' | 'debug'\r\n        metadata?: any\r\n    }): TerminalSession {\r\n        const sessionId = options.id || `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\r\n        const now = Date.now()\r\n\r\n        const session: TerminalSession = {\r\n            id: sessionId,\r\n            title: options.title || `Terminal ${sessionId}`,\r\n            shell: options.shell,\r\n            cwd: options.cwd,\r\n            env: options.env || {},\r\n            cols: options.cols || 80,\r\n            rows: options.rows || 24,\r\n            status: 'running',\r\n            processType: options.processType || 'shell',\r\n            metadata: options.metadata || {},\r\n            createdAt: now,\r\n            lastActive: now,\r\n            history: [],\r\n            commandHistory: []\r\n        }\r\n\r\n        this.sessions.set(sessionId, session)\r\n        this.emit('session_created', session)\r\n\r\n        // Auto-save session\r\n        this.saveSession(sessionId)\r\n\r\n        return session\r\n    }\r\n\r\n    getSession(sessionId: string): TerminalSession | undefined {\r\n        return this.sessions.get(sessionId)\r\n    }\r\n\r\n    updateSession(sessionId: string, updates: Partial<TerminalSession>): boolean {\r\n        const session = this.sessions.get(sessionId)\r\n        if (!session) return false\r\n\r\n        Object.assign(session, updates)\r\n        session.lastActive = Date.now()\r\n\r\n        this.emit('session_updated', { sessionId, updates })\r\n        this.saveSession(sessionId)\r\n\r\n        return true\r\n    }\r\n\r\n    addToSessionHistory(sessionId: string, data: string): boolean {\r\n        const session = this.sessions.get(sessionId)\r\n        if (!session) return false\r\n\r\n        session.history.push(data)\r\n        session.lastActive = Date.now()\r\n\r\n        // Limit history size\r\n        if (session.history.length > 10000) {\r\n            session.history = session.history.slice(-10000)\r\n        }\r\n\r\n        return true\r\n    }\r\n\r\n    addToCommandHistory(sessionId: string, command: string, exitCode?: number): boolean {\r\n        const session = this.sessions.get(sessionId)\r\n        if (!session) return false\r\n\r\n        session.commandHistory.push({\r\n            command,\r\n            timestamp: Date.now(),\r\n            exitCode\r\n        })\r\n\r\n        // Limit command history size\r\n        if (session.commandHistory.length > 1000) {\r\n            session.commandHistory = session.commandHistory.slice(-1000)\r\n        }\r\n\r\n        this.saveSession(sessionId)\r\n        return true\r\n    }\r\n\r\n    pauseSession(sessionId: string): boolean {\r\n        return this.updateSession(sessionId, { status: 'paused' })\r\n    }\r\n\r\n    resumeSession(sessionId: string): boolean {\r\n        return this.updateSession(sessionId, { status: 'running' })\r\n    }\r\n\r\n    stopSession(sessionId: string): boolean {\r\n        return this.updateSession(sessionId, { status: 'stopped' })\r\n    }\r\n\r\n    deleteSession(sessionId: string): boolean {\r\n        const session = this.sessions.get(sessionId)\r\n        if (!session) return false\r\n\r\n        this.sessions.delete(sessionId)\r\n        this.emit('session_deleted', sessionId)\r\n\r\n        // Delete session file\r\n        const sessionFile = path.join(this.sessionStoragePath, `${sessionId}.json`)\r\n        if (fs.existsSync(sessionFile)) {\r\n            fs.unlinkSync(sessionFile)\r\n        }\r\n\r\n        return true\r\n    }\r\n\r\n    getAllSessions(): TerminalSession[] {\r\n        return Array.from(this.sessions.values())\r\n    }\r\n\r\n    getActiveSessions(): TerminalSession[] {\r\n        return this.getAllSessions().filter(s => s.status === 'running')\r\n    }\r\n\r\n    createGroup(name: string, sessionIds: string[], layout?: 'horizontal' | 'vertical' | 'grid'): SessionGroup {\r\n        const groupId = `group_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\r\n\r\n        const group: SessionGroup = {\r\n            id: groupId,\r\n            name,\r\n            sessionIds,\r\n            layout,\r\n            createdAt: Date.now()\r\n        }\r\n\r\n        this.groups.set(groupId, group)\r\n        this.emit('group_created', group)\r\n\r\n        return group\r\n    }\r\n\r\n    addToGroup(groupId: string, sessionId: string): boolean {\r\n        const group = this.groups.get(groupId)\r\n        if (!group) return false\r\n\r\n        if (!group.sessionIds.includes(sessionId)) {\r\n            group.sessionIds.push(sessionId)\r\n            this.emit('group_updated', { groupId, sessionId, action: 'added' })\r\n            return true\r\n        }\r\n\r\n        return false\r\n    }\r\n\r\n    removeFromGroup(groupId: string, sessionId: string): boolean {\r\n        const group = this.groups.get(groupId)\r\n        if (!group) return false\r\n\r\n        const index = group.sessionIds.indexOf(sessionId)\r\n        if (index !== -1) {\r\n            group.sessionIds.splice(index, 1)\r\n            this.emit('group_updated', { groupId, sessionId, action: 'removed' })\r\n            return true\r\n        }\r\n\r\n        return false\r\n    }\r\n\r\n    getGroup(groupId: string): SessionGroup | undefined {\r\n        return this.groups.get(groupId)\r\n    }\r\n\r\n    getAllGroups(): SessionGroup[] {\r\n        return Array.from(this.groups.values())\r\n    }\r\n\r\n    deleteGroup(groupId: string): boolean {\r\n        const group = this.groups.get(groupId)\r\n        if (!group) return false\r\n\r\n        this.groups.delete(groupId)\r\n        this.emit('group_deleted', groupId)\r\n\r\n        return true\r\n    }\r\n\r\n    saveSession(sessionId: string): boolean {\r\n        const session = this.sessions.get(sessionId)\r\n        if (!session) return false\r\n\r\n        try {\r\n            const sessionFile = path.join(this.sessionStoragePath, `${sessionId}.json`)\r\n            const sessionData = {\r\n                ...session,\r\n                // Don't save full history to disk to avoid large files\r\n                history: [],\r\n                commandHistory: session.commandHistory.slice(-100) // Keep last 100 commands\r\n            }\r\n\r\n            fs.writeFileSync(sessionFile, JSON.stringify(sessionData, null, 2))\r\n            return true\r\n        } catch (error) {\r\n            console.error(`[SessionManager] Error saving session ${sessionId}:`, error)\r\n            return false\r\n        }\r\n    }\r\n\r\n    loadSession(sessionId: string): TerminalSession | null {\r\n        try {\r\n            const sessionFile = path.join(this.sessionStoragePath, `${sessionId}.json`)\r\n            if (!fs.existsSync(sessionFile)) return null\r\n\r\n            const sessionData = JSON.parse(fs.readFileSync(sessionFile, 'utf8'))\r\n            const session: TerminalSession = {\r\n                ...sessionData,\r\n                status: 'stopped', // Sessions are stopped when loaded from disk\r\n                history: [],\r\n                lastActive: Date.now()\r\n            }\r\n\r\n            this.sessions.set(sessionId, session)\r\n            return session\r\n        } catch (error) {\r\n            console.error(`[SessionManager] Error loading session ${sessionId}:`, error)\r\n            return null\r\n        }\r\n    }\r\n\r\n    private loadSessions(): void {\r\n        try {\r\n            const files = fs.readdirSync(this.sessionStoragePath)\r\n\r\n            for (const file of files) {\r\n                if (file.endsWith('.json')) {\r\n                    const sessionId = path.basename(file, '.json')\r\n                    this.loadSession(sessionId)\r\n                }\r\n            }\r\n        } catch (error) {\r\n            console.error('[SessionManager] Error loading sessions:', error)\r\n        }\r\n    }\r\n\r\n    exportSession(sessionId: string, exportPath: string): boolean {\r\n        const session = this.sessions.get(sessionId)\r\n        if (!session) return false\r\n\r\n        try {\r\n            const exportData = {\r\n                session,\r\n                exportDate: new Date().toISOString(),\r\n                version: '1.0.0',\r\n                app: 'Kalynt Terminal'\r\n            }\r\n\r\n            fs.writeFileSync(exportPath, JSON.stringify(exportData, null, 2))\r\n            return true\r\n        } catch (error) {\r\n            console.error(`[SessionManager] Error exporting session ${sessionId}:`, error)\r\n            return false\r\n        }\r\n    }\r\n\r\n    importSession(importPath: string): string | null {\r\n        try {\r\n            if (!fs.existsSync(importPath)) return null\r\n\r\n            const importData = JSON.parse(fs.readFileSync(importPath, 'utf8'))\r\n\r\n            if (importData.app !== 'Kalynt Terminal') {\r\n                throw new Error('Invalid session file format')\r\n            }\r\n\r\n            const session = importData.session as TerminalSession\r\n            const newSessionId = `imported_${Date.now()}_${session.id}`\r\n\r\n            session.id = newSessionId\r\n            session.status = 'stopped'\r\n            session.lastActive = Date.now()\r\n\r\n            this.sessions.set(newSessionId, session)\r\n            this.saveSession(newSessionId)\r\n\r\n            return newSessionId\r\n        } catch (error) {\r\n            console.error('[SessionManager] Error importing session:', error)\r\n            return null\r\n        }\r\n    }\r\n\r\n    clearOldSessions(maxAgeHours: number = 24): number {\r\n        const cutoff = Date.now() - (maxAgeHours * 60 * 60 * 1000)\r\n        let count = 0\r\n\r\n        for (const [sessionId, session] of this.sessions) {\r\n            if (session.lastActive < cutoff && session.status === 'stopped') {\r\n                this.deleteSession(sessionId)\r\n                count++\r\n            }\r\n        }\r\n\r\n        return count\r\n    }\r\n\r\n    getSessionStats() {\r\n        const sessions = this.getAllSessions()\r\n\r\n        return {\r\n            total: sessions.length,\r\n            running: sessions.filter(s => s.status === 'running').length,\r\n            stopped: sessions.filter(s => s.status === 'stopped').length,\r\n            paused: sessions.filter(s => s.status === 'paused').length,\r\n            byShell: sessions.reduce((acc, session) => {\r\n                acc[session.shell] = (acc[session.shell] || 0) + 1\r\n                return acc\r\n            }, {} as Record<string, number>),\r\n            byType: sessions.reduce((acc, session) => {\r\n                acc[session.processType] = (acc[session.processType] || 0) + 1\r\n                return acc\r\n            }, {} as Record<string, number>)\r\n        }\r\n    }\r\n\r\n    dispose(): void {\r\n        // Save all sessions before disposing\r\n        for (const sessionId of this.sessions.keys()) {\r\n            this.saveSession(sessionId)\r\n        }\r\n\r\n        this.sessions.clear()\r\n        this.groups.clear()\r\n        this.removeAllListeners()\r\n    }\r\n}","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\electron\\terminal\\terminalService.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'languageConfigs' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":55,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":55,"endColumn":30},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":125,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":125,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4455,4458],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4455,4458],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":152,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":152,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[5446,5493],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":159,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":159,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[5717,5768],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'programFilesX86' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":169,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":169,"endColumn":38},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":231,"column":28,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":231,"endColumn":41},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":233,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":233,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[9019,9083],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":234,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":234,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[9101,9173],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":238,"column":25,"nodeType":"MemberExpression","messageId":"unexpected","endLine":238,"endColumn":36,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[9355,9401],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":242,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":242,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[9524,9606],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":255,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":255,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[10056,10151],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":298,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":298,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[11690,11769],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":301,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":301,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[11869,11916],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":436,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":436,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[15993,16051],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":446,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":446,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16311,16314],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16311,16314],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":451,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":451,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[16465,16521],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":463,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":463,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16890,16893],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16890,16893],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":470,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":470,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[17097,17155],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":489,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":489,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17724,17727],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17724,17727],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":490,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":490,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17768,17771],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17768,17771],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":554,"column":78,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":554,"endColumn":81,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19825,19828],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19825,19828],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":580,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":580,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20636,20639],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20636,20639],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":626,"column":24,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":626,"endColumn":37},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":657,"column":20,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":657,"endColumn":33},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":673,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":673,"endColumn":30,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[23762,23826],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":20,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n// main-process/terminal.ts\r\nimport * as pty from 'node-pty'\r\nimport type { BrowserWindow } from 'electron'\r\nimport { EventEmitter } from 'node:events'\r\nimport { ShellIntegrationService } from './shellIntegration'\r\nimport { LanguageRuntimeGateway } from './languageGateway'\r\nimport { TaskRunnerService } from './taskRunner'\r\nimport { TerminalSessionManager } from './terminalManager'\r\n\r\n// Enhanced terminal interface\r\nexport interface KalyntTerminal extends pty.IPty {\r\n    id: string\r\n    title: string\r\n    shell: string\r\n    cwd: string\r\n    env: { [key: string]: string }\r\n    status: 'running' | 'stopped' | 'error'\r\n    lastExitCode?: number\r\n    processType?: 'shell' | 'task' | 'debug'\r\n    metadata?: {\r\n        languageId?: string\r\n        taskId?: string\r\n        debugSessionId?: string\r\n        projectType?: string\r\n    }\r\n}\r\n\r\nexport class TerminalService extends EventEmitter {\r\n    public terminals = new Map<string, KalyntTerminal>()\r\n    public shellIntegration: ShellIntegrationService\r\n    public languageGateway: LanguageRuntimeGateway\r\n    public taskRunner: TaskRunnerService\r\n    public sessionManager: TerminalSessionManager\r\n    private terminalHistory = new Map<string, string[]>()\r\n    private maxHistorySize = 10000\r\n\r\n    constructor(\r\n        private getMainWindow: () => BrowserWindow | null,\r\n        private getWorkspacePath: () => string | null\r\n    ) {\r\n        super()\r\n        this.shellIntegration = new ShellIntegrationService()\r\n        this.languageGateway = new LanguageRuntimeGateway()\r\n        this.taskRunner = new TaskRunnerService()\r\n        this.sessionManager = new TerminalSessionManager()\r\n\r\n        this.setupLanguageServers()\r\n    }\r\n\r\n    private setupLanguageServers() {\r\n        // Configure 40+ language servers\r\n        const languageConfigs = {\r\n            python: {\r\n                lsp: 'pylsp',\r\n                debug: 'debugpy',\r\n                run: 'python',\r\n                extensions: ['.py', '.pyw'],\r\n                test: 'pytest'\r\n            },\r\n            javascript: {\r\n                lsp: 'typescript-language-server',\r\n                debug: 'node',\r\n                run: 'node',\r\n                extensions: ['.js', '.jsx', '.ts', '.tsx'],\r\n                test: 'jest'\r\n            },\r\n            rust: {\r\n                lsp: 'rust-analyzer',\r\n                debug: 'lldb',\r\n                run: 'cargo run',\r\n                extensions: ['.rs'],\r\n                test: 'cargo test'\r\n            },\r\n            go: {\r\n                lsp: 'gopls',\r\n                debug: 'dlv',\r\n                run: 'go run',\r\n                extensions: ['.go'],\r\n                test: 'go test'\r\n            },\r\n            java: {\r\n                lsp: 'jdtls',\r\n                debug: 'java-debug',\r\n                run: 'mvn exec:java',\r\n                extensions: ['.java'],\r\n                test: 'mvn test'\r\n            },\r\n            cpp: {\r\n                lsp: 'clangd',\r\n                debug: 'lldb',\r\n                run: 'make run',\r\n                extensions: ['.cpp', '.hpp', '.c', '.h'],\r\n                test: 'make test'\r\n            },\r\n            // Add 35+ more languages...\r\n            ruby: { lsp: 'solargraph', debug: 'rdbg', run: 'ruby' },\r\n            php: { lsp: 'intelephense', debug: 'xdebug', run: 'php' },\r\n            csharp: { lsp: 'omnisharp', debug: 'netcoredbg', run: 'dotnet run' },\r\n            kotlin: { lsp: 'kotlin-language-server', debug: 'kotlin-debug-adapter' },\r\n            swift: { lsp: 'sourcekit-lsp', debug: 'lldb' },\r\n            haskell: { lsp: 'haskell-language-server', debug: 'haskell-debug-adapter' },\r\n            scala: { lsp: 'metals', debug: 'scala-debug-adapter' },\r\n            dart: { lsp: 'dart', debug: 'dart-debug-adapter' },\r\n            elixir: { lsp: 'elixir-ls', debug: 'elixir-debugger' },\r\n            clojure: { lsp: 'clojure-lsp', debug: 'clojure-debug-adapter' },\r\n            // ... continue for 40+ languages\r\n        }\r\n\r\n        // Note: Language gateway has internal configurations\r\n        // Additional language configs can be added here if needed\r\n    }\r\n\r\n    async spawnTerminal(options: {\r\n        id: string\r\n        shell?: string\r\n        cwd?: string\r\n        cols?: number\r\n        rows?: number\r\n        env?: { [key: string]: string }\r\n        title?: string\r\n        processType?: 'shell' | 'task' | 'debug'\r\n        metadata?: any\r\n    }): Promise<{ success: boolean; pid?: number; error?: string }> {\r\n        try {\r\n            const mainWindow = this.getMainWindow()\r\n\r\n            // Check if terminal already exists\r\n            if (this.terminals.has(options.id)) {\r\n                const terminal = this.terminals.get(options.id)!\r\n                mainWindow?.webContents.send('terminal:restored', {\r\n                    id: options.id,\r\n                    pid: terminal.pid,\r\n                    title: terminal.title\r\n                })\r\n                return { success: true, pid: terminal.pid }\r\n            }\r\n\r\n            // Determine shell with proper validation\r\n            let shell = options.shell?.trim() || ''\r\n            if (!shell) {\r\n                shell = this.getDefaultShell()\r\n            }\r\n\r\n            // Final validation - ensure we have a shell\r\n            if (!shell) {\r\n                shell = process.platform === 'win32' ? 'cmd.exe' : '/bin/sh'\r\n            }\r\n\r\n            console.log(`[Terminal] Using shell: ${shell}`)\r\n\r\n            // Determine working directory\r\n            const cwd = options.cwd || this.getWorkspacePath() ||\r\n                process.env.HOME || process.env.USERPROFILE ||\r\n                process.cwd()\r\n\r\n            console.log(`[Terminal] Working directory: ${cwd}`)\r\n\r\n            // Merge environment variables\r\n            // On Windows, Electron may not inherit user PATH fully when launched from shortcuts\r\n            // We need to explicitly add common install paths\r\n            let enhancedPath = process.env.PATH || ''\r\n\r\n            if (process.platform === 'win32') {\r\n                const userProfile = process.env.USERPROFILE || 'C:\\\\Users\\\\Default'\r\n                const programFiles = process.env.ProgramFiles || 'C:\\\\Program Files'\r\n                const programFilesX86 = process.env['ProgramFiles(x86)'] || 'C:\\\\Program Files (x86)'\r\n                const localAppData = process.env.LOCALAPPDATA || `${userProfile}\\\\AppData\\\\Local`\r\n                const appData = process.env.APPDATA || `${userProfile}\\\\AppData\\\\Roaming`\r\n\r\n                // Common paths for user-installed development tools\r\n                const additionalPaths = [\r\n                    // Python\r\n                    `${localAppData}\\\\Programs\\\\Python\\\\Python312`,\r\n                    `${localAppData}\\\\Programs\\\\Python\\\\Python312\\\\Scripts`,\r\n                    `${localAppData}\\\\Programs\\\\Python\\\\Python311`,\r\n                    `${localAppData}\\\\Programs\\\\Python\\\\Python311\\\\Scripts`,\r\n                    `${localAppData}\\\\Programs\\\\Python\\\\Python310`,\r\n                    `${localAppData}\\\\Programs\\\\Python\\\\Python310\\\\Scripts`,\r\n                    `${appData}\\\\Python\\\\Python312\\\\Scripts`,\r\n                    `${programFiles}\\\\Python312`,\r\n                    `${programFiles}\\\\Python311`,\r\n                    `${programFiles}\\\\Python310`,\r\n\r\n                    // Rust / Cargo\r\n                    `${userProfile}\\\\.cargo\\\\bin`,\r\n\r\n                    // Node.js / npm\r\n                    `${programFiles}\\\\nodejs`,\r\n                    `${appData}\\\\npm`,\r\n                    `${localAppData}\\\\fnm_multishells`,\r\n\r\n                    // Java\r\n                    `${programFiles}\\\\Java\\\\jdk-21\\\\bin`,\r\n                    `${programFiles}\\\\Eclipse Adoptium\\\\jdk-21\\\\bin`,\r\n                    `${programFiles}\\\\Microsoft\\\\jdk-17\\\\bin`,\r\n\r\n                    // Go\r\n                    `${userProfile}\\\\go\\\\bin`,\r\n                    `${programFiles}\\\\Go\\\\bin`,\r\n\r\n                    // Ruby\r\n                    `${programFiles}\\\\Ruby32-x64\\\\bin`,\r\n                    `${programFiles}\\\\Ruby31-x64\\\\bin`,\r\n\r\n                    // .NET\r\n                    `${programFiles}\\\\dotnet`,\r\n                    `${userProfile}\\\\.dotnet\\\\tools`,\r\n\r\n                    // Scoop\r\n                    `${userProfile}\\\\scoop\\\\shims`,\r\n\r\n                    // Chocolatey\r\n                    `${programFiles}\\\\chocolatey\\\\bin`,\r\n\r\n                    // Git\r\n                    `${programFiles}\\\\Git\\\\cmd`,\r\n                    `${programFiles}\\\\Git\\\\bin`,\r\n\r\n                    // Visual Studio Code\r\n                    `${localAppData}\\\\Programs\\\\Microsoft VS Code\\\\bin`,\r\n\r\n                    // Common local bin directories\r\n                    `${userProfile}\\\\.local\\\\bin`,\r\n                    `${userProfile}\\\\bin`\r\n                ]\r\n\r\n                // Add paths that exist\r\n                const fs = require('fs')\r\n                const cargoPath = `${userProfile}\\\\.cargo\\\\bin`\r\n                console.log(`[Terminal] Checking Rust/Cargo path: ${cargoPath}`)\r\n                console.log(`[Terminal] Cargo path exists: ${fs.existsSync(cargoPath)}`)\r\n\r\n                for (const p of additionalPaths) {\r\n                    if (fs.existsSync(p) && !enhancedPath.toLowerCase().includes(p.toLowerCase())) {\r\n                        console.log(`[Terminal] Adding to PATH: ${p}`)\r\n                        enhancedPath = `${p};${enhancedPath}`\r\n                    }\r\n                }\r\n                console.log(`[Terminal] Final enhanced PATH length: ${enhancedPath.length} chars`)\r\n            }\r\n\r\n            const env = {\r\n                ...process.env,\r\n                ...options.env,\r\n                PATH: enhancedPath,\r\n                TERM: 'xterm-256color',\r\n                COLORTERM: 'truecolor',\r\n                KALYNT_TERMINAL: '1',\r\n                KALYNT_TERMINAL_ID: options.id,\r\n                LANG: process.platform === 'win32' ? 'en_US.UTF-8' : process.env.LANG || 'en_US.UTF-8'\r\n            }\r\n            console.log(`[Terminal] Environment PATH includes .cargo: ${env.PATH.includes('.cargo\\\\bin')}`)\r\n\r\n            // Spawn PTY process\r\n            const ptyProcess = pty.spawn(shell, [], {\r\n                name: 'xterm-256color',\r\n                cols: options.cols || 80,\r\n                rows: options.rows || 24,\r\n                cwd: cwd,\r\n                env: env,\r\n                encoding: 'utf8',\r\n                handleFlowControl: true,\r\n                useConpty: process.platform === 'win32'\r\n            }) as KalyntTerminal\r\n\r\n            // Enhance with metadata\r\n            ptyProcess.id = options.id\r\n            ptyProcess.title = options.title || `Terminal ${options.id}`\r\n            ptyProcess.shell = shell\r\n            ptyProcess.cwd = cwd\r\n            ptyProcess.env = env\r\n            ptyProcess.status = 'running'\r\n            ptyProcess.processType = options.processType || 'shell'\r\n            ptyProcess.metadata = options.metadata || {}\r\n\r\n            // Store terminal\r\n            this.terminals.set(options.id, ptyProcess)\r\n            this.terminalHistory.set(options.id, [])\r\n\r\n            // Setup shell integration\r\n            this.shellIntegration.attachToTerminal(options.id, ptyProcess, shell)\r\n\r\n            // Setup event handlers\r\n            this.setupTerminalEvents(options.id, ptyProcess)\r\n\r\n            // Notify renderer\r\n            mainWindow?.webContents.send('terminal:spawned', {\r\n                id: options.id,\r\n                pid: ptyProcess.pid,\r\n                title: ptyProcess.title,\r\n                cwd: cwd,\r\n                shell: shell\r\n            })\r\n\r\n            console.log(`[Terminal] Spawned ${shell} with PID ${ptyProcess.pid} in ${cwd}`)\r\n            return { success: true, pid: ptyProcess.pid }\r\n        } catch (error) {\r\n            console.error('[Terminal] Spawn error:', error)\r\n            return { success: false, error: String(error) }\r\n        }\r\n    }\r\n\r\n    private setupTerminalEvents(id: string, terminal: KalyntTerminal) {\r\n        terminal.onData((data) => {\r\n            this.handleTerminalData(id, data)\r\n        })\r\n\r\n        terminal.onExit(({ exitCode, signal }) => {\r\n            this.handleTerminalExit(id, exitCode, signal)\r\n        })\r\n    }\r\n\r\n    private handleTerminalData(id: string, data: string) {\r\n        const mainWindow = this.getMainWindow()\r\n\r\n        // Store in history\r\n        const history = this.terminalHistory.get(id) || []\r\n        history.push(data)\r\n        if (history.length > this.maxHistorySize) {\r\n            history.splice(0, history.length - this.maxHistorySize)\r\n        }\r\n        this.terminalHistory.set(id, history)\r\n\r\n        // Send to renderer\r\n        mainWindow?.webContents.send('terminal:data', {\r\n            id,\r\n            data,\r\n            type: 'output'\r\n        })\r\n\r\n        // Process shell integration sequences\r\n        this.shellIntegration.processData(id, data)\r\n    }\r\n\r\n    private handleTerminalExit(id: string, exitCode: number, signal?: number) {\r\n        const terminal = this.terminals.get(id)\r\n        if (!terminal) return\r\n\r\n        terminal.status = 'stopped'\r\n        terminal.lastExitCode = exitCode\r\n\r\n        const mainWindow = this.getMainWindow()\r\n        mainWindow?.webContents.send('terminal:exit', {\r\n            id,\r\n            exitCode,\r\n            signal,\r\n            title: terminal.title\r\n        })\r\n\r\n        // Clean up after delay\r\n        setTimeout(() => {\r\n            this.terminals.delete(id)\r\n            this.terminalHistory.delete(id)\r\n        }, 30000) // Keep metadata for 30 seconds\r\n    }\r\n\r\n    async executeTask(options: {\r\n        id: string\r\n        command: string\r\n        cwd?: string\r\n        shell?: string\r\n        env?: { [key: string]: string }\r\n        languageId?: string\r\n        taskType?: 'build' | 'test' | 'run' | 'debug'\r\n    }): Promise<{ success: boolean; pid?: number; error?: string }> {\r\n        // Create a task definition from the options\r\n        const task = {\r\n            id: options.id,\r\n            label: options.command,\r\n            type: 'shell' as const,\r\n            command: options.command,\r\n            cwd: options.cwd,\r\n            env: options.env,\r\n            group: options.taskType\r\n        }\r\n\r\n        return this.taskRunner.executeTask({\r\n            id: options.id,\r\n            task,\r\n            terminalService: this,\r\n            getMainWindow: this.getMainWindow\r\n        })\r\n    }\r\n\r\n    async startDebugSession(options: {\r\n        sessionId: string\r\n        languageId: string\r\n        program: string\r\n        args?: string[]\r\n        cwd?: string\r\n        stopOnEntry?: boolean\r\n    }): Promise<{ success: boolean; port?: number; error?: string }> {\r\n        return this.languageGateway.startDebugSession(options)\r\n    }\r\n\r\n    async loadLanguageServer(options: {\r\n        languageId: string\r\n        workspacePath: string\r\n        rootUri?: string\r\n    }): Promise<{ success: boolean; sessionId?: string; error?: string }> {\r\n        return this.languageGateway.loadLanguageServer(options)\r\n    }\r\n\r\n    // Getters and utility methods\r\n    getTerminal(id: string): KalyntTerminal | undefined {\r\n        return this.terminals.get(id)\r\n    }\r\n\r\n    getAllTerminals(): KalyntTerminal[] {\r\n        return Array.from(this.terminals.values())\r\n    }\r\n\r\n    getTerminalHistory(id: string): string[] {\r\n        return this.terminalHistory.get(id) || []\r\n    }\r\n\r\n    async writeToTerminal(id: string, data: string): Promise<boolean> {\r\n        const terminal = this.terminals.get(id)\r\n        if (!terminal) return false\r\n\r\n        terminal.write(data)\r\n        return true\r\n    }\r\n\r\n    async resizeTerminal(id: string, cols: number, rows: number): Promise<boolean> {\r\n        const terminal = this.terminals.get(id)\r\n        if (!terminal) return false\r\n\r\n        try {\r\n            terminal.resize(cols, rows)\r\n            return true\r\n        } catch (error) {\r\n            console.error(`[Terminal] Resize error for ${id}:`, error)\r\n            return false\r\n        }\r\n    }\r\n\r\n    async killTerminal(id: string, signal?: string): Promise<boolean> {\r\n        const terminal = this.terminals.get(id)\r\n        if (!terminal) return false\r\n\r\n        try {\r\n            terminal.kill(signal as any)\r\n            this.terminals.delete(id)\r\n            this.terminalHistory.delete(id)\r\n            return true\r\n        } catch (error) {\r\n            console.error(`[Terminal] Kill error for ${id}:`, error)\r\n            return false\r\n        }\r\n    }\r\n\r\n    async sendSignal(id: string, signal: string): Promise<boolean> {\r\n        const terminal = this.terminals.get(id)\r\n        if (!terminal) return false\r\n\r\n        try {\r\n            // On Unix systems, send signals\r\n            if (process.platform !== 'win32') {\r\n                process.kill(terminal.pid, signal as any)\r\n            } else {\r\n                // Windows doesn't support signals well, use kill\r\n                terminal.kill()\r\n            }\r\n            return true\r\n        } catch (error) {\r\n            console.error(`[Terminal] Signal error for ${id}:`, error)\r\n            return false\r\n        }\r\n    }\r\n\r\n    async getTerminalInfo(id: string) {\r\n        const terminal = this.terminals.get(id)\r\n        if (!terminal) return null\r\n\r\n        return {\r\n            id: terminal.id,\r\n            pid: terminal.pid,\r\n            title: terminal.title,\r\n            shell: terminal.shell,\r\n            cwd: terminal.cwd,\r\n            status: terminal.status,\r\n            lastExitCode: terminal.lastExitCode,\r\n            processType: terminal.processType,\r\n            metadata: terminal.metadata,\r\n            cols: (terminal as any)._cols,\r\n            rows: (terminal as any)._rows\r\n        }\r\n    }\r\n\r\n    async clearTerminalHistory(id: string): Promise<boolean> {\r\n        if (!this.terminalHistory.has(id)) return false\r\n\r\n        this.terminalHistory.set(id, [])\r\n        return true\r\n    }\r\n\r\n    async forkTerminal(sourceId: string, newId: string): Promise<boolean> {\r\n        const source = this.terminals.get(sourceId)\r\n        if (!source) return false\r\n\r\n        // Create a new terminal with same configuration\r\n        return (await this.spawnTerminal({\r\n            id: newId,\r\n            shell: source.shell,\r\n            cwd: source.cwd,\r\n            env: source.env,\r\n            title: `Fork of ${source.title}`,\r\n            processType: source.processType,\r\n            metadata: { ...source.metadata, forkedFrom: sourceId }\r\n        })).success\r\n    }\r\n\r\n    async sendTerminalSequence(id: string, sequence: string): Promise<boolean> {\r\n        const terminal = this.terminals.get(id)\r\n        if (!terminal) return false\r\n\r\n        // Handle special sequences\r\n        switch (sequence) {\r\n            case 'break':\r\n                terminal.write('\\x03') // Ctrl+C\r\n                break\r\n            case 'suspend':\r\n                terminal.write('\\x1a') // Ctrl+Z\r\n                break\r\n            case 'clear':\r\n                terminal.write('\\x1b[H\\x1b[2J') // Clear screen\r\n                break\r\n            case 'reset':\r\n                terminal.write('\\x1bc') // Reset terminal\r\n                break\r\n            default:\r\n                terminal.write(sequence)\r\n        }\r\n\r\n        return true\r\n    }\r\n\r\n    async broadcastToTerminals(data: string, filter?: (term: KalyntTerminal) => boolean): Promise<number> {\r\n        let count = 0\r\n        for (const [_id, terminal] of Array.from(this.terminals)) {\r\n            if (!filter || filter(terminal)) {\r\n                terminal.write(data)\r\n                count++\r\n            }\r\n        }\r\n        return count\r\n    }\r\n\r\n    // Advanced terminal operations\r\n    async saveTerminalState(id: string): Promise<{ success: boolean; state?: any; error?: string }> {\r\n        const terminal = this.terminals.get(id)\r\n        if (!terminal) {\r\n            return { success: false, error: 'Terminal not found' }\r\n        }\r\n\r\n        const state = {\r\n            id: terminal.id,\r\n            pid: terminal.pid,\r\n            title: terminal.title,\r\n            shell: terminal.shell,\r\n            cwd: terminal.cwd,\r\n            env: terminal.env,\r\n            status: terminal.status,\r\n            processType: terminal.processType,\r\n            metadata: terminal.metadata,\r\n            history: this.terminalHistory.get(id),\r\n            timestamp: Date.now()\r\n        }\r\n\r\n        // Store in session manager\r\n        this.sessionManager.saveSession(state.id)\r\n\r\n        return { success: true, state }\r\n    }\r\n\r\n    async restoreTerminalState(state: any): Promise<{ success: boolean; id?: string; error?: string }> {\r\n        try {\r\n            // Create new terminal with saved state\r\n            const result = await this.spawnTerminal({\r\n                id: state.id || `restored-${Date.now()}`,\r\n                shell: state.shell,\r\n                cwd: state.cwd,\r\n                env: state.env,\r\n                title: state.title,\r\n                processType: state.processType,\r\n                metadata: state.metadata\r\n            })\r\n\r\n            if (result.success && state.history) {\r\n                // Restore history\r\n                this.terminalHistory.set(state.id, state.history)\r\n\r\n                // Send history to renderer\r\n                const mainWindow = this.getMainWindow()\r\n                mainWindow?.webContents.send('terminal:history', {\r\n                    id: state.id,\r\n                    history: state.history\r\n                })\r\n            }\r\n\r\n            return result\r\n        } catch (error) {\r\n            return { success: false, error: String(error) }\r\n        }\r\n    }\r\n\r\n    private getDefaultShell(): string {\r\n        const platform = process.platform\r\n\r\n        // Windows shell detection\r\n        if (platform === 'win32') {\r\n            const windowsShells = [\r\n                process.env.COMSPEC, // Usually C:\\Windows\\System32\\cmd.exe\r\n                'C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe',\r\n                'C:\\\\Windows\\\\System32\\\\cmd.exe',\r\n                'C:\\\\Program Files\\\\PowerShell\\\\7\\\\pwsh.exe', // PowerShell 7\r\n                'pwsh.exe', // PowerShell Core (if in PATH)\r\n                'powershell.exe', // Windows PowerShell (if in PATH)\r\n                'cmd.exe' // Fallback\r\n            ]\r\n\r\n            const fs = require('fs')\r\n            for (const shell of windowsShells) {\r\n                if (!shell) continue\r\n\r\n                // Check if it's a full path that exists\r\n                if (shell.includes('\\\\') && fs.existsSync(shell)) {\r\n                    return shell\r\n                }\r\n\r\n                // If it's just a name (like 'powershell.exe'), return it\r\n                // node-pty will search in PATH\r\n                if (!shell.includes('\\\\')) {\r\n                    return shell\r\n                }\r\n            }\r\n\r\n            return 'cmd.exe' // Ultimate fallback for Windows\r\n        }\r\n\r\n        // Unix/Linux/macOS shell detection\r\n        const shells = [\r\n            process.env.SHELL,\r\n            '/bin/zsh',\r\n            '/bin/bash',\r\n            '/usr/bin/zsh',\r\n            '/usr/bin/bash',\r\n            '/usr/local/bin/zsh',\r\n            '/usr/local/bin/bash',\r\n            '/bin/sh'\r\n        ]\r\n\r\n        const fs = require('fs')\r\n        for (const shell of shells) {\r\n            if (shell && fs.existsSync(shell)) {\r\n                return shell\r\n            }\r\n        }\r\n\r\n        return '/bin/sh'\r\n    }\r\n\r\n    // Cleanup all terminals\r\n    dispose() {\r\n        for (const [id, terminal] of Array.from(this.terminals)) {\r\n            try {\r\n                terminal.kill()\r\n            } catch (error) {\r\n                console.error(`[Terminal] Error killing terminal ${id}:`, error)\r\n            }\r\n        }\r\n\r\n        this.terminals.clear()\r\n        this.terminalHistory.clear()\r\n        this.languageGateway.dispose()\r\n        this.taskRunner.dispose()\r\n\r\n        this.removeAllListeners()\r\n    }\r\n}\r\n\r\n// Export factory function for easy initialization\r\nexport function createTerminalService(\r\n    getMainWindow: () => BrowserWindow | null,\r\n    getWorkspacePath: () => string | null\r\n): TerminalService {\r\n    return new TerminalService(getMainWindow, getWorkspacePath)\r\n}","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\electron\\utils\\pathValidator.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":57,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":57,"endColumn":21,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[1821,1888],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":66,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":66,"endColumn":21,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[2180,2284],"text":""},"desc":"Remove the console.warn()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\nimport * as path from 'node:path';\r\nimport * as fs from 'node:fs';\r\n\r\nconst FORBIDDEN_PATTERNS = [\r\n    /\\.git/i,\r\n    /\\.env/i,\r\n    /\\.ssh/i,\r\n    /\\.aws/i,\r\n    /id_rsa/i,\r\n    /\\.npmrc/i,\r\n];\r\n\r\nfunction getRealPath(normalizedRequested: string): string {\r\n    try {\r\n        if (fs.existsSync(normalizedRequested)) {\r\n            return fs.realpathSync(normalizedRequested);\r\n        }\r\n        const parentDir = path.dirname(normalizedRequested);\r\n        if (fs.existsSync(parentDir)) {\r\n            const realParent = fs.realpathSync(parentDir);\r\n            return path.join(realParent, path.basename(normalizedRequested));\r\n        }\r\n    } catch {\r\n        /* Fallback */\r\n    }\r\n    return normalizedRequested;\r\n}\r\n\r\nfunction isForbidden(normalizedPath: string): boolean {\r\n    if (normalizedPath.endsWith('.gitignore')) return false;\r\n    return FORBIDDEN_PATTERNS.some(pattern => pattern.test(normalizedPath));\r\n}\r\n\r\n/**\r\n * Validates that the requested path is safe and contained within the workspace.\r\n * Prevents path traversal attacks and symlink bypasses.\r\n * \r\n * @param workspacePath The absolute path to the workspace root\r\n * @param requestedPath The path requested by the user/agent\r\n * @returns The normalized absolute path if safe\r\n */\r\nexport function validatePath(workspacePath: string, requestedPath: string): string {\r\n    if (!workspacePath) throw new Error('Workspace path is required');\r\n    if (!requestedPath) throw new Error('Path is required');\r\n\r\n    const resolved = path.isAbsolute(requestedPath)\r\n        ? path.resolve(requestedPath)\r\n        : path.resolve(workspacePath, requestedPath);\r\n\r\n    const normW = path.normalize(workspacePath);\r\n    const normR = path.normalize(resolved);\r\n\r\n    if (isForbidden(normR)) {\r\n        console.warn(`[Security] Forbidden path access: ${requestedPath}`);\r\n        throw new Error('Access denied: Forbidden pattern');\r\n    }\r\n\r\n    const realR = getRealPath(normR);\r\n    const relative = path.relative(normW, realR);\r\n\r\n    const isSafe = relative === '' || (!relative.startsWith('..') && !path.isAbsolute(relative));\r\n    if (!isSafe) {\r\n        console.warn(`[Security] Path traversal detect: ${requestedPath} -> ${realR} outside ${workspacePath}`);\r\n        throw new Error('Access denied: Outside workspace');\r\n    }\r\n\r\n    return normR;\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\App.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\AIMESettings.tsx","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":102,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":102,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[3684,3746],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\n * Copyright 2026 Hermes Lekkas.\n * PROPRIETARY & CONFIDENTIAL.\n * \n * This file is part of the Kalynt \"Pro\" Edition.\n * Unauthorized copying, distribution, or modification of this file, \n * via any medium, is strictly prohibited.\n */\n// AIME (Artificial Intelligence Memory Management) Settings Component\n// V2.0 - Sophisticated Dashboard with Real-time Monitoring\n\nimport { useState, useEffect, useRef } from 'react'\nimport { hardwareService } from '../services/hardwareService'\nimport type { HardwareInfo, AIMEConfig, KVCacheQuantization, OffloadingStrategy } from '../types/aime'\nimport { DEFAULT_AIME_CONFIG, AIME_PRESETS, calculateAIMERAMUsage, recommendAIMESettings } from '../types/aime'\nimport {\n    Activity,\n    Brain,\n    Cpu,\n    Zap,\n    Layers,\n    Gauge,\n    Save,\n    RotateCcw,\n    Microchip\n} from 'lucide-react'\n\n// Graphics for the RAM Graph\nconst GRAPH_POINTS = 60 // 60 seconds of history\n\ninterface AIMESettingsProps {\n    readonly onSave?: (config: AIMEConfig) => void\n}\n\nexport default function AIMESettings({ onSave }: AIMESettingsProps) {\n    const [config, setConfig] = useState<AIMEConfig>(DEFAULT_AIME_CONFIG)\n    const [hardware, setHardware] = useState<HardwareInfo | null>(null)\n    const [loading, setLoading] = useState(true)\n    const [saved, setSaved] = useState(false)\n\n    // Real-time RAM Monitoring\n    const [ramHistory, setRamHistory] = useState<number[]>(new Array(GRAPH_POINTS).fill(0))\n    const [currentRam, setCurrentRam] = useState<{ total: number; used: number; free: number } | null>(null)\n    const lastUpdateRef = useRef<number>(Date.now())\n\n    // Load hardware info and existing config\n    useEffect(() => {\n        loadHardwareAndConfig()\n\n        // Start RAM monitoring\n        const cleanup = hardwareService.startRAMMonitoring((info) => {\n            const now = Date.now()\n            setCurrentRam({\n                total: info.totalRAM,\n                used: info.usedRAM,\n                free: info.availableRAM\n            })\n\n            setRamHistory(prev => {\n                const elapsedSeconds = Math.floor((now - lastUpdateRef.current) / 1000)\n                let newData = [...prev]\n\n                // BUG #38: Fill gaps if monitoring was paused/latent\n                if (elapsedSeconds > 1 && elapsedSeconds < GRAPH_POINTS) {\n                    for (let i = 0; i < elapsedSeconds - 1; i++) {\n                        newData = [...newData.slice(1), 0]\n                    }\n                } else if (elapsedSeconds >= GRAPH_POINTS) {\n                    newData = new Array(GRAPH_POINTS).fill(0)\n                }\n\n                newData = [...newData.slice(1), info.usedRAM]\n                return newData\n            })\n            lastUpdateRef.current = now\n        })\n\n        return cleanup\n    }, [])\n    async function loadHardwareAndConfig() {\n        try {\n            // BUG #39: Hardware detection timeout\n            const hwPromise = hardwareService.getHardwareInfo()\n            const timeoutPromise = new Promise<never>((_, reject) =>\n                setTimeout(() => reject(new Error('Hardware detection timeout')), 5000)\n            )\n\n            // Load hardware info\n            const hw = await Promise.race([hwPromise, timeoutPromise])\n            setHardware(hw)\n\n            // Load saved config or use defaults\n            const stored = localStorage.getItem('aime-config')\n            if (stored) {\n                setConfig(JSON.parse(stored))\n            } else {\n                // Recommend settings based on hardware\n                const recommended = recommendAIMESettings(hw)\n                setConfig(recommended)\n            }\n        } catch (error) {\n            console.error('[AIME] Failed to load hardware/config:', error)\n        } finally {\n            setLoading(false)\n        }\n    }\n\n    function handleSave() {\n        localStorage.setItem('aime-config', JSON.stringify(config))\n        setSaved(true)\n        setTimeout(() => setSaved(false), 2000)\n        onSave?.(config)\n    }\n\n    function handlePresetSelect(presetName: string) {\n        const preset = AIME_PRESETS.find(p => p.name === presetName)\n        if (preset) {\n            // BUG #40: Preset hardware validation\n            if (preset.name.includes('Maximum Quality') && hardware && hardware.totalRAM < 12288) {\n                const confirmed = globalThis.confirm(\n                    `Warning: This preset is designed for systems with 16GB+ RAM. ` +\n                    `Your system has ~${Math.round(hardware.totalRAM / 1024)}GB. ` +\n                    `Performance may be severely degraded. Continue?`\n                )\n                if (!confirmed) return\n            }\n            setConfig(preset.config)\n        }\n    }\n\n    // Calculate estimated RAM for a sample model (7B model = 7700MB)\n    const estimatedRAM = calculateAIMERAMUsage(7700, config.maxContextTokens, config.kvCacheQuantization)\n\n    if (loading) {\n        return <div className=\"p-8 text-center text-gray-500\">Initializing AIME Engine...</div>\n    }\n\n    return (\n        <div className=\"aime-dashboard\">\n            {/* Real-time RAM Graph */}\n            <div className=\"aime-graph-section\">\n                <div className=\"graph-header\">\n                    <div className=\"graph-title\">\n                        <Activity size={18} className=\"text-blue-500\" />\n                        <span>System Memory Velocity</span>\n                    </div>\n                    {currentRam && (\n                        <div className=\"live-badge\">\n                            <span className=\"live-dot\" />\n                            LIVE MONITORING\n                        </div>\n                    )}\n                </div>\n\n                <RAMUsageGraph history={ramHistory} total={hardware?.totalRAM || 16384} />\n\n                <div className=\"current-stats\">\n                    <div className=\"mini-stat\">\n                        <span className=\"label\">Total System RAM</span>\n                        <span className=\"value\">{hardware ? Math.round(hardware.totalRAM / 1024) : '-'} <span className=\"sub\">GB</span></span>\n                    </div>\n                    <div className=\"mini-stat\">\n                        <span className=\"label\">Active Usage</span>\n                        <span className=\"value\">{currentRam ? Math.round(currentRam.used / 1024) : '-'} <span className=\"sub\">GB</span></span>\n                    </div>\n                    <div className=\"mini-stat\">\n                        <span className=\"label\">Available for AI</span>\n                        <span className=\"value text-blue-400\">{currentRam ? Math.round(currentRam.free / 1024) : '-'} <span className=\"sub\">GB</span></span>\n                    </div>\n                </div>\n            </div>\n\n            {/* Bento Grid Layout */}\n            <div className=\"aime-grid\">\n                {/* Hardware Specs Card */}\n                <div className=\"bento-card\">\n                    <div className=\"bento-header\">\n                        <div className=\"bento-icon\"><Cpu size={18} /></div>\n                        <div className=\"bento-title\">\n                            <h4>Hardware Profile</h4>\n                            <p>Detected System Capabilities</p>\n                        </div>\n                    </div>\n                    <div className=\"hardware-specs\">\n                        <div className=\"spec-item\">\n                            <span className=\"spec-label\">Processor</span>\n                            <span className=\"spec-val truncate\" title={hardware?.cpuModel}>{hardware?.cpuModel || 'Unknown'}</span>\n                        </div>\n                        <div className=\"spec-item\">\n                            <span className=\"spec-label\">Cores / Threads</span>\n                            <span className=\"spec-val\">{hardware?.cpuCores} / {hardware?.cpuThreads}</span>\n                        </div>\n                        <div className={`spec-item ${hardware?.hasGPU ? 'gpu-active' : ''}`}>\n                            <span className=\"spec-label\">GPU Acceleration</span>\n                            <span className=\"spec-val\">{hardware?.hasGPU ? hardware.gpuName : 'Not Detected'}</span>\n                        </div>\n                        <div className=\"spec-item\">\n                            <span className=\"spec-label\">VRAM Capacity</span>\n                            <span className=\"spec-val\">{hardware?.totalVRAM ? `${Math.round(hardware.totalVRAM / 1024)} GB` : 'N/A'}</span>\n                        </div>\n                    </div>\n                </div>\n\n                {/* Presets Card */}\n                <div className=\"bento-card\">\n                    <div className=\"bento-header\">\n                        <div className=\"bento-icon\"><Zap size={18} /></div>\n                        <div className=\"bento-title\">\n                            <h4>Optimization Presets</h4>\n                            <p>One-click configuration</p>\n                        </div>\n                    </div>\n                    <div className=\"presets-grid\">\n                        {AIME_PRESETS.map(preset => (\n                            <div\n                                key={preset.name}\n                                className={`preset-btn ${JSON.stringify(config) === JSON.stringify(preset.config) ? 'active' : ''}`}\n                                onClick={() => handlePresetSelect(preset.name)}\n                                onKeyDown={(e) => { if (e.key === 'Enter' || e.key === ' ') handlePresetSelect(preset.name) }}\n                                tabIndex={0}\n                                role=\"button\"\n                                title={preset.description}\n                            >\n                                <Zap size={16} className={`preset-icon ${preset.name.includes('Max') ? 'text-purple-400' : 'text-blue-400'}`} />\n                                <span className=\"preset-label\">{preset.name.replace('Maximum', 'Max')}</span>\n                            </div>\n                        ))}\n                        <div className=\"preset-btn\" onClick={() => hardware && setConfig(recommendAIMESettings(hardware))} onKeyDown={(e) => { if (e.key === 'Enter' || e.key === ' ') if (hardware) setConfig(recommendAIMESettings(hardware)) }} tabIndex={0} role=\"button\">\n                            <RotateCcw size={16} className=\"preset-icon\" />\n                            <span className=\"preset-label\">Auto</span>\n                        </div>\n                    </div>\n                </div>\n\n                {/* KV Cache Quantization */}\n                <div className=\"bento-card\">\n                    <div className=\"bento-header\">\n                        <div className=\"bento-icon\"><Microchip size={18} /></div>\n                        <div className=\"bento-title\">\n                            <h4>Memory Compression</h4>\n                            <p>KV Cache Quantization (Quality vs RAM)</p>\n                        </div>\n                    </div>\n                    <div className=\"setting-group\">\n                        <div className=\"quantization-options grid grid-cols-4 gap-2\">\n                            {(['none', 'fp16', 'q8', 'q4'] as KVCacheQuantization[]).map(level => (\n                                <label key={level} className={`quantization-option ${config.kvCacheQuantization === level ? 'active' : ''}`}>\n                                    <input\n                                        type=\"radio\"\n                                        name=\"kvQuantization\"\n                                        value={level}\n                                        checked={config.kvCacheQuantization === level}\n                                        onChange={(e) => setConfig({ ...config, kvCacheQuantization: e.target.value as KVCacheQuantization })}\n                                    />\n                                    <div className=\"option-content\">\n                                        <div className=\"option-name\">{level.toUpperCase()}</div>\n                                        <div className=\"option-desc text-[10px]\">\n                                            {level === 'q4' ? '-75% RAM' : (level === 'q8' ? '-50% RAM' : 'Lossless')}\n                                        </div>\n                                    </div>\n                                </label>\n                            ))}\n                        </div>\n                    </div>\n                </div>\n\n                {/* Offloading Strategy */}\n                <div className=\"bento-card\">\n                    <div className=\"bento-header\">\n                        <div className=\"bento-icon\"><Layers size={18} /></div>\n                        <div className=\"bento-title\">\n                            <h4>GPU Offloading</h4>\n                            <p>Pipeline Distribution Strategy</p>\n                        </div>\n                    </div>\n                    <div className=\"setting-group\">\n                        <div className=\"offloading-control\">\n                            <select\n                                className=\"input\"\n                                value={config.offloadingStrategy}\n                                onChange={(e) => setConfig({ ...config, offloadingStrategy: e.target.value as OffloadingStrategy })}\n                            >\n                                <option value=\"auto\">Auto-Balance (Recommended)</option>\n                                <option value=\"gpu-only\" disabled={!hardware?.hasGPU}>GPU Only (Max Speed)</option>\n                                <option value=\"cpu-only\">CPU Only (Max Compatibility)</option>\n                                <option value=\"balanced\" disabled={!hardware?.hasGPU}>Balanced (Hybrid)</option>\n                                <option value=\"custom\">Custom Configuration</option>\n                            </select>\n                        </div>\n                        {config.offloadingStrategy === 'custom' && (\n                            <div className=\"mt-3\">\n                                <div className=\"flex justify-between text-xs text-slate-400 mb-1\">\n                                    <span>CPU Only</span>\n                                    <span>{config.gpuLayers} Layers</span>\n                                    <span>Max GPU</span>\n                                </div>\n                                <input\n                                    type=\"range\"\n                                    min=\"0\"\n                                    max=\"64\"\n                                    value={config.gpuLayers}\n                                    onChange={(e) => setConfig({ ...config, gpuLayers: Number.parseInt(e.target.value, 10) })}\n                                    className=\"slider w-full\"\n                                    disabled={!hardware?.hasGPU}\n                                />\n                            </div>\n                        )}\n                    </div>\n                </div>\n\n                {/* Context Window */}\n                <div className=\"bento-card\">\n                    <div className=\"bento-header\">\n                        <div className=\"bento-icon\"><Brain size={18} /></div>\n                        <div className=\"bento-title\">\n                            <h4>Context Window</h4>\n                            <p>Conversation Memory Limit</p>\n                        </div>\n                    </div>\n                    <div className=\"setting-group\">\n                        <div className=\"flex justify-between items-center mb-2\">\n                            <span className=\"text-2xl font-bold text-blue-400\">{config.maxContextTokens.toLocaleString()}</span>\n                            <span className=\"text-xs text-slate-500 uppercase\">Tokens</span>\n                        </div>\n                        <input\n                            type=\"range\"\n                            min=\"1024\"\n                            max=\"131072\"\n                            step=\"1024\"\n                            value={config.maxContextTokens}\n                            onChange={(e) => setConfig({ ...config, maxContextTokens: Number.parseInt(e.target.value, 10) })}\n                            className=\"slider mb-3\"\n                        />\n                        <label className=\"toggle-switch\">\n                            <span>Auto-Cap Context <span className=\"text-slate-500 text-xs\">(Safety Limit)</span></span>\n                            <input\n                                type=\"checkbox\"\n                                checked={config.autoContextCap}\n                                onChange={(e) => setConfig({ ...config, autoContextCap: e.target.checked })}\n                            />\n                            <div className=\"toggle-track\"><div className=\"toggle-thumb\"></div></div>\n                        </label>\n                    </div>\n                </div>\n\n                {/* Performance Tuning */}\n                <div className=\"bento-card\">\n                    <div className=\"bento-header\">\n                        <div className=\"bento-icon\"><Gauge size={18} /></div>\n                        <div className=\"bento-title\">\n                            <h4>Performance Tuning</h4>\n                            <p>Thread & Batch Optimization</p>\n                        </div>\n                    </div>\n                    <div className=\"grid grid-cols-2 gap-4\">\n                        <div className=\"setting-group\">\n                            <label>Threads ({config.threads})</label>\n                            <input\n                                type=\"range\"\n                                min=\"1\"\n                                max={hardware?.cpuCores || 8}\n                                value={config.threads}\n                                onChange={(e) => setConfig({ ...config, threads: Number.parseInt(e.target.value, 10) })}\n                                className=\"slider\"\n                            />\n                        </div>\n                        <div className=\"setting-group\">\n                            <label>Batch Size ({config.batchSize})</label>\n                            <input\n                                type=\"range\"\n                                min=\"128\"\n                                max=\"2048\"\n                                step=\"128\"\n                                value={config.batchSize}\n                                onChange={(e) => setConfig({ ...config, batchSize: Number.parseInt(e.target.value, 10) })}\n                                className=\"slider\"\n                            />\n                        </div>\n                    </div>\n                    <label className=\"toggle-switch mt-2\">\n                        <span>Emergency Unload Protection</span>\n                        <input\n                            type=\"checkbox\"\n                            checked={config.emergencyUnload}\n                            onChange={(e) => setConfig({ ...config, emergencyUnload: e.target.checked })}\n                        />\n                        <div className=\"toggle-track\"><div className=\"toggle-thumb\"></div></div>\n                    </label>\n                </div>\n\n                {/* Impact Analysis (Full Width) */}\n                <div className=\"bento-card full-width bg-blue-500/5 border-blue-500/20\">\n                    <div className=\"flex justify-between items-center px-2\">\n                        <div className=\"flex items-center gap-3\">\n                            <div className=\"text-blue-400 font-semibold text-sm\">ESTIMATED IMPACT (7B MODEL)</div>\n                        </div>\n                        <div className=\"flex gap-8 text-sm\">\n                            <div className=\"flex flex-col items-end\">\n                                <span className=\"text-xs text-slate-500\">RAM Required</span>\n                                <span className=\"font-mono font-bold text-blue-400\">{estimatedRAM} MB</span>\n                            </div>\n                            <div className=\"flex flex-col items-end\">\n                                <span className=\"text-xs text-slate-500\">Tokens</span>\n                                <span className=\"font-mono font-bold text-slate-300\">{config.maxContextTokens / 1024}K</span>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <div className=\"flex justify-end pt-4 border-t border-slate-700/50 mt-4\">\n                <button className=\"btn btn-primary\" onClick={handleSave}>\n                    {saved ? <span className=\"flex items-center gap-2\">âœ“ Saved</span> : <span className=\"flex items-center gap-2\"><Save size={16} /> Save Configuration</span>}\n                </button>\n            </div>\n        </div>\n    )\n}\n\n// ------------------------------------------------------------------\n// Sub-Component: RAM Usage SVG Graph\n// ------------------------------------------------------------------\n\nfunction RAMUsageGraph({ history, total }: { readonly history: number[]; readonly total: number }) {\n    if (!history.length) return null\n\n    const width = 100\n    const height = 100\n    const maxVal = total\n    const minVal = 0\n\n    // Create Path\n    const points = history.map((val, i) => {\n        const x = (i / (history.length - 1)) * width\n        const y = height - ((val - minVal) / (maxVal - minVal)) * height\n        return `${x},${y}`\n    }).join(' ')\n\n    const pathD = `M ${points}`\n    const areaD = `M 0,${height} ${points} L ${width},${height} Z`\n\n    return (\n        <div className=\"ram-graph-container\">\n            <svg className=\"ram-usage-svg\" viewBox={`0 0 ${width} ${height}`} preserveAspectRatio=\"none\">\n                <defs>\n                    <linearGradient id=\"gradient-fill\" x1=\"0\" x2=\"0\" y1=\"0\" y2=\"1\">\n                        <stop offset=\"0%\" stopColor=\"#3b82f6\" stopOpacity=\"0.5\" />\n                        <stop offset=\"100%\" stopColor=\"#3b82f6\" stopOpacity=\"0\" />\n                    </linearGradient>\n                </defs>\n\n                {/* Grid Lines */}\n                <line x1=\"0\" y1=\"25\" x2=\"100\" y2=\"25\" className=\"grid-line\" />\n                <line x1=\"0\" y1=\"50\" x2=\"100\" y2=\"50\" className=\"grid-line\" />\n                <line x1=\"0\" y1=\"75\" x2=\"100\" y2=\"75\" className=\"grid-line\" />\n\n                {/* Graph Data */}\n                <path d={areaD} className=\"graph-fill\" />\n                <path d={pathD} className=\"graph-path\" vectorEffect=\"non-scaling-stroke\" />\n            </svg>\n            <div className=\"absolute top-2 right-2 text-xs text-slate-500 font-mono\">\n                {Math.round(total / 1024)}GB MAX\n            </div>\n        </div>\n    )\n}\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\CategorySelector.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\CollaborationPanel.tsx","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":428,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":428,"endColumn":33,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[17563,17625],"text":""},"desc":"Remove the console.warn()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n// CollaborationPanel.tsx\r\n// Unified panel for Team Management, Invites, and Joining Workspaces\r\nimport { useState, useEffect } from 'react'\r\nimport { Users, Link as LinkIcon, Copy, Check, Shield, Search, X, Eye, EyeOff } from 'lucide-react'\r\nimport MemberManagement from './MemberManagement'\r\nimport { useAppStore } from '../stores/appStore'\r\nimport { p2pService } from '../services/p2pService'\r\n\r\ninterface Props {\r\n    onClose: () => void\r\n}\r\n\r\nexport default function CollaborationPanel({ onClose }: Props) {\r\n    const [activeTab, setActiveTab] = useState<'members' | 'invite' | 'join'>('invite')\r\n    const { currentSpace } = useAppStore()\r\n\r\n    if (!currentSpace) return null\r\n\r\n    return (\r\n        <div className=\"collaboration-overlay\" onClick={onClose}>\r\n            <div className=\"collaboration-panel\" onClick={e => e.stopPropagation()}>\r\n                <div className=\"panel-header\">\r\n                    <div className=\"header-title\">\r\n                        <h2><Users size={20} className=\"text-blue-400\" /> Team & Collaboration</h2>\r\n                    </div>\r\n                    <button className=\"close-btn\" onClick={onClose}><X size={20} /></button>\r\n                </div>\r\n\r\n                <div className=\"panel-tabs\">\r\n                    <button\r\n                        className={`tab-btn ${activeTab === 'members' ? 'active' : ''}`}\r\n                        onClick={() => setActiveTab('members')}\r\n                    >\r\n                        Members\r\n                    </button>\r\n                    <button\r\n                        className={`tab-btn ${activeTab === 'invite' ? 'active' : ''}`}\r\n                        onClick={() => setActiveTab('invite')}\r\n                    >\r\n                        Invite\r\n                    </button>\r\n                    <button\r\n                        className={`tab-btn ${activeTab === 'join' ? 'active' : ''}`}\r\n                        onClick={() => setActiveTab('join')}\r\n                    >\r\n                        Join Space\r\n                    </button>\r\n                </div>\r\n\r\n                <div className=\"panel-content\">\r\n                    {activeTab === 'members' && (\r\n                        <div className=\"h-full\">\r\n                            <MemberManagement spaceId={currentSpace.id} onClose={() => { }} />\r\n                        </div>\r\n                    )}\r\n                    {activeTab === 'invite' && <InviteView spaceId={currentSpace.id} />}\r\n                    {activeTab === 'join' && <JoinView onClose={onClose} />}\r\n                </div>\r\n\r\n                <style>{`\r\n                    .collaboration-overlay {\r\n                        position: fixed;\r\n                        top: 0;\r\n                        left: 0;\r\n                        right: 0;\r\n                        bottom: 0;\r\n                        background: rgba(0, 0, 0, 0.6);\r\n                        backdrop-filter: blur(4px);\r\n                        z-index: 1000;\r\n                        display: flex;\r\n                        align-items: center;\r\n                        justify-content: center;\r\n                    }\r\n\r\n                    .collaboration-panel {\r\n                        width: 900px;\r\n                        max-width: 95vw;\r\n                        height: 700px;\r\n                        max-height: 90vh;\r\n                        background: rgba(13, 13, 13, 0.9);\r\n                        backdrop-filter: blur(24px) saturate(180%);\r\n                        border: 1px solid rgba(255, 255, 255, 0.08);\r\n                        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(59, 130, 246, 0.1);\r\n                        border-radius: var(--radius-xl);\r\n                        display: flex;\r\n                        flex-direction: column;\r\n                        overflow: hidden;\r\n                        color: var(--color-text);\r\n                    }\r\n\r\n                    .panel-header {\r\n                        padding: 20px 24px;\r\n                        border-bottom: 1px solid rgba(255, 255, 255, 0.06);\r\n                        display: flex;\r\n                        justify-content: space-between;\r\n                        align-items: center;\r\n                        background: rgba(255, 255, 255, 0.02);\r\n                    }\r\n\r\n                    .header-title h2 {\r\n                        margin: 0;\r\n                        font-size: 18px;\r\n                        font-weight: 600;\r\n                        display: flex;\r\n                        align-items: center;\r\n                        gap: 12px;\r\n                        color: var(--color-text);\r\n                        text-shadow: 0 0 20px rgba(59, 130, 246, 0.3);\r\n                    }\r\n\r\n                    .close-btn {\r\n                        width: 32px;\r\n                        height: 32px;\r\n                        color: var(--color-text-muted);\r\n                        background: transparent;\r\n                        border: 1px solid rgba(255, 255, 255, 0.1);\r\n                        border-radius: 8px;\r\n                        cursor: pointer;\r\n                        display: flex;\r\n                        align-items: center;\r\n                        justify-content: center;\r\n                        transition: all 0.2s;\r\n                    }\r\n\r\n                    .close-btn:hover {\r\n                        color: white;\r\n                        background: rgba(255, 255, 255, 0.05);\r\n                        border-color: rgba(255, 255, 255, 0.2);\r\n                    }\r\n\r\n                    .panel-tabs {\r\n                        display: flex;\r\n                        padding: 12px 24px;\r\n                        background: rgba(0, 0, 0, 0.2);\r\n                        border-bottom: 1px solid rgba(255, 255, 255, 0.04);\r\n                        gap: 8px;\r\n                    }\r\n\r\n                    .tab-btn {\r\n                        padding: 8px 16px;\r\n                        background: transparent;\r\n                        border: none;\r\n                        border-radius: 100px;\r\n                        color: var(--color-text-muted);\r\n                        font-size: 13px;\r\n                        font-weight: 500;\r\n                        cursor: pointer;\r\n                        transition: all 0.2s;\r\n                    }\r\n\r\n                    .tab-btn:hover {\r\n                        color: var(--color-text);\r\n                        background: rgba(255, 255, 255, 0.04);\r\n                    }\r\n\r\n                    .tab-btn.active {\r\n                        color: white;\r\n                        background: rgba(59, 130, 246, 0.1);\r\n                        box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.3);\r\n                    }\r\n\r\n                    .panel-content {\r\n                        flex: 1;\r\n                        overflow: hidden;\r\n                        padding: 24px;\r\n                    }\r\n                `}</style>\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n\r\n// ------------------------------------------------------------------\r\n// Invite View\r\n// ------------------------------------------------------------------\r\nfunction InviteView({ spaceId }: { spaceId: string }) {\r\n    const [inviteLink, setInviteLink] = useState('')\r\n    const [roomCode, setRoomCode] = useState('')\r\n    const [copied, setCopied] = useState(false)\r\n    const [showRoomCode, setShowRoomCode] = useState(false)\r\n\r\n    const generate = async () => {\r\n        // SECURITY #9: Do not embed passwords in URLs\r\n        const link = p2pService.generateRoomLink(spaceId)\r\n        setInviteLink(link)\r\n        setRoomCode(spaceId.toUpperCase())\r\n    }\r\n\r\n    useEffect(() => {\r\n        generate()\r\n    }, [spaceId])\r\n\r\n    const copyToClipboard = async (text: string) => {\r\n        await navigator.clipboard.writeText(text)\r\n        setCopied(true)\r\n        setTimeout(() => setCopied(false), 2000)\r\n    }\r\n\r\n    return (\r\n        <div className=\"invite-container\">\r\n            <div className=\"invite-grid\">\r\n                {/* Left: Code Card */}\r\n                <div className=\"col-autocard\">\r\n                    <h3>Room Code</h3>\r\n                    <div className=\"code-card\">\r\n                        <div className=\"code-display-wrapper\">\r\n                            <div className=\"code-display\">\r\n                                {showRoomCode ? roomCode : roomCode.replace(/./g, 'â€¢')}\r\n                            </div>\r\n                            <button\r\n                                className=\"show-code-btn\"\r\n                                onClick={() => setShowRoomCode(!showRoomCode)}\r\n                                title={showRoomCode ? \"Hide Code\" : \"Show Code\"}\r\n                            >\r\n                                {showRoomCode ? <EyeOff size={16} /> : <Eye size={16} />}\r\n                            </button>\r\n                        </div>\r\n                        <p className=\"code-hint\">Share this code for quick access</p>\r\n                        <button className=\"btn btn-secondary w-full mt-4\" onClick={() => copyToClipboard(roomCode)}>\r\n                            <Copy size={16} className=\"mr-2\" /> Copy Code\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Right: Link & Config */}\r\n                <div className=\"col-main\">\r\n                    <h3>Direct Invite Link</h3>\r\n                    <div className=\"link-box\">\r\n                        <div className=\"link-input-wrapper\">\r\n                            <LinkIcon size={16} className=\"text-slate-500 ml-3\" />\r\n                            <input value={inviteLink} readOnly className=\"link-input\" />\r\n                        </div>\r\n                        <button className=\"btn btn-primary\" onClick={() => copyToClipboard(inviteLink)}>\r\n                            {copied ? <Check size={16} className=\"mr-2\" /> : <Copy size={16} className=\"mr-2\" />}\r\n                            {copied ? 'Copied!' : 'Copy Link'}\r\n                        </button>\r\n                    </div>\r\n\r\n                    <div className=\"options-panel\">\r\n                        <h4 className=\"options-title\">Security & Protocol</h4>\r\n                        <div className=\"option-row\">\r\n                            <span className=\"text-xs text-slate-400\">\r\n                                Passwords are no longer embedded in links for security.\r\n                                Share your encryption key via a secure second channel.\r\n                            </span>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            <style>{`\r\n                .invite-container {\r\n                    height: 100%;\r\n                }\r\n                .invite-grid {\r\n                    display: grid;\r\n                    grid-template-columns: 300px 1fr;\r\n                    gap: 32px;\r\n                    height: 100%;\r\n                }\r\n                .col-autocard h3, .col-main h3 {\r\n                    font-size: 13px;\r\n                    font-weight: 600;\r\n                    color: var(--color-text-secondary);\r\n                    margin: 0 0 16px 0;\r\n                    text-transform: uppercase;\r\n                    letter-spacing: 0.05em;\r\n                }\r\n                .code-card {\r\n                    background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(15, 23, 42, 0.4));\r\n                    border: 1px solid rgba(59, 130, 246, 0.2);\r\n                    padding: 32px 24px;\r\n                    border-radius: 16px;\r\n                    text-align: center;\r\n                    display: flex;\r\n                    flex-direction: column;\r\n                    align-items: center;\r\n                    justify-content: center;\r\n                    height: 240px;\r\n                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);\r\n                }\r\n                .code-display-wrapper {\r\n                    display: flex;\r\n                    align-items: center;\r\n                    gap: 12px;\r\n                    margin-bottom: 12px;\r\n                    max-width: 100%;\r\n                    width: 100%;\r\n                    justify-content: center;\r\n                }\r\n                .code-display {\r\n                    font-family: var(--font-mono);\r\n                    font-size: 28px;\r\n                    font-weight: 700;\r\n                    color: #60a5fa;\r\n                    letter-spacing: 0.1em;\r\n                    text-shadow: 0 0 20px rgba(59, 130, 246, 0.4);\r\n                    white-space: nowrap;\r\n                    overflow: hidden;\r\n                    text-overflow: ellipsis;\r\n                }\r\n                .show-code-btn {\r\n                    background: transparent;\r\n                    border: none;\r\n                    color: var(--color-text-muted);\r\n                    cursor: pointer;\r\n                    padding: 4px;\r\n                    border-radius: 4px;\r\n                    transition: all 0.2s;\r\n                    display: flex;\r\n                    align-items: center;\r\n                }\r\n                .show-code-btn:hover {\r\n                    color: white;\r\n                    background: rgba(255, 255, 255, 0.05);\r\n                }\r\n                .code-hint {\r\n                    font-size: 13px;\r\n                    color: var(--color-text-muted);\r\n                    margin: 0;\r\n                }\r\n                .link-box {\r\n                    display: flex;\r\n                    gap: 12px;\r\n                    margin-bottom: 32px;\r\n                }\r\n                .link-input-wrapper {\r\n                    flex: 1;\r\n                    display: flex;\r\n                    align-items: center;\r\n                    background: rgba(0, 0, 0, 0.3);\r\n                    border: 1px solid rgba(255, 255, 255, 0.1);\r\n                    border-radius: 8px;\r\n                    transition: border-color 0.2s;\r\n                }\r\n                .link-input-wrapper:focus-within {\r\n                    border-color: var(--color-accent);\r\n                }\r\n                .link-input {\r\n                    flex: 1;\r\n                    background: transparent;\r\n                    border: none;\r\n                    padding: 12px;\r\n                    color: var(--color-text);\r\n                    font-family: var(--font-mono);\r\n                    font-size: 13px;\r\n                    outline: none;\r\n                }\r\n                .options-panel {\r\n                    background: rgba(255, 255, 255, 0.03);\r\n                    border: 1px solid rgba(255, 255, 255, 0.06);\r\n                    border-radius: 12px;\r\n                    padding: 24px;\r\n                }\r\n                .options-title {\r\n                    margin: 0 0 20px 0;\r\n                    font-size: 14px;\r\n                    font-weight: 600;\r\n                    color: var(--color-text);\r\n                }\r\n                .option-row {\r\n                    display: flex;\r\n                    align-items: center;\r\n                    justify-content: space-between;\r\n                    margin-bottom: 16px;\r\n                    font-size: 14px;\r\n                    color: var(--color-text-secondary);\r\n                }\r\n                .checkbox-label {\r\n                    display: flex;\r\n                    align-items: center;\r\n                    gap: 10px;\r\n                    cursor: pointer;\r\n                    color: var(--color-text);\r\n                }\r\n                .checkbox-label input {\r\n                    accent-color: var(--color-accent);\r\n                }\r\n                .info-badge {\r\n                    background: rgba(16, 185, 129, 0.1);\r\n                    color: #34d399;\r\n                    font-size: 11px;\r\n                    font-weight: 500;\r\n                    padding: 4px 10px;\r\n                    border-radius: 100px;\r\n                    border: 1px solid rgba(16, 185, 129, 0.2);\r\n                }\r\n                .select-input {\r\n                    background: rgba(0, 0, 0, 0.3);\r\n                    border: 1px solid rgba(255, 255, 255, 0.1);\r\n                    color: var(--color-text);\r\n                    padding: 6px 12px;\r\n                    border-radius: 6px;\r\n                    font-size: 13px;\r\n                    outline: none;\r\n                }\r\n                .select-input:focus {\r\n                    border-color: var(--color-accent);\r\n                }\r\n            `}</style>\r\n        </div>\r\n    )\r\n}\r\n\r\n// ------------------------------------------------------------------\r\n// Join View\r\n// ------------------------------------------------------------------\r\nfunction JoinView({ onClose }: { onClose: () => void }) {\r\n    const { createSpace, setCurrentSpace, spaces } = useAppStore()\r\n    const [input, setInput] = useState('')\r\n    const [password, setPassword] = useState('')\r\n    const [error, setError] = useState('')\r\n    const [joining, setJoining] = useState(false)\r\n    const [parsedInvite, setParsedInvite] = useState<{ spaceId: string, password?: string } | null>(null)\r\n\r\n    // Listen for deep links\r\n    useEffect(() => {\r\n        const handler = (e: CustomEvent<{ url: string }>) => {\r\n            if (e.detail?.url) {\r\n                // BUG #36: Validate URL scheme\r\n                const url = e.detail.url\r\n\r\n                // Only allow kalynt:// protocol\r\n                if (!url.startsWith('kalynt://')) {\r\n                    console.warn('[Collaboration] Invalid deep link scheme:', url)\r\n                    return\r\n                }\r\n\r\n                setInput(url)\r\n                setTimeout(() => handleParse(url), 100)\r\n            }\r\n        }\r\n        window.addEventListener('kalynt-deep-link', handler as EventListener)\r\n        return () => window.removeEventListener('kalynt-deep-link', handler as EventListener)\r\n    }, [])\r\n\r\n    const handleParse = (urlOverride?: string) => {\r\n        setError('')\r\n        const text = (urlOverride || input).trim()\r\n\r\n        // BUG #36: Validate deep link schema\r\n        if (text.includes(':') && !text.startsWith('kalynt://')) {\r\n            setError('Untrusted protocol detected')\r\n            return\r\n        }\r\n\r\n        // Try parsing as link\r\n        const parsed = p2pService.parseRoomLink(text)\r\n\r\n        if (parsed) {\r\n            setParsedInvite({ spaceId: parsed.roomId, password: parsed.password })\r\n            if (parsed.password) setPassword(parsed.password)\r\n        } else if (text.length > 0 && text.length <= 50) {\r\n            // Treat as raw room code\r\n            setParsedInvite({ spaceId: text })\r\n        } else {\r\n            setError('Invalid link or code')\r\n        }\r\n    }\r\n\r\n    const handleJoin = async () => {\r\n        if (!parsedInvite || joining) return\r\n        setJoining(true)\r\n        try {\r\n            // Initialize encryption if password present\r\n            const pwdToUse = password || parsedInvite.password\r\n\r\n            const existing = spaces.find(s => s.id === parsedInvite.spaceId)\r\n            if (existing) {\r\n                setCurrentSpace(existing)\r\n            } else {\r\n                const newSpace = createSpace('Shared Space', parsedInvite.spaceId)\r\n                setCurrentSpace(newSpace)\r\n            }\r\n\r\n            if (pwdToUse) {\r\n                localStorage.setItem(`space-settings-${parsedInvite.spaceId}`, JSON.stringify({ encryptionEnabled: true, roomPassword: pwdToUse }))\r\n            }\r\n            onClose()\r\n        } catch (_e) {\r\n            setError('Failed to join')\r\n        } finally {\r\n            setJoining(false)\r\n        }\r\n    }\r\n\r\n    return (\r\n        <div className=\"join-container h-full flex flex-col items-center justify-center p-8\">\r\n            <div className=\"join-card max-w-md w-full\">\r\n                {!parsedInvite ? (\r\n                    <>\r\n                        <div className=\"text-center mb-8\">\r\n                            <div className=\"inline-flex p-4 bg-blue-500/10 rounded-full text-blue-400 mb-4 ring-1 ring-blue-500/20\">\r\n                                <Search size={32} />\r\n                            </div>\r\n                            <h3 className=\"text-xl font-semibold mb-2 text-white\">Join a Workspace</h3>\r\n                            <p className=\"text-slate-400 text-sm\">Enter an invite link or room code to connect</p>\r\n                        </div>\r\n                        <div className=\"join-form\">\r\n                            <input\r\n                                className=\"input text-lg p-4 text-center mb-4 w-full bg-black/20 border border-white/10 rounded-xl focus:border-blue-500/50 outline-none text-white transition-colors\"\r\n                                placeholder=\"Paste Link or Code...\"\r\n                                value={input}\r\n                                onChange={e => setInput(e.target.value)}\r\n                                autoFocus\r\n                            />\r\n                            {error && <div className=\"text-red-400 text-sm text-center mb-4 bg-red-500/10 p-2 rounded-lg border border-red-500/20\">{error}</div>}\r\n                            <button className=\"btn btn-primary w-full py-3 text-base font-medium\" onClick={() => handleParse()} disabled={!input.trim()}>\r\n                                Continue\r\n                            </button>\r\n                        </div>\r\n                    </>\r\n                ) : (\r\n                    <>\r\n                        <div className=\"text-center mb-8\">\r\n                            <div className=\"inline-flex p-4 bg-green-500/10 rounded-full text-green-400 mb-4 ring-1 ring-green-500/20\">\r\n                                <Shield size={32} />\r\n                            </div>\r\n                            <h3 className=\"text-xl font-semibold mb-2 text-white\">Found Workspace</h3>\r\n                            <p className=\"text-slate-400 text-sm flex items-center justify-center gap-2\">\r\n                                <span className=\"font-mono text-blue-300\">{parsedInvite.spaceId}</span>\r\n                            </p>\r\n                        </div>\r\n                        <div className=\"join-form\">\r\n                            <input\r\n                                type=\"password\"\r\n                                className=\"input text-lg p-4 text-center mb-4 w-full bg-black/20 border border-white/10 rounded-xl focus:border-blue-500/50 outline-none text-white transition-colors\"\r\n                                placeholder=\"Enter Workspace Password (if required)\"\r\n                                value={password}\r\n                                onChange={e => setPassword(e.target.value)}\r\n                                autoFocus\r\n                            />\r\n                            <button\r\n                                className=\"btn btn-primary w-full py-3 text-base font-medium\"\r\n                                onClick={async (e) => {\r\n                                    // BUG #37: Prevent double-click\r\n                                    if (joining) return\r\n                                    e.currentTarget.disabled = true  // Immediately disable\r\n                                    try {\r\n                                        await handleJoin()\r\n                                    } finally {\r\n                                        e.currentTarget.disabled = false\r\n                                    }\r\n                                }}\r\n                                disabled={joining}\r\n                            >\r\n                                {joining ? 'Joining...' : 'Confirm & Join'}\r\n                            </button>\r\n                            <button className=\"btn btn-ghost w-full mt-3 text-slate-400 hover:text-white\" onClick={() => setParsedInvite(null)}>\r\n                                Back\r\n                            </button>\r\n                        </div>\r\n                    </>\r\n                )}\r\n            </div>\r\n            <style>{`\r\n                .join-card {\r\n                    background: rgba(255, 255, 255, 0.03);\r\n                    border: 1px solid rgba(255, 255, 255, 0.08);\r\n                    border-radius: 24px;\r\n                    padding: 48px;\r\n                    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);\r\n                }\r\n            `}</style>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\Editor.tsx","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":42,"column":11,"nodeType":"MemberExpression","messageId":"unexpected","endLine":42,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"debug"},"fix":{"range":[1708,1765],"text":""},"desc":"Remove the console.debug()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":56,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":56,"endColumn":19,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[2114,2167],"text":""},"desc":"Remove the console.warn()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\nimport { useEffect, useRef, useCallback, useState } from 'react'\r\nimport { useAppStore } from '../stores/appStore'\r\nimport { useYDoc, useYText, useAwareness } from '../hooks/useYjs'\r\nimport { usePermissions } from '../hooks/usePermissions'\r\nimport { EDITOR_MODES, EditorMode, getModeConfig } from '../config/editorModes'\r\nimport UnifiedAgentPanel from './UnifiedAgentPanel'\r\nimport { EncryptionBadge } from '../hooks/useEncryption'\r\nimport WorkspaceRouter from './workspaces/WorkspaceRouter'\r\n\r\nexport default function Editor() {\r\n  const { currentSpace } = useAppStore()\r\n  const { doc, provider, synced, peerCount } = useYDoc(currentSpace?.id ?? null)\r\n  const { text, updateText } = useYText(doc, 'editor-content')\r\n  const { users, setLocalState, localClientId } = useAwareness(provider)\r\n  const { canEdit, canUseAgent } = usePermissions()\r\n\r\n  const editorRef = useRef<HTMLDivElement>(null)\r\n  const isLocalChange = useRef(false)\r\n  const [currentMode, setCurrentMode] = useState<EditorMode>('general')\r\n  const [showModeSelector, setShowModeSelector] = useState(false)\r\n  const [showAgentPanel, setShowAgentPanel] = useState(true)\r\n\r\n  const modeConfig = getModeConfig(currentMode)\r\n\r\n  // Sync content from Yjs to editor\r\n  useEffect(() => {\r\n    if (editorRef.current && !isLocalChange.current) {\r\n      const selection = window.getSelection()\r\n      const range = selection?.rangeCount ? selection.getRangeAt(0) : null\r\n\r\n      if (editorRef.current.innerText !== text) {\r\n        editorRef.current.innerText = text\r\n      }\r\n\r\n      if (range && selection) {\r\n        try {\r\n          selection.addRange(range)\r\n        } catch (e) {\r\n          console.debug('[Editor] Failed to restore selection:', e)\r\n        }\r\n      }\r\n    }\r\n    isLocalChange.current = false\r\n  }, [text])\r\n\r\n  const handleInput = useCallback((e: React.FormEvent<HTMLDivElement>) => {\r\n    // Block edits if user doesn't have permission\r\n    if (!canEdit) {\r\n      // Revert the change\r\n      if (editorRef.current) {\r\n        editorRef.current.innerText = text\r\n      }\r\n      console.warn('[Editor] Edit blocked - no permission')\r\n      return\r\n    }\r\n\r\n    isLocalChange.current = true\r\n    const newText = e.currentTarget.innerText\r\n    updateText(newText)\r\n\r\n    // Update cursor position in awareness\r\n    const selection = window.getSelection()\r\n    if (selection && selection.rangeCount > 0) {\r\n      const range = selection.getRangeAt(0)\r\n      setLocalState('cursor', {\r\n        anchor: range.startOffset,\r\n        head: range.endOffset\r\n      })\r\n    }\r\n  }, [updateText, setLocalState, canEdit, text])\r\n\r\n  const applyTemplate = () => {\r\n    if (modeConfig.template && !text.trim()) {\r\n      updateText(modeConfig.template)\r\n    } else if (modeConfig.template) {\r\n      if (confirm('Apply template? This will append to your current content.')) {\r\n        updateText(text + '\\n\\n' + modeConfig.template)\r\n      }\r\n    }\r\n  }\r\n\r\n  const getCursorInfo = () => {\r\n    const selection = window.getSelection()\r\n    if (selection && selection.rangeCount > 0) {\r\n      const textBefore = text.substring(0, selection.getRangeAt(0).startOffset)\r\n      const linesBefore = textBefore.split('\\n')\r\n      return {\r\n        line: linesBefore.length,\r\n        col: (linesBefore[linesBefore.length - 1]?.length || 0) + 1\r\n      }\r\n    }\r\n    return { line: 1, col: 1 }\r\n  }\r\n\r\n  const cursorInfo = getCursorInfo()\r\n  const wordCount = text.split(/\\s+/).filter(Boolean).length\r\n\r\n  const remoteUsers = Array.from(users.entries())\r\n    .filter(([id]) => id !== localClientId)\r\n    .map(([id, state]) => ({\r\n      id,\r\n      name: state?.user?.name || 'Anonymous',\r\n      color: state?.user?.color || '#888'\r\n    }))\r\n\r\n  if (currentSpace && currentSpace.category) {\r\n    return <WorkspaceRouter space={currentSpace} />\r\n  }\r\n\r\n  return (\r\n    <div className=\"editor-container\">\r\n      <div className=\"editor\">\r\n        <div className=\"editor-toolbar\">\r\n          {/* Mode Selector */}\r\n          <div className=\"mode-selector-container\">\r\n            <button\r\n              className=\"mode-selector-btn\"\r\n              onClick={() => setShowModeSelector(!showModeSelector)}\r\n            >\r\n              <span className=\"mode-icon\">{modeConfig.icon}</span>\r\n              <span className=\"mode-name\">{modeConfig.name}</span>\r\n              <span className=\"dropdown-arrow\">â–¾</span>\r\n            </button>\r\n\r\n            {showModeSelector && (\r\n              <div className=\"mode-dropdown\">\r\n                {EDITOR_MODES.map(mode => (\r\n                  <button\r\n                    key={mode.id}\r\n                    className={`mode-option ${currentMode === mode.id ? 'active' : ''}`}\r\n                    onClick={() => {\r\n                      setCurrentMode(mode.id)\r\n                      setShowModeSelector(false)\r\n                    }}\r\n                  >\r\n                    <span className=\"mode-icon\">{mode.icon}</span>\r\n                    <div className=\"mode-info\">\r\n                      <span className=\"mode-name\">{mode.name}</span>\r\n                      <span className=\"mode-desc\">{mode.description}</span>\r\n                    </div>\r\n                  </button>\r\n                ))}\r\n              </div>\r\n            )}\r\n          </div>\r\n\r\n          <button\r\n            className=\"toolbar-btn template-btn\"\r\n            onClick={applyTemplate}\r\n            title=\"Apply mode template\"\r\n            disabled={!modeConfig.template}\r\n          >\r\n            ðŸ“‹ Template\r\n          </button>\r\n\r\n          <div className=\"toolbar-divider\" />\r\n\r\n          <button\r\n            className={`toolbar-btn agent-toggle ${showAgentPanel ? 'active' : ''}`}\r\n            onClick={() => setShowAgentPanel(!showAgentPanel)}\r\n            title=\"Toggle AI Agent panel\"\r\n          >\r\n            ðŸ¤– Agent\r\n          </button>\r\n\r\n          <div className=\"toolbar-spacer\" />\r\n\r\n          <EncryptionBadge showDetails={false} />\r\n\r\n          <div className=\"sync-status\">\r\n            <span className={`status-dot ${peerCount > 0 ? 'status-online' : 'status-offline'}`} />\r\n            <span>\r\n              {peerCount > 0 ? `${peerCount} peer${peerCount > 1 ? 's' : ''}` : synced ? 'Saved' : 'Syncing...'}\r\n            </span>\r\n          </div>\r\n\r\n          {remoteUsers.length > 0 && (\r\n            <div className=\"remote-users\">\r\n              {remoteUsers.map(user => (\r\n                <div key={user.id} className=\"user-badge\" style={{ background: user.color }}>\r\n                  {user.name[0]}\r\n                </div>\r\n              ))}\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        <div className=\"editor-body\">\r\n          {!canEdit && (\r\n            <div className=\"permission-notice\">\r\n              ðŸ”’ View Only - You don't have permission to edit\r\n            </div>\r\n          )}\r\n\r\n          {/* Generic Text Editor Fallback */}\r\n          <div\r\n            ref={editorRef}\r\n            className={`editor-content ${!canEdit ? 'read-only' : ''}`}\r\n            contentEditable={canEdit}\r\n            suppressContentEditableWarning\r\n            onInput={handleInput}\r\n            data-placeholder={modeConfig.placeholder}\r\n          />\r\n\r\n        </div>\r\n\r\n        <div className=\"editor-footer\">\r\n          <span className=\"mode-badge\">{modeConfig.icon} {modeConfig.name}</span>\r\n          {!canEdit && <span className=\"permission-badge\">ðŸ‘ï¸ Read Only</span>}\r\n          <span>Ln {cursorInfo.line}, Col {cursorInfo.col}</span>\r\n          <span>{wordCount} {wordCount === 1 ? 'word' : 'words'}</span>\r\n        </div>\r\n      </div>\r\n\r\n      {showAgentPanel && currentSpace && canUseAgent && (\r\n        <div className=\"agent-sidebar\">\r\n          <UnifiedAgentPanel\r\n            workspacePath={null}\r\n            currentFile={null}\r\n            currentFileContent={null}\r\n            editorMode={currentMode}\r\n          />\r\n        </div>\r\n      )}\r\n\r\n      <style>{`\r\n        .editor-container {\r\n          height: 100%;\r\n          display: flex;\r\n          gap: var(--space-3);\r\n        }\r\n        \r\n        .editor {\r\n          flex: 1;\r\n          display: flex;\r\n          flex-direction: column;\r\n          background: var(--color-bg);\r\n          min-width: 0;\r\n        }\r\n        \r\n        .agent-sidebar {\r\n          width: 360px;\r\n          flex-shrink: 0;\r\n          display: flex;\r\n          flex-direction: column;\r\n          border-left: 1px solid var(--color-border-subtle);\r\n          overflow: hidden;\r\n        }\r\n        \r\n        .agent-mode-toggle {\r\n          display: flex;\r\n          padding: var(--space-2);\r\n          gap: var(--space-1);\r\n          border-bottom: 1px solid var(--color-border-subtle);\r\n          background: var(--color-surface);\r\n        }\r\n        \r\n        .mode-tab {\r\n          flex: 1;\r\n          padding: var(--space-2);\r\n          font-size: var(--text-xs);\r\n          font-weight: var(--font-medium);\r\n          color: var(--color-text-muted);\r\n          background: transparent;\r\n          border-radius: var(--radius-md);\r\n          transition: all var(--transition-fast);\r\n        }\r\n        \r\n        .mode-tab:hover {\r\n          color: var(--color-text);\r\n          background: var(--color-surface-elevated);\r\n        }\r\n        \r\n        .mode-tab.active {\r\n          color: var(--color-text);\r\n          background: var(--color-surface-elevated);\r\n        }\r\n        \r\n        .editor-toolbar {\r\n          display: flex;\r\n          align-items: center;\r\n          gap: var(--space-2);\r\n          padding: var(--space-2) var(--space-4);\r\n          border-bottom: 1px solid var(--color-border-subtle);\r\n        }\r\n        \r\n        .mode-selector-container {\r\n          position: relative;\r\n        }\r\n        \r\n        .mode-selector-btn {\r\n          display: flex;\r\n          align-items: center;\r\n          gap: var(--space-2);\r\n          padding: var(--space-2) var(--space-3);\r\n          background: var(--color-surface);\r\n          border: 1px solid var(--color-border);\r\n          border-radius: var(--radius-md);\r\n          font-size: var(--text-sm);\r\n          color: var(--color-text);\r\n          transition: all var(--transition-fast);\r\n        }\r\n        \r\n        .mode-selector-btn:hover {\r\n          border-color: var(--color-border-hover);\r\n        }\r\n        \r\n        .dropdown-arrow {\r\n          font-size: 10px;\r\n          color: var(--color-text-muted);\r\n        }\r\n        \r\n        .mode-dropdown {\r\n          position: absolute;\r\n          top: 100%;\r\n          left: 0;\r\n          margin-top: var(--space-1);\r\n          width: 240px;\r\n          background: var(--color-surface);\r\n          border: 1px solid var(--color-border);\r\n          border-radius: var(--radius-lg);\r\n          padding: var(--space-2);\r\n          z-index: 100;\r\n          box-shadow: var(--shadow-lg);\r\n        }\r\n        \r\n        .mode-option {\r\n          width: 100%;\r\n          display: flex;\r\n          align-items: center;\r\n          gap: var(--space-2);\r\n          padding: var(--space-2);\r\n          border-radius: var(--radius-md);\r\n          transition: background var(--transition-fast);\r\n        }\r\n        \r\n        .mode-option:hover {\r\n          background: var(--color-surface-elevated);\r\n        }\r\n        \r\n        .mode-option.active {\r\n          background: var(--color-surface-elevated);\r\n        }\r\n        \r\n        .mode-option .mode-icon {\r\n          font-size: 18px;\r\n        }\r\n        \r\n        .mode-option .mode-info {\r\n          display: flex;\r\n          flex-direction: column;\r\n          text-align: left;\r\n        }\r\n        \r\n        .mode-option .mode-name {\r\n          font-size: var(--text-sm);\r\n          font-weight: var(--font-medium);\r\n          color: var(--color-text);\r\n        }\r\n        \r\n        .mode-option .mode-desc {\r\n          font-size: 10px;\r\n          color: var(--color-text-muted);\r\n        }\r\n        \r\n        .toolbar-btn {\r\n          padding: var(--space-1) var(--space-2);\r\n          font-size: var(--text-xs);\r\n          color: var(--color-text-secondary);\r\n          border-radius: var(--radius-sm);\r\n          transition: all var(--transition-fast);\r\n        }\r\n        \r\n        .toolbar-btn:hover:not(:disabled) {\r\n          background: var(--color-surface);\r\n        }\r\n        \r\n        .toolbar-btn:disabled {\r\n          opacity: 0.5;\r\n        }\r\n        \r\n        .toolbar-btn.active {\r\n          background: var(--color-surface);\r\n          color: var(--color-accent);\r\n        }\r\n        \r\n        .toolbar-divider {\r\n          width: 1px;\r\n          height: 24px;\r\n          background: var(--color-border-subtle);\r\n          margin: 0 var(--space-1);\r\n        }\r\n        \r\n        .toolbar-spacer {\r\n          flex: 1;\r\n        }\r\n        \r\n        .sync-status {\r\n          display: flex;\r\n          align-items: center;\r\n          gap: var(--space-2);\r\n          font-size: var(--text-xs);\r\n          color: var(--color-text-muted);\r\n        }\r\n        \r\n        .remote-users {\r\n          display: flex;\r\n          gap: 4px;\r\n          margin-left: var(--space-2);\r\n        }\r\n        \r\n        .user-badge {\r\n          width: 24px;\r\n          height: 24px;\r\n          border-radius: var(--radius-full);\r\n          display: flex;\r\n          align-items: center;\r\n          justify-content: center;\r\n          font-size: 10px;\r\n          font-weight: var(--font-semibold);\r\n          color: white;\r\n        }\r\n        \r\n        .editor-body {\r\n          flex: 1;\r\n          overflow: auto;\r\n          padding: var(--space-6);\r\n        }\r\n        \r\n        .editor-content {\r\n          max-width: 720px;\r\n          margin: 0 auto;\r\n          min-height: 100%;\r\n          font-size: var(--text-base);\r\n          line-height: 1.75;\r\n          color: var(--color-text);\r\n          outline: none;\r\n          white-space: pre-wrap;\r\n          word-wrap: break-word;\r\n        }\r\n        \r\n        .editor-content:empty::before {\r\n          content: attr(data-placeholder);\r\n          color: var(--color-text-muted);\r\n          pointer-events: none;\r\n        }\r\n        \r\n        .editor-footer {\r\n          display: flex;\r\n          align-items: center;\r\n          gap: var(--space-4);\r\n          padding: var(--space-2) var(--space-4);\r\n          border-top: 1px solid var(--color-border-subtle);\r\n          font-size: var(--text-xs);\r\n          font-family: var(--font-mono);\r\n          color: var(--color-text-muted);\r\n        }\r\n        \r\n        .mode-badge {\r\n          padding: 2px 8px;\r\n          background: var(--color-surface);\r\n          border-radius: var(--radius-sm);\r\n          font-family: var(--font-sans);\r\n        }\r\n        \r\n        .permission-notice {\r\n          padding: var(--space-2) var(--space-4);\r\n          background: var(--color-warning);\r\n          color: var(--color-bg);\r\n          font-size: var(--text-sm);\r\n          text-align: center;\r\n          border-radius: var(--radius-md);\r\n          margin-bottom: var(--space-3);\r\n        }\r\n        \r\n        .editor-content.read-only {\r\n          opacity: 0.7;\r\n          cursor: not-allowed;\r\n          user-select: text;\r\n        }\r\n        \r\n        .permission-badge {\r\n          padding: 2px 8px;\r\n          background: var(--color-warning);\r\n          color: var(--color-bg);\r\n          border-radius: var(--radius-sm);\r\n          font-family: var(--font-sans);\r\n          font-weight: var(--font-medium);\r\n        }\r\n      `}</style>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\ErrorBoundary.tsx","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":26,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":26,"endColumn":22,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[574,638],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\nimport { Component, ReactNode, ErrorInfo } from 'react'\r\n\r\ninterface Props {\r\n    children: ReactNode\r\n}\r\n\r\ninterface State {\r\n    hasError: boolean\r\n    error?: Error\r\n}\r\n\r\nexport class ErrorBoundary extends Component<Props, State> {\r\n    constructor(props: Props) {\r\n        super(props)\r\n        this.state = { hasError: false }\r\n    }\r\n\r\n    static getDerivedStateFromError(error: Error): State {\r\n        return { hasError: true, error }\r\n    }\r\n\r\n    componentDidCatch(error: Error, errorInfo: ErrorInfo) {\r\n        console.error('[ErrorBoundary] Caught error:', error, errorInfo)\r\n    }\r\n\r\n    render() {\r\n        if (this.state.hasError) {\r\n            return (\r\n                <div style={{\r\n                    padding: '2rem',\r\n                    display: 'flex',\r\n                    flexDirection: 'column',\r\n                    alignItems: 'center',\r\n                    justifyContent: 'center',\r\n                    height: '100vh',\r\n                    backgroundColor: '#111827',\r\n                    color: '#e5e7eb',\r\n                    fontFamily: 'system-ui, -apple-system, sans-serif'\r\n                }}>\r\n                    <h1 style={{ fontSize: '1.5rem', marginBottom: '1rem', color: '#ef4444' }}>\r\n                        âŒ Something went wrong\r\n                    </h1>\r\n                    <div style={{\r\n                        backgroundColor: '#1f2937',\r\n                        padding: '1rem',\r\n                        borderRadius: '0.5rem',\r\n                        maxWidth: '600px',\r\n                        overflow: 'auto',\r\n                        marginBottom: '1rem'\r\n                    }}>\r\n                        <code style={{ fontFamily: 'monospace' }}>{this.state.error?.message}</code>\r\n                    </div>\r\n                    <button\r\n                        onClick={() => window.location.reload()}\r\n                        style={{\r\n                            padding: '0.5rem 1rem',\r\n                            backgroundColor: '#3b82f6',\r\n                            color: 'white',\r\n                            border: 'none',\r\n                            borderRadius: '0.25rem',\r\n                            cursor: 'pointer'\r\n                        }}\r\n                    >\r\n                        Reload App\r\n                    </button>\r\n                </div>\r\n            )\r\n        }\r\n\r\n        return this.props.children\r\n    }\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\FilesPanel.tsx","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":123,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":123,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[3960,4046],"text":""},"desc":"Remove the console.log()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n// Files Panel - P2P File Sharing with Tiered Transfer\r\nimport { useState, useRef, useEffect, useMemo } from 'react'\r\nimport { useAppStore } from '../stores/appStore'\r\nimport { usePermissions } from '../hooks/usePermissions'\r\nimport { fileTransferService, SharedFile, TransferTier } from '../services/fileTransferService'\r\nimport { PeerInfo } from '../services/p2pService'\r\nimport {\r\n  File,\r\n  Upload,\r\n  Trash2,\r\n  Download,\r\n  Search,\r\n  FolderOpen,\r\n  Image as ImageIcon,\r\n  FileText,\r\n  Music,\r\n  Video,\r\n  Package,\r\n  FileCode,\r\n  AlertCircle,\r\n  Users,\r\n  Globe,\r\n  HardDrive,\r\n  Zap,\r\n  Layers,\r\n  Server,\r\n  ChevronDown,\r\n  Loader2\r\n} from 'lucide-react'\r\nimport './FilesPanel.css'\r\n\r\nexport default function FilesPanel() {\r\n  const { currentSpace } = useAppStore()\r\n  const { isBanned, canManageFiles, isAdmin } = usePermissions()\r\n  const [files, setFiles] = useState<SharedFile[]>([])\r\n  const [peers, setPeers] = useState<PeerInfo[]>([])\r\n  const [dragActive, setDragActive] = useState(false)\r\n  const [searchQuery, setSearchQuery] = useState('')\r\n  const [selectedTier, setSelectedTier] = useState<TransferTier>('small')\r\n  const [showTierMenu, setShowTierMenu] = useState(false)\r\n  const [uploadProgress, setUploadProgress] = useState<Record<string, number>>({})\r\n  const [isUploading, setIsUploading] = useState(false)\r\n  const fileInputRef = useRef<HTMLInputElement>(null)\r\n  const tierMenuRef = useRef<HTMLDivElement>(null)\r\n\r\n  const canModify = canManageFiles && !isBanned\r\n\r\n  // Initialize P2P file transfer when space changes\r\n  useEffect(() => {\r\n    if (!currentSpace || isBanned) return\r\n\r\n    fileTransferService.init(currentSpace.id, currentSpace.id)\r\n    fileTransferService.setCallbacks(\r\n      (sharedFiles) => setFiles(sharedFiles),\r\n      (connectedPeers) => setPeers(connectedPeers),\r\n      (fileId, progress) => setUploadProgress(prev => ({ ...prev, [fileId]: progress }))\r\n    )\r\n\r\n    setFiles(fileTransferService.getFiles())\r\n    setPeers(fileTransferService.getPeers())\r\n\r\n    return () => fileTransferService.destroy()\r\n  }, [currentSpace?.id, isBanned])\r\n\r\n  // Close tier menu on outside click\r\n  useEffect(() => {\r\n    const handleClickOutside = (e: MouseEvent) => {\r\n      if (tierMenuRef.current && !tierMenuRef.current.contains(e.target as Node)) {\r\n        setShowTierMenu(false)\r\n      }\r\n    }\r\n    document.addEventListener('mousedown', handleClickOutside)\r\n    return () => document.removeEventListener('mousedown', handleClickOutside)\r\n  }, [])\r\n\r\n  const filteredFiles = useMemo(() => {\r\n    if (!searchQuery.trim()) return files\r\n    return files.filter(file =>\r\n      file.name.toLowerCase().includes(searchQuery.toLowerCase())\r\n    )\r\n  }, [files, searchQuery])\r\n\r\n  const handleDrag = (e: React.DragEvent) => {\r\n    e.preventDefault()\r\n    e.stopPropagation()\r\n    if (e.type === 'dragenter' || e.type === 'dragover') {\r\n      setDragActive(true)\r\n    } else if (e.type === 'dragleave') {\r\n      setDragActive(false)\r\n    }\r\n  }\r\n\r\n  const handleDrop = (e: React.DragEvent) => {\r\n    e.preventDefault()\r\n    e.stopPropagation()\r\n    setDragActive(false)\r\n\r\n    if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {\r\n      handleFiles(e.dataTransfer.files)\r\n    }\r\n  }\r\n\r\n  const handleFileInput = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    if (e.target.files && e.target.files.length > 0) {\r\n      handleFiles(e.target.files)\r\n    }\r\n  }\r\n\r\n  const handleFiles = async (fileList: FileList) => {\r\n    setIsUploading(true)\r\n\r\n    for (const file of Array.from(fileList)) {\r\n      const result = await fileTransferService.shareFile(file, 'You', selectedTier)\r\n\r\n      if (!result.success) {\r\n        alert(`Failed to share ${file.name}: ${result.error}`)\r\n      } else if (result.actualTier !== selectedTier) {\r\n        // Show fallback notification\r\n        const tierInfo = fileTransferService.getTierInfo(result.actualTier!)\r\n        console.log(`[FileTransfer] Auto-upgraded to ${tierInfo.label} tier for ${file.name}`)\r\n      }\r\n    }\r\n\r\n    setIsUploading(false)\r\n    setFiles(fileTransferService.getFiles())\r\n\r\n    // Clear file input\r\n    if (fileInputRef.current) fileInputRef.current.value = ''\r\n  }\r\n\r\n  const handleDelete = (fileId: string) => {\r\n    // Linked to system Role System: isAdmin is true for 'owner' and 'admin' roles\r\n    if (!globalThis.window.confirm('Remove this shared file?')) return\r\n\r\n    if (fileTransferService.removeFile(fileId, isAdmin)) {\r\n      setFiles(fileTransferService.getFiles())\r\n    } else {\r\n      alert('You can only delete files you shared.')\r\n    }\r\n  }\r\n\r\n  const handleClearAll = () => {\r\n    if (!globalThis.window.confirm('Are you sure you want to clear ALL shared files? This cannot be undone.')) return\r\n    if (fileTransferService.clearAllFiles()) {\r\n      setFiles([])\r\n    }\r\n  }\r\n\r\n  const handleDownload = async (file: SharedFile) => {\r\n    await fileTransferService.downloadFile(file)\r\n  }\r\n\r\n  const formatSize = (bytes: number): string => {\r\n    if (typeof bytes !== 'number' || Number.isNaN(bytes) || bytes < 0) return '0 B'\r\n    if (bytes === 0) return '0 B'\r\n    if (bytes < 1024) return `${bytes} B`\r\n    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`\r\n    return `${(bytes / (1024 * 1024)).toFixed(1)} MB`\r\n  }\r\n\r\n  const formatTime = (ts: number) => {\r\n    const date = new Date(ts)\r\n    return date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' }) +\r\n      ', ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })\r\n  }\r\n\r\n  const getFileIcon = (type: string | undefined) => {\r\n    if (!type) return <File size={20} />\r\n    const lowerType = type.toLowerCase()\r\n    if (lowerType.startsWith('image/')) return <ImageIcon size={20} />\r\n    if (lowerType.startsWith('video/')) return <Video size={20} />\r\n    if (lowerType.startsWith('audio/')) return <Music size={20} />\r\n    if (lowerType.includes('pdf')) return <FileText size={20} />\r\n    if (lowerType.includes('zip') || lowerType.includes('rar')) return <Package size={20} />\r\n    if (lowerType.includes('json') || lowerType.includes('javascript')) return <FileCode size={20} />\r\n    return <File size={20} />\r\n  }\r\n\r\n  const getTierIcon = (tier: TransferTier) => {\r\n    switch (tier) {\r\n      case 'small': return <Zap size={14} />\r\n      case 'medium': return <Layers size={14} />\r\n      case 'large': return <Server size={14} />\r\n    }\r\n  }\r\n\r\n  const tierOptions: TransferTier[] = ['small', 'medium', 'large']\r\n\r\n  if (!currentSpace) {\r\n    return (\r\n      <div className=\"files-panel empty\">\r\n        <FolderOpen size={48} style={{ opacity: 0.3, marginBottom: 16 }} />\r\n        <p>Select a space to share files</p>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  if (isBanned) {\r\n    return (\r\n      <div className=\"files-panel empty banned\">\r\n        <AlertCircle size={48} className=\"banned-icon\" color=\"#ef4444\" />\r\n        <h3>Access Denied</h3>\r\n        <p>You have been banned from this space.</p>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"files-panel\">\r\n      <div className=\"files-header\">\r\n        <div className=\"header-left\">\r\n          <h2><Globe size={18} /> P2P Files</h2>\r\n          <div className=\"search-input-wrapper\">\r\n            <input\r\n              type=\"text\"\r\n              className=\"search-input\"\r\n              placeholder=\"Search files...\"\r\n              value={searchQuery}\r\n              onChange={(e) => setSearchQuery(e.target.value)}\r\n            />\r\n            <div className=\"search-icon-overlay\">\r\n              <Search size={14} />\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"header-right\">\r\n          <div className=\"peers-indicator\" title={peers.length > 0 ? peers.map(p => p.name).join(', ') : 'No peers connected'}>\r\n            <Users size={14} />\r\n            <span>{peers.length} online</span>\r\n          </div>\r\n\r\n          {canModify && (\r\n            <div className=\"upload-controls\" ref={tierMenuRef}>\r\n              {/* Clear All for Admins Only (Owner/Admin roles) */}\r\n              {isAdmin && files.length > 0 && (\r\n                <button\r\n                  className=\"btn btn-secondary btn-sm\"\r\n                  onClick={handleClearAll}\r\n                  style={{ marginRight: '8px', color: '#ef4444' }}\r\n                  title=\"Clear All Files\"\r\n                >\r\n                  <Trash2 size={14} /> Clear All\r\n                </button>\r\n              )}\r\n\r\n              {/* Tier Selector Dropdown */}\r\n              <button\r\n                className=\"tier-selector\"\r\n                onClick={() => setShowTierMenu(!showTierMenu)}\r\n                title=\"Select transfer mode\"\r\n              >\r\n                {getTierIcon(selectedTier)}\r\n                <span>{fileTransferService.getTierInfo(selectedTier).label}</span>\r\n                <ChevronDown size={12} />\r\n              </button>\r\n\r\n              {showTierMenu && (\r\n                <div className=\"tier-menu\">\r\n                  {tierOptions.map(tier => {\r\n                    const info = fileTransferService.getTierInfo(tier)\r\n                    return (\r\n                      <button\r\n                        key={tier}\r\n                        className={`tier-option ${selectedTier === tier ? 'active' : ''}`}\r\n                        onClick={() => {\r\n                          setSelectedTier(tier)\r\n                          setShowTierMenu(false)\r\n                        }}\r\n                      >\r\n                        {getTierIcon(tier)}\r\n                        <div className=\"tier-option-info\">\r\n                          <span className=\"tier-option-label\">{info.label}</span>\r\n                          <span className=\"tier-option-desc\">{info.description}</span>\r\n                        </div>\r\n                      </button>\r\n                    )\r\n                  })}\r\n                </div>\r\n              )}\r\n\r\n              {/* Upload Button */}\r\n              <button\r\n                className=\"btn btn-primary\"\r\n                onClick={() => fileInputRef.current?.click()}\r\n                disabled={isUploading}\r\n                title=\"Share File\"\r\n              >\r\n                {isUploading ? <Loader2 size={16} className=\"spin\" /> : <Upload size={16} />}\r\n                Share\r\n              </button>\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Info Banner */}\r\n      <div className=\"version-info-banner\">\r\n        <Globe size={14} />\r\n        <span>Files sync directly between peers. <b>No server.</b> Auto-fallback if file exceeds selected tier.</span>\r\n      </div>\r\n\r\n      <div className=\"files-content\">\r\n        {canModify && (\r\n          <div\r\n            className={`drop-zone ${dragActive ? 'active' : ''}`}\r\n            onDragEnter={handleDrag}\r\n            onDragLeave={handleDrag}\r\n            onDragOver={handleDrag}\r\n            onDrop={handleDrop}\r\n            onClick={() => fileInputRef.current?.click()}\r\n          >\r\n            <Upload size={32} className=\"drop-zone-icon\" />\r\n            <div style={{ textAlign: 'center' }}>\r\n              <div className=\"drop-text\">Click to share or drag and drop</div>\r\n              <div className=\"drop-subtext\">\r\n                {selectedTier === 'small' && 'â‰¤5MB instant sync'}\r\n                {selectedTier === 'medium' && 'â‰¤50MB chunked transfer'}\r\n                {selectedTier === 'large' && 'â‰¤200MB streaming'}\r\n              </div>\r\n            </div>\r\n            <input\r\n              type=\"file\"\r\n              ref={fileInputRef}\r\n              onChange={handleFileInput}\r\n              style={{ display: 'none' }}\r\n              multiple\r\n            />\r\n          </div>\r\n        )}\r\n\r\n        <div className=\"files-list-container\">\r\n          {filteredFiles.length === 0 ? (\r\n            <div className=\"empty-files\">\r\n              <Globe size={48} style={{ opacity: 0.2 }} />\r\n              <p>No shared files yet</p>\r\n              {canModify && <span className=\"drop-subtext\">Share a file to send it to connected peers</span>}\r\n            </div>\r\n          ) : (\r\n            <div className=\"files-grid\">\r\n              {filteredFiles.map(file => (\r\n                <div key={file.id} className={`file-card ${file.isLocal ? 'local' : 'remote'}`}>\r\n                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>\r\n                    <div className=\"file-icon-wrapper\">\r\n                      {getFileIcon(file.type)}\r\n                    </div>\r\n                    <div className=\"file-actions\">\r\n                      <button\r\n                        className=\"action-btn\"\r\n                        title=\"Download\"\r\n                        onClick={() => handleDownload(file)}\r\n                      >\r\n                        <Download size={14} />\r\n                      </button>\r\n                      {/* Show delete if it's your file OR you are an Admin */}\r\n                      {(file.isLocal || isAdmin) && (\r\n                        <button\r\n                          className=\"action-btn delete\"\r\n                          title=\"Remove\"\r\n                          onClick={() => handleDelete(file.id)}\r\n                        >\r\n                          <Trash2 size={14} />\r\n                        </button>\r\n                      )}\r\n                    </div>\r\n                  </div>\r\n\r\n                  {/* Progress bar for uploads */}\r\n                  {uploadProgress[file.id] !== undefined && uploadProgress[file.id] < 100 && (\r\n                    <div className=\"upload-progress\">\r\n                      <div className=\"progress-bar\" style={{ width: `${uploadProgress[file.id]}%` }} />\r\n                    </div>\r\n                  )}\r\n\r\n                  <div className=\"file-info\">\r\n                    <span className=\"file-name\" title={file.name}>{file.name}</span>\r\n                    <span className=\"file-meta\">\r\n                      {formatSize(file.size)} â€¢ {formatTime(file.uploadedAt)}\r\n                    </span>\r\n                    <span className=\"file-source\">\r\n                      {file.isLocal ? (\r\n                        <><HardDrive size={10} /> You</>\r\n                      ) : (\r\n                        <><Globe size={10} /> {file.uploadedBy}</>\r\n                      )}\r\n                      <span className=\"tier-badge\">{getTierIcon(file.tier)}</span>\r\n                    </span>\r\n                  </div>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\MainContent.tsx","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":41,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":41,"endColumn":21,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[1317,1371],"text":""},"desc":"Remove the console.warn()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\nimport { useState, useEffect } from 'react'\r\nimport { useAppStore } from '../stores/appStore'\r\nimport Editor from './Editor'\r\nimport CollaborationPanel from './CollaborationPanel'\r\nimport TaskBoard from './TaskBoard'\r\nimport VersionPanel from './VersionPanel'\r\nimport FilesPanel from './FilesPanel'\r\nimport UnifiedSettingsPanel from './UnifiedSettingsPanel'\r\nimport ResourceMonitor from './ResourceMonitor'\r\nimport { Users, Settings } from 'lucide-react'\r\n\r\ntype Tab = 'editor' | 'tasks' | 'files' | 'history'\r\n\r\ninterface MainContentProps {\r\n  activeTab: Tab\r\n}\r\n\r\nexport default function MainContent({ activeTab }: MainContentProps) {\r\n  const { currentSpace } = useAppStore()\r\n  const [showSettings, setShowSettings] = useState(false)\r\n  const [showCollaboration, setShowCollaboration] = useState(false)\r\n\r\n  // Resource monitor visibility state (with persistence)\r\n  const [resourceVisibility, setResourceVisibility] = useState({\r\n    cpu: true,\r\n    ram: true,\r\n    disk: true,\r\n    network: true\r\n  })\r\n\r\n  // Load visibility preferences from localStorage\r\n  useEffect(() => {\r\n    const saved = localStorage.getItem('resource-monitor-visibility')\r\n    if (saved) {\r\n      try {\r\n        setResourceVisibility(JSON.parse(saved))\r\n      } catch (e) {\r\n        console.warn('Failed to parse resource visibility', e)\r\n      }\r\n    }\r\n  }, [])\r\n\r\n  const handleToggleResource = (metric: 'cpu' | 'ram' | 'disk' | 'network') => {\r\n    setResourceVisibility(prev => {\r\n      const updated = { ...prev, [metric]: !prev[metric] }\r\n      localStorage.setItem('resource-monitor-visibility', JSON.stringify(updated))\r\n      return updated\r\n    })\r\n  }\r\n\r\n  if (!currentSpace) return null\r\n\r\n  return (\r\n    <div className=\"main-content\">\r\n      <header className=\"content-header glass-header\">\r\n        <h1 className=\"space-name\">{currentSpace.name}</h1>\r\n\r\n        <div className=\"header-center-scroll-wrapper\">\r\n          <div className=\"header-center\">\r\n            <ResourceMonitor\r\n              visible={resourceVisibility}\r\n              onToggle={handleToggleResource}\r\n            />\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"header-right\">\r\n          <button\r\n            className=\"icon-btn share-btn\"\r\n            onClick={() => setShowCollaboration(true)}\r\n            title=\"Team & Collaboration\"\r\n          >\r\n            <Users size={16} />\r\n          </button>\r\n\r\n          <button\r\n            className=\"icon-btn settings-btn\"\r\n            onClick={() => setShowSettings(true)}\r\n            title=\"Space Settings\"\r\n          >\r\n            <Settings size={16} />\r\n          </button>\r\n        </div>\r\n      </header>\r\n\r\n      <div className=\"content-body\">\r\n        {activeTab === 'editor' && <Editor />}\r\n        {activeTab === 'tasks' && <TaskBoard />}\r\n        {activeTab === 'history' && <VersionPanel />}\r\n        {activeTab === 'files' && <FilesPanel />}\r\n      </div>\r\n\r\n      {showSettings && <UnifiedSettingsPanel onClose={() => setShowSettings(false)} />}\r\n      {showCollaboration && <CollaborationPanel onClose={() => setShowCollaboration(false)} />}\r\n\r\n      <style>{`\r\n        .main-content {\r\n          flex: 1;\r\n          display: flex;\r\n          flex-direction: column;\r\n          overflow: hidden;\r\n          background: var(--color-bg);\r\n        }\r\n        \r\n        .content-header {\r\n          display: flex;\r\n          align-items: center;\r\n          justify-content: space-between;\r\n          padding: 0 var(--space-4);\r\n          height: 48px;\r\n          background: rgba(10, 10, 12, 0.4);\r\n          backdrop-filter: blur(12px);\r\n          border-bottom: 1px solid rgba(255, 255, 255, 0.05);\r\n          z-index: 1000;\r\n          position: relative;\r\n          gap: 12px;\r\n        }\r\n\r\n        .space-name {\r\n          font-size: var(--text-sm);\r\n          font-weight: var(--font-semibold);\r\n          color: var(--color-text);\r\n          margin: 0;\r\n          flex-shrink: 0;\r\n          max-width: 200px;\r\n          overflow: hidden;\r\n          text-overflow: ellipsis;\r\n          white-space: nowrap;\r\n        }\r\n\r\n        .header-center-scroll-wrapper {\r\n          flex: 1;\r\n          position: relative;\r\n          overflow: hidden;\r\n          margin: 0 8px;\r\n          min-width: 0;\r\n        }\r\n\r\n        .header-center-scroll-wrapper::after {\r\n          content: '';\r\n          position: absolute;\r\n          top: 0;\r\n          right: 0;\r\n          bottom: 0;\r\n          width: 40px;\r\n          background: linear-gradient(to right, transparent, rgba(10, 10, 12, 0.8));\r\n          pointer-events: none;\r\n          z-index: 10;\r\n        }\r\n\r\n        .header-center {\r\n          display: flex;\r\n          align-items: center;\r\n          justify-content: center;\r\n          min-width: 0; /* Allow shrinking */\r\n          height: 100%;\r\n        }\r\n\r\n        .header-right {\r\n          display: flex;\r\n          align-items: center;\r\n          gap: var(--space-4);\r\n          flex-shrink: 0;\r\n          z-index: 1001;\r\n          position: relative;\r\n        }\r\n\r\n        .icon-btn {\r\n          width: 32px;\r\n          height: 32px;\r\n          display: flex;\r\n          align-items: center;\r\n          justify-content: center;\r\n          color: var(--color-text-tertiary);\r\n          border-radius: 8px;\r\n          transition: all 0.2s ease;\r\n          background: transparent;\r\n          border: none;\r\n          cursor: pointer;\r\n        }\r\n\r\n        .icon-btn:hover {\r\n          background: rgba(255, 255, 255, 0.08);\r\n          color: var(--color-text);\r\n        }\r\n        \r\n        .content-body {\r\n          flex: 1;\r\n          overflow: hidden;\r\n          position: relative;\r\n        }\r\n      `}</style>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\MemberManagement.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":279,"column":72,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":279,"endColumn":75,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12430,12433],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12430,12433],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n// MemberManagement - UI for managing workspace members (Embedded)\r\nimport { useState } from 'react'\r\nimport { useMemberStore } from '../stores/memberStore'\r\nimport { useAppStore } from '../stores/appStore'\r\nimport { memberSyncService } from '../services/memberSyncService'\r\nimport { WorkspaceRole, WorkspaceMember, canKick, canBan } from '../types/permissions'\r\nimport {\r\n    User,\r\n    Shield,\r\n    Crown,\r\n    Ban,\r\n    LogOut,\r\n    Check,\r\n    Edit2,\r\n    Bot,\r\n    MessageSquare,\r\n    FileText,\r\n    Users,\r\n    Search,\r\n    Copy,\r\n    Share2,\r\n    Unlock,\r\n    Eye,\r\n    ChevronRight,\r\n    ChevronLeft,\r\n    UserPlus,\r\n    Settings,\r\n    AlertTriangle,\r\n    CheckCircle,\r\n    XCircle,\r\n    ShieldCheck\r\n} from 'lucide-react'\r\nimport './MemberManagement.css'\r\n\r\ninterface Props {\r\n    spaceId: string\r\n    onClose: () => void\r\n}\r\n\r\nexport default function MemberManagement({ spaceId, onClose }: Props) {\r\n    const { getMembers, getMyRole, unbanMember } = useMemberStore()\r\n    const { connectedPeers, currentSpace } = useAppStore()\r\n\r\n    const [selectedMember, setSelectedMember] = useState<WorkspaceMember | null>(null)\r\n    const [confirmAction, setConfirmAction] = useState<'kick' | 'ban' | 'unban' | null>(null)\r\n    const [banReason, setBanReason] = useState('')\r\n    const [viewMode, setViewMode] = useState<'active' | 'banned'>('active')\r\n    const [searchQuery, setSearchQuery] = useState('')\r\n    const [copied, setCopied] = useState(false)\r\n\r\n    const members = getMembers(spaceId)\r\n    const myRole = getMyRole(spaceId)\r\n    const isAdmin = myRole === 'owner' || myRole === 'admin'\r\n\r\n    // Filter members\r\n    const filteredMembers = members.filter(m => {\r\n        const matchesSearch = m.displayName.toLowerCase().includes(searchQuery.toLowerCase())\r\n        return matchesSearch\r\n    })\r\n\r\n    // Get banned users\r\n    const bannedUserIds = useMemberStore(state => state.spaceMembers[spaceId]?.bannedUsers || [])\r\n\r\n    const handleKick = (member: WorkspaceMember) => {\r\n        if (memberSyncService.kickMember(spaceId, member.userId)) {\r\n            setConfirmAction(null)\r\n            setSelectedMember(null)\r\n        }\r\n    }\r\n\r\n    const handleBan = (member: WorkspaceMember) => {\r\n        if (memberSyncService.banMember(spaceId, member.userId, banReason)) {\r\n            setConfirmAction(null)\r\n            setSelectedMember(null)\r\n            setBanReason('')\r\n        }\r\n    }\r\n\r\n    const handleUnban = (userId: string) => {\r\n        if (unbanMember(spaceId, userId)) {\r\n            setConfirmAction(null)\r\n            setSelectedMember(null)\r\n        }\r\n    }\r\n\r\n    const handleRoleChange = (userId: string, role: WorkspaceRole) => {\r\n        memberSyncService.updateMemberRole(spaceId, userId, role)\r\n    }\r\n\r\n    const handlePermissionToggle = (userId: string, permission: string, value: boolean) => {\r\n        memberSyncService.updateMemberPermissions(spaceId, userId, { [permission]: value })\r\n    }\r\n\r\n    const copySpaceId = () => {\r\n        if (currentSpace) {\r\n            navigator.clipboard.writeText(currentSpace.id)\r\n            setCopied(true)\r\n            setTimeout(() => setCopied(false), 2000)\r\n        }\r\n    }\r\n\r\n    const getRoleIcon = (role: string) => {\r\n        switch (role) {\r\n            case 'owner': return <Crown size={14} />\r\n            case 'admin': return <Shield size={14} />\r\n            case 'member': return <User size={14} />\r\n            case 'viewer': return <Eye size={14} />\r\n            default: return <User size={14} />\r\n        }\r\n    }\r\n\r\n    const getRoleDescription = (role: string) => {\r\n        switch (role) {\r\n            case 'owner': return 'Full control over workspace'\r\n            case 'admin': return 'Can manage members & settings'\r\n            case 'member': return 'Can edit and collaborate'\r\n            case 'viewer': return 'Read-only access'\r\n            default: return ''\r\n        }\r\n    }\r\n\r\n    const onlinePeers = connectedPeers.length\r\n\r\n    return (\r\n        <div className=\"member-management\">\r\n            {/* Header with Back Button */}\r\n            <div className=\"mm-header\">\r\n                <div className=\"mm-header-top\">\r\n                    <button className=\"mm-back-btn\" onClick={onClose}>\r\n                        <ChevronLeft size={18} />\r\n                        Back\r\n                    </button>\r\n                    <h3 className=\"mm-title\">Team Management</h3>\r\n                </div>\r\n                <div className=\"mm-stats-row\">\r\n                    <div className=\"mm-stat\">\r\n                        <div className=\"mm-stat-icon\">\r\n                            <Users size={18} />\r\n                        </div>\r\n                        <div className=\"mm-stat-info\">\r\n                            <span className=\"mm-stat-value\">{members.length}</span>\r\n                            <span className=\"mm-stat-label\">Total Members</span>\r\n                        </div>\r\n                    </div>\r\n                    <div className=\"mm-stat\">\r\n                        <div className=\"mm-stat-icon online\">\r\n                            <div className=\"online-pulse\" />\r\n                        </div>\r\n                        <div className=\"mm-stat-info\">\r\n                            <span className=\"mm-stat-value\">{onlinePeers + 1}</span>\r\n                            <span className=\"mm-stat-label\">Online Now</span>\r\n                        </div>\r\n                    </div>\r\n                    {isAdmin && bannedUserIds.length > 0 && (\r\n                        <div className=\"mm-stat\">\r\n                            <div className=\"mm-stat-icon banned\">\r\n                                <Ban size={18} />\r\n                            </div>\r\n                            <div className=\"mm-stat-info\">\r\n                                <span className=\"mm-stat-value\">{bannedUserIds.length}</span>\r\n                                <span className=\"mm-stat-label\">Banned</span>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"mm-content\">\r\n                {/* LEFT: Member List */}\r\n                <div className=\"mm-list-panel\">\r\n                    {/* Tabs */}\r\n                    <div className=\"mm-tabs\">\r\n                        <button\r\n                            className={`mm-tab ${viewMode === 'active' ? 'active' : ''}`}\r\n                            onClick={() => setViewMode('active')}\r\n                        >\r\n                            <Users size={14} />\r\n                            Members\r\n                        </button>\r\n                        {isAdmin && (\r\n                            <button\r\n                                className={`mm-tab ${viewMode === 'banned' ? 'active' : ''}`}\r\n                                onClick={() => setViewMode('banned')}\r\n                            >\r\n                                <Ban size={14} />\r\n                                Banned\r\n                                {bannedUserIds.length > 0 && (\r\n                                    <span className=\"mm-tab-badge\">{bannedUserIds.length}</span>\r\n                                )}\r\n                            </button>\r\n                        )}\r\n                    </div>\r\n\r\n                    {/* Search */}\r\n                    <div className=\"mm-search\">\r\n                        <Search size={14} />\r\n                        <input\r\n                            type=\"text\"\r\n                            placeholder=\"Search members...\"\r\n                            value={searchQuery}\r\n                            onChange={e => setSearchQuery(e.target.value)}\r\n                        />\r\n                    </div>\r\n\r\n                    {/* Member List */}\r\n                    <div className=\"mm-member-list\">\r\n                        {viewMode === 'active' ? (\r\n                            filteredMembers.length === 0 ? (\r\n                                <div className=\"mm-empty\">\r\n                                    <Users size={40} />\r\n                                    <p>No members found</p>\r\n                                </div>\r\n                            ) : (\r\n                                filteredMembers.map(member => {\r\n                                    const isOnline = connectedPeers.some(p => p.id === member.userId)\r\n                                    const isSelected = selectedMember?.userId === member.userId\r\n                                    const isMe = member.userId === useMemberStore.getState().userId\r\n\r\n                                    return (\r\n                                        <div\r\n                                            key={member.userId}\r\n                                            className={`mm-member-item ${isSelected ? 'selected' : ''} ${isMe ? 'is-me' : ''}`}\r\n                                            onClick={() => setSelectedMember(member)}\r\n                                        >\r\n                                            <div className=\"mm-member-avatar\">\r\n                                                <User size={18} />\r\n                                                <span className={`mm-status-dot ${isOnline ? 'online' : 'offline'}`} />\r\n                                            </div>\r\n                                            <div className=\"mm-member-info\">\r\n                                                <span className=\"mm-member-name\">\r\n                                                    {member.displayName}\r\n                                                    {isMe && <span className=\"mm-you-badge\">You</span>}\r\n                                                </span>\r\n                                                <span className={`mm-member-role role-${member.role}`}>\r\n                                                    {getRoleIcon(member.role)}\r\n                                                    {member.role}\r\n                                                </span>\r\n                                            </div>\r\n                                            <ChevronRight size={16} className=\"mm-chevron\" />\r\n                                        </div>\r\n                                    )\r\n                                })\r\n                            )\r\n                        ) : (\r\n                            // Banned List\r\n                            bannedUserIds.length === 0 ? (\r\n                                <div className=\"mm-empty\">\r\n                                    <CheckCircle size={40} />\r\n                                    <p>No banned users</p>\r\n                                    <span>All clear!</span>\r\n                                </div>\r\n                            ) : (\r\n                                bannedUserIds.map(userId => (\r\n                                    <div key={userId} className=\"mm-member-item banned-item\">\r\n                                        <div className=\"mm-member-avatar banned\">\r\n                                            <Ban size={18} />\r\n                                        </div>\r\n                                        <div className=\"mm-member-info\">\r\n                                            <span className=\"mm-member-name banned\">\r\n                                                {userId.slice(0, 12)}...\r\n                                            </span>\r\n                                            <span className=\"mm-member-role role-banned\">\r\n                                                <XCircle size={12} />\r\n                                                Banned\r\n                                            </span>\r\n                                        </div>\r\n                                        <button\r\n                                            className=\"mm-unban-btn\"\r\n                                            onClick={(e) => {\r\n                                                e.stopPropagation()\r\n                                                setConfirmAction('unban')\r\n                                                setSelectedMember({\r\n                                                    userId,\r\n                                                    displayName: 'Banned User',\r\n                                                    role: 'member',\r\n                                                    permissions: {} as any,\r\n                                                    joinedAt: 0,\r\n                                                    isOnline: false,\r\n                                                    isBanned: true\r\n                                                })\r\n                                            }}\r\n                                        >\r\n                                            <Unlock size={14} />\r\n                                            Unban\r\n                                        </button>\r\n                                    </div>\r\n                                ))\r\n                            )\r\n                        )}\r\n                    </div>\r\n                </div>\r\n\r\n                {/* RIGHT: Details Panel */}\r\n                <div className=\"mm-detail-panel\">\r\n                    {selectedMember && viewMode === 'active' ? (\r\n                        <div className=\"mm-detail-content\">\r\n                            {/* Member Header */}\r\n                            <div className=\"mm-detail-header\">\r\n                                <div className=\"mm-detail-avatar\">\r\n                                    <User size={28} />\r\n                                </div>\r\n                                <div className=\"mm-detail-info\">\r\n                                    <h3>{selectedMember.displayName}</h3>\r\n                                    <span className={`mm-detail-role role-${selectedMember.role}`}>\r\n                                        {getRoleIcon(selectedMember.role)}\r\n                                        {selectedMember.role}\r\n                                    </span>\r\n                                </div>\r\n                                {isAdmin && canKick(myRole, selectedMember.role) && selectedMember.userId !== useMemberStore.getState().userId && (\r\n                                    <div className=\"mm-detail-actions\">\r\n                                        <button\r\n                                            className=\"mm-action-btn kick\"\r\n                                            onClick={() => setConfirmAction('kick')}\r\n                                            title=\"Remove from workspace\"\r\n                                        >\r\n                                            <LogOut size={16} />\r\n                                        </button>\r\n                                        {canBan(myRole, selectedMember.role) && (\r\n                                            <button\r\n                                                className=\"mm-action-btn ban\"\r\n                                                onClick={() => setConfirmAction('ban')}\r\n                                                title=\"Ban user\"\r\n                                            >\r\n                                                <Ban size={16} />\r\n                                            </button>\r\n                                        )}\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n\r\n                            {/* Confirmation Dialog */}\r\n                            {confirmAction && (\r\n                                <div className=\"mm-confirm-dialog\">\r\n                                    <div className=\"mm-confirm-icon\">\r\n                                        {confirmAction === 'kick' ? <LogOut size={24} /> : <Ban size={24} />}\r\n                                    </div>\r\n                                    <h4>{confirmAction === 'kick' ? 'Remove Member?' : 'Ban Member?'}</h4>\r\n                                    <p>\r\n                                        {confirmAction === 'kick'\r\n                                            ? `${selectedMember.displayName} will be removed from this workspace.`\r\n                                            : `${selectedMember.displayName} will be permanently banned.`}\r\n                                    </p>\r\n                                    {confirmAction === 'ban' && (\r\n                                        <input\r\n                                            type=\"text\"\r\n                                            className=\"mm-ban-reason\"\r\n                                            placeholder=\"Reason for ban (optional)\"\r\n                                            value={banReason}\r\n                                            onChange={e => setBanReason(e.target.value)}\r\n                                            autoFocus\r\n                                        />\r\n                                    )}\r\n                                    <div className=\"mm-confirm-actions\">\r\n                                        <button className=\"mm-btn secondary\" onClick={() => setConfirmAction(null)}>\r\n                                            Cancel\r\n                                        </button>\r\n                                        <button\r\n                                            className=\"mm-btn danger\"\r\n                                            onClick={() => confirmAction === 'kick' ? handleKick(selectedMember) : handleBan(selectedMember)}\r\n                                        >\r\n                                            {confirmAction === 'kick' ? 'Remove' : 'Ban'}\r\n                                        </button>\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n\r\n                            {!confirmAction && (\r\n                                <>\r\n                                    {/* Role Selection */}\r\n                                    <div className=\"mm-section\">\r\n                                        <div className=\"mm-section-header\">\r\n                                            <ShieldCheck size={16} />\r\n                                            <h4>Access Level</h4>\r\n                                        </div>\r\n                                        <div className=\"mm-role-grid\">\r\n                                            {(['admin', 'member', 'viewer'] as WorkspaceRole[]).map(role => {\r\n                                                const canChange = isAdmin && canKick(myRole, selectedMember.role) && selectedMember.role !== 'owner'\r\n                                                const isActive = selectedMember.role === role\r\n\r\n                                                return (\r\n                                                    <button\r\n                                                        key={role}\r\n                                                        className={`mm-role-card ${isActive ? 'active' : ''} ${!canChange ? 'disabled' : ''}`}\r\n                                                        onClick={() => canChange && handleRoleChange(selectedMember.userId, role)}\r\n                                                        disabled={!canChange}\r\n                                                    >\r\n                                                        <div className=\"mm-role-icon\">\r\n                                                            {getRoleIcon(role)}\r\n                                                        </div>\r\n                                                        <span className=\"mm-role-name\">{role}</span>\r\n                                                        <span className=\"mm-role-desc\">{getRoleDescription(role)}</span>\r\n                                                        {isActive && <CheckCircle size={14} className=\"mm-role-check\" />}\r\n                                                    </button>\r\n                                                )\r\n                                            })}\r\n                                        </div>\r\n                                    </div>\r\n\r\n                                    {/* Permissions */}\r\n                                    <div className=\"mm-section\">\r\n                                        <div className=\"mm-section-header\">\r\n                                            <Settings size={16} />\r\n                                            <h4>Permissions</h4>\r\n                                        </div>\r\n                                        <div className=\"mm-permissions\">\r\n                                            <PermissionRow\r\n                                                icon={<Edit2 size={16} />}\r\n                                                label=\"Edit Documents\"\r\n                                                description=\"Create and modify files\"\r\n                                                active={selectedMember.permissions.canEdit}\r\n                                                disabled={!isAdmin || !canKick(myRole, selectedMember.role)}\r\n                                                onChange={(v) => handlePermissionToggle(selectedMember.userId, 'canEdit', v)}\r\n                                            />\r\n                                            <PermissionRow\r\n                                                icon={<Bot size={16} />}\r\n                                                label=\"Use AI Agent\"\r\n                                                description=\"Access AI assistance\"\r\n                                                active={selectedMember.permissions.canUseAgent}\r\n                                                disabled={!isAdmin || !canKick(myRole, selectedMember.role)}\r\n                                                onChange={(v) => handlePermissionToggle(selectedMember.userId, 'canUseAgent', v)}\r\n                                            />\r\n                                            <PermissionRow\r\n                                                icon={<MessageSquare size={16} />}\r\n                                                label=\"Send Messages\"\r\n                                                description=\"Chat with team members\"\r\n                                                active={selectedMember.permissions.canChat}\r\n                                                disabled={!isAdmin || !canKick(myRole, selectedMember.role)}\r\n                                                onChange={(v) => handlePermissionToggle(selectedMember.userId, 'canChat', v)}\r\n                                            />\r\n                                            <PermissionRow\r\n                                                icon={<FileText size={16} />}\r\n                                                label=\"Manage Files\"\r\n                                                description=\"Upload and delete files\"\r\n                                                active={selectedMember.permissions.canManageFiles}\r\n                                                disabled={!isAdmin || !canKick(myRole, selectedMember.role)}\r\n                                                onChange={(v) => handlePermissionToggle(selectedMember.userId, 'canManageFiles', v)}\r\n                                            />\r\n                                        </div>\r\n                                    </div>\r\n                                </>\r\n                            )}\r\n                        </div>\r\n                    ) : viewMode === 'banned' && confirmAction === 'unban' && selectedMember ? (\r\n                        <div className=\"mm-detail-content\">\r\n                            <div className=\"mm-confirm-dialog unban\">\r\n                                <div className=\"mm-confirm-icon success\">\r\n                                    <Unlock size={24} />\r\n                                </div>\r\n                                <h4>Unban User?</h4>\r\n                                <p>This user will be able to join the workspace again.</p>\r\n                                <div className=\"mm-confirm-actions\">\r\n                                    <button className=\"mm-btn secondary\" onClick={() => setConfirmAction(null)}>\r\n                                        Cancel\r\n                                    </button>\r\n                                    <button\r\n                                        className=\"mm-btn primary\"\r\n                                        onClick={() => handleUnban(selectedMember.userId)}\r\n                                    >\r\n                                        <Unlock size={14} />\r\n                                        Unban User\r\n                                    </button>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    ) : (\r\n                        // Invite Section\r\n                        <div className=\"mm-invite-panel\">\r\n                            <div className=\"mm-invite-header\">\r\n                                <div className=\"mm-invite-icon\">\r\n                                    <UserPlus size={32} />\r\n                                </div>\r\n                                <h3>Invite Collaborators</h3>\r\n                                <p>Share this Space ID with people you want to invite. They can join through P2P connection.</p>\r\n                            </div>\r\n\r\n                            <div className=\"mm-invite-code\">\r\n                                <span className=\"mm-invite-label\">Space ID</span>\r\n                                <div className=\"mm-invite-value\" onClick={copySpaceId}>\r\n                                    <code>{spaceId}</code>\r\n                                    <button className={`mm-copy-btn ${copied ? 'copied' : ''}`}>\r\n                                        {copied ? <Check size={16} /> : <Copy size={16} />}\r\n                                    </button>\r\n                                </div>\r\n                            </div>\r\n\r\n                            <button className=\"mm-btn primary full\" onClick={copySpaceId}>\r\n                                {copied ? (\r\n                                    <>\r\n                                        <Check size={16} />\r\n                                        Copied!\r\n                                    </>\r\n                                ) : (\r\n                                    <>\r\n                                        <Share2 size={16} />\r\n                                        Copy Invite Link\r\n                                    </>\r\n                                )}\r\n                            </button>\r\n\r\n                            <div className=\"mm-invite-info\">\r\n                                <AlertTriangle size={14} />\r\n                                <span>Members join via P2P - ensure they're on a compatible network or have TURN servers configured.</span>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n\r\nfunction PermissionRow({\r\n    icon,\r\n    label,\r\n    description,\r\n    active,\r\n    disabled,\r\n    onChange\r\n}: {\r\n    icon: React.ReactNode\r\n    label: string\r\n    description: string\r\n    active: boolean\r\n    disabled: boolean\r\n    onChange: (v: boolean) => void\r\n}) {\r\n    return (\r\n        <div\r\n            className={`mm-permission-row ${active ? 'active' : ''} ${disabled ? 'disabled' : ''}`}\r\n            onClick={() => !disabled && onChange(!active)}\r\n        >\r\n            <div className=\"mm-permission-icon\">{icon}</div>\r\n            <div className=\"mm-permission-info\">\r\n                <span className=\"mm-permission-label\">{label}</span>\r\n                <span className=\"mm-permission-desc\">{description}</span>\r\n            </div>\r\n            <div className={`mm-permission-toggle ${active ? 'on' : 'off'}`}>\r\n                <div className=\"mm-toggle-thumb\" />\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\ModelManager.tsx","messages":[{"ruleId":"no-irregular-whitespace","severity":2,"message":"Irregular whitespace not allowed.","line":77,"column":58,"nodeType":"Program","messageId":"noIrregularWhitespace","endLine":77,"endColumn":59},{"ruleId":"no-irregular-whitespace","severity":2,"message":"Irregular whitespace not allowed.","line":158,"column":43,"nodeType":"Program","messageId":"noIrregularWhitespace","endLine":158,"endColumn":44}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n// ModelManager - UI for browsing and downloading offline AI models\r\nimport { useState, useEffect } from 'react'\r\nimport { useModelStore } from '../stores/modelStore'\r\nimport {\r\n    OFFLINE_MODELS,\r\n    OfflineModel,\r\n    formatBytes,\r\n    formatETA\r\n} from '../types/offlineModels'\r\nimport {\r\n    downloadModel,\r\n    cancelDownload,\r\n    pauseDownload,\r\n    resumeDownload,\r\n    deleteModel\r\n} from '../services/modelDownloadService'\r\n\r\ninterface Props {\r\n    onClose: () => void\r\n    onSelectModel?: (modelId: string) => void\r\n}\r\n\r\nexport default function ModelManager({ onClose, onSelectModel }: Props) {\r\n    const {\r\n        downloadedModels,\r\n        activeDownloads,\r\n        loadedModelId,\r\n        getTotalDownloadedSize\r\n    } = useModelStore()\r\n\r\n    const [confirmDelete, setConfirmDelete] = useState<string | null>(null)\r\n\r\n    useEffect(() => {\r\n        useModelStore.getState().setupListeners()\r\n    }, [])\r\n\r\n    const handleDownload = async (model: OfflineModel) => {\r\n        await downloadModel(model.id)\r\n    }\r\n\r\n    const handleDelete = async (modelId: string) => {\r\n        await deleteModel(modelId)\r\n        setConfirmDelete(null)\r\n    }\r\n\r\n    const handleSelect = (modelId: string) => {\r\n        if (onSelectModel) {\r\n            onSelectModel(modelId)\r\n        }\r\n    }\r\n\r\n    const getQualityStars = (quality: number) => {\r\n        return 'â˜…'.repeat(quality) + 'â˜†'.repeat(5 - quality)\r\n    }\r\n\r\n    const getStatusBadge = (model: OfflineModel) => {\r\n        const downloaded = downloadedModels[model.id]\r\n        const download = activeDownloads[model.id]\r\n\r\n        if (loadedModelId === model.id) {\r\n            return <span className=\"badge badge-active\">âœ“ Active</span>\r\n        }\r\n        if (downloaded) {\r\n            return <span className=\"badge badge-downloaded\">âœ“ Downloaded</span>\r\n        }\r\n        if (download?.status === 'downloading') {\r\n            const pct = Math.round((download.bytesDownloaded / download.totalBytes) * 100)\r\n            return <span className=\"badge badge-progress\">{pct}%</span>\r\n        }\r\n        if (download?.status === 'paused') {\r\n            return <span className=\"badge badge-paused\">â¸ Paused</span>\r\n        }\r\n        if (download?.status === 'error') {\r\n            return <span className=\"badge badge-error\">âš  Error</span>\r\n        }\r\n        return null\r\n    }\r\n\r\n    return (\r\n        <div className=\"model-manager-overlay\" onClick={onClose}>\r\n            <div className=\"model-manager\" onClick={(e) => e.stopPropagation()}>\r\n                <div className=\"manager-header\">\r\n                    <h2>ðŸ¤– Offline AI Models</h2>\r\n                    <button className=\"close-btn\" onClick={onClose}>Ã—</button>\r\n                </div>\r\n\r\n                <div className=\"manager-info\">\r\n                    <div className=\"tier-info\">\r\n                        <span className=\"tier-badge\">Free Beta</span>\r\n                        <span>\r\n                            All {OFFLINE_MODELS.length} models available\r\n                        </span>\r\n                    </div>\r\n                    <div className=\"storage-info\">\r\n                        ðŸ’¾ {formatBytes(getTotalDownloadedSize())} used\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"model-list\">\r\n                    {OFFLINE_MODELS.map((model) => {\r\n                        const downloaded = downloadedModels[model.id]\r\n                        const download = activeDownloads[model.id]\r\n                        const isDownloading = download?.status === 'downloading'\r\n                        const isPaused = download?.status === 'paused'\r\n                        const hasError = download?.status === 'error'\r\n\r\n                        return (\r\n                            <div\r\n                                key={model.id}\r\n                                className={`model-card ${downloaded ? 'downloaded' : ''}`}\r\n                            >\r\n                                <div className=\"model-main\">\r\n                                    <div className=\"model-icon\">\r\n                                        {model.tierIndex <= 2 ? 'ðŸŸ¢' : model.tierIndex <= 4 ? 'ðŸŸ¡' : 'ðŸ”µ'}\r\n                                    </div>\r\n                                    <div className=\"model-info\">\r\n                                        <div className=\"model-header-row\">\r\n                                            <h3>{model.name}</h3>\r\n                                            {getStatusBadge(model)}\r\n                                        </div>\r\n                                        <p className=\"model-desc\">{model.description}</p>\r\n                                        <div className=\"model-stats\">\r\n                                            <span className=\"stat\">ðŸ“¦ {model.size}</span>\r\n                                            <span className=\"stat\">ðŸ’» {model.ramRequired} RAM</span>\r\n                                            <span className=\"stat quality\">{getQualityStars(model.quality)}</span>\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n\r\n                                {/* Download Progress */}\r\n                                {(isDownloading || isPaused) && download && (\r\n                                    <div className=\"download-progress\">\r\n                                        <div className=\"progress-bar\">\r\n                                            <div\r\n                                                className=\"progress-fill\"\r\n                                                style={{ width: `${(download.bytesDownloaded / download.totalBytes) * 100}%` }}\r\n                                            />\r\n                                        </div>\r\n                                        <div className=\"progress-info\">\r\n                                            <span>\r\n                                                {formatBytes(download.bytesDownloaded)} / {formatBytes(download.totalBytes)}\r\n                                            </span>\r\n                                            {isDownloading && (\r\n                                                <span>\r\n                                                    {formatBytes(download.speed)}/s â€¢ {formatETA(download.eta)}\r\n                                                </span>\r\n                                            )}\r\n                                        </div>\r\n                                    </div>\r\n                                )}\r\n\r\n                                {/* Error Message */}\r\n                                {hasError && download?.error && (\r\n                                    <div className=\"error-message\">\r\n                                        âš ï¸ {download.error}\r\n                                    </div>\r\n                                )}\r\n\r\n                                {/* Actions */}\r\n                                <div className=\"model-actions\">\r\n                                    {downloaded ? (\r\n                                        <>\r\n                                            <button\r\n                                                className=\"btn btn-primary\"\r\n                                                onClick={() => handleSelect(model.id)}\r\n                                            >\r\n                                                {loadedModelId === model.id ? 'âœ“ Selected' : 'Use Model'}\r\n                                            </button>\r\n                                            {confirmDelete === model.id ? (\r\n                                                <>\r\n                                                    <button\r\n                                                        className=\"btn btn-danger\"\r\n                                                        onClick={() => handleDelete(model.id)}\r\n                                                    >\r\n                                                        Confirm Delete\r\n                                                    </button>\r\n                                                    <button\r\n                                                        className=\"btn btn-ghost\"\r\n                                                        onClick={() => setConfirmDelete(null)}\r\n                                                    >\r\n                                                        Cancel\r\n                                                    </button>\r\n                                                </>\r\n                                            ) : (\r\n                                                <button\r\n                                                    className=\"btn btn-ghost\"\r\n                                                    onClick={() => setConfirmDelete(model.id)}\r\n                                                >\r\n                                                    ðŸ—‘ï¸ Delete\r\n                                                </button>\r\n                                            )}\r\n                                        </>\r\n                                    ) : isDownloading ? (\r\n                                        <>\r\n                                            <button\r\n                                                className=\"btn btn-secondary\"\r\n                                                onClick={() => pauseDownload(model.id)}\r\n                                            >\r\n                                                â¸ Pause\r\n                                            </button>\r\n                                            <button\r\n                                                className=\"btn btn-ghost\"\r\n                                                onClick={() => cancelDownload(model.id)}\r\n                                            >\r\n                                                Cancel\r\n                                            </button>\r\n                                        </>\r\n                                    ) : isPaused ? (\r\n                                        <>\r\n                                            <button\r\n                                                className=\"btn btn-primary\"\r\n                                                onClick={() => resumeDownload(model.id)}\r\n                                            >\r\n                                                â–¶ Resume\r\n                                            </button>\r\n                                            <button\r\n                                                className=\"btn btn-ghost\"\r\n                                                onClick={() => cancelDownload(model.id)}\r\n                                            >\r\n                                                Cancel\r\n                                            </button>\r\n                                        </>\r\n                                    ) : hasError ? (\r\n                                        <>\r\n                                            <button\r\n                                                className=\"btn btn-primary\"\r\n                                                onClick={() => handleDownload(model)}\r\n                                            >\r\n                                                â†» Retry\r\n                                            </button>\r\n                                            <button\r\n                                                className=\"btn btn-ghost\"\r\n                                                onClick={() => cancelDownload(model.id)}\r\n                                            >\r\n                                                Dismiss\r\n                                            </button>\r\n                                        </>\r\n                                    ) : (\r\n                                        <button\r\n                                            className=\"btn btn-primary\"\r\n                                            onClick={() => handleDownload(model)}\r\n                                        >\r\n                                            â¬‡ Download\r\n                                        </button>\r\n                                    )}\r\n                                </div>\r\n                            </div>\r\n                        )\r\n                    })}\r\n                </div>\r\n\r\n                <style>{`\r\n                    .model-manager-overlay {\r\n                        position: fixed;\r\n                        top: 0;\r\n                        left: 0;\r\n                        right: 0;\r\n                        bottom: 0;\r\n                        background: rgba(0, 0, 0, 0.8);\r\n                        display: flex;\r\n                        align-items: center;\r\n                        justify-content: center;\r\n                        z-index: 1000;\r\n                    }\r\n\r\n                    .model-manager {\r\n                        width: 700px;\r\n                        max-height: 85vh;\r\n                        background: var(--color-surface);\r\n                        border: 1px solid var(--color-border);\r\n                        border-radius: var(--radius-xl);\r\n                        display: flex;\r\n                        flex-direction: column;\r\n                        overflow: hidden;\r\n                    }\r\n\r\n                    .manager-header {\r\n                        display: flex;\r\n                        justify-content: space-between;\r\n                        align-items: center;\r\n                        padding: var(--space-4);\r\n                        border-bottom: 1px solid var(--color-border);\r\n                    }\r\n\r\n                    .manager-header h2 {\r\n                        font-size: var(--text-lg);\r\n                        font-weight: var(--font-semibold);\r\n                        margin: 0;\r\n                    }\r\n\r\n                    .close-btn {\r\n                        width: 32px;\r\n                        height: 32px;\r\n                        font-size: 20px;\r\n                        color: var(--color-text-muted);\r\n                    }\r\n\r\n                    .manager-info {\r\n                        display: flex;\r\n                        justify-content: space-between;\r\n                        align-items: center;\r\n                        padding: var(--space-3) var(--space-4);\r\n                        background: var(--color-surface-elevated);\r\n                        border-bottom: 1px solid var(--color-border);\r\n                        font-size: var(--text-sm);\r\n                    }\r\n\r\n                    .tier-info {\r\n                        display: flex;\r\n                        align-items: center;\r\n                        gap: var(--space-2);\r\n                    }\r\n\r\n                    .tier-badge {\r\n                        padding: 2px 8px;\r\n                        background: var(--color-accent);\r\n                        color: white;\r\n                        border-radius: var(--radius-sm);\r\n                        font-size: var(--text-xs);\r\n                        font-weight: var(--font-medium);\r\n                        text-transform: uppercase;\r\n                    }\r\n\r\n                    .storage-info {\r\n                        color: var(--color-text-muted);\r\n                    }\r\n\r\n                    .model-list {\r\n                        flex: 1;\r\n                        overflow-y: auto;\r\n                        padding: var(--space-4);\r\n                        display: flex;\r\n                        flex-direction: column;\r\n                        gap: var(--space-3);\r\n                    }\r\n\r\n                    .model-card {\r\n                        background: var(--color-bg);\r\n                        border: 1px solid var(--color-border);\r\n                        border-radius: var(--radius-lg);\r\n                        padding: var(--space-4);\r\n                        transition: all var(--transition-fast);\r\n                    }\r\n\r\n                    .model-card.locked {\r\n                        opacity: 0.6;\r\n                    }\r\n\r\n                    .model-card.downloaded {\r\n                        border-color: var(--color-success);\r\n                        background: rgba(34, 197, 94, 0.05);\r\n                    }\r\n\r\n                    .model-main {\r\n                        display: flex;\r\n                        gap: var(--space-3);\r\n                    }\r\n\r\n                    .model-icon {\r\n                        font-size: 24px;\r\n                        flex-shrink: 0;\r\n                    }\r\n\r\n                    .model-info {\r\n                        flex: 1;\r\n                        min-width: 0;\r\n                    }\r\n\r\n                    .model-header-row {\r\n                        display: flex;\r\n                        align-items: center;\r\n                        gap: var(--space-2);\r\n                        margin-bottom: var(--space-1);\r\n                    }\r\n\r\n                    .model-header-row h3 {\r\n                        font-size: var(--text-base);\r\n                        font-weight: var(--font-medium);\r\n                        margin: 0;\r\n                    }\r\n\r\n                    .badge {\r\n                        font-size: var(--text-xs);\r\n                        padding: 2px 6px;\r\n                        border-radius: var(--radius-sm);\r\n                        font-weight: var(--font-medium);\r\n                    }\r\n\r\n                    .badge-locked {\r\n                        background: var(--color-text-muted);\r\n                        color: white;\r\n                    }\r\n\r\n                    .badge-downloaded {\r\n                        background: var(--color-success);\r\n                        color: white;\r\n                    }\r\n\r\n                    .badge-active {\r\n                        background: var(--color-accent);\r\n                        color: white;\r\n                    }\r\n\r\n                    .badge-progress {\r\n                        background: var(--color-warning);\r\n                        color: var(--color-bg);\r\n                    }\r\n\r\n                    .badge-paused {\r\n                        background: var(--color-text-muted);\r\n                        color: white;\r\n                    }\r\n\r\n                    .badge-error {\r\n                        background: var(--color-error);\r\n                        color: white;\r\n                    }\r\n\r\n                    .model-desc {\r\n                        font-size: var(--text-sm);\r\n                        color: var(--color-text-secondary);\r\n                        margin: 0 0 var(--space-2) 0;\r\n                    }\r\n\r\n                    .model-stats {\r\n                        display: flex;\r\n                        gap: var(--space-3);\r\n                        font-size: var(--text-xs);\r\n                        color: var(--color-text-muted);\r\n                    }\r\n\r\n                    .stat.quality {\r\n                        color: var(--color-warning);\r\n                    }\r\n\r\n                    .download-progress {\r\n                        margin-top: var(--space-3);\r\n                    }\r\n\r\n                    .progress-bar {\r\n                        height: 6px;\r\n                        background: var(--color-border);\r\n                        border-radius: 3px;\r\n                        overflow: hidden;\r\n                    }\r\n\r\n                    .progress-fill {\r\n                        height: 100%;\r\n                        background: var(--color-accent);\r\n                        transition: width 0.2s ease;\r\n                    }\r\n\r\n                    .progress-info {\r\n                        display: flex;\r\n                        justify-content: space-between;\r\n                        margin-top: var(--space-1);\r\n                        font-size: var(--text-xs);\r\n                        color: var(--color-text-muted);\r\n                    }\r\n\r\n                    .error-message {\r\n                        margin-top: var(--space-2);\r\n                        padding: var(--space-2);\r\n                        background: rgba(239, 68, 68, 0.1);\r\n                        border-radius: var(--radius-sm);\r\n                        font-size: var(--text-xs);\r\n                        color: var(--color-error);\r\n                    }\r\n\r\n                    .model-actions {\r\n                        display: flex;\r\n                        gap: var(--space-2);\r\n                        margin-top: var(--space-3);\r\n                        padding-top: var(--space-3);\r\n                        border-top: 1px solid var(--color-border);\r\n                    }\r\n\r\n                    .btn-danger {\r\n                        background: var(--color-error);\r\n                        color: white;\r\n                    }\r\n\r\n                    .btn-danger:hover {\r\n                        background: #dc2626;\r\n                    }\r\n                `}</style>\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\NotificationSystem.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\PluginsPanel.tsx","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":451,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":451,"endColumn":32,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[18865,18912],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":510,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":510,"endColumn":34,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[21474,21544],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":521,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":521,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[22020,22070],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":548,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":548,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[23046,23098],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\nimport { useState, useEffect, useCallback } from 'react'\r\nimport { createPortal } from 'react-dom'\r\nimport {\r\n    Download, CheckCircle, XCircle, Loader2, Package,\r\n    Hexagon, Terminal, Box, Zap, Coffee, Hash, Database,\r\n    Code, Braces, FileCode, Cpu, Sparkles, Palette, Globe,\r\n    Wrench, Music, Layers, Radio, Rocket, Triangle, Crown, FileText\r\n} from 'lucide-react'\r\nimport type { LucideIcon } from 'lucide-react'\r\n\r\ninterface LanguagePlugin {\r\n    id: string\r\n    name: string\r\n    description: string\r\n    icon: LucideIcon\r\n    downloadUrl: string\r\n    installInstructions: string\r\n    isInstalled: boolean\r\n    version?: string\r\n    supportsExecution: boolean\r\n    managedByKalynt?: boolean\r\n    supportsAutoInstall?: boolean\r\n}\r\n\r\ninterface DownloadProgress {\r\n    runtimeId: string\r\n    version?: string\r\n    bytesDownloaded?: number\r\n    totalBytes?: number\r\n    progress?: number\r\n    speed: number\r\n}\r\n\r\ninterface RuntimeStatus {\r\n    runtimeId: string\r\n    version?: string\r\n    status: 'downloading' | 'installing' | 'completed' | 'failed'\r\n    message?: string\r\n    error?: string\r\n}\r\n\r\nconst AVAILABLE_PLUGINS: LanguagePlugin[] = [\r\n    {\r\n        id: 'node',\r\n        name: 'Node.js',\r\n        description: 'JavaScript & TypeScript runtime environment',\r\n        icon: Hexagon,\r\n        downloadUrl: 'https://nodejs.org/en/download/',\r\n        installInstructions: 'Automatically downloads and sets up Node.js with PATH configuration. Supports both chat and autonomous agent modes for JavaScript/TypeScript execution.',\r\n        isInstalled: false,\r\n        supportsExecution: true,\r\n        supportsAutoInstall: true\r\n    },\r\n    {\r\n        id: 'python',\r\n        name: 'Python',\r\n        description: 'Python 3 runtime for scripting and data science',\r\n        icon: Terminal,\r\n        downloadUrl: 'https://www.python.org/downloads/',\r\n        installInstructions: 'Automatically downloads and installs Python with PATH configuration. Supports both chat and autonomous agent modes for Python script execution.',\r\n        isInstalled: false,\r\n        supportsExecution: true,\r\n        supportsAutoInstall: true\r\n    },\r\n    {\r\n        id: 'rust',\r\n        name: 'Rust',\r\n        description: 'Systems programming language with cargo toolchain',\r\n        icon: Box,\r\n        downloadUrl: 'https://www.rust-lang.org/tools/install',\r\n        installInstructions: 'Automatically downloads and installs Rust with cargo toolchain. Supports IDE code execution.',\r\n        isInstalled: false,\r\n        supportsExecution: true,\r\n        supportsAutoInstall: true\r\n    },\r\n    {\r\n        id: 'go',\r\n        name: 'Go',\r\n        description: 'Fast, statically typed compiled language',\r\n        icon: Braces,\r\n        downloadUrl: 'https://go.dev/dl/',\r\n        installInstructions: 'Automatically downloads and installs Go toolchain with PATH configuration. Supports IDE code execution.',\r\n        isInstalled: false,\r\n        supportsExecution: true,\r\n        supportsAutoInstall: true\r\n    },\r\n    {\r\n        id: 'java',\r\n        name: 'Java (JDK)',\r\n        description: 'Java Development Kit for Java applications',\r\n        icon: Coffee,\r\n        downloadUrl: 'https://www.oracle.com/java/technologies/downloads/',\r\n        installInstructions: 'Automatically downloads and installs JDK with JAVA_HOME and PATH configuration. Supports IDE code execution.',\r\n        isInstalled: false,\r\n        supportsExecution: true,\r\n        supportsAutoInstall: true\r\n    },\r\n    {\r\n        id: 'dotnet',\r\n        name: '.NET SDK',\r\n        description: 'C# and F# development platform',\r\n        icon: Hash,\r\n        downloadUrl: 'https://dotnet.microsoft.com/download',\r\n        installInstructions: 'Automatically downloads and installs .NET SDK with PATH configuration. Supports IDE code execution.',\r\n        isInstalled: false,\r\n        supportsExecution: true,\r\n        supportsAutoInstall: true\r\n    },\r\n    {\r\n        id: 'ruby',\r\n        name: 'Ruby',\r\n        description: 'Dynamic, object-oriented scripting language',\r\n        icon: Database,\r\n        downloadUrl: 'https://www.ruby-lang.org/en/downloads/',\r\n        installInstructions: 'Automatically downloads and installs Ruby with PATH configuration. Supports IDE code execution.',\r\n        isInstalled: false,\r\n        supportsExecution: true,\r\n        supportsAutoInstall: true\r\n    },\r\n    {\r\n        id: 'php',\r\n        name: 'PHP',\r\n        description: 'Server-side scripting language',\r\n        icon: Code,\r\n        downloadUrl: 'https://www.php.net/downloads',\r\n        installInstructions: 'Automatically downloads and installs PHP with PATH configuration. Supports IDE code execution.',\r\n        isInstalled: false,\r\n        supportsExecution: true,\r\n        supportsAutoInstall: true\r\n    },\r\n    {\r\n        id: 'gcc',\r\n        name: 'C/C++ (GCC)',\r\n        description: 'C and C++ compiler toolchain',\r\n        icon: Cpu,\r\n        downloadUrl: 'https://gcc.gnu.org/install/',\r\n        installInstructions: 'Automatically installs GCC toolchain with PATH configuration. Windows: MinGW-w64. Mac: Xcode tools. Linux: system gcc/g++. Supports IDE code execution.',\r\n        isInstalled: false,\r\n        supportsExecution: true,\r\n        supportsAutoInstall: true\r\n    },\r\n    {\r\n        id: 'kotlin',\r\n        name: 'Kotlin',\r\n        description: 'Modern JVM language for Android and more',\r\n        icon: Triangle,\r\n        downloadUrl: 'https://kotlinlang.org/docs/command-line.html',\r\n        installInstructions: 'Automatically downloads and installs Kotlin compiler with PATH configuration. Requires Java JDK. Supports IDE code execution.',\r\n        isInstalled: false,\r\n        supportsExecution: true,\r\n        supportsAutoInstall: true\r\n    },\r\n    {\r\n        id: 'swift',\r\n        name: 'Swift',\r\n        description: 'Apple\\'s powerful programming language',\r\n        icon: Zap,\r\n        downloadUrl: 'https://www.swift.org/download/',\r\n        installInstructions: 'Automatically installs Swift toolchain with PATH configuration. Mac: Xcode tools. Windows/Linux: Swift binaries. Supports IDE code execution.',\r\n        isInstalled: false,\r\n        supportsExecution: true,\r\n        supportsAutoInstall: true\r\n    },\r\n    {\r\n        id: 'scala',\r\n        name: 'Scala',\r\n        description: 'Functional programming on the JVM',\r\n        icon: Layers,\r\n        downloadUrl: 'https://www.scala-lang.org/download/',\r\n        installInstructions: 'Automatically downloads and installs Scala with PATH configuration. Requires Java JDK. Supports IDE code execution.',\r\n        isInstalled: false,\r\n        supportsExecution: true,\r\n        supportsAutoInstall: true\r\n    },\r\n    {\r\n        id: 'perl',\r\n        name: 'Perl',\r\n        description: 'Highly capable text processing language',\r\n        icon: FileCode,\r\n        downloadUrl: 'https://www.perl.org/get.html',\r\n        installInstructions: 'Automatically installs Perl with PATH configuration. Windows: Strawberry Perl. Mac/Linux: system perl. Supports IDE code execution.',\r\n        isInstalled: false,\r\n        supportsExecution: true,\r\n        supportsAutoInstall: true\r\n    },\r\n    {\r\n        id: 'lua',\r\n        name: 'Lua',\r\n        description: 'Lightweight scripting language',\r\n        icon: Sparkles,\r\n        downloadUrl: 'https://www.lua.org/download.html',\r\n        installInstructions: 'Automatically downloads and installs Lua with PATH configuration. Popular for game scripting and embedded systems. Supports IDE code execution.',\r\n        isInstalled: false,\r\n        supportsExecution: true,\r\n        supportsAutoInstall: true\r\n    },\r\n    {\r\n        id: 'haskell',\r\n        name: 'Haskell',\r\n        description: 'Pure functional programming language',\r\n        icon: Braces,\r\n        downloadUrl: 'https://www.haskell.org/downloads/',\r\n        installInstructions: 'Automatically installs GHCup and Haskell toolchain with PATH configuration. Supports IDE code execution.',\r\n        isInstalled: false,\r\n        supportsExecution: true,\r\n        supportsAutoInstall: true\r\n    },\r\n    {\r\n        id: 'elixir',\r\n        name: 'Elixir',\r\n        description: 'Functional language for scalable applications',\r\n        icon: Sparkles,\r\n        downloadUrl: 'https://elixir-lang.org/install.html',\r\n        installInstructions: 'Automatically installs Elixir and Erlang/OTP with PATH configuration. Great for concurrent systems. Supports IDE code execution.',\r\n        isInstalled: false,\r\n        supportsExecution: true,\r\n        supportsAutoInstall: true\r\n    },\r\n    {\r\n        id: 'r',\r\n        name: 'R',\r\n        description: 'Statistical computing and graphics',\r\n        icon: Database,\r\n        downloadUrl: 'https://cran.r-project.org/',\r\n        installInstructions: 'Automatically downloads and installs R with PATH configuration. Popular for data science and statistical analysis. Supports IDE code execution.',\r\n        isInstalled: false,\r\n        supportsExecution: true,\r\n        supportsAutoInstall: true\r\n    },\r\n    {\r\n        id: 'julia',\r\n        name: 'Julia',\r\n        description: 'High-performance scientific computing',\r\n        icon: Cpu,\r\n        downloadUrl: 'https://julialang.org/downloads/',\r\n        installInstructions: 'Automatically downloads and installs Julia with PATH configuration. Designed for numerical and scientific computing. Supports IDE code execution.',\r\n        isInstalled: false,\r\n        supportsExecution: true,\r\n        supportsAutoInstall: true\r\n    },\r\n    {\r\n        id: 'dart',\r\n        name: 'Dart',\r\n        description: 'Language for Flutter and web apps',\r\n        icon: Rocket,\r\n        downloadUrl: 'https://dart.dev/get-dart',\r\n        installInstructions: 'Automatically downloads and installs Dart SDK with PATH configuration. Used for Flutter mobile development and web apps. Supports IDE code execution.',\r\n        isInstalled: false,\r\n        supportsExecution: true,\r\n        supportsAutoInstall: true\r\n    },\r\n    {\r\n        id: 'zig',\r\n        name: 'Zig',\r\n        description: 'Modern systems programming language',\r\n        icon: Zap,\r\n        downloadUrl: 'https://ziglang.org/download/',\r\n        installInstructions: 'Automatically downloads and installs Zig with PATH configuration. A general-purpose language focused on robustness and performance. Supports IDE code execution.',\r\n        isInstalled: false,\r\n        supportsExecution: true,\r\n        supportsAutoInstall: true\r\n    },\r\n    {\r\n        id: 'clojure',\r\n        name: 'Clojure',\r\n        description: 'Lisp dialect for the JVM',\r\n        icon: Layers,\r\n        downloadUrl: 'https://clojure.org/guides/install_clojure',\r\n        installInstructions: 'Automatically installs Clojure CLI tools with PATH configuration. Requires Java JDK. Functional programming on the JVM. Supports IDE code execution.',\r\n        isInstalled: false,\r\n        supportsExecution: true,\r\n        supportsAutoInstall: true\r\n    },\r\n    {\r\n        id: 'deno',\r\n        name: 'Deno',\r\n        description: 'Secure TypeScript/JavaScript runtime',\r\n        icon: Terminal,\r\n        downloadUrl: 'https://deno.land/manual/getting_started/installation',\r\n        installInstructions: 'Automatically downloads and installs Deno with PATH configuration. Modern, secure runtime for JavaScript and TypeScript with built-in tooling. Supports IDE code execution.',\r\n        isInstalled: false,\r\n        supportsExecution: true,\r\n        supportsAutoInstall: true\r\n    },\r\n    {\r\n        id: 'bun',\r\n        name: 'Bun',\r\n        description: 'Fast all-in-one JavaScript runtime',\r\n        icon: Zap,\r\n        downloadUrl: 'https://bun.sh/docs/installation',\r\n        installInstructions: 'Automatically downloads and installs Bun with PATH configuration. Extremely fast JavaScript runtime with npm-compatible package manager. Supports IDE code execution.',\r\n        isInstalled: false,\r\n        supportsExecution: true,\r\n        supportsAutoInstall: true\r\n    },\r\n    {\r\n        id: 'nasm',\r\n        name: 'NASM',\r\n        description: 'Netwide Assembler for x86/x64',\r\n        icon: Cpu,\r\n        downloadUrl: 'https://www.nasm.us/pub/nasm/releasebuilds/',\r\n        installInstructions: 'Automatically downloads and installs NASM assembler with PATH configuration. For low-level x86/x64 assembly programming. Assembly code can be assembled and linked via terminal.',\r\n        isInstalled: false,\r\n        supportsExecution: false,\r\n        supportsAutoInstall: true\r\n    },\r\n    {\r\n        id: 'sass',\r\n        name: 'Sass',\r\n        description: 'CSS preprocessor with superpowers',\r\n        icon: Palette,\r\n        downloadUrl: 'https://sass-lang.com/install',\r\n        installInstructions: 'Automatically installs Sass globally via npm with PATH configuration. Compiles Sass/SCSS to CSS. Can be run via terminal.',\r\n        isInstalled: false,\r\n        supportsExecution: false,\r\n        supportsAutoInstall: true\r\n    },\r\n    {\r\n        id: 'emscripten',\r\n        name: 'Emscripten',\r\n        description: 'C/C++ to WebAssembly compiler',\r\n        icon: Globe,\r\n        downloadUrl: 'https://emscripten.org/docs/getting_started/downloads.html',\r\n        installInstructions: 'Automatically installs Emscripten SDK with PATH configuration. Compiles C/C++ to WebAssembly for web browsers. Includes Python dependencies.',\r\n        isInstalled: false,\r\n        supportsExecution: false,\r\n        supportsAutoInstall: true\r\n    },\r\n    {\r\n        id: 'wabt',\r\n        name: 'WebAssembly Tools',\r\n        description: 'WebAssembly Binary Toolkit',\r\n        icon: Wrench,\r\n        downloadUrl: 'https://github.com/WebAssembly/wabt/releases',\r\n        installInstructions: 'Automatically downloads and installs WABT with PATH configuration. Tools for converting between WebAssembly text and binary formats (wat2wasm, wasm2wat, etc).',\r\n        isInstalled: false,\r\n        supportsExecution: false,\r\n        supportsAutoInstall: true\r\n    },\r\n    {\r\n        id: 'groovy',\r\n        name: 'Groovy',\r\n        description: 'Dynamic language for the JVM',\r\n        icon: Music,\r\n        downloadUrl: 'https://groovy.apache.org/download.html',\r\n        installInstructions: 'Automatically downloads and installs Groovy with PATH configuration. Requires Java JDK. Dynamic scripting language for the JVM platform. Supports IDE code execution.',\r\n        isInstalled: false,\r\n        supportsExecution: true,\r\n        supportsAutoInstall: true\r\n    },\r\n    {\r\n        id: 'ocaml',\r\n        name: 'OCaml',\r\n        description: 'Functional programming with strong types',\r\n        icon: FileCode,\r\n        downloadUrl: 'https://ocaml.org/install',\r\n        installInstructions: 'Automatically installs OCaml with PATH configuration. Industrial-strength functional programming language. Supports IDE code execution.',\r\n        isInstalled: false,\r\n        supportsExecution: true,\r\n        supportsAutoInstall: true\r\n    },\r\n    {\r\n        id: 'erlang',\r\n        name: 'Erlang',\r\n        description: 'Concurrent and fault-tolerant systems',\r\n        icon: Radio,\r\n        downloadUrl: 'https://www.erlang.org/downloads',\r\n        installInstructions: 'Automatically downloads and installs Erlang/OTP with PATH configuration. Built for massively concurrent, distributed systems. Supports IDE code execution.',\r\n        isInstalled: false,\r\n        supportsExecution: true,\r\n        supportsAutoInstall: true\r\n    },\r\n    {\r\n        id: 'fsharp',\r\n        name: 'F#',\r\n        description: 'Functional-first .NET language',\r\n        icon: Hash,\r\n        downloadUrl: 'https://fsharp.org/use/windows/',\r\n        installInstructions: 'Automatically installs .NET SDK with F# support and PATH configuration. Functional programming on .NET platform. Supports IDE code execution.',\r\n        isInstalled: false,\r\n        supportsExecution: true,\r\n        supportsAutoInstall: true\r\n    },\r\n    {\r\n        id: 'v',\r\n        name: 'V',\r\n        description: 'Simple, fast, safe compiled language',\r\n        icon: Triangle,\r\n        downloadUrl: 'https://github.com/vlang/v#installing-v-from-source',\r\n        installInstructions: 'Automatically installs V language with PATH configuration. Simple language similar to Go. Supports IDE code execution.',\r\n        isInstalled: false,\r\n        supportsExecution: true,\r\n        supportsAutoInstall: true\r\n    },\r\n    {\r\n        id: 'nim',\r\n        name: 'Nim',\r\n        description: 'Efficient, expressive, elegant language',\r\n        icon: Crown,\r\n        downloadUrl: 'https://nim-lang.org/install.html',\r\n        installInstructions: 'Automatically downloads and installs Nim with PATH configuration. Compiles to C/C++ for high performance. Supports IDE code execution.',\r\n        isInstalled: false,\r\n        supportsExecution: true,\r\n        supportsAutoInstall: true\r\n    },\r\n    {\r\n        id: 'html',\r\n        name: 'HTML',\r\n        description: 'HyperText Markup Language for web pages',\r\n        icon: FileText,\r\n        downloadUrl: 'https://developer.mozilla.org/en-US/docs/Web/HTML',\r\n        installInstructions: 'HTML is natively supported in all web browsers. No installation required. Create and preview HTML files directly in the IDE.',\r\n        isInstalled: true,\r\n        supportsExecution: true,\r\n        supportsAutoInstall: true,\r\n        managedByKalynt: false\r\n    }\r\n]\r\n\r\nexport default function PluginsPanel({ onClose }: { onClose: () => void }) {\r\n    const [plugins, setPlugins] = useState<LanguagePlugin[]>(AVAILABLE_PLUGINS)\r\n    const [checkingInstallations, setCheckingInstallations] = useState(false)\r\n    const [installingId, setInstallingId] = useState<string | null>(null)\r\n    const [downloadProgress, setDownloadProgress] = useState<Map<string, DownloadProgress>>(new Map())\r\n    const [runtimeStatus, setRuntimeStatus] = useState<Map<string, RuntimeStatus>>(new Map())\r\n    const [installLogs, setInstallLogs] = useState<Map<string, string[]>>(new Map())\r\n\r\n    // Check installation states\r\n    const checkInstallations = useCallback(async () => {\r\n        setCheckingInstallations(true)\r\n\r\n        const updatedPlugins = await Promise.all(\r\n            AVAILABLE_PLUGINS.map(async (plugin) => {\r\n                try {\r\n                    if (globalThis.window.electronAPI?.runtimeMgmt?.check) {\r\n                        const result = await globalThis.window.electronAPI.runtimeMgmt.check(plugin.id)\r\n\r\n                        if (result.success && result.isInstalled) {\r\n                            return {\r\n                                ...plugin,\r\n                                isInstalled: true,\r\n                                version: result.version,\r\n                                managedByKalynt: result.managedByKalynt\r\n                            }\r\n                        }\r\n                    }\r\n                } catch (error) {\r\n                    console.log(`${plugin.name} not found:`, error)\r\n                }\r\n\r\n                return { ...plugin, isInstalled: false, managedByKalynt: false }\r\n            })\r\n        )\r\n\r\n        setPlugins(updatedPlugins)\r\n        setCheckingInstallations(false)\r\n    }, [])\r\n\r\n    // Check installations on mount and set up listeners\r\n    useEffect(() => {\r\n        checkInstallations()\r\n\r\n        // Set up progress listeners\r\n        if (window.electronAPI?.runtimeMgmt) {\r\n            window.electronAPI.runtimeMgmt.onDownloadProgress((progress: { runtimeId: string; version?: string; bytesDownloaded?: number; totalBytes?: number; progress?: number; speed: number }) => {\r\n                setDownloadProgress(prev => new Map(prev).set(progress.runtimeId, progress))\r\n            })\r\n\r\n            window.electronAPI.runtimeMgmt.onStatus((status: { runtimeId: string; version?: string; status: 'downloading' | 'installing' | 'completed' | 'failed'; message?: string; error?: string }) => {\r\n                setRuntimeStatus(prev => new Map(prev).set(status.runtimeId, status))\r\n\r\n                // Recheck installations when complete\r\n                if (status.status === 'completed') {\r\n                    setTimeout(() => checkInstallations(), 1000)\r\n                    setInstallingId(null)\r\n                } else if (status.status === 'failed') {\r\n                    setInstallingId(null)\r\n                }\r\n            })\r\n\r\n            window.electronAPI.runtimeMgmt.onLog((log: { runtimeId: string; version?: string; level: string; message: string }) => {\r\n                setInstallLogs(prev => {\r\n                    const logs = prev.get(log.runtimeId) || []\r\n                    return new Map(prev).set(log.runtimeId, [...logs, log.message])\r\n                })\r\n            })\r\n        }\r\n\r\n        return () => {\r\n            window.electronAPI?.runtimeMgmt?.removeListeners()\r\n        }\r\n    }, [checkInstallations])\r\n\r\n    // REMOVED: duplicate checkInstallations definition was here, now moved above useEffect\r\n\r\n    const installRuntime = async (plugin: LanguagePlugin) => {\r\n        setInstallingId(plugin.id)\r\n        // Clear previous logs\r\n        setInstallLogs(prev => new Map(prev).set(plugin.id, []))\r\n\r\n        try {\r\n            // If auto-install is supported, use the new runtime manager\r\n            if (plugin.supportsAutoInstall && globalThis.window.electronAPI?.runtimeMgmt?.downloadAndInstall) {\r\n                const result = await globalThis.window.electronAPI.runtimeMgmt.downloadAndInstall(plugin.id)\r\n\r\n                if (!result.success) {\r\n                    console.error(`Installation failed for ${plugin.name}:`, result.error)\r\n                    alert(`Failed to install ${plugin.name}: ${result.error}`)\r\n                }\r\n            } else {\r\n                // Otherwise, open download page in external browser\r\n                if (globalThis.window.electronAPI?.shell?.openExternal) {\r\n                    await globalThis.window.electronAPI.shell.openExternal(plugin.downloadUrl)\r\n                }\r\n                setInstallingId(null)\r\n            }\r\n        } catch (error) {\r\n            console.error('Failed to install runtime:', error)\r\n            alert(`Failed to install ${plugin.name}`)\r\n            setInstallingId(null)\r\n        }\r\n    }\r\n\r\n    const uninstallRuntime = async (plugin: LanguagePlugin) => {\r\n        if (!plugin.managedByKalynt) {\r\n            alert(`${plugin.name} was not installed by Kalynt and cannot be automatically uninstalled.`)\r\n            return\r\n        }\r\n\r\n        if (!confirm(`Are you sure you want to uninstall ${plugin.name}? This will remove it from your system and PATH.`)) {\r\n            return\r\n        }\r\n\r\n        try {\r\n            if (globalThis.window.electronAPI?.runtimeMgmt?.uninstall) {\r\n                const result = await globalThis.window.electronAPI.runtimeMgmt.uninstall(plugin.id)\r\n\r\n                if (result.success) {\r\n                    await checkInstallations()\r\n                } else {\r\n                    alert(`Failed to uninstall ${plugin.name}: ${result.error}`)\r\n                }\r\n            }\r\n        } catch (error) {\r\n            console.error('Failed to uninstall runtime:', error)\r\n            alert(`Failed to uninstall ${plugin.name}`)\r\n        }\r\n    }\r\n\r\n    const formatBytes = (bytes: number): string => {\r\n        if (bytes === 0) return '0 B'\r\n        const k = 1024\r\n        const sizes = ['B', 'KB', 'MB', 'GB']\r\n        const i = Math.floor(Math.log(bytes) / Math.log(k))\r\n        return `${(bytes / Math.pow(k, i)).toFixed(2)} ${sizes[i]}`\r\n    }\r\n\r\n    const formatSpeed = (bytesPerSecond: number): string => {\r\n        return `${formatBytes(bytesPerSecond)}/s`\r\n    }\r\n\r\n    return createPortal(\r\n        <div className=\"plugins-overlay\" onClick={onClose}>\r\n            <div className=\"plugins-panel\" onClick={e => e.stopPropagation()}>\r\n                <div className=\"plugins-header\">\r\n                    <div className=\"header-content\">\r\n                        <Package size={24} className=\"header-icon\" />\r\n                        <div>\r\n                            <h2>Language Plugins</h2>\r\n                            <p>Install programming language runtimes to execute code in the IDE</p>\r\n                        </div>\r\n                    </div>\r\n                    <button className=\"close-btn\" onClick={onClose}>Ã—</button>\r\n                </div>\r\n\r\n                <div className=\"plugins-actions\">\r\n                    <button\r\n                        className=\"btn-check-installations\"\r\n                        onClick={checkInstallations}\r\n                        disabled={checkingInstallations}\r\n                    >\r\n                        {checkingInstallations ? (\r\n                            <>\r\n                                <Loader2 size={16} className=\"animate-spin\" />\r\n                                Checking...\r\n                            </>\r\n                        ) : (\r\n                            <>\r\n                                <CheckCircle size={16} />\r\n                                Check Installations\r\n                            </>\r\n                        )}\r\n                    </button>\r\n                </div>\r\n\r\n                <div className=\"plugins-list\">\r\n                    {plugins.map(plugin => {\r\n                        const progress = downloadProgress.get(plugin.id)\r\n                        const status = runtimeStatus.get(plugin.id)\r\n                        const isInstalling = installingId === plugin.id\r\n\r\n                        const IconComponent = plugin.icon\r\n\r\n                        return (\r\n                            <div key={plugin.id} className=\"plugin-card\">\r\n                                <div className=\"plugin-icon\">\r\n                                    <IconComponent size={40} strokeWidth={1.5} />\r\n                                </div>\r\n                                <div className=\"plugin-info\">\r\n                                    <div className=\"plugin-header-row\">\r\n                                        <h3>{plugin.name}</h3>\r\n                                        {plugin.isInstalled ? (\r\n                                            <div className=\"badge-group\">\r\n                                                <span className=\"badge-installed\">\r\n                                                    <CheckCircle size={14} />\r\n                                                    {plugin.version || 'Installed'}\r\n                                                </span>\r\n                                                {plugin.managedByKalynt && (\r\n                                                    <span className=\"badge-managed\">Kalynt Managed</span>\r\n                                                )}\r\n                                            </div>\r\n                                        ) : (\r\n                                            <span className=\"badge-not-installed\">\r\n                                                <XCircle size={14} />\r\n                                                Not Installed\r\n                                            </span>\r\n                                        )}\r\n                                    </div>\r\n                                    <p className=\"plugin-description\">{plugin.description}</p>\r\n                                    <p className=\"plugin-instructions\">{plugin.installInstructions}</p>\r\n                                    {plugin.supportsExecution && (\r\n                                        <span className=\"execution-badge\">\r\n                                            <Zap size={12} />\r\n                                            Supports IDE Execution\r\n                                        </span>\r\n                                    )}\r\n\r\n                                    {/* Download Progress */}\r\n                                    {isInstalling && progress && (\r\n                                        <div className=\"progress-container\">\r\n                                            <div className=\"progress-bar\">\r\n                                                <div\r\n                                                    className=\"progress-fill\"\r\n                                                    style={{\r\n                                                        width: progress.bytesDownloaded && progress.totalBytes\r\n                                                            ? `${(progress.bytesDownloaded / progress.totalBytes) * 100}%`\r\n                                                            : progress.progress ? `${progress.progress}%` : '0%'\r\n                                                    }}\r\n                                                />\r\n                                            </div>\r\n                                            <div className=\"progress-text\">\r\n                                                <span>\r\n                                                    {progress.bytesDownloaded && progress.totalBytes\r\n                                                        ? `${formatBytes(progress.bytesDownloaded)} / ${formatBytes(progress.totalBytes)}`\r\n                                                        : progress.progress ? `${progress.progress.toFixed(1)}%` : 'Downloading...'}\r\n                                                </span>\r\n                                                <span>{formatSpeed(progress.speed)}</span>\r\n                                            </div>\r\n                                        </div>\r\n                                    )}\r\n\r\n                                    {/* Installation Status */}\r\n                                    {isInstalling && status && (\r\n                                        <div className=\"status-message\">\r\n                                            {status.status === 'downloading' && (\r\n                                                <><Download size={14} /> Downloading...</>\r\n                                            )}\r\n                                            {status.status === 'installing' && (\r\n                                                <><Package size={14} /> Installing...</>\r\n                                            )}\r\n                                            {status.status === 'completed' && (\r\n                                                <><CheckCircle size={14} /> Installation complete!</>\r\n                                            )}\r\n                                            {status.status === 'failed' && (\r\n                                                <><XCircle size={14} /> Failed: {status.error}</>\r\n                                            )}\r\n                                        </div>\r\n                                    )}\r\n\r\n                                    {/* Installation Logs */}\r\n                                    {isInstalling && installLogs.get(plugin.id) && installLogs.get(plugin.id)!.length > 0 && (\r\n                                        <div className=\"install-logs\">\r\n                                            {installLogs.get(plugin.id)!.map((log, index) => (\r\n                                                <div key={index} className=\"log-line\">\r\n                                                    {log}\r\n                                                </div>\r\n                                            ))}\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n                                <div className=\"plugin-actions\">\r\n                                    {plugin.isInstalled && plugin.managedByKalynt ? (\r\n                                        <button\r\n                                            className=\"btn-uninstall\"\r\n                                            onClick={() => uninstallRuntime(plugin)}\r\n                                            title=\"Uninstall\"\r\n                                        >\r\n                                            <XCircle size={16} />\r\n                                        </button>\r\n                                    ) : (\r\n                                        <button\r\n                                            className={`btn-download ${plugin.isInstalled ? 'installed' : ''}`}\r\n                                            onClick={() => installRuntime(plugin)}\r\n                                            disabled={isInstalling || plugin.isInstalled}\r\n                                            title={plugin.isInstalled ? \"Already installed\" : \"Install\"}\r\n                                        >\r\n                                            {isInstalling && <Loader2 size={16} className=\"animate-spin\" />}\r\n                                            {!isInstalling && plugin.isInstalled && <CheckCircle size={16} />}\r\n                                            {!isInstalling && !plugin.isInstalled && <Download size={16} />}\r\n                                        </button>\r\n                                    )}\r\n                                </div>\r\n                            </div>\r\n                        )\r\n                    })}\r\n                </div>\r\n\r\n                <style>{`\r\n                    .plugins-overlay {\r\n                        position: fixed;\r\n                        top: 0;\r\n                        left: 0;\r\n                        right: 0;\r\n                        bottom: 0;\r\n                        background: rgba(0, 0, 0, 0.7);\r\n                        display: flex;\r\n                        align-items: center;\r\n                        justify-content: center;\r\n                        z-index: 10000;\r\n                        backdrop-filter: blur(4px);\r\n                    }\r\n\r\n                    .plugins-panel {\r\n                        background: var(--color-surface);\r\n                        border-radius: var(--radius-lg);\r\n                        border: 1px solid var(--color-border);\r\n                        box-shadow: var(--shadow-xl);\r\n                        width: 90%;\r\n                        max-width: 900px;\r\n                        max-height: 85vh;\r\n                        display: flex;\r\n                        flex-direction: column;\r\n                        overflow: hidden;\r\n                    }\r\n\r\n                    .plugins-header {\r\n                        display: flex;\r\n                        align-items: center;\r\n                        justify-content: space-between;\r\n                        padding: var(--space-5);\r\n                        border-bottom: 1px solid var(--color-border-subtle);\r\n                        background: var(--color-surface-subtle);\r\n                    }\r\n\r\n                    .header-content {\r\n                        display: flex;\r\n                        align-items: center;\r\n                        gap: var(--space-3);\r\n                    }\r\n\r\n                    .header-icon {\r\n                        color: var(--color-accent);\r\n                    }\r\n\r\n                    .plugins-header h2 {\r\n                        margin: 0;\r\n                        font-size: var(--text-lg);\r\n                        font-weight: 700;\r\n                        color: var(--color-text);\r\n                    }\r\n\r\n                    .plugins-header p {\r\n                        margin: 4px 0 0 0;\r\n                        font-size: var(--text-sm);\r\n                        color: var(--color-text-secondary);\r\n                    }\r\n\r\n                    .close-btn {\r\n                        width: 32px;\r\n                        height: 32px;\r\n                        display: flex;\r\n                        align-items: center;\r\n                        justify-content: center;\r\n                        font-size: 24px;\r\n                        color: var(--color-text-tertiary);\r\n                        border-radius: var(--radius-md);\r\n                        transition: all var(--transition-fast);\r\n                        border: none;\r\n                        background: transparent;\r\n                        cursor: pointer;\r\n                    }\r\n\r\n                    .close-btn:hover {\r\n                        background: var(--color-surface-elevated);\r\n                        color: var(--color-text);\r\n                    }\r\n\r\n                    .plugins-actions {\r\n                        padding: var(--space-4);\r\n                        border-bottom: 1px solid var(--color-border-subtle);\r\n                        display: flex;\r\n                        justify-content: flex-end;\r\n                    }\r\n\r\n                    .btn-check-installations {\r\n                        display: flex;\r\n                        align-items: center;\r\n                        gap: var(--space-2);\r\n                        padding: 8px 16px;\r\n                        background: var(--color-accent);\r\n                        color: #000;\r\n                        border: none;\r\n                        border-radius: var(--radius-md);\r\n                        font-size: var(--text-sm);\r\n                        font-weight: 600;\r\n                        cursor: pointer;\r\n                        transition: all var(--transition-fast);\r\n                    }\r\n\r\n                    .btn-check-installations:hover:not(:disabled) {\r\n                        filter: brightness(1.1);\r\n                        transform: translateY(-1px);\r\n                    }\r\n\r\n                    .btn-check-installations:disabled {\r\n                        opacity: 0.6;\r\n                        cursor: not-allowed;\r\n                    }\r\n\r\n                    .animate-spin {\r\n                        animation: spin 1s linear infinite;\r\n                    }\r\n\r\n                    @keyframes spin {\r\n                        from { transform: rotate(0deg); }\r\n                        to { transform: rotate(360deg); }\r\n                    }\r\n\r\n                    .plugins-list {\r\n                        flex: 1;\r\n                        overflow-y: auto;\r\n                        padding: var(--space-4);\r\n                        display: flex;\r\n                        flex-direction: column;\r\n                        gap: var(--space-3);\r\n                    }\r\n\r\n                    .plugin-card {\r\n                        display: flex;\r\n                        align-items: flex-start;\r\n                        gap: var(--space-4);\r\n                        padding: var(--space-4);\r\n                        background: var(--color-surface-elevated);\r\n                        border: 1px solid var(--color-border);\r\n                        border-radius: var(--radius-lg);\r\n                        transition: all var(--transition-fast);\r\n                    }\r\n\r\n                    .plugin-card:hover {\r\n                        border-color: var(--color-accent);\r\n                        box-shadow: var(--shadow-md);\r\n                    }\r\n\r\n                    .plugin-icon {\r\n                        display: flex;\r\n                        align-items: center;\r\n                        justify-content: center;\r\n                        width: 56px;\r\n                        height: 56px;\r\n                        flex-shrink: 0;\r\n                        color: var(--color-accent);\r\n                    }\r\n\r\n                    .plugin-info {\r\n                        flex: 1;\r\n                        min-width: 0;\r\n                    }\r\n\r\n                    .plugin-header-row {\r\n                        display: flex;\r\n                        align-items: center;\r\n                        justify-content: space-between;\r\n                        margin-bottom: var(--space-2);\r\n                        gap: var(--space-2);\r\n                    }\r\n\r\n                    .plugin-info h3 {\r\n                        margin: 0;\r\n                        font-size: var(--text-md);\r\n                        font-weight: 700;\r\n                        color: var(--color-text);\r\n                    }\r\n\r\n                    .badge-group {\r\n                        display: flex;\r\n                        align-items: center;\r\n                        gap: 6px;\r\n                        flex-wrap: wrap;\r\n                    }\r\n\r\n                    .badge-installed {\r\n                        display: flex;\r\n                        align-items: center;\r\n                        gap: 4px;\r\n                        padding: 4px 10px;\r\n                        background: rgba(34, 197, 94, 0.1);\r\n                        color: var(--color-success);\r\n                        border-radius: var(--radius-sm);\r\n                        font-size: 11px;\r\n                        font-weight: 600;\r\n                        white-space: nowrap;\r\n                    }\r\n\r\n                    .badge-managed {\r\n                        padding: 4px 8px;\r\n                        background: rgba(59, 130, 246, 0.1);\r\n                        color: var(--color-accent);\r\n                        border-radius: var(--radius-sm);\r\n                        font-size: 10px;\r\n                        font-weight: 600;\r\n                        white-space: nowrap;\r\n                    }\r\n\r\n                    .badge-not-installed {\r\n                        display: flex;\r\n                        align-items: center;\r\n                        gap: 4px;\r\n                        padding: 4px 10px;\r\n                        background: rgba(239, 68, 68, 0.1);\r\n                        color: var(--color-error);\r\n                        border-radius: var(--radius-sm);\r\n                        font-size: 11px;\r\n                        font-weight: 600;\r\n                        white-space: nowrap;\r\n                    }\r\n\r\n                    .plugin-description {\r\n                        margin: 0 0 var(--space-2) 0;\r\n                        font-size: var(--text-sm);\r\n                        color: var(--color-text-secondary);\r\n                        line-height: 1.5;\r\n                    }\r\n\r\n                    .plugin-instructions {\r\n                        margin: 0 0 var(--space-2) 0;\r\n                        font-size: var(--text-xs);\r\n                        color: var(--color-text-tertiary);\r\n                        line-height: 1.5;\r\n                        font-style: italic;\r\n                    }\r\n\r\n                    .execution-badge {\r\n                        display: inline-flex;\r\n                        align-items: center;\r\n                        gap: 4px;\r\n                        padding: 3px 8px;\r\n                        background: rgba(59, 130, 246, 0.1);\r\n                        color: var(--color-accent);\r\n                        border-radius: var(--radius-sm);\r\n                        font-size: 10px;\r\n                        font-weight: 600;\r\n                    }\r\n\r\n                    .progress-container {\r\n                        margin-top: var(--space-3);\r\n                    }\r\n\r\n                    .progress-bar {\r\n                        width: 100%;\r\n                        height: 6px;\r\n                        background: var(--color-surface);\r\n                        border-radius: var(--radius-sm);\r\n                        overflow: hidden;\r\n                        margin-bottom: var(--space-2);\r\n                    }\r\n\r\n                    .progress-fill {\r\n                        height: 100%;\r\n                        background: linear-gradient(90deg, var(--color-accent), var(--color-success));\r\n                        transition: width 0.3s ease;\r\n                    }\r\n\r\n                    .progress-text {\r\n                        display: flex;\r\n                        justify-content: space-between;\r\n                        font-size: 11px;\r\n                        color: var(--color-text-secondary);\r\n                    }\r\n\r\n                    .status-message {\r\n                        display: flex;\r\n                        align-items: center;\r\n                        gap: 8px;\r\n                        margin-top: var(--space-2);\r\n                        padding: 8px 12px;\r\n                        background: var(--color-surface);\r\n                        border-radius: var(--radius-md);\r\n                        font-size: 12px;\r\n                        color: var(--color-text-secondary);\r\n                        font-weight: 500;\r\n                    }\r\n\r\n                    .install-logs {\r\n                        margin-top: var(--space-3);\r\n                        padding: 12px;\r\n                        background: #0a0a0a;\r\n                        border: 1px solid rgba(255, 255, 255, 0.1);\r\n                        border-radius: var(--radius-md);\r\n                        max-height: 200px;\r\n                        overflow-y: auto;\r\n                        font-family: 'Cascadia Code', 'Consolas', 'Monaco', monospace;\r\n                    }\r\n\r\n                    .log-line {\r\n                        font-size: 11px;\r\n                        color: #00ff00;\r\n                        line-height: 1.6;\r\n                        margin-bottom: 2px;\r\n                        word-break: break-all;\r\n                        white-space: pre-wrap;\r\n                    }\r\n\r\n                    .install-logs::-webkit-scrollbar {\r\n                        width: 6px;\r\n                    }\r\n\r\n                    .install-logs::-webkit-scrollbar-track {\r\n                        background: rgba(255, 255, 255, 0.05);\r\n                        border-radius: 3px;\r\n                    }\r\n\r\n                    .install-logs::-webkit-scrollbar-thumb {\r\n                        background: rgba(255, 255, 255, 0.2);\r\n                        border-radius: 3px;\r\n                    }\r\n\r\n                    .install-logs::-webkit-scrollbar-thumb:hover {\r\n                        background: rgba(255, 255, 255, 0.3);\r\n                    }\r\n\r\n                    .plugin-actions {\r\n                        display: flex;\r\n                        gap: var(--space-2);\r\n                        flex-shrink: 0;\r\n                    }\r\n\r\n                    .btn-download {\r\n                        position: relative;\r\n                        width: 40px;\r\n                        height: 40px;\r\n                        flex-shrink: 0;\r\n                        display: flex;\r\n                        align-items: center;\r\n                        justify-content: center;\r\n                        background: var(--color-accent);\r\n                        color: #000;\r\n                        border: none;\r\n                        border-radius: var(--radius-md);\r\n                        cursor: pointer;\r\n                        transition: all var(--transition-fast);\r\n                    }\r\n\r\n                    .btn-download:hover:not(:disabled) {\r\n                        filter: brightness(1.1);\r\n                        transform: translateY(-2px);\r\n                        box-shadow: var(--shadow-md);\r\n                    }\r\n\r\n                    .btn-download:disabled {\r\n                        opacity: 0.5;\r\n                        cursor: not-allowed;\r\n                    }\r\n\r\n                    .btn-download.installed {\r\n                        background: var(--color-success);\r\n                    }\r\n\r\n                    .btn-uninstall {\r\n                        position: relative;\r\n                        width: 40px;\r\n                        height: 40px;\r\n                        flex-shrink: 0;\r\n                        display: flex;\r\n                        align-items: center;\r\n                        justify-content: center;\r\n                        background: rgba(239, 68, 68, 0.1);\r\n                        color: var(--color-error);\r\n                        border: 1px solid rgba(239, 68, 68, 0.2);\r\n                        border-radius: var(--radius-md);\r\n                        cursor: pointer;\r\n                        transition: all var(--transition-fast);\r\n                    }\r\n\r\n                    .btn-uninstall:hover {\r\n                        background: rgba(239, 68, 68, 0.2);\r\n                        border-color: rgba(239, 68, 68, 0.4);\r\n                        transform: translateY(-2px);\r\n                        box-shadow: var(--shadow-md);\r\n                    }\r\n                `}</style>\r\n            </div>\r\n        </div>,\r\n        document.body\r\n    )\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\ResourceMonitor.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":414,"column":69,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":414,"endColumn":72,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14524,14527],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14524,14527],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\nimport { useState, useEffect, useRef } from 'react'\r\nimport { hardwareService, type RealTimeStats } from '../services/hardwareService'\r\nimport { Cpu, HardDrive, Wifi, WifiOff, MemoryStick, Gpu, Play, Pause, RotateCcw } from 'lucide-react'\r\n\r\nconst GRAPH_POINTS = 60\r\n\r\ninterface ResourceMonitorProps {\r\n    visible?: {\r\n        cpu?: boolean\r\n        ram?: boolean\r\n        disk?: boolean\r\n        network?: boolean\r\n    }\r\n    onToggle?: (metric: 'cpu' | 'ram' | 'disk' | 'network') => void\r\n}\r\n\r\nexport default function ResourceMonitor({ onToggle }: ResourceMonitorProps) {\r\n    const scrollRef = useRef<HTMLDivElement>(null)\r\n    const [stats, setStats] = useState<RealTimeStats | null>(null)\r\n    const [cpuHistory, setCpuHistory] = useState<number[]>(new Array(GRAPH_POINTS).fill(0))\r\n    const [ramHistory, setRamHistory] = useState<number[]>(new Array(GRAPH_POINTS).fill(0))\r\n    const [gpuHistory, setGpuHistory] = useState<number[]>(new Array(GRAPH_POINTS).fill(0))\r\n    const [vramHistory, setVramHistory] = useState<number[]>(new Array(GRAPH_POINTS).fill(0))\r\n    const [diskIOHistory, setDiskIOHistory] = useState<number[]>(new Array(GRAPH_POINTS).fill(0))\r\n    const [networkHistory, setNetworkHistory] = useState<number[]>(new Array(GRAPH_POINTS).fill(0))\r\n\r\n    // Session timer state\r\n    const [timerSeconds, setTimerSeconds] = useState(0)\r\n    const [timerRunning, setTimerRunning] = useState(false)\r\n\r\n    // ALWAYS show all metrics for now\r\n    const showCpu = true\r\n    const showRam = true\r\n    const showDiskIO = true\r\n    const showNetwork = true\r\n    const showGpu = true\r\n    const showVram = true\r\n    const showTimer = true\r\n\r\n    // Load initial state\r\n    useEffect(() => {\r\n        const savedTime = localStorage.getItem('session-timer-seconds')\r\n        const savedRunning = localStorage.getItem('session-timer-running')\r\n        if (savedTime) setTimerSeconds(parseInt(savedTime, 10))\r\n        if (savedRunning === 'true') setTimerRunning(true)\r\n    }, [])\r\n\r\n    // Timer persistence\r\n    useEffect(() => {\r\n        localStorage.setItem('session-timer-seconds', timerSeconds.toString())\r\n    }, [timerSeconds])\r\n\r\n    useEffect(() => {\r\n        localStorage.setItem('session-timer-running', timerRunning.toString())\r\n    }, [timerRunning])\r\n\r\n    // Timer tick\r\n    useEffect(() => {\r\n        if (!timerRunning) return\r\n        const interval = setInterval(() => {\r\n            setTimerSeconds(prev => prev + 1)\r\n        }, 1000)\r\n        return () => clearInterval(interval)\r\n    }, [timerRunning])\r\n\r\n    // Resource monitoring\r\n    useEffect(() => {\r\n        const cleanup = hardwareService.startResourceMonitoring((newStats) => {\r\n            setStats(newStats)\r\n            setCpuHistory(prev => [...prev.slice(1), newStats.cpuUsage])\r\n            setRamHistory(prev => [...prev.slice(1), (newStats.ramUsage / newStats.ramTotal) * 100])\r\n            setGpuHistory(prev => [...prev.slice(1), newStats.gpuUsage])\r\n            setVramHistory(prev => [...prev.slice(1), (newStats.vramUsage / newStats.vramTotal) * 100])\r\n            setDiskIOHistory(prev => {\r\n                // Normalize to 0-100 scale (0-100 MB/s)\r\n                const normalized = Math.min((newStats.diskIOSpeed / 100) * 100, 100)\r\n                return [...prev.slice(1), normalized]\r\n            })\r\n            setNetworkHistory(prev => {\r\n                const lat = newStats.networkLatency || 0\r\n                const latPercent = Math.min((lat / 500) * 100, 100)\r\n                return [...prev.slice(1), newStats.networkConnected ? latPercent : 0]\r\n            })\r\n        })\r\n        return cleanup\r\n    }, [])\r\n\r\n    // Mouse wheel horizontal scroll\r\n    useEffect(() => {\r\n        const element = scrollRef.current\r\n        if (!element) return\r\n\r\n        const handleWheel = (e: WheelEvent) => {\r\n            // Check if horizontal scroll is already happening or if it's primary vertical\r\n            if (Math.abs(e.deltaX) < Math.abs(e.deltaY)) {\r\n                e.preventDefault()\r\n                element.scrollLeft += e.deltaY\r\n            }\r\n        }\r\n\r\n        element.addEventListener('wheel', handleWheel, { passive: false })\r\n        return () => element.removeEventListener('wheel', handleWheel)\r\n    }, [])\r\n\r\n    const displayStats = stats || {\r\n        cpuUsage: 0,\r\n        ramUsage: 0,\r\n        ramTotal: 1,\r\n        diskIOSpeed: 0,\r\n        networkConnected: true,\r\n        networkLatency: 0,\r\n        gpuUsage: 0,\r\n        vramUsage: 0,\r\n        vramTotal: 1\r\n    }\r\n\r\n    const formatTime = (seconds: number) => {\r\n        const hours = Math.floor(seconds / 3600)\r\n        const mins = Math.floor((seconds % 3600) / 60)\r\n        const secs = seconds % 60\r\n        return {\r\n            h: [Math.floor(hours / 10), hours % 10],\r\n            m: [Math.floor(mins / 10), mins % 10],\r\n            s: [Math.floor(secs / 10), secs % 10]\r\n        }\r\n    }\r\n\r\n    const { h, m, s } = formatTime(timerSeconds)\r\n\r\n    return (\r\n        <div className=\"resource-monitor-compact\" ref={scrollRef}>\r\n            <div className=\"metrics-scroll-content\">\r\n                {showCpu && (\r\n                    <MiniGraph\r\n                        icon={<Cpu size={11} />}\r\n                        label=\"CPU\"\r\n                        value={`${displayStats.cpuUsage}%`}\r\n                        history={cpuHistory}\r\n                        color=\"#007AFF\"\r\n                        onClick={() => onToggle?.('cpu')}\r\n                    />\r\n                )}\r\n\r\n                {showRam && (\r\n                    <MiniGraph\r\n                        icon={<MemoryStick size={11} />}\r\n                        label=\"RAM\"\r\n                        value={`${Math.round((displayStats.ramUsage / displayStats.ramTotal) * 100)}%`}\r\n                        history={ramHistory}\r\n                        color=\"#34C759\"\r\n                        onClick={() => onToggle?.('ram')}\r\n                    />\r\n                )}\r\n\r\n                {showGpu && (\r\n                    <MiniGraph\r\n                        icon={<Gpu size={11} />}\r\n                        label=\"GPU\"\r\n                        value={`${displayStats.gpuUsage}%`}\r\n                        history={gpuHistory}\r\n                        color=\"#AF52DE\"\r\n                        onClick={() => { }}\r\n                    />\r\n                )}\r\n\r\n                {showVram && (\r\n                    <MiniGraph\r\n                        icon={<MemoryStick size={11} />}\r\n                        label=\"VRAM\"\r\n                        value={`${Math.round((displayStats.vramUsage / displayStats.vramTotal) * 100)}%`}\r\n                        history={vramHistory}\r\n                        color=\"#FF9500\"\r\n                        onClick={() => { }}\r\n                    />\r\n                )}\r\n\r\n                {showDiskIO && (\r\n                    <MiniGraph\r\n                        icon={<HardDrive size={11} />}\r\n                        label=\"I/O\"\r\n                        value={`${displayStats.diskIOSpeed.toFixed(1)}MB/s`}\r\n                        history={diskIOHistory}\r\n                        color=\"#FF2D55\"\r\n                        onClick={() => onToggle?.('disk')}\r\n                    />\r\n                )}\r\n\r\n                {showNetwork && (\r\n                    <MiniGraph\r\n                        icon={displayStats.networkConnected ? <Wifi size={11} /> : <WifiOff size={11} />}\r\n                        label=\"NET\"\r\n                        value={displayStats.networkConnected ? `${displayStats.networkLatency || 0}ms` : 'OFF'}\r\n                        history={networkHistory}\r\n                        color={displayStats.networkConnected ? \"#5AC8FA\" : \"#FF3B30\"}\r\n                        onClick={() => onToggle?.('network')}\r\n                    />\r\n                )}\r\n\r\n                {showTimer && (\r\n                    <div className=\"timer-item\">\r\n                        <div className={`timer-status-dot ${timerRunning ? 'active' : ''}`} />\r\n                        <div className=\"animated-timer\">\r\n                            <Digit value={h[0]} />\r\n                            <Digit value={h[1]} />\r\n                            <span className=\"timer-colon\">:</span>\r\n                            <Digit value={m[0]} />\r\n                            <Digit value={m[1]} />\r\n                            <span className=\"timer-colon\">:</span>\r\n                            <Digit value={s[0]} />\r\n                            <Digit value={s[1]} />\r\n                        </div>\r\n                        <div className=\"timer-controls\">\r\n                            <button className=\"timer-btn\" onClick={() => setTimerRunning(!timerRunning)} title={timerRunning ? \"Pause\" : \"Start\"}>\r\n                                {timerRunning ? <Pause size={10} /> : <Play size={10} />}\r\n                            </button>\r\n                            <button className=\"timer-btn\" onClick={() => { setTimerSeconds(0); setTimerRunning(false); }} title=\"Reset\">\r\n                                <RotateCcw size={10} />\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n            </div>\r\n\r\n            <style>{`\r\n        .resource-monitor-compact {\r\n          display: flex;\r\n          align-items: center;\r\n          height: 38px;\r\n          width: 100%;\r\n          overflow-x: auto;\r\n          overflow-y: hidden;\r\n          scrollbar-width: none;\r\n          -ms-overflow-style: none;\r\n          scroll-behavior: smooth;\r\n        }\r\n        \r\n        .resource-monitor-compact::-webkit-scrollbar {\r\n          display: none;\r\n        }\r\n\r\n        .metrics-scroll-content {\r\n          display: flex;\r\n          align-items: center;\r\n          gap: 8px;\r\n          padding: 0 12px;\r\n          flex-shrink: 0;\r\n        }\r\n\r\n        .mini-stat-item, .mini-graph-item {\r\n          display: flex;\r\n          align-items: center;\r\n          gap: 6px;\r\n          height: 28px;\r\n          padding: 0 10px;\r\n          background: rgba(255, 255, 255, 0.05);\r\n          backdrop-filter: blur(20px);\r\n          border-radius: 8px;\r\n          border: 0.5px solid rgba(255, 255, 255, 0.1);\r\n          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1), \r\n                      inset 0 1px 0 rgba(255, 255, 255, 0.1);\r\n          cursor: pointer;\r\n          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\r\n          flex-shrink: 0;\r\n        }\r\n\r\n        .mini-stat-item:hover, .mini-graph-item:hover {\r\n          background: rgba(255, 255, 255, 0.08);\r\n          border-color: rgba(255, 255, 255, 0.15);\r\n          transform: translateY(-1px);\r\n        }\r\n\r\n        .stat-label, .graph-label {\r\n          font-size: 9px;\r\n          font-weight: 600;\r\n          color: rgba(255, 255, 255, 0.6);\r\n          letter-spacing: 0.02em;\r\n          font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', system-ui, sans-serif;\r\n        }\r\n\r\n        .stat-value, .graph-value {\r\n          font-size: 10px;\r\n          font-weight: 500;\r\n          color: rgba(255, 255, 255, 0.95);\r\n          font-family: -apple-system, BlinkMacSystemFont, 'SF Mono', 'Menlo', monospace;\r\n          min-width: 32px;\r\n          text-align: right;\r\n        }\r\n\r\n        .mini-sparkline {\r\n          width: 70px;\r\n          height: 18px;\r\n          margin-left: 4px;\r\n          opacity: 0.95;\r\n        }\r\n\r\n        .timer-item {\r\n          display: flex;\r\n          align-items: center;\r\n          gap: 8px;\r\n          height: 28px;\r\n          padding: 0 10px;\r\n          background: rgba(255, 255, 255, 0.05);\r\n          backdrop-filter: blur(20px);\r\n          border-radius: 8px;\r\n          border: 0.5px solid rgba(255, 255, 255, 0.1);\r\n          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1), \r\n                      inset 0 1px 0 rgba(255, 255, 255, 0.1);\r\n          flex-shrink: 0;\r\n        }\r\n\r\n        .timer-status-dot {\r\n          width: 6px;\r\n          height: 6px;\r\n          border-radius: 50%;\r\n          background: rgba(255, 255, 255, 0.2);\r\n        }\r\n\r\n        .timer-status-dot.active {\r\n          background: #34C759;\r\n          box-shadow: 0 0 8px #34C759;\r\n          animation: pulse 1.5s infinite;\r\n        }\r\n\r\n        @keyframes pulse {\r\n          0% { opacity: 1; }\r\n          50% { opacity: 0.4; transform: scale(0.8); }\r\n          100% { opacity: 1; }\r\n        }\r\n\r\n        .animated-timer {\r\n          display: flex;\r\n          align-items: center;\r\n          gap: 0;\r\n          font-family: -apple-system, BlinkMacSystemFont, 'SF Mono', 'Menlo', monospace;\r\n          font-size: 11px;\r\n          font-weight: 500;\r\n          color: rgba(255, 255, 255, 0.95);\r\n        }\r\n\r\n        .timer-colon {\r\n          margin: 0 1px;\r\n          opacity: 0.4;\r\n          font-weight: 400;\r\n        }\r\n\r\n        .digit-container {\r\n          height: 14px;\r\n          width: 7px;\r\n          overflow: hidden;\r\n          position: relative;\r\n        }\r\n\r\n        .digit-reel {\r\n          display: flex;\r\n          flex-direction: column;\r\n          transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);\r\n        }\r\n\r\n        .digit-num {\r\n          height: 14px;\r\n          display: flex;\r\n          align-items: center;\r\n          justify-content: center;\r\n        }\r\n\r\n        .timer-controls {\r\n          display: flex;\r\n          gap: 4px;\r\n          margin-left: 4px;\r\n        }\r\n\r\n        .timer-btn {\r\n          width: 22px;\r\n          height: 22px;\r\n          display: flex;\r\n          align-items: center;\r\n          justify-content: center;\r\n          background: rgba(255, 255, 255, 0.07);\r\n          border: 0.5px solid rgba(255, 255, 255, 0.15);\r\n          border-radius: 6px;\r\n          cursor: pointer;\r\n          transition: all 0.2s ease;\r\n          color: rgba(255, 255, 255, 0.8);\r\n        }\r\n\r\n        .timer-btn:hover {\r\n          background: rgba(255, 255, 255, 0.12);\r\n          color: rgba(255, 255, 255, 1);\r\n        }\r\n\r\n        .timer-btn:active {\r\n          transform: scale(0.9);\r\n        }\r\n      `}</style>\r\n        </div>\r\n    )\r\n}\r\n\r\nfunction Digit({ value }: { value: number }) {\r\n    return (\r\n        <div className=\"digit-container\">\r\n            <div className=\"digit-reel\" style={{ transform: `translateY(-${value * 10}%)` }}>\r\n                {[0, 1, 2, 3, 4, 5, 6, 7, 8, 9].map(n => (\r\n                    <div key={n} className=\"digit-num\">{n}</div>\r\n                ))}\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n\r\nfunction MiniGraph({ icon, label, value, history, color, onClick }: any) {\r\n    const width = 70\r\n    const height = 18\r\n\r\n    const points = history.map((val: number, i: number) => {\r\n        const x = (i / (history.length - 1)) * width\r\n        const y = height - (val / 100) * height\r\n        return `${x},${y}`\r\n    }).join(' ')\r\n\r\n    const pathD = `M ${points}`\r\n    const areaD = `M 0,${height} ${points} L ${width},${height} Z`\r\n\r\n    return (\r\n        <div className=\"mini-graph-item\" onClick={onClick}>\r\n            {icon}\r\n            <span className=\"graph-label\">{label}</span>\r\n            <span className=\"graph-value\">{value}</span>\r\n            <div className=\"mini-sparkline\">\r\n                <svg viewBox={`0 0 ${width} ${height}`} preserveAspectRatio=\"none\" style={{ width: '100%', height: '100%', display: 'block' }}>\r\n                    <defs>\r\n                        <linearGradient id={`grad-${label}`} x1=\"0\" x2=\"0\" y1=\"0\" y2=\"1\">\r\n                            <stop offset=\"0%\" stopColor={color} stopOpacity=\"0.35\" />\r\n                            <stop offset=\"100%\" stopColor={color} stopOpacity=\"0.05\" />\r\n                        </linearGradient>\r\n                    </defs>\r\n                    <path d={areaD} fill={`url(#grad-${label})`} />\r\n                    <path\r\n                        d={pathD}\r\n                        fill=\"none\"\r\n                        stroke={color}\r\n                        strokeWidth=\"2\"\r\n                        strokeLinecap=\"round\"\r\n                        strokeLinejoin=\"round\"\r\n                        vectorEffect=\"non-scaling-stroke\"\r\n                    />\r\n                </svg>\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\SettingsPanel.tsx","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":69,"column":11,"nodeType":"MemberExpression","messageId":"unexpected","endLine":69,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[2150,2190],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":79,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":79,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[2346,2520],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":88,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":88,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[2745,2799],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":93,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":93,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[2941,3048],"text":""},"desc":"Remove the console.log()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n// Settings Panel - Space settings including encryption and integrations\r\nimport { useState, useEffect } from 'react'\r\nimport { useAppStore } from '../stores/appStore'\r\nimport { useMemberStore } from '../stores/memberStore'\r\nimport { encryptionService } from '../services/encryptionService'\r\nimport MemberManagement from './MemberManagement'\r\nimport {\r\n  Settings,\r\n  Lock,\r\n  Eye,\r\n  EyeOff,\r\n  Link,\r\n  Github,\r\n  MessageSquare,\r\n  Check,\r\n  Users,\r\n  AlertTriangle\r\n} from 'lucide-react'\r\n\r\ninterface SpaceSettings {\r\n  encryptionEnabled: boolean\r\n  roomPassword: string\r\n  githubConnected: boolean\r\n  slackWebhook: string\r\n}\r\n\r\nexport default function SettingsPanel({ onClose }: { readonly onClose: () => void }) {\r\n  const { currentSpace } = useAppStore()\r\n  const { getMyRole, getMembers } = useMemberStore()\r\n  const [settings, setSettings] = useState<SpaceSettings>({\r\n    encryptionEnabled: false,\r\n    roomPassword: '',\r\n    githubConnected: false,\r\n    slackWebhook: ''\r\n  })\r\n  const [showPassword, setShowPassword] = useState(false)\r\n  const [saved, setSaved] = useState(false)\r\n  const [showMembers, setShowMembers] = useState(false)\r\n\r\n  useEffect(() => {\r\n    const handleEsc = (e: KeyboardEvent) => {\r\n      if (e.key === 'Escape') onClose()\r\n    }\r\n    globalThis.addEventListener('keydown', handleEsc)\r\n    return () => globalThis.removeEventListener('keydown', handleEsc)\r\n  }, [onClose])\r\n\r\n  const myRole = currentSpace ? getMyRole(currentSpace.id) : 'member'\r\n  const isAdmin = myRole === 'owner' || myRole === 'admin'\r\n  const memberCount = currentSpace ? getMembers(currentSpace.id).length : 0\r\n\r\n  const getRoleColor = (role: string) => {\r\n    if (role === 'owner') return 'var(--color-warning)'\r\n    if (role === 'admin') return 'var(--color-accent)'\r\n    return 'var(--color-text-muted)'\r\n  }\r\n\r\n  useEffect(() => {\r\n    // Load settings from localStorage\r\n    if (currentSpace) {\r\n      const stored = localStorage.getItem(`space-settings-${currentSpace.id}`)\r\n      if (stored) {\r\n        try {\r\n          setSettings(JSON.parse(stored))\r\n        } catch {\r\n          console.error('Failed to load settings')\r\n        }\r\n      }\r\n    }\r\n  }, [currentSpace])\r\n\r\n  const handleSave = async () => {\r\n    if (!currentSpace) return\r\n\r\n    // Log what we're saving\r\n    console.log('[Settings] Saving:', {\r\n      encryptionEnabled: settings.encryptionEnabled,\r\n      hasPassword: !!settings.roomPassword,\r\n      spaceId: currentSpace.id\r\n    })\r\n\r\n    // If encryption is enabled and password provided, set room key\r\n    if (settings.encryptionEnabled && settings.roomPassword) {\r\n      await encryptionService.setRoomKey(currentSpace.id, settings.roomPassword)\r\n      console.log('[Settings] Encryption key set for space')\r\n    }\r\n\r\n    // Save settings to localStorage\r\n    localStorage.setItem(`space-settings-${currentSpace.id}`, JSON.stringify(settings))\r\n    console.log('[Settings] Saved to localStorage:', localStorage.getItem(`space-settings-${currentSpace.id}`))\r\n\r\n    setSaved(true)\r\n    setTimeout(() => {\r\n      setSaved(false)\r\n      // Reload page to reinitialize encryption provider with new settings\r\n      if (settings.encryptionEnabled && settings.roomPassword) {\r\n        globalThis.window.location.reload()\r\n      }\r\n    }, 1000)\r\n  }\r\n\r\n  if (!currentSpace) return null\r\n\r\n  return (\r\n    <div className=\"settings-container\">\r\n      <button\r\n        type=\"button\"\r\n        className=\"settings-overlay\"\r\n        onClick={onClose}\r\n        aria-label=\"Close settings\"\r\n      />\r\n      <dialog\r\n        className=\"settings-panel\"\r\n        open\r\n        aria-labelledby=\"settings-title\"\r\n      >\r\n        <div className=\"settings-header\">\r\n          <h2 id=\"settings-title\" style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>\r\n            <Settings size={20} /> Space Settings\r\n          </h2>\r\n          <button type=\"button\" className=\"close-btn\" onClick={onClose}>Ã—</button>\r\n        </div>\r\n\r\n        <div className=\"settings-content\">\r\n          {/* Encryption Section */}\r\n          <section className=\"settings-section\">\r\n            <h3 style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>\r\n              <Lock size={16} /> Encryption\r\n            </h3>\r\n            <p className=\"section-desc\">\r\n              End-to-end encryption protects your data during P2P sync\r\n            </p>\r\n\r\n            <label className=\"setting-row\">\r\n              <span>Enable Encryption</span>\r\n              <input\r\n                type=\"checkbox\"\r\n                checked={settings.encryptionEnabled}\r\n                onChange={(e) => setSettings({ ...settings, encryptionEnabled: e.target.checked })}\r\n              />\r\n            </label>\r\n\r\n            {settings.encryptionEnabled && (\r\n              <div className=\"password-field\">\r\n                <label htmlFor=\"room-password\">Room Password</label>\r\n                <div className=\"password-input-row\">\r\n                  <input\r\n                    id=\"room-password\"\r\n                    type={showPassword ? 'text' : 'password'}\r\n                    className=\"input\"\r\n                    placeholder=\"Shared password for this space\"\r\n                    value={settings.roomPassword}\r\n                    onChange={(e) => setSettings({ ...settings, roomPassword: e.target.value })}\r\n                  />\r\n                  <button\r\n                    type=\"button\"\r\n                    className=\"btn btn-ghost\"\r\n                    onClick={() => setShowPassword(!showPassword)}\r\n                  >\r\n                    {showPassword ? <EyeOff size={16} /> : <Eye size={16} />}\r\n                  </button>\r\n                </div>\r\n                <p className=\"hint\">Share this password with collaborators</p>\r\n              </div>\r\n            )}\r\n          </section>\r\n\r\n          {/* Integrations Section */}\r\n          <section className=\"settings-section\">\r\n            <h3 style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>\r\n              <Link size={16} /> Integrations\r\n            </h3>\r\n            <p className=\"section-desc\">\r\n              Connect external services for enhanced workflow\r\n            </p>\r\n\r\n            <div className=\"integration-item\">\r\n              <div className=\"integration-info\">\r\n                <span className=\"integration-icon\"><Github size={24} /></span>\r\n                <div>\r\n                  <span className=\"integration-name\">GitHub</span>\r\n                  <span className=\"integration-status\" style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>\r\n                    {settings.githubConnected ? <><Check size={12} className=\"text-success\" /> Connected</> : 'Not connected'}\r\n                  </span>\r\n                </div>\r\n              </div>\r\n              <button\r\n                className=\"btn btn-secondary\"\r\n                onClick={() => setSettings({ ...settings, githubConnected: !settings.githubConnected })}\r\n              >\r\n                {settings.githubConnected ? 'Disconnect' : 'Connect'}\r\n              </button>\r\n            </div>\r\n\r\n            <div className=\"integration-item\">\r\n              <div className=\"integration-info\">\r\n                <span className=\"integration-icon\"><MessageSquare size={24} /></span>\r\n                <div>\r\n                  <span className=\"integration-name\">Slack Webhook</span>\r\n                  <span className=\"integration-status\" style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>\r\n                    {settings.slackWebhook ? <><Check size={12} className=\"text-success\" /> Configured</> : 'Not configured'}\r\n                  </span>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {settings.slackWebhook ? (\r\n              <button\r\n                type=\"button\"\r\n                className=\"btn btn-ghost\"\r\n                onClick={() => setSettings({ ...settings, slackWebhook: '' })}\r\n              >\r\n                Remove Webhook\r\n              </button>\r\n            ) : (\r\n              <input\r\n                type=\"url\"\r\n                className=\"input webhook-input\"\r\n                placeholder=\"https://hooks.slack.com/services/...\"\r\n                onChange={(e) => setSettings({ ...settings, slackWebhook: e.target.value })}\r\n              />\r\n            )}\r\n          </section>\r\n\r\n          {/* Members Section (Admin Only) */}\r\n          <section className=\"settings-section\">\r\n            <h3 style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>\r\n              <Users size={16} /> Members\r\n            </h3>\r\n            <p className=\"section-desc\">\r\n              Manage workspace members and permissions\r\n            </p>\r\n\r\n            <div className=\"member-summary\">\r\n              <span>{memberCount} member{memberCount === 1 ? '' : 's'}</span>\r\n              <span className=\"role-badge\" style={{ color: getRoleColor(myRole) }}>\r\n                Your role: {myRole.charAt(0).toUpperCase() + myRole.slice(1)}\r\n              </span>\r\n            </div>\r\n\r\n            {isAdmin && (\r\n              <button\r\n                className=\"btn btn-secondary\"\r\n                onClick={() => setShowMembers(true)}\r\n              >\r\n                Manage Members\r\n              </button>\r\n            )}\r\n          </section>\r\n\r\n          {/* Danger Zone */}\r\n          <section className=\"settings-section danger-zone\">\r\n            <h3 style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>\r\n              <AlertTriangle size={16} /> Danger Zone\r\n            </h3>\r\n            <button className=\"btn btn-danger\">\r\n              Delete Space\r\n            </button>\r\n          </section>\r\n        </div>\r\n\r\n        <div className=\"settings-footer\">\r\n          <button className=\"btn btn-ghost\" onClick={onClose}>\r\n            Cancel\r\n          </button>\r\n          <button className=\"btn btn-primary\" onClick={handleSave} style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>\r\n            {saved ? <><Check size={14} /> Saved</> : 'Save Settings'}\r\n          </button>\r\n        </div>\r\n\r\n        <style>{`\r\n          .settings-overlay {\r\n            position: fixed;\r\n            top: 0;\r\n            left: 0;\r\n            right: 0;\r\n            bottom: 0;\r\n            background: rgba(0,0,0,0.8);\r\n            display: flex;\r\n            align-items: center;\r\n            justify-content: center;\r\n            z-index: 1000;\r\n          }\r\n          \r\n          .settings-panel {\r\n            position: fixed;\r\n            top: 50%;\r\n            left: 50%;\r\n            transform: translate(-50%, -50%);\r\n            width: 500px;\r\n            max-height: 80vh;\r\n            background: var(--color-surface);\r\n            border: 1px solid var(--color-border);\r\n            border-radius: var(--radius-xl);\r\n            display: flex;\r\n            flex-direction: column;\r\n            overflow: hidden;\r\n            z-index: 1001;\r\n            margin: 0;\r\n            padding: 0;\r\n          }\r\n          \r\n          .settings-header {\r\n            display: flex;\r\n            justify-content: space-between;\r\n            align-items: center;\r\n            padding: var(--space-4);\r\n            border-bottom: 1px solid var(--color-border);\r\n          }\r\n          \r\n          .settings-header h2 {\r\n            font-size: var(--text-lg);\r\n            font-weight: var(--font-medium);\r\n            margin: 0;\r\n          }\r\n          \r\n          .close-btn {\r\n            width: 28px;\r\n            height: 28px;\r\n            font-size: 18px;\r\n            color: var(--color-text-muted);\r\n          }\r\n          \r\n          .close-btn:hover {\r\n            color: var(--color-text);\r\n          }\r\n          \r\n          .settings-content {\r\n            flex: 1;\r\n            overflow-y: auto;\r\n            padding: var(--space-4);\r\n          }\r\n          \r\n          .settings-section {\r\n            margin-bottom: var(--space-6);\r\n          }\r\n          \r\n          .settings-section h3 {\r\n            font-size: var(--text-sm);\r\n            font-weight: var(--font-medium);\r\n            color: var(--color-text);\r\n            margin-bottom: var(--space-2);\r\n          }\r\n          \r\n          .section-desc {\r\n            font-size: var(--text-xs);\r\n            color: var(--color-text-muted);\r\n            margin-bottom: var(--space-3);\r\n          }\r\n          \r\n          .setting-row {\r\n            display: flex;\r\n            justify-content: space-between;\r\n            align-items: center;\r\n            padding: var(--space-2) 0;\r\n            font-size: var(--text-sm);\r\n            cursor: pointer;\r\n          }\r\n          \r\n          .setting-row input[type=\"checkbox\"] {\r\n            width: 18px;\r\n            height: 18px;\r\n            accent-color: var(--color-accent);\r\n          }\r\n          \r\n          .password-field {\r\n            margin-top: var(--space-3);\r\n          }\r\n          \r\n          .password-field label {\r\n            display: block;\r\n            font-size: var(--text-xs);\r\n            color: var(--color-text-secondary);\r\n            margin-bottom: var(--space-2);\r\n          }\r\n          \r\n          .password-input-row {\r\n            display: flex;\r\n            gap: var(--space-2);\r\n          }\r\n          \r\n          .password-input-row .input {\r\n            flex: 1;\r\n          }\r\n          \r\n          .hint {\r\n            font-size: var(--text-xs);\r\n            color: var(--color-text-muted);\r\n            margin-top: var(--space-1);\r\n          }\r\n          \r\n          .integration-item {\r\n            display: flex;\r\n            justify-content: space-between;\r\n            align-items: center;\r\n            padding: var(--space-3);\r\n            background: var(--color-surface-elevated);\r\n            border-radius: var(--radius-md);\r\n            margin-bottom: var(--space-2);\r\n          }\r\n          \r\n          .integration-info {\r\n            display: flex;\r\n            align-items: center;\r\n            gap: var(--space-3);\r\n          }\r\n          \r\n          .integration-icon {\r\n            font-size: 24px;\r\n          }\r\n          \r\n          .integration-name {\r\n            display: block;\r\n            font-size: var(--text-sm);\r\n            font-weight: var(--font-medium);\r\n          }\r\n          \r\n          .integration-status {\r\n            display: block;\r\n            font-size: var(--text-xs);\r\n            color: var(--color-text-muted);\r\n          }\r\n          \r\n          .webhook-input {\r\n            margin-top: var(--space-2);\r\n          }\r\n          \r\n          .danger-zone {\r\n            padding-top: var(--space-4);\r\n            border-top: 1px solid var(--color-border);\r\n          }\r\n          \r\n          .btn-danger {\r\n            background: var(--color-error);\r\n            color: white;\r\n          }\r\n          \r\n          .settings-footer {\r\n            display: flex;\r\n            justify-content: flex-end;\r\n            gap: var(--space-2);\r\n            padding: var(--space-4);\r\n            border-top: 1px solid var(--color-border);\r\n          }\r\n          \r\n          .member-summary {\r\n            display: flex;\r\n            justify-content: space-between;\r\n            align-items: center;\r\n            padding: var(--space-3);\r\n            background: var(--color-surface-elevated);\r\n            border-radius: var(--radius-md);\r\n            margin-bottom: var(--space-3);\r\n            font-size: var(--text-sm);\r\n          }\r\n          \r\n          .role-badge {\r\n            font-weight: var(--font-medium);\r\n            text-transform: uppercase;\r\n            font-size: var(--text-xs);\r\n            letter-spacing: 0.05em;\r\n          }\r\n        `}</style>\r\n      </dialog>\r\n\r\n      {\r\n        showMembers && currentSpace && (\r\n          <MemberManagement\r\n            spaceId={currentSpace.id}\r\n            onClose={() => setShowMembers(false)}\r\n          />\r\n        )\r\n      }\r\n    </div >\r\n  )\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\Sidebar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\StartupLayout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\TaskBoard.tsx","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":116,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":116,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[3994,4047],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":137,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":137,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[4650,4703],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":149,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":149,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[5035,5078],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":519,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":519,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16156,16159],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16156,16159],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\nimport { useState, useCallback } from 'react'\r\nimport { useAppStore } from '../stores/appStore'\r\nimport { useYDoc, useYArray } from '../hooks/useYjs'\r\nimport { offlineLLMService, type ChatMessage } from '../services/offlineLLMService'\r\nimport { useModelStore } from '../stores/modelStore'\r\nimport UnifiedSettingsPanel from './UnifiedSettingsPanel'\r\nimport { Plus, X, Sparkles, CheckCircle2, Clock, Trash2, Save } from 'lucide-react'\r\n\r\ninterface Task {\r\n  id: string\r\n  title: string\r\n  description?: string\r\n  status: 'todo' | 'in-progress' | 'done'\r\n  priority: 'low' | 'medium' | 'high'\r\n  tags: string[]\r\n  createdAt: number\r\n  dueDate?: number\r\n  subtasks?: { id: string; title: string; completed: boolean }[]\r\n}\r\n\r\nconst COLUMNS = [\r\n  { id: 'todo', title: 'To Do', color: 'var(--color-text-tertiary)' },\r\n  { id: 'in-progress', title: 'In Progress', color: 'var(--color-accent)' },\r\n  { id: 'done', title: 'Done', color: 'var(--color-success)' },\r\n] as const\r\n\r\nexport default function TaskBoard() {\r\n  const { currentSpace } = useAppStore()\r\n  const { doc, peerCount } = useYDoc(currentSpace?.id ?? null)\r\n  const { items: tasks, push, update, remove } = useYArray<Task>(doc, 'tasks')\r\n  const { loadedModelId } = useModelStore()\r\n\r\n  const [draggingTask, setDraggingTask] = useState<string | null>(null)\r\n  const [editingTask, setEditingTask] = useState<Task | null>(null)\r\n  const [isAiLoading, setIsAiLoading] = useState(false)\r\n  const [showModelSelector, setShowModelSelector] = useState(false)\r\n\r\n  // Drag & Drop\r\n  const handleDragStart = (taskId: string) => setDraggingTask(taskId)\r\n  const handleDragOver = (e: React.DragEvent) => e.preventDefault()\r\n\r\n  const handleDrop = useCallback((status: Task['status']) => {\r\n    if (!draggingTask) return\r\n    const taskIndex = tasks.findIndex(t => t.id === draggingTask)\r\n    if (taskIndex !== -1) {\r\n      const task = tasks[taskIndex]\r\n      if (task.status !== status) {\r\n        update(taskIndex, { ...task, status })\r\n      }\r\n    }\r\n    setDraggingTask(null)\r\n  }, [draggingTask, tasks, update])\r\n\r\n  // CRUD\r\n  const handleAddTask = (status: Task['status'] = 'todo') => {\r\n    const newTask: Task = {\r\n      id: crypto.randomUUID(),\r\n      title: 'New Task',\r\n      status,\r\n      priority: 'medium',\r\n      tags: [],\r\n      createdAt: Date.now(),\r\n      subtasks: []\r\n    }\r\n    push(newTask)\r\n    setEditingTask(newTask)\r\n  }\r\n\r\n  const handleDeleteTask = (taskId: string) => {\r\n    const index = tasks.findIndex(t => t.id === taskId)\r\n    if (index !== -1) remove(index)\r\n    if (editingTask?.id === taskId) setEditingTask(null)\r\n  }\r\n\r\n  const handleSaveTask = (updatedTask: Task) => {\r\n    const index = tasks.findIndex(t => t.id === updatedTask.id)\r\n    if (index !== -1) {\r\n      update(index, updatedTask)\r\n    }\r\n    setEditingTask(null)\r\n  }\r\n\r\n  // AI Helper - Now uses offline models\r\n  // Returns the generated subtasks so modal can update its local state\r\n  const handleAiBreakdown = async (task: Task): Promise<{ id: string; title: string; completed: boolean }[]> => {\r\n    // Check if a model is loaded\r\n    if (!loadedModelId) {\r\n      // Prompt user to select a model\r\n      setShowModelSelector(true)\r\n      return []\r\n    }\r\n\r\n    setIsAiLoading(true)\r\n    try {\r\n      const prompt = `Break down this task into 3-5 actionable subtasks: \"${task.title}\". \r\n${task.description ? `Context: ${task.description}` : ''}\r\n\r\nReturn ONLY a JSON array of strings, for example:\r\n[\"First subtask\", \"Second subtask\", \"Third subtask\"]\r\n\r\nDo not include any other text.`\r\n\r\n      const history: ChatMessage[] = [\r\n        { role: 'system', content: 'You are a helpful task planning assistant. Respond only with the requested JSON array.' },\r\n        { role: 'user', content: prompt }\r\n      ]\r\n\r\n      let fullResponse = ''\r\n      await offlineLLMService.generateStream(history, (token) => {\r\n        fullResponse += token\r\n      }, { jsonSchema: undefined })\r\n\r\n      console.log('[TaskBoard] AI Response:', fullResponse)\r\n\r\n      // Parse JSON from response\r\n      let subtasks: string[] = []\r\n\r\n      try {\r\n        // Try to find JSON array in response\r\n        const jsonMatch = fullResponse.match(/\\[[\\s\\S]*?\\]/)\r\n        if (jsonMatch) {\r\n          subtasks = JSON.parse(jsonMatch[0])\r\n        }\r\n      } catch {\r\n        // Fallback: split by newlines\r\n        subtasks = fullResponse\r\n          .split('\\n')\r\n          .filter(l => l.trim().length > 0)\r\n          .map(l => l.replace(/^[-*â€¢]\\s*/, '').replace(/^\\d+\\.\\s*/, '').trim())\r\n          .filter(l => l.length > 0)\r\n          .slice(0, 5)\r\n      }\r\n\r\n      console.log('[TaskBoard] Parsed subtasks:', subtasks)\r\n\r\n      if (Array.isArray(subtasks) && subtasks.length > 0) {\r\n        const newSubtasks = subtasks.map(t => ({\r\n          id: crypto.randomUUID(),\r\n          title: typeof t === 'string' ? t : String(t),\r\n          completed: false\r\n        }))\r\n        return newSubtasks\r\n      }\r\n      return []\r\n    } catch (error) {\r\n      console.error('AI Breakdown failed', error)\r\n      alert('Failed to generate subtasks. Please try again.')\r\n      return []\r\n    } finally {\r\n      setIsAiLoading(false)\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"task-board\">\r\n      <div className=\"board-header\">\r\n        <div>\r\n          <h2>Project Tasks</h2>\r\n          <p className=\"subtitle\">{tasks.length} tasks â€¢ {peerCount > 0 ? `${peerCount} peers online` : 'Offline'}</p>\r\n        </div>\r\n        <button className=\"btn btn-primary\" onClick={() => handleAddTask('todo')}>\r\n          <Plus size={16} /> New Task\r\n        </button>\r\n      </div>\r\n\r\n      <div className=\"board-columns\">\r\n        {COLUMNS.map(column => (\r\n          <div\r\n            key={column.id}\r\n            className=\"column glass\"\r\n            onDragOver={handleDragOver}\r\n            onDrop={() => handleDrop(column.id)}\r\n          >\r\n            <div className=\"column-header\">\r\n              <div className=\"column-title-group\">\r\n                <span className=\"status-indicator\" style={{ background: column.color }} />\r\n                <h3>{column.title}</h3>\r\n                <span className=\"count-badge\">{tasks.filter(t => t.status === column.id).length}</span>\r\n              </div>\r\n              <button className=\"btn-icon-sm\" onClick={() => handleAddTask(column.id)}>\r\n                <Plus size={14} />\r\n              </button>\r\n            </div>\r\n\r\n            <div className=\"column-content\">\r\n              {tasks\r\n                .filter(task => task.status === column.id)\r\n                .map(task => (\r\n                  <TaskCard\r\n                    key={task.id}\r\n                    task={task}\r\n                    onClick={() => setEditingTask(task)}\r\n                    onDragStart={() => handleDragStart(task.id)}\r\n                    onDelete={() => handleDeleteTask(task.id)}\r\n                    isDragging={draggingTask === task.id}\r\n                    showDelete={column.id === 'done'}\r\n                  />\r\n                ))}\r\n            </div>\r\n          </div>\r\n        ))}\r\n      </div>\r\n\r\n      {editingTask && (\r\n        <TaskModal\r\n          task={editingTask}\r\n          onClose={() => setEditingTask(null)}\r\n          onSave={handleSaveTask}\r\n          onDelete={() => handleDeleteTask(editingTask.id)}\r\n          onAiBreakdown={(currentTask) => handleAiBreakdown(currentTask)}\r\n          isAiLoading={isAiLoading}\r\n        />\r\n      )}\r\n\r\n      {showModelSelector && (\r\n        <UnifiedSettingsPanel onClose={() => setShowModelSelector(false)} />\r\n      )}\r\n\r\n      <style>{`\r\n        .task-board {\r\n          height: 100%;\r\n          display: flex;\r\n          flex-direction: column;\r\n          background: var(--color-bg);\r\n          color: var(--color-text);\r\n        }\r\n        \r\n        .board-header {\r\n          padding: var(--space-5) var(--space-6);\r\n          display: flex;\r\n          justify-content: space-between;\r\n          align-items: center;\r\n          border-bottom: 1px solid var(--color-border-subtle);\r\n        }\r\n        \r\n        .subtitle {\r\n          font-size: var(--text-xs);\r\n          color: var(--color-text-tertiary);\r\n          margin-top: 2px;\r\n        }\r\n\r\n        .board-columns {\r\n          flex: 1;\r\n          display: flex;\r\n          gap: var(--space-4);\r\n          padding: var(--space-4);\r\n          overflow-x: auto;\r\n        }\r\n\r\n        .column {\r\n          flex: 1;\r\n          min-width: 300px;\r\n          max-width: 400px;\r\n          display: flex;\r\n          flex-direction: column;\r\n          background: rgba(10, 10, 10, 0.6);\r\n          backdrop-filter: blur(12px);\r\n          -webkit-backdrop-filter: blur(12px);\r\n          border-radius: var(--radius-lg);\r\n          border: 1px solid rgba(255, 255, 255, 0.1);\r\n          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);\r\n        }\r\n\r\n        .column-header {\r\n          padding: var(--space-3) var(--space-4);\r\n          display: flex;\r\n          justify-content: space-between;\r\n          align-items: center;\r\n          border-bottom: 1px solid var(--color-border-subtle);\r\n        }\r\n\r\n        .column-title-group {\r\n          display: flex;\r\n          align-items: center;\r\n          gap: var(--space-2);\r\n        }\r\n\r\n        .column-title-group h3 {\r\n          font-size: var(--text-sm);\r\n          font-weight: var(--font-medium);\r\n        }\r\n\r\n        .status-indicator {\r\n          width: 8px;\r\n          height: 8px;\r\n          border-radius: 50%;\r\n        }\r\n\r\n        .count-badge {\r\n          background: var(--color-surface-elevated);\r\n          padding: 2px 6px;\r\n          border-radius: var(--radius-sm);\r\n          font-size: var(--text-xs);\r\n          color: var(--color-text-tertiary);\r\n        }\r\n\r\n        .btn-icon-sm {\r\n          padding: 4px;\r\n          border-radius: var(--radius-sm);\r\n          color: var(--color-text-tertiary);\r\n          transition: all 0.2s;\r\n        }\r\n        \r\n        .btn-icon-sm:hover {\r\n          background: var(--color-surface-elevated);\r\n          color: var(--color-text);\r\n        }\r\n\r\n        .column-content {\r\n          flex: 1;\r\n          padding: var(--space-2);\r\n          overflow-y: auto;\r\n          display: flex;\r\n          flex-direction: column;\r\n          gap: var(--space-2);\r\n        }\r\n      `}</style>\r\n    </div>\r\n  )\r\n}\r\n\r\nfunction TaskCard({ task, onClick, onDragStart, onDelete, isDragging, showDelete }: {\r\n  task: Task;\r\n  onClick: () => void;\r\n  onDragStart: () => void;\r\n  onDelete: () => void;\r\n  isDragging: boolean;\r\n  showDelete: boolean;\r\n}) {\r\n  const [isHovered, setIsHovered] = useState(false)\r\n  const completedSubtasks = task.subtasks?.filter(s => s.completed).length || 0\r\n  const totalSubtasks = task.subtasks?.length || 0\r\n\r\n  const handleDelete = (e: React.MouseEvent) => {\r\n    e.stopPropagation()\r\n    if (window.confirm(`Delete \"${task.title}\"?`)) {\r\n      onDelete()\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div\r\n      className={`task-card glass-card ${isDragging ? 'dragging' : ''}`}\r\n      draggable\r\n      onDragStart={onDragStart}\r\n      onClick={onClick}\r\n      onMouseEnter={() => setIsHovered(true)}\r\n      onMouseLeave={() => setIsHovered(false)}\r\n    >\r\n      <div className=\"task-card-header\">\r\n        {showDelete && isHovered && (\r\n          <button className=\"delete-btn-card\" onClick={handleDelete} title=\"Delete task\">\r\n            <Trash2 size={14} />\r\n          </button>\r\n        )}\r\n        <span className={`priority-badge ${task.priority}`}>{task.priority}</span>\r\n        {task.dueDate && (\r\n          <span className=\"date-badge\">\r\n            <Clock size={10} /> {new Date(task.dueDate).toLocaleDateString()}\r\n          </span>\r\n        )}\r\n      </div>\r\n\r\n      <div className=\"task-card-title\">{task.title}</div>\r\n\r\n      {task.description && (\r\n        <div className=\"task-card-desc\">{task.description.slice(0, 60)}{task.description.length > 60 ? '...' : ''}</div>\r\n      )}\r\n\r\n      <div className=\"task-card-footer\">\r\n        {task.tags.length > 0 && (\r\n          <div className=\"tags-row\">\r\n            {task.tags.slice(0, 2).map(tag => (\r\n              <span key={tag} className=\"tag-mini\"># {tag}</span>\r\n            ))}\r\n            {task.tags.length > 2 && <span className=\"tag-more\">+{task.tags.length - 2}</span>}\r\n          </div>\r\n        )}\r\n\r\n        {totalSubtasks > 0 && (\r\n          <div className=\"subtask-indicator\" title={`${completedSubtasks}/${totalSubtasks} subtasks`}>\r\n            <CheckCircle2 size={12} /> {completedSubtasks}/{totalSubtasks}\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      <style>{`\r\n        .task-card {\r\n          padding: var(--space-3);\r\n          border-radius: var(--radius-md);\r\n          cursor: grab;\r\n          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\r\n          position: relative;\r\n        }\r\n\r\n        .glass-card {\r\n          background: rgba(38, 38, 38, 0.5);\r\n          backdrop-filter: blur(8px);\r\n          -webkit-backdrop-filter: blur(8px);\r\n          border: 1px solid rgba(255, 255, 255, 0.08);\r\n          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);\r\n        }\r\n\r\n        .glass-card:hover {\r\n          transform: translateY(-2px);\r\n          border-color: rgba(59, 130, 246, 0.4);\r\n          box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);\r\n          background: rgba(38, 38, 38, 0.7);\r\n        }\r\n\r\n        .delete-btn-card {\r\n          position: absolute;\r\n          top: 8px;\r\n          right: 8px;\r\n          padding: 4px;\r\n          background: rgba(239, 68, 68, 0.2);\r\n          border: 1px solid rgba(239, 68, 68, 0.3);\r\n          border-radius: 4px;\r\n          color: var(--color-error);\r\n          transition: all 0.2s;\r\n          z-index: 10;\r\n        }\r\n\r\n        .delete-btn-card:hover {\r\n          background: rgba(239, 68, 68, 0.3);\r\n          transform: scale(1.1);\r\n        }\r\n\r\n        .task-card.dragging {\r\n          opacity: 0.5;\r\n          cursor: grabbing;\r\n          transform: rotate(2deg) scale(1.05);\r\n        }\r\n\r\n        .task-card-header {\r\n          display: flex;\r\n          justify-content: space-between;\r\n          margin-bottom: var(--space-2);\r\n        }\r\n\r\n        .priority-badge {\r\n          font-size: 10px;\r\n          text-transform: uppercase;\r\n          font-weight: 600;\r\n          padding: 2px 6px;\r\n          border-radius: 4px;\r\n        }\r\n        \r\n        .priority-badge.high { background: rgba(239, 68, 68, 0.15); color: #ef4444; }\r\n        .priority-badge.medium { background: rgba(234, 179, 8, 0.15); color: #eab308; }\r\n        .priority-badge.low { background: rgba(34, 197, 94, 0.15); color: #22c55e; }\r\n\r\n        .date-badge {\r\n          font-size: 10px;\r\n          color: var(--color-text-tertiary);\r\n          display: flex;\r\n          align-items: center;\r\n          gap: 4px;\r\n        }\r\n\r\n        .task-card-title {\r\n          font-size: var(--text-sm);\r\n          font-weight: var(--font-medium);\r\n          color: var(--color-text);\r\n          margin-bottom: var(--space-1);\r\n          line-height: 1.4;\r\n        }\r\n\r\n        .task-card-desc {\r\n          font-size: var(--text-xs);\r\n          color: var(--color-text-secondary);\r\n          margin-bottom: var(--space-2);\r\n          line-height: 1.3;\r\n        }\r\n\r\n        .task-card-footer {\r\n          display: flex;\r\n          justify-content: space-between;\r\n          align-items: center;\r\n          margin-top: auto;\r\n        }\r\n\r\n        .tags-row {\r\n          display: flex;\r\n          gap: 4px;\r\n          flex-wrap: wrap;\r\n        }\r\n\r\n        .tag-mini {\r\n          font-size: 10px;\r\n          color: var(--color-text-tertiary);\r\n          background: var(--color-bg);\r\n          padding: 1px 4px;\r\n          border-radius: 3px;\r\n        }\r\n\r\n        .subtask-indicator {\r\n          font-size: 11px;\r\n          color: var(--color-text-tertiary);\r\n          display: flex;\r\n          align-items: center;\r\n          gap: 4px;\r\n        }\r\n      `}</style>\r\n    </div>\r\n  )\r\n}\r\n\r\nfunction TaskModal({\r\n  task, onClose, onSave, onDelete, onAiBreakdown, isAiLoading\r\n}: {\r\n  task: Task;\r\n  onClose: () => void;\r\n  onSave: (t: Task) => void;\r\n  onDelete: () => void;\r\n  onAiBreakdown: (currentTask: Task) => Promise<any[]>;\r\n  isAiLoading: boolean;\r\n}) {\r\n  // LOCAL STATE for editing (fixes input lag)\r\n  const [localTask, setLocalTask] = useState<Task>(task)\r\n  const [newTag, setNewTag] = useState('')\r\n  const [newSubtask, setNewSubtask] = useState('')\r\n\r\n\r\n  const addTag = () => {\r\n    if (newTag.trim() && !localTask.tags.includes(newTag.trim())) {\r\n      setLocalTask({ ...localTask, tags: [...localTask.tags, newTag.trim()] })\r\n      setNewTag('')\r\n    }\r\n  }\r\n\r\n  const removeTag = (tag: string) => {\r\n    setLocalTask({ ...localTask, tags: localTask.tags.filter(t => t !== tag) })\r\n  }\r\n\r\n  const addSubtask = () => {\r\n    if (newSubtask.trim()) {\r\n      setLocalTask({\r\n        ...localTask,\r\n        subtasks: [...(localTask.subtasks || []), { id: crypto.randomUUID(), title: newSubtask.trim(), completed: false }]\r\n      })\r\n      setNewSubtask('')\r\n    }\r\n  }\r\n\r\n  const toggleSubtask = (id: string) => {\r\n    const updatedSubtasks = localTask.subtasks?.map(s =>\r\n      s.id === id ? { ...s, completed: !s.completed } : s\r\n    )\r\n    setLocalTask({ ...localTask, subtasks: updatedSubtasks })\r\n  }\r\n\r\n  const handleSave = () => {\r\n    onSave(localTask)\r\n  }\r\n\r\n  const handleAiBreakdown = async () => {\r\n    const newSubtasks = await onAiBreakdown(localTask)\r\n    if (newSubtasks.length > 0) {\r\n      setLocalTask({\r\n        ...localTask,\r\n        subtasks: [...(localTask.subtasks || []), ...newSubtasks]\r\n      })\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"modal-overlay\" onClick={onClose}>\r\n      <div className=\"modal-content\" onClick={e => e.stopPropagation()}>\r\n        <div className=\"modal-header\">\r\n          <input\r\n            className=\"title-input\"\r\n            value={localTask.title}\r\n            onChange={e => setLocalTask({ ...localTask, title: e.target.value })}\r\n            placeholder=\"Task Title\"\r\n          />\r\n          <button className=\"btn-icon\" onClick={onClose}><X size={20} /></button>\r\n        </div>\r\n\r\n        <div className=\"modal-body\">\r\n          <div className=\"modal-section\">\r\n            <label>Description</label>\r\n            <textarea\r\n              className=\"desc-input\"\r\n              value={localTask.description || ''}\r\n              onChange={e => setLocalTask({ ...localTask, description: e.target.value })}\r\n              placeholder=\"Add details...\"\r\n              rows={4}\r\n            />\r\n          </div>\r\n\r\n          <div className=\"modal-row\">\r\n            <div className=\"modal-section\">\r\n              <label>Status</label>\r\n              <select\r\n                value={localTask.status}\r\n                onChange={e => setLocalTask({ ...localTask, status: e.target.value as Task['status'] })}\r\n              >\r\n                <option value=\"todo\">To Do</option>\r\n                <option value=\"in-progress\">In Progress</option>\r\n                <option value=\"done\">Done</option>\r\n              </select>\r\n            </div>\r\n\r\n            <div className=\"modal-section\">\r\n              <label>Priority</label>\r\n              <select\r\n                value={localTask.priority}\r\n                onChange={e => setLocalTask({ ...localTask, priority: e.target.value as Task['priority'] })}\r\n              >\r\n                <option value=\"low\">Low</option>\r\n                <option value=\"medium\">Medium</option>\r\n                <option value=\"high\">High</option>\r\n              </select>\r\n            </div>\r\n\r\n            <div className=\"modal-section\">\r\n              <label>Due Date</label>\r\n              <input\r\n                type=\"date\"\r\n                value={localTask.dueDate ? new Date(localTask.dueDate).toISOString().split('T')[0] : ''}\r\n                onChange={e => setLocalTask({ ...localTask, dueDate: e.target.valueAsDate?.getTime() })}\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"modal-section\">\r\n            <label>Tags</label>\r\n            <div className=\"tags-container\">\r\n              {localTask.tags.map(tag => (\r\n                <span key={tag} className=\"tag-chip\">\r\n                  {tag}\r\n                  <button onClick={() => removeTag(tag)}>Ã—</button>\r\n                </span>\r\n              ))}\r\n              <input\r\n                className=\"tag-input\"\r\n                placeholder=\"+ Add tag\"\r\n                value={newTag}\r\n                onChange={e => setNewTag(e.target.value)}\r\n                onKeyDown={e => {\r\n                  if (e.key === 'Enter') {\r\n                    e.preventDefault()\r\n                    addTag()\r\n                  }\r\n                }}\r\n                onBlur={addTag}\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"modal-section\">\r\n            <div className=\"section-header\">\r\n              <label>Subtasks</label>\r\n              <button\r\n                className=\"btn-ai\"\r\n                onClick={handleAiBreakdown}\r\n                disabled={isAiLoading}\r\n              >\r\n                <Sparkles size={12} /> {isAiLoading ? 'Generating...' : 'AI Breakdown'}\r\n              </button>\r\n            </div>\r\n\r\n            <div className=\"subtasks-list\">\r\n              {localTask.subtasks?.map(subtask => (\r\n                <div key={subtask.id} className=\"subtask-item\">\r\n                  <button\r\n                    className={`checkbox ${subtask.completed ? 'checked' : ''}`}\r\n                    onClick={() => toggleSubtask(subtask.id)}\r\n                  >\r\n                    {subtask.completed && <CheckCircle2 size={14} />}\r\n                  </button>\r\n                  <span className={subtask.completed ? 'completed' : ''}>{subtask.title}</span>\r\n                </div>\r\n              ))}\r\n              <input\r\n                className=\"subtask-input\"\r\n                placeholder=\"+ Add subtask\"\r\n                value={newSubtask}\r\n                onChange={e => setNewSubtask(e.target.value)}\r\n                onKeyDown={e => e.key === 'Enter' && addSubtask()}\r\n              />\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"modal-footer\">\r\n          <button className=\"btn btn-ghost delete-btn\" onClick={onDelete}>\r\n            <Trash2 size={16} /> Delete\r\n          </button>\r\n          <div className=\"action-buttons\">\r\n            <button className=\"btn btn-secondary\" onClick={onClose}>\r\n              Cancel\r\n            </button>\r\n            <button className=\"btn btn-primary\" onClick={handleSave}>\r\n              <Save size={16} /> Save Changes\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <style>{`\r\n        .modal-overlay {\r\n          position: fixed;\r\n          inset: 0;\r\n          background: rgba(0, 0, 0, 0.7);\r\n          backdrop-filter: blur(4px);\r\n          display: flex;\r\n          align-items: center;\r\n          justify-content: center;\r\n          z-index: 50;\r\n          animation: fadeIn 0.2s ease-out;\r\n        }\r\n\r\n        .modal-content {\r\n          width: 600px;\r\n          max-height: 85vh;\r\n          background: var(--color-surface);\r\n          border: 1px solid var(--color-border);\r\n          border-radius: var(--radius-xl);\r\n          box-shadow: var(--shadow-xl);\r\n          display: flex;\r\n          flex-direction: column;\r\n          animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);\r\n        }\r\n\r\n        @keyframes fadeIn {\r\n          from { opacity: 0; }\r\n          to { opacity: 1; }\r\n        }\r\n\r\n        @keyframes slideUp {\r\n          from { \r\n            opacity: 0; \r\n            transform: translateY(20px) scale(0.95);\r\n          }\r\n          to { \r\n            opacity: 1; \r\n            transform: translateY(0) scale(1);\r\n          }\r\n        }\r\n\r\n        .modal-header {\r\n          padding: var(--space-4) var(--space-6);\r\n          display: flex;\r\n          align-items: flex-start;\r\n          gap: var(--space-4);\r\n          border-bottom: 1px solid var(--color-border-subtle);\r\n        }\r\n\r\n        .title-input {\r\n          flex: 1;\r\n          background: transparent;\r\n          font-size: var(--text-xl);\r\n          font-weight: var(--font-semibold);\r\n          color: var(--color-text);\r\n          border: none;\r\n          outline: none;\r\n        }\r\n\r\n        .modal-body {\r\n          flex: 1;\r\n          overflow-y: auto;\r\n          padding: var(--space-6);\r\n          display: flex;\r\n          flex-direction: column;\r\n          gap: var(--space-6);\r\n        }\r\n\r\n        .modal-section label {\r\n          display: block;\r\n          font-size: var(--text-xs);\r\n          font-weight: var(--font-medium);\r\n          color: var(--color-text-tertiary);\r\n          text-transform: uppercase;\r\n          letter-spacing: 0.05em;\r\n          margin-bottom: var(--space-2);\r\n        }\r\n\r\n        .desc-input {\r\n          width: 100%;\r\n          min-height: 100px;\r\n          background: var(--color-surface-elevated);\r\n          border: 1px solid var(--color-border);\r\n          border-radius: var(--radius-md);\r\n          padding: var(--space-3);\r\n          color: var(--color-text);\r\n          resize: vertical;\r\n          font-family: inherit;\r\n          font-size: var(--text-sm);\r\n          line-height: 1.5;\r\n        }\r\n\r\n        .desc-input:focus {\r\n          outline: none;\r\n          border-color: var(--color-accent);\r\n        }\r\n\r\n        .modal-row {\r\n          display: grid;\r\n          grid-template-columns: 1fr 1fr 1fr;\r\n          gap: var(--space-4);\r\n        }\r\n\r\n        select, input[type=\"date\"] {\r\n          width: 100%;\r\n          background: var(--color-surface-elevated);\r\n          border: 1px solid var(--color-border);\r\n          padding: var(--space-2);\r\n          border-radius: var(--radius-md);\r\n          color: var(--color-text);\r\n          font-size: var(--text-sm);\r\n        }\r\n\r\n        select:focus, input[type=\"date\"]:focus {\r\n          outline: none;\r\n          border-color: var(--color-accent);\r\n        }\r\n\r\n        .tags-container {\r\n          display: flex;\r\n          flex-wrap: wrap;\r\n          gap: var(--space-2);\r\n        }\r\n\r\n        .tag-chip {\r\n          background: var(--color-surface-elevated);\r\n          border: 1px solid var(--color-border);\r\n          padding: 2px 8px;\r\n          border-radius: var(--radius-full);\r\n          font-size: var(--text-sm);\r\n          display: flex;\r\n          align-items: center;\r\n          gap: 4px;\r\n        }\r\n\r\n        .tag-chip button {\r\n          opacity: 0.5;\r\n        }\r\n        .tag-chip button:hover { opacity: 1; }\r\n\r\n        .tag-input {\r\n          background: transparent;\r\n          border: none;\r\n          min-width: 80px;\r\n          outline: none;\r\n          font-size: var(--text-sm);\r\n        }\r\n\r\n        .section-header {\r\n          display: flex;\r\n          justify-content: space-between;\r\n          align-items: center;\r\n          margin-bottom: var(--space-2);\r\n        }\r\n\r\n        .btn-ai {\r\n          display: flex;\r\n          align-items: center;\r\n          gap: 4px;\r\n          font-size: 11px;\r\n          color: var(--color-accent);\r\n          background: rgba(59, 130, 246, 0.1);\r\n          padding: 4px 10px;\r\n          border-radius: var(--radius-md);\r\n          border: 1px solid rgba(59, 130, 246, 0.2);\r\n          transition: all 0.2s;\r\n        }\r\n        \r\n        .btn-ai:hover { background: rgba(59, 130, 246, 0.15); }\r\n        .btn-ai:disabled { opacity: 0.5; cursor: not-allowed; }\r\n\r\n        .subtasks-list {\r\n          display: flex;\r\n          flex-direction: column;\r\n          gap: var(--space-2);\r\n        }\r\n\r\n        .subtask-item {\r\n          display: flex;\r\n          align-items: center;\r\n          gap: var(--space-3);\r\n        }\r\n\r\n        .checkbox {\r\n          width: 20px;\r\n          height: 20px;\r\n          border-radius: 6px;\r\n          border: 2px solid var(--color-border);\r\n          display: flex;\r\n          align-items: center;\r\n          justify-content: center;\r\n          color: var(--color-success);\r\n          transition: all 0.2s;\r\n          flex-shrink: 0;\r\n        }\r\n\r\n        .checkbox:hover { border-color: var(--color-text-tertiary); }\r\n        .checkbox.checked { border-color: var(--color-success); background: rgba(34, 197, 94, 0.1); }\r\n\r\n        .completed {\r\n          text-decoration: line-through;\r\n          color: var(--color-text-muted);\r\n        }\r\n\r\n        .subtask-input {\r\n          margin-top: var(--space-2);\r\n          background: transparent;\r\n          border-bottom: 2px solid var(--color-border); \r\n          padding: 4px 0;\r\n          width: 100%;\r\n          outline: none;\r\n          font-size: var(--text-sm);\r\n        }\r\n\r\n        .subtask-input:focus { border-color: var(--color-accent); }\r\n\r\n        .modal-footer {\r\n          padding: var(--space-4) var(--space-6);\r\n          border-top: 1px solid var(--color-border-subtle);\r\n          display: flex;\r\n          justify-content: space-between;\r\n          align-items: center;\r\n        }\r\n\r\n        .action-buttons {\r\n          display: flex;\r\n          gap: var(--space-2);\r\n        }\r\n\r\n        .delete-btn {\r\n          color: var(--color-error);\r\n        }\r\n        .delete-btn:hover { background: rgba(239, 68, 68, 0.1); }\r\n      `}</style>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\Titlebar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\ToolConfirmationDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\UnifiedAgentPanel.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":60,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":60,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2154,2157],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2154,2157],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":73,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":73,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2590,2593],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2590,2593],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":132,"column":27,"nodeType":"MemberExpression","messageId":"unexpected","endLine":132,"endColumn":40,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[5426,5471],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":141,"column":70,"nodeType":"MemberExpression","messageId":"unexpected","endLine":141,"endColumn":83,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[5775,5817],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":209,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":209,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8160,8163],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8160,8163],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":244,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":244,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9543,9546],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9543,9546],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":298,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":298,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[12028,12074],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":374,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":374,"endColumn":32,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[15639,15877],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":388,"column":25,"nodeType":"MemberExpression","messageId":"unexpected","endLine":388,"endColumn":36,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[16350,16403],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":408,"column":25,"nodeType":"MemberExpression","messageId":"unexpected","endLine":408,"endColumn":36,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[17282,17358],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":422,"column":88,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":422,"endColumn":91,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18083,18086],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18083,18086],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":437,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":437,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19004,19007],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19004,19007],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":443,"column":25,"nodeType":"MemberExpression","messageId":"unexpected","endLine":443,"endColumn":36,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[19327,19418],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":512,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":512,"endColumn":32,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[23106,23152],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":513,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":513,"endColumn":32,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[23174,23222],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":546,"column":33,"nodeType":"MemberExpression","messageId":"unexpected","endLine":546,"endColumn":46,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[24983,25048],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":579,"column":33,"nodeType":"MemberExpression","messageId":"unexpected","endLine":579,"endColumn":44,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[26986,27045],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":585,"column":25,"nodeType":"MemberExpression","messageId":"unexpected","endLine":585,"endColumn":36,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[27192,27248],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":588,"column":29,"nodeType":"MemberExpression","messageId":"unexpected","endLine":588,"endColumn":40,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[27380,27466],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":590,"column":29,"nodeType":"MemberExpression","messageId":"unexpected","endLine":590,"endColumn":40,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[27630,27673],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":651,"column":37,"nodeType":"MemberExpression","messageId":"unexpected","endLine":651,"endColumn":48,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[31805,31886],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":676,"column":41,"nodeType":"MemberExpression","messageId":"unexpected","endLine":676,"endColumn":52,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[33477,33552],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":693,"column":41,"nodeType":"MemberExpression","messageId":"unexpected","endLine":693,"endColumn":54,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[35006,35087],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":713,"column":37,"nodeType":"MemberExpression","messageId":"unexpected","endLine":713,"endColumn":48,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[36248,36327],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":718,"column":33,"nodeType":"MemberExpression","messageId":"unexpected","endLine":718,"endColumn":44,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[36503,36578],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":728,"column":29,"nodeType":"MemberExpression","messageId":"unexpected","endLine":728,"endColumn":42,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[37131,37177],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":731,"column":25,"nodeType":"MemberExpression","messageId":"unexpected","endLine":731,"endColumn":36,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[37260,37345],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":754,"column":101,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":754,"endColumn":104,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[38566,38569],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[38566,38569],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"prefer-const","severity":2,"message":"'toolMatch' is never reassigned. Use 'const' instead.","line":766,"column":25,"nodeType":"Identifier","messageId":"useConst","endLine":766,"endColumn":34,"fix":{"range":[39224,39299],"text":"const toolMatch = response.content?.match(/```tool\\s*\\n?({[\\s\\S]*?})\\n?```/i)"}},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":797,"column":37,"nodeType":"MemberExpression","messageId":"unexpected","endLine":797,"endColumn":48,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[41268,41355],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":824,"column":41,"nodeType":"MemberExpression","messageId":"unexpected","endLine":824,"endColumn":54,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[43466,43553],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":833,"column":37,"nodeType":"MemberExpression","messageId":"unexpected","endLine":833,"endColumn":48,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[44140,44225],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":838,"column":33,"nodeType":"MemberExpression","messageId":"unexpected","endLine":838,"endColumn":44,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[44401,44482],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":847,"column":39,"nodeType":"MemberExpression","messageId":"unexpected","endLine":847,"endColumn":52,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[45006,45044],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":946,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":946,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[49896,49899],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[49896,49899],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":971,"column":157,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":971,"endColumn":160,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[51999,52002],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[51999,52002],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":1289,"column":105,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1289,"endColumn":108,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[76340,76343],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[76340,76343],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":1307,"column":73,"nodeType":"MemberExpression","messageId":"unexpected","endLine":1307,"endColumn":86,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[78013,78066],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":1347,"column":65,"nodeType":"MemberExpression","messageId":"unexpected","endLine":1347,"endColumn":77,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[81346,81395],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":1349,"column":65,"nodeType":"MemberExpression","messageId":"unexpected","endLine":1349,"endColumn":78,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[81531,81579],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":1452,"column":80,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1452,"endColumn":83,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[90091,90094],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[90091,90094],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":1457,"column":80,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1457,"endColumn":83,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[90573,90576],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[90573,90576],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":1458,"column":82,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1458,"endColumn":85,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[90670,90673],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[90670,90673],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":42,"fixableErrorCount":1,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\nimport React, { useState, useRef, useEffect, useMemo } from 'react'\r\nimport { useAppStore } from '../stores/appStore'\r\nimport { useYDoc, useYArray, useAwareness } from '../hooks/useYjs'\r\nimport { usePermissions } from '../hooks/usePermissions'\r\nimport { encryptionService, EncryptedPayload } from '../services/encryptionService'\r\nimport { aiService, AIProvider, AIMessage } from '../services/aiService'\r\nimport { offlineLLMService, ChatMessage as OfflineChatMessage } from '../services/offlineLLMService'\r\nimport { useModelStore } from '../stores/modelStore'\r\nimport { useAgent } from '../hooks/useAgent'\r\nimport { executeTool, getToolsDescription, getToolCallJsonSchema, getToolSystemPrompt, getSimplifiedToolSchema, getModelSizeCategory, toolPermissionManager, type ToolCallRequest } from '../services/ideAgentTools'\r\nimport { getModelById } from '../types/offlineModels'\r\nimport UnifiedSettingsPanel from './UnifiedSettingsPanel'\r\nimport {\r\n    MessageSquare, Zap, Lock, Send, Trash2,\r\n    Paperclip, Cloud, Terminal as TerminalIcon,\r\n    Scroll, Check, X, Lightbulb, Bot, AlertCircle,\r\n    ChevronDown, Monitor, Loader2, Square,\r\n    Brain, Bug, Shield, Info\r\n} from 'lucide-react'\r\n\r\n// --- Types ---\r\ntype PanelMode = 'collaboration' | 'agent'\r\ntype AIMode = 'cloud' | 'offline'\r\n\r\ninterface TabProps {\r\n    id: PanelMode\r\n    icon: React.ReactNode\r\n    label: string\r\n    active: boolean\r\n    onClick: () => void\r\n    badge?: number\r\n}\r\n\r\ninterface ChatMessage {\r\n    id: string\r\n    role?: 'user' | 'assistant' | 'system' | 'tool'\r\n    content: string\r\n    sender?: string\r\n    senderId?: string\r\n    timestamp: number\r\n    channelId?: string\r\n    encrypted?: boolean\r\n    toolName?: string\r\n    toolResult?: string\r\n    isError?: boolean\r\n    modelId?: string\r\n    isLoading?: boolean\r\n    issueType?: string\r\n    thinking?: string  // Model's chain-of-thought reasoning\r\n}\r\n\r\n// --- Component ---\r\ninterface UnifiedAgentPanelProps {\r\n    readonly workspacePath: string | null\r\n    readonly currentFile: string | null\r\n    readonly currentFileContent: string | null\r\n    readonly editorMode?: any\r\n    readonly onRunCommand?: (command: string) => void\r\n}\r\n\r\nexport default function UnifiedAgentPanel({\r\n    workspacePath,\r\n    currentFile,\r\n    currentFileContent,\r\n    editorMode = 'general',\r\n    onRunCommand\r\n}: UnifiedAgentPanelProps) {\r\n    const { currentSpace, apiKeys } = useAppStore()\r\n    const { doc, provider, synced } = useYDoc(currentSpace?.id ?? null)\r\n    const { items: p2pMessages, push: pushP2P } = useYArray<any>(doc, 'messages')\r\n    useAwareness(provider)\r\n    const { canChat } = usePermissions()\r\n    const { loadedModelId, isLoading: isModelLoading, loadError } = useModelStore()\r\n\r\n    // Agent Logic\r\n    const [agentAIMode, setAgentAIMode] = useState<AIMode>('cloud')\r\n    const agent = useAgent(currentSpace?.id ?? null, editorMode, agentAIMode === 'offline', workspacePath || '')\r\n\r\n    // UI State\r\n    const [activeMode, setActiveMode] = useState<PanelMode>('agent')\r\n    const [aiMode, setAiMode] = useState<AIMode>('cloud')\r\n    const [input, setInput] = useState('')\r\n    const [isProcessing, setIsProcessing] = useState(false)\r\n    const [showModelManager, setShowModelManager] = useState(false)\r\n    const [includeContext, setIncludeContext] = useState(true)\r\n    const [currentProvider, setCurrentProvider] = useState<AIProvider>('openai')\r\n    const [showLog, setShowLog] = useState(false)\r\n    const [showAutonomous, setShowAutonomous] = useState(false)\r\n    const [scanProgress, setScanProgress] = useState<{ current: number; total: number; currentFile: string } | null>(null)\r\n\r\n    // Message States (Local storage for AI chats)\r\n    const [aiMessages, setAiMessages] = useState<ChatMessage[]>([])\r\n    const [streamingContent, setStreamingContent] = useState('')\r\n\r\n    // Thinking UI State\r\n    const [thinkingContent, setThinkingContent] = useState('')\r\n    const [isThinking, setIsThinking] = useState(false)\r\n    const [showThinking, setShowThinking] = useState(false)\r\n\r\n    // Tool Confirmation State\r\n    const [pendingToolRequest, setPendingToolRequest] = useState<ToolCallRequest | null>(null)\r\n    const [toolConfirmationResolver, setToolConfirmationResolver] = useState<{\r\n        resolve: (value: { approved: boolean; alwaysAllow: boolean }) => void\r\n    } | null>(null)\r\n\r\n    // Encryption State\r\n    const [encryptionEnabled, setEncryptionEnabled] = useState(false)\r\n    const [decryptedCache, setDecryptedCache] = useState<Map<string, string>>(new Map())\r\n    const [decryptionErrors, setDecryptionErrors] = useState<Set<string>>(new Set())\r\n\r\n    const messagesEndRef = useRef<HTMLDivElement>(null)\r\n    const inputRef = useRef<HTMLTextAreaElement>(null)\r\n    const userId = useRef(crypto.randomUUID())\r\n\r\n    // --- Initialization & Sync ---\r\n\r\n    // Load encryption\r\n    useEffect(() => {\r\n        if (!currentSpace) return\r\n        const settings = localStorage.getItem(`space-settings-${currentSpace.id}`)\r\n        if (settings) {\r\n            try {\r\n                const parsed = JSON.parse(settings)\r\n                if (parsed.encryptionEnabled && parsed.roomPassword) {\r\n                    encryptionService.setRoomKey(currentSpace.id, parsed.roomPassword).then(() => {\r\n                        setEncryptionEnabled(true)\r\n                    })\r\n                }\r\n            } catch (e) { console.error('Failed to load encryption', e) }\r\n        }\r\n    }, [currentSpace])\r\n\r\n    // Sync AI Chat history\r\n    useEffect(() => {\r\n        if (currentSpace?.id) {\r\n            const saved = localStorage.getItem(`unified-chat-${currentSpace.id}`)\r\n            if (saved) {\r\n                try { setAiMessages(JSON.parse(saved)) } catch (e) { console.error('Failed to load history', e) }\r\n            } else {\r\n                setAiMessages([])\r\n            }\r\n        }\r\n    }, [currentSpace?.id])\r\n\r\n    useEffect(() => {\r\n        if (currentSpace?.id) {\r\n            localStorage.setItem(`unified-chat-${currentSpace.id}`, JSON.stringify(aiMessages))\r\n        }\r\n    }, [aiMessages, currentSpace?.id])\r\n\r\n    // Register Tool Confirmation Handler\r\n    useEffect(() => {\r\n        toolPermissionManager.setConfirmationHandler(async (request) => {\r\n            return new Promise((resolve) => {\r\n                setPendingToolRequest(request)\r\n                setToolConfirmationResolver({\r\n                    resolve: (result) => {\r\n                        resolve(result)\r\n                        // Trigger scroll to bottom to show the executing tool\r\n                        setTimeout(scrollToBottom, 100)\r\n                    }\r\n                })\r\n                // Scroll to show the approval card\r\n                setTimeout(scrollToBottom, 100)\r\n            })\r\n        })\r\n\r\n        return () => {\r\n            toolPermissionManager.setConfirmationHandler(async () => ({ approved: false, alwaysAllow: false }))\r\n        }\r\n    }, [])\r\n\r\n\r\n    // Scroll to bottom helper\r\n    const scrollToBottom = () => {\r\n        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' })\r\n    }\r\n\r\n    // Scroll to bottom on changes\r\n    useEffect(() => {\r\n        scrollToBottom()\r\n    }, [p2pMessages, aiMessages, streamingContent, activeMode, agent.activityLog, showLog])\r\n\r\n    // Focus input\r\n    useEffect(() => {\r\n        if (inputRef.current) inputRef.current.focus()\r\n    }, [activeMode, aiMode])\r\n\r\n    // Set up tool permission handler\r\n    useEffect(() => {\r\n        toolPermissionManager.setConfirmationHandler(async (request: ToolCallRequest) => {\r\n            return new Promise((resolve) => {\r\n                setPendingToolRequest(request)\r\n                setToolConfirmationResolver({ resolve })\r\n            })\r\n        })\r\n\r\n        // DISABLE trusted mode to show confirmation dialogs\r\n        // Users should approve destructive operations\r\n        toolPermissionManager.setTrustedMode(false)\r\n\r\n        // Auto-allow read-only tools (safe operations)\r\n        toolPermissionManager.setReadOnlyAutoAllow(true)\r\n\r\n        return () => {\r\n            toolPermissionManager.setConfirmationHandler(null as any)\r\n            toolPermissionManager.setTrustedMode(false)\r\n            toolPermissionManager.clearSession()\r\n        }\r\n    }, [])\r\n\r\n    // --- P2P Encryption Logic ---\r\n    useEffect(() => {\r\n        if (!currentSpace || !encryptionEnabled) return\r\n        const decryptAll = async () => {\r\n            const roomKey = encryptionService.getRoomKey(currentSpace.id)\r\n            if (!roomKey) return\r\n            const newCache = new Map(decryptedCache)\r\n            const newErrors = new Set(decryptionErrors)\r\n            let changed = false\r\n            for (const msg of p2pMessages) {\r\n                if (!msg.encrypted || newCache.has(msg.id) || newErrors.has(msg.id)) continue\r\n                try {\r\n                    const payload: EncryptedPayload = JSON.parse(msg.content)\r\n                    const decrypted = await encryptionService.decryptToString(payload, roomKey)\r\n                    newCache.set(msg.id, decrypted)\r\n                    changed = true\r\n                } catch (_e) {\r\n                    newErrors.add(msg.id)\r\n                    changed = true\r\n                }\r\n            }\r\n            if (changed) {\r\n                setDecryptedCache(newCache)\r\n                setDecryptionErrors(newErrors)\r\n            }\r\n        }\r\n        decryptAll()\r\n    }, [p2pMessages, currentSpace, encryptionEnabled])\r\n\r\n    const getP2PContent = (msg: any) => {\r\n        if (!msg.encrypted) return msg.content\r\n        if (decryptedCache.has(msg.id)) return decryptedCache.get(msg.id)\r\n        if (decryptionErrors.has(msg.id)) return <span style={{ display: 'inline-flex', alignItems: 'center', gap: '4px' }}><Lock size={12} /> [Decryption Failed]</span>\r\n        return <span style={{ display: 'inline-flex', alignItems: 'center', gap: '4px' }}><Loader2 size={12} className=\"animate-spin\" /> [Decrypting...]</span>\r\n    }\r\n\r\n    // --- AI Logic (Assistant) ---\r\n    const availableCloudProviders = useMemo(() => {\r\n        const providers: AIProvider[] = []\r\n        if (apiKeys.openai) providers.push('openai')\r\n        if (apiKeys.anthropic) providers.push('anthropic')\r\n        if (apiKeys.google) providers.push('google')\r\n        return providers\r\n    }, [apiKeys])\r\n\r\n    const currentOfflineModel = loadedModelId ? getModelById(loadedModelId) : null\r\n\r\n    const buildContext = (forOffline: boolean = false): string => {\r\n        if (!includeContext) return ''\r\n        let context = `WORKSPACE: ${workspacePath || 'None'}\\n`\r\n        if (currentFile && currentFileContent) {\r\n            // For offline models, use much less context to avoid KV slot errors\r\n            const maxContent = forOffline ? 500 : 3000\r\n            context += `CURRENT FILE: ${currentFile}\\nCONTENT (Partial):\\n${currentFileContent.slice(0, maxContent)}\\n`\r\n        }\r\n        // For offline models, use compact tool descriptions\r\n        if (forOffline) {\r\n            context += `TOOLS: readFile, writeFile, listDirectory, createFile, createDirectory, delete, executeCode, runCommand, gitStatus\\n`\r\n        } else {\r\n            context += `AVAILABLE TOOLS:\\n${getToolsDescription()}\\n`\r\n        }\r\n        return context\r\n    }\r\n\r\n    const handleStop = async () => {\r\n        if (!isProcessing) return\r\n\r\n        try {\r\n            // Cancel backend generation FIRST before resetting UI\r\n            const currentAIMode = showAutonomous ? agentAIMode : aiMode\r\n            if (currentAIMode === 'offline') {\r\n                await offlineLLMService.cancelGeneration()\r\n            } else {\r\n                // Cancel cloud AI streams using AbortController\r\n                aiService.cancelStream()\r\n            }\r\n\r\n            // Then reset all generation state\r\n            setIsProcessing(false)\r\n            setStreamingContent('')\r\n            setThinkingContent('')\r\n            setIsThinking(false)\r\n        } catch (error) {\r\n            console.error('Stop generation error:', error)\r\n            // Reset UI even if cancel fails\r\n            setIsProcessing(false)\r\n            setStreamingContent('')\r\n            setThinkingContent('')\r\n            setIsThinking(false)\r\n        }\r\n    }\r\n\r\n    const handleSend = async () => {\r\n        const text = input.trim()\r\n        if (!text || isProcessing) return\r\n\r\n        if (activeMode === 'collaboration') {\r\n            if (!canChat) return\r\n            let content = text\r\n            let encrypted = false\r\n            if (encryptionEnabled && currentSpace) {\r\n                const key = encryptionService.getRoomKey(currentSpace.id)\r\n                if (key) {\r\n                    const payload = await encryptionService.encrypt(content, key)\r\n                    const msgId = crypto.randomUUID()\r\n                    setDecryptedCache(prev => new Map(prev).set(msgId, content))\r\n                    content = JSON.stringify(payload)\r\n                    encrypted = true\r\n                    pushP2P({ id: msgId, content, sender: 'You', senderId: userId.current, timestamp: Date.now(), encrypted })\r\n                    setInput('')\r\n                    return\r\n                }\r\n            }\r\n            pushP2P({ id: crypto.randomUUID(), content, sender: 'You', senderId: userId.current, timestamp: Date.now(), encrypted: false })\r\n            setInput('')\r\n            return\r\n        }\r\n\r\n        if (activeMode === 'agent' && !showAutonomous) {\r\n            if (aiMode === 'cloud' && availableCloudProviders.length === 0) return\r\n            if (aiMode === 'offline' && !loadedModelId) return\r\n\r\n            const userMsg: ChatMessage = { id: crypto.randomUUID(), role: 'user', content: text, timestamp: Date.now() }\r\n            setAiMessages(prev => [...prev, userMsg])\r\n            setInput('')\r\n            setIsProcessing(true)\r\n\r\n            if (aiMode === 'offline') {\r\n                setStreamingContent('')\r\n                try {\r\n                    // Detect if this is a thinking model (Qwen3-Thinking)\r\n                    const isThinkingModel = loadedModelId?.includes('thinking')\r\n\r\n                    // Detect if user is requesting a tool (for grammar-based generation)\r\n                    const detectToolIntent = (text: string): boolean => {\r\n                        const lower = text.toLowerCase()\r\n\r\n                        // Explicit tool keywords (high confidence)\r\n                        const toolKeywords = ['read', 'write', 'list', 'create', 'delete', 'run', 'execute', 'git']\r\n                        if (toolKeywords.some(kw => lower.includes(kw))) return true\r\n\r\n                        // Action verbs commonly used for tools\r\n                        const actionVerbs = ['remove', 'fix', 'change', 'update', 'edit', 'rename', 'move', 'copy', 'add', 'check']\r\n                        if (actionVerbs.some(verb => lower.includes(verb))) return true\r\n\r\n                        // File/path references\r\n                        if (/\\.(ts|js|tsx|jsx|py|json|md|txt|css|html)/i.test(text)) return true\r\n                        if (/(file|folder|directory|path)/i.test(lower)) return true\r\n\r\n                        return false\r\n                    }\r\n\r\n                    const isToolRequest = detectToolIntent(text)\r\n\r\n                    // Determine model size for schema complexity selection\r\n                    const modelSize = loadedModelId ? getModelSizeCategory(loadedModelId) : 'small'\r\n                    const useCompactPrompt = modelSize === 'small'\r\n\r\n                    // DEBUG: Log intent detection result\r\n                    console.log('[Agent] Intent detection:', {\r\n                        userInput: text.slice(0, 50),\r\n                        isToolRequest,\r\n                        isThinkingModel,\r\n                        modelSize\r\n                    })\r\n\r\n                    // Build system prompt based on request type\r\n                    // KEY FIX: When tools are requested, use dedicated tool prompt that TEACHES the format\r\n                    let sysPrompt: string\r\n\r\n                    if (isToolRequest) {\r\n                        // Use tool-specific prompt that explicitly shows JSON format\r\n                        sysPrompt = getToolSystemPrompt(workspacePath || '', useCompactPrompt)\r\n                        console.log('[Agent] Using tool-aware system prompt')\r\n                    } else if (isThinkingModel) {\r\n                        // Thinking model prompt - simplified for conversation\r\n                        sysPrompt = `You are Kalynt, a helpful AI coding assistant.\r\n\r\nWORKSPACE: ${workspacePath || 'None'}\r\n\r\nYou have extended reasoning capabilities. Use <think> tags ONLY for complex problems.\r\n\r\nIMPORTANT: For simple greetings and basic questions, respond directly and naturally.\r\nOnly use <think> tags for complex problems that require step-by-step reasoning.\r\n\r\nExample:\r\nUser: \"hello\"\r\nAssistant: Hello! How can I help you today?\r\n\r\nBe helpful, friendly, and conversational.`\r\n                    } else {\r\n                        // Simple conversational prompt for non-tool requests\r\n                        // CRITICAL: Don't include tool examples for small models - they copy them literally!\r\n                        console.log('[Agent] Using simple conversational prompt (no tool examples)')\r\n                        sysPrompt = `You are Kalynt, a helpful AI coding assistant.\r\n\r\nWORKSPACE: ${workspacePath || 'None'}\r\n\r\nRespond naturally to questions and greetings. Be helpful and conversational.\r\n\r\nIf the user asks you to perform file operations (read, write, list files, etc.), let them know you can help with that.`\r\n                    }\r\n\r\n                    // For offline models, keep only last 2 turns to prevent context overflow\r\n                    const history: OfflineChatMessage[] = [\r\n                        { role: 'system', content: sysPrompt },\r\n                        ...aiMessages.slice(-2).map(m => ({\r\n                            role: m.role === 'tool' ? 'assistant' as const : m.role as any,\r\n                            content: m.role === 'tool' ? `Tool result: ${m.toolResult?.slice(0, 100)}` : m.content.slice(0, 200)\r\n                        })),\r\n                        { role: 'user', content: text }\r\n                    ]\r\n\r\n                    // Handle streaming with thinking tag parsing\r\n                    // KEY FIX: Disable thinking mode during tool requests (breaks JSON grammar)\r\n                    let fullResponse = ''\r\n                    let inThinking = false\r\n                    const enableThinkingParsing = isThinkingModel && !isToolRequest  // Disabled during tool calls\r\n                    const thinkOpenTag = isThinkingModel ? '<think>' : '<thinking>'\r\n                    const thinkCloseTag = isThinkingModel ? '</think>' : '</thinking>'\r\n\r\n                    // Use grammar-based sampling for tool requests (Cursor-like reliability)\r\n                    const options: any = {}\r\n                    if (isToolRequest) {\r\n                        // Use simplified schema for small models\r\n                        options.jsonSchema = modelSize === 'small'\r\n                            ? getSimplifiedToolSchema()\r\n                            : getToolCallJsonSchema()\r\n                        console.log('[Agent] Using grammar-based tool calling (100% reliable JSON)', { modelSize })\r\n                    }\r\n\r\n                    const response = await offlineLLMService.generateStream(history, (token) => {\r\n                        fullResponse += token\r\n\r\n                        // Skip thinking tag parsing when doing tool calls (JSON grammar mode)\r\n                        if (!enableThinkingParsing) {\r\n                            // Direct streaming for tool calls - just show the raw JSON being generated\r\n                            setStreamingContent(fullResponse)\r\n                            return\r\n                        }\r\n\r\n                        // Check for thinking tag transitions (only for non-tool requests)\r\n                        if (fullResponse.includes(thinkOpenTag) && !fullResponse.includes(thinkCloseTag)) {\r\n                            if (!inThinking) {\r\n                                setIsThinking(true)\r\n                                inThinking = true\r\n                            }\r\n                            // Extract and show thinking content\r\n                            const thinkingStart = fullResponse.indexOf(thinkOpenTag) + thinkOpenTag.length\r\n                            setThinkingContent(fullResponse.slice(thinkingStart))\r\n                        } else if (fullResponse.includes(thinkCloseTag)) {\r\n                            // Thinking complete\r\n                            if (inThinking) {\r\n                                setIsThinking(false)\r\n                                inThinking = false\r\n                            }\r\n                            // Show only content after closing tag\r\n                            const afterThinking = fullResponse.split(thinkCloseTag).pop() ?? ''\r\n                            // Normal streaming (no thinking tags)\r\n                            setStreamingContent(afterThinking.replace(/```tool[\\s\\S]*?```/g, '').trim())\r\n                        } else if (!inThinking) {\r\n                            // Normal streaming (no thinking tags)\r\n                            setStreamingContent(fullResponse.replace(/```tool[\\s\\S]*?```/g, '').trim())\r\n                        }\r\n                    }, options)\r\n\r\n                    // Extract final thinking content for message storage\r\n                    // Support both <think> and <thinking> tags\r\n                    const thinkingPattern = isThinkingModel\r\n                        ? /<think>([\\s\\S]*?)<\\/think>/\r\n                        : /<thinking>([\\s\\S]*?)<\\/thinking>/\r\n                    const thinkingMatch = thinkingPattern.exec(response)\r\n                    const thinking = thinkingMatch ? thinkingMatch[1].trim() : undefined\r\n\r\n                    // Clean main content (no thinking tags, no tool blocks)\r\n                    const mainContent = response\r\n                        .replace(/<think>[\\s\\S]*?<\\/think>/g, '')\r\n                        .replace(/<thinking>[\\s\\S]*?<\\/thinking>/g, '')\r\n                        .replace(/```tool[\\s\\S]*?```/g, '')\r\n                        .trim()\r\n\r\n                    if (mainContent || thinking) {\r\n                        setAiMessages(prev => [...prev, {\r\n                            id: crypto.randomUUID(),\r\n                            role: 'assistant',\r\n                            content: mainContent,\r\n                            thinking,\r\n                            timestamp: Date.now(),\r\n                            modelId: loadedModelId!\r\n                        }])\r\n                    }\r\n\r\n                    // Reset thinking UI state\r\n                    setThinkingContent('')\r\n                    setIsThinking(false)\r\n\r\n                    // DEBUG: Log actual LLM response to see what we're working with\r\n                    console.log('[Agent] LLM Response:', response)\r\n                    console.log('[Agent] Looking for tool calls...')\r\n\r\n                    // Tool Handling - support multiple tool call formats\r\n                    // Format 1: Markdown code block (existing)\r\n                    let toolMatch = response.match(/```tool\\s*\\n?({[\\s\\S]*?})\\n?```/i)\r\n\r\n                    // Format 2: XML tags (existing)\r\n                    if (!toolMatch) {\r\n                        const toolPattern = /<tool>({[\\s\\S]*?})<\\/tool>/i\r\n                        const toolShortPattern = /<tool>({[\\s\\S]*?})/i\r\n                        toolMatch = toolPattern.exec(response) ?? toolShortPattern.exec(response)\r\n                    }\r\n\r\n                    // Format 3: Qwen-specific <tool_call> format (NEW)\r\n                    if (!toolMatch) {\r\n                        const qwenPattern = /<tool_call>\\s*({[\\s\\S]*?})\\s*<\\/tool_call>/i\r\n                        const qwenMatch = qwenPattern.exec(response)\r\n                        if (qwenMatch) toolMatch = qwenMatch\r\n                    }\r\n\r\n                    // Format 4: Hermes function call format (NEW)\r\n                    if (!toolMatch) {\r\n                        const hermesPattern = /<function=(\\w+)>([\\s\\S]*?)<\\/function>/i\r\n                        const hermesMatch = hermesPattern.exec(response)\r\n                        if (hermesMatch) {\r\n                            // Convert Hermes format to standard format\r\n                            try {\r\n                                const toolCall = {\r\n                                    name: hermesMatch[1],\r\n                                    params: JSON.parse(hermesMatch[2])\r\n                                }\r\n                                toolMatch = [hermesMatch[0], JSON.stringify(toolCall)]\r\n                            } catch (e) {\r\n                                console.error('[Agent] Failed to parse Hermes function call:', e)\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    // Format 5: Direct JSON without wrapping (NEW - improved)\r\n                    // The regex approach fails with nested braces, so we use JSON.parse instead\r\n                    if (!toolMatch) {\r\n                        // Try to find where JSON might start\r\n                        const jsonStart = response.indexOf('{\"name\":')\r\n                        if (jsonStart !== -1) {\r\n                            // Extract from start position to end of response\r\n                            const jsonCandidate = response.substring(jsonStart)\r\n\r\n                            // Try to parse it - JSON.parse will find the correct end\r\n                            try {\r\n                                // Find the matching closing brace by attempting parse\r\n                                // We'll try progressively longer substrings until parse succeeds\r\n                                for (let endPos = jsonCandidate.length; endPos >= 50; endPos--) {\r\n                                    try {\r\n                                        const potentialJson = jsonCandidate.substring(0, endPos)\r\n                                        const parsed = JSON.parse(potentialJson)\r\n                                        // Verify it has the expected structure\r\n                                        if (parsed.name && parsed.params) {\r\n                                            toolMatch = [potentialJson, potentialJson]\r\n                                            break\r\n                                        }\r\n                                    } catch {\r\n                                        // Keep trying shorter strings\r\n                                        continue\r\n                                    }\r\n                                }\r\n                            } catch (_e) {\r\n                                console.log('[Agent] Failed to extract JSON from response')\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    if (toolMatch) {\r\n                        console.log('[Agent] Tool call detected:', toolMatch[1])\r\n                        try {\r\n                            const toolCall = JSON.parse(toolMatch[1])\r\n                            console.log('[Agent] Executing tool:', toolCall.name, 'with params:', toolCall.params)\r\n                            const result = await executeTool(toolCall.name, toolCall.params, { workspacePath: workspacePath || '' })\r\n                            console.log('[Agent] Tool result:', result)\r\n\r\n                            const output = result.success ? (typeof result.data === 'string' ? result.data : JSON.stringify(result.data, null, 2)) : `Error: ${result.error}`\r\n\r\n                            setAiMessages(prev => [...prev, { id: crypto.randomUUID(), role: 'tool', content: '', toolName: toolCall.name, toolResult: output, timestamp: Date.now() }])\r\n\r\n                            if (toolCall.name === 'runCommand' && onRunCommand) {\r\n                                onRunCommand(toolCall.params.command)\r\n                            }\r\n\r\n                            // Multi-turn tool loop - continue until no more tools are called\r\n                            const MAX_TOOL_ITERATIONS = 5\r\n                            let iterationCount = 0\r\n                            let currentHistory: OfflineChatMessage[] = [\r\n                                ...history,\r\n                                { role: 'assistant', content: response },\r\n                                {\r\n                                    role: 'user', content: `Tool \"${toolCall.name}\" executed successfully. Result:\r\n${output}\r\n\r\nNow use this result to complete the task. If more tools are needed, call them one at a time. If the task is complete, provide a summary of what was done.` }\r\n                            ]\r\n\r\n                            let hasMoreTools = true\r\n                            while (hasMoreTools && iterationCount < MAX_TOOL_ITERATIONS) {\r\n                                iterationCount++\r\n                                setStreamingContent('') // Clear for new response\r\n\r\n                                // IMPORTANT: Pass same JSON schema options for consistent tool calling in multi-turn\r\n                                const followUp = await offlineLLMService.generateStream(currentHistory, (token) => setStreamingContent(p => p + token), options)\r\n\r\n                                // Check if follow-up contains another tool call\r\n                                let followUpToolMatch = followUp.match(/```tool\\s*\\n?({[\\s\\S]*?})\\n?```/i)\r\n                                if (!followUpToolMatch) followUpToolMatch = followUp.match(/<tool>({[\\s\\S]*?})<\\/tool>/i)\r\n                                if (!followUpToolMatch) followUpToolMatch = followUp.match(/<tool_call>\\s*({[\\s\\S]*?})\\s*<\\/tool_call>/i)\r\n                                if (!followUpToolMatch) {\r\n                                    const hermesMatch = followUp.match(/<function=(\\w+)>([\\s\\S]*?)<\\/function>/i)\r\n                                    if (hermesMatch) {\r\n                                        try {\r\n                                            followUpToolMatch = [hermesMatch[0], JSON.stringify({ name: hermesMatch[1], params: JSON.parse(hermesMatch[2]) })]\r\n                                        } catch { /* ignore */ }\r\n                                    }\r\n                                }\r\n                                if (!followUpToolMatch) {\r\n                                    const jsonStart = followUp.indexOf('{\"name\":')\r\n                                    if (jsonStart !== -1) {\r\n                                        const jsonCandidate = followUp.substring(jsonStart)\r\n                                        for (let endPos = jsonCandidate.length; endPos >= 50; endPos--) {\r\n                                            try {\r\n                                                const potentialJson = jsonCandidate.substring(0, endPos)\r\n                                                const parsed = JSON.parse(potentialJson)\r\n                                                if (parsed.name && parsed.params) {\r\n                                                    followUpToolMatch = [potentialJson, potentialJson]\r\n                                                    break\r\n                                                }\r\n                                            } catch { continue }\r\n                                        }\r\n                                    }\r\n                                }\r\n\r\n                                if (followUpToolMatch) {\r\n                                    console.log(`[Agent] Multi-turn iteration ${iterationCount}: Tool call detected`)\r\n                                    try {\r\n                                        const nextToolCall = JSON.parse(followUpToolMatch[1])\r\n\r\n                                        // Show the follow-up message (minus tool call)\r\n                                        const followUpClean = followUp\r\n                                            .replace(/<thinking>[\\s\\S]*?<\\/thinking>/, '')\r\n                                            .replace(/<think>[\\s\\S]*?<\\/think>/, '')\r\n                                            .replace(/```tool[\\s\\S]*?```/, '')\r\n                                            .replace(/<tool>[\\s\\S]*?<\\/tool>/, '')\r\n                                            .replace(/<tool_call>[\\s\\S]*?<\\/tool_call>/, '')\r\n                                            .replace(/<function=\\w+>[\\s\\S]*?<\\/function>/, '')\r\n                                            .trim()\r\n\r\n                                        if (followUpClean) {\r\n                                            setAiMessages(prev => [...prev, {\r\n                                                id: crypto.randomUUID(),\r\n                                                role: 'assistant',\r\n                                                content: followUpClean,\r\n                                                timestamp: Date.now(),\r\n                                                modelId: loadedModelId!\r\n                                            }])\r\n                                        }\r\n\r\n                                        // Execute the next tool\r\n                                        console.log(`[Agent] Executing tool ${iterationCount}:`, nextToolCall.name)\r\n                                        const nextResult = await executeTool(nextToolCall.name, nextToolCall.params, { workspacePath: workspacePath || '' })\r\n                                        const nextOutput = nextResult.success ? (typeof nextResult.data === 'string' ? nextResult.data : JSON.stringify(nextResult.data, null, 2)) : `Error: ${nextResult.error}`\r\n\r\n                                        setAiMessages(prev => [...prev, { id: crypto.randomUUID(), role: 'tool', content: '', toolName: nextToolCall.name, toolResult: nextOutput, timestamp: Date.now() }])\r\n\r\n                                        if (nextToolCall.name === 'runCommand' && onRunCommand) {\r\n                                            onRunCommand(nextToolCall.params.command)\r\n                                        }\r\n\r\n                                        // Update history for next iteration\r\n                                        currentHistory = [\r\n                                            ...currentHistory,\r\n                                            { role: 'assistant', content: followUp },\r\n                                            { role: 'user', content: `Tool \"${nextToolCall.name}\" executed. Result:\\n${nextOutput}\\n\\nContinue with the task. Call another tool if needed, or summarize what was done.` }\r\n                                        ]\r\n                                    } catch (e) {\r\n                                        console.error(`[Agent] Multi-turn tool error at iteration ${iterationCount}:`, e)\r\n                                        hasMoreTools = false\r\n                                    }\r\n                                } else {\r\n                                    // No more tools - show final response\r\n                                    hasMoreTools = false\r\n                                    const followUpClean = followUp\r\n                                        .replace(/<thinking>[\\s\\S]*?<\\/thinking>/, '')\r\n                                        .replace(/<think>[\\s\\S]*?<\\/think>/, '')\r\n                                        .trim()\r\n\r\n                                    if (followUpClean) {\r\n                                        setAiMessages(prev => [...prev, {\r\n                                            id: crypto.randomUUID(),\r\n                                            role: 'assistant',\r\n                                            content: followUpClean,\r\n                                            timestamp: Date.now(),\r\n                                            modelId: loadedModelId!\r\n                                        }])\r\n                                    }\r\n                                    console.log(`[Agent] Multi-turn complete after ${iterationCount} iteration(s)`)\r\n                                }\r\n                            }\r\n\r\n                            if (iterationCount >= MAX_TOOL_ITERATIONS) {\r\n                                console.log(`[Agent] Reached max tool iterations (${MAX_TOOL_ITERATIONS})`)\r\n                                setAiMessages(prev => [...prev, {\r\n                                    id: crypto.randomUUID(),\r\n                                    role: 'assistant',\r\n                                    content: '⚠️ Reached maximum tool execution limit. Some tasks may be incomplete.',\r\n                                    timestamp: Date.now(),\r\n                                    isError: true\r\n                                }])\r\n                            }\r\n                        } catch (e) {\r\n                            console.error('[Agent] Tool execute error', e)\r\n                        }\r\n                    } else {\r\n                        console.log('[Agent] No tool call detected in response. Response stored as message.')\r\n                    }\r\n                } catch (e) {\r\n                    setAiMessages(prev => [...prev, { id: crypto.randomUUID(), role: 'assistant', content: `Error: ${e instanceof Error ? e.message : 'Offline generation failed'}`, timestamp: Date.now(), isError: true }])\r\n                } finally {\r\n                    setIsProcessing(false)\r\n                    setStreamingContent('')\r\n                }\r\n            } else {\r\n                // Cloud AI (with Agent support)\r\n                try {\r\n                    // Use full tool system prompt for cloud AI too\r\n                    const toolPrompt = getToolSystemPrompt(workspacePath || '', false)\r\n                    const contextInfo = includeContext ? `\\n\\nCURRENT CONTEXT:\\n${buildContext(false)}` : ''\r\n                    const sysPrompt = `${toolPrompt}${contextInfo}\r\n\r\nRESPONSE FORMAT FOR CLOUD AI:\r\nWhen calling tools, wrap your JSON in markdown code blocks:\r\n\\`\\`\\`tool\r\n{\"name\": \"toolName\", \"params\": {...}}\r\n\\`\\`\\``\r\n                    const chatHistory: AIMessage[] = [\r\n                        { role: 'system', content: sysPrompt },\r\n                        ...aiMessages.map(m => ({ role: m.role === 'tool' ? 'assistant' : m.role as any, content: m.role === 'tool' ? `Tool result: ${m.toolResult}` : m.content })),\r\n                        { role: 'user', content: text }\r\n                    ]\r\n\r\n                    const response = await aiService.chat(chatHistory, currentProvider)\r\n                    const mainContent = (response.content || '').replace(/```tool[\\s\\S]*?```/, '').trim()\r\n\r\n                    if (mainContent) {\r\n                        setAiMessages(prev => [...prev, { id: crypto.randomUUID(), role: 'assistant', content: mainContent, timestamp: Date.now() }])\r\n                    }\r\n\r\n                    // Tool Handling with multi-turn loop\r\n                    let toolMatch = response.content?.match(/```tool\\s*\\n?({[\\s\\S]*?})\\n?```/i)\r\n                    if (toolMatch) {\r\n                        try {\r\n                            const toolCall = JSON.parse(toolMatch[1])\r\n                            const result = await executeTool(toolCall.name, toolCall.params, { workspacePath: workspacePath || '' })\r\n\r\n                            const output = result.success ? (typeof result.data === 'string' ? result.data : JSON.stringify(result.data, null, 2)) : `Error: ${result.error}`\r\n\r\n                            setAiMessages(prev => [...prev, { id: crypto.randomUUID(), role: 'tool', content: '', toolName: toolCall.name, toolResult: output, timestamp: Date.now() }])\r\n\r\n                            if (toolCall.name === 'runCommand' && onRunCommand) {\r\n                                onRunCommand(toolCall.params.command)\r\n                            }\r\n\r\n                            // Multi-turn tool loop for cloud AI\r\n                            const MAX_TOOL_ITERATIONS = 5\r\n                            let iterationCount = 0\r\n                            let currentCloudHistory: AIMessage[] = [\r\n                                ...chatHistory,\r\n                                { role: 'assistant', content: response.content || '' },\r\n                                { role: 'user', content: `Tool ${toolCall.name} returned: ${output}. Continue with the task. If more tools are needed, call them. If done, summarize what was done.` }\r\n                            ]\r\n\r\n                            let hasMoreTools = true\r\n                            while (hasMoreTools && iterationCount < MAX_TOOL_ITERATIONS) {\r\n                                iterationCount++\r\n\r\n                                const followUp = await aiService.chat(currentCloudHistory, currentProvider)\r\n                                const followUpToolMatch = followUp.content?.match(/```tool\\s*\\n?({[\\s\\S]*?})\\n?```/i)\r\n\r\n                                if (followUpToolMatch) {\r\n                                    console.log(`[Agent] Cloud multi-turn iteration ${iterationCount}: Tool call detected`)\r\n                                    try {\r\n                                        const nextToolCall = JSON.parse(followUpToolMatch[1])\r\n\r\n                                        // Show the follow-up message (minus tool call)\r\n                                        const followUpClean = (followUp.content || '').replace(/```tool[\\s\\S]*?```/, '').trim()\r\n                                        if (followUpClean) {\r\n                                            setAiMessages(prev => [...prev, { id: crypto.randomUUID(), role: 'assistant', content: followUpClean, timestamp: Date.now() }])\r\n                                        }\r\n\r\n                                        // Execute the next tool\r\n                                        const nextResult = await executeTool(nextToolCall.name, nextToolCall.params, { workspacePath: workspacePath || '' })\r\n                                        const nextOutput = nextResult.success ? (typeof nextResult.data === 'string' ? nextResult.data : JSON.stringify(nextResult.data, null, 2)) : `Error: ${nextResult.error}`\r\n\r\n                                        setAiMessages(prev => [...prev, { id: crypto.randomUUID(), role: 'tool', content: '', toolName: nextToolCall.name, toolResult: nextOutput, timestamp: Date.now() }])\r\n\r\n                                        if (nextToolCall.name === 'runCommand' && onRunCommand) {\r\n                                            onRunCommand(nextToolCall.params.command)\r\n                                        }\r\n\r\n                                        // Update history for next iteration\r\n                                        currentCloudHistory = [\r\n                                            ...currentCloudHistory,\r\n                                            { role: 'assistant', content: followUp.content || '' },\r\n                                            { role: 'user', content: `Tool ${nextToolCall.name} returned: ${nextOutput}. Continue or summarize.` }\r\n                                        ]\r\n                                    } catch (e) {\r\n                                        console.error(`[Agent] Cloud multi-turn tool error at iteration ${iterationCount}:`, e)\r\n                                        hasMoreTools = false\r\n                                    }\r\n                                } else {\r\n                                    // No more tools - show final response\r\n                                    hasMoreTools = false\r\n                                    if (followUp.content) {\r\n                                        setAiMessages(prev => [...prev, { id: crypto.randomUUID(), role: 'assistant', content: followUp.content, timestamp: Date.now() }])\r\n                                    }\r\n                                    console.log(`[Agent] Cloud multi-turn complete after ${iterationCount} iteration(s)`)\r\n                                }\r\n                            }\r\n\r\n                            if (iterationCount >= MAX_TOOL_ITERATIONS) {\r\n                                console.log(`[Agent] Cloud reached max tool iterations (${MAX_TOOL_ITERATIONS})`)\r\n                                setAiMessages(prev => [...prev, {\r\n                                    id: crypto.randomUUID(),\r\n                                    role: 'assistant',\r\n                                    content: '⚠️ Reached maximum tool execution limit. Some tasks may be incomplete.',\r\n                                    timestamp: Date.now(),\r\n                                    isError: true\r\n                                }])\r\n                            }\r\n                        } catch (e) { console.error('Tool execute error', e) }\r\n                    }\r\n                } catch (e) {\r\n                    setAiMessages(prev => [...prev, { id: crypto.randomUUID(), role: 'assistant', content: `Error: ${e instanceof Error ? e.message : 'Failed'}`, timestamp: Date.now(), isError: true }])\r\n                } finally {\r\n                    setIsProcessing(false)\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    // --- Sub-components ---\r\n\r\n    // BUG #6: Sanitize AI responses to prevent XSS\r\n    const sanitizeContent = (text: string): string => {\r\n        return text\r\n            .replace(/</g, '&lt;')\r\n            .replace(/>/g, '&gt;')\r\n            .replace(/\"/g, '&quot;')\r\n            .replace(/'/g, '&#x27;')\r\n            .replace(/\\//g, '&#x2F;')\r\n    }\r\n\r\n    const MessageBubble = ({ msg }: { msg: ChatMessage }) => {\r\n        const isOwn = msg.senderId === userId.current || msg.role === 'user'\r\n\r\n        if (msg.role === 'tool') {\r\n            return (\r\n                <div className=\"tool-message\">\r\n                    <div className=\"tool-header\">\r\n                        <TerminalIcon size={12} />\r\n                        <span>{msg.toolName}</span>\r\n                    </div>\r\n                    <pre className=\"tool-output\">{msg.toolResult}</pre>\r\n                </div>\r\n            )\r\n        }\r\n\r\n        // Extract thinking blocks from content\r\n        const thinkingMatch = msg.content.match(/<thinking>([\\s\\S]*?)<\\/thinking>/i)\r\n        const thinking = thinkingMatch ? thinkingMatch[1].trim() : null\r\n        const contentWithoutThinking = msg.content.replace(/<thinking>[\\s\\S]*?<\\/thinking>/gi, '').trim()\r\n\r\n        return (\r\n            <>\r\n                {thinking && !isOwn && (\r\n                    <div className=\"thinking-block\">\r\n                        <div className=\"thinking-header\">\r\n                            <Loader2 size={12} className=\"thinking-spinner\" />\r\n                            <span>Thinking</span>\r\n                        </div>\r\n                        <div className=\"thinking-content\">{thinking}</div>\r\n                    </div>\r\n                )}\r\n                <div className={`message-bubble ${isOwn ? 'own' : ''} ${msg.isError ? 'error' : ''}`}>\r\n                    <div className=\"message-info\">\r\n                        <span className=\"sender-name\">{msg.sender === 'You' ? '' : (msg.sender || (msg.role === 'assistant' ? (msg.modelId ? getModelById(msg.modelId)?.name : 'Assistant') : ''))}</span>\r\n                        {msg.encrypted && <Lock size={10} className=\"lock-icon\" />}\r\n                    </div>\r\n                    <div\r\n                        className=\"bubble-content\"\r\n                        dangerouslySetInnerHTML={{\r\n                            __html: sanitizeContent(contentWithoutThinking || msg.content)\r\n                                .replace(/\\n/g, '<br/>') // Preserve line breaks after sanitization\r\n                        }}\r\n                    />\r\n                    <div className=\"message-time\">{new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>\r\n                </div>\r\n            </>\r\n        )\r\n    }\r\n\r\n    return (\r\n        <div className=\"unified-panel\">\r\n            {/* Top Tabs */}\r\n            <nav className=\"panel-tabs\">\r\n                <PanelTab icon={<MessageSquare size={16} />} label=\"Collaboration\" active={activeMode === 'collaboration'} onClick={() => setActiveMode('collaboration')} />\r\n                <PanelTab icon={<Zap size={16} />} label=\"Agent\" active={activeMode === 'agent'} onClick={() => setActiveMode('agent')} badge={agent.pendingCount} />\r\n            </nav>\r\n\r\n            {/* Content Area */}\r\n            <div className=\"panel-content\">\r\n                {activeMode === 'collaboration' && (\r\n                    <div className=\"mode-container collaboration\">\r\n                        <div className=\"mode-header\">\r\n                            <div className=\"header-title\">Team Chat</div>\r\n                            <div className=\"header-badges\">\r\n                                {encryptionEnabled && <span className=\"badge success\"><Lock size={12} /> Encrypted</span>}\r\n                                <span className={`status-dot ${synced ? 'online' : 'away'}`} />\r\n                            </div>\r\n                        </div>\r\n                        <div className=\"messages-list\">\r\n                            {p2pMessages.length === 0 ? (\r\n                                <div className=\"empty-state\">\r\n                                    <MessageSquare size={48} className=\"empty-icon\" />\r\n                                    <h3>No messages yet.</h3>\r\n                                    <p>Start the conversation!</p>\r\n                                </div>\r\n                            ) : (\r\n                                p2pMessages.map((m: any) => <MessageBubble key={m.id} msg={{ ...m, content: getP2PContent(m) }} />)\r\n                            )}\r\n                            <div ref={messagesEndRef} />\r\n                        </div>\r\n                    </div>\r\n                )}\r\n\r\n                {activeMode === 'agent' && (\r\n                    <div className=\"mode-container agent\">\r\n                        <div className=\"mode-header\">\r\n                            <div className=\"ai-source-toggle\">\r\n                                <button className={`src-btn ${!showAutonomous ? 'active' : ''}`} onClick={() => setShowAutonomous(false)}><Bot size={14} /> Chat</button>\r\n                                <button className={`src-btn ${showAutonomous ? 'active' : ''}`} onClick={() => setShowAutonomous(true)}>\r\n                                    <Zap size={14} /> Autonomous {agent.pendingCount > 0 && <span className=\"mini-badge\">{agent.pendingCount}</span>}\r\n                                </button>\r\n                            </div>\r\n                            <div className=\"header-controls\">\r\n                                {!showAutonomous ? (\r\n                                    <>\r\n                                        <div className=\"ai-mode-toggle\">\r\n                                            <button className={`mode-btn ${aiMode === 'cloud' ? 'active' : ''}`} onClick={() => setAiMode('cloud')}><Cloud size={12} /></button>\r\n                                            <button className={`mode-btn ${aiMode === 'offline' ? 'active' : ''}`} onClick={() => setAiMode('offline')}><Monitor size={12} /></button>\r\n                                        </div>\r\n                                        <button className={`tool-btn ${includeContext ? 'active' : ''}`} onClick={() => setIncludeContext(!includeContext)} title=\"Include workspace context\"><Paperclip size={16} /></button>\r\n                                        {aiMode === 'cloud' ? (\r\n                                            <select className=\"provider-select\" value={currentProvider} onChange={e => setCurrentProvider(e.target.value as any)}>\r\n                                                {availableCloudProviders.map(p => <option key={p} value={p}>{p.toUpperCase()}</option>)}\r\n                                                {availableCloudProviders.length === 0 && <option disabled>No API Keys</option>}\r\n                                            </select>\r\n                                        ) : (\r\n                                            <button className=\"model-select-btn\" onClick={() => setShowModelManager(true)}>\r\n                                                {currentOfflineModel ? currentOfflineModel.name : 'Select Model'} <ChevronDown size={12} />\r\n                                            </button>\r\n                                        )}\r\n                                        <button className=\"tool-btn\" onClick={() => setAiMessages([])} title=\"Clear history\"><Trash2 size={16} /></button>\r\n                                    </>\r\n                                ) : (\r\n                                    <>\r\n                                        <div className=\"ai-mode-toggle\">\r\n                                            <button className={`mode-btn ${agentAIMode === 'cloud' ? 'active' : ''}`} onClick={() => setAgentAIMode('cloud')} title=\"Cloud AI\"><Cloud size={12} /></button>\r\n                                            <button className={`mode-btn ${agentAIMode === 'offline' ? 'active' : ''}`} onClick={() => setAgentAIMode('offline')} title=\"Local AI\"><Monitor size={12} /></button>\r\n                                        </div>\r\n                                        {agentAIMode === 'offline' && (\r\n                                            <button className=\"model-select-btn\" onClick={() => setShowModelManager(true)}>\r\n                                                {currentOfflineModel ? currentOfflineModel.name : 'Select Model'} <ChevronDown size={12} />\r\n                                            </button>\r\n                                        )}\r\n                                        <button className={`toggle-switch ${agent.config.enabled ? 'on' : 'off'}`} onClick={agent.toggleEnabled} title={agent.canRun ? 'Toggle autonomous monitoring' : 'Configure API keys or load model to enable agent'}>\r\n                                            {agent.config.enabled ? 'ACTIVE' : 'IDLE'}\r\n                                        </button>\r\n                                        <button className={`tool-btn ${showLog ? 'active' : ''}`} onClick={() => setShowLog(!showLog)}><Scroll size={16} /></button>\r\n                                    </>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n\r\n                        {!showAutonomous ? (\r\n                            // Chat Mode\r\n                            <>\r\n\r\n                                {aiMode === 'offline' && isModelLoading && <div className=\"status-bar loading\"><Loader2 size={14} className=\"animate-spin mr-1\" /> Loading model...</div>}\r\n                                {aiMode === 'offline' && loadError && <div className=\"status-bar error\"><AlertCircle size={14} className=\"mr-1\" /> {loadError}</div>}\r\n                                <div className=\"status-bar note\"><Info size={14} className=\"inline mr-1\" /> Note: small parameter LLMS do not function as well as larger ones</div>\r\n\r\n                                <div className=\"messages-list\">\r\n                                    {aiMessages.length === 0 && !streamingContent && (\r\n                                        <div className=\"empty-state\">\r\n                                            <Bot size={48} className=\"empty-icon\" />\r\n                                            <h3>AI Agent Ready</h3>\r\n                                            <p>Ask me anything about your project or request changes with tool access.</p>\r\n                                        </div>\r\n                                    )}\r\n                                    {aiMessages.map(m => <MessageBubble key={m.id} msg={m} />)}\r\n\r\n                                    {/* Real-time Thinking Bubble during generation */}\r\n                                    {(isThinking || thinkingContent) && (\r\n                                        <div className={`thinking-bubble ${isThinking ? 'active' : ''}`}>\r\n                                            <button\r\n                                                className=\"thinking-toggle\"\r\n                                                onClick={() => setShowThinking(!showThinking)}\r\n                                            >\r\n                                                <Brain size={14} className={isThinking ? 'pulse' : ''} />\r\n                                                <span>Thinking{isThinking ? '...' : ''}</span>\r\n                                                <ChevronDown size={12} className={showThinking ? 'rotate' : ''} />\r\n                                            </button>\r\n                                            {showThinking && thinkingContent && (\r\n                                                <div className=\"thinking-content\">{thinkingContent}</div>\r\n                                            )}\r\n                                        </div>\r\n                                    )}\r\n\r\n                                    {/* Streaming Response (after thinking) */}\r\n                                    {streamingContent && (\r\n                                        <div className=\"message-bubble assistant streaming\">\r\n                                            <div className=\"bubble-content\">{streamingContent}</div>\r\n                                            <div className=\"typing-indicator\"><span></span><span></span><span></span></div>\r\n                                        </div>\r\n                                    )}\r\n\r\n                                    {/* Inline Tool Approval Card */}\r\n                                    {pendingToolRequest && (\r\n                                        <div className=\"inline-tool-approval\">\r\n                                            <div className=\"tool-card-header\">\r\n                                                <div className=\"tool-icon-wrapper execute\">\r\n                                                    <TerminalIcon size={16} />\r\n                                                </div>\r\n                                                <span className=\"tool-name\">\r\n                                                    Requesting: <strong>{pendingToolRequest.toolName}</strong>\r\n                                                </span>\r\n                                            </div>\r\n\r\n                                            <div className=\"tool-params\">\r\n                                                {Object.entries(pendingToolRequest.params).map(([key, value]) => (\r\n                                                    <div key={key} className=\"param-row\">\r\n                                                        <span className=\"param-key\">{key}:</span>\r\n                                                        <span className=\"param-value\">\r\n                                                            {typeof value === 'string' && value.includes('\\n') ? (\r\n                                                                <pre>{value}</pre>\r\n                                                            ) : (\r\n                                                                JSON.stringify(value)\r\n                                                            )}\r\n                                                        </span>\r\n                                                    </div>\r\n                                                ))}\r\n                                            </div>\r\n\r\n                                            <div className=\"tool-actions\">\r\n                                                <button\r\n                                                    className=\"action-btn reject\"\r\n                                                    onClick={() => {\r\n                                                        toolConfirmationResolver?.resolve({ approved: false, alwaysAllow: false })\r\n                                                        setPendingToolRequest(null)\r\n                                                    }}\r\n                                                >\r\n                                                    <X size={14} /> Cancel\r\n                                                </button>\r\n                                                <button\r\n                                                    className=\"action-btn approve\"\r\n                                                    onClick={() => {\r\n                                                        toolConfirmationResolver?.resolve({ approved: true, alwaysAllow: false })\r\n                                                        setPendingToolRequest(null)\r\n                                                    }}\r\n                                                >\r\n                                                    <Zap size={14} /> Run Tool\r\n                                                </button>\r\n                                            </div>\r\n                                        </div>\r\n                                    )}\r\n                                    <div ref={messagesEndRef} />\r\n                                </div>\r\n                            </>\r\n                        ) : (\r\n                            // Autonomous Mode\r\n                            <div className=\"agent-body\">\r\n                                {/* Workspace Scan Section */}\r\n                                {workspacePath && agent.config.enabled && (\r\n                                    <div className=\"workspace-scan-section\">\r\n                                        {/* Info Banner */}\r\n                                        <div className=\"scan-info-banner\">\r\n                                            <Info size={14} />\r\n                                            <span>\r\n                                                Analyzes up to <strong>500 lines</strong> per file across <strong>25 files</strong>.\r\n                                                Supports TypeScript, JavaScript, Python, Go, Rust, Java, C/C++, and more.\r\n                                                Timeout: 120s per file.\r\n                                            </span>\r\n                                        </div>\r\n\r\n                                        <button\r\n                                            className=\"scan-workspace-btn\"\r\n                                            onClick={async () => {\r\n                                                if (!workspacePath) return\r\n                                                setIsProcessing(true)\r\n                                                setScanProgress({ current: 0, total: 0, currentFile: 'Indexing workspace...' })\r\n\r\n                                                try {\r\n                                                    // All IDE-supported languages\r\n                                                    const codeExtensions = /\\.(ts|tsx|js|jsx|json|md|css|scss|html|py|rs|go|java|c|cpp|h|hpp|yaml|yml|xml|sql|sh|bash|ps1|rb|php|swift|kt|scala|vue|svelte|lua|r|m|mm|zig|nim|ex|exs|clj|hs|fs|dart|toml|ini|cfg|conf)$/i\r\n                                                    const ignoreDirs = ['node_modules', '.git', 'dist', 'build', '.next', '__pycache__', 'venv', '.venv', 'target', 'coverage', '.cache', '.turbo', '.vercel', 'vendor', 'packages', '.idea', '.vscode']\r\n\r\n                                                    const allCodeFiles: { name: string; path: string; size?: number }[] = []\r\n\r\n                                                    const collectFiles = async (dirPath: string, depth = 0) => {\r\n                                                        if (depth > 5) return\r\n\r\n                                                        const result = await globalThis.window.electronAPI?.fs.readDir(dirPath)\r\n                                                        if (!result?.success || !result.items) return\r\n\r\n                                                        for (const item of result.items) {\r\n                                                            if (ignoreDirs.includes(item.name) || item.name.startsWith('.')) continue\r\n\r\n                                                            const fullPath = `${dirPath}${dirPath.endsWith('/') || dirPath.endsWith('\\\\') ? '' : '/'}${item.name}`\r\n\r\n                                                            if (item.isDirectory) {\r\n                                                                await collectFiles(fullPath, depth + 1)\r\n                                                            } else if (codeExtensions.test(item.name)) {\r\n                                                                allCodeFiles.push({ name: item.name, path: fullPath, size: item.size })\r\n                                                            }\r\n                                                        }\r\n                                                    }\r\n\r\n                                                    await collectFiles(workspacePath)\r\n\r\n                                                    // Prioritize important files (entry points, configs, core logic)\r\n                                                    const priorityPatterns = [/index\\./i, /main\\./i, /app\\./i, /config/i, /\\.config\\./i, /service/i, /util/i, /helper/i]\r\n                                                    const sortedFiles = allCodeFiles\r\n                                                        .map(f => ({\r\n                                                            ...f,\r\n                                                            priority: priorityPatterns.some(p => p.test(f.name)) ? 0 : 1\r\n                                                        }))\r\n                                                        .sort((a, b) => a.priority - b.priority || (a.size || 0) - (b.size || 0))\r\n\r\n                                                    const filesToAnalyze = sortedFiles.slice(0, 25)\r\n                                                    setScanProgress({ current: 0, total: filesToAnalyze.length, currentFile: 'Starting analysis...' })\r\n\r\n                                                    if (filesToAnalyze.length === 0) {\r\n                                                        setAiMessages(prev => [...prev, {\r\n                                                            id: crypto.randomUUID(),\r\n                                                            role: 'assistant',\r\n                                                            content: 'No code files found in the workspace to analyze.',\r\n                                                            timestamp: Date.now()\r\n                                                        }])\r\n                                                        return\r\n                                                    }\r\n\r\n                                                    const allIssues: Array<{\r\n                                                        file: string\r\n                                                        path: string\r\n                                                        type: string\r\n                                                        severity: string\r\n                                                        line?: number\r\n                                                        description: string\r\n                                                        suggestion: string\r\n                                                    }> = []\r\n\r\n                                                    let skippedFiles = 0\r\n                                                    let timedOutFiles = 0\r\n                                                    let analyzedFiles = 0\r\n\r\n                                                    // Smart line extraction: get first 500 lines\r\n                                                    const extractSmartContent = (content: string, maxLines = 500): string => {\r\n                                                        const lines = content.split('\\n')\r\n                                                        if (lines.length <= maxLines) return content\r\n\r\n                                                        // Take first 500 lines (includes imports, class definitions, main logic)\r\n                                                        return lines.slice(0, maxLines).join('\\n')\r\n                                                    }\r\n\r\n                                                    // Detect language from extension\r\n                                                    const getLanguage = (fileName: string): string => {\r\n                                                        const ext = fileName.split('.').pop()?.toLowerCase() || ''\r\n                                                        const langMap: Record<string, string> = {\r\n                                                            'ts': 'TypeScript', 'tsx': 'TypeScript/React', 'js': 'JavaScript', 'jsx': 'JavaScript/React',\r\n                                                            'py': 'Python', 'rs': 'Rust', 'go': 'Go', 'java': 'Java', 'c': 'C', 'cpp': 'C++',\r\n                                                            'h': 'C Header', 'hpp': 'C++ Header', 'swift': 'Swift', 'kt': 'Kotlin',\r\n                                                            'rb': 'Ruby', 'php': 'PHP', 'sql': 'SQL', 'sh': 'Shell', 'bash': 'Bash',\r\n                                                            'vue': 'Vue', 'svelte': 'Svelte', 'scala': 'Scala', 'dart': 'Dart', 'lua': 'Lua',\r\n                                                            'r': 'R', 'ex': 'Elixir', 'hs': 'Haskell', 'fs': 'F#', 'clj': 'Clojure', 'zig': 'Zig'\r\n                                                        }\r\n                                                        return langMap[ext] || ext.toUpperCase()\r\n                                                    }\r\n\r\n                                                    // Analyze each file with 120s timeout\r\n                                                    for (let i = 0; i < filesToAnalyze.length; i++) {\r\n                                                        const file = filesToAnalyze[i]\r\n                                                        setScanProgress({ current: i + 1, total: filesToAnalyze.length, currentFile: file.name })\r\n\r\n                                                        const content = await globalThis.window.electronAPI?.fs.readFile(file.path)\r\n                                                        if (!content?.success || !content.content) {\r\n                                                            skippedFiles++\r\n                                                            continue\r\n                                                        }\r\n\r\n                                                        // Skip very small files (< 5 lines)\r\n                                                        const lineCount = content.content.split('\\n').length\r\n                                                        if (lineCount < 5) {\r\n                                                            skippedFiles++\r\n                                                            continue\r\n                                                        }\r\n\r\n                                                        // Extract fewer lines for offline (faster), more for cloud\r\n                                                        const maxLines = agentAIMode === 'offline' ? 200 : 500\r\n                                                        const fileContent = extractSmartContent(content.content, maxLines)\r\n                                                        const language = getLanguage(file.name)\r\n\r\n                                                        // Simpler prompt for offline models (faster generation)\r\n                                                        const offlinePrompt = `Review this ${language} file \"${file.name}\".\r\n\r\n${fileContent}\r\n\r\nReturn JSON: {\"issues\":[{\"type\":\"bug\"|\"security\"|\"performance\"|\"improvement\",\"description\":\"...\",\"suggestion\":\"...\"}]}`\r\n\r\n                                                        const cloudPrompt = `Analyze this ${language} code for bugs, security issues, and improvements.\r\n\r\nFile: ${file.name} (${lineCount} lines total, showing first ${Math.min(lineCount, maxLines)})\r\n\r\n\\`\\`\\`${language.toLowerCase()}\r\n${fileContent}\r\n\\`\\`\\`\r\n\r\nFind REAL issues only:\r\n- Bugs: null refs, logic errors, type issues\r\n- Security: XSS, injection, hardcoded secrets, unsafe patterns\r\n- Performance: memory leaks, inefficient code, N+1 queries\r\n- Improvements: dead code, missing error handling, bad practices\r\n\r\nOutput JSON with issues array. If no issues, return {\"issues\": []}`\r\n\r\n                                                        const prompt = agentAIMode === 'offline' ? offlinePrompt : cloudPrompt\r\n\r\n                                                        try {\r\n                                                            let response: string\r\n\r\n                                                            // 60s timeout for offline (smaller context), 120s for cloud\r\n                                                            const fileTimeoutMs = agentAIMode === 'offline' ? 60000 : 120000\r\n                                                            let timeoutId: number | undefined\r\n\r\n                                                            if (agentAIMode === 'offline' && loadedModelId) {\r\n                                                                // Note: Don't use jsonSchema with small offline models - causes them to stall\r\n                                                                // Instead, use prompt-based JSON formatting with lower maxTokens for speed\r\n                                                                const generatePromise = offlineLLMService.generate([\r\n                                                                    { role: 'system', content: `You are a code reviewer. Output ONLY valid JSON.` },\r\n                                                                    { role: 'user', content: prompt }\r\n                                                                ], {\r\n                                                                    temperature: 0.1,\r\n                                                                    maxTokens: 800 // Lower tokens for faster response\r\n                                                                })\r\n\r\n                                                                // Create timeout that also cancels the generation\r\n                                                                const timeoutPromise = new Promise<string>((_, reject) => {\r\n                                                                    timeoutId = window.setTimeout(async () => {\r\n                                                                        // Cancel the ongoing generation\r\n                                                                        await offlineLLMService.cancelGeneration()\r\n                                                                        reject(new Error('Analysis timed out'))\r\n                                                                    }, fileTimeoutMs)\r\n                                                                })\r\n\r\n                                                                try {\r\n                                                                    response = await Promise.race([generatePromise, timeoutPromise])\r\n                                                                } finally {\r\n                                                                    if (timeoutId) clearTimeout(timeoutId)\r\n                                                                }\r\n                                                            } else {\r\n                                                                // Cloud AI mode with 120s timeout\r\n                                                                const cloudTimeoutPromise = new Promise<any>((_, reject) => {\r\n                                                                    timeoutId = window.setTimeout(() => reject(new Error('Analysis timed out')), fileTimeoutMs)\r\n                                                                })\r\n\r\n                                                                const chatPromise = aiService.chat([\r\n                                                                    { role: 'system', content: `You are a senior ${language} code reviewer. Find bugs, security issues, and improvements. Output valid JSON only.` },\r\n                                                                    { role: 'user', content: prompt }\r\n                                                                ], currentProvider, {\r\n                                                                    temperature: 0.1,\r\n                                                                    maxTokens: 1200\r\n                                                                })\r\n\r\n                                                                try {\r\n                                                                    const cloudResponse = await Promise.race([chatPromise, cloudTimeoutPromise])\r\n                                                                    if (typeof cloudResponse === 'string') {\r\n                                                                        throw new Error(cloudResponse)\r\n                                                                    }\r\n                                                                    if (cloudResponse.error) {\r\n                                                                        console.error('Cloud AI error:', cloudResponse.error)\r\n                                                                        skippedFiles++\r\n                                                                        continue\r\n                                                                    }\r\n                                                                    response = cloudResponse.content\r\n                                                                } finally {\r\n                                                                    if (timeoutId) clearTimeout(timeoutId)\r\n                                                                }\r\n                                                            }\r\n\r\n                                                            analyzedFiles++\r\n\r\n                                                            // Parse JSON response\r\n                                                            let jsonStr = response\r\n                                                            const jsonMatch = /```json?\\n?([\\s\\S]*?)\\n?```/.exec(response) || /{[\\s\\S]*}/.exec(response)\r\n                                                            if (jsonMatch) {\r\n                                                                jsonStr = jsonMatch[1] || jsonMatch[0]\r\n                                                            }\r\n\r\n                                                            const analysis = JSON.parse(jsonStr)\r\n\r\n                                                            if (analysis.issues && Array.isArray(analysis.issues)) {\r\n                                                                for (const issue of analysis.issues) {\r\n                                                                    if (issue.description && issue.suggestion) {\r\n                                                                        allIssues.push({\r\n                                                                            file: file.name,\r\n                                                                            path: file.path,\r\n                                                                            type: issue.type || 'improvement',\r\n                                                                            severity: issue.severity || 'medium',\r\n                                                                            line: issue.line,\r\n                                                                            description: issue.description,\r\n                                                                            suggestion: issue.suggestion\r\n                                                                        })\r\n                                                                    }\r\n                                                                }\r\n                                                            }\r\n                                                        } catch (e) {\r\n                                                            const errorMsg = e instanceof Error ? e.message : 'Unknown error'\r\n                                                            if (errorMsg.includes('timed out')) {\r\n                                                                timedOutFiles++\r\n                                                                console.warn('Analysis timed out for', file.name)\r\n                                                            } else {\r\n                                                                console.error('Failed to analyze', file.name, e)\r\n                                                                skippedFiles++\r\n                                                            }\r\n                                                        }\r\n                                                    }\r\n\r\n                                                    // Sort issues by severity\r\n                                                    const severityOrder = { critical: 0, high: 1, medium: 2, low: 3 }\r\n                                                    allIssues.sort((a, b) => (severityOrder[a.severity as keyof typeof severityOrder] || 3) - (severityOrder[b.severity as keyof typeof severityOrder] || 3))\r\n\r\n                                                    // Map severity to confidence\r\n                                                    const severityToConfidence: Record<string, number> = { critical: 0.95, high: 0.85, medium: 0.7, low: 0.5 }\r\n\r\n                                                    // Add issues to agent suggestions system\r\n                                                    const agentSuggestions = allIssues.slice(0, 20).map(issue => ({\r\n                                                        action: 'suggest' as const,\r\n                                                        target: 'file-system' as const,\r\n                                                        description: `[${issue.type.toUpperCase()}] ${issue.file}${issue.line ? `:${issue.line}` : ''}: ${issue.description}`,\r\n                                                        reasoning: issue.suggestion,\r\n                                                        confidence: severityToConfidence[issue.severity] || 0.6,\r\n                                                        payload: {\r\n                                                            message: issue.suggestion,\r\n                                                            category: issue.type as 'bug' | 'security' | 'performance' | 'improvement',\r\n                                                            filePath: issue.path,\r\n                                                            lineNumber: issue.line\r\n                                                        }\r\n                                                    }))\r\n\r\n                                                    if (agentSuggestions.length > 0) {\r\n                                                        agent.addSuggestions(agentSuggestions)\r\n                                                    }\r\n\r\n                                                    // Summary counts\r\n                                                    const bugCount = allIssues.filter(i => i.type === 'bug').length\r\n                                                    const securityCount = allIssues.filter(i => i.type === 'security').length\r\n                                                    const perfCount = allIssues.filter(i => i.type === 'performance').length\r\n                                                    const improvementCount = allIssues.filter(i => i.type === 'improvement').length\r\n\r\n                                                    // Build status notes\r\n                                                    const statusNotes: string[] = []\r\n                                                    if (skippedFiles > 0) statusNotes.push(`${skippedFiles} skipped`)\r\n                                                    if (timedOutFiles > 0) statusNotes.push(`${timedOutFiles} timed out`)\r\n\r\n                                                    // Add summary message to chat\r\n                                                    setAiMessages(prev => [...prev, {\r\n                                                        id: crypto.randomUUID(),\r\n                                                        role: 'assistant',\r\n                                                        content: `**Workspace Scan Complete**\\n\\nSuccessfully analyzed **${analyzedFiles}** of ${filesToAnalyze.length} files.${statusNotes.length > 0 ? `\\n_(${statusNotes.join(', ')})_` : ''}\\n\\n` +\r\n                                                            (allIssues.length > 0\r\n                                                                ? `Found **${allIssues.length}** issues:\\n` +\r\n                                                                  `- 🐛 Bugs: ${bugCount}\\n` +\r\n                                                                  `- 🔒 Security: ${securityCount}\\n` +\r\n                                                                  `- ⚡ Performance: ${perfCount}\\n` +\r\n                                                                  `- 💡 Improvements: ${improvementCount}\\n\\n` +\r\n                                                                  `**Review issues in the Pending Tasks section above** to approve or reject suggestions.`\r\n                                                                : '✅ No major issues found! Your code looks good.'),\r\n                                                        timestamp: Date.now()\r\n                                                    }])\r\n\r\n                                                } catch (err) {\r\n                                                    setAiMessages(prev => [...prev, {\r\n                                                        id: crypto.randomUUID(),\r\n                                                        role: 'assistant',\r\n                                                        content: `Error scanning workspace: ${err instanceof Error ? err.message : 'Unknown error'}`,\r\n                                                        timestamp: Date.now(),\r\n                                                        isError: true\r\n                                                    }])\r\n                                                } finally {\r\n                                                    setIsProcessing(false)\r\n                                                    setScanProgress(null)\r\n                                                }\r\n                                            }}\r\n                                            disabled={!agent.canRun || isProcessing}\r\n                                        >\r\n                                            {isProcessing ? <Loader2 size={14} className=\"animate-spin\" /> : <AlertCircle size={14} />}\r\n                                            {isProcessing\r\n                                                ? (scanProgress\r\n                                                    ? `Scanning (${scanProgress.current}/${scanProgress.total})...`\r\n                                                    : 'Scanning...')\r\n                                                : 'Scan Workspace Files'}\r\n                                        </button>\r\n                                        {scanProgress && (\r\n                                            <div className=\"scan-progress\">\r\n                                                <div className=\"progress-bar\">\r\n                                                    <div\r\n                                                        className=\"progress-fill\"\r\n                                                        style={{ width: `${scanProgress.total > 0 ? (scanProgress.current / scanProgress.total) * 100 : 0}%` }}\r\n                                                    />\r\n                                                </div>\r\n                                                <span className=\"progress-file\">{scanProgress.currentFile}</span>\r\n                                            </div>\r\n                                        )}\r\n                                        <p className=\"scan-description\">\r\n                                            Deep scan of all code files for bugs, security vulnerabilities, performance issues, and improvements.\r\n                                        </p>\r\n                                    </div>\r\n                                )}\r\n\r\n                                {agent.suggestions.filter(s => s.status === 'pending').length > 0 && (\r\n                                    <div className=\"suggestions-section\">\r\n                                        <div className=\"section-title\">Pending Tasks ({agent.pendingCount})</div>\r\n                                        <div className=\"suggestions-list\">\r\n                                            {agent.suggestions.filter(s => s.status === 'pending').map(s => {\r\n                                                const category = (s.payload as any)?.category || 'improvement'\r\n                                                const isBug = category === 'bug'\r\n                                                const isPerformance = category === 'performance'\r\n                                                const isSecurity = category === 'security'\r\n                                                const isImprovement = category === 'improvement'\r\n                                                const filePath = (s.payload as any)?.filePath\r\n                                                const lineNumber = (s.payload as any)?.lineNumber\r\n\r\n                                                return (\r\n                                                    <div key={s.id} className={`suggestion-card ${isBug ? 'bug' : ''} ${isSecurity ? 'security' : ''}`}>\r\n                                                        <div className=\"card-header\">\r\n                                                            {isBug && <Bug size={14} />}\r\n                                                            {isSecurity && <Shield size={14} />}\r\n                                                            {isPerformance && <Zap size={14} />}\r\n                                                            {isImprovement && <Lightbulb size={14} />}\r\n                                                            {isBug && <span className=\"category-badge bug\">BUG</span>}\r\n                                                            {isSecurity && <span className=\"category-badge security\">SECURITY</span>}\r\n                                                            {isPerformance && <span className=\"category-badge performance\">PERFORMANCE</span>}\r\n                                                            {isImprovement && <span className=\"category-badge improvement\">IMPROVEMENT</span>}\r\n                                                            <span className=\"confidence-score\">{Math.round(s.confidence * 100)}%</span>\r\n                                                        </div>\r\n                                                        {filePath && (\r\n                                                            <div className=\"card-file-path\">\r\n                                                                {filePath.split(/[/\\\\]/).pop()}{lineNumber ? `:${lineNumber}` : ''}\r\n                                                            </div>\r\n                                                        )}\r\n                                                        <div className=\"card-body\">\r\n                                                            <div className=\"desc\">{s.description}</div>\r\n                                                            <div className=\"reason\">{s.reasoning}</div>\r\n                                                        </div>\r\n                                                        <div className=\"card-actions\">\r\n                                                            <button className=\"reject-btn\" onClick={() => agent.rejectSuggestion(s.id)}><X size={14} /> Dismiss</button>\r\n                                                            <button className=\"approve-btn\" onClick={() => agent.approveSuggestion(s.id)}><Check size={14} /> Apply</button>\r\n                                                        </div>\r\n                                                    </div>\r\n                                                )\r\n                                            })}\r\n                                        </div>\r\n                                    </div>\r\n                                )}\r\n\r\n                                {showLog && (\r\n                                    <div className=\"log-section\">\r\n                                        <div className=\"log-header\">\r\n                                            <span>Activity Log</span>\r\n                                            <button className=\"clear-link\" onClick={agent.clearActivityLog}>Clear</button>\r\n                                        </div>\r\n                                        <div className=\"log-entries\">\r\n                                            {agent.activityLog.map(entry => (\r\n                                                <div key={entry.id} className=\"log-entry\">\r\n                                                    <span className=\"entry-icon\">{entry.type === 'execution' ? <Zap size={10} /> : <Scroll size={10} />}</span>\r\n                                                    <span className=\"entry-msg\">{entry.message}</span>\r\n                                                    <span className=\"entry-time\">{new Date(entry.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>\r\n                                                </div>\r\n                                            ))}\r\n                                        </div>\r\n                                    </div>\r\n                                )}\r\n\r\n                                {!agent.config.enabled && agent.suggestions.filter(s => s.status === 'pending').length === 0 && (\r\n                                    <div className=\"agent-intro\">\r\n                                        <Zap size={48} className=\"intro-icon\" />\r\n                                        <h3>Autonomous Agent</h3>\r\n                                        <p>\r\n                                            {agent.canRun\r\n                                                ? 'Enable the agent to automatically detect bugs, suggest fixes, identify code quality issues, and provide actionable improvements while you work.'\r\n                                                : agentAIMode === 'offline'\r\n                                                    ? 'Load an offline model to enable autonomous bug detection and code analysis.'\r\n                                                    : 'The autonomous agent requires valid API keys for OpenAI, Anthropic, or Google to function.'\r\n                                            }\r\n                                        </p>\r\n                                        {!agent.canRun && (\r\n                                            <div className=\"setup-hint\">\r\n                                                {agentAIMode === 'offline'\r\n                                                    ? 'Click the model selector above to choose and load a model.'\r\n                                                    : 'Configure keys in Settings > API Keys or switch to Local AI mode.'\r\n                                                }\r\n                                            </div>\r\n                                        )}\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                )}\r\n            </div>\r\n\r\n            {/* Input Section */}\r\n            {(activeMode === 'collaboration' || (activeMode === 'agent' && !showAutonomous)) && (\r\n                <div className=\"input-section\">\r\n                    <div className=\"input-wrapper\">\r\n                        <textarea\r\n                            ref={inputRef}\r\n                            className=\"panel-textarea\"\r\n                            placeholder={activeMode === 'collaboration' ? \"Message team...\" : \"Ask agent...\"}\r\n                            value={input}\r\n                            onChange={e => setInput(e.target.value)}\r\n                            onKeyDown={e => {\r\n                                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); }\r\n                            }}\r\n                            rows={1}\r\n                            disabled={isProcessing || (activeMode === 'collaboration' && !canChat)}\r\n                        />\r\n                        <button\r\n                            className={`send-action ${isProcessing ? 'stop-btn' : ''}`}\r\n                            onClick={isProcessing ? handleStop : handleSend}\r\n                            disabled={!isProcessing && !input.trim()}\r\n                            title={isProcessing ? \"Stop generation\" : \"Send message\"}\r\n                        >\r\n                            {isProcessing ? <Square size={18} /> : <Send size={18} />}\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            {showModelManager && <UnifiedSettingsPanel onClose={() => setShowModelManager(false)} />}\r\n\r\n            <style>{`\r\n                .unified-panel {\r\n                    display: flex;\r\n                    flex-direction: column;\r\n                    height: 100%;\r\n                    background: var(--color-bg);\r\n                    border-left: 1px solid var(--color-border-subtle);\r\n                    color: var(--color-text);\r\n                    font-family: var(--font-sans);\r\n                }\r\n\r\n                .panel-tabs {\r\n                    display: flex;\r\n                    padding: var(--space-2);\r\n                    background: var(--color-surface);\r\n                    border-bottom: 1px solid var(--color-border-subtle);\r\n                    gap: var(--space-1);\r\n                }\r\n\r\n                .tab-btn {\r\n                    flex: 1;\r\n                    display: flex;\r\n                    align-items: center;\r\n                    justify-content: center;\r\n                    gap: var(--space-2);\r\n                    padding: var(--space-2);\r\n                    font-size: var(--text-xs);\r\n                    font-weight: var(--font-medium);\r\n                    color: var(--color-text-tertiary);\r\n                    border-radius: var(--radius-md);\r\n                    transition: all var(--transition-fast);\r\n                    position: relative;\r\n                    border: none;\r\n                    background: transparent;\r\n                }\r\n        \r\n                .tab-btn:hover { color: var(--color-text-secondary); background: var(--color-surface-elevated); }\r\n                .tab-btn.active { color: var(--color-accent); background: rgba(59, 130, 246, 0.1); }\r\n        \r\n                .badge-count {\r\n                    position: absolute;\r\n                    top: 2px;\r\n                    right: 2px;\r\n                    background: var(--color-accent);\r\n                    color: #000;\r\n                    font-size: 9px;\r\n                    font-weight: 700;\r\n                    min-width: 14px;\r\n                    height: 14px;\r\n                    border-radius: 7px;\r\n                    display: flex;\r\n                    align-items: center;\r\n                    justify-content: center;\r\n                    padding: 0 4px;\r\n                }\r\n        \r\n                .panel-content {\r\n                    flex: 1;\r\n                    overflow: hidden;\r\n                    position: relative;\r\n                }\r\n        \r\n                .mode-container {\r\n                    display: flex;\r\n                    flex-direction: column;\r\n                    height: 100%;\r\n                }\r\n        \r\n                .mode-header {\r\n                    display: flex;\r\n                    justify-content: space-between;\r\n                    align-items: center;\r\n                    padding: var(--space-3) var(--space-4);\r\n                    border-bottom: 1px solid var(--color-border-subtle);\r\n                    background: var(--color-surface-subtle);\r\n                }\r\n        \r\n                .header-title { font-size: var(--text-sm); font-weight: 600; color: var(--color-text-secondary); }\r\n        \r\n                .header-badges { display: flex; align-items: center; gap: var(--space-3); }\r\n                .badge { font-size: 10px; padding: 2px 6px; border-radius: var(--radius-sm); font-weight: 600; display: flex; align-items: center; gap: 4px; }\r\n                .badge.success { background: rgba(34, 197, 94, 0.1); color: var(--color-success); }\r\n                .status-dot { width: 8px; height: 8px; border-radius: 50%; }\r\n                .status-dot.online { background: var(--color-success); }\r\n                .status-dot.away { background: var(--color-warning); }\r\n        \r\n                .messages-list {\r\n                    flex: 1;\r\n                    overflow-y: auto;\r\n                    padding: var(--space-4);\r\n                    display: flex;\r\n                    flex-direction: column;\r\n                    gap: var(--space-3);\r\n                }\r\n        \r\n                .message-bubble {\r\n                    max-width: 90%;\r\n                    padding: var(--space-3);\r\n                    border-radius: var(--radius-lg);\r\n                    font-size: var(--text-sm);\r\n                    line-height: 1.5;\r\n                    align-self: flex-start;\r\n                    background: var(--color-surface-elevated);\r\n                    border: 1px solid var(--color-border-subtle);\r\n                }\r\n        \r\n                .message-bubble.own {\r\n                    align-self: flex-end;\r\n                    background: var(--color-accent);\r\n                    color: #000;\r\n                    border-color: transparent;\r\n                }\r\n        \r\n                .message-bubble.error { border-color: var(--color-error); }\r\n        \r\n                .message-info {\r\n                    display: flex;\r\n                    align-items: center;\r\n                    gap: 6px;\r\n                    margin-bottom: 4px;\r\n                    font-size: 10px;\r\n                    font-weight: 600;\r\n                    color: var(--color-text-muted);\r\n                }\r\n\r\n                .bubble-content { white-space: pre-wrap; word-break: break-word; }\r\n                .message-time { font-size: 9px; opacity: 0.6; margin-top: 4px; text-align: right; }\r\n\r\n                .tool-message {\r\n                    background: var(--color-bg-darker, #111);\r\n                    border: 1px solid var(--color-accent);\r\n                    border-radius: var(--radius-md);\r\n                    overflow: hidden;\r\n                    margin: var(--space-1) 0;\r\n                    max-width: 90%;\r\n                }\r\n\r\n                .tool-header {\r\n                    padding: 4px 8px;\r\n                    background: rgba(59, 130, 246, 0.15);\r\n                    color: var(--color-accent);\r\n                    font-size: 11px;\r\n                    font-weight: 600;\r\n                    display: flex;\r\n                    align-items: center;\r\n                    gap: 6px;\r\n                }\r\n\r\n                .tool-output {\r\n                    padding: 8px;\r\n                    margin: 0;\r\n                    font-family: var(--font-mono);\r\n                    font-size: 11px;\r\n                    overflow-x: auto;\r\n                    color: var(--color-text-secondary);\r\n                    white-space: pre-wrap;\r\n                }\r\n\r\n                .thinking-header {\r\n                    padding: 6px 10px;\r\n                    background: rgba(168, 85, 247, 0.1);\r\n                    color: #a855f7;\r\n                    font-size: 11px;\r\n                    font-weight: 600;\r\n                    display: flex;\r\n                    align-items: center;\r\n                    gap: 6px;\r\n                }\r\n\r\n                .thinking-spinner {\r\n                    animation: spin 1s linear infinite;\r\n                }\r\n\r\n                @keyframes spin {\r\n                    from { transform: rotate(0deg); }\r\n                    to { transform: rotate(360deg); }\r\n                }\r\n\r\n                .thinking-content {\r\n                    padding: 10px;\r\n                    font-size: 12px;\r\n                    line-height: 1.6;\r\n                    color: var(--color-text-secondary);\r\n                    white-space: pre-wrap;\r\n                    font-style: italic;\r\n                }\r\n\r\n                /* Real-time Thinking Bubble */\r\n                .thinking-bubble {\r\n                    background: rgba(168, 85, 247, 0.08);\r\n                    border: 1px solid rgba(168, 85, 247, 0.25);\r\n                    border-radius: var(--radius-lg);\r\n                    margin: var(--space-2) 0;\r\n                    max-width: 90%;\r\n                    overflow: hidden;\r\n                }\r\n\r\n                .thinking-bubble.active {\r\n                    border-color: rgba(168, 85, 247, 0.5);\r\n                    box-shadow: 0 0 12px rgba(168, 85, 247, 0.15);\r\n                }\r\n\r\n                .thinking-toggle {\r\n                    width: 100%;\r\n                    display: flex;\r\n                    align-items: center;\r\n                    gap: 8px;\r\n                    padding: 10px 14px;\r\n                    background: transparent;\r\n                    border: none;\r\n                    color: #a855f7;\r\n                    font-size: 12px;\r\n                    font-weight: 600;\r\n                    cursor: pointer;\r\n                    transition: background 0.15s;\r\n                }\r\n\r\n                .thinking-toggle:hover {\r\n                    background: rgba(168, 85, 247, 0.1);\r\n                }\r\n\r\n                .thinking-toggle.pulse {\r\n                    animation: pulse 1.5s ease-in-out infinite;\r\n                }\r\n\r\n                @keyframes pulse {\r\n                    0%, 100% { opacity: 1; transform: scale(1); }\r\n                    50% { opacity: 0.6; transform: scale(1.1); }\r\n                }\r\n\r\n                .thinking-toggle.rotate {\r\n                    transform: rotate(180deg);\r\n                }\r\n\r\n                .thinking-bubble .thinking-content {\r\n                    padding: 0 14px 12px;\r\n                    border-top: 1px solid rgba(168, 85, 247, 0.15);\r\n                    animation: fadeIn 0.2s ease-out;\r\n                }\r\n\r\n                @keyframes fadeIn {\r\n                    from { opacity: 0; transform: translateY(-5px); }\r\n                    to { opacity: 1; transform: translateY(0); }\r\n                }\r\n\r\n                .subscription-notice {\r\n                    padding: var(--space-2);\r\n                    background: rgba(239, 68, 68, 0.1);\r\n                    border: 1px solid var(--color-error);\r\n                    border-radius: var(--radius-md);\r\n                    color: var(--color-error);\r\n                    font-size: 11px;\r\n                    font-weight: 600;\r\n                    text-align: center;\r\n                }\r\n\r\n                .input-section {\r\n                    padding: var(--space-3) var(--space-4);\r\n                    border-top: 1px solid var(--color-border-subtle);\r\n                    background: var(--color-surface);\r\n                }\r\n\r\n                .input-wrapper {\r\n                    display: flex;\r\n                    align-items: flex-end;\r\n                    gap: var(--space-2);\r\n                    background: var(--color-bg);\r\n                    border: 1px solid var(--color-border);\r\n                    border-radius: var(--radius-lg);\r\n                    padding: 6px 10px;\r\n                    transition: border-color var(--transition-fast);\r\n                }\r\n\r\n                .input-wrapper:focus-within { border-color: var(--color-accent); }\r\n\r\n                .panel-textarea {\r\n                    flex: 1;\r\n                    background: transparent;\r\n                    border: none;\r\n                    color: var(--color-text);\r\n                    font-size: var(--text-sm);\r\n                    resize: none;\r\n                    padding: 6px 0;\r\n                    max-height: 120px;\r\n                    outline: none;\r\n                    line-height: 1.4;\r\n                }\r\n\r\n                .send-action {\r\n                    width: 32px;\r\n                    height: 32px;\r\n                    display: flex;\r\n                    align-items: center;\r\n                    justify-content: center;\r\n                    color: var(--color-accent);\r\n                    border-radius: var(--radius-md);\r\n                    transition: transform var(--transition-fast);\r\n                    border: none;\r\n                    background: transparent;\r\n                    cursor: pointer;\r\n                }\r\n\r\n                .send-action:hover:not(:disabled) { transform: translateY(-1px); color: var(--color-accent-hover); }\r\n                .send-action:disabled { opacity: 0.4; cursor: not-allowed; }\r\n                .send-action.stop-btn { color: var(--color-error); }\r\n                .send-action.stop-btn:hover:not(:disabled) { color: #ff4444; }\r\n\r\n                .ai-source-toggle {\r\n                    display: flex;\r\n                    background: var(--color-surface-elevated);\r\n                    padding: 3px;\r\n                    border-radius: var(--radius-md);\r\n                    gap: 4px;\r\n                    border: 1px solid var(--color-border-subtle);\r\n                }\r\n\r\n                .src-btn {\r\n                    display: flex;\r\n                    align-items: center;\r\n                    gap: 6px;\r\n                    padding: 5px 12px;\r\n                    font-size: 11px;\r\n                    font-weight: 500;\r\n                    color: var(--color-text-tertiary);\r\n                    border-radius: var(--radius-sm);\r\n                    transition: all var(--transition-fast);\r\n                    position: relative;\r\n                    border: none;\r\n                }\r\n\r\n                .src-btn.active { background: var(--color-surface); color: var(--color-text); box-shadow: var(--shadow-sm); }\r\n\r\n                .mini-badge {\r\n                    background: var(--color-error);\r\n                    color: #fff;\r\n                    font-size: 9px;\r\n                    font-weight: 700;\r\n                    padding: 1px 4px;\r\n                    border-radius: 8px;\r\n                    margin-left: 4px;\r\n                }\r\n\r\n                .ai-mode-toggle {\r\n                    display: flex;\r\n                    gap: 4px;\r\n                    padding: 3px;\r\n                    background: var(--color-surface-elevated);\r\n                    border-radius: var(--radius-md);\r\n                    border: 1px solid var(--color-border-subtle);\r\n                }\r\n\r\n                .mode-btn {\r\n                    width: 26px;\r\n                    height: 26px;\r\n                    display: flex;\r\n                    align-items: center;\r\n                    justify-content: center;\r\n                    color: var(--color-text-tertiary);\r\n                    border-radius: var(--radius-sm);\r\n                    transition: all var(--transition-fast);\r\n                    border: none;\r\n                }\r\n\r\n                .mode-btn:hover { background: var(--color-surface); }\r\n                .mode-btn.active { background: var(--color-surface); color: var(--color-accent); box-shadow: var(--shadow-sm); }\r\n\r\n                .header-controls { display: flex; align-items: center; gap: var(--space-3); }\r\n                .tool-btn {\r\n                    width: 28px;\r\n                    height: 28px;\r\n                    display: flex;\r\n                    align-items: center;\r\n                    justify-content: center;\r\n                    color: var(--color-text-tertiary);\r\n                    border-radius: var(--radius-sm);\r\n                    transition: all var(--transition-fast);\r\n                    border: none;\r\n                    background: transparent;\r\n                }\r\n                .tool-btn:hover { background: var(--color-surface-elevated); color: var(--color-text); }\r\n                .tool-btn.active { color: var(--color-accent); }\r\n\r\n                .provider-select, .model-select-btn {\r\n                    font-size: 10px;\r\n                    font-weight: 600;\r\n                    background: var(--color-surface-elevated);\r\n                    border: 1px solid var(--color-border);\r\n                    padding: 4px 8px;\r\n                    border-radius: var(--radius-sm);\r\n                    color: var(--color-text-secondary);\r\n                }\r\n\r\n                .model-select-btn { display: flex; align-items: center; gap: 6px; border: none; cursor: pointer; }\r\n\r\n                .status-bar { padding: 4px; text-align: center; font-size: 10px; font-weight: 600; }\r\n                .status-bar.loading { background: var(--color-accent); color: #000; }\r\n                .status-bar.error { background: var(--color-error); color: #fff; }\r\n                .status-bar.note { background: var(--color-bg-secondary); color: var(--color-text-secondary); margin-bottom: 8px; font-weight: normal; font-style: italic; }\r\n\r\n\r\n\r\n\r\n                .agent-body { flex: 1; overflow-y: auto; padding: var(--space-4); }\r\n\r\n                .workspace-scan-section {\r\n                    background: var(--color-surface-elevated);\r\n                    border: 1px solid var(--color-border);\r\n                    border-radius: var(--radius-md);\r\n                    padding: var(--space-4);\r\n                    margin-bottom: var(--space-4);\r\n                }\r\n\r\n                .scan-info-banner {\r\n                    display: flex;\r\n                    align-items: flex-start;\r\n                    gap: 8px;\r\n                    padding: 10px 12px;\r\n                    background: rgba(59, 130, 246, 0.1);\r\n                    border: 1px solid rgba(59, 130, 246, 0.2);\r\n                    border-radius: var(--radius-sm);\r\n                    margin-bottom: 12px;\r\n                    font-size: 11px;\r\n                    color: var(--color-text-secondary);\r\n                    line-height: 1.4;\r\n                }\r\n\r\n                .scan-info-banner svg {\r\n                    flex-shrink: 0;\r\n                    color: var(--color-accent);\r\n                    margin-top: 1px;\r\n                }\r\n\r\n                .scan-info-banner strong {\r\n                    color: var(--color-text);\r\n                    font-weight: 600;\r\n                }\r\n\r\n                .scan-workspace-btn {\r\n                    width: 100%;\r\n                    display: flex;\r\n                    align-items: center;\r\n                    justify-content: center;\r\n                    gap: 8px;\r\n                    padding: 12px;\r\n                    background: linear-gradient(135deg, var(--color-accent), #8b5cf6);\r\n                    color: #fff;\r\n                    border: none;\r\n                    border-radius: var(--radius-md);\r\n                    font-size: 13px;\r\n                    font-weight: 600;\r\n                    cursor: pointer;\r\n                    transition: all var(--transition-fast);\r\n                    box-shadow: var(--shadow-sm);\r\n                }\r\n\r\n                .scan-workspace-btn:hover:not(:disabled) {\r\n                    transform: translateY(-1px);\r\n                    box-shadow: var(--shadow-md);\r\n                }\r\n\r\n                .scan-workspace-btn:disabled {\r\n                    opacity: 0.5;\r\n                    cursor: not-allowed;\r\n                }\r\n\r\n                .scan-description {\r\n                    margin-top: 8px;\r\n                    font-size: 11px;\r\n                    color: var(--color-text-muted);\r\n                    text-align: center;\r\n                }\r\n\r\n                .scan-progress {\r\n                    margin-top: 12px;\r\n                    display: flex;\r\n                    flex-direction: column;\r\n                    gap: 6px;\r\n                }\r\n\r\n                .progress-bar {\r\n                    height: 6px;\r\n                    background: var(--color-border);\r\n                    border-radius: 3px;\r\n                    overflow: hidden;\r\n                }\r\n\r\n                .progress-fill {\r\n                    height: 100%;\r\n                    background: linear-gradient(90deg, var(--color-accent), #8b5cf6);\r\n                    border-radius: 3px;\r\n                    transition: width 0.3s ease;\r\n                }\r\n\r\n                .progress-file {\r\n                    font-size: 10px;\r\n                    color: var(--color-text-muted);\r\n                    text-overflow: ellipsis;\r\n                    overflow: hidden;\r\n                    white-space: nowrap;\r\n                }\r\n\r\n                .agent-status-indicator { display: flex; align-items: center; gap: 12px; }\r\n                .status-icon {\r\n                    width: 36px;\r\n                    height: 36px;\r\n                    border-radius: 50%;\r\n                    display: flex;\r\n                    align-items: center;\r\n                    justify-content: center;\r\n                    background: var(--color-surface-elevated);\r\n                    border: 2px solid var(--color-border);\r\n                }\r\n                .status-icon.state-executing { border-color: var(--color-accent); color: var(--color-accent); animation: pulse 1s infinite alternate; }\r\n                .status-icon.state-waiting-approval { border-color: var(--color-warning); color: var(--color-warning); }\r\n                .status-icon.state-observing { border-color: var(--color-success); color: var(--color-success); }\r\n                \r\n                .status-text.main-status { font-weight: 700; font-size: var(--text-sm); text-transform: uppercase; letter-spacing: 0.5px; }\r\n                .status-text.sub-status { font-size: 10px; color: var(--color-text-muted); }\r\n\r\n                .toggle-switch {\r\n                    font-size: 10px;\r\n                    font-weight: 800;\r\n                    padding: 5px 12px;\r\n                    border-radius: 14px;\r\n                    transition: all var(--transition-fast);\r\n                    border: 1px solid transparent;\r\n                }\r\n                .toggle-switch.on { background: var(--color-success); color: #000; cursor: pointer; box-shadow: var(--shadow-sm); }\r\n                .toggle-switch.off { background: var(--color-surface-elevated); color: var(--color-text-tertiary); cursor: pointer; border-color: var(--color-border); }\r\n                .toggle-switch:hover:not(:disabled) { filter: brightness(1.15); transform: translateY(-1px); }\r\n                .error-text { color: var(--color-error); font-weight: 700; }\r\n                .setup-hint { margin-top: 12px; font-size: 11px; color: var(--color-accent); font-weight: 600; }\r\n\r\n                .suggestions-section { margin-top: var(--space-6); }\r\n                .section-title { font-size: 11px; font-weight: 700; color: var(--color-text-muted); text-transform: uppercase; margin-bottom: 12px; }\r\n                \r\n                .suggestion-card {\r\n                    background: var(--color-surface-elevated);\r\n                    border: 1px solid var(--color-border);\r\n                    border-radius: var(--radius-md);\r\n                    padding: var(--space-3);\r\n                    margin-bottom: var(--space-3);\r\n                    transition: all var(--transition-fast);\r\n                }\r\n\r\n                .suggestion-card.bug {\r\n                    border-color: var(--color-error);\r\n                    background: rgba(239, 68, 68, 0.05);\r\n                }\r\n\r\n                .suggestion-card.security {\r\n                    border-color: #a855f7;\r\n                    background: rgba(168, 85, 247, 0.05);\r\n                }\r\n\r\n                .card-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; }\r\n\r\n                .card-file-path {\r\n                    font-size: 10px;\r\n                    font-family: var(--font-mono);\r\n                    color: var(--color-accent);\r\n                    margin-bottom: 8px;\r\n                    padding: 4px 8px;\r\n                    background: var(--color-surface-subtle);\r\n                    border-radius: var(--radius-sm);\r\n                    display: inline-block;\r\n                }\r\n                .action-label { font-size: 10px; font-weight: 800; text-transform: uppercase; color: var(--color-text); }\r\n\r\n                .category-badge {\r\n                    display: inline-flex;\r\n                    align-items: center;\r\n                    padding: 2px 6px;\r\n                    border-radius: var(--radius-sm);\r\n                    font-size: 9px;\r\n                    font-weight: 700;\r\n                    line-height: 1;\r\n                }\r\n\r\n                .category-badge.bug {\r\n                    background: rgba(239, 68, 68, 0.15);\r\n                    color: var(--color-error);\r\n                }\r\n\r\n                .category-badge.security {\r\n                    background: rgba(168, 85, 247, 0.15);\r\n                    color: #a855f7;\r\n                }\r\n\r\n                .category-badge.performance {\r\n                    background: rgba(251, 191, 36, 0.15);\r\n                    color: var(--color-warning);\r\n                }\r\n\r\n                .category-badge.improvement {\r\n                    background: rgba(34, 197, 94, 0.15);\r\n                    color: var(--color-success);\r\n                }\r\n\r\n                .confidence-score { margin-left: auto; font-size: 10px; color: var(--color-accent); font-weight: 700; }\r\n\r\n                .card-body { margin-bottom: 8px; }\r\n                .card-body .desc { font-size: 13px; font-weight: 500; margin-bottom: 6px; line-height: 1.4; }\r\n                .card-body .reason { font-size: 11px; color: var(--color-text-muted); line-height: 1.4; padding: 8px; background: var(--color-surface-subtle); border-radius: var(--radius-sm); }\r\n\r\n                .card-actions { display: flex; gap: var(--space-2); margin-top: 12px; }\r\n                .card-actions button { flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px; padding: 8px; border-radius: var(--radius-sm); font-size: 11px; font-weight: 600; cursor: pointer; border: none; transition: all var(--transition-fast); }\r\n                .reject-btn { background: var(--color-surface); color: var(--color-text-secondary); }\r\n                .reject-btn:hover { background: rgba(239, 68, 68, 0.1); color: var(--color-error); }\r\n                .approve-btn { background: var(--color-success); color: #000; }\r\n                .approve-btn:hover { filter: brightness(1.1); transform: translateY(-1px); }\r\n\r\n                .log-section { margin-top: var(--space-6); background: var(--color-surface-subtle); border-radius: var(--radius-md); padding: var(--space-3); }\r\n                .log-header { display: flex; justify-content: space-between; font-size: 11px; font-weight: 700; margin-bottom: 8px; }\r\n                .clear-link { color: var(--color-text-muted); text-decoration: underline; font-size: 10px; background: none; border: none; cursor: pointer; }\r\n                .log-entries { display: flex; flex-direction: column; gap: 4px; }\r\n                .log-entry { display: flex; align-items: center; gap: 8px; font-size: 10px; color: var(--color-text-secondary); }\r\n                .entry-time { margin-left: auto; font-family: var(--font-mono); opacity: 0.6; }\r\n\r\n                .empty-state, .agent-intro {\r\n                    height: 100%;\r\n                    display: flex;\r\n                    flex-direction: column;\r\n                    align-items: center;\r\n                    justify-content: center;\r\n                    text-align: center;\r\n                    color: var(--color-text-muted);\r\n                    padding: var(--space-6);\r\n                }\r\n                .empty-icon, .intro-icon { color: var(--color-surface-elevated); margin-bottom: 12px; }\r\n                .empty-state h3, .agent-intro h3 { color: var(--color-text-secondary); margin-bottom: 8px; font-size: var(--text-lg); }\r\n                .empty-state p, .agent-intro p { font-size: var(--text-sm); line-height: 1.5; max-width: 240px; }\r\n\r\n                @keyframes pulse {\r\n                    from { opacity: 0.6; transform: scale(0.95); }\r\n                    to { opacity: 1; transform: scale(1.05); }\r\n                }\r\n\r\n                .typing-indicator { display: flex; gap: 4px; padding: 4px; }\r\n                .typing-indicator span { width: 6px; height: 6px; background: var(--color-accent); border-radius: 50%; animation: typing 1s infinite alternate; }\r\n                .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }\r\n                .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }\r\n\r\n                @keyframes typing { from { transform: translateY(0); opacity: 0.3; } to { transform: translateY(-4px); opacity: 1; } }\r\n\r\n                /* Inline Tool Approval Card */\r\n                .inline-tool-approval {\r\n                    background: var(--color-surface-elevated);\r\n                    border: 1px solid var(--color-border);\r\n                    border-radius: var(--radius-lg);\r\n                    margin: var(--space-3) 0;\r\n                    overflow: hidden;\r\n                    animation: slideIn 0.2s ease-out;\r\n                    box-shadow: var(--shadow-md);\r\n                }\r\n\r\n                .tool-card-header {\r\n                    display: flex;\r\n                    align-items: center;\r\n                    gap: var(--space-3);\r\n                    padding: var(--space-3);\r\n                    background: var(--color-surface-subtle);\r\n                    border-bottom: 1px solid var(--color-border-subtle);\r\n                }\r\n\r\n                .tool-icon-wrapper {\r\n                    width: 32px;\r\n                    height: 32px;\r\n                    border-radius: var(--radius-md);\r\n                    display: flex;\r\n                    align-items: center;\r\n                    justify-content: center;\r\n                }\r\n                \r\n                .tool-icon-wrapper.execute {\r\n                    background: rgba(168, 85, 247, 0.1);\r\n                    color: #a855f7;\r\n                }\r\n\r\n                .tool-name {\r\n                    font-size: var(--text-sm);\r\n                    color: var(--color-text);\r\n                }\r\n\r\n                .tool-params {\r\n                    padding: var(--space-3);\r\n                    font-family: var(--font-mono);\r\n                    font-size: var(--text-xs);\r\n                    color: var(--color-text-secondary);\r\n                    max-height: 200px;\r\n                    overflow-y: auto;\r\n                }\r\n\r\n                .param-row {\r\n                    margin-bottom: 6px;\r\n                }\r\n\r\n                .param-key {\r\n                    color: var(--color-accent);\r\n                    margin-right: 8px;\r\n                    font-weight: 600;\r\n                }\r\n\r\n                .tool-actions {\r\n                    display: flex;\r\n                    gap: var(--space-2);\r\n                    padding: var(--space-3);\r\n                    background: var(--color-surface-subtle);\r\n                    border-top: 1px solid var(--color-border-subtle);\r\n                }\r\n\r\n                .action-btn {\r\n                    flex: 1;\r\n                    display: flex;\r\n                    align-items: center;\r\n                    justify-content: center;\r\n                    gap: 6px;\r\n                    padding: 8px;\r\n                    border-radius: var(--radius-md);\r\n                    font-size: var(--text-xs);\r\n                    font-weight: 600;\r\n                    cursor: pointer;\r\n                    transition: all 0.1s;\r\n                    border: none;\r\n                }\r\n\r\n                .action-btn.approve {\r\n                    background: var(--color-success);\r\n                    color: #000;\r\n                    border: 1px solid transparent;\r\n                }\r\n                .action-btn.approve:hover { filter: brightness(1.1); }\r\n\r\n                .action-btn.reject {\r\n                    background: var(--color-surface);\r\n                    color: var(--color-text);\r\n                    border: 1px solid var(--color-border);\r\n                }\r\n                .action-btn.reject:hover { background: var(--color-surface-elevated); }\r\n\r\n                @keyframes slideIn {\r\n                    from { opacity: 0; transform: translateY(10px); }\r\n                    to { opacity: 1; transform: translateY(0); }\r\n                }\r\n            `}</style>\r\n        </div >\r\n    )\r\n}\r\n\r\nfunction PanelTab({ icon, label, active, onClick, badge }: Omit<TabProps, 'id'>) {\r\n    return (\r\n        <button className={`tab-btn ${active ? 'active' : ''}`} onClick={onClick} title={label}>\r\n            {icon}\r\n            <span>{label}</span>\r\n            {badge !== undefined && badge > 0 && <div className=\"badge-count\">{badge}</div>}\r\n        </button>\r\n    )\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\UnifiedSettingsPanel.tsx","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":114,"column":11,"nodeType":"MemberExpression","messageId":"unexpected","endLine":114,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[3041,3081],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":279,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":279,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7911,7914],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7911,7914],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":525,"column":80,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":525,"endColumn":83,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18357,18360],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18357,18360],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":540,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":540,"endColumn":22,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[18931,18983],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":563,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":563,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[19632,19684],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":577,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":577,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[20039,20093],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":689,"column":93,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":689,"endColumn":96,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[24127,24130],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[24127,24130],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":692,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":692,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[24272,24275],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[24272,24275],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":910,"column":4,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":910,"endColumn":7,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[32107,32110],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[32107,32110],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":1097,"column":90,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1097,"endColumn":93,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[38082,38085],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[38082,38085],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":10,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\n * SPDX-License-Identifier: AGPL-3.0-only\n */\nimport React, { useState, useEffect } from 'react'\nimport { useAppStore } from '../stores/appStore'\nimport { useMemberStore } from '../stores/memberStore'\nimport { useModelStore } from '../stores/modelStore'\nimport { encryptionService } from '../services/encryptionService'\nimport { p2pService } from '../services/p2pService'\nimport { offlineLLMService } from '../services/offlineLLMService'\nimport {\n  downloadModel,\n  cancelDownload,\n  pauseDownload,\n  resumeDownload,\n  deleteModel\n} from '../services/modelDownloadService'\nimport {\n  OFFLINE_MODELS,\n  OfflineModel,\n  formatBytes,\n  formatETA\n} from '../types/offlineModels'\nimport MemberManagement from './MemberManagement'\nimport AIMESettings from './AIMESettings'\nimport './UnifiedSettingsPanel.css'\nimport {\n  X,\n  Eye,\n  EyeOff,\n  Save,\n  Play,\n  Square,\n  Loader2 as LoadingIcon,\n  Check,\n  Trash2,\n  ChevronDown,\n  ChevronUp,\n  Bot,\n  Brain,\n  Lock,\n  Users,\n  Radiation,\n  Settings as SettingsIcon,\n  Shield,\n  Award,\n  HelpCircle,\n  Mail,\n  FileText,\n  ExternalLink,\n  Github,\n  Code,\n  Sparkles,\n  Wifi,\n  Radio,\n  RefreshCw,\n  Server,\n  Globe,\n  CheckCircle,\n  XCircle,\n  AlertCircle,\n  Loader2\n} from 'lucide-react'\n\ntype TabId = 'general' | 'security' | 'members' | 'advanced' | 'credits' | 'support'\n\ninterface SpaceSettings {\n  encryptionEnabled: boolean\n  roomPassword: string\n  githubConnected: boolean\n  slackWebhook: string\n}\n\nexport default function UnifiedSettingsPanel({ onClose }: { readonly onClose: () => void }) {\n  const { currentSpace, apiKeys, setAPIKey, removeAPIKey } = useAppStore()\n  const { getMyRole, getMembers } = useMemberStore()\n\n  const [activeTab, setActiveTab] = useState<TabId>('general')\n  const [settings, setSettings] = useState<SpaceSettings>({\n    encryptionEnabled: false,\n    roomPassword: '',\n    githubConnected: false,\n    slackWebhook: ''\n  })\n  const [showPassword, setShowPassword] = useState(false)\n  const [saved, setSaved] = useState(false)\n  const [showMembers, setShowMembers] = useState(false)\n  const [showAIME, setShowAIME] = useState(false)\n\n  // Nuke Button State\n  const [nukeCoverOpen, setNukeCoverOpen] = useState(false)\n  const [nukeStatus, setNukeStatus] = useState<'idle' | 'arming' | 'ready' | 'detonating' | 'done'>('idle')\n  const [nukeMessage, setNukeMessage] = useState('')\n\n  useEffect(() => {\n    const handleEsc = (e: KeyboardEvent) => {\n      if (e.key === 'Escape') onClose()\n    }\n    globalThis.addEventListener('keydown', handleEsc)\n    return () => globalThis.removeEventListener('keydown', handleEsc)\n  }, [onClose])\n\n  const myRole = currentSpace ? getMyRole(currentSpace.id) : 'member'\n  const isAdmin = myRole === 'owner' || myRole === 'admin'\n  const memberCount = currentSpace ? getMembers(currentSpace.id).length : 0\n\n  useEffect(() => {\n    if (currentSpace) {\n      const stored = localStorage.getItem(`space-settings-${currentSpace.id}`)\n      if (stored) {\n        try {\n          setSettings(JSON.parse(stored))\n        } catch {\n          console.error('Failed to load settings')\n        }\n      }\n    }\n  }, [currentSpace])\n\n  const handleSave = async () => {\n    if (!currentSpace) return\n\n    if (settings.encryptionEnabled && settings.roomPassword) {\n      await encryptionService.setRoomKey(currentSpace.id, settings.roomPassword)\n    }\n\n    localStorage.setItem(`space-settings-${currentSpace.id}`, JSON.stringify(settings))\n    setSaved(true)\n    setTimeout(() => {\n      setSaved(false)\n      if (settings.encryptionEnabled && settings.roomPassword) {\n        globalThis.window.location.reload()\n      }\n    }, 1000)\n  }\n\n  const handleNuke = async () => {\n    if (nukeStatus !== 'ready') return\n\n    setNukeStatus('detonating')\n    try {\n      await window.electronAPI.nukeProcesses('hard')\n      setNukeStatus('done')\n      setNukeMessage('System Nuked Successfully')\n\n      setTimeout(() => {\n        setNukeStatus('idle')\n        setNukeCoverOpen(false)\n        setNukeMessage('')\n      }, 3000)\n    } catch (_error) {\n      setNukeStatus('idle')\n      setNukeMessage('Failed to nuke')\n    }\n  }\n\n  const toggleCover = () => {\n    if (nukeCoverOpen) {\n      setNukeCoverOpen(false)\n      setNukeStatus('idle')\n    } else {\n      setNukeCoverOpen(true)\n      setNukeStatus('arming')\n      setTimeout(() => setNukeStatus('ready'), 300)\n    }\n  }\n\n  if (!currentSpace) return null\n\n  const tabs: Array<{ id: TabId; label: string; icon: React.ReactNode }> = [\n    { id: 'general', label: 'General', icon: <SettingsIcon size={16} /> },\n    { id: 'security', label: 'Security', icon: <Lock size={16} /> },\n    { id: 'members', label: 'Members', icon: <Users size={16} /> },\n    { id: 'advanced', label: 'Advanced', icon: <Brain size={16} /> },\n    { id: 'credits', label: 'Credits', icon: <Award size={16} /> },\n    { id: 'support', label: 'Support', icon: <HelpCircle size={16} /> }\n  ]\n\n  return (\n    <div className=\"settings-overlay\">\n      <div className=\"settings-modal\">\n        {/* Header */}\n        <div className=\"settings-header\">\n          <div className=\"header-content\">\n            <h2>Settings</h2>\n            <p className=\"space-name\">{currentSpace.name}</p>\n          </div>\n          <button className=\"close-button\" onClick={onClose}>\n            <X size={20} />\n          </button>\n        </div>\n\n        <div className=\"settings-body\">\n          {/* Sidebar Navigation */}\n          <div className=\"settings-sidebar\">\n            {tabs.map((tab) => (\n              <button\n                key={tab.id}\n                className={`tab-button ${activeTab === tab.id ? 'active' : ''}`}\n                onClick={() => setActiveTab(tab.id)}\n              >\n                <span className=\"tab-icon\">{tab.icon}</span>\n                <span className=\"tab-label\">{tab.label}</span>\n              </button>\n            ))}\n          </div>\n\n          {/* Content Area */}\n          <div className=\"settings-content\">\n            {activeTab === 'general' && (\n              <GeneralTab apiKeys={apiKeys} setAPIKey={setAPIKey} removeAPIKey={removeAPIKey} />\n            )}\n\n            {activeTab === 'security' && (\n              <SecurityTab\n                settings={settings}\n                setSettings={setSettings}\n                showPassword={showPassword}\n                setShowPassword={setShowPassword}\n              />\n            )}\n\n            {activeTab === 'members' && (\n              <MembersTab\n                memberCount={memberCount}\n                myRole={myRole}\n                isAdmin={isAdmin}\n                showMembers={showMembers}\n                setShowMembers={setShowMembers}\n                spaceId={currentSpace?.id}\n              />\n            )}\n\n            {activeTab === 'advanced' && (\n              <AdvancedTab\n                showAIME={showAIME}\n                setShowAIME={setShowAIME}\n                nukeCoverOpen={nukeCoverOpen}\n                nukeStatus={nukeStatus}\n                nukeMessage={nukeMessage}\n                toggleCover={toggleCover}\n                handleNuke={handleNuke}\n              />\n            )}\n\n            {activeTab === 'credits' && <CreditsTab />}\n\n            {activeTab === 'support' && <SupportTab />}\n          </div>\n        </div>\n\n        {/* Footer */}\n        <div className=\"settings-footer\">\n          <button className=\"btn-secondary\" onClick={onClose}>\n            Cancel\n          </button>\n          <button className=\"btn-primary\" onClick={handleSave}>\n            {saved ? (\n              <>\n                <Check size={16} />\n                Saved\n              </>\n            ) : (\n              <>\n                <Save size={16} />\n                Save Changes\n              </>\n            )}\n          </button>\n        </div>\n      </div>\n\n      <style>{styles}</style>\n    </div>\n  )\n}\n\n// General Tab Component\nfunction GeneralTab({ apiKeys, setAPIKey, removeAPIKey }: any) {\n  const [showOfflineModels, setShowOfflineModels] = useState(false)\n  const { downloadedModels, activeDownloads, loadedModelId, isLoading, getTotalDownloadedSize } = useModelStore()\n  const [confirmDelete, setConfirmDelete] = useState<string | null>(null)\n\n  useEffect(() => {\n    useModelStore.getState().setupListeners()\n  }, [])\n\n  const handleDownload = async (model: OfflineModel) => {\n    await downloadModel(model.id)\n  }\n\n  const handleDelete = async (modelId: string) => {\n    await deleteModel(modelId)\n    setConfirmDelete(null)\n  }\n\n  const handleLoadModel = async (modelId: string) => {\n    await offlineLLMService.loadModel(modelId)\n  }\n\n  const handleUnloadModel = async () => {\n    await offlineLLMService.unloadModel()\n  }\n\n  const getQualityStars = (quality: number) => {\n    return '★'.repeat(quality) + '☆'.repeat(5 - quality)\n  }\n\n  return (\n    <div className=\"tab-content\">\n      {/* BYOK Section */}\n      <h3 className=\"section-title\">\n        <Bot size={20} />\n        Bring Your Own Keys (BYOK)\n      </h3>\n      <p className=\"section-description\">\n        Connect your cloud AI providers for agent and assistant features. Keys are encrypted using your system's\n        secure storage and never leave your device.\n      </p>\n\n      <div className=\"info-banner\">\n        <Sparkles size={16} />\n        <span>\n          <strong>Free Beta:</strong> All providers work as AI agents with tool calling and multi-turn conversations.\n        </span>\n      </div>\n\n      <div className=\"api-keys-grid\">\n        <ApiKeyInput\n          provider=\"openai\"\n          label=\"OpenAI\"\n          placeholder=\"sk-...\"\n          apiKeys={apiKeys}\n          setAPIKey={setAPIKey}\n          removeAPIKey={removeAPIKey}\n        />\n        <ApiKeyInput\n          provider=\"anthropic\"\n          label=\"Anthropic\"\n          placeholder=\"sk-ant-...\"\n          apiKeys={apiKeys}\n          setAPIKey={setAPIKey}\n          removeAPIKey={removeAPIKey}\n        />\n        <ApiKeyInput\n          provider=\"google\"\n          label=\"Google Gemini\"\n          placeholder=\"AIza...\"\n          apiKeys={apiKeys}\n          setAPIKey={setAPIKey}\n          removeAPIKey={removeAPIKey}\n        />\n      </div>\n\n      {/* Offline Models Section */}\n      <div className=\"collapsible-section\" style={{ marginTop: '32px' }}>\n        <button className=\"collapsible-header\" onClick={() => setShowOfflineModels(!showOfflineModels)}>\n          <div className=\"header-left\">\n            <Brain size={20} />\n            <div>\n              <h3>Offline AI Models</h3>\n              <p>Download and run AI models locally - no internet required</p>\n            </div>\n          </div>\n          <div className=\"header-right\">\n            <span className=\"storage-badge\">\n              💾 {formatBytes(getTotalDownloadedSize())} used\n            </span>\n            {showOfflineModels ? <ChevronUp size={20} /> : <ChevronDown size={20} />}\n          </div>\n        </button>\n\n        {showOfflineModels && (\n          <div className=\"collapsible-content\">\n            <div className=\"offline-models-info\">\n              <span className=\"tier-badge\">Free Beta</span>\n              <span>All {OFFLINE_MODELS.length} models available for download</span>\n            </div>\n\n            <div className=\"offline-model-list\">\n              {OFFLINE_MODELS.map((model) => {\n                const downloaded = downloadedModels[model.id]\n                const download = activeDownloads[model.id]\n                const isDownloading = download?.status === 'downloading'\n                const isPaused = download?.status === 'paused'\n                const hasError = download?.status === 'error'\n\n                return (\n                  <div\n                    key={model.id}\n                    className={`offline-model-card ${downloaded ? 'downloaded' : ''} ${loadedModelId === model.id ? 'active' : ''}`}\n                  >\n                    <div className=\"model-main\">\n                      <div className=\"model-icon\">\n                        {model.tierIndex <= 2 ? '🟢' : model.tierIndex <= 4 ? '🟡' : '🔵'}\n                      </div>\n                      <div className=\"model-info\">\n                        <div className=\"model-header-row\">\n                          <strong>{model.name}</strong>\n                          {loadedModelId === model.id && <span className=\"badge badge-active\">✓ Active</span>}\n                          {downloaded && loadedModelId !== model.id && <span className=\"badge badge-downloaded\">✓ Ready</span>}\n                          {isDownloading && <span className=\"badge badge-progress\">{Math.round((download.bytesDownloaded / download.totalBytes) * 100)}%</span>}\n                          {isPaused && <span className=\"badge badge-paused\">⏸ Paused</span>}\n                          {hasError && <span className=\"badge badge-error\">⚠ Error</span>}\n                        </div>\n                        <p className=\"model-desc\">{model.description}</p>\n                        <div className=\"model-stats\">\n                          <span>📦 {model.size}</span>\n                          <span>💻 {model.ramRequired} RAM</span>\n                          <span className=\"quality\">{getQualityStars(model.quality)}</span>\n                        </div>\n                      </div>\n                    </div>\n\n                    {/* Download Progress */}\n                    {(isDownloading || isPaused) && download && (\n                      <div className=\"download-progress\">\n                        <div className=\"progress-bar\">\n                          <div\n                            className=\"progress-fill\"\n                            style={{ width: `${(download.bytesDownloaded / download.totalBytes) * 100}%` }}\n                          />\n                        </div>\n                        <div className=\"progress-info\">\n                          <span>{formatBytes(download.bytesDownloaded)} / {formatBytes(download.totalBytes)}</span>\n                          {isDownloading && <span>{formatBytes(download.speed)}/s • {formatETA(download.eta)}</span>}\n                        </div>\n                      </div>\n                    )}\n\n                    {/* Error Message */}\n                    {hasError && download?.error && (\n                      <div className=\"error-message\">⚠️ {download.error}</div>\n                    )}\n\n                    {/* Actions */}\n                    <div className=\"model-actions\">\n                      {downloaded ? (\n                        <>\n                          {/* Load/Unload button */}\n                          {loadedModelId === model.id ? (\n                            <button\n                              className=\"btn btn-secondary\"\n                              onClick={handleUnloadModel}\n                              disabled={isLoading}\n                            >\n                              <Square size={14} /> Unload\n                            </button>\n                          ) : (\n                            <button\n                              className=\"btn btn-primary\"\n                              onClick={() => handleLoadModel(model.id)}\n                              disabled={isLoading}\n                            >\n                              {isLoading ? <LoadingIcon size={14} className=\"animate-spin\" /> : <Play size={14} />}\n                              {isLoading ? 'Loading...' : 'Load Model'}\n                            </button>\n                          )}\n                          {/* Delete button */}\n                          {confirmDelete === model.id ? (\n                            <>\n                              <button className=\"btn btn-danger\" onClick={() => handleDelete(model.id)}>\n                                Confirm Delete\n                              </button>\n                              <button className=\"btn btn-ghost\" onClick={() => setConfirmDelete(null)}>\n                                Cancel\n                              </button>\n                            </>\n                          ) : (\n                            <button\n                              className=\"btn btn-ghost\"\n                              onClick={() => setConfirmDelete(model.id)}\n                              disabled={loadedModelId === model.id}\n                              title={loadedModelId === model.id ? 'Unload model before deleting' : 'Delete model'}\n                            >\n                              <Trash2 size={14} /> Delete\n                            </button>\n                          )}\n                        </>\n                      ) : isDownloading ? (\n                        <>\n                          <button className=\"btn btn-secondary\" onClick={() => pauseDownload(model.id)}>\n                            ⏸ Pause\n                          </button>\n                          <button className=\"btn btn-ghost\" onClick={() => cancelDownload(model.id)}>\n                            Cancel\n                          </button>\n                        </>\n                      ) : isPaused ? (\n                        <>\n                          <button className=\"btn btn-primary\" onClick={() => resumeDownload(model.id)}>\n                            ▶ Resume\n                          </button>\n                          <button className=\"btn btn-ghost\" onClick={() => cancelDownload(model.id)}>\n                            Cancel\n                          </button>\n                        </>\n                      ) : hasError ? (\n                        <>\n                          <button className=\"btn btn-primary\" onClick={() => handleDownload(model)}>\n                            ↻ Retry\n                          </button>\n                          <button className=\"btn btn-ghost\" onClick={() => cancelDownload(model.id)}>\n                            Dismiss\n                          </button>\n                        </>\n                      ) : (\n                        <button className=\"btn btn-primary\" onClick={() => handleDownload(model)}>\n                          ⬇ Download\n                        </button>\n                      )}\n                    </div>\n                  </div>\n                )\n              })}\n            </div>\n          </div>\n        )}\n      </div>\n    </div>\n  )\n}\n\n// Security Tab Component\nfunction SecurityTab({ settings, setSettings, showPassword, setShowPassword }: any) {\n  const [githubToken, setGithubToken] = useState('')\n  const [showGithubToken, setShowGithubToken] = useState(false)\n  const [tokenSaved, setTokenSaved] = useState(false)\n  const [tokenLoading, setTokenLoading] = useState(false)\n\n  useEffect(() => {\n    // Load existing GitHub token from safe storage\n    const loadToken = async () => {\n      try {\n        const result = await window.electronAPI?.safeStorage?.get('github-update-token')\n        if (result?.success && result.value) {\n          setGithubToken(result.value)\n        }\n      } catch (error) {\n        console.error('Failed to load GitHub token:', error)\n      }\n    }\n    loadToken()\n  }, [])\n\n  const handleSaveGithubToken = async () => {\n    setTokenLoading(true)\n    try {\n      if (githubToken && githubToken.trim() !== '') {\n        // Save token to secure storage\n        const result = await window.electronAPI?.safeStorage?.set({\n          key: 'github-update-token',\n          value: githubToken\n        })\n        if (result?.success) {\n          // Configure update system with new token\n          await window.electronAPI?.update?.configureToken(githubToken)\n          setTokenSaved(true)\n          setTimeout(() => setTokenSaved(false), 3000)\n        }\n      }\n    } catch (error) {\n      console.error('Failed to save GitHub token:', error)\n    } finally {\n      setTokenLoading(false)\n    }\n  }\n\n  const handleDeleteGithubToken = async () => {\n    setTokenLoading(true)\n    try {\n      await window.electronAPI?.safeStorage?.delete('github-update-token')\n      await window.electronAPI?.update?.configureToken('')\n      setGithubToken('')\n      setTokenSaved(false)\n    } catch (error) {\n      console.error('Failed to delete GitHub token:', error)\n    } finally {\n      setTokenLoading(false)\n    }\n  }\n\n  return (\n    <div className=\"tab-content\">\n      <h3 className=\"section-title\">\n        <Shield size={20} />\n        Encryption\n      </h3>\n      <p className=\"section-description\">\n        End-to-end encryption for your workspace data during P2P sync.\n      </p>\n\n      <div className=\"setting-card\">\n        <div className=\"setting-row\">\n          <div className=\"setting-info\">\n            <label>Enable Encryption</label>\n            <p>Encrypt all workspace content with a shared password</p>\n          </div>\n          <label className=\"toggle-switch\">\n            <input\n              type=\"checkbox\"\n              checked={settings.encryptionEnabled}\n              onChange={(e) => setSettings({ ...settings, encryptionEnabled: e.target.checked })}\n            />\n            <span className=\"toggle-slider\"></span>\n          </label>\n        </div>\n\n        {settings.encryptionEnabled && (\n          <div className=\"password-input-group\">\n            <label>Room Password</label>\n            <div className=\"input-with-icon\">\n              <input\n                type={showPassword ? 'text' : 'password'}\n                placeholder=\"Enter shared password\"\n                value={settings.roomPassword}\n                onChange={(e) => setSettings({ ...settings, roomPassword: e.target.value })}\n              />\n              <button className=\"icon-button\" onClick={() => setShowPassword(!showPassword)}>\n                {showPassword ? <EyeOff size={16} /> : <Eye size={16} />}\n              </button>\n            </div>\n            <p className=\"hint\">Share this password with all workspace collaborators</p>\n          </div>\n        )}\n      </div>\n\n      <h3 className=\"section-title\" style={{ marginTop: '32px' }}>\n        <Github size={20} />\n        Auto-Update Configuration\n      </h3>\n      <p className=\"section-description\">\n        Configure GitHub access for automatic updates. For private repositories, provide a GitHub Personal Access Token.\n      </p>\n\n      <div className=\"setting-card\">\n        <div className=\"password-input-group\">\n          <label>GitHub Personal Access Token (Optional)</label>\n          <div className=\"input-with-icon\">\n            <input\n              type={showGithubToken ? 'text' : 'password'}\n              placeholder=\"ghp_xxxxxxxxxxxxxxxxxxxx\"\n              value={githubToken}\n              onChange={(e) => setGithubToken(e.target.value)}\n            />\n            <button className=\"icon-button\" onClick={() => setShowGithubToken(!showGithubToken)}>\n              {showGithubToken ? <EyeOff size={16} /> : <Eye size={16} />}\n            </button>\n          </div>\n          <p className=\"hint\">\n            Required only for private repositories. Token is encrypted using OS-level security.\n            {' '}\n            <a\n              href=\"https://github.com/settings/tokens/new\"\n              target=\"_blank\"\n              rel=\"noopener noreferrer\"\n              style={{ color: 'var(--color-accent)', textDecoration: 'underline' }}\n            >\n              Create token â†’\n            </a>\n          </p>\n          <div style={{ display: 'flex', gap: '8px', marginTop: '12px' }}>\n            <button\n              className=\"action-button primary\"\n              onClick={handleSaveGithubToken}\n              disabled={tokenLoading || !githubToken}\n            >\n              {tokenSaved ? <Check size={16} /> : <Save size={16} />}\n              {tokenSaved ? 'Saved!' : 'Save Token'}\n            </button>\n            {githubToken && (\n              <button\n                className=\"action-button danger\"\n                onClick={handleDeleteGithubToken}\n                disabled={tokenLoading}\n              >\n                <Trash2 size={16} />\n                Delete Token\n              </button>\n            )}\n          </div>\n        </div>\n      </div>\n    </div>\n  )\n}\n\n// Members Tab Component\nfunction MembersTab({ memberCount, myRole, isAdmin, showMembers, setShowMembers, spaceId }: any) {\n  const [connectivityTest, setConnectivityTest] = useState<{\n    testing: boolean\n    result: { stun: boolean; turn: boolean; candidates: any[]; error?: string } | null\n  }>({ testing: false, result: null })\n  const [connectionInfo, setConnectionInfo] = useState<{\n    connected: boolean\n    peerCount: number\n    signalingState: string\n    iceServers: number\n    turnEnabled: boolean\n  } | null>(null)\n\n  // Load connection info on mount\n  useEffect(() => {\n    if (spaceId) {\n      const info = p2pService.getConnectionInfo(`kalynt-${spaceId}`)\n      setConnectionInfo(info)\n    }\n  }, [spaceId])\n\n  const getRoleColor = (role: string) => {\n    if (role === 'owner') return '#ff9500'\n    if (role === 'admin') return '#0a84ff'\n    return 'rgba(255,255,255,0.5)'\n  }\n\n  const runConnectivityTest = async () => {\n    setConnectivityTest({ testing: true, result: null })\n    try {\n      const result = await p2pService.testConnectivity()\n      setConnectivityTest({ testing: false, result })\n    } catch (error) {\n      setConnectivityTest({\n        testing: false,\n        result: { stun: false, turn: false, candidates: [], error: String(error) }\n      })\n    }\n  }\n\n  // When showMembers is true, show MemberManagement inline\n  if (showMembers && spaceId) {\n    return (\n      <div className=\"tab-content member-management-container\">\n        <MemberManagement spaceId={spaceId} onClose={() => setShowMembers(false)} />\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"tab-content\">\n      <h3 className=\"section-title\">\n        <Users size={20} />\n        Team Members\n      </h3>\n      <p className=\"section-description\">Manage workspace members and permissions.</p>\n\n      <div className=\"setting-card\">\n        <div className=\"members-summary\">\n          <div className=\"member-stat\">\n            <span className=\"stat-value\">{memberCount}</span>\n            <span className=\"stat-label\">{memberCount === 1 ? 'Member' : 'Members'}</span>\n          </div>\n          <div className=\"role-badge\" style={{ color: getRoleColor(myRole) }}>\n            Your Role: {myRole}\n          </div>\n        </div>\n\n        {isAdmin && (\n          <button className=\"btn-secondary full-width\" onClick={() => setShowMembers(true)}>\n            <Users size={16} />\n            Manage Team\n          </button>\n        )}\n      </div>\n\n      {/* P2P Connectivity Section */}\n      <h3 className=\"section-title\" style={{ marginTop: '24px' }}>\n        <Globe size={20} />\n        P2P Connectivity\n      </h3>\n      <p className=\"section-description\">\n        Network status and connection diagnostics for peer-to-peer collaboration.\n      </p>\n\n      <div className=\"setting-card\">\n        {/* Connection Status */}\n        <div className=\"connectivity-status\">\n          <div className=\"status-row\">\n            <div className=\"status-item\">\n              <Server size={16} />\n              <span className=\"status-label\">ICE Servers:</span>\n              <span className=\"status-value\">{connectionInfo?.iceServers ?? 11}</span>\n            </div>\n            <div className=\"status-item\">\n              <Radio size={16} />\n              <span className=\"status-label\">TURN Enabled:</span>\n              {connectionInfo?.turnEnabled !== false ? (\n                <span className=\"status-value success\"><CheckCircle size={14} /> Yes</span>\n              ) : (\n                <span className=\"status-value error\"><XCircle size={14} /> No</span>\n              )}\n            </div>\n          </div>\n          <div className=\"status-row\">\n            <div className=\"status-item\">\n              <Wifi size={16} />\n              <span className=\"status-label\">Connected Peers:</span>\n              <span className=\"status-value\">{connectionInfo?.peerCount ?? 0}</span>\n            </div>\n            <div className=\"status-item\">\n              <AlertCircle size={16} />\n              <span className=\"status-label\">Status:</span>\n              <span className={`status-value ${connectionInfo?.connected ? 'success' : ''}`}>\n                {connectionInfo?.connected ? 'Connected' : 'Not in room'}\n              </span>\n            </div>\n          </div>\n        </div>\n\n        {/* Connectivity Test */}\n        <div className=\"connectivity-test\">\n          <div className=\"test-header\">\n            <strong>Network Diagnostics</strong>\n            <p className=\"test-description\">\n              Test your network's ability to establish peer connections.\n            </p>\n          </div>\n\n          <button\n            className=\"btn-secondary full-width\"\n            onClick={runConnectivityTest}\n            disabled={connectivityTest.testing}\n          >\n            {connectivityTest.testing ? (\n              <>\n                <Loader2 size={16} className=\"spinning\" />\n                Testing...\n              </>\n            ) : (\n              <>\n                <RefreshCw size={16} />\n                Run Connectivity Test\n              </>\n            )}\n          </button>\n\n          {connectivityTest.result && (\n            <div className=\"test-results\">\n              <div className=\"result-row\">\n                <span>STUN (NAT Discovery):</span>\n                {connectivityTest.result.stun ? (\n                  <span className=\"result-success\"><CheckCircle size={14} /> Working</span>\n                ) : (\n                  <span className=\"result-error\"><XCircle size={14} /> Failed</span>\n                )}\n              </div>\n              <div className=\"result-row\">\n                <span>TURN (Relay Fallback):</span>\n                {connectivityTest.result.turn ? (\n                  <span className=\"result-success\"><CheckCircle size={14} /> Working</span>\n                ) : (\n                  <span className=\"result-warning\"><AlertCircle size={14} /> Not tested</span>\n                )}\n              </div>\n              <div className=\"result-row\">\n                <span>ICE Candidates Found:</span>\n                <span className=\"result-value\">{connectivityTest.result.candidates.length}</span>\n              </div>\n              {connectivityTest.result.error && (\n                <div className=\"result-error-message\">\n                  Error: {connectivityTest.result.error}\n                </div>\n              )}\n              {connectivityTest.result.stun && connectivityTest.result.turn && (\n                <div className=\"result-success-message\">\n                  <CheckCircle size={14} />\n                  Your network supports full P2P connectivity!\n                </div>\n              )}\n              {connectivityTest.result.stun && !connectivityTest.result.turn && (\n                <div className=\"result-info-message\">\n                  <AlertCircle size={14} />\n                  Direct connections work. TURN relay available as fallback for restrictive networks.\n                </div>\n              )}\n              {!connectivityTest.result.stun && !connectivityTest.result.turn && !connectivityTest.result.error && (\n                <div className=\"result-error-message\">\n                  <XCircle size={14} />\n                  Connection issues detected. P2P may not work on your network.\n                </div>\n              )}\n            </div>\n          )}\n        </div>\n      </div>\n\n      {/* Network Info */}\n      <div className=\"setting-card info-card\">\n        <div className=\"info-content\">\n          <strong>How P2P Works</strong>\n          <ul className=\"info-list\">\n            <li><strong>STUN</strong> discovers your public IP for direct peer connections</li>\n            <li><strong>TURN</strong> relays traffic when direct connections fail (firewalls, corporate networks)</li>\n            <li>All data is <strong>end-to-end encrypted</strong> regardless of connection type</li>\n          </ul>\n        </div>\n      </div>\n    </div>\n  )\n}\n\n// Advanced Tab Component\nfunction AdvancedTab({\n  showAIME,\n  setShowAIME,\n  nukeCoverOpen,\n  nukeStatus,\n  nukeMessage,\n  toggleCover,\n  handleNuke\n}: any) {\n  return (\n    <div className=\"tab-content\">\n      {/* AIME Section */}\n      <div className=\"collapsible-section\">\n        <button className=\"collapsible-header\" onClick={() => setShowAIME(!showAIME)}>\n          <div className=\"header-left\">\n            <Brain size={20} />\n            <div>\n              <h3>AIME (AI Memory Engine)</h3>\n              <p>Hardware optimization for local AI models</p>\n            </div>\n          </div>\n          {showAIME ? <ChevronUp size={20} /> : <ChevronDown size={20} />}\n        </button>\n\n        {showAIME && (\n          <div className=\"collapsible-content\">\n            <AIMESettings />\n          </div>\n        )}\n      </div>\n\n      {/* Danger Zone */}\n      <div className=\"danger-zone\">\n        <h3 className=\"section-title danger\">\n          <Radiation size={20} />\n          Danger Zone\n        </h3>\n        <p className=\"section-description\">Critical system operations - use with caution</p>\n\n        <div className=\"setting-card danger-card\">\n          <div className=\"nuke-section\">\n            <div className=\"nuke-info\">\n              <strong>Nuke Process Tree</strong>\n              <p>Force kill all child processes and free ports (3000, 8080)</p>\n            </div>\n\n            <div className={`nuke-switch ${nukeCoverOpen ? 'open' : ''}`}>\n              <div className=\"safety-cover\" onClick={toggleCover}>\n                <span>SAFETY</span>\n              </div>\n              <button\n                className={`nuke-button ${nukeStatus}`}\n                onClick={handleNuke}\n                disabled={!nukeCoverOpen || nukeStatus === 'detonating' || nukeStatus === 'done'}\n              >\n                {nukeStatus === 'detonating' ? '...' : nukeStatus === 'done' ? <Check size={16} /> : <Radiation size={32} />}\n              </button>\n            </div>\n          </div>\n\n          {nukeMessage && <div className=\"nuke-feedback\">{nukeMessage}</div>}\n        </div>\n\n        <div className=\"setting-card danger-card\">\n          <div className=\"delete-space-section\">\n            <div>\n              <strong>Delete Workspace</strong>\n              <p>Permanently delete this workspace and all its data</p>\n            </div>\n            <button className=\"btn-danger\">\n              <Trash2 size={16} />\n              Delete Workspace\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>\n  )\n}\n\n// Credits Tab Component\nfunction CreditsTab() {\n  const libraries = [\n    { name: 'React', description: 'UI Framework', url: 'https://react.dev' },\n    { name: 'Electron', description: 'Desktop App Platform', url: 'https://electronjs.org' },\n    { name: 'Monaco Editor', description: 'Code Editor', url: 'https://microsoft.github.io/monaco-editor/' },\n    { name: 'Yjs', description: 'CRDT for Real-time Collaboration', url: 'https://yjs.dev' },\n    { name: 'node-llama-cpp', description: 'Local LLM Inference', url: 'https://github.com/withcatai/node-llama-cpp' },\n    { name: 'Lucide', description: 'Beautiful Icons', url: 'https://lucide.dev' }\n  ]\n\n  return (\n    <div className=\"tab-content\">\n      <h3 className=\"section-title\">\n        <Award size={20} />\n        Credits & Attribution\n      </h3>\n      <p className=\"section-description\">\n        Built with amazing open-source tools and libraries\n      </p>\n\n      <div className=\"credits-section\">\n        <h4 className=\"subsection-title\">\n          <Code size={18} />\n          Open Source Libraries\n        </h4>\n        <div className=\"libraries-grid\">\n          {libraries.map((lib) => (\n            <a\n              key={lib.name}\n              href={lib.url}\n              target=\"_blank\"\n              rel=\"noopener noreferrer\"\n              className=\"library-card\"\n            >\n              <div className=\"library-info\">\n                <strong>{lib.name}</strong>\n                <p>{lib.description}</p>\n              </div>\n              <ExternalLink size={16} />\n            </a>\n          ))}\n        </div>\n\n        <div className=\"made-with-love\">\n          <Sparkles size={16} />\n          <span>Made with passion for developers and creators</span>\n          <Sparkles size={16} />\n        </div>\n      </div>\n    </div>\n  )\n}\n\n// Support Tab Component\nfunction SupportTab() {\n  return (\n    <div className=\"tab-content\">\n      <h3 className=\"section-title\">\n        <HelpCircle size={20} />\n        Support & Help\n      </h3>\n      <p className=\"section-description\">\n        Get help, report issues, and provide feedback\n      </p>\n\n      <div className=\"support-section\">\n        <div className=\"setting-card\">\n          <div className=\"support-item\">\n            <Mail size={20} />\n            <div>\n              <strong>Contact Support</strong>\n              <p>security@hermeslekkas.dev</p>\n            </div>\n          </div>\n        </div>\n\n        <div className=\"setting-card\">\n          <div className=\"support-item\">\n            <Github size={20} />\n            <div>\n              <strong>Report a Bug</strong>\n              <p>Found an issue? Let us know on GitHub</p>\n            </div>\n            <button className=\"btn-secondary\">\n              <ExternalLink size={16} />\n              GitHub Issues\n            </button>\n          </div>\n        </div>\n\n        <div className=\"setting-card\">\n          <div className=\"support-item\">\n            <FileText size={20} />\n            <div>\n              <strong>Documentation</strong>\n              <p>Learn how to get the most out of Kalynt</p>\n            </div>\n            <button className=\"btn-secondary\">\n              <ExternalLink size={16} />\n              Docs\n            </button>\n          </div>\n        </div>\n\n        <div className=\"version-info\">\n          <p>Kalynt Desktop v1.0 beta</p>\n          <p>© 2026 Hermes Lekkas. All rights reserved.</p>\n        </div>\n      </div>\n    </div>\n  )\n}\n\n// API Key Input Component\nfunction ApiKeyInput({ provider, label, placeholder, apiKeys, setAPIKey, removeAPIKey }: any) {\n  const [tempValue, setTempValue] = useState('')\n  const [isEditing, setIsEditing] = useState(false)\n\n  const currentKey = apiKeys[provider as keyof typeof apiKeys]\n  const hasKey = !!currentKey\n\n  const handleSave = async () => {\n    if (tempValue.trim()) {\n      await setAPIKey(provider, tempValue.trim())\n      setIsEditing(false)\n      setTempValue('')\n    }\n  }\n\n  const handleClear = async () => {\n    await removeAPIKey(provider)\n    setIsEditing(false)\n    setTempValue('')\n  }\n\n  return (\n    <div className=\"api-key-card\">\n      <div className=\"api-key-header\">\n        <span className=\"provider-name\">{label}</span>\n        {hasKey && <span className=\"status-badge\">Connected</span>}\n      </div>\n\n      {!isEditing && hasKey ? (\n        <div className=\"key-display\">\n          <span className=\"key-masked\">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span>\n          <div className=\"key-actions\">\n            <button className=\"icon-button\" onClick={() => setIsEditing(true)}>\n              Edit\n            </button>\n            <button className=\"icon-button danger\" onClick={handleClear}>\n              <Trash2 size={14} />\n            </button>\n          </div>\n        </div>\n      ) : (\n        <div className=\"key-input\">\n          <input\n            type=\"password\"\n            placeholder={placeholder}\n            value={tempValue}\n            onChange={(e) => setTempValue(e.target.value)}\n            onKeyDown={(e) => e.key === 'Enter' && handleSave()}\n          />\n          <div className=\"key-actions\">\n            <button className=\"icon-button\" onClick={handleSave} disabled={!tempValue}>\n              <Check size={14} />\n            </button>\n            {hasKey && (\n              <button className=\"icon-button\" onClick={() => setIsEditing(false)}>\n                <X size={14} />\n              </button>\n            )}\n          </div>\n        </div>\n      )}\n    </div>\n  )\n}\n\nconst styles = `\n  .settings-overlay {\n    position: fixed;\n    inset: 0;\n    background: rgba(0, 0, 0, 0.75);\n    backdrop-filter: blur(8px);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    z-index: 10000;\n    animation: fadeIn 0.2s ease-out;\n  }\n\n  @keyframes fadeIn {\n    from { opacity: 0; }\n    to { opacity: 1; }\n  }\n\n  .settings-modal {\n    width: 90%;\n    max-width: 920px;\n    height: 85vh;\n    max-height: 720px;\n    background: #0a0a0a;\n    border-radius: 16px;\n    border: 1px solid rgba(255, 255, 255, 0.1);\n    display: flex;\n    flex-direction: column;\n    overflow: hidden;\n    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);\n    animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n  }\n\n  @keyframes slideUp {\n    from {\n      opacity: 0;\n      transform: translateY(20px);\n    }\n    to {\n      opacity: 1;\n      transform: translateY(0);\n    }\n  }\n\n  /* Header */\n  .settings-header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: 20px 24px;\n    background: linear-gradient(135deg, rgba(10, 132, 255, 0.1) 0%, rgba(10, 10, 10, 0.95) 100%);\n    backdrop-filter: blur(20px);\n    border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n  }\n\n  .header-content h2 {\n    margin: 0;\n    font-size: 20px;\n    font-weight: 600;\n    color: #fff;\n  }\n\n  .header-content .space-name {\n    font-size: 13px;\n    color: rgba(255, 255, 255, 0.5);\n    margin-top: 2px;\n  }\n\n  .close-button {\n    width: 32px;\n    height: 32px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    background: rgba(255, 255, 255, 0.05);\n    border: 1px solid rgba(255, 255, 255, 0.1);\n    border-radius: 8px;\n    color: rgba(255, 255, 255, 0.7);\n    cursor: pointer;\n    transition: all 0.2s;\n  }\n\n  .close-button:hover {\n    background: rgba(255, 255, 255, 0.1);\n    color: #fff;\n  }\n\n  /* Body */\n  .settings-body {\n    display: flex;\n    flex: 1;\n    overflow: hidden;\n  }\n\n  /* Sidebar */\n  .settings-sidebar {\n    width: 200px;\n    background: rgba(255, 255, 255, 0.02);\n    border-right: 1px solid rgba(255, 255, 255, 0.08);\n    padding: 12px;\n    display: flex;\n    flex-direction: column;\n    gap: 4px;\n  }\n\n  .tab-button {\n    display: flex;\n    align-items: center;\n    gap: 12px;\n    padding: 10px 14px;\n    background: transparent;\n    border: none;\n    border-radius: 10px;\n    color: rgba(255, 255, 255, 0.6);\n    font-size: 14px;\n    font-weight: 500;\n    cursor: pointer;\n    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n    position: relative;\n  }\n\n  .tab-button:hover {\n    background: rgba(255, 255, 255, 0.05);\n    color: rgba(255, 255, 255, 0.9);\n  }\n\n  .tab-button.active {\n    background: linear-gradient(135deg, rgba(10, 132, 255, 0.15), rgba(10, 132, 255, 0.05));\n    color: #0a84ff;\n    border: 1px solid rgba(10, 132, 255, 0.3);\n  }\n\n  .tab-icon {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n  }\n\n  .tab-label {\n    flex: 1;\n    text-align: left;\n  }\n\n  /* Content */\n  .settings-content {\n    flex: 1;\n    overflow-y: auto;\n    padding: 24px;\n  }\n\n  .tab-content {\n    animation: contentFadeIn 0.3s ease-out;\n  }\n\n  .tab-content.member-management-container {\n    display: flex;\n    flex-direction: column;\n    height: 100%;\n    min-height: 500px;\n  }\n\n  .tab-content.member-management-container .member-management {\n    flex: 1;\n    min-height: 0;\n  }\n\n  @keyframes contentFadeIn {\n    from {\n      opacity: 0;\n      transform: translateY(10px);\n    }\n    to {\n      opacity: 1;\n      transform: translateY(0);\n    }\n  }\n\n  .section-title {\n    display: flex;\n    align-items: center;\n    gap: 10px;\n    font-size: 18px;\n    font-weight: 600;\n    color: #fff;\n    margin: 0 0 8px 0;\n  }\n\n  .section-title.danger {\n    color: #ff453a;\n  }\n\n  .section-description {\n    color: rgba(255, 255, 255, 0.5);\n    font-size: 14px;\n    margin: 0 0 20px 0;\n  }\n\n  /* Setting Cards */\n  .setting-card {\n    background: rgba(255, 255, 255, 0.03);\n    border: 1px solid rgba(255, 255, 255, 0.08);\n    border-radius: 12px;\n    padding: 20px;\n    margin-bottom: 16px;\n    backdrop-filter: blur(20px);\n    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n  }\n\n  .setting-card:hover {\n    border-color: rgba(255, 255, 255, 0.15);\n    background: rgba(255, 255, 255, 0.05);\n  }\n\n  .setting-row {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    gap: 16px;\n  }\n\n  .setting-info label {\n    display: block;\n    font-size: 15px;\n    font-weight: 500;\n    color: #fff;\n    margin-bottom: 4px;\n  }\n\n  .setting-info p {\n    font-size: 13px;\n    color: rgba(255, 255, 255, 0.5);\n    margin: 0;\n  }\n\n  /* Toggle Switch */\n  .toggle-switch {\n    position: relative;\n    display: inline-block;\n    width: 52px;\n    height: 32px;\n    flex-shrink: 0;\n  }\n\n  .toggle-switch input {\n    opacity: 0;\n    width: 0;\n    height: 0;\n  }\n\n  .toggle-slider {\n    position: absolute;\n    cursor: pointer;\n    inset: 0;\n    background: rgba(255, 255, 255, 0.1);\n    transition: 0.3s;\n    border-radius: 32px;\n    border: 1.5px solid rgba(255, 255, 255, 0.2);\n  }\n\n  .toggle-slider:before {\n    position: absolute;\n    content: \"\";\n    height: 24px;\n    width: 24px;\n    left: 3px;\n    bottom: 3px;\n    background: white;\n    transition: 0.3s;\n    border-radius: 50%;\n    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);\n  }\n\n  .toggle-switch input:checked + .toggle-slider {\n    background: #0a84ff;\n    border-color: #0a84ff;\n  }\n\n  .toggle-switch input:checked + .toggle-slider:before {\n    transform: translateX(20px);\n  }\n\n  /* Inputs */\n  .password-input-group {\n    margin-top: 16px;\n    padding-top: 16px;\n    border-top: 1px solid rgba(255, 255, 255, 0.08);\n  }\n\n  .password-input-group label {\n    display: block;\n    font-size: 13px;\n    font-weight: 500;\n    color: rgba(255, 255, 255, 0.7);\n    margin-bottom: 8px;\n  }\n\n  .input-with-icon {\n    display: flex;\n    gap: 8px;\n  }\n\n  .input-with-icon input {\n    flex: 1;\n    background: rgba(0, 0, 0, 0.4);\n    border: 1.5px solid rgba(255, 255, 255, 0.1);\n    border-radius: 10px;\n    padding: 10px 14px;\n    color: #fff;\n    font-size: 14px;\n    transition: all 0.2s;\n  }\n\n  .input-with-icon input:focus {\n    outline: none;\n    border-color: #0a84ff;\n    background: rgba(0, 0, 0, 0.6);\n    box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.15);\n  }\n\n  .icon-button {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    padding: 0 12px;\n    background: rgba(255, 255, 255, 0.05);\n    border: 1px solid rgba(255, 255, 255, 0.1);\n    border-radius: 8px;\n    color: rgba(255, 255, 255, 0.7);\n    font-size: 13px;\n    cursor: pointer;\n    transition: all 0.2s;\n  }\n\n  .icon-button:hover {\n    background: rgba(255, 255, 255, 0.1);\n    color: #fff;\n  }\n\n  .icon-button.danger:hover {\n    background: rgba(255, 69, 58, 0.15);\n    color: #ff453a;\n    border-color: rgba(255, 69, 58, 0.3);\n  }\n\n  .icon-button:disabled {\n    opacity: 0.5;\n    cursor: not-allowed;\n  }\n\n  .hint {\n    font-size: 12px;\n    color: rgba(255, 255, 255, 0.4);\n    margin-top: 6px;\n  }\n\n  /* API Keys Grid */\n  .api-keys-grid {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));\n    gap: 16px;\n  }\n\n  .api-key-card {\n    background: rgba(255, 255, 255, 0.03);\n    border: 1px solid rgba(255, 255, 255, 0.08);\n    border-radius: 12px;\n    padding: 16px;\n    transition: all 0.2s;\n  }\n\n  .api-key-card:hover {\n    border-color: rgba(255, 255, 255, 0.15);\n    background: rgba(255, 255, 255, 0.05);\n  }\n\n  .api-key-header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    margin-bottom: 12px;\n  }\n\n  .provider-name {\n    font-size: 14px;\n    font-weight: 600;\n    color: #fff;\n  }\n\n  .status-badge {\n    font-size: 11px;\n    padding: 3px 8px;\n    background: rgba(52, 199, 89, 0.15);\n    color: #34c759;\n    border-radius: 6px;\n    font-weight: 600;\n    border: 1px solid rgba(52, 199, 89, 0.3);\n  }\n\n  .key-display,\n  .key-input {\n    display: flex;\n    align-items: center;\n    gap: 8px;\n  }\n\n  .key-masked {\n    flex: 1;\n    font-size: 12px;\n    color: rgba(255, 255, 255, 0.3);\n  }\n\n  .key-input input {\n    flex: 1;\n    background: rgba(0, 0, 0, 0.4);\n    border: 1.5px solid rgba(255, 255, 255, 0.1);\n    border-radius: 8px;\n    padding: 8px 12px;\n    color: #fff;\n    font-size: 13px;\n    font-family: monospace;\n  }\n\n  .key-input input:focus {\n    outline: none;\n    border-color: #0a84ff;\n    box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.15);\n  }\n\n  .key-actions {\n    display: flex;\n    gap: 6px;\n  }\n\n  /* Members */\n  .members-summary {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    margin-bottom: 16px;\n  }\n\n  .member-stat {\n    display: flex;\n    flex-direction: column;\n  }\n\n  .stat-value {\n    font-size: 32px;\n    font-weight: 700;\n    color: #0a84ff;\n  }\n\n  .stat-label {\n    font-size: 13px;\n    color: rgba(255, 255, 255, 0.5);\n  }\n\n  .role-badge {\n    font-size: 12px;\n    font-weight: 600;\n    padding: 6px 12px;\n    background: rgba(255, 255, 255, 0.05);\n    border: 1px solid rgba(255, 255, 255, 0.1);\n    border-radius: 8px;\n  }\n\n  /* P2P Connectivity */\n  .connectivity-status {\n    margin-bottom: 20px;\n  }\n\n  .status-row {\n    display: flex;\n    gap: 16px;\n    margin-bottom: 12px;\n  }\n\n  .status-row:last-child {\n    margin-bottom: 0;\n  }\n\n  .status-item {\n    flex: 1;\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    padding: 10px 12px;\n    background: rgba(255, 255, 255, 0.03);\n    border-radius: 8px;\n    font-size: 13px;\n  }\n\n  .status-item svg {\n    color: rgba(255, 255, 255, 0.5);\n    flex-shrink: 0;\n  }\n\n  .status-label {\n    color: rgba(255, 255, 255, 0.6);\n  }\n\n  .status-value {\n    margin-left: auto;\n    font-weight: 600;\n    display: flex;\n    align-items: center;\n    gap: 4px;\n  }\n\n  .status-value.success {\n    color: #30d158;\n  }\n\n  .status-value.error {\n    color: #ff453a;\n  }\n\n  .connectivity-test {\n    padding-top: 16px;\n    border-top: 1px solid rgba(255, 255, 255, 0.08);\n  }\n\n  .test-header {\n    margin-bottom: 12px;\n  }\n\n  .test-header strong {\n    font-size: 14px;\n    color: #fff;\n  }\n\n  .test-description {\n    font-size: 12px;\n    color: rgba(255, 255, 255, 0.5);\n    margin: 4px 0 0 0;\n  }\n\n  .test-results {\n    margin-top: 16px;\n    padding: 12px;\n    background: rgba(0, 0, 0, 0.2);\n    border-radius: 8px;\n  }\n\n  .result-row {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    padding: 8px 0;\n    font-size: 13px;\n    border-bottom: 1px solid rgba(255, 255, 255, 0.05);\n  }\n\n  .result-row:last-of-type {\n    border-bottom: none;\n  }\n\n  .result-success {\n    color: #30d158;\n    display: flex;\n    align-items: center;\n    gap: 4px;\n  }\n\n  .result-error {\n    color: #ff453a;\n    display: flex;\n    align-items: center;\n    gap: 4px;\n  }\n\n  .result-warning {\n    color: #ff9f0a;\n    display: flex;\n    align-items: center;\n    gap: 4px;\n  }\n\n  .result-value {\n    color: #0a84ff;\n    font-weight: 600;\n  }\n\n  .result-error-message,\n  .result-success-message,\n  .result-info-message {\n    margin-top: 12px;\n    padding: 10px 12px;\n    border-radius: 6px;\n    font-size: 12px;\n    display: flex;\n    align-items: center;\n    gap: 8px;\n  }\n\n  .result-error-message {\n    background: rgba(255, 69, 58, 0.15);\n    color: #ff453a;\n  }\n\n  .result-success-message {\n    background: rgba(48, 209, 88, 0.15);\n    color: #30d158;\n  }\n\n  .result-info-message {\n    background: rgba(10, 132, 255, 0.15);\n    color: #0a84ff;\n  }\n\n  .info-card {\n    background: rgba(10, 132, 255, 0.08) !important;\n    border-color: rgba(10, 132, 255, 0.2) !important;\n  }\n\n  .info-content strong {\n    font-size: 14px;\n    color: #0a84ff;\n    display: block;\n    margin-bottom: 8px;\n  }\n\n  .info-list {\n    margin: 0;\n    padding-left: 16px;\n    font-size: 12px;\n    color: rgba(255, 255, 255, 0.7);\n  }\n\n  .info-list li {\n    margin-bottom: 4px;\n  }\n\n  .info-list li:last-child {\n    margin-bottom: 0;\n  }\n\n  .spinning {\n    animation: spin 1s linear infinite;\n  }\n\n  @keyframes spin {\n    from { transform: rotate(0deg); }\n    to { transform: rotate(360deg); }\n  }\n\n  /* Collapsible Section */\n  .collapsible-section {\n    margin-bottom: 20px;\n  }\n\n  .collapsible-header {\n    width: 100%;\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: 16px 20px;\n    background: rgba(255, 255, 255, 0.03);\n    border: 1px solid rgba(255, 255, 255, 0.08);\n    border-radius: 12px;\n    cursor: pointer;\n    transition: all 0.2s;\n  }\n\n  .collapsible-header:hover {\n    background: rgba(255, 255, 255, 0.05);\n    border-color: rgba(255, 255, 255, 0.15);\n  }\n\n  .collapsible-header .header-left {\n    display: flex;\n    align-items: center;\n    gap: 12px;\n  }\n\n  .collapsible-header h3 {\n    margin: 0;\n    font-size: 16px;\n    font-weight: 600;\n    color: #fff;\n  }\n\n  .collapsible-header p {\n    margin: 2px 0 0 0;\n    font-size: 13px;\n    color: rgba(255, 255, 255, 0.5);\n  }\n\n  .collapsible-content {\n    margin-top: 12px;\n    padding: 20px;\n    background: rgba(255, 255, 255, 0.02);\n    border: 1px solid rgba(255, 255, 255, 0.08);\n    border-radius: 12px;\n  }\n\n  /* Danger Zone */\n  .danger-zone {\n    margin-top: 32px;\n  }\n\n  .danger-card {\n    border-color: rgba(255, 69, 58, 0.2);\n    background: rgba(255, 69, 58, 0.03);\n  }\n\n  .nuke-section {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    gap: 20px;\n  }\n\n  .nuke-info strong {\n    display: block;\n    font-size: 15px;\n    color: #ff453a;\n    margin-bottom: 4px;\n  }\n\n  .nuke-info p {\n    font-size: 13px;\n    color: rgba(255, 255, 255, 0.5);\n    margin: 0;\n  }\n\n  .nuke-switch {\n    position: relative;\n    width: 70px;\n    height: 70px;\n    perspective: 800px;\n  }\n\n  .safety-cover {\n    position: absolute;\n    inset: 0;\n    background: repeating-linear-gradient(45deg, #e8be33, #e8be33 8px, #1a1a1a 8px, #1a1a1a 16px);\n    border: 2px solid #52420a;\n    border-radius: 8px;\n    cursor: pointer;\n    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);\n    transform-origin: top center;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    z-index: 2;\n  }\n\n  .safety-cover span {\n    background: #1a1a1a;\n    color: #e8be33;\n    font-size: 9px;\n    font-weight: 900;\n    padding: 1px 4px;\n    border: 1px solid #e8be33;\n  }\n\n  .nuke-switch.open .safety-cover {\n    transform: rotateX(110deg);\n  }\n\n  .nuke-button {\n    position: absolute;\n    inset: 10px;\n    border-radius: 50%;\n    background: radial-gradient(circle at 30% 30%, #ff453a, #dc2626);\n    color: #fff;\n    font-weight: 900;\n    font-size: 10px;\n    border: none;\n    cursor: pointer;\n    box-shadow: 0 5px 0 #991b1b, 0 8px 8px rgba(0, 0, 0, 0.5);\n    transition: all 0.15s;\n    letter-spacing: 0.5px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n  }\n\n  .nuke-button:active {\n    transform: translateY(3px);\n    box-shadow: 0 1px 0 #8c1c1c;\n  }\n\n  .nuke-button:disabled {\n    opacity: 0.4;\n    cursor: not-allowed;\n  }\n\n  .nuke-button.done {\n    background: #34c759;\n    box-shadow: 0 4px 0 #248a3d;\n  }\n\n  .nuke-feedback {\n    margin-top: 12px;\n    padding: 12px;\n    background: rgba(52, 199, 89, 0.15);\n    border: 1px solid rgba(52, 199, 89, 0.3);\n    border-radius: 8px;\n    color: #34c759;\n    font-size: 13px;\n    font-weight: 500;\n    text-align: center;\n  }\n\n  .delete-space-section {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    gap: 20px;\n  }\n\n  .delete-space-section strong {\n    display: block;\n    font-size: 15px;\n    color: #ff453a;\n    margin-bottom: 4px;\n  }\n\n  .delete-space-section p {\n    font-size: 13px;\n    color: rgba(255, 255, 255, 0.5);\n    margin: 0;\n  }\n\n  /* Credits Tab */\n  .credits-section {\n    max-width: 700px;\n  }\n\n  .subsection-title {\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    font-size: 16px;\n    font-weight: 600;\n    color: #fff;\n    margin: 24px 0 16px 0;\n  }\n\n  .libraries-grid {\n    display: grid;\n    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));\n    gap: 12px;\n    margin-bottom: 32px;\n  }\n\n  .library-card {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    gap: 12px;\n    padding: 14px 16px;\n    background: rgba(255, 255, 255, 0.03);\n    border: 1px solid rgba(255, 255, 255, 0.08);\n    border-radius: 10px;\n    text-decoration: none;\n    transition: all 0.2s;\n  }\n\n  .library-card:hover {\n    background: rgba(255, 255, 255, 0.05);\n    border-color: rgba(10, 132, 255, 0.3);\n    transform: translateY(-2px);\n  }\n\n  .library-info strong {\n    display: block;\n    font-size: 14px;\n    color: #fff;\n    margin-bottom: 2px;\n  }\n\n  .library-info p {\n    font-size: 12px;\n    color: rgba(255, 255, 255, 0.5);\n    margin: 0;\n  }\n\n  .library-card svg {\n    color: rgba(255, 255, 255, 0.4);\n    flex-shrink: 0;\n  }\n\n  .made-with-love {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 8px;\n    padding: 20px;\n    background: linear-gradient(135deg, rgba(10, 132, 255, 0.1), rgba(147, 51, 234, 0.1));\n    border: 1px solid rgba(255, 255, 255, 0.1);\n    border-radius: 12px;\n    color: rgba(255, 255, 255, 0.7);\n    font-size: 14px;\n  }\n\n  .made-with-love svg {\n    color: #fbbf24;\n  }\n\n  /* Support Tab */\n  .support-section {\n    max-width: 600px;\n  }\n\n  .support-item {\n    display: flex;\n    align-items: center;\n    gap: 16px;\n  }\n\n  .support-item > svg {\n    color: #0a84ff;\n    flex-shrink: 0;\n  }\n\n  .support-item > div {\n    flex: 1;\n  }\n\n  .support-item strong {\n    display: block;\n    font-size: 15px;\n    color: #fff;\n    margin-bottom: 4px;\n  }\n\n  .support-item p {\n    font-size: 13px;\n    color: rgba(255, 255, 255, 0.5);\n    margin: 0;\n  }\n\n  .version-info {\n    margin-top: 32px;\n    padding-top: 20px;\n    border-top: 1px solid rgba(255, 255, 255, 0.08);\n    text-align: center;\n    color: rgba(255, 255, 255, 0.4);\n    font-size: 12px;\n  }\n\n  .version-info p {\n    margin: 4px 0;\n  }\n\n  /* Footer */\n  .settings-footer {\n    display: flex;\n    align-items: center;\n    justify-content: flex-end;\n    gap: 12px;\n    padding: 16px 24px;\n    background: rgba(255, 255, 255, 0.02);\n    border-top: 1px solid rgba(255, 255, 255, 0.08);\n  }\n\n  /* Buttons */\n  .btn-primary,\n  .btn-secondary,\n  .btn-danger {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 8px;\n    padding: 10px 20px;\n    border-radius: 10px;\n    font-size: 14px;\n    font-weight: 500;\n    cursor: pointer;\n    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n    border: none;\n  }\n\n  .btn-primary {\n    background: #0a84ff;\n    color: #fff;\n  }\n\n  .btn-primary:hover {\n    background: #0077ed;\n    transform: translateY(-1px);\n    box-shadow: 0 4px 12px rgba(10, 132, 255, 0.3);\n  }\n\n  .btn-secondary {\n    background: rgba(255, 255, 255, 0.05);\n    border: 1px solid rgba(255, 255, 255, 0.1);\n    color: #fff;\n  }\n\n  .btn-secondary:hover {\n    background: rgba(255, 255, 255, 0.1);\n    border-color: rgba(255, 255, 255, 0.2);\n  }\n\n  .btn-danger {\n    background: rgba(255, 69, 58, 0.15);\n    color: #ff453a;\n    border: 1px solid rgba(255, 69, 58, 0.3);\n  }\n\n  .btn-danger:hover {\n    background: rgba(255, 69, 58, 0.25);\n    border-color: rgba(255, 69, 58, 0.5);\n  }\n\n  .full-width {\n    width: 100%;\n  }\n\n  /* Scrollbar */\n  .settings-content::-webkit-scrollbar {\n    width: 8px;\n  }\n\n  .settings-content::-webkit-scrollbar-track {\n    background: rgba(255, 255, 255, 0.02);\n  }\n\n  .settings-content::-webkit-scrollbar-thumb {\n    background: rgba(255, 255, 255, 0.1);\n    border-radius: 4px;\n  }\n\n  .settings-content::-webkit-scrollbar-thumb:hover {\n    background: rgba(255, 255, 255, 0.15);\n  }\n\n  /* Info Banner */\n  .info-banner {\n    display: flex;\n    align-items: center;\n    gap: 10px;\n    padding: 12px 16px;\n    background: linear-gradient(135deg, rgba(10, 132, 255, 0.1) 0%, rgba(16, 185, 129, 0.1) 100%);\n    border: 1px solid rgba(10, 132, 255, 0.2);\n    border-radius: 10px;\n    color: rgba(255, 255, 255, 0.9);\n    font-size: 13px;\n    margin-bottom: 20px;\n  }\n\n  .info-banner svg {\n    color: #0a84ff;\n    flex-shrink: 0;\n  }\n\n  /* Offline Models Section */\n  .collapsible-header .header-right {\n    display: flex;\n    align-items: center;\n    gap: 12px;\n  }\n\n  .storage-badge {\n    font-size: 12px;\n    color: rgba(255, 255, 255, 0.6);\n    background: rgba(255, 255, 255, 0.05);\n    padding: 4px 10px;\n    border-radius: 6px;\n  }\n\n  .offline-models-info {\n    display: flex;\n    align-items: center;\n    gap: 12px;\n    padding: 12px;\n    background: rgba(255, 255, 255, 0.02);\n    border-radius: 8px;\n    margin-bottom: 16px;\n    font-size: 13px;\n    color: rgba(255, 255, 255, 0.7);\n  }\n\n  .tier-badge {\n    padding: 4px 10px;\n    background: linear-gradient(135deg, #0a84ff 0%, #5e5ce6 100%);\n    color: white;\n    border-radius: 6px;\n    font-size: 11px;\n    font-weight: 600;\n    text-transform: uppercase;\n  }\n\n  .offline-model-list {\n    display: flex;\n    flex-direction: column;\n    gap: 12px;\n    max-height: 400px;\n    overflow-y: auto;\n    padding-right: 4px;\n  }\n\n  .offline-model-card {\n    background: rgba(255, 255, 255, 0.02);\n    border: 1px solid rgba(255, 255, 255, 0.08);\n    border-radius: 12px;\n    padding: 16px;\n    transition: all 0.2s ease;\n  }\n\n  .offline-model-card:hover {\n    border-color: rgba(255, 255, 255, 0.15);\n    background: rgba(255, 255, 255, 0.04);\n  }\n\n  .offline-model-card.downloaded {\n    border-color: rgba(34, 197, 94, 0.3);\n    background: rgba(34, 197, 94, 0.05);\n  }\n\n  .offline-model-card.active {\n    border-color: rgba(10, 132, 255, 0.4);\n    background: rgba(10, 132, 255, 0.08);\n  }\n\n  .model-main {\n    display: flex;\n    gap: 12px;\n  }\n\n  .model-icon {\n    font-size: 20px;\n  }\n\n  .model-info {\n    flex: 1;\n  }\n\n  .model-header-row {\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    margin-bottom: 4px;\n    flex-wrap: wrap;\n  }\n\n  .model-header-row strong {\n    font-size: 14px;\n    color: #fff;\n  }\n\n  .model-desc {\n    font-size: 12px;\n    color: rgba(255, 255, 255, 0.5);\n    margin: 0 0 8px 0;\n  }\n\n  .model-stats {\n    display: flex;\n    gap: 12px;\n    font-size: 11px;\n    color: rgba(255, 255, 255, 0.4);\n  }\n\n  .model-stats .quality {\n    color: #fbbf24;\n  }\n\n  /* Badges */\n  .badge {\n    font-size: 10px;\n    padding: 2px 8px;\n    border-radius: 4px;\n    font-weight: 500;\n  }\n\n  .badge-active {\n    background: #0a84ff;\n    color: white;\n  }\n\n  .badge-downloaded {\n    background: #22c55e;\n    color: white;\n  }\n\n  .badge-progress {\n    background: #eab308;\n    color: #000;\n  }\n\n  .badge-paused {\n    background: rgba(255, 255, 255, 0.2);\n    color: white;\n  }\n\n  .badge-error {\n    background: #ef4444;\n    color: white;\n  }\n\n  /* Download Progress */\n  .download-progress {\n    margin-top: 12px;\n  }\n\n  .progress-bar {\n    height: 6px;\n    background: rgba(255, 255, 255, 0.1);\n    border-radius: 3px;\n    overflow: hidden;\n  }\n\n  .progress-fill {\n    height: 100%;\n    background: linear-gradient(90deg, #0a84ff, #5e5ce6);\n    border-radius: 3px;\n    transition: width 0.3s ease;\n  }\n\n  .progress-info {\n    display: flex;\n    justify-content: space-between;\n    margin-top: 6px;\n    font-size: 11px;\n    color: rgba(255, 255, 255, 0.5);\n  }\n\n  .error-message {\n    margin-top: 8px;\n    padding: 8px 12px;\n    background: rgba(239, 68, 68, 0.1);\n    border: 1px solid rgba(239, 68, 68, 0.2);\n    border-radius: 6px;\n    font-size: 12px;\n    color: #ef4444;\n  }\n\n  /* Model Actions */\n  .model-actions {\n    display: flex;\n    gap: 8px;\n    margin-top: 12px;\n    padding-top: 12px;\n    border-top: 1px solid rgba(255, 255, 255, 0.06);\n  }\n\n  .btn {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 6px;\n    padding: 8px 14px;\n    border-radius: 8px;\n    font-size: 12px;\n    font-weight: 500;\n    cursor: pointer;\n    transition: all 0.2s ease;\n    border: none;\n    background: transparent;\n  }\n\n  .btn-primary {\n    background: #0a84ff;\n    color: white;\n  }\n\n  .btn-primary:hover {\n    background: #0077ed;\n  }\n\n  .btn-secondary {\n    background: rgba(255, 255, 255, 0.08);\n    color: white;\n    border: 1px solid rgba(255, 255, 255, 0.1);\n  }\n\n  .btn-secondary:hover {\n    background: rgba(255, 255, 255, 0.12);\n  }\n\n  .btn-ghost {\n    color: rgba(255, 255, 255, 0.6);\n  }\n\n  .btn-ghost:hover {\n    background: rgba(255, 255, 255, 0.05);\n    color: white;\n  }\n\n  .btn-danger {\n    background: rgba(239, 68, 68, 0.15);\n    color: #ef4444;\n    border: 1px solid rgba(239, 68, 68, 0.3);\n  }\n\n  .btn-danger:hover {\n    background: rgba(239, 68, 68, 0.25);\n  }\n\n  .offline-model-list::-webkit-scrollbar {\n    width: 6px;\n  }\n\n  .offline-model-list::-webkit-scrollbar-track {\n    background: transparent;\n  }\n\n  .offline-model-list::-webkit-scrollbar-thumb {\n    background: rgba(255, 255, 255, 0.1);\n    border-radius: 3px;\n  }\n\n  /* Loading spinner animation */\n  .animate-spin {\n    animation: spin 1s linear infinite;\n  }\n\n  @keyframes spin {\n    from { transform: rotate(0deg); }\n    to { transform: rotate(360deg); }\n  }\n\n  .btn:disabled {\n    opacity: 0.5;\n    cursor: not-allowed;\n  }\n`\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\UpdateButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\UpdateModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\VersionPanel.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":171,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":171,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5280,5283],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5280,5283],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n// Version History Panel - Shows document versions and allows restoring\r\nimport { useState, useEffect, useMemo } from 'react'\r\nimport { DiffEditor } from '@monaco-editor/react'\r\nimport { useAppStore } from '../stores/appStore'\r\nimport { versionControlService, Version } from '../services/versionControlService'\r\nimport { Search, GitBranch, History, ChevronRight, X, Trash2, Download, Info } from 'lucide-react'\r\nimport './VersionPanel.css'\r\n\r\nconst electron = window.electronAPI\r\n\r\ninterface VersionItem {\r\n  id: string\r\n  label: string\r\n  description: string\r\n  author: string\r\n  timestamp: number\r\n  branch: string\r\n}\r\n\r\nexport default function VersionPanel() {\r\n  const { currentSpace } = useAppStore()\r\n  const [versions, setVersions] = useState<VersionItem[]>([])\r\n  const [currentBranch, setCurrentBranch] = useState('main')\r\n  const [branches, setBranches] = useState<string[]>(['main'])\r\n  const [showCreateVersion, setShowCreateVersion] = useState(false)\r\n  const [versionLabel, setVersionLabel] = useState('')\r\n  const [versionDesc, setVersionDesc] = useState('')\r\n  const [filterQuery, setFilterQuery] = useState('')\r\n  const [showBranchInput, setShowBranchInput] = useState(false)\r\n  const [newBranchName, setNewBranchName] = useState('')\r\n  const [isBackingUp, setIsBackingUp] = useState(false)\r\n\r\n  // Diff View State\r\n  const [showDiff, setShowDiff] = useState(false)\r\n  const [diffData, setDiffData] = useState<{\r\n    original: string,\r\n    modified: string,\r\n    vLabel: string,\r\n    parentLabel: string\r\n  } | null>(null)\r\n\r\n  const userId = 'local-user'\r\n  const userName = 'You'\r\n\r\n  useEffect(() => {\r\n    if (currentSpace) {\r\n      loadVersions()\r\n      loadBranches()\r\n    }\r\n  }, [currentSpace])\r\n\r\n  const loadBranches = () => {\r\n    if (!currentSpace) return\r\n    setBranches(versionControlService.getBranches(currentSpace.id))\r\n    setCurrentBranch(versionControlService.getCurrentBranch(currentSpace.id))\r\n  }\r\n\r\n  const loadVersions = () => {\r\n    if (!currentSpace) return\r\n    const timeline = versionControlService.getTimeline(currentSpace.id)\r\n    setVersions(timeline)\r\n  }\r\n\r\n  const filteredVersions = useMemo(() => {\r\n    if (!filterQuery) return versions\r\n    const lower = filterQuery.toLowerCase()\r\n    return versions.filter(v =>\r\n      v.label.toLowerCase().includes(lower) ||\r\n      v.description.toLowerCase().includes(lower) ||\r\n      v.author.toLowerCase().includes(lower)\r\n    )\r\n  }, [versions, filterQuery])\r\n\r\n  const handleCreateVersion = () => {\r\n    if (!currentSpace || !versionLabel.trim()) return\r\n\r\n    versionControlService.createVersion(\r\n      currentSpace.id,\r\n      versionLabel.trim(),\r\n      versionDesc.trim(),\r\n      userId,\r\n      userName\r\n    )\r\n\r\n    setVersionLabel('')\r\n    setVersionDesc('')\r\n    setShowCreateVersion(false)\r\n    loadVersions()\r\n  }\r\n\r\n  const handleRestore = (versionId: string) => {\r\n    if (!currentSpace) return\r\n    if (confirm('Restore the editor to this version? This will replace the current document content.')) {\r\n      const success = versionControlService.restoreVersion(currentSpace.id, versionId)\r\n      if (success) {\r\n        loadVersions()\r\n      }\r\n    }\r\n  }\r\n\r\n  const handleDeleteVersion = (versionId: string) => {\r\n    if (!currentSpace) return\r\n    if (confirm('Delete this version? This cannot be undone.')) {\r\n      versionControlService.deleteVersion(currentSpace.id, versionId)\r\n      loadVersions()\r\n      loadBranches()\r\n    }\r\n  }\r\n\r\n  const handleCompare = (versionId: string) => {\r\n    if (!currentSpace) return\r\n\r\n    const currentVersion = versionControlService.getVersion(currentSpace.id, versionId)\r\n    if (!currentVersion) return\r\n\r\n    let prevVersion: Version | undefined\r\n    const currentIndex = versions.findIndex(v => v.id === versionId)\r\n    if (currentIndex < versions.length - 1) {\r\n      const prevId = versions[currentIndex + 1].id\r\n      prevVersion = versionControlService.getVersion(currentSpace.id, prevId)\r\n    }\r\n\r\n    const comparison = versionControlService.compareVersions(\r\n      currentSpace.id,\r\n      prevVersion?.id || versionId,\r\n      versionId\r\n    )\r\n\r\n    if (comparison) {\r\n      setDiffData({\r\n        original: comparison.aContent,\r\n        modified: comparison.bContent,\r\n        vLabel: currentVersion.label,\r\n        parentLabel: prevVersion?.label || 'Previous'\r\n      })\r\n      setShowDiff(true)\r\n    }\r\n  }\r\n\r\n  const handleCreateBranch = () => {\r\n    if (!currentSpace || !newBranchName.trim()) return\r\n\r\n    const name = newBranchName.trim()\r\n    const success = versionControlService.createBranch(currentSpace.id, name)\r\n\r\n    if (success) {\r\n      setBranches(versionControlService.getBranches(currentSpace.id))\r\n      setNewBranchName('')\r\n      setShowBranchInput(false)\r\n      // Auto switch to new branch\r\n      handleSwitchBranch(name)\r\n    } else {\r\n      alert('Branch already exists')\r\n    }\r\n  }\r\n\r\n  const handleSwitchBranch = (branch: string) => {\r\n    if (!currentSpace) return\r\n    versionControlService.switchBranch(currentSpace.id, branch)\r\n    setCurrentBranch(branch)\r\n    loadVersions()\r\n  }\r\n\r\n  const handleBackup = async () => {\r\n    if (isBackingUp) return\r\n    setIsBackingUp(true)\r\n    try {\r\n      const result = await (electron as any).fs.backupWorkspace()\r\n      if (result.success) {\r\n        alert(`Backup created successfully!`)\r\n      } else {\r\n        alert(`Backup failed: ${result.error}`)\r\n      }\r\n    } catch (err) {\r\n      alert(`Backup failed: ${err}`)\r\n    } finally {\r\n      setIsBackingUp(false)\r\n    }\r\n  }\r\n\r\n  const formatTime = (ts: number) => {\r\n    const date = new Date(ts)\r\n    const now = new Date()\r\n    const diff = now.getTime() - ts\r\n\r\n    if (diff < 60000) return 'Just now'\r\n    if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`\r\n    if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`\r\n    return date.toLocaleDateString()\r\n  }\r\n\r\n  const closeDiff = () => {\r\n    // Close modal first, then clear data to ensure proper cleanup\r\n    setShowDiff(false)\r\n    setTimeout(() => setDiffData(null), 100)\r\n  }\r\n\r\n  if (!currentSpace) {\r\n    return (\r\n      <div className=\"version-panel empty\">\r\n        <History size={48} style={{ opacity: 0.2, marginBottom: 16 }} />\r\n        <p>Select a space to view version history</p>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"version-panel\">\r\n      <div className=\"version-header\">\r\n        <div className=\"header-left\">\r\n          <h2><History size={18} /> History</h2>\r\n\r\n          <div className=\"search-input-wrapper\">\r\n            <Search size={14} className=\"search-icon-overlay\" />\r\n            <input\r\n              className=\"search-input\"\r\n              placeholder=\"Filter...\"\r\n              value={filterQuery}\r\n              onChange={e => setFilterQuery(e.target.value)}\r\n            />\r\n          </div>\r\n\r\n          <div className=\"branch-controls\">\r\n            {showBranchInput ? (\r\n              <div className=\"glass-input-group\">\r\n                <input\r\n                  autoFocus\r\n                  className=\"search-input\"\r\n                  style={{ width: 120 }}\r\n                  placeholder=\"Branch name...\"\r\n                  value={newBranchName}\r\n                  onChange={e => setNewBranchName(e.target.value)}\r\n                  onKeyDown={e => e.key === 'Enter' && handleCreateBranch()}\r\n                />\r\n                <button className=\"btn-icon small\" onClick={handleCreateBranch}><GitBranch size={14} /></button>\r\n                <button className=\"btn-icon small\" onClick={() => setShowBranchInput(false)}><X size={14} /></button>\r\n              </div>\r\n            ) : (\r\n              <>\r\n                <select\r\n                  className=\"branch-select\"\r\n                  value={currentBranch}\r\n                  onChange={(e) => handleSwitchBranch(e.target.value)}\r\n                >\r\n                  {branches.map(b => (\r\n                    <option key={b} value={b}>{b}</option>\r\n                  ))}\r\n                </select>\r\n                <button className=\"btn-icon\" onClick={() => setShowBranchInput(true)} title=\"New branch\">\r\n                  <GitBranch size={16} />\r\n                </button>\r\n              </>\r\n            )}\r\n          </div>\r\n        </div>\r\n        <div className=\"header-right\">\r\n          <button\r\n            className=\"btn btn-secondary\"\r\n            onClick={handleBackup}\r\n            disabled={isBackingUp}\r\n          >\r\n            <Download size={16} /> {isBackingUp ? 'Backing up...' : 'Full Backup'}\r\n          </button>\r\n          <button\r\n            className=\"btn btn-primary\"\r\n            onClick={() => setShowCreateVersion(true)}\r\n          >\r\n            Save Version\r\n          </button>\r\n        </div>\r\n      </div>\r\n\r\n      {showCreateVersion && (\r\n        <div className=\"create-version-overlay\" onClick={() => setShowCreateVersion(false)}>\r\n          <div className=\"create-version-form\" onClick={e => e.stopPropagation()}>\r\n            <div className=\"form-title\">Save Version</div>\r\n            <input\r\n              type=\"text\"\r\n              className=\"search-input\"\r\n              placeholder=\"Version name (e.g., v1.0, Stable)\"\r\n              value={versionLabel}\r\n              onChange={(e) => setVersionLabel(e.target.value)}\r\n              autoFocus\r\n            />\r\n            <textarea\r\n              className=\"search-input\"\r\n              style={{ height: 80, resize: 'none' }}\r\n              placeholder=\"What changed? (optional description)\"\r\n              value={versionDesc}\r\n              onChange={(e) => setVersionDesc(e.target.value)}\r\n            />\r\n            <div className=\"form-actions\">\r\n              <button className=\"btn btn-ghost\" onClick={() => setShowCreateVersion(false)}>\r\n                Cancel\r\n              </button>\r\n              <button\r\n                className=\"btn btn-primary\"\r\n                onClick={handleCreateVersion}\r\n                disabled={!versionLabel.trim()}\r\n              >\r\n                Create Version\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      <div className=\"version-info-banner\">\r\n        <Info size={14} />\r\n        <span>Tracks document content only. Use <b>Full Backup</b> for all files.</span>\r\n      </div>\r\n\r\n      <div className=\"version-list\">\r\n        {filteredVersions.length === 0 ? (\r\n          <div className=\"empty-versions\">\r\n            <History size={32} style={{ opacity: 0.3 }} />\r\n            <p>{filterQuery ? 'No matching versions found' : 'No versions yet'}</p>\r\n            {!filterQuery && <span className=\"hint\">Save a version to track document history</span>}\r\n          </div>\r\n        ) : (\r\n          filteredVersions.map((v, i) => (\r\n            <div key={v.id} className={`version-item ${i === 0 ? 'latest' : ''}`}>\r\n              <div className=\"version-timeline\">\r\n                <span className=\"timeline-dot\" />\r\n                {i < filteredVersions.length - 1 && <span className=\"timeline-line\" />}\r\n              </div>\r\n\r\n              <div className=\"version-card\">\r\n                <div className=\"version-header-row\">\r\n                  <div className=\"version-info\">\r\n                    <span className=\"version-label\">{v.label}</span>\r\n                    <div className=\"version-meta\">\r\n                      <span className=\"version-author\">{v.author}</span>\r\n                      <span>â€¢</span>\r\n                      <span className=\"version-time\">{formatTime(v.timestamp)}</span>\r\n                    </div>\r\n                  </div>\r\n                  <div className=\"card-header-actions\">\r\n                    {v.branch !== 'main' && (\r\n                      <span className=\"version-badge branch\">{v.branch}</span>\r\n                    )}\r\n                    <button\r\n                      className=\"delete-button-pill\"\r\n                      onClick={() => handleDeleteVersion(v.id)}\r\n                      title=\"Delete version\"\r\n                    >\r\n                      <Trash2 size={12} />\r\n                      <span>Delete</span>\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n\r\n                {v.description && (\r\n                  <p className=\"version-desc\">{v.description}</p>\r\n                )}\r\n\r\n                <div className=\"card-actions\">\r\n                  <button\r\n                    className=\"btn-secondary btn-sm\"\r\n                    onClick={() => handleCompare(v.id)}\r\n                    title=\"Compare with previous version\"\r\n                  >\r\n                    Compare\r\n                  </button>\r\n                  <button\r\n                    className=\"btn-secondary btn-sm\"\r\n                    onClick={() => handleRestore(v.id)}\r\n                    title=\"Restore this version\"\r\n                  >\r\n                    Restore\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          ))\r\n        )}\r\n      </div>\r\n\r\n      {showDiff && diffData && (\r\n        <div className=\"diff-modal-overlay\" onClick={closeDiff}>\r\n          <div className=\"diff-modal\" onClick={e => e.stopPropagation()}>\r\n            <div className=\"diff-header\">\r\n              <div className=\"diff-title\">\r\n                <span>Comparing changes</span>\r\n                <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>\r\n                  <span className=\"diff-tag\">{diffData.parentLabel}</span>\r\n                  <ChevronRight size={14} color=\"#666\" />\r\n                  <span className=\"diff-tag\" style={{ border: '1px solid var(--color-accent)', color: 'var(--color-accent)' }}>\r\n                    {diffData.vLabel}\r\n                  </span>\r\n                </div>\r\n              </div>\r\n              <button className=\"btn-icon\" onClick={closeDiff}>\r\n                <X size={20} />\r\n              </button>\r\n            </div>\r\n            <div style={{ flex: 1, position: 'relative' }}>\r\n              <DiffEditor\r\n                height=\"100%\"\r\n                original={diffData.original}\r\n                modified={diffData.modified}\r\n                language=\"markdown\"\r\n                theme=\"vs-dark\"\r\n                options={{\r\n                  readOnly: true,\r\n                  renderSideBySide: true,\r\n                  minimap: { enabled: false },\r\n                  scrollBeyondLastLine: false,\r\n                  fontSize: 13,\r\n                  automaticLayout: true\r\n                }}\r\n              />\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\WelcomeScreen.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\ide\\Breadcrumbs.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\ide\\CodeBlockRenderer.tsx","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":31,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":31,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[862,899],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\nimport { useState } from 'react'\r\nimport { Prism as SyntaxHighlighter } from 'react-syntax-highlighter'\r\nimport { vscDarkPlus } from 'react-syntax-highlighter/dist/esm/styles/prism'\r\n\r\ninterface CodeBlockProps {\r\n    code: string\r\n    language: string\r\n    onApply?: (code: string) => void\r\n    onCopy?: (code: string) => void\r\n}\r\n\r\nexport default function CodeBlockRenderer({\r\n    code,\r\n    language,\r\n    onApply,\r\n    onCopy\r\n}: CodeBlockProps) {\r\n    const [copied, setCopied] = useState(false)\r\n    const [applied, setApplied] = useState(false)\r\n\r\n    const handleCopy = async () => {\r\n        try {\r\n            await navigator.clipboard.writeText(code)\r\n            setCopied(true)\r\n            onCopy?.(code)\r\n            setTimeout(() => setCopied(false), 2000)\r\n        } catch (err) {\r\n            console.error('Failed to copy:', err)\r\n        }\r\n    }\r\n\r\n    const handleApply = () => {\r\n        onApply?.(code)\r\n        setApplied(true)\r\n        setTimeout(() => setApplied(false), 2000)\r\n    }\r\n\r\n    return (\r\n        <div className=\"code-block\">\r\n            <div className=\"code-header\">\r\n                <span className=\"code-language\">{language || 'code'}</span>\r\n                <div className=\"code-actions\">\r\n                    <button\r\n                        className={`code-action ${copied ? 'success' : ''}`}\r\n                        onClick={handleCopy}\r\n                        title=\"Copy code\"\r\n                    >\r\n                        {copied ? 'âœ“ Copied' : 'ðŸ“‹ Copy'}\r\n                    </button>\r\n                    {onApply && (\r\n                        <button\r\n                            className={`code-action apply ${applied ? 'success' : ''}`}\r\n                            onClick={handleApply}\r\n                            title=\"Apply to editor\"\r\n                        >\r\n                            {applied ? 'âœ“ Applied' : 'âš¡ Apply'}\r\n                        </button>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {/* SECURITY FIX: Replace dangerouslySetInnerHTML with react-syntax-highlighter */}\r\n            <SyntaxHighlighter\r\n                language={language || 'typescript'}\r\n                style={vscDarkPlus}\r\n                customStyle={{\r\n                    margin: 0,\r\n                    padding: '12px 16px',\r\n                    fontSize: '13px',\r\n                    lineHeight: '1.5',\r\n                    background: '#1a1a1a',\r\n                    borderRadius: '0 0 8px 8px'\r\n                }}\r\n                codeTagProps={{\r\n                    style: {\r\n                        fontFamily: \"'SF Mono', 'Fira Code', 'Consolas', monospace\"\r\n                    }\r\n                }}\r\n            >\r\n                {code}\r\n            </SyntaxHighlighter>\r\n\r\n            <style>{`\r\n        .code-block {\r\n          margin: 8px 0;\r\n          border-radius: 8px;\r\n          overflow: hidden;\r\n          background: #1a1a1a;\r\n          border: 1px solid var(--color-border, #3c3c3c);\r\n        }\r\n\r\n        .code-header {\r\n          display: flex;\r\n          align-items: center;\r\n          justify-content: space-between;\r\n          padding: 6px 12px;\r\n          background: rgba(255, 255, 255, 0.05);\r\n          border-bottom: 1px solid var(--color-border, #3c3c3c);\r\n        }\r\n\r\n        .code-language {\r\n          font-size: 11px;\r\n          font-weight: 500;\r\n          color: var(--color-text-muted, #888);\r\n          text-transform: uppercase;\r\n          letter-spacing: 0.5px;\r\n        }\r\n\r\n        .code-actions {\r\n          display: flex;\r\n          gap: 4px;\r\n        }\r\n\r\n        .code-action {\r\n          padding: 3px 8px;\r\n          background: transparent;\r\n          border: 1px solid var(--color-border, #3c3c3c);\r\n          border-radius: 4px;\r\n          color: var(--color-text-muted, #888);\r\n          font-size: 11px;\r\n          cursor: pointer;\r\n          transition: all 0.2s;\r\n        }\r\n\r\n        .code-action:hover {\r\n          background: var(--color-surface, #252526);\r\n          color: var(--color-text, #ccc);\r\n        }\r\n\r\n        .code-action.apply {\r\n          border-color: var(--color-accent, #0e639c);\r\n          color: var(--color-accent, #0e639c);\r\n        }\r\n\r\n        .code-action.apply:hover {\r\n          background: var(--color-accent, #0e639c);\r\n          color: white;\r\n        }\r\n\r\n        .code-action.success {\r\n          background: #1d6e3f;\r\n          border-color: #1d6e3f;\r\n          color: white;\r\n        }\r\n      `}</style>\r\n        </div>\r\n    )\r\n}\r\n\r\n// Helper to parse code blocks from markdown\r\nexport function parseCodeBlocks(text: string): Array<{ type: 'text' | 'code', content: string, language?: string }> {\r\n    const parts: Array<{ type: 'text' | 'code', content: string, language?: string }> = []\r\n    const codeBlockRegex = /```(\\w*)\\n?([\\s\\S]*?)```/g\r\n\r\n    let lastIndex = 0\r\n    let match\r\n\r\n    while ((match = codeBlockRegex.exec(text)) !== null) {\r\n        // Add text before code block\r\n        if (match.index > lastIndex) {\r\n            const textBefore = text.slice(lastIndex, match.index).trim()\r\n            if (textBefore) {\r\n                parts.push({ type: 'text', content: textBefore })\r\n            }\r\n        }\r\n\r\n        // Add code block\r\n        parts.push({\r\n            type: 'code',\r\n            content: match[2].trim(),\r\n            language: match[1] || 'typescript'\r\n        })\r\n\r\n        lastIndex = match.index + match[0].length\r\n    }\r\n\r\n    // Add remaining text\r\n    if (lastIndex < text.length) {\r\n        const remaining = text.slice(lastIndex).trim()\r\n        if (remaining) {\r\n            parts.push({ type: 'text', content: remaining })\r\n        }\r\n    }\r\n\r\n    return parts.length > 0 ? parts : [{ type: 'text', content: text }]\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\ide\\CommandPalette.tsx","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":127,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":127,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[3121,3163],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":138,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":138,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[3483,3528],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\nimport React, { useState, useEffect, useCallback, useMemo } from 'react'\r\nimport { Command } from 'cmdk'\r\nimport Fuse from 'fuse.js'\r\nimport {\r\n    Folder,\r\n    FileText,\r\n    FileCode,\r\n    FileJson,\r\n    FileEdit,\r\n    Palette,\r\n    Globe,\r\n    Lock,\r\n    Shield,\r\n    Terminal,\r\n    GitBranch,\r\n    Bot,\r\n    Pencil,\r\n    Eye,\r\n    Zap,\r\n    Save,\r\n    Play,\r\n    Bug,\r\n    Hammer,\r\n    Sparkles,\r\n    MoveVertical,\r\n    Search,\r\n    CheckCircle2,\r\n    ArrowUp,\r\n    ArrowDown,\r\n    X,\r\n    MessageSquare,\r\n    Lightbulb,\r\n    Wrench,\r\n    FilePlus\r\n} from 'lucide-react'\r\n\r\n// Command types\r\ninterface IDECommand {\r\n    id: string\r\n    title: string\r\n    shortcut?: string\r\n    category: 'file' | 'edit' | 'view' | 'terminal' | 'git' | 'ai'\r\n    action: () => void | Promise<void>\r\n    icon?: string | React.ReactNode\r\n}\r\n\r\ninterface FileItem {\r\n    path: string\r\n    name: string\r\n    type: 'file' | 'directory'\r\n}\r\n\r\ninterface CommandPaletteProps {\r\n    readonly open: boolean\r\n    readonly onOpenChange: (open: boolean) => void\r\n    readonly mode: 'commands' | 'files'\r\n    readonly files: FileItem[]\r\n    readonly onFileSelect?: (path: string) => void\r\n    readonly commands?: IDECommand[]\r\n    readonly workspacePath?: string\r\n}\r\n\r\nexport default function CommandPalette({\r\n    open,\r\n    onOpenChange,\r\n    mode: propMode,\r\n    files,\r\n    onFileSelect,\r\n    commands = [],\r\n    workspacePath\r\n}: CommandPaletteProps) {\r\n    // BUG-074: Mode validation\r\n    const mode = (propMode === 'files' || propMode === 'commands') ? propMode : 'commands'\r\n\r\n    const [search, setSearch] = useState('')\r\n\r\n    // Reset search when modal opens\r\n    useEffect(() => {\r\n        if (open) setSearch('')\r\n    }, [open])\r\n\r\n    // File search with Fuse.js\r\n    // File search with Fuse.js\r\n    const [fileFuse, setFileFuse] = useState<Fuse<FileItem> | null>(null)\r\n\r\n    // BUG-077: Add useEffect cleanup that destroys Fuse instances\r\n    useEffect(() => {\r\n        const fuseInstance = new Fuse(files, {\r\n            keys: ['name', 'path'],\r\n            threshold: 0.4,\r\n            distance: 100\r\n        })\r\n        setFileFuse(fuseInstance)\r\n\r\n        return () => {\r\n            setFileFuse(null) // Explicit cleanup\r\n        }\r\n    }, [files])\r\n\r\n    // Command search with Fuse.js\r\n    // Command search with Fuse.js\r\n    const [commandFuse, setCommandFuse] = useState<Fuse<IDECommand> | null>(null)\r\n\r\n    // BUG-077: Add useEffect cleanup that destroys Fuse instances\r\n    useEffect(() => {\r\n        const fuseInstance = new Fuse(commands, {\r\n            keys: ['title', 'category'],\r\n            threshold: 0.3\r\n        })\r\n        setCommandFuse(fuseInstance)\r\n\r\n        return () => {\r\n            setCommandFuse(null) // Explicit cleanup\r\n        }\r\n    }, [commands])\r\n\r\n    // Get filtered results\r\n    const filteredFiles = useMemo(() => {\r\n        try {\r\n            if (!search) return files.slice(0, 20)\r\n            if (!fileFuse) return []\r\n            return fileFuse.search(search).slice(0, 20).map(r => r.item)\r\n        } catch (error) {\r\n            console.error('File search error:', error)\r\n            return []\r\n        }\r\n    }, [search, files, fileFuse])\r\n\r\n    const filteredCommands = useMemo(() => {\r\n        try {\r\n            if (!search) return commands\r\n            if (!commandFuse) return []\r\n            return commandFuse.search(search).map(r => r.item)\r\n        } catch (error) {\r\n            console.error('Command search error:', error)\r\n            return []\r\n        }\r\n    }, [search, commands, commandFuse])\r\n\r\n    // Group commands by category\r\n    const groupedCommands = useMemo(() => {\r\n        const groups: Record<string, IDECommand[]> = {}\r\n        // Initialize known categories to ensure order\r\n        const categories = ['file', 'edit', 'view', 'terminal', 'git', 'ai']\r\n        categories.forEach(c => groups[c] = [])\r\n\r\n        filteredCommands.forEach(cmd => {\r\n            // Validate category\r\n            const category = cmd.category || 'other'\r\n            if (!groups[category]) groups[category] = []\r\n            groups[category].push(cmd)\r\n        })\r\n\r\n        // Remove empty groups\r\n        Object.keys(groups).forEach(key => {\r\n            if (groups[key].length === 0) delete groups[key]\r\n        })\r\n\r\n        return groups\r\n    }, [filteredCommands])\r\n\r\n    const handleSelect = useCallback((value: string) => {\r\n        if (mode === 'files' && onFileSelect) {\r\n            onFileSelect(value)\r\n        }\r\n        onOpenChange(false)\r\n    }, [mode, onFileSelect, onOpenChange])\r\n\r\n    // Get file icon based on extension\r\n    const getFileIcon = (name: string, type: 'file' | 'directory') => {\r\n        if (type === 'directory') return <Folder size={16} />\r\n        if (!name) return <FileText size={16} />\r\n\r\n        const ext = name.split('.').pop()?.toLowerCase()\r\n        const icons: Record<string, React.ReactNode> = {\r\n            ts: <FileCode size={16} color=\"#60a5fa\" />,\r\n            tsx: <FileCode size={16} color=\"#818cf8\" />,\r\n            js: <FileCode size={16} color=\"#facc15\" />,\r\n            jsx: <FileCode size={16} color=\"#818cf8\" />,\r\n            json: <FileJson size={16} color=\"#f87171\" />,\r\n            md: <FileEdit size={16} color=\"#94a3b8\" />,\r\n            css: <Palette size={16} color=\"#38bdf8\" />,\r\n            html: <Globe size={16} color=\"#fb923c\" />,\r\n            py: <FileCode size={16} color=\"#3776ab\" />,\r\n            rs: <FileCode size={16} color=\"#dea584\" />,\r\n            go: <FileCode size={16} color=\"#00add8\" />,\r\n            java: <FileCode size={16} color=\"#b07219\" />,\r\n            gitignore: <Lock size={16} color=\"#94a3b8\" />,\r\n            env: <Shield size={16} color=\"#fbbf24\" />\r\n        }\r\n\r\n        if (!ext || ext === name.toLowerCase()) return <FileText size={16} />\r\n        return icons[ext] || <FileText size={16} />\r\n    }\r\n\r\n    const getCategoryIcon = (category: string) => {\r\n        const icons: Record<string, React.ReactNode> = {\r\n            file: <Folder size={16} />,\r\n            edit: <Pencil size={16} />,\r\n            view: <Eye size={16} />,\r\n            terminal: <Terminal size={16} />,\r\n            git: <GitBranch size={16} />,\r\n            ai: <Bot size={16} />\r\n        }\r\n        return icons[category] || <Zap size={16} />\r\n    }\r\n\r\n    // Helper to render command icon which could be an emoji string from old code or a name\r\n    const renderIcon = (icon: string | React.ReactNode, category: string) => {\r\n        if (!icon) return getCategoryIcon(category)\r\n        if (typeof icon !== 'string') return icon\r\n\r\n        // Map names to Lucide components\r\n        const iconMap: Record<string, React.ReactNode> = {\r\n            'FilePlus': <FilePlus size={16} />,\r\n            'Save': <Save size={16} />,\r\n            'X': <X size={16} />,\r\n            'Folder': <Folder size={16} />,\r\n            'Terminal': <Terminal size={16} />,\r\n            'FolderOpen': <Folder size={16} />,\r\n            'GitBranch': <GitBranch size={16} />,\r\n            'Bot': <Bot size={16} />,\r\n            'Play': <Play size={16} />,\r\n            'Bug': <Bug size={16} />,\r\n            'Hammer': <Hammer size={16} />,\r\n            'Sparkles': <Sparkles size={16} />,\r\n            'MoveVertical': <MoveVertical size={16} />,\r\n            'Search': <Search size={16} />,\r\n            'CheckCircle2': <CheckCircle2 size={16} />,\r\n            'ArrowUp': <ArrowUp size={16} />,\r\n            'ArrowDown': <ArrowDown size={16} />,\r\n            'MessageSquare': <MessageSquare size={16} />,\r\n            'Lightbulb': <Lightbulb size={16} />,\r\n            'Wrench': <Wrench size={16} />\r\n        }\r\n\r\n        return iconMap[icon] || <span>{icon}</span>\r\n    }\r\n\r\n    return (\r\n        <Command.Dialog\r\n            open={open}\r\n            onOpenChange={onOpenChange}\r\n            label={mode === 'commands' ? 'Command Palette' : 'Quick Open'}\r\n            className=\"command-palette\"\r\n        >\r\n            <Command.Input\r\n                value={search}\r\n                onValueChange={setSearch}\r\n                placeholder={mode === 'commands' ? 'Type a command...' : 'Search files...'}\r\n                className=\"command-input\"\r\n            />\r\n\r\n            <Command.List className=\"command-list\">\r\n                <Command.Empty className=\"command-empty\">\r\n                    {mode === 'commands' ? 'No commands found.' : 'No files found.'}\r\n                </Command.Empty>\r\n\r\n                {mode === 'files' ? (\r\n                    <Command.Group heading=\"Files\" className=\"command-group\">\r\n                        {filteredFiles.map(file => (\r\n                            <Command.Item\r\n                                key={file.path}\r\n                                value={file.path}\r\n                                onSelect={handleSelect}\r\n                                className=\"command-item\"\r\n                            >\r\n                                <span className=\"item-icon\">{getFileIcon(file.name, file.type)}</span>\r\n                                <span className=\"item-name\">{file.name}</span>\r\n                                <span className=\"item-path\">\r\n                                    {file.path.replace(workspacePath || '', '').replace(/^[/\\\\]/, '')}\r\n                                </span>\r\n                            </Command.Item>\r\n                        ))}\r\n                    </Command.Group>\r\n                ) : (\r\n                    Object.entries(groupedCommands).map(([category, cmds]) => (\r\n                        <Command.Group\r\n                            key={category}\r\n                            heading={category.charAt(0).toUpperCase() + category.slice(1)}\r\n                            className=\"command-group\"\r\n                        >\r\n                            {cmds.map(cmd => (\r\n                                <Command.Item\r\n                                    key={cmd.id}\r\n                                    value={cmd.title}\r\n                                    onSelect={() => {\r\n                                        cmd.action()\r\n                                        onOpenChange(false)\r\n                                    }}\r\n                                    className=\"command-item\"\r\n                                >\r\n                                    <span className=\"item-icon\">{renderIcon(cmd.icon, cmd.category)}</span>\r\n                                    <span className=\"item-name\">{cmd.title}</span>\r\n                                    {cmd.shortcut && (\r\n                                        <span className=\"item-shortcut\">{cmd.shortcut}</span>\r\n                                    )}\r\n                                </Command.Item>\r\n                            ))}\r\n                        </Command.Group>\r\n                    ))\r\n                )}\r\n            </Command.List>\r\n\r\n            <style>{`\r\n        .command-palette {\r\n          position: fixed;\r\n          top: 0;\r\n          left: 0;\r\n          right: 0;\r\n          bottom: 0;\r\n          z-index: 1000;\r\n          display: flex;\r\n          align-items: flex-start;\r\n          justify-content: center;\r\n          padding-top: 20vh;\r\n          background: rgba(0, 0, 0, 0.5);\r\n          backdrop-filter: blur(4px);\r\n        }\r\n\r\n        .command-palette [cmdk-root] {\r\n          width: 560px;\r\n          max-width: 90vw;\r\n          background: var(--color-surface, #1e1e1e);\r\n          border: 1px solid var(--color-border, #3c3c3c);\r\n          border-radius: 12px;\r\n          box-shadow: 0 16px 70px rgba(0, 0, 0, 0.6);\r\n          overflow: hidden;\r\n        }\r\n\r\n        .command-input {\r\n          width: 100%;\r\n          padding: 16px 20px;\r\n          font-size: 16px;\r\n          background: transparent;\r\n          border: none;\r\n          border-bottom: 1px solid var(--color-border, #3c3c3c);\r\n          color: var(--color-text, #e0e0e0);\r\n          outline: none;\r\n        }\r\n\r\n        .command-input::placeholder {\r\n          color: var(--color-text-muted, #666);\r\n        }\r\n\r\n        .command-list {\r\n          max-height: 400px;\r\n          overflow-y: auto;\r\n          padding: 8px;\r\n        }\r\n\r\n        .command-empty {\r\n          padding: 32px;\r\n          text-align: center;\r\n          color: var(--color-text-muted, #666);\r\n          font-size: 14px;\r\n        }\r\n\r\n        .command-group {\r\n          margin-bottom: 8px;\r\n        }\r\n\r\n        .command-group [cmdk-group-heading] {\r\n          padding: 8px 12px 4px;\r\n          font-size: 11px;\r\n          font-weight: 600;\r\n          text-transform: uppercase;\r\n          letter-spacing: 0.5px;\r\n          color: var(--color-text-muted, #666);\r\n        }\r\n\r\n        .command-item {\r\n          display: flex;\r\n          align-items: center;\r\n          gap: 12px;\r\n          padding: 10px 12px;\r\n          border-radius: 6px;\r\n          cursor: pointer;\r\n          color: var(--color-text, #e0e0e0);\r\n          font-size: 14px;\r\n        }\r\n\r\n        .command-item[data-selected=\"true\"],\r\n        .command-item:hover {\r\n          background: var(--color-accent, #0066cc);\r\n          color: white;\r\n        }\r\n\r\n        .command-item[data-selected=\"true\"] .item-path,\r\n        .command-item:hover .item-path {\r\n          color: rgba(255, 255, 255, 0.7);\r\n        }\r\n\r\n        .item-icon {\r\n          font-size: 16px;\r\n          width: 20px;\r\n          text-align: center;\r\n          flex-shrink: 0;\r\n        }\r\n\r\n        .item-name {\r\n          flex: 1;\r\n          overflow: hidden;\r\n          text-overflow: ellipsis;\r\n          white-space: nowrap;\r\n        }\r\n\r\n        .item-path {\r\n          font-size: 12px;\r\n          color: var(--color-text-muted, #666);\r\n          overflow: hidden;\r\n          text-overflow: ellipsis;\r\n          white-space: nowrap;\r\n          max-width: 200px;\r\n        }\r\n\r\n        .item-shortcut {\r\n          font-size: 11px;\r\n          padding: 2px 6px;\r\n          background: rgba(255, 255, 255, 0.1);\r\n          border-radius: 4px;\r\n          font-family: var(--font-mono, monospace);\r\n          color: var(--color-text-muted, #999);\r\n        }\r\n\r\n        .command-item[data-selected=\"true\"] .item-shortcut {\r\n          background: rgba(255, 255, 255, 0.2);\r\n          color: white;\r\n        }\r\n      `}</style>\r\n        </Command.Dialog>\r\n    )\r\n}\r\n\r\n// Export command type for use in other components\r\nexport type { IDECommand, FileItem }\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\ide\\FileExplorer.tsx","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":132,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":132,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[4648,4710],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":148,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":148,"endColumn":34,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[5439,5494],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":195,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":195,"endColumn":30,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[7410,7474],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":384,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":384,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[15043,15094],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":413,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":413,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[16022,16073],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":453,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":453,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[17392,17443],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":581,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":581,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[22276,22325],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":615,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":615,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[23581,23635],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\nimport { useState, useEffect, useCallback } from 'react'\r\nimport {\r\n    Folder, FileText, ChevronRight, ChevronDown,\r\n    FolderPlus, FilePlus,\r\n    FolderOpen, AlertTriangle, X, XCircle,\r\n    Search, RefreshCw, ChevronUp, Trash2, Edit2,\r\n    FileJson, FileCode, FileImage, Code2, Database, Terminal as TerminalIcon, Languages\r\n} from 'lucide-react'\r\nimport './FileExplorer.css'\r\nimport type { FileSystemItem } from '../../vite-env'\r\n\r\ninterface FileNode extends FileSystemItem {\r\n    children?: FileNode[]\r\n    expanded?: boolean\r\n    level: number\r\n}\r\n\r\ninterface OpenFile {\r\n    path: string\r\n    name: string\r\n    isDirty?: boolean\r\n}\r\n\r\ninterface FileExplorerProps {\r\n    workspacePath: string | null\r\n    onOpenFolder: () => void\r\n    onCloseWorkspace?: () => void\r\n    onSelectFile: (filePath: string) => void\r\n    onCloseFile?: (filePath: string) => void\r\n    selectedFile: string | null\r\n    openFiles?: OpenFile[]\r\n    onFileCreate?: (dirPath: string, fileName: string) => void\r\n    onFileDelete?: (filePath: string) => void\r\n    onFileRename?: (oldPath: string, newPath: string) => void\r\n    requestedExpansion?: string | null\r\n    onExpansionComplete?: () => void\r\n}\r\n\r\nexport default function FileExplorer({\r\n    workspacePath,\r\n    onOpenFolder,\r\n    onCloseWorkspace,\r\n    onSelectFile,\r\n    onCloseFile,\r\n    selectedFile,\r\n    openFiles = [],\r\n    onFileCreate,\r\n    onFileDelete,\r\n    onFileRename,\r\n    requestedExpansion,\r\n    onExpansionComplete\r\n}: FileExplorerProps) {\r\n    const [openEditorsExpanded, setOpenEditorsExpanded] = useState(true)\r\n    const [files, setFiles] = useState<FileNode[]>([])\r\n    const [expandedDirs, setExpandedDirs] = useState<Set<string>>(new Set())\r\n    const [loading, setLoading] = useState<boolean>(false)\r\n    const [contextMenu, setContextMenu] = useState<{ x: number; y: number; path: string; isDir: boolean } | null>(null)\r\n    const [newItemInput, setNewItemInput] = useState<{ path: string; type: 'file' | 'folder' } | null>(null)\r\n    const [newItemName, setNewItemName] = useState<string>('')\r\n    const [renameInput, setRenameInput] = useState<{ path: string; name: string } | null>(null)\r\n    const [searchQuery, setSearchQuery] = useState<string>('')\r\n    const [focusedIndex, setFocusedIndex] = useState<number>(-1)\r\n    const [error, setError] = useState<string | null>(null)\r\n    const [dragOverPath, setDragOverPath] = useState<string | null>(null)\r\n\r\n\r\n\r\n    // Load directory contents\r\n    const loadDirectory = useCallback(async (dirPath: string, level: number = 0): Promise<FileNode[]> => {\r\n        const result = await window.electronAPI?.fs.readDir(dirPath)\r\n        if (!result?.success || !result.items) return []\r\n\r\n        const nodes: FileNode[] = result.items\r\n            .sort((a: FileSystemItem, b: FileSystemItem) => {\r\n                // Directories first, then files\r\n                if (a.isDirectory && !b.isDirectory) return -1\r\n                if (!a.isDirectory && b.isDirectory) return 1\r\n                return a.name.localeCompare(b.name)\r\n            })\r\n            .map((item: FileSystemItem) => ({\r\n                ...item,\r\n                level,\r\n                expanded: false,\r\n                children: item.isDirectory ? [] : undefined\r\n            }))\r\n\r\n        return nodes\r\n    }, [])\r\n\r\n    // Handle requested expansion from outside (e.g. Breadcrumbs)\r\n    useEffect(() => {\r\n        if (!requestedExpansion || !workspacePath) return\r\n\r\n        const expandPath = async () => {\r\n            // Get relative path parts\r\n            const relative = requestedExpansion.replace(workspacePath, '').replace(/^[/\\\\]+/, '')\r\n            const parts = relative.split(/[/\\\\]/).filter(Boolean)\r\n\r\n            let currentPath = workspacePath\r\n            const newExpanded = new Set(expandedDirs)\r\n            newExpanded.add(workspacePath)\r\n\r\n            for (const part of parts) {\r\n                currentPath = `${currentPath}/${part}`\r\n                newExpanded.add(currentPath)\r\n            }\r\n\r\n            setExpandedDirs(newExpanded)\r\n            onExpansionComplete?.()\r\n        }\r\n\r\n        expandPath()\r\n    }, [requestedExpansion, workspacePath, onExpansionComplete])\r\n\r\n    // Load root directory\r\n    useEffect(() => {\r\n        if (!workspacePath) {\r\n            setFiles([])\r\n            return\r\n        }\r\n\r\n        setLoading(true)\r\n        loadDirectory(workspacePath).then(nodes => {\r\n            setFiles(nodes)\r\n            setLoading(false)\r\n            // Auto-expand root\r\n            setExpandedDirs(new Set([workspacePath]))\r\n        }).catch(err => {\r\n            console.error('[FileExplorer] Failed to load directory:', err)\r\n            setError('Failed to load directory')\r\n            setLoading(false)\r\n        })\r\n\r\n        // Watch for file changes with unique ID per workspace\r\n        const watchId = `file-explorer-${workspacePath.replace(/[^a-zA-Z0-9]/g, '-')}`\r\n\r\n        // Create specific handler for this workspace\r\n        // Create specific handler for this workspace\r\n        const changeHandler = (event: { id: string; event: string; path: string }) => {\r\n            if (event.id === watchId) {\r\n                // Refresh on changes using functional update to avoid stale state\r\n                loadDirectory(workspacePath).then(nodes => {\r\n                    setFiles(nodes)\r\n                }).catch(err => {\r\n                    console.error('[FileExplorer] Failed to refresh:', err)\r\n                })\r\n            }\r\n        }\r\n\r\n        window.electronAPI?.fs.watchDir({ id: watchId, dirPath: workspacePath })\r\n        // Use the returned unsubscribe function\r\n        const unsubscribe = window.electronAPI?.fs.onChange(changeHandler)\r\n\r\n        return () => {\r\n            window.electronAPI?.fs.unwatchDir(watchId)\r\n            unsubscribe?.()\r\n        }\r\n    }, [workspacePath, loadDirectory])\r\n\r\n    // Toggle directory expansion\r\n    const toggleDir = async (dirPath: string) => {\r\n        const newExpanded = new Set(expandedDirs)\r\n\r\n        if (newExpanded.has(dirPath)) {\r\n            newExpanded.delete(dirPath)\r\n            setExpandedDirs(newExpanded)\r\n        } else {\r\n            newExpanded.add(dirPath)\r\n            setExpandedDirs(newExpanded) // Optimistic update\r\n\r\n            // Load children safely\r\n            try {\r\n                // Recursive helper (synchronous logic wrapper)\r\n                const updateChildren = async (nodes: FileNode[]): Promise<FileNode[]> => {\r\n                    const updatedNodes = await Promise.all(nodes.map(async (node) => {\r\n                        if (node.path === dirPath && node.isDirectory) {\r\n                            const children = await loadDirectory(dirPath, node.level + 1)\r\n                            return { ...node, children, expanded: true }\r\n                        }\r\n                        if (node.children) {\r\n                            return { ...node, children: await updateChildren(node.children) }\r\n                        }\r\n                        return node\r\n                    }))\r\n                    return updatedNodes\r\n                }\r\n\r\n                // Wait for update then set state (simpler than functional update for deep trees)\r\n                const updatedFiles = await updateChildren(files)\r\n                setFiles(updatedFiles)\r\n            } catch (err) {\r\n                console.error('[FileExplorer] Failed to expand directory:', err)\r\n                setError('Failed to load folder contents')\r\n                // Revert expansion on error\r\n                newExpanded.delete(dirPath)\r\n                setExpandedDirs(new Set(newExpanded))\r\n            }\r\n        }\r\n    }\r\n\r\n    const refreshTree = async () => {\r\n        if (!workspacePath) return\r\n        setLoading(true)\r\n        try {\r\n            const nodes = await loadDirectory(workspacePath)\r\n            setFiles(nodes)\r\n            setError(null)\r\n        } catch (_err) {\r\n            setError('Failed to refresh')\r\n        } finally {\r\n            setLoading(false)\r\n        }\r\n    }\r\n\r\n    const collapseAll = () => {\r\n        setExpandedDirs(new Set(workspacePath ? [workspacePath] : []))\r\n    }\r\n\r\n    const copyPath = (path: string) => {\r\n        navigator.clipboard.writeText(path)\r\n        closeContextMenu()\r\n    }\r\n\r\n    const copyRelativePath = (path: string) => {\r\n        if (!workspacePath) return\r\n        const relative = path.replace(workspacePath, '').replace(/^[/\\\\]+/, '')\r\n        navigator.clipboard.writeText(relative)\r\n        closeContextMenu()\r\n    }\r\n\r\n    const revealInExplorer = (path: string) => {\r\n        window.electronAPI?.shell.showItemInFolder?.(path)\r\n        closeContextMenu()\r\n    }\r\n\r\n    // Flattened list for keyboard navigation and filtering\r\n    const getFlattenedFiles = (nodes: FileNode[], result: FileNode[] = []): FileNode[] => {\r\n        nodes.forEach(node => {\r\n            const matchesSearch = !searchQuery || node.name.toLowerCase().includes(searchQuery.toLowerCase())\r\n            if (matchesSearch) {\r\n                result.push(node)\r\n            }\r\n            if (node.children && expandedDirs.has(node.path)) {\r\n                getFlattenedFiles(node.children, result)\r\n            }\r\n        })\r\n        return result\r\n    }\r\n\r\n    const flattenedFiles = getFlattenedFiles(files)\r\n\r\n    // BUG #33: Reset focus when search changes\r\n    useEffect(() => {\r\n        setFocusedIndex(-1)\r\n    }, [searchQuery])\r\n\r\n    // BUG #34: Close context menu on scroll\r\n    useEffect(() => {\r\n        const treeElement = document.querySelector('.file-tree')\r\n        if (!treeElement) return\r\n\r\n        const handleScroll = () => {\r\n            if (contextMenu) setContextMenu(null)\r\n        }\r\n\r\n        treeElement.addEventListener('scroll', handleScroll)\r\n        return () => treeElement.removeEventListener('scroll', handleScroll)\r\n    }, [contextMenu])\r\n\r\n    // Keyboard navigation\r\n    useEffect(() => {\r\n        const handleKeyDown = (e: KeyboardEvent) => {\r\n            if (newItemInput || renameInput) return\r\n\r\n            if (e.key === 'ArrowDown') {\r\n                e.preventDefault()\r\n                setFocusedIndex(prev => Math.min(prev + 1, flattenedFiles.length - 1))\r\n            } else if (e.key === 'ArrowUp') {\r\n                e.preventDefault()\r\n                setFocusedIndex(prev => Math.max(prev - 1, 0))\r\n            } else if (e.key === 'Enter') {\r\n                if (focusedIndex >= 0) {\r\n                    const node = flattenedFiles[focusedIndex]\r\n                    if (node.isDirectory) toggleDir(node.path)\r\n                    else onSelectFile(node.path)\r\n                }\r\n            } else if (e.key === 'f' && (e.ctrlKey || e.metaKey)) {\r\n                e.preventDefault()\r\n                document.getElementById('explorer-search-input')?.focus()\r\n            }\r\n        }\r\n\r\n        window.addEventListener('keydown', handleKeyDown)\r\n        return () => window.removeEventListener('keydown', handleKeyDown)\r\n    }, [flattenedFiles, focusedIndex, newItemInput, renameInput])\r\n\r\n    // Handle context menu\r\n    const handleContextMenu = (e: React.MouseEvent, path: string, isDir: boolean) => {\r\n        e.preventDefault()\r\n        setContextMenu({ x: e.clientX, y: e.clientY, path, isDir })\r\n    }\r\n\r\n    // Close context menu\r\n    const closeContextMenu = () => setContextMenu(null)\r\n\r\n    // Create new file/folder\r\n    const handleCreate = async (type: 'file' | 'folder') => {\r\n        let dirPath: string | null = null\r\n\r\n        if (contextMenu) {\r\n            dirPath = contextMenu.isDir ? contextMenu.path : contextMenu.path.split(/[/\\\\]/).slice(0, -1).join('/')\r\n            closeContextMenu()\r\n        } else if (selectedFile) {\r\n            // If we have a selection, try to determine if it is a dir or file (we might not know easily if it's a dir from just the path string here without stats, but commonly users select files)\r\n            // Ideally we'd know if selectedFile is a dir. The `files` tree has this info, but traversing it to find `selectedFile` is complex.\r\n            // Simplified strategy: assume it's a file and use parent, UNLESS we can easily check.\r\n            // Actually, for header actions, using the root workspace path is often the safest default if no context is clear, OR we just always use workspacePath if nothing is selected.\r\n            // Let's rely on workspacePath if contextMenu is null, or maybe implement a 'selectedDir' state?\r\n            // For now, let's default to workspacePath if contextMenu is null, or the parent of active file if that's better?\r\n            // \"Explorer\" usually implies creation in the *root* if nothing specific is right-clicked, or maybe expected behavior is \"relative to selection\".\r\n            // Let's go with: if context menu, use that. If not, use workspace root. This is standard behavior for \"New File\" buttons in many IDEs unless a specific folder is focused.\r\n            dirPath = workspacePath\r\n        } else {\r\n            dirPath = workspacePath\r\n        }\r\n\r\n        if (!dirPath) return\r\n        setNewItemInput({ path: dirPath, type })\r\n    }\r\n\r\n    const validateFileName = (name: string): boolean => {\r\n        if (!name || name.trim().length === 0) return false\r\n        // OS invalid chars: / \\ : * ? \" < > |\r\n        const invalidChars = /[\\\\/:*?\"<>|]/\r\n        if (invalidChars.test(name)) {\r\n            setError('Filename contains invalid characters')\r\n            return false\r\n        }\r\n        // SECURITY FIX: Prevent path traversal attempts\r\n        if (name === '..' || name === '.' || name.includes('..') || name.includes('/') || name.includes('\\\\')) {\r\n            setError('Invalid filename - path traversal not allowed')\r\n            return false\r\n        }\r\n        return true\r\n    }\r\n\r\n    const submitNewItem = async () => {\r\n        if (!newItemInput || !newItemName.trim()) return\r\n\r\n        // BUG #35: Validate filename\r\n        if (!validateFileName(newItemName)) return\r\n\r\n        const fullPath = `${newItemInput.path}/${newItemName.trim()}`\r\n\r\n        try {\r\n            if (newItemInput.type === 'file') {\r\n                const result = await window.electronAPI?.fs.createFile(fullPath)\r\n                if (!result?.success) {\r\n                    setError(result?.error || 'Failed to create file')\r\n                    return\r\n                }\r\n                onFileCreate?.(newItemInput.path, newItemName.trim())\r\n            } else {\r\n                const result = await window.electronAPI?.fs.createDir(fullPath)\r\n                if (!result?.success) {\r\n                    setError(result?.error || 'Failed to create folder')\r\n                    return\r\n                }\r\n            }\r\n\r\n            setNewItemInput(null)\r\n            setNewItemName('')\r\n            setError(null)\r\n\r\n            // Refresh\r\n            if (workspacePath) {\r\n                const nodes = await loadDirectory(workspacePath)\r\n                setFiles(nodes)\r\n            }\r\n        } catch (err) {\r\n            console.error('[FileExplorer] Create failed:', err)\r\n            setError(err instanceof Error ? err.message : 'Failed to create item')\r\n        }\r\n    }\r\n\r\n    // Delete file/folder\r\n    const handleDelete = async () => {\r\n        if (!contextMenu) return\r\n\r\n        const confirmed = window.confirm(`Delete \"${contextMenu.path.split(/[/\\\\]/).pop()}\"?`)\r\n        if (!confirmed) return\r\n\r\n        try {\r\n            const result = await window.electronAPI?.fs.delete(contextMenu.path)\r\n            if (!result?.success) {\r\n                setError(result?.error || 'Failed to delete')\r\n                closeContextMenu()\r\n                return\r\n            }\r\n            onFileDelete?.(contextMenu.path)\r\n            closeContextMenu()\r\n            setError(null)\r\n\r\n            // Refresh\r\n            if (workspacePath) {\r\n                const nodes = await loadDirectory(workspacePath)\r\n                setFiles(nodes)\r\n            }\r\n        } catch (err) {\r\n            console.error('[FileExplorer] Delete failed:', err)\r\n            setError(err instanceof Error ? err.message : 'Failed to delete')\r\n            closeContextMenu()\r\n        }\r\n    }\r\n\r\n    // Rename file/folder\r\n    const handleRename = () => {\r\n        if (!contextMenu) return\r\n        const name = contextMenu.path.split(/[/\\\\]/).pop() || ''\r\n        setRenameInput({ path: contextMenu.path, name })\r\n        closeContextMenu()\r\n    }\r\n\r\n    const submitRename = async () => {\r\n        if (!renameInput) return\r\n\r\n        // BUG #35: Validate filename\r\n        if (!validateFileName(renameInput.name)) return\r\n\r\n        const dir = renameInput.path.split(/[/\\\\]/).slice(0, -1).join('/')\r\n        const newPath = `${dir}/${renameInput.name}`\r\n\r\n        try {\r\n            const result = await window.electronAPI?.fs.rename({ oldPath: renameInput.path, newPath })\r\n            if (!result?.success) {\r\n                setError(result?.error || 'Failed to rename')\r\n                setRenameInput(null)\r\n                return\r\n            }\r\n            onFileRename?.(renameInput.path, newPath)\r\n            setRenameInput(null)\r\n            setError(null)\r\n\r\n            // Refresh\r\n            if (workspacePath) {\r\n                const nodes = await loadDirectory(workspacePath)\r\n                setFiles(nodes)\r\n            }\r\n        } catch (err) {\r\n            console.error('[FileExplorer] Rename failed:', err)\r\n            setError(err instanceof Error ? err.message : 'Failed to rename')\r\n            setRenameInput(null)\r\n        }\r\n    }\r\n\r\n    // Get icon based on file extension\r\n    const getFileIcon = (fileName: string) => {\r\n        const ext = fileName.split('.').pop()?.toLowerCase() || ''\r\n\r\n        const iconProps = { size: 16 }\r\n\r\n        switch (ext) {\r\n            case 'json':\r\n                return <FileJson {...iconProps} className=\"text-yellow-400\" />\r\n            case 'js':\r\n            case 'cjs':\r\n            case 'mjs':\r\n                return <FileCode {...iconProps} className=\"text-yellow-300\" />\r\n            case 'ts':\r\n                return <FileCode {...iconProps} className=\"text-blue-400\" />\r\n            case 'tsx':\r\n            case 'jsx':\r\n                return <Code2 {...iconProps} className=\"text-cyan-400\" />\r\n            case 'py':\r\n                return <FileCode {...iconProps} className=\"text-blue-500\" />\r\n            case 'rs':\r\n                return <FileCode {...iconProps} className=\"text-orange-600\" />\r\n            case 'go':\r\n                return <FileCode {...iconProps} className=\"text-cyan-500\" />\r\n            case 'java':\r\n                return <FileCode {...iconProps} className=\"text-red-500\" />\r\n            case 'c':\r\n            case 'cpp':\r\n            case 'h':\r\n            case 'hpp':\r\n                return <FileCode {...iconProps} className=\"text-blue-600\" />\r\n            case 'css':\r\n            case 'scss':\r\n            case 'less':\r\n                return <FileCode {...iconProps} className=\"text-blue-300\" />\r\n            case 'html':\r\n                return <Languages {...iconProps} className=\"text-orange-500\" />\r\n            case 'md':\r\n                return <FileText {...iconProps} className=\"text-blue-200\" />\r\n            case 'yaml':\r\n            case 'yml':\r\n                return <FileCode {...iconProps} className=\"text-purple-400\" />\r\n            case 'sql':\r\n                return <Database {...iconProps} className=\"text-pink-400\" />\r\n            case 'sh':\r\n            case 'bash':\r\n            case 'zsh':\r\n                return <TerminalIcon {...iconProps} className=\"text-green-400\" />\r\n            case 'png':\r\n            case 'jpg':\r\n            case 'jpeg':\r\n            case 'gif':\r\n            case 'svg':\r\n            case 'webp':\r\n                return <FileImage {...iconProps} className=\"text-purple-300\" />\r\n            default:\r\n                return <FileText {...iconProps} className=\"text-gray-400\" />\r\n        }\r\n    }\r\n\r\n    // Drag and Drop Handlers\r\n    const handleDragStart = (e: React.DragEvent, node: FileNode) => {\r\n        e.dataTransfer.setData('text/plain', node.path)\r\n        e.dataTransfer.effectAllowed = 'move'\r\n    }\r\n\r\n    const handleDragOver = (e: React.DragEvent, node: FileNode) => {\r\n        e.preventDefault()\r\n        // Only allow dropping on directories\r\n        if (node.isDirectory) {\r\n            setDragOverPath(node.path)\r\n            e.dataTransfer.dropEffect = 'move'\r\n        } else {\r\n            setDragOverPath(null)\r\n            e.dataTransfer.dropEffect = 'none'\r\n        }\r\n    }\r\n\r\n    const handleDragLeave = () => {\r\n        setDragOverPath(null)\r\n    }\r\n\r\n    const handleDrop = async (e: React.DragEvent, targetNode: FileNode) => {\r\n        e.preventDefault()\r\n        setDragOverPath(null)\r\n\r\n        const sourcePath = e.dataTransfer.getData('text/plain')\r\n        if (!sourcePath || !targetNode.isDirectory) return\r\n\r\n        // Prevent dropping on self or direct parent (simplified check)\r\n        // Also prevent dropping if source is same as target\r\n        if (sourcePath === targetNode.path) return\r\n\r\n        // BUG #31: Prevent recursive move (dropping folder into its own subfolder)\r\n        if (targetNode.path.startsWith(sourcePath + '/') || targetNode.path.startsWith(sourcePath + '\\\\')) {\r\n            setError('Cannot move a folder into its own subfolder')\r\n            return\r\n        }\r\n\r\n        const fileName = sourcePath.split(/[/\\\\]/).pop()\r\n        const newPath = `${targetNode.path}/${fileName}`\r\n\r\n        if (sourcePath === newPath) return // Same location\r\n\r\n        // Confirmation dialog\r\n        const confirmed = window.confirm(`Move \"${fileName}\" to \"${targetNode.name}\"?`)\r\n        if (!confirmed) return\r\n\r\n        try {\r\n            const result = await window.electronAPI?.fs.rename({ oldPath: sourcePath, newPath })\r\n            if (!result?.success) {\r\n                setError(result?.error || 'Failed to move file')\r\n                return\r\n            }\r\n            onFileRename?.(sourcePath, newPath)\r\n\r\n            // Refresh Explorer\r\n            if (workspacePath) {\r\n                const nodes = await loadDirectory(workspacePath)\r\n                setFiles(nodes)\r\n            }\r\n        } catch (err) {\r\n            console.error('[FileExplorer] Move failed:', err)\r\n            setError('Failed to move file')\r\n        }\r\n    }\r\n\r\n    // Root Drop Handler\r\n    const handleRootDrop = async (e: React.DragEvent) => {\r\n        e.preventDefault()\r\n        const sourcePath = e.dataTransfer.getData('text/plain')\r\n        if (!sourcePath || !workspacePath) return\r\n\r\n        // If source is already in root, do nothing\r\n        const parentDir = sourcePath.split(/[/\\\\]/).slice(0, -1).join('/')\r\n        // Normalized comparison\r\n        if (parentDir.replace(/\\\\/g, '/') === workspacePath.replace(/\\\\/g, '/')) return\r\n\r\n        const fileName = sourcePath.split(/[/\\\\]/).pop()\r\n        const newPath = `${workspacePath}/${fileName}`\r\n\r\n        const confirmed = window.confirm(`Move \"${fileName}\" to workspace root?`)\r\n        if (!confirmed) return\r\n\r\n        try {\r\n            const result = await window.electronAPI?.fs.rename({ oldPath: sourcePath, newPath })\r\n            if (!result?.success) {\r\n                setError(result?.error || 'Failed to move to root')\r\n                return\r\n            }\r\n            onFileRename?.(sourcePath, newPath)\r\n\r\n            // Refresh Explorer\r\n            const nodes = await loadDirectory(workspacePath)\r\n            setFiles(nodes)\r\n        } catch (err) {\r\n            console.error('[FileExplorer] Root move failed:', err)\r\n            setError('Failed to move file to root')\r\n        }\r\n    }\r\n\r\n    // Render file tree\r\n    const renderNode = (node: FileNode): JSX.Element | null => {\r\n        const isExpanded = expandedDirs.has(node.path)\r\n        const isSelected = selectedFile === node.path\r\n        const isFocused = focusedIndex >= 0 && flattenedFiles[focusedIndex]?.path === node.path\r\n        const isRenaming = renameInput?.path === node.path\r\n\r\n        // Check search filter - if child matches but parent doesn't, parent should still show\r\n        const matchesSearch = !searchQuery || node.name.toLowerCase().includes(searchQuery.toLowerCase())\r\n        const hasMatchingChildren = node.children && node.children.some(child =>\r\n            child.name.toLowerCase().includes(searchQuery.toLowerCase()) ||\r\n            (child.children && child.children.length > 0)\r\n        )\r\n\r\n        if (searchQuery && !matchesSearch && !hasMatchingChildren) return null\r\n\r\n        // BUG-065: Visual indicator for ignored/hidden files\r\n        const isIgnored = node.name.startsWith('.') || ['node_modules', 'dist', 'build', 'out'].includes(node.name)\r\n        const isDragOver = dragOverPath === node.path\r\n\r\n        return (\r\n            <div key={node.path}>\r\n                <div\r\n                    className={`file-item ${isSelected ? 'selected' : ''} ${isFocused ? 'focused' : ''} ${isIgnored ? 'ignored' : ''} ${isDragOver ? 'drag-over' : ''}`}\r\n                    style={{ paddingLeft: 12 + node.level * 16 }}\r\n                    onClick={() => node.isDirectory ? toggleDir(node.path) : onSelectFile(node.path)}\r\n                    onContextMenu={(e) => handleContextMenu(e, node.path, node.isDirectory)}\r\n                    draggable\r\n                    onDragStart={(e) => handleDragStart(e, node)}\r\n                    onDragOver={(e) => handleDragOver(e, node)}\r\n                    onDragLeave={handleDragLeave}\r\n                    onDrop={(e) => handleDrop(e, node)}\r\n                >\r\n                    {node.isDirectory ? (\r\n                        <span className=\"expand-icon\">\r\n                            {isExpanded ? <ChevronDown size={14} /> : <ChevronRight size={14} />}\r\n                        </span>\r\n                    ) : (\r\n                        <span className=\"expand-icon\" style={{ width: '14px' }}></span> // Placeholder\r\n                    )}\r\n                    {node.isDirectory ? (\r\n                        <Folder size={16} className=\"text-blue-400\" />\r\n                    ) : (\r\n                        getFileIcon(node.name)\r\n                    )}\r\n                    {isRenaming ? (\r\n                        <input\r\n                            className=\"rename-input\"\r\n                            value={renameInput.name}\r\n                            onChange={(e) => setRenameInput({ ...renameInput, name: e.target.value })}\r\n                            onBlur={submitRename}\r\n                            onKeyDown={(e) => {\r\n                                if (e.key === 'Enter') submitRename()\r\n                                if (e.key === 'Escape') setRenameInput(null)\r\n                            }}\r\n                            autoFocus\r\n                            onClick={(e) => e.stopPropagation()}\r\n                        />\r\n                    ) : (\r\n                        <span className=\"file-name\">{node.name}</span>\r\n                    )}\r\n                </div>\r\n\r\n                {node.isDirectory && isExpanded && node.children && (\r\n                    <div className=\"children\">\r\n                        {/* Guide line for nested items */}\r\n                        <div className=\"guide-line\" style={{ left: 19 + node.level * 16 }}></div>\r\n                        {node.children.map((child) => renderNode(child))}\r\n                    </div>\r\n                )}\r\n            </div>\r\n        )\r\n    }\r\n\r\n    return (\r\n        <div className=\"file-explorer\" onClick={closeContextMenu}>\r\n            <div className=\"explorer-header\">\r\n                <span className=\"explorer-title\">Explorer</span>\r\n                <div className=\"explorer-actions\">\r\n                    <button onClick={() => handleCreate('file')} title=\"New File\" disabled={!workspacePath}>\r\n                        <FilePlus size={14} />\r\n                    </button>\r\n                    <button onClick={() => handleCreate('folder')} title=\"New Folder\" disabled={!workspacePath}>\r\n                        <FolderPlus size={14} />\r\n                    </button>\r\n                    <button onClick={refreshTree} title=\"Refresh Explorer\" disabled={!workspacePath}>\r\n                        <RefreshCw size={14} />\r\n                    </button>\r\n                    <button onClick={collapseAll} title=\"Collapse All Folders\" disabled={!workspacePath}>\r\n                        <ChevronUp size={14} />\r\n                    </button>\r\n                    <button onClick={onOpenFolder} title=\"Open Folder\">\r\n                        <FolderOpen size={14} />\r\n                    </button>\r\n                    {workspacePath && onCloseWorkspace && (\r\n                        <button onClick={onCloseWorkspace} title=\"Close Workspace\" className=\"close-workspace-btn\">\r\n                            <XCircle size={14} />\r\n                        </button>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {/* Open Editors Section */}\r\n            {openFiles.length > 0 && !searchQuery && (\r\n                <div className=\"open-editors-section\">\r\n                    <div\r\n                        className=\"section-header\"\r\n                        onClick={() => setOpenEditorsExpanded(!openEditorsExpanded)}\r\n                    >\r\n                        <span className=\"expand-icon\">\r\n                            {openEditorsExpanded ? <ChevronDown size={14} /> : <ChevronRight size={14} />}\r\n                        </span>\r\n                        <span className=\"section-title\">Open Editors</span>\r\n                        <span className=\"file-count\">{openFiles.length}</span>\r\n                    </div>\r\n                    {openEditorsExpanded && (\r\n                        <div className=\"open-editors-list\">\r\n                            {openFiles.map(file => (\r\n                                <div\r\n                                    key={file.path}\r\n                                    className={`open-editor-item ${selectedFile === file.path ? 'selected' : ''}`}\r\n                                    onClick={() => onSelectFile(file.path)}\r\n                                >\r\n                                    <FileText size={14} />\r\n                                    <span className=\"file-name\">\r\n                                        {file.isDirty && <span className=\"dirty-dot\">â—</span>}\r\n                                        {file.name}\r\n                                    </span>\r\n                                    {onCloseFile && (\r\n                                        <button\r\n                                            className=\"close-file-btn\"\r\n                                            onClick={(e) => { e.stopPropagation(); onCloseFile(file.path); }}\r\n                                            title=\"Close\"\r\n                                        >\r\n                                            <X size={12} />\r\n                                        </button>\r\n                                    )}\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            )}\r\n\r\n            {!workspacePath ? (\r\n                <div className=\"no-folder\">\r\n                    <p>No folder opened</p>\r\n                    <button className=\"open-folder-btn\" onClick={onOpenFolder}>\r\n                        Open Folder\r\n                    </button>\r\n                </div>\r\n            ) : (\r\n                <>\r\n                    {/* Search Bar */}\r\n                    <div className=\"explorer-search\">\r\n                        <div className=\"search-input-wrapper\">\r\n                            <Search size={12} className=\"text-gray-500 absolute left-2\" />\r\n                            <input\r\n                                style={{ paddingLeft: 24 }}\r\n                                placeholder=\"Filter files (e.g. ts, css)\"\r\n                                value={searchQuery}\r\n                                onChange={(e) => setSearchQuery(e.target.value)}\r\n                            />\r\n                            {searchQuery && (\r\n                                <button className=\"clear-search\" onClick={() => setSearchQuery('')}>\r\n                                    <X size={12} />\r\n                                </button>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n\r\n                    {loading ? (\r\n                        <div className=\"loading\">Loading...</div>\r\n                    ) : (\r\n                        <div\r\n                            className=\"file-tree\"\r\n                            onDragOver={(e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; }}\r\n                            onDrop={handleRootDrop}\r\n                        >\r\n                            {error && (\r\n                                <div className=\"error-banner\" onClick={() => setError(null)}>\r\n                                    <AlertTriangle size={14} className=\"mr-1\" />\r\n                                    <span>{error}</span>\r\n                                </div>\r\n                            )}\r\n                            {files.map((node) => renderNode(node))}\r\n                            {/* Empty space filler to catch drops */}\r\n                            <div style={{ flex: 1, minHeight: '50px' }}></div>\r\n                        </div>\r\n                    )}\r\n                </>\r\n            )}\r\n\r\n            {/* New item input */}\r\n            {newItemInput && (\r\n                <div className=\"new-item-input\" style={{ paddingLeft: 24 }}>\r\n                    <span className=\"mr-1\">\r\n                        {newItemInput.type === 'file' ? <FileText size={14} /> : <Folder size={14} />}\r\n                    </span>\r\n                    <input\r\n                        value={newItemName}\r\n                        onChange={(e) => setNewItemName(e.target.value)}\r\n                        onBlur={submitNewItem}\r\n                        onKeyDown={(e) => {\r\n                            if (e.key === 'Enter') submitNewItem()\r\n                            if (e.key === 'Escape') setNewItemInput(null)\r\n                        }}\r\n                        placeholder={newItemInput.type === 'file' ? 'filename.ts' : 'folder name'}\r\n                        autoFocus\r\n                    />\r\n                </div>\r\n            )}\r\n\r\n            {/* Context menu */}\r\n            {contextMenu && (\r\n                <div\r\n                    className=\"context-menu\"\r\n                    style={{ left: contextMenu.x, top: contextMenu.y }}\r\n                >\r\n                    <button onClick={() => handleCreate('file')}>\r\n                        <span className=\"flex items-center gap-2\"><FilePlus size={12} /> New File</span>\r\n                    </button>\r\n                    <button onClick={() => handleCreate('folder')}>\r\n                        <span className=\"flex items-center gap-2\"><FolderPlus size={12} /> New Folder</span>\r\n                    </button>\r\n                    <div className=\"divider\" />\r\n                    <button onClick={() => copyPath(contextMenu.path)}>\r\n                        <span>Copy Path</span>\r\n                        <span className=\"shortcut\">Shift+Alt+C</span>\r\n                    </button>\r\n                    <button onClick={() => copyRelativePath(contextMenu.path)}>\r\n                        <span>Copy Relative Path</span>\r\n                        <span className=\"shortcut\">Ctrl+K Ctrl+Alt+C</span>\r\n                    </button>\r\n                    <button onClick={() => revealInExplorer(contextMenu.path)}>\r\n                        <span>Reveal in File Explorer</span>\r\n                    </button>\r\n                    <div className=\"divider\" />\r\n                    <button onClick={handleRename}>\r\n                        <span className=\"flex items-center gap-2\"><Edit2 size={12} /> Rename</span>\r\n                        <span className=\"shortcut\">Enter</span>\r\n                    </button>\r\n                    <button className=\"delete\" onClick={handleDelete}>\r\n                        <span className=\"flex items-center gap-2\"><Trash2 size={12} /> Delete</span>\r\n                        <span className=\"shortcut\">Del</span>\r\n                    </button>\r\n                </div>\r\n            )}\r\n        </div>\r\n    )\r\n}\r\n\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\ide\\GitPanel.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":99,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":99,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3826,3829],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3826,3829],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":139,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":139,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[5186,5231],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":154,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":154,"endColumn":30,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[5714,5758],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":175,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":175,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[6365,6412],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":197,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":197,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[7054,7095],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":230,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":230,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[8178,8217],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\nimport { useState, useEffect, useCallback, useRef } from 'react'\r\nimport { GitBranch, RefreshCw, Check, X, FileText, AlertCircle, Folder } from 'lucide-react'\r\nimport { useNotificationStore } from '../../stores/notificationStore'\r\n\r\ninterface GitFile {\r\n    path: string\r\n    status: 'modified' | 'added' | 'deleted' | 'renamed' | 'untracked'\r\n    staged: boolean\r\n}\r\n\r\ninterface GitPanelProps {\r\n    readonly workspacePath: string | null\r\n    readonly isVisible?: boolean  // Only poll when visible to save CPU\r\n}\r\n\r\nexport default function GitPanel({ workspacePath, isVisible = true }: GitPanelProps) {\r\n    const [branch, setBranch] = useState<string>('main')\r\n    const [files, setFiles] = useState<GitFile[]>([])\r\n    const [commitMessage, setCommitMessage] = useState<string>('')\r\n    const [loading, setLoading] = useState<boolean>(false)\r\n    const [error, setError] = useState<string | null>(null)\r\n    const [diff, setDiff] = useState<string | null>(null)\r\n    const [selectedFile, setSelectedFile] = useState<string | null>(null)\r\n    const [isRepo, setIsRepo] = useState<boolean>(false)\r\n    const { addNotification } = useNotificationStore()\r\n    const lastRefreshRef = useRef<number>(0)\r\n\r\n    // Fetch git status\r\n    const fetchStatus = useCallback(async () => {\r\n        if (!workspacePath) return\r\n\r\n        setLoading(true)\r\n        setError(null)\r\n\r\n        try {\r\n            // Get branch info\r\n            const branchResult = await globalThis.window.electronAPI?.git.branch(workspacePath)\r\n            if (branchResult?.success && branchResult.branches) {\r\n                setBranch(branchResult.branches.current)\r\n                setIsRepo(true)\r\n            } else {\r\n                setIsRepo(false)\r\n                setLoading(false)\r\n                return\r\n            }\r\n\r\n            // Get status\r\n            const statusResult = await globalThis.window.electronAPI?.git.status(workspacePath)\r\n            if (statusResult?.success && statusResult.status) {\r\n                const gitFiles: GitFile[] = []\r\n\r\n                // Modified files\r\n                statusResult.status.modified?.forEach((path: string) => {\r\n                    gitFiles.push({ path, status: 'modified', staged: false })\r\n                })\r\n\r\n                // Staged files\r\n                statusResult.status.staged?.forEach((path: string) => {\r\n                    const existing = gitFiles.find(f => f.path === path)\r\n                    if (existing) {\r\n                        existing.staged = true\r\n                    } else {\r\n                        gitFiles.push({ path, status: 'modified', staged: true })\r\n                    }\r\n                })\r\n\r\n                // New files\r\n                statusResult.status.not_added?.forEach((path: string) => {\r\n                    gitFiles.push({ path, status: 'untracked', staged: false })\r\n                })\r\n\r\n                // Created (staged new files)\r\n                statusResult.status.created?.forEach((path: string) => {\r\n                    gitFiles.push({ path, status: 'added', staged: true })\r\n                })\r\n\r\n                // Deleted\r\n                statusResult.status.deleted?.forEach((path: string) => {\r\n                    gitFiles.push({ path, status: 'deleted', staged: false })\r\n                })\r\n\r\n                setFiles(gitFiles)\r\n            }\r\n        } catch (err) {\r\n            addNotification(`Failed to refresh Git: ${err instanceof Error ? err.message : 'Unknown error'}`, 'error')\r\n            setError(String(err))\r\n        }\r\n\r\n        setLoading(false)\r\n    }, [workspacePath, addNotification])\r\n\r\n    // Watch for file changes to trigger git refresh\r\n    useEffect(() => {\r\n        if (!workspacePath || !isVisible) return\r\n\r\n        let timeout: any\r\n        const debouncedRefresh = () => {\r\n            clearTimeout(timeout)\r\n            timeout = setTimeout(() => {\r\n                const now = Date.now()\r\n                if (now - lastRefreshRef.current > 1000) { // Throttle to 1s\r\n                    fetchStatus()\r\n                    lastRefreshRef.current = now\r\n                }\r\n            }, 500)\r\n        }\r\n\r\n        // Initial fetch\r\n        fetchStatus()\r\n\r\n        // Watch .git changes if possible, or just the workspace\r\n        const watchId = `git-panel-${workspacePath.replace(/[^a-zA-Z0-9]/g, '-')}`\r\n        window.electronAPI?.fs.watchDir({ id: watchId, dirPath: workspacePath })\r\n\r\n        const unsubscribe = window.electronAPI?.fs.onChange((event: { id: string }) => {\r\n            if (event.id === watchId) {\r\n                debouncedRefresh()\r\n            }\r\n        })\r\n\r\n        return () => {\r\n            clearTimeout(timeout)\r\n            unsubscribe?.()\r\n            window.electronAPI?.fs.unwatchDir(watchId)\r\n        }\r\n    }, [workspacePath, isVisible, fetchStatus])\r\n\r\n    // Stage file\r\n    const stageFile = async (path: string) => {\r\n        if (!workspacePath) return\r\n\r\n        try {\r\n            await globalThis.window.electronAPI?.git.add({ repoPath: workspacePath, files: [path] })\r\n            await fetchStatus()\r\n        } catch (err) {\r\n            console.error('[Git] Stage file error:', err)\r\n            setError('Failed to stage file')\r\n        }\r\n    }\r\n\r\n    // Stage all files\r\n    const stageAll = async () => {\r\n        if (!workspacePath) return\r\n\r\n        const unstaged = files.filter(f => !f.staged).map(f => f.path)\r\n        if (unstaged.length > 0) {\r\n            try {\r\n                await globalThis.window.electronAPI?.git.add({ repoPath: workspacePath, files: unstaged })\r\n                await fetchStatus()\r\n            } catch (err) {\r\n                console.error('[Git] Stage all error:', err)\r\n                setError('Failed to stage all files')\r\n            }\r\n        }\r\n    }\r\n\r\n    // Unstage file (reset)\r\n    const unstageFile = async (path: string) => {\r\n        if (!workspacePath) return\r\n\r\n        try {\r\n            const result = await globalThis.window.electronAPI?.git.reset({\r\n                repoPath: workspacePath,\r\n                files: [path]\r\n            })\r\n            if (result?.success) {\r\n                await fetchStatus()\r\n            } else {\r\n                setError(result?.error || 'Failed to unstage file')\r\n            }\r\n        } catch (err) {\r\n            console.error('[Git] Unstage file error:', err)\r\n            setError('Failed to unstage file')\r\n        }\r\n    }\r\n\r\n    // Commit staged changes\r\n    const commit = async () => {\r\n        if (!workspacePath || !commitMessage.trim()) return\r\n\r\n        try {\r\n            const result = await globalThis.window.electronAPI?.git.commit({\r\n                repoPath: workspacePath,\r\n                message: commitMessage.trim()\r\n            })\r\n\r\n            if (result?.success) {\r\n                setCommitMessage('')\r\n                await fetchStatus()\r\n            } else {\r\n                setError(result?.error || 'Commit failed')\r\n            }\r\n        } catch (err) {\r\n            console.error('[Git] Commit error:', err)\r\n            setError('Failed to commit changes')\r\n        }\r\n    }\r\n\r\n    // View diff for a file\r\n    const viewDiff = async (path: string) => {\r\n        if (!workspacePath) return\r\n\r\n        try {\r\n            setSelectedFile(path)\r\n\r\n            const binaryExts = [\r\n                '.png', '.jpg', '.jpeg', '.gif', '.ico', '.pdf', '.zip', '.tar', '.gz',\r\n                '.mp3', '.mp4', '.woff', '.woff2', '.ttf', '.exe', '.dll', '.so', '.dylib',\r\n                '.bin', '.pyc', '.wasm', '.o', '.a', '.lib'\r\n            ]\r\n            if (binaryExts.some(ext => path.toLowerCase().endsWith(ext))) {\r\n                setDiff('BINARY_FILE')\r\n                return\r\n            }\r\n\r\n            const result = await globalThis.window.electronAPI?.git.diff({\r\n                repoPath: workspacePath,\r\n                file: path\r\n            })\r\n\r\n            if (result?.success) {\r\n                setDiff(result.diff || 'No changes')\r\n            } else {\r\n                setError(result?.error || 'Failed to load diff')\r\n            }\r\n        } catch (err) {\r\n            console.error('[Git] Diff error:', err)\r\n            setError('Failed to load diff')\r\n        }\r\n    }\r\n\r\n    // Get status icon\r\n    const getStatusIcon = (status: GitFile['status']) => {\r\n        switch (status) {\r\n            case 'modified': return 'M'\r\n            case 'added': return 'A'\r\n            case 'deleted': return 'D'\r\n            case 'renamed': return 'R'\r\n            case 'untracked': return 'U'\r\n        }\r\n    }\r\n\r\n    // Get status color\r\n    const getStatusColor = (status: GitFile['status']) => {\r\n        switch (status) {\r\n            case 'modified': return '#d29922'\r\n            case 'added': return '#3fb950'\r\n            case 'deleted': return '#f85149'\r\n            case 'renamed': return '#a371f7'\r\n            case 'untracked': return '#8b949e'\r\n        }\r\n    }\r\n\r\n    const stagedFiles = files.filter(f => f.staged)\r\n    const unstagedFiles = files.filter(f => !f.staged)\r\n\r\n    if (!workspacePath) {\r\n        return (\r\n            <div className=\"git-panel empty\">\r\n                <p>Open a folder to view Git status</p>\r\n                <style>{gitPanelStyles}</style>\r\n            </div>\r\n        )\r\n    }\r\n\r\n    if (!isRepo) {\r\n        return (\r\n            <div className=\"git-panel empty\">\r\n                <p style={{ display: 'flex', alignItems: 'center', gap: '8px', justifyContent: 'center' }}>\r\n                    <Folder size={16} /> Not a Git repository\r\n                </p>\r\n                <p className=\"hint\">Initialize a repository to track changes</p>\r\n                <style>{gitPanelStyles}</style>\r\n            </div>\r\n        )\r\n    }\r\n\r\n    return (\r\n        <div className=\"git-panel\">\r\n            {/* Header */}\r\n            <div className=\"git-header\">\r\n                <GitBranch size={16} className=\"text-accent\" />\r\n                <span className=\"branch-name\">{branch}</span>\r\n                <button className=\"refresh-btn\" onClick={fetchStatus} title=\"Refresh Status\">\r\n                    <RefreshCw size={14} className={loading ? 'animate-spin' : ''} />\r\n                </button>\r\n            </div>\r\n\r\n            {error && (\r\n                <div className=\"git-error\">{error}</div>\r\n            )}\r\n\r\n            {loading && files.length === 0 ? (\r\n                <div className=\"loading\">Loading...</div>\r\n            ) : (\r\n                <>\r\n                    {/* Staged Changes */}\r\n                    <div className=\"git-section\">\r\n                        <div className=\"section-header\">\r\n                            <span>Staged Changes ({stagedFiles.length})</span>\r\n                            {stagedFiles.length > 0 && (\r\n                                <button className=\"section-action\" title=\"Unstage all\">âˆ’</button>\r\n                            )}\r\n                        </div>\r\n                        {stagedFiles.length === 0 ? (\r\n                            <div className=\"empty-section\">No staged changes</div>\r\n                        ) : (\r\n                            <div className=\"file-list\">\r\n                                {stagedFiles.map(file => (\r\n                                    <button\r\n                                        key={file.path}\r\n                                        className=\"file-item\"\r\n                                        onClick={() => viewDiff(file.path)}\r\n                                        aria-label={`View changes for ${file.path}`}\r\n                                    >\r\n                                        <span\r\n                                            className=\"status-badge\"\r\n                                            style={{ color: getStatusColor(file.status) }}\r\n                                        >\r\n                                            {getStatusIcon(file.status)}\r\n                                        </span>\r\n                                        <span className=\"file-path\">{file.path}</span>\r\n                                        <button\r\n                                            type=\"button\"\r\n                                            className=\"file-action\"\r\n                                            onClick={(e) => { e.stopPropagation(); unstageFile(file.path) }}\r\n                                            title=\"Unstage\"\r\n                                        >\r\n                                            âˆ’\r\n                                        </button>\r\n                                    </button>\r\n                                ))}\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n\r\n                    {/* Changes */}\r\n                    <div className=\"git-section\">\r\n                        <div className=\"section-header\">\r\n                            <span>Changes ({unstagedFiles.length})</span>\r\n                            {unstagedFiles.length > 0 && (\r\n                                <button\r\n                                    type=\"button\"\r\n                                    className=\"section-action\"\r\n                                    onClick={stageAll}\r\n                                    title=\"Stage all\"\r\n                                >\r\n                                    +\r\n                                </button>\r\n                            )}\r\n                        </div>\r\n                        {unstagedFiles.length === 0 ? (\r\n                            <div className=\"empty-section\">No changes</div>\r\n                        ) : (\r\n                            <div className=\"file-list\">\r\n                                {unstagedFiles.map(file => (\r\n                                    <button\r\n                                        key={file.path}\r\n                                        className=\"file-item\"\r\n                                        onClick={() => viewDiff(file.path)}\r\n                                        aria-label={`View changes for ${file.path}`}\r\n                                    >\r\n                                        <span\r\n                                            className=\"status-badge\"\r\n                                            style={{ color: getStatusColor(file.status) }}\r\n                                        >\r\n                                            {getStatusIcon(file.status)}\r\n                                        </span>\r\n                                        <span className=\"file-path\">{file.path}</span>\r\n                                        <button\r\n                                            type=\"button\"\r\n                                            className=\"file-action\"\r\n                                            onClick={(e) => { e.stopPropagation(); stageFile(file.path) }}\r\n                                            title=\"Stage\"\r\n                                        >\r\n                                            +\r\n                                        </button>\r\n                                    </button>\r\n                                ))}\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n\r\n                    {/* Commit Box */}\r\n                    {stagedFiles.length > 0 && (\r\n                        <div className=\"commit-box\">\r\n                            <textarea\r\n                                placeholder=\"Commit message...\"\r\n                                value={commitMessage}\r\n                                onChange={(e) => setCommitMessage(e.target.value)}\r\n                                rows={3}\r\n                            />\r\n                            <button\r\n                                type=\"button\"\r\n                                className=\"commit-btn\"\r\n                                onClick={commit}\r\n                                disabled={!commitMessage.trim()}\r\n                            >\r\n                                <Check size={14} className=\"mr-1\" />\r\n                                Commit ({stagedFiles.length})\r\n                            </button>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* Diff View */}\r\n                    {diff && selectedFile && (\r\n                        <div className=\"diff-panel\">\r\n                            <div className=\"diff-header\">\r\n                                <FileText size={14} className=\"mr-1\" />\r\n                                <span className=\"file-path-title\">{selectedFile}</span>\r\n                                <button type=\"button\" className=\"close-diff\" onClick={() => { setDiff(null); setSelectedFile(null) }}>\r\n                                    <X size={16} />\r\n                                </button>\r\n                            </div>\r\n                            <div className=\"diff-body\">\r\n                                {diff === 'BINARY_FILE' ? (\r\n                                    <div className=\"binary-notice\">\r\n                                        <AlertCircle size={32} />\r\n                                        <p>Binary file changes detected</p>\r\n                                        <p className=\"sub\">Diff preview is not available for this file type.</p>\r\n                                    </div>\r\n                                ) : (\r\n                                    <pre className=\"diff-content\">{diff}</pre>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </>\r\n            )}\r\n\r\n            <style>{gitPanelStyles}</style>\r\n        </div>\r\n    )\r\n}\r\n\r\nconst gitPanelStyles = `\r\n    .git-panel {\r\n        display: flex;\r\n        flex-direction: column;\r\n        height: 100%;\r\n        background: var(--color-surface);\r\n        font-size: 13px;\r\n    }\r\n\r\n    .git-panel.empty {\r\n        align-items: center;\r\n        justify-content: center;\r\n        color: var(--color-text-muted);\r\n        text-align: center;\r\n        padding: 24px;\r\n    }\r\n\r\n    .git-panel.empty .hint {\r\n        font-size: 11px;\r\n        margin-top: 4px;\r\n    }\r\n\r\n    .git-header {\r\n        display: flex;\r\n        align-items: center;\r\n        gap: 8px;\r\n        padding: 12px;\r\n        border-bottom: 1px solid var(--color-border-subtle);\r\n    }\r\n\r\n    .branch-icon {\r\n        font-size: 14px;\r\n    }\r\n\r\n    .branch-name {\r\n        font-weight: 600;\r\n        color: var(--color-text);\r\n    }\r\n\r\n    .refresh-btn {\r\n        margin-left: auto;\r\n        width: 24px;\r\n        height: 24px;\r\n        display: flex;\r\n        align-items: center;\r\n        justify-content: center;\r\n        font-size: 12px;\r\n        background: transparent;\r\n        border: none;\r\n        border-radius: 4px;\r\n        cursor: pointer;\r\n        color: var(--color-text-secondary);\r\n    }\r\n\r\n    .refresh-btn:hover {\r\n        background: var(--color-surface-elevated);\r\n    }\r\n\r\n    .git-error {\r\n        padding: 8px 12px;\r\n        background: rgba(248, 81, 73, 0.1);\r\n        color: #f85149;\r\n        font-size: 12px;\r\n    }\r\n\r\n    .loading {\r\n        padding: 24px;\r\n        text-align: center;\r\n        color: var(--color-text-muted);\r\n    }\r\n\r\n    .git-section {\r\n        border-bottom: 1px solid var(--color-border-subtle);\r\n    }\r\n\r\n    .section-header {\r\n        display: flex;\r\n        align-items: center;\r\n        justify-content: space-between;\r\n        padding: 8px 12px;\r\n        font-size: 11px;\r\n        font-weight: 600;\r\n        color: var(--color-text-secondary);\r\n        text-transform: uppercase;\r\n        letter-spacing: 0.05em;\r\n        background: var(--color-bg);\r\n    }\r\n\r\n    .section-action {\r\n        width: 20px;\r\n        height: 20px;\r\n        display: flex;\r\n        align-items: center;\r\n        justify-content: center;\r\n        font-size: 16px;\r\n        font-weight: bold;\r\n        background: transparent;\r\n        border: none;\r\n        border-radius: 4px;\r\n        cursor: pointer;\r\n        color: var(--color-text-secondary);\r\n    }\r\n\r\n    .section-action:hover {\r\n        background: var(--color-surface-elevated);\r\n        color: var(--color-text);\r\n    }\r\n\r\n    .empty-section {\r\n        padding: 12px;\r\n        color: var(--color-text-muted);\r\n        font-size: 12px;\r\n        font-style: italic;\r\n    }\r\n\r\n    .file-list {\r\n        max-height: 200px;\r\n        overflow-y: auto;\r\n    }\r\n\r\n    .file-item {\r\n        display: flex;\r\n        align-items: center;\r\n        width: 100%;\r\n        border: none;\r\n        background: transparent;\r\n        color: inherit;\r\n        text-align: left;\r\n        gap: 8px;\r\n        padding: 6px 12px;\r\n        cursor: pointer;\r\n    }\r\n\r\n    .file-item:hover {\r\n        background: var(--color-surface-elevated);\r\n    }\r\n\r\n    .status-badge {\r\n        font-size: 11px;\r\n        font-weight: bold;\r\n        font-family: monospace;\r\n        min-width: 14px;\r\n    }\r\n\r\n    .file-path {\r\n        flex: 1;\r\n        overflow: hidden;\r\n        text-overflow: ellipsis;\r\n        white-space: nowrap;\r\n        color: var(--color-text-secondary);\r\n    }\r\n\r\n    .file-action {\r\n        width: 18px;\r\n        height: 18px;\r\n        display: flex;\r\n        align-items: center;\r\n        justify-content: center;\r\n        font-size: 14px;\r\n        font-weight: bold;\r\n        background: transparent;\r\n        border: none;\r\n        border-radius: 4px;\r\n        cursor: pointer;\r\n        color: var(--color-text-muted);\r\n        opacity: 0;\r\n    }\r\n\r\n    .file-item:hover .file-action {\r\n        opacity: 1;\r\n    }\r\n\r\n    .file-action:hover {\r\n        background: var(--color-accent);\r\n        color: white;\r\n    }\r\n\r\n    .commit-box {\r\n        padding: 12px;\r\n        border-top: 1px solid var(--color-border-subtle);\r\n    }\r\n\r\n    .commit-box textarea {\r\n        width: 100%;\r\n        padding: 8px;\r\n        background: var(--color-bg);\r\n        border: 1px solid var(--color-border-subtle);\r\n        border-radius: 6px;\r\n        color: var(--color-text);\r\n        font-size: 13px;\r\n        font-family: inherit;\r\n        resize: none;\r\n        outline: none;\r\n    }\r\n\r\n    .commit-box textarea:focus {\r\n        border-color: var(--color-accent);\r\n    }\r\n\r\n    .commit-btn {\r\n        width: 100%;\r\n        margin-top: 8px;\r\n        padding: 8px 16px;\r\n        background: #238636;\r\n        color: white;\r\n        border: none;\r\n        border-radius: 6px;\r\n        font-size: 13px;\r\n        font-weight: 500;\r\n        cursor: pointer;\r\n    }\r\n\r\n    .commit-btn:hover {\r\n        background: #2ea043;\r\n    }\r\n\r\n    .commit-btn:disabled {\r\n        opacity: 0.5;\r\n        cursor: not-allowed;\r\n    }\r\n\r\n    .diff-panel {\r\n        flex: 1;\r\n        display: flex;\r\n        flex-direction: column;\r\n        border-top: 1px solid var(--color-border-subtle);\r\n        min-height: 200px;\r\n    }\r\n\r\n    .diff-header {\r\n        display: flex;\r\n        align-items: center;\r\n        justify-content: space-between;\r\n        padding: 8px 12px;\r\n        background: var(--color-bg);\r\n        font-size: 12px;\r\n        color: var(--color-text-secondary);\r\n    }\r\n\r\n    .diff-header button {\r\n        background: transparent;\r\n        border: none;\r\n        color: var(--color-text-muted);\r\n        cursor: pointer;\r\n        font-size: 16px;\r\n    }\r\n\r\n    .diff-content {\r\n        flex: 1;\r\n        overflow-x: auto;\r\n        padding: 12px;\r\n        margin: 0;\r\n        font-family: 'SF Mono', 'Fira Code', monospace;\r\n        font-size: 11px;\r\n        line-height: 1.5;\r\n        color: var(--color-text-secondary);\r\n        white-space: pre;\r\n    }\r\n\r\n    .binary-notice {\r\n        flex: 1;\r\n        display: flex;\r\n        flex-direction: column;\r\n        align-items: center;\r\n        justify-content: center;\r\n        padding: 40px 20px;\r\n        color: var(--color-text-muted);\r\n        text-align: center;\r\n        gap: 12px;\r\n    }\r\n\r\n    .binary-notice p {\r\n        font-weight: 500;\r\n        margin: 0;\r\n    }\r\n\r\n    .binary-notice .sub {\r\n        font-size: 11px;\r\n        opacity: 0.7;\r\n    }\r\n\r\n    .close-diff {\r\n        padding: 4px;\r\n        border-radius: 4px;\r\n        color: var(--color-text-muted);\r\n    }\r\n    \r\n    .close-diff:hover {\r\n        background: var(--color-surface-elevated);\r\n        color: var(--color-text);\r\n    }\r\n\r\n    .animate-spin {\r\n        animation: spin 1s linear infinite;\r\n    }\r\n\r\n    @keyframes spin {\r\n        from { transform: rotate(0deg); }\r\n        to { transform: rotate(360deg); }\r\n    }\r\n`\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\ide\\IDEActivityBar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\ide\\IDEBottomTerminal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\ide\\IDEPanelContainer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\ide\\IDETabList.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\ide\\IDEToolbar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\ide\\IDEWorkspace.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":30,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":30,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1098,1101],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1098,1101],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":31,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":31,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1119,1122],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1119,1122],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":32,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":32,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1151,1154],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1151,1154],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":36,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":36,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1338,1341],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1338,1341],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":133,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":133,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5202,5205],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5202,5205],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":135,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":135,"endColumn":33,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[5271,5332],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":140,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":140,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5489,5492],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5489,5492],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":142,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":142,"endColumn":33,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[5558,5629],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":220,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":220,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8716,8719],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8716,8719],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":351,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":351,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13638,13641],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13638,13641],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":353,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":353,"endColumn":29,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[13699,13759],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":378,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":378,"endColumn":34,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[14739,14795],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":480,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":480,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18730,18733],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18730,18733],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":482,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":482,"endColumn":29,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[18791,18841],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":489,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":489,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19045,19048],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19045,19048],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":490,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":490,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19087,19090],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19087,19090],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":524,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":524,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20448,20451],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20448,20451],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":557,"column":25,"nodeType":"MemberExpression","messageId":"unexpected","endLine":557,"endColumn":38,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[21888,21952],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":657,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":657,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[25740,25831],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":667,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":667,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[26258,26322],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":684,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":684,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[27083,27142],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":694,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":694,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[27399,27448],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-irregular-whitespace","severity":2,"message":"Irregular whitespace not allowed.","line":711,"column":38,"nodeType":"Program","messageId":"noIrregularWhitespace","endLine":711,"endColumn":39},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":775,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":775,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[30867,30870],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[30867,30870],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-irregular-whitespace","severity":2,"message":"Irregular whitespace not allowed.","line":787,"column":42,"nodeType":"Program","messageId":"noIrregularWhitespace","endLine":787,"endColumn":43},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":792,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":792,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[31588,31591],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[31588,31591],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":803,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":803,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[32007,32010],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[32007,32010],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":813,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":813,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[32388,32391],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[32388,32391],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":823,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":823,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[32770,32773],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[32770,32773],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":833,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":833,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[33150,33153],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[33150,33153],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":843,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":843,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[33525,33528],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[33525,33528],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-irregular-whitespace","severity":2,"message":"Irregular whitespace not allowed.","line":866,"column":42,"nodeType":"Program","messageId":"noIrregularWhitespace","endLine":866,"endColumn":43},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":872,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":872,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[34606,34609],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[34606,34609],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":888,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":888,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[35286,35289],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[35286,35289],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-irregular-whitespace","severity":2,"message":"Irregular whitespace not allowed.","line":900,"column":42,"nodeType":"Program","messageId":"noIrregularWhitespace","endLine":900,"endColumn":43},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":905,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":905,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[35955,35958],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[35955,35958],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":950,"column":25,"nodeType":"MemberExpression","messageId":"unexpected","endLine":950,"endColumn":38,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[38394,38438],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":983,"column":87,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":983,"endColumn":90,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[40114,40117],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[40114,40117],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":34,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\nimport { useState, useEffect, useRef, useMemo, useCallback } from 'react'\r\nimport Editor from '@monaco-editor/react'\r\nimport UnifiedAgentPanel from '../UnifiedAgentPanel'\r\n\r\nimport InlineEditWidget from './InlineEditWidget'\r\nimport Breadcrumbs from './Breadcrumbs'\r\nimport CommandPalette, { FileItem, IDECommand } from './CommandPalette'\r\nimport { createDefaultCommands } from '../../services/ideCommands'\r\nimport type { FileSystemItem } from '../../vite-env'\r\nimport {\r\n    FolderOpen, Wand2\r\n} from 'lucide-react'\r\nimport { useNotificationStore } from '../../stores/notificationStore'\r\nimport { logger } from '../../utils/logger'\r\nimport { validatePath } from '../../utils/path-validator'\r\n\r\n// Modular Components\r\nimport { IDEActivityBar } from './IDEActivityBar'\r\nimport { IDETabList } from './IDETabList'\r\nimport { IDEPanelContainer } from './IDEPanelContainer'\r\nimport { IDEToolbar } from './IDEToolbar'\r\nimport { IDEBottomTerminal } from './IDEBottomTerminal'\r\n\r\nimport './IDEWorkspace.css'\r\n\r\ninterface ICodeEditor {\r\n    getSelection(): any\r\n    getModel(): any\r\n    getAction(id: string): any\r\n    revealLineInCenter(lineNumber: number): void\r\n    setPosition(position: { lineNumber: number; column: number }): void\r\n    focus(): void\r\n    executeEdits(source: string, edits: any[]): boolean\r\n}\r\n\r\ninterface OpenFile {\r\n    path: string\r\n    name: string\r\n    content: string\r\n    language: string\r\n    isDirty: boolean\r\n}\r\n\r\n\r\n\r\n// Storage keys for persistence\r\nconst STORAGE_KEYS = {\r\n    WORKSPACE_PATH: 'kalynt-workspace-path',\r\n    OPEN_FILES: 'kalynt-open-files',\r\n    ACTIVE_FILE: 'kalynt-active-file',\r\n    SIDEBAR_OPEN: 'kalynt-sidebar-open',\r\n    TERMINAL_VISIBLE: 'kalynt-terminal-visible',\r\n    TERMINAL_HEIGHT: 'kalynt-terminal-height',\r\n    SIDEBAR_WIDTH: 'kalynt-sidebar-width',\r\n    WORD_WRAP: 'kalynt-word-wrap',\r\n    MINIMAP_ENABLED: 'kalynt-minimap-enabled',\r\n    STICKY_SCROLL_ENABLED: 'kalynt-sticky-scroll-enabled',\r\n    SPLIT_EDITOR_ENABLED: 'kalynt-split-editor-enabled',\r\n    SPLIT_EDITOR_RATIO: 'kalynt-split-editor-ratio',\r\n    SECONDARY_ACTIVE_FILE: 'kalynt-secondary-active-file'\r\n}\r\n\r\nexport default function IDEWorkspace() {\r\n    // Workspace state with persistence\r\n    const [workspacePath, setWorkspacePath] = useState<string | null>(() => {\r\n        try {\r\n            return localStorage.getItem(STORAGE_KEYS.WORKSPACE_PATH)\r\n        } catch (error) {\r\n            logger.ide.warn('Failed to load workspace path from localStorage', error)\r\n            return null\r\n        }\r\n    })\r\n    const [openFiles, setOpenFiles] = useState<OpenFile[]>([])\r\n    const [activeFile, setActiveFile] = useState<string | null>(null)\r\n    const [pendingLine, setPendingLine] = useState<number | null>(null)\r\n    const { addNotification } = useNotificationStore()\r\n    const [showTerminal, setShowTerminal] = useState(() => {\r\n        try {\r\n            const saved = localStorage.getItem(STORAGE_KEYS.TERMINAL_VISIBLE)\r\n            return saved !== null ? saved === 'true' : true\r\n        } catch (error) {\r\n            logger.ide.warn('Failed to load terminal visibility from localStorage', error)\r\n            return true\r\n        }\r\n    })\r\n    const [terminalHeight, setTerminalHeight] = useState(() => {\r\n        try {\r\n            const saved = localStorage.getItem(STORAGE_KEYS.TERMINAL_HEIGHT)\r\n            return saved ? parseInt(saved, 10) : 200\r\n        } catch (error) {\r\n            logger.ide.warn('Failed to load terminal height from localStorage', error)\r\n            return 200\r\n        }\r\n    })\r\n    const [sidebarOpen, setSidebarOpen] = useState(() => {\r\n        try {\r\n            const saved = localStorage.getItem(STORAGE_KEYS.SIDEBAR_OPEN)\r\n            return saved !== null ? saved === 'true' : true\r\n        } catch (error) {\r\n            logger.ide.warn('Failed to load sidebar state from localStorage', error)\r\n            return true\r\n        }\r\n    })\r\n    const [sidebarWidth, setSidebarWidth] = useState(() => {\r\n        try {\r\n            // Clear any corrupted value and always start fresh\r\n            localStorage.removeItem(STORAGE_KEYS.SIDEBAR_WIDTH)\r\n            return 260\r\n        } catch (error) {\r\n            logger.ide.warn('Failed to load sidebar width from localStorage', error)\r\n            return 260\r\n        }\r\n    })\r\n    const [isResizingSidebar, setIsResizingSidebar] = useState(false)\r\n    const [isRunning, setIsRunning] = useState(false)\r\n    const executionIdRef = useRef<string | null>(null)\r\n    // SECURITY FIX: Store cleanup functions to prevent event listener leaks\r\n    const codeListenersCleanupRef = useRef<(() => void)[]>([])\r\n    const [codeOutput, setCodeOutput] = useState<string>('') // For code execution output display\r\n    const [isDebugging, setIsDebugging] = useState(false)\r\n    const debugSessionIdRef = useRef<string | null>(null)\r\n    const [isBuilding, setIsBuilding] = useState(false)\r\n    const buildTaskIdRef = useRef<string | null>(null)\r\n\r\n    // BUG #22: Dispose editors on unmount\r\n    useEffect(() => {\r\n        return () => {\r\n            if (editorRef.current) {\r\n                try {\r\n                    (editorRef.current as any).dispose?.()\r\n                } catch (e) {\r\n                    console.warn('[IDE] Failed to dispose editor on unmount:', e)\r\n                }\r\n            }\r\n            if (secondaryEditorRef.current) {\r\n                try {\r\n                    (secondaryEditorRef.current as any).dispose?.()\r\n                } catch (e) {\r\n                    console.warn('[IDE] Failed to dispose secondary editor on unmount:', e)\r\n                }\r\n            }\r\n        }\r\n    }, [])\r\n\r\n    const [activePanel, setActivePanel] = useState<'files' | 'search' | 'git' | 'collaboration'>('files')\r\n    const [requestedExpansion, setRequestedExpansion] = useState<string | null>(null)\r\n\r\n    // Split Editor state\r\n    const [splitEditorEnabled, setSplitEditorEnabled] = useState(() => {\r\n        try {\r\n            const saved = localStorage.getItem(STORAGE_KEYS.SPLIT_EDITOR_ENABLED)\r\n            return saved === 'true'\r\n        } catch (_error) {\r\n            return false\r\n        }\r\n    })\r\n    const [secondaryActiveFile, setSecondaryActiveFile] = useState<string | null>(() => {\r\n        try {\r\n            return localStorage.getItem(STORAGE_KEYS.SECONDARY_ACTIVE_FILE)\r\n        } catch (_error) {\r\n            return null\r\n        }\r\n    })\r\n    const [editorSplitRatio, setEditorSplitRatio] = useState(() => {\r\n        try {\r\n            const saved = localStorage.getItem(STORAGE_KEYS.SPLIT_EDITOR_RATIO)\r\n            return saved ? parseFloat(saved) : 0.5\r\n        } catch (_error) {\r\n            return 0.5\r\n        }\r\n    })\r\n    const [isResizingSplit, setIsResizingSplit] = useState(false)\r\n\r\n    // AI Agent state\r\n    const [agentOpen, setAgentOpen] = useState(true)\r\n\r\n    // Command Palette state\r\n    const [paletteOpen, setPaletteOpen] = useState(false)\r\n    const [paletteMode, setPaletteMode] = useState<'commands' | 'files'>('commands')\r\n    const [unsavedDialog, setUnsavedDialog] = useState<{ isOpen: boolean, filePath: string | null }>({ isOpen: false, filePath: null })\r\n    const [deletedFileDialog, setDeletedFileDialog] = useState<{ isOpen: boolean, filePath: string | null }>({ isOpen: false, filePath: null })\r\n    const [workspaceFiles, setWorkspaceFiles] = useState<FileItem[]>([])\r\n\r\n    // Inline AI Edit state\r\n    const [inlineEditVisible, setInlineEditVisible] = useState(false)\r\n    const [inlineEditSelection] = useState('')\r\n    const [inlineEditPosition] = useState({ top: 100, left: 100 })\r\n\r\n    // Editor Settings state\r\n    const [wordWrap, setWordWrap] = useState<'on' | 'off'>(() => {\r\n        try {\r\n            const saved = localStorage.getItem(STORAGE_KEYS.WORD_WRAP)\r\n            return saved === 'on' || saved === 'off' ? saved : 'on'\r\n        } catch (_error) {\r\n            return 'on'\r\n        }\r\n    })\r\n    const [minimapEnabled, setMinimapEnabled] = useState(() => {\r\n        try {\r\n            const saved = localStorage.getItem(STORAGE_KEYS.MINIMAP_ENABLED)\r\n            return saved !== null ? saved === 'true' : true\r\n        } catch (_error) {\r\n            return true\r\n        }\r\n    })\r\n    const [stickyScrollEnabled, setStickyScrollEnabled] = useState(() => {\r\n        try {\r\n            const saved = localStorage.getItem(STORAGE_KEYS.STICKY_SCROLL_ENABLED)\r\n            return saved !== null ? saved === 'true' : true\r\n        } catch (_error) {\r\n            return true\r\n        }\r\n    })\r\n\r\n    const editorRef = useRef<ICodeEditor | null>(null)\r\n    const secondaryEditorRef = useRef<ICodeEditor | null>(null)\r\n    const monacoRef = useRef<any>(null)\r\n\r\n    // Breakpoints state: Map of file path -> array of line numbers\r\n    const [breakpoints, setBreakpoints] = useState<Map<string, number[]>>(new Map())\r\n    const breakpointDecorationsRef = useRef<string[]>([])\r\n\r\n    // Get active file object\r\n    const activeFileObj = openFiles.find(f => f.path === activeFile)\r\n    const secondaryFileObj = openFiles.find(f => f.path === secondaryActiveFile)\r\n\r\n    // Run command in terminal\r\n    const onRunCommand = useCallback((command: string) => {\r\n        setShowTerminal(true)\r\n        globalThis.window.electronAPI?.terminal.write({ id: 'term-1', data: command + '\\r' })\r\n    }, [])\r\n\r\n    // Persist workspace path\r\n    useEffect(() => {\r\n        try {\r\n            if (workspacePath) {\r\n                localStorage.setItem(STORAGE_KEYS.WORKSPACE_PATH, workspacePath)\r\n            } else {\r\n                localStorage.removeItem(STORAGE_KEYS.WORKSPACE_PATH)\r\n            }\r\n        } catch (error) {\r\n            logger.ide.warn('Failed to persist workspace path to localStorage', error)\r\n        }\r\n    }, [workspacePath])\r\n\r\n    // Persist editor settings\r\n    useEffect(() => {\r\n        try {\r\n            localStorage.setItem(STORAGE_KEYS.WORD_WRAP, wordWrap)\r\n        } catch (error) {\r\n            logger.ide.warn('Failed to persist word wrap state', error)\r\n        }\r\n    }, [wordWrap])\r\n\r\n    useEffect(() => {\r\n        try {\r\n            localStorage.setItem(STORAGE_KEYS.MINIMAP_ENABLED, String(minimapEnabled))\r\n        } catch (error) {\r\n            logger.ide.warn('Failed to persist minimap state', error)\r\n        }\r\n    }, [minimapEnabled])\r\n\r\n    useEffect(() => {\r\n        try {\r\n            localStorage.setItem(STORAGE_KEYS.STICKY_SCROLL_ENABLED, String(stickyScrollEnabled))\r\n        } catch (error) {\r\n            logger.ide.warn('Failed to persist sticky scroll state', error)\r\n        }\r\n    }, [stickyScrollEnabled])\r\n\r\n    useEffect(() => {\r\n        try {\r\n            localStorage.setItem(STORAGE_KEYS.SPLIT_EDITOR_ENABLED, String(splitEditorEnabled))\r\n        } catch (error) {\r\n            logger.ide.warn('Failed to persist split editor state', error)\r\n        }\r\n    }, [splitEditorEnabled])\r\n\r\n    useEffect(() => {\r\n        try {\r\n            localStorage.setItem(STORAGE_KEYS.SPLIT_EDITOR_RATIO, String(editorSplitRatio))\r\n        } catch (error) {\r\n            logger.ide.warn('Failed to persist split ratio', error)\r\n        }\r\n    }, [editorSplitRatio])\r\n\r\n    useEffect(() => {\r\n        try {\r\n            if (secondaryActiveFile) {\r\n                localStorage.setItem(STORAGE_KEYS.SECONDARY_ACTIVE_FILE, secondaryActiveFile)\r\n            } else {\r\n                localStorage.removeItem(STORAGE_KEYS.SECONDARY_ACTIVE_FILE)\r\n            }\r\n        } catch (error) {\r\n            logger.ide.warn('Failed to persist secondary active file', error)\r\n        }\r\n    }, [secondaryActiveFile])\r\n\r\n    const handleClearCache = useCallback(async () => {\r\n        await globalThis.window.electronAPI?.code.clearCache()\r\n        addNotification('Execution cache cleared', 'success')\r\n    }, [addNotification])\r\n\r\n    const handleReloadWindow = () => {\r\n        window.location.reload()\r\n    }\r\n\r\n    const handleOpenCommandPalette = useCallback(() => {\r\n        setPaletteOpen(true)\r\n        setPaletteMode('commands')\r\n    }, [])\r\n\r\n\r\n    const handleAboutKalynt = useCallback(() => {\r\n        addNotification('Kalynt IDE v1.0 beta - AI-Powered Development Environment', 'info')\r\n    }, [addNotification])\r\n\r\n    const handleToggleSplitEditor = useCallback(() => {\r\n        if (!splitEditorEnabled && openFiles.length < 2) {\r\n            addNotification('Open at least 2 files to use split editor', 'warning')\r\n            return\r\n        }\r\n\r\n        const newSplitState = !splitEditorEnabled\r\n        setSplitEditorEnabled(newSplitState)\r\n\r\n        // If enabling split and no secondary file is set, use the next file\r\n        if (newSplitState && !secondaryActiveFile && openFiles.length >= 2) {\r\n            const currentIndex = openFiles.findIndex(f => f.path === activeFile)\r\n            const nextFile = openFiles[(currentIndex + 1) % openFiles.length]\r\n            setSecondaryActiveFile(nextFile.path)\r\n        }\r\n\r\n        // If disabling, keep secondary file for next time\r\n    }, [splitEditorEnabled, openFiles, activeFile, secondaryActiveFile, addNotification])\r\n\r\n    const handleSecondaryEditorChange = useCallback((value: string | undefined) => {\r\n        if (!value || !secondaryActiveFile) return\r\n        setOpenFiles(prev => prev.map(f =>\r\n            f.path === secondaryActiveFile ? { ...f, content: value, isDirty: true } : f\r\n        ))\r\n    }, [secondaryActiveFile])\r\n\r\n    const handleSecondaryEditorDidMount = (editor: ICodeEditor) => {\r\n        // BUG #22: Dispose old secondary editor\r\n        if (secondaryEditorRef.current) {\r\n            try {\r\n                (secondaryEditorRef.current as any).dispose?.()\r\n            } catch (e) {\r\n                console.warn('[IDE] Failed to dispose secondary editor:', e)\r\n            }\r\n        }\r\n        secondaryEditorRef.current = editor\r\n    }\r\n\r\n    // Persist UI state\r\n    useEffect(() => {\r\n        try {\r\n            localStorage.setItem(STORAGE_KEYS.SIDEBAR_OPEN, String(sidebarOpen))\r\n            localStorage.setItem(STORAGE_KEYS.TERMINAL_VISIBLE, String(showTerminal))\r\n            localStorage.setItem(STORAGE_KEYS.TERMINAL_HEIGHT, String(terminalHeight))\r\n            localStorage.setItem(STORAGE_KEYS.SIDEBAR_WIDTH, String(sidebarWidth))\r\n        } catch (error) {\r\n            logger.ide.warn('Failed to persist UI state to localStorage', error)\r\n        }\r\n    }, [sidebarOpen, showTerminal, terminalHeight, sidebarWidth])\r\n\r\n    // Restore workspace on mount\r\n    useEffect(() => {\r\n        const restoreWorkspace = async () => {\r\n            if (workspacePath) {\r\n                try {\r\n                    await globalThis.window.electronAPI?.fs.setWorkspace(workspacePath)\r\n                } catch (err) {\r\n                    console.error('[IDE] Failed to restore workspace:', err)\r\n                    setWorkspacePath(null)\r\n                }\r\n            }\r\n        }\r\n        restoreWorkspace()\r\n    }, [])\r\n\r\n    // Close workspace handler\r\n    const handleCloseWorkspace = useCallback(() => {\r\n        // Close all open files first\r\n        const hasUnsaved = openFiles.some(f => f.isDirty)\r\n        if (hasUnsaved) {\r\n            const confirmed = globalThis.window.confirm('You have unsaved changes. Close workspace anyway?')\r\n            if (!confirmed) return\r\n        }\r\n\r\n        setWorkspacePath(null)\r\n        setOpenFiles([])\r\n        setActiveFile(null)\r\n        addNotification('Workspace closed', 'info')\r\n    }, [openFiles, addNotification])\r\n\r\n\r\n    // Open folder dialog\r\n    const handleOpenFolder = async () => {\r\n        const result = await globalThis.window.electronAPI?.fs.openFolder()\r\n        if (result?.success && result.path) {\r\n            setWorkspacePath(result.path)\r\n            await globalThis.window.electronAPI?.fs.setWorkspace(result.path)\r\n            setOpenFiles([])\r\n            setActiveFile(null)\r\n        }\r\n    }\r\n\r\n    // Open file in editor\r\n    const handleOpenFile = async (filePath: string, line?: number) => {\r\n        // SECURITY FIX: Validate path to prevent traversal attacks\r\n        const validation = validatePath(filePath, workspacePath)\r\n        if (!validation.valid) {\r\n            addNotification(validation.error || 'Invalid file path', 'error')\r\n            logger.ide.warn('Path validation failed for file open', { filePath, error: validation.error })\r\n            return\r\n        }\r\n\r\n        const validatedPath = validation.normalizedPath!\r\n\r\n        if (line) setPendingLine(line)\r\n        const existing = openFiles.find(f => f.path === validatedPath)\r\n        if (existing) {\r\n            setActiveFile(validatedPath)\r\n            return\r\n        }\r\n\r\n        const result = await globalThis.window.electronAPI?.fs.readFile(validatedPath)\r\n        if (!result?.success) {\r\n            try {\r\n                const dirResult = await globalThis.window.electronAPI?.fs.readDir(validatedPath)\r\n                if (dirResult?.success) {\r\n                    setActivePanel('files')\r\n                    setRequestedExpansion(validatedPath)\r\n                    return\r\n                }\r\n            } catch (error) {\r\n                logger.ide.debug('Path is not a directory, treating as file error', { filePath: validatedPath, error })\r\n            }\r\n\r\n            addNotification(`Failed to read file: ${result?.error || 'Unknown error'}`, 'error')\r\n            return\r\n        }\r\n\r\n        const fileName = validatedPath.split(/[/\\\\]/).pop() || 'untitled'\r\n        const language = getLanguageFromFileName(fileName)\r\n\r\n        const newFile: OpenFile = {\r\n            path: validatedPath,\r\n            name: fileName,\r\n            content: result.content || '',\r\n            language,\r\n            isDirty: false\r\n        }\r\n\r\n        setOpenFiles([...openFiles, newFile])\r\n        setActiveFile(validatedPath)\r\n    }\r\n\r\n    const getLanguageFromFileName = (fileName: string): string => {\r\n        const ext = fileName.split('.').pop()?.toLowerCase()\r\n        const langMap: Record<string, string> = {\r\n            'ts': 'typescript', 'tsx': 'typescript', 'js': 'javascript', 'jsx': 'javascript',\r\n            'json': 'json', 'md': 'markdown', 'css': 'css', 'scss': 'scss', 'html': 'html',\r\n            'py': 'python', 'rs': 'rust', 'go': 'go', 'java': 'java', 'c': 'c', 'cpp': 'cpp',\r\n            'h': 'c', 'hpp': 'cpp', 'yaml': 'yaml', 'yml': 'yaml', 'xml': 'xml', 'sql': 'sql',\r\n            'sh': 'shell', 'bash': 'shell', 'ps1': 'powershell'\r\n        }\r\n        return langMap[ext || ''] || 'plaintext'\r\n    }\r\n\r\n    const handleEditorDidMount = (editor: unknown, monaco: unknown) => {\r\n        // BUG #22: Dispose old editor before replacing\r\n        if (editorRef.current) {\r\n            try {\r\n                (editorRef.current as any).dispose?.()\r\n            } catch (e) {\r\n                console.warn('[IDE] Failed to dispose editor:', e)\r\n            }\r\n        }\r\n        editorRef.current = editor as ICodeEditor\r\n        monacoRef.current = monaco\r\n\r\n        // Add breakpoint gutter click handler\r\n        const monacoEditor = editor as any\r\n        monacoEditor.onMouseDown((e: any) => {\r\n            // Check if click is on the gutter (line number margin)\r\n            if (e.target.type === 2 || e.target.type === 3) { // GUTTER_GLYPH_MARGIN or GUTTER_LINE_NUMBERS\r\n                const lineNumber = e.target.position?.lineNumber\r\n                if (lineNumber && activeFile) {\r\n                    toggleBreakpoint(activeFile, lineNumber)\r\n                }\r\n            }\r\n        })\r\n    }\r\n\r\n    // Toggle breakpoint at a specific line\r\n    const toggleBreakpoint = useCallback((filePath: string, lineNumber: number) => {\r\n        setBreakpoints(prev => {\r\n            const newMap = new Map(prev)\r\n            const fileBreakpoints = newMap.get(filePath) || []\r\n\r\n            if (fileBreakpoints.includes(lineNumber)) {\r\n                // Remove breakpoint\r\n                newMap.set(filePath, fileBreakpoints.filter(l => l !== lineNumber))\r\n            } else {\r\n                // Add breakpoint\r\n                newMap.set(filePath, [...fileBreakpoints, lineNumber].sort((a, b) => a - b))\r\n            }\r\n\r\n            return newMap\r\n        })\r\n    }, [])\r\n\r\n    // Update breakpoint decorations when breakpoints or active file changes\r\n    useEffect(() => {\r\n        if (!editorRef.current || !monacoRef.current || !activeFile) return\r\n\r\n        const monaco = monacoRef.current\r\n        const editor = editorRef.current as any\r\n        const fileBreakpoints = breakpoints.get(activeFile) || []\r\n\r\n        // Clear old decorations\r\n        breakpointDecorationsRef.current = editor.deltaDecorations(\r\n            breakpointDecorationsRef.current,\r\n            fileBreakpoints.map((lineNumber: number) => ({\r\n                range: new monaco.Range(lineNumber, 1, lineNumber, 1),\r\n                options: {\r\n                    isWholeLine: true,\r\n                    glyphMarginClassName: 'breakpoint-glyph',\r\n                    glyphMarginHoverMessage: { value: 'Breakpoint' },\r\n                    linesDecorationsClassName: 'breakpoint-line-decoration',\r\n                }\r\n            }))\r\n        )\r\n    }, [breakpoints, activeFile])\r\n\r\n    // Sync breakpoints to debug session when debugging\r\n    useEffect(() => {\r\n        if (!isDebugging || !debugSessionIdRef.current) return\r\n\r\n        // Send all breakpoints to the debug session\r\n        const syncBreakpoints = async () => {\r\n            for (const [filePath, lines] of breakpoints.entries()) {\r\n                if (lines.length > 0) {\r\n                    try {\r\n                        await window.electronAPI?.debug.setBreakpoints(\r\n                            debugSessionIdRef.current!,\r\n                            filePath,\r\n                            lines.map(line => ({ line, verified: false }))\r\n                        )\r\n                    } catch (error) {\r\n                        console.error('Failed to sync breakpoints for', filePath, error)\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        syncBreakpoints()\r\n    }, [isDebugging, breakpoints])\r\n\r\n    const handleEditorChange = (value: string | undefined) => {\r\n        if (!activeFile || value === undefined) return\r\n        setOpenFiles(openFiles.map(f =>\r\n            f.path === activeFile ? { ...f, content: value, isDirty: true } : f\r\n        ))\r\n    }\r\n\r\n    const handleSaveFile = useCallback(async () => {\r\n        if (!activeFile || !activeFileObj) return\r\n\r\n        // SECURITY FIX: Validate path to prevent traversal attacks\r\n        const validation = validatePath(activeFile, workspacePath)\r\n        if (!validation.valid) {\r\n            addNotification(validation.error || 'Invalid file path', 'error')\r\n            logger.ide.warn('Path validation failed for file save', { filePath: activeFile, error: validation.error })\r\n            return\r\n        }\r\n\r\n        const validatedPath = validation.normalizedPath!\r\n\r\n        const exists = await globalThis.window.electronAPI?.fileExists(validatedPath)\r\n        if (!exists) {\r\n            setDeletedFileDialog({ isOpen: true, filePath: validatedPath })\r\n            return\r\n        }\r\n\r\n        const result = await globalThis.window.electronAPI?.fs.writeFile({\r\n            path: validatedPath,\r\n            content: activeFileObj.content\r\n        })\r\n\r\n        if (result?.success) {\r\n            setOpenFiles(prev => prev.map(f =>\r\n                f.path === activeFile ? { ...f, isDirty: false } : f\r\n            ))\r\n        }\r\n    }, [activeFile, activeFileObj, workspacePath, addNotification])\r\n\r\n    const forceCloseFile = useCallback((filePath: string) => {\r\n        setOpenFiles(prev => {\r\n            const remaining = prev.filter(f => f.path !== filePath)\r\n            if (activeFile === filePath) {\r\n                setActiveFile(remaining.length > 0 ? remaining[remaining.length - 1].path : null)\r\n            }\r\n            return remaining\r\n        })\r\n    }, [activeFile])\r\n\r\n    const handleCloseFile = useCallback((filePath: string, e?: React.MouseEvent) => {\r\n        e?.stopPropagation()\r\n        const file = openFiles.find(f => f.path === filePath)\r\n        if (file?.isDirty) {\r\n            setUnsavedDialog({ isOpen: true, filePath })\r\n            return\r\n        }\r\n        forceCloseFile(filePath)\r\n    }, [openFiles, forceCloseFile])\r\n\r\n    const handleRunCode = useCallback(async () => {\r\n        if (!activeFileObj) return\r\n        const lang = activeFileObj.language\r\n\r\n        // All languages supported by the code execution backend\r\n        const supportedLanguages = [\r\n            'javascript', 'typescript', 'python', 'node', 'deno', 'bun',\r\n            'rust', 'go', 'java', 'dotnet', 'csharp', 'fsharp', 'ruby', 'php',\r\n            'c', 'cpp', 'gcc', 'kotlin', 'swift', 'scala', 'perl', 'lua',\r\n            'haskell', 'elixir', 'r', 'julia', 'dart', 'zig', 'clojure',\r\n            'groovy', 'ocaml', 'erlang', 'v', 'nim', 'html'\r\n        ]\r\n\r\n        if (!supportedLanguages.includes(lang)) {\r\n            addNotification(`Running ${lang} is not supported.`, 'warning')\r\n            return\r\n        }\r\n\r\n        await handleSaveFile()\r\n        const execId = `exec-${Date.now()}`\r\n        executionIdRef.current = execId\r\n        setIsRunning(true)\r\n        setCodeOutput(`â–¶ Running ${activeFileObj.name}...\\n`)\r\n\r\n        // Show terminal for output\r\n        setShowTerminal(true)\r\n\r\n        // SECURITY FIX: Cleanup previous listeners before registering new ones\r\n        codeListenersCleanupRef.current.forEach(cleanup => cleanup())\r\n        codeListenersCleanupRef.current = []\r\n\r\n        // Listen for code output and accumulate in state\r\n        const outputHandler = (data: { id: string; type: string; data: string }) => {\r\n            console.log('[CodeExec] Output received:', data.id, data.type, data.data?.substring(0, 50))\r\n            if (data.id === execId && data.data) {\r\n                setCodeOutput(prev => prev + data.data)\r\n            }\r\n        }\r\n        const removeOutput = window.electronAPI?.code.onOutput(outputHandler)\r\n        if (removeOutput) codeListenersCleanupRef.current.push(removeOutput)\r\n\r\n        // Listen for execution completion\r\n        const exitHandler = (data: { id: string; exitCode: number }) => {\r\n            console.log('[CodeExec] Exit received:', data.id, data.exitCode)\r\n            if (data.id === execId) {\r\n                setIsRunning(false)\r\n                executionIdRef.current = null\r\n                const exitMsg = data.exitCode === 0\r\n                    ? `\\nâœ“ Process exited with code ${data.exitCode}`\r\n                    : `\\nâœ— Process exited with code ${data.exitCode}`\r\n                setCodeOutput(prev => prev + exitMsg)\r\n\r\n                // Cleanup listeners after execution completes\r\n                codeListenersCleanupRef.current.forEach(cleanup => cleanup())\r\n                codeListenersCleanupRef.current = []\r\n            }\r\n        }\r\n        const removeExit = window.electronAPI?.code.onExit(exitHandler)\r\n        if (removeExit) codeListenersCleanupRef.current.push(removeExit)\r\n\r\n        console.log('[CodeExec] Starting execution:', execId, lang)\r\n\r\n        // Execute code\r\n        const result = await window.electronAPI?.code.execute({\r\n            id: execId,\r\n            code: activeFileObj.content,\r\n            language: lang,\r\n            cwd: workspacePath || undefined\r\n        })\r\n\r\n        console.log('[CodeExec] Execute result:', result)\r\n\r\n        if (!result?.success) {\r\n            setCodeOutput(prev => prev + `\\nâœ— Execution failed: ${result?.error || 'Unknown error'}`)\r\n            setIsRunning(false)\r\n            executionIdRef.current = null\r\n            // Cleanup on error\r\n            codeListenersCleanupRef.current.forEach(cleanup => cleanup())\r\n            codeListenersCleanupRef.current = []\r\n        }\r\n    }, [activeFileObj, handleSaveFile, workspacePath, addNotification])\r\n\r\n    const handleStopCode = () => {\r\n        if (executionIdRef.current) {\r\n            window.electronAPI?.code.kill(executionIdRef.current)\r\n            globalThis.window.electronAPI?.terminal.writeOutput({\r\n                id: 'term-1',\r\n                data: `\\r\\n\\x1b[33mâš  Execution stopped by user\\x1b[0m\\r\\n`\r\n            })\r\n            setIsRunning(false)\r\n            executionIdRef.current = null\r\n        }\r\n    }\r\n\r\n    const handleDebugCode = useCallback(async () => {\r\n        if (!activeFileObj || !workspacePath || !activeFile) return\r\n\r\n        // Save file first\r\n        await handleSaveFile()\r\n\r\n        // Show terminal\r\n        if (!showTerminal) {\r\n            setShowTerminal(true)\r\n        }\r\n\r\n        try {\r\n            // Get debug configurations\r\n            const configsResult = await window.electronAPI?.debug.getConfigurations(workspacePath)\r\n\r\n            if (!configsResult?.success || !configsResult.configurations || configsResult.configurations.length === 0) {\r\n                addNotification('No debug configurations found. Creating auto-detected configuration...', 'info')\r\n\r\n                // Use auto-detected configuration\r\n                const autoConfig = {\r\n                    type: 'node' as const,\r\n                    request: 'launch' as const,\r\n                    name: 'Auto Debug',\r\n                    program: activeFile,\r\n                    skipFiles: ['<node_internals>/**'],\r\n                }\r\n\r\n                const result = await window.electronAPI?.debug.start(autoConfig, workspacePath, activeFile)\r\n\r\n                if (result?.success && result.sessionId) {\r\n                    debugSessionIdRef.current = result.sessionId\r\n                    setIsDebugging(true)\r\n\r\n                    globalThis.window.electronAPI?.terminal.writeOutput({\r\n                        id: 'term-1',\r\n                        data: `\\r\\n\\x1b[1m\\x1b[36mâ–¶ Starting debug session...\\x1b[0m\\r\\n`\r\n                    })\r\n                } else {\r\n                    addNotification(result?.error || 'Failed to start debug session', 'error')\r\n                }\r\n            } else {\r\n                // Use first available configuration\r\n                const config = configsResult.configurations[0]\r\n                const result = await window.electronAPI?.debug.start(config, workspacePath, activeFile)\r\n\r\n                if (result?.success && result.sessionId) {\r\n                    debugSessionIdRef.current = result.sessionId\r\n                    setIsDebugging(true)\r\n\r\n                    globalThis.window.electronAPI?.terminal.writeOutput({\r\n                        id: 'term-1',\r\n                        data: `\\r\\n\\x1b[1m\\x1b[36mâ–¶ Starting debug session: ${config.name}\\x1b[0m\\r\\n`\r\n                    })\r\n                } else {\r\n                    addNotification(result?.error || 'Failed to start debug session', 'error')\r\n                }\r\n            }\r\n        } catch (error: any) {\r\n            addNotification(`Debug error: ${error.message}`, 'error')\r\n        }\r\n    }, [activeFileObj, activeFile, handleSaveFile, workspacePath, showTerminal, addNotification])\r\n\r\n    const handleStopDebug = useCallback(async () => {\r\n        if (debugSessionIdRef.current) {\r\n            try {\r\n                await window.electronAPI?.debug.stop(debugSessionIdRef.current)\r\n\r\n                globalThis.window.electronAPI?.terminal.writeOutput({\r\n                    id: 'term-1',\r\n                    data: `\\r\\n\\x1b[33mâš  Debug session stopped by user\\x1b[0m\\r\\n`\r\n                })\r\n\r\n                setIsDebugging(false)\r\n                debugSessionIdRef.current = null\r\n            } catch (error: any) {\r\n                addNotification(`Failed to stop debug session: ${error.message}`, 'error')\r\n            }\r\n        }\r\n    }, [addNotification])\r\n\r\n    // Debug control handlers\r\n    const handleDebugContinue = useCallback(async () => {\r\n        if (debugSessionIdRef.current) {\r\n            try {\r\n                await window.electronAPI?.debug.continue(debugSessionIdRef.current)\r\n            } catch (error: any) {\r\n                addNotification(`Debug continue failed: ${error.message}`, 'error')\r\n            }\r\n        }\r\n    }, [addNotification])\r\n\r\n    const handleDebugStepOver = useCallback(async () => {\r\n        if (debugSessionIdRef.current) {\r\n            try {\r\n                await window.electronAPI?.debug.stepOver(debugSessionIdRef.current)\r\n            } catch (error: any) {\r\n                addNotification(`Debug step over failed: ${error.message}`, 'error')\r\n            }\r\n        }\r\n    }, [addNotification])\r\n\r\n    const handleDebugStepInto = useCallback(async () => {\r\n        if (debugSessionIdRef.current) {\r\n            try {\r\n                await window.electronAPI?.debug.stepInto(debugSessionIdRef.current)\r\n            } catch (error: any) {\r\n                addNotification(`Debug step into failed: ${error.message}`, 'error')\r\n            }\r\n        }\r\n    }, [addNotification])\r\n\r\n    const handleDebugStepOut = useCallback(async () => {\r\n        if (debugSessionIdRef.current) {\r\n            try {\r\n                await window.electronAPI?.debug.stepOut(debugSessionIdRef.current)\r\n            } catch (error: any) {\r\n                addNotification(`Debug step out failed: ${error.message}`, 'error')\r\n            }\r\n        }\r\n    }, [addNotification])\r\n\r\n    const handleDebugPause = useCallback(async () => {\r\n        if (debugSessionIdRef.current) {\r\n            try {\r\n                await window.electronAPI?.debug.pause(debugSessionIdRef.current)\r\n            } catch (error: any) {\r\n                addNotification(`Debug pause failed: ${error.message}`, 'error')\r\n            }\r\n        }\r\n    }, [addNotification])\r\n\r\n    const handleBuildCode = useCallback(async () => {\r\n        if (!workspacePath) return\r\n\r\n        // Show terminal\r\n        if (!showTerminal) {\r\n            setShowTerminal(true)\r\n        }\r\n\r\n        try {\r\n            // Get available tasks\r\n            const tasksResult = await window.electronAPI?.build.getTasks(workspacePath)\r\n\r\n            if (!tasksResult?.success || !tasksResult.tasks || tasksResult.tasks.length === 0) {\r\n                addNotification('No build tasks found. Make sure you have a tasks.json file or package.json', 'warning')\r\n\r\n                globalThis.window.electronAPI?.terminal.writeOutput({\r\n                    id: 'term-1',\r\n                    data: `\\r\\n\\x1b[33mâš  No build tasks found in workspace\\x1b[0m\\r\\n`\r\n                })\r\n                return\r\n            }\r\n\r\n            // Find default build task or use first task\r\n            const buildTask = tasksResult.tasks.find((task: any) => {\r\n                const group = task.group\r\n                if (typeof group === 'object' && group.kind === 'build' && group.isDefault) {\r\n                    return true\r\n                }\r\n                return group === 'build'\r\n            }) || tasksResult.tasks[0]\r\n\r\n            const result = await window.electronAPI?.build.executeTask(buildTask, workspacePath)\r\n\r\n            if (result?.success && result.taskId) {\r\n                buildTaskIdRef.current = result.taskId\r\n                setIsBuilding(true)\r\n            } else {\r\n                addNotification(result?.error || 'Failed to start build task', 'error')\r\n            }\r\n        } catch (error: any) {\r\n            addNotification(`Build error: ${error.message}`, 'error')\r\n        }\r\n    }, [workspacePath, showTerminal, addNotification])\r\n\r\n    const handleStopBuild = useCallback(async () => {\r\n        if (buildTaskIdRef.current) {\r\n            try {\r\n                await window.electronAPI?.build.killTask(buildTaskIdRef.current)\r\n\r\n                globalThis.window.electronAPI?.terminal.writeOutput({\r\n                    id: 'term-1',\r\n                    data: `\\r\\n\\x1b[33mâš  Build task stopped by user\\x1b[0m\\r\\n`\r\n                })\r\n\r\n                setIsBuilding(false)\r\n                buildTaskIdRef.current = null\r\n            } catch (error: any) {\r\n                addNotification(`Failed to stop build task: ${error.message}`, 'error')\r\n            }\r\n        }\r\n    }, [addNotification])\r\n\r\n    const indexFiles = useCallback(async () => {\r\n        if (!workspacePath) { setWorkspaceFiles([]); return }\r\n        try {\r\n            // Workspace path is already validated when set, but double-check\r\n            const workspaceValidation = validatePath(workspacePath, workspacePath)\r\n            if (!workspaceValidation.valid) {\r\n                logger.ide.warn('Invalid workspace path in indexFiles', { workspacePath })\r\n                return\r\n            }\r\n\r\n            const result = await window.electronAPI?.fs.readDir(workspacePath)\r\n            if (result?.success && result.items) {\r\n                const files: FileItem[] = []\r\n                const processEntries = async (items: FileSystemItem[], basePath: string) => {\r\n                    for (const item of items) {\r\n                        if (['node_modules', '.git', 'dist', 'build', '.next'].includes(item.name)) continue\r\n                        const fullPath = `${basePath}${basePath.endsWith('/') || basePath.endsWith('\\\\') ? '' : '/'}${item.name}`\r\n\r\n                        // SECURITY FIX: Validate each constructed path\r\n                        const pathValidation = validatePath(fullPath, workspacePath)\r\n                        if (!pathValidation.valid) {\r\n                            logger.ide.debug('Skipping invalid path during indexing', { fullPath })\r\n                            continue\r\n                        }\r\n\r\n                        if (item.isDirectory) {\r\n                            const subResult = await globalThis.window.electronAPI?.fs.readDir(pathValidation.normalizedPath!)\r\n                            if (subResult?.success && subResult.items) {\r\n                                files.push({ path: pathValidation.normalizedPath!, name: item.name, type: 'directory' })\r\n                                await processEntries(subResult.items, pathValidation.normalizedPath!)\r\n                            }\r\n                        } else {\r\n                            files.push({ path: pathValidation.normalizedPath!, name: item.name, type: 'file' })\r\n                        }\r\n                    }\r\n                }\r\n                await processEntries(result.items, workspacePath)\r\n                setWorkspaceFiles(files)\r\n            }\r\n        } catch (err) { console.error('[IDE] Failed to index:', err) }\r\n    }, [workspacePath])\r\n\r\n    useEffect(() => { indexFiles() }, [workspacePath, indexFiles])\r\n\r\n    // PERFORMANCE FIX: File watcher should only depend on workspacePath\r\n    // Removed activeFile and indexFiles from dependencies to prevent over-firing\r\n    useEffect(() => {\r\n        if (!workspacePath) return\r\n        const watchId = 'workspace-root'\r\n        window.electronAPI?.fs.watchDir({ id: watchId, dirPath: workspacePath })\r\n        const removeListener = window.electronAPI?.fs.onChange((data: { id: string; event: string; path: string }) => {\r\n            if (data.id === watchId && (data.event === 'unlink' || data.event === 'unlinkDir')) {\r\n                const normalizedDeletedPath = data.path.replace(/\\\\/g, '/')\r\n                setOpenFiles(prev => prev.filter(f => f.path.replace(/\\\\/g, '/') !== normalizedDeletedPath))\r\n                setActiveFile(prev => prev && prev.replace(/\\\\/g, '/') === normalizedDeletedPath ? null : prev)\r\n                // Trigger re-index when files change\r\n                indexFiles()\r\n            }\r\n        })\r\n        return () => { removeListener?.(); window.electronAPI?.fs.unwatchDir(watchId) }\r\n    }, [workspacePath]) // ONLY depend on workspacePath\r\n\r\n    // Build event listeners\r\n    useEffect(() => {\r\n        const removeOutputListener = window.electronAPI?.build.onOutput((data: { type: string }) => {\r\n            // Output is automatically routed to terminal\r\n            if (data.type === 'end') {\r\n                setIsBuilding(false)\r\n                buildTaskIdRef.current = null\r\n            }\r\n        })\r\n\r\n        const removeEndListener = window.electronAPI?.build.onEnd((data: { problems?: any[]; exitCode: number }) => {\r\n            setIsBuilding(false)\r\n            buildTaskIdRef.current = null\r\n\r\n            if (data.problems && data.problems.length > 0) {\r\n                addNotification(`Build completed with ${data.problems.length} problem(s)`, 'warning')\r\n            } else if (data.exitCode === 0) {\r\n                addNotification('Build completed successfully', 'success')\r\n            } else {\r\n                addNotification(`Build failed with exit code ${data.exitCode}`, 'error')\r\n            }\r\n        })\r\n\r\n        return () => {\r\n            removeOutputListener?.()\r\n            removeEndListener?.()\r\n        }\r\n    }, [addNotification])\r\n\r\n    // Debug event listeners\r\n    useEffect(() => {\r\n        const removeStartedListener = window.electronAPI?.debug.onStarted((data: { configuration: { name: string } }) => {\r\n            addNotification(`Debug session started: ${data.configuration.name}`, 'success')\r\n        })\r\n\r\n        const removeStoppedListener = window.electronAPI?.debug.onStopped(() => {\r\n            globalThis.window.electronAPI?.terminal.writeOutput({\r\n                id: 'term-1',\r\n                data: `\\r\\n\\x1b[33mâ¸ Debugger paused\\x1b[0m\\r\\n`\r\n            })\r\n        })\r\n\r\n        const removeTerminatedListener = window.electronAPI?.debug.onTerminated(() => {\r\n            setIsDebugging(false)\r\n            debugSessionIdRef.current = null\r\n\r\n            globalThis.window.electronAPI?.terminal.writeOutput({\r\n                id: 'term-1',\r\n                data: `\\r\\n\\x1b[36mâœ“ Debug session terminated\\x1b[0m\\r\\n`\r\n            })\r\n            addNotification('Debug session ended', 'info')\r\n        })\r\n\r\n        const removeOutputListener = window.electronAPI?.debug.onOutput((data: { data?: string }) => {\r\n            if (data.data) {\r\n                globalThis.window.electronAPI?.terminal.writeOutput({\r\n                    id: 'term-1',\r\n                    data: data.data\r\n                })\r\n            }\r\n        })\r\n\r\n        const removeErrorListener = window.electronAPI?.debug.onError((data: { error: string }) => {\r\n            addNotification(`Debug error: ${data.error}`, 'error')\r\n            setIsDebugging(false)\r\n            debugSessionIdRef.current = null\r\n        })\r\n\r\n        return () => {\r\n            removeStartedListener?.()\r\n            removeStoppedListener?.()\r\n            removeTerminatedListener?.()\r\n            removeOutputListener?.()\r\n            removeErrorListener?.()\r\n        }\r\n    }, [addNotification])\r\n\r\n    const handleNewFile = async () => {\r\n        if (!workspacePath) return\r\n        const fileName = window.prompt('Enter file name:')\r\n        if (!fileName) return\r\n\r\n        const fullPath = `${workspacePath}/${fileName}`\r\n\r\n        // SECURITY FIX: Validate path to prevent directory traversal\r\n        const validation = validatePath(fullPath, workspacePath)\r\n        if (!validation.valid) {\r\n            addNotification(validation.error || 'Invalid file path', 'error')\r\n            logger.ide.warn('Path validation failed for new file', { fullPath, error: validation.error })\r\n            return\r\n        }\r\n\r\n        const result = await window.electronAPI?.fs.writeFile({ path: validation.normalizedPath!, content: '' })\r\n        if (result?.success) {\r\n            handleOpenFile(validation.normalizedPath!)\r\n            indexFiles()\r\n            addNotification(`File created: ${fileName}`, 'success')\r\n        } else {\r\n            addNotification(`Failed to create: ${result?.error}`, 'error')\r\n        }\r\n    }\r\n\r\n    const ideCommands = useMemo<IDECommand[]>(() => {\r\n        return createDefaultCommands({\r\n            newFile: handleNewFile,\r\n            saveFile: handleSaveFile,\r\n            closeFile: () => { if (activeFile) handleCloseFile(activeFile) },\r\n            closeAllFiles: () => { setOpenFiles([]); setActiveFile(null) },\r\n            openFolder: handleOpenFolder,\r\n            toggleTerminal: () => setShowTerminal(prev => !prev),\r\n            toggleSidebar: () => setSidebarOpen(prev => !prev),\r\n            toggleGitPanel: () => setActivePanel('git'),\r\n            toggleAIPanel: () => setAgentOpen(!agentOpen),\r\n            runCode: handleRunCode,\r\n            debugCode: handleDebugCode,\r\n            buildCode: handleBuildCode,\r\n            formatDocument: () => editorRef.current?.getAction('editor.action.formatDocument')?.run(),\r\n            goToLine: () => editorRef.current?.getAction('editor.action.gotoLine')?.run(),\r\n            findInFiles: () => setActivePanel('search'),\r\n            gitCommit: () => setActivePanel('git'),\r\n            gitPush: async () => { if (workspacePath) await globalThis.window.electronAPI?.git.push(workspacePath) },\r\n            gitPull: async () => { if (workspacePath) await globalThis.window.electronAPI?.git.pull(workspacePath) },\r\n            aiChat: () => setAgentOpen(true),\r\n            aiExplain: () => setAgentOpen(true),\r\n            aiRefactor: () => { } // Handled via Inline AI tool\r\n        })\r\n    }, [activeFile, workspacePath, handleNewFile, handleSaveFile, handleCloseFile, handleRunCode, handleDebugCode, handleBuildCode, agentOpen])\r\n\r\n    useEffect(() => {\r\n        const handleKeyDown = (e: KeyboardEvent) => {\r\n            if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); handleSaveFile() }\r\n            if ((e.ctrlKey || e.metaKey) && e.key === 'w') { e.preventDefault(); if (activeFile) handleCloseFile(activeFile) }\r\n            if ((e.ctrlKey || e.metaKey) && e.key === 'p' && !e.shiftKey) { e.preventDefault(); setPaletteMode('files'); setPaletteOpen(true) }\r\n            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'P') { e.preventDefault(); setPaletteMode('commands'); setPaletteOpen(true) }\r\n            if (e.key === 'F1') { e.preventDefault(); setPaletteMode('commands'); setPaletteOpen(true) }\r\n            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'F') { e.preventDefault(); setActivePanel('search') }\r\n            if ((e.ctrlKey || e.metaKey) && e.key === '`') { e.preventDefault(); setShowTerminal(prev => !prev) }\r\n            // Run/Debug/Build shortcuts\r\n            if (e.key === 'F5' && !e.shiftKey && !e.ctrlKey && !e.metaKey) {\r\n                e.preventDefault()\r\n                if (isDebugging) handleDebugContinue()\r\n                else if (isRunning) handleStopCode()\r\n                else handleRunCode()\r\n            }\r\n            if (e.shiftKey && e.key === 'F5') { e.preventDefault(); handleStopDebug() }\r\n            if (e.key === 'F9') { e.preventDefault(); if (isDebugging) handleStopDebug(); else handleDebugCode() }\r\n            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'B') { e.preventDefault(); if (isBuilding) handleStopBuild(); else handleBuildCode() }\r\n            // Debug step shortcuts (only when debugging)\r\n            if (isDebugging) {\r\n                if (e.key === 'F10' && !e.shiftKey) { e.preventDefault(); handleDebugStepOver() }\r\n                if (e.key === 'F11' && !e.shiftKey) { e.preventDefault(); handleDebugStepInto() }\r\n                if (e.shiftKey && e.key === 'F11') { e.preventDefault(); handleDebugStepOut() }\r\n                if (e.key === 'F6') { e.preventDefault(); handleDebugPause() }\r\n            }\r\n        }\r\n        window.addEventListener('keydown', handleKeyDown)\r\n        return () => window.removeEventListener('keydown', handleKeyDown)\r\n    }, [activeFile, openFiles, handleSaveFile, handleCloseFile, handleRunCode, handleStopCode, isRunning, handleDebugCode, handleStopDebug, isDebugging, handleBuildCode, handleStopBuild, isBuilding, handleDebugContinue, handleDebugStepOver, handleDebugStepInto, handleDebugStepOut, handleDebugPause])\r\n\r\n    useEffect(() => {\r\n        if (activeFile && pendingLine && editorRef.current) {\r\n            setTimeout(() => {\r\n                editorRef.current?.revealLineInCenter(pendingLine)\r\n                editorRef.current?.setPosition({ lineNumber: pendingLine, column: 1 })\r\n                editorRef.current?.focus()\r\n                setPendingLine(null)\r\n            }, 100)\r\n        }\r\n    }, [activeFile, pendingLine])\r\n\r\n    const handleResizeSidebar = useCallback((e: MouseEvent) => {\r\n        if (!isResizingSidebar) return\r\n        const newWidth = e.clientX - 48 // Subtract activity bar width\r\n        if (newWidth > 200 && newWidth < 600) {\r\n            setSidebarWidth(newWidth)\r\n        }\r\n    }, [isResizingSidebar])\r\n\r\n    const stopResizingSidebar = useCallback(() => {\r\n        setIsResizingSidebar(false)\r\n    }, [])\r\n\r\n    const handleResizeSplit = useCallback((e: MouseEvent) => {\r\n        if (!isResizingSplit) return\r\n        const container = document.querySelector('.split-editor-container')\r\n        if (!container) return\r\n\r\n        const rect = container.getBoundingClientRect()\r\n        const newRatio = (e.clientX - rect.left) / rect.width\r\n\r\n        // Clamp between 30% and 70%\r\n        if (newRatio >= 0.3 && newRatio <= 0.7) {\r\n            setEditorSplitRatio(newRatio)\r\n        }\r\n    }, [isResizingSplit])\r\n\r\n    const stopResizingSplit = useCallback(() => {\r\n        setIsResizingSplit(false)\r\n    }, [])\r\n\r\n    useEffect(() => {\r\n        if (isResizingSplit) {\r\n            window.addEventListener('mousemove', handleResizeSplit)\r\n            window.addEventListener('mouseup', stopResizingSplit)\r\n        } else {\r\n            window.removeEventListener('mousemove', handleResizeSplit)\r\n            window.removeEventListener('mouseup', stopResizingSplit)\r\n        }\r\n        return () => {\r\n            window.removeEventListener('mousemove', handleResizeSplit)\r\n            window.removeEventListener('mouseup', stopResizingSplit)\r\n        }\r\n    }, [isResizingSplit, handleResizeSplit, stopResizingSplit])\r\n\r\n    useEffect(() => {\r\n        if (isResizingSidebar) {\r\n            window.addEventListener('mousemove', handleResizeSidebar)\r\n            window.addEventListener('mouseup', stopResizingSidebar)\r\n        } else {\r\n            window.removeEventListener('mousemove', handleResizeSidebar)\r\n            window.removeEventListener('mouseup', stopResizingSidebar)\r\n        }\r\n        return () => {\r\n            window.removeEventListener('mousemove', handleResizeSidebar)\r\n            window.removeEventListener('mouseup', stopResizingSidebar)\r\n        }\r\n    }, [isResizingSidebar, handleResizeSidebar, stopResizingSidebar])\r\n\r\n    return (\r\n        <div className={`ide-workspace ${isResizingSidebar ? 'resizing-active' : ''}`}>\r\n            {isResizingSidebar && <div className=\"resize-overlay\" />}\r\n\r\n            <IDEActivityBar activePanel={activePanel} onPanelChange={setActivePanel} />\r\n\r\n            <IDEPanelContainer\r\n                sidebarOpen={sidebarOpen}\r\n                sidebarWidth={sidebarWidth}\r\n                activePanel={activePanel}\r\n                workspacePath={workspacePath}\r\n                onOpenFolder={handleOpenFolder}\r\n                onCloseWorkspace={handleCloseWorkspace}\r\n                onSelectFile={handleOpenFile}\r\n                onCloseFile={handleCloseFile}\r\n                selectedFile={activeFile}\r\n                openFiles={openFiles.map(f => ({ path: f.path, name: f.name, isDirty: f.isDirty }))}\r\n                onFileCreate={() => indexFiles()}\r\n                onFileDelete={(path) => {\r\n                    setOpenFiles(prev => prev.filter(f => f.path !== path))\r\n                    if (activeFile === path) setActiveFile(null)\r\n                    indexFiles()\r\n                }}\r\n                onFileRename={(oldP, newP) => {\r\n                    setOpenFiles(prev => prev.map(f => f.path === oldP ? { ...f, path: newP, name: newP.split(/[/\\\\]/).pop() || f.name } : f))\r\n                    if (activeFile === oldP) setActiveFile(newP)\r\n                    indexFiles()\r\n                }}\r\n                requestedExpansion={requestedExpansion}\r\n                onExpansionComplete={() => setRequestedExpansion(null)}\r\n            />\r\n\r\n            {sidebarOpen && (\r\n                <div\r\n                    className={`sidebar-resizer ${isResizingSidebar ? 'resizing' : ''}`}\r\n                    onMouseDown={(e) => {\r\n                        e.preventDefault()\r\n                        setIsResizingSidebar(true)\r\n                    }}\r\n                />\r\n            )}\r\n\r\n            <main className=\"ide-main\">\r\n                <IDEToolbar\r\n                    activeFileObj={activeFileObj || null}\r\n                    onRunCode={handleRunCode}\r\n                    onStopCode={handleStopCode}\r\n                    isRunning={isRunning}\r\n                    onDebugCode={handleDebugCode}\r\n                    onStopDebug={handleStopDebug}\r\n                    isDebugging={isDebugging}\r\n                    onBuildCode={handleBuildCode}\r\n                    onStopBuild={handleStopBuild}\r\n                    isBuilding={isBuilding}\r\n                    toggleAIPanel={() => setAgentOpen(prev => !prev)}\r\n                    isAIAppOpen={agentOpen}\r\n                    onToggleTerminal={() => setShowTerminal(prev => !prev)}\r\n                    // Editor Settings\r\n                    wordWrap={wordWrap as 'on' | 'off'}\r\n                    onToggleWordWrap={() => setWordWrap(prev => prev === 'on' ? 'off' : 'on')}\r\n                    minimapEnabled={minimapEnabled}\r\n                    onToggleMinimap={() => setMinimapEnabled(prev => !prev)}\r\n                    stickyScrollEnabled={stickyScrollEnabled}\r\n                    onToggleStickyScroll={() => setStickyScrollEnabled(prev => !prev)}\r\n                    // Utility Actions\r\n                    onClearCache={handleClearCache}\r\n                    onReloadWindow={handleReloadWindow}\r\n                    onSplitEditor={handleToggleSplitEditor}\r\n                    splitEditorEnabled={splitEditorEnabled}\r\n                    onOpenCommandPalette={handleOpenCommandPalette}\r\n                    onAboutKalynt={handleAboutKalynt}\r\n                    // Debug Controls\r\n                    onDebugContinue={handleDebugContinue}\r\n                    onDebugStepOver={handleDebugStepOver}\r\n                    onDebugStepInto={handleDebugStepInto}\r\n                    onDebugStepOut={handleDebugStepOut}\r\n                    onDebugPause={handleDebugPause}\r\n                />\r\n\r\n                <IDETabList\r\n                    openFiles={openFiles}\r\n                    activeFile={activeFile}\r\n                    onSelectFile={setActiveFile}\r\n                    onCloseFile={handleCloseFile}\r\n                />\r\n\r\n                {activeFile && (\r\n                    <Breadcrumbs\r\n                        filePath={activeFile}\r\n                        workspacePath={workspacePath}\r\n                        onNavigate={handleOpenFile}\r\n                    />\r\n                )}\r\n\r\n                <div className={`editor-container ${splitEditorEnabled ? 'split-mode' : ''}`}>\r\n                    {activeFileObj ? (\r\n                        <div className=\"split-editor-container\">\r\n                            {/* Primary Editor Pane */}\r\n                            <div\r\n                                className=\"editor-pane primary\"\r\n                                style={{\r\n                                    width: splitEditorEnabled ? `${editorSplitRatio * 100}%` : '100%'\r\n                                }}\r\n                            >\r\n                                <div className=\"split-editor-header\" style={{ opacity: splitEditorEnabled ? 1 : 0 }}>\r\n                                    <span className=\"split-file-name\">{activeFileObj.name}</span>\r\n                                </div>\r\n                                <div style={{ height: splitEditorEnabled ? 'calc(100% - 24px)' : '100%' }}>\r\n                                    <Editor\r\n                                        height=\"100%\"\r\n                                        language={activeFileObj.language}\r\n                                        value={activeFileObj.content}\r\n                                        onChange={handleEditorChange}\r\n                                        theme=\"vs-dark\"\r\n                                        onMount={handleEditorDidMount}\r\n                                        options={{\r\n                                            fontSize: 14,\r\n                                            fontFamily: \"'SF Mono', 'Fira Code', 'Consolas', monospace\",\r\n                                            minimap: { enabled: minimapEnabled, scale: 1 },\r\n                                            scrollBeyondLastLine: false,\r\n                                            automaticLayout: true,\r\n                                            tabSize: 2,\r\n                                            wordWrap: wordWrap as 'on' | 'off',\r\n                                            stickyScroll: { enabled: stickyScrollEnabled },\r\n                                            lineNumbers: 'on',\r\n                                            renderLineHighlight: 'all',\r\n                                            bracketPairColorization: { enabled: true },\r\n                                            cursorBlinking: 'smooth',\r\n                                            smoothScrolling: true,\r\n                                            inlineSuggest: { enabled: true },\r\n                                            quickSuggestions: true,\r\n                                            suggestOnTriggerCharacters: true\r\n                                        }}\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* Draggable Divider */}\r\n                            <div\r\n                                className={`editor-divider ${isResizingSplit ? 'resizing' : ''}`}\r\n                                style={{\r\n                                    width: splitEditorEnabled ? '4px' : '0px',\r\n                                    opacity: splitEditorEnabled ? 1 : 0,\r\n                                    pointerEvents: splitEditorEnabled ? 'auto' : 'none'\r\n                                }}\r\n                                onMouseDown={(e) => {\r\n                                    e.preventDefault()\r\n                                    setIsResizingSplit(true)\r\n                                }}\r\n                            />\r\n\r\n                            {/* Secondary Editor Pane */}\r\n                            <div\r\n                                className=\"editor-pane secondary\"\r\n                                style={{\r\n                                    width: splitEditorEnabled && secondaryFileObj ? `${(1 - editorSplitRatio) * 100}%` : '0%',\r\n                                    opacity: splitEditorEnabled ? 1 : 0\r\n                                }}\r\n                            >\r\n                                {secondaryFileObj && (\r\n                                    <>\r\n                                        <div className=\"split-editor-header\">\r\n                                            <span className=\"split-file-name\">{secondaryFileObj.name}</span>\r\n                                        </div>\r\n                                        <div style={{ height: 'calc(100% - 24px)' }}>\r\n                                            <Editor\r\n                                                height=\"100%\"\r\n                                                language={secondaryFileObj.language}\r\n                                                value={secondaryFileObj.content}\r\n                                                onChange={handleSecondaryEditorChange}\r\n                                                theme=\"vs-dark\"\r\n                                                onMount={handleSecondaryEditorDidMount}\r\n                                                options={{\r\n                                                    fontSize: 14,\r\n                                                    fontFamily: \"'SF Mono', 'Fira Code', 'Consolas', monospace\",\r\n                                                    minimap: { enabled: minimapEnabled, scale: 1 },\r\n                                                    scrollBeyondLastLine: false,\r\n                                                    automaticLayout: true,\r\n                                                    tabSize: 2,\r\n                                                    wordWrap: wordWrap as 'on' | 'off',\r\n                                                    stickyScroll: { enabled: stickyScrollEnabled },\r\n                                                    lineNumbers: 'on',\r\n                                                    renderLineHighlight: 'all',\r\n                                                    bracketPairColorization: { enabled: true },\r\n                                                    cursorBlinking: 'smooth',\r\n                                                    smoothScrolling: true,\r\n                                                    inlineSuggest: { enabled: true },\r\n                                                    quickSuggestions: true,\r\n                                                    suggestOnTriggerCharacters: true\r\n                                                }}\r\n                                            />\r\n                                        </div>\r\n                                    </>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n                    ) : (\r\n                        <div className=\"welcome-screen\">\r\n                            <Wand2 size={64} className=\"welcome-icon\" />\r\n                            <h2>Welcome to Kalynt IDE</h2>\r\n                            <p>Open a folder to get started</p>\r\n                            <button className=\"welcome-btn\" onClick={handleOpenFolder}>\r\n                                <FolderOpen size={18} />\r\n                                <span>Open Folder</span>\r\n                            </button>\r\n                            <div className=\"shortcuts\">\r\n                                <p><kbd>Ctrl+S</kbd> Save file</p>\r\n                                <p><kbd>Ctrl+W</kbd> Close tab</p>\r\n                                <p><kbd>Ctrl+`</kbd> Toggle terminal</p>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n\r\n\r\n                <IDEBottomTerminal\r\n                    showTerminal={showTerminal}\r\n                    terminalHeight={terminalHeight}\r\n                    setTerminalHeight={setTerminalHeight}\r\n                    workspacePath={workspacePath}\r\n                    codeOutput={codeOutput}\r\n                    isRunning={isRunning}\r\n                />\r\n            </main>\r\n\r\n            <div className={`ide-right-panel ${agentOpen ? 'open' : ''}`}>\r\n                <UnifiedAgentPanel\r\n                    workspacePath={workspacePath}\r\n                    currentFile={activeFile}\r\n                    currentFileContent={activeFileObj?.content || null}\r\n                    onRunCommand={onRunCommand}\r\n                />\r\n            </div>\r\n\r\n            <CommandPalette\r\n                open={paletteOpen}\r\n                onOpenChange={setPaletteOpen}\r\n                mode={paletteMode}\r\n                files={workspaceFiles}\r\n                onFileSelect={handleOpenFile}\r\n                commands={ideCommands}\r\n                workspacePath={workspacePath || undefined}\r\n            />\r\n\r\n            <InlineEditWidget\r\n                visible={inlineEditVisible}\r\n                selectedCode={inlineEditSelection}\r\n                filePath={activeFile || ''}\r\n                language={activeFileObj?.language || 'typescript'}\r\n                position={inlineEditPosition}\r\n                onApply={(newCode) => {\r\n                    if (editorRef.current) {\r\n                        const editor = editorRef.current\r\n                        const selection = editor.getSelection()\r\n                        if (selection) {\r\n                            editor.executeEdits('inline-ai-edit', [{\r\n                                range: selection,\r\n                                text: newCode,\r\n                                forceMoveMarkers: true\r\n                            }])\r\n                        }\r\n                    }\r\n                    setInlineEditVisible(false)\r\n                }}\r\n                onCancel={() => setInlineEditVisible(false)}\r\n            />\r\n\r\n            {unsavedDialog.isOpen && (\r\n                <div className=\"dialog-overlay\">\r\n                    <div className=\"dialog\">\r\n                        <h3>Unsaved Changes</h3>\r\n                        <p>Do you want to save changes to <strong>{openFiles.find(f => f.path === unsavedDialog.filePath)?.name}</strong>?</p>\r\n                        <div className=\"dialog-actions\">\r\n                            <button className=\"btn-secondary\" onClick={() => {\r\n                                if (unsavedDialog.filePath) forceCloseFile(unsavedDialog.filePath)\r\n                                setUnsavedDialog({ isOpen: false, filePath: null })\r\n                            }}>Don't Save</button>\r\n                            <button className=\"btn-secondary\" onClick={() => setUnsavedDialog({ isOpen: false, filePath: null })}>Cancel</button>\r\n                            <button className=\"btn-primary\" onClick={async () => {\r\n                                if (unsavedDialog.filePath) {\r\n                                    const file = openFiles.find(f => f.path === unsavedDialog.filePath)\r\n                                    if (file) await globalThis.window.electronAPI?.fs.writeFile({ path: file.path, content: file.content })\r\n                                    forceCloseFile(unsavedDialog.filePath)\r\n                                }\r\n                                setUnsavedDialog({ isOpen: false, filePath: null })\r\n                            }}>Save</button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            {deletedFileDialog.isOpen && (\r\n                <div className=\"dialog-overlay\">\r\n                    <div className=\"dialog alert\">\r\n                        <h3>File Deleted</h3>\r\n                        <p>The file <strong>{deletedFileDialog.filePath?.split(/[/\\\\]/).pop()}</strong> no longer exists. Close the tab?</p>\r\n                        <div className=\"dialog-actions\">\r\n                            <button className=\"btn-secondary\" onClick={() => setDeletedFileDialog({ isOpen: false, filePath: null })}>Keep Open</button>\r\n                            <button className=\"btn-primary\" onClick={() => {\r\n                                if (deletedFileDialog.filePath) forceCloseFile(deletedFileDialog.filePath)\r\n                                setDeletedFileDialog({ isOpen: false, filePath: null })\r\n                            }}>Close Tab</button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\ide\\InlineEditWidget.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\ide\\SearchPanel.tsx","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":59,"column":11,"nodeType":"MemberExpression","messageId":"unexpected","endLine":59,"endColumn":23,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[1982,2087],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":75,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":75,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[2562,2622],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":99,"column":11,"nodeType":"MemberExpression","messageId":"unexpected","endLine":99,"endColumn":23,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[3484,3558],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":108,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":108,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[3754,3814],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":114,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":114,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3947,3950],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3947,3950],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":183,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":183,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6649,6652],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6649,6652],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":319,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":319,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11711,11714],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11711,11714],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\nimport { useState, useMemo, useRef, useEffect } from 'react'\r\nimport { List, ListImperativeAPI } from 'react-window'\r\nimport { logger } from '../../utils/logger'\r\n\r\nconst useResizeObserver = (ref: React.RefObject<HTMLElement>) => {\r\n  const [dimensions, setDimensions] = useState({ width: 0, height: 0 })\r\n  useEffect(() => {\r\n    if (!ref.current) return\r\n    const resizeObserver = new ResizeObserver((entries) => {\r\n      if (entries[0]) {\r\n        const { width, height } = entries[0].contentRect\r\n        setDimensions({ width, height })\r\n      }\r\n    })\r\n    resizeObserver.observe(ref.current)\r\n    return () => resizeObserver.disconnect()\r\n  }, [ref])\r\n  return dimensions\r\n}\r\n\r\ninterface SearchResult {\r\n  filePath: string\r\n  fileName: string\r\n  line: number\r\n  column: number\r\n  matchText: string\r\n  contextBefore: string\r\n  contextAfter: string\r\n}\r\n\r\nconst shouldSkipFile = (fileName: string, includeExts: string[]) => {\r\n  const binaryExts = ['png', 'jpg', 'jpeg', 'gif', 'ico', 'svg', 'woff', 'woff2', 'ttf', 'eot', 'mp3', 'mp4', 'zip', 'tar', 'gz']\r\n  const ext = fileName.split('.').pop()?.toLowerCase() || ''\r\n\r\n  if (binaryExts.includes(ext)) return true\r\n  if (includeExts.length > 0 && !includeExts.some(ie => ext === ie || fileName.endsWith(ie))) return true\r\n\r\n  return false\r\n}\r\n\r\nconst searchInFile = (content: string, filePath: string, fileName: string, pattern: RegExp, results: SearchResult[]) => {\r\n  const lines = content.split('\\n')\r\n  for (let idx = 0; idx < lines.length; idx++) {\r\n    const line = lines[idx]\r\n    pattern.lastIndex = 0\r\n    let match\r\n\r\n    // SECURITY FIX: Add timeout protection for potentially malicious regex\r\n    const startTime = Date.now()\r\n    const MAX_REGEX_TIME = 100 // milliseconds\r\n\r\n    try {\r\n      while ((match = pattern.exec(line)) !== null) {\r\n        // Check timeout to prevent ReDoS attacks\r\n        if (Date.now() - startTime > MAX_REGEX_TIME) {\r\n          console.warn('[SearchPanel] Regex execution timeout, skipping rest of line', { fileName, line: idx + 1 })\r\n          break\r\n        }\r\n\r\n        results.push({\r\n          filePath,\r\n          fileName,\r\n          line: idx + 1,\r\n          column: match.index + 1,\r\n          matchText: match[0],\r\n          contextBefore: line.slice(Math.max(0, match.index - 30), match.index),\r\n          contextAfter: line.slice(match.index + match[0].length, match.index + match[0].length + 50)\r\n        })\r\n        if (results.length >= 500) return true\r\n      }\r\n    } catch (error) {\r\n      console.error('[SearchPanel] Regex execution error:', error)\r\n      break // Skip this line and continue with next\r\n    }\r\n  }\r\n  return false\r\n}\r\n\r\nconst getSearchPattern = (query: string, useRegex: boolean, caseSensitive: boolean) => {\r\n  const flags = caseSensitive ? 'g' : 'gi'\r\n  const patternStr = useRegex ? query : query.replaceAll(/[.*+?^${}()|[\\]\\\\]/g, String.raw`\\$&`)\r\n\r\n  // SECURITY FIX: Wrap RegExp construction in try-catch to prevent crashes from invalid patterns\r\n  try {\r\n    // Validate regex complexity to prevent ReDoS\r\n    if (useRegex) {\r\n      // Check for common ReDoS patterns\r\n      const dangerousPatterns = [\r\n        /(\\(.*\\+.*\\))+/,  // Nested quantifiers like (a+)+\r\n        /(\\(.*\\*.*\\))+/,  // Nested quantifiers like (a*)+\r\n        /(\\(.*\\{.*,.*\\}.*\\))+/,  // Nested ranges\r\n      ]\r\n\r\n      for (const dangerous of dangerousPatterns) {\r\n        if (dangerous.test(query)) {\r\n          console.warn('[SearchPanel] Potentially dangerous regex pattern detected')\r\n          // Don't block entirely, but user has been warned via console\r\n        }\r\n      }\r\n    }\r\n\r\n    const regex = new RegExp(patternStr, flags)\r\n    return regex\r\n  } catch (error) {\r\n    console.error('[SearchPanel] Invalid regex pattern:', error)\r\n    // Return a pattern that matches nothing on error\r\n    return new RegExp('(?!.*)', flags)\r\n  }\r\n}\r\n\r\nconst SearchRow = (props: any) => {\r\n  const { index, style, ariaAttributes, items, expandedFiles, toggleFile, getRelativePath, onFileSelect } = props\r\n  const item = items[index]\r\n  if (!item) return null\r\n\r\n  if (item.type === 'header') {\r\n    return (\r\n      <div style={style} {...ariaAttributes}>\r\n        <button\r\n          className=\"result-file-header\"\r\n          onClick={() => toggleFile(item.filePath)}\r\n          aria-expanded={expandedFiles.has(item.filePath)}\r\n        >\r\n          <span className=\"expand-icon\">\r\n            {expandedFiles.has(item.filePath) ? 'â–¼' : 'â–¶'}\r\n          </span>\r\n          <span className=\"file-name\">{item.results[0].fileName}</span>\r\n          <span className=\"file-path\">{getRelativePath(item.filePath)}</span>\r\n          <span className=\"match-count\">{item.count}</span>\r\n        </button>\r\n      </div>\r\n    )\r\n  } else {\r\n    return (\r\n      <div style={style} {...ariaAttributes}>\r\n        <button\r\n          className=\"result-match\"\r\n          onClick={() => onFileSelect(item.filePath, item.result.line)}\r\n          aria-label={`Go to line ${item.result.line} in ${item.filePath}`}\r\n        >\r\n          <span className=\"line-number\">{item.result.line}</span>\r\n          <span className=\"match-content\">\r\n            <span className=\"context\">{item.result.contextBefore}</span>\r\n            <span className=\"highlight\">{item.result.matchText}</span>\r\n            <span className=\"context\">{item.result.contextAfter}</span>\r\n          </span>\r\n        </button>\r\n      </div>\r\n    )\r\n  }\r\n}\r\n\r\ninterface SearchPanelProps {\r\n  readonly workspacePath: string | null\r\n  readonly onFileSelect: (path: string, line?: number) => void\r\n}\r\n\r\nexport default function SearchPanel({ workspacePath, onFileSelect }: SearchPanelProps) {\r\n  const [query, setQuery] = useState('')\r\n  const [results, setResults] = useState<SearchResult[]>([])\r\n  const [isSearching, setIsSearching] = useState(false)\r\n  const [caseSensitive, setCaseSensitive] = useState(false)\r\n  const [useRegex, setUseRegex] = useState(false)\r\n  const [includePattern, setIncludePattern] = useState('')\r\n  const [excludePattern, setExcludePattern] = useState('node_modules,dist,.git')\r\n  const [expandedFiles, setExpandedFiles] = useState<Set<string>>(new Set())\r\n  const abortRef = useRef<boolean>(false)\r\n\r\n  const listRef = useRef<ListImperativeAPI>(null)\r\n  const parentRef = useRef<HTMLDivElement>(null)\r\n  const { width, height } = useResizeObserver(parentRef)\r\n\r\n  const items = useMemo(() => {\r\n    const grouped: Record<string, SearchResult[]> = {}\r\n    for (const res of results) {\r\n      if (!grouped[res.filePath]) grouped[res.filePath] = []\r\n      grouped[res.filePath].push(res)\r\n    }\r\n\r\n    const flat: any[] = []\r\n    for (const [filePath, fileResults] of Object.entries(grouped)) {\r\n      flat.push({ type: 'header', filePath, count: fileResults.length, results: fileResults })\r\n      if (expandedFiles.has(filePath)) {\r\n        for (const res of fileResults) {\r\n          flat.push({ type: 'match', filePath, result: res })\r\n        }\r\n      }\r\n    }\r\n    return flat\r\n  }, [results, expandedFiles])\r\n\r\n  const getItemSize = (index: number) => {\r\n    return items[index].type === 'header' ? 32 : 24\r\n  }\r\n\r\n  const toggleFile = (filePath: string) => {\r\n    const next = new Set(expandedFiles)\r\n    if (next.has(filePath)) next.delete(filePath)\r\n    else next.add(filePath)\r\n    setExpandedFiles(next)\r\n  }\r\n\r\n  const getRelativePath = (filePath: string) => {\r\n    if (!workspacePath) return filePath\r\n    return filePath.replace(workspacePath, '').replace(/^[\\\\/]/, '').replaceAll('\\\\', '/')\r\n  }\r\n\r\n  const handleSearch = async () => {\r\n    if (!query || !workspacePath) return\r\n    setIsSearching(true)\r\n    setResults([])\r\n    setExpandedFiles(new Set())\r\n    abortRef.current = false\r\n\r\n    try {\r\n      const includeExts = includePattern.split(',').map(s => s.trim().toLowerCase()).filter(Boolean)\r\n      const excludeDirs = new Set(excludePattern.split(',').map(s => s.trim()).filter(Boolean))\r\n      const pattern = getSearchPattern(query, useRegex, caseSensitive)\r\n\r\n      const searchDir = async (dir: string) => {\r\n        if (abortRef.current) return\r\n\r\n        const res = await globalThis.window.electronAPI.fs.readDir(dir)\r\n        if (!res.success || !res.items) return\r\n\r\n        for (const entry of res.items) {\r\n          if (abortRef.current) return\r\n          if (entry.isDirectory) {\r\n            if (excludeDirs.has(entry.name)) continue\r\n            await searchDir(`${dir}/${entry.name}`)\r\n          } else if (!shouldSkipFile(entry.name, includeExts)) {\r\n            await processFile(`${dir}/${entry.name}`, entry.name, pattern)\r\n          }\r\n        }\r\n      }\r\n\r\n      const processFile = async (fullPath: string, fileName: string, pattern: RegExp) => {\r\n        try {\r\n          const fileRes = await globalThis.window.electronAPI.fs.readFile(fullPath)\r\n          if (fileRes.success && fileRes.content) {\r\n            if (searchInFile(fileRes.content, fullPath, fileName, pattern, results)) {\r\n              abortRef.current = true\r\n            }\r\n          }\r\n        } catch (error) {\r\n          logger.ide.debug('Failed to read file during search', { fullPath, error })\r\n        }\r\n      }\r\n\r\n      await searchDir(workspacePath)\r\n      setResults([...results])\r\n    } catch (error) {\r\n      logger.ide.error('Search operation failed', { workspacePath, query, error })\r\n    } finally {\r\n      setIsSearching(false)\r\n    }\r\n  }\r\n\r\n  const clearSearch = () => {\r\n    setQuery('')\r\n    setResults([])\r\n    setExpandedFiles(new Set())\r\n    abortRef.current = true\r\n  }\r\n\r\n  useEffect(() => {\r\n    return () => { abortRef.current = true }\r\n  }, [])\r\n\r\n  return (\r\n    <div className=\"search-panel\">\r\n      <div className=\"search-header\">\r\n        <div className=\"search-input-wrapper\">\r\n          <input\r\n            id=\"search-query\"\r\n            type=\"text\"\r\n            placeholder=\"Search query...\"\r\n            value={query}\r\n            onChange={(e) => setQuery(e.target.value)}\r\n            onKeyDown={(e) => e.key === 'Enter' && handleSearch()}\r\n            aria-label=\"Search query\"\r\n          />\r\n          <div className=\"search-actions\">\r\n            <button className={caseSensitive ? 'active' : ''} onClick={() => setCaseSensitive(!caseSensitive)} title=\"Case Sensitive\">Aa</button>\r\n            <button className={useRegex ? 'active' : ''} onClick={() => setUseRegex(!useRegex)} title=\"Use Regex\">.*</button>\r\n            <button onClick={handleSearch} disabled={isSearching}>{isSearching ? '...' : 'ðŸ”'}</button>\r\n            <button onClick={clearSearch}>âœ–ï¸</button>\r\n          </div>\r\n        </div>\r\n        <div className=\"search-options\">\r\n          <div className=\"option\">\r\n            <label htmlFor=\"search-include\">Include:</label>\r\n            <input id=\"search-include\" type=\"text\" placeholder=\"e.g. .ts, .tsx\" value={includePattern} onChange={(e) => setIncludePattern(e.target.value)} />\r\n          </div>\r\n          <div className=\"option\">\r\n            <label htmlFor=\"search-exclude\">Exclude:</label>\r\n            <input id=\"search-exclude\" type=\"text\" value={excludePattern} onChange={(e) => setExcludePattern(e.target.value)} />\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"search-results-container\" ref={parentRef} style={{ flex: 1, minHeight: 0 }}>\r\n        {results.length > 0 ? (\r\n          <List\r\n            listRef={listRef}\r\n            rowCount={items.length}\r\n            rowHeight={getItemSize}\r\n            style={{ height, width }}\r\n            rowProps={{\r\n              items,\r\n              expandedFiles,\r\n              toggleFile,\r\n              getRelativePath,\r\n              onFileSelect\r\n            }}\r\n            rowComponent={SearchRow as any}\r\n          />\r\n        ) : (\r\n          <div className=\"no-results\">\r\n            {isSearching ? 'Searching...' : 'No results found'}\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      <style>{`\r\n        .search-panel {\r\n          height: 100%;\r\n          display: flex;\r\n          flex-direction: column;\r\n          background: var(--color-bg, #1e1e1e);\r\n          color: var(--color-text, #ccc);\r\n        }\r\n        .search-header {\r\n          padding: 12px;\r\n          border-bottom: 1px solid var(--color-border, #3c3c3c);\r\n        }\r\n        .search-input-wrapper {\r\n          display: flex;\r\n          gap: 8px;\r\n          margin-bottom: 8px;\r\n        }\r\n        .search-input-wrapper input {\r\n          flex: 1;\r\n          padding: 6px 10px;\r\n          background: var(--color-surface, #252526);\r\n          border: 1px solid var(--color-border, #3c3c3c);\r\n          color: inherit;\r\n          border-radius: 4px;\r\n        }\r\n        .search-actions {\r\n          display: flex;\r\n          gap: 4px;\r\n        }\r\n        .search-actions button {\r\n          padding: 4px 8px;\r\n          background: var(--color-surface, #252526);\r\n          border: 1px solid var(--color-border, #3c3c3c);\r\n          color: inherit;\r\n          cursor: pointer;\r\n          border-radius: 4px;\r\n        }\r\n        .search-actions button.active {\r\n          background: var(--color-accent, #007acc);\r\n          color: white;\r\n          border-color: var(--color-accent, #007acc);\r\n        }\r\n        .search-options {\r\n          display: flex;\r\n          gap: 12px;\r\n          font-size: 11px;\r\n        }\r\n        .option {\r\n          display: flex;\r\n          align-items: center;\r\n          gap: 4px;\r\n        }\r\n        .option input {\r\n          background: var(--color-surface, #252526);\r\n          border: 1px solid var(--color-border, #3c3c3c);\r\n          color: inherit;\r\n          padding: 2px 4px;\r\n          border-radius: 2px;\r\n        }\r\n        .search-results-container {\r\n          overflow: hidden;\r\n        }\r\n        .result-file-header, .result-match {\r\n          display: flex;\r\n          align-items: center;\r\n          width: 100%;\r\n          border: none;\r\n          background: transparent;\r\n          color: inherit;\r\n          text-align: left;\r\n          padding: 0;\r\n          margin: 0;\r\n          cursor: pointer;\r\n        }\r\n        .result-file-header {\r\n          gap: 8px;\r\n          padding: 4px 8px;\r\n          font-size: 13px;\r\n        }\r\n        .result-file-header:hover, .result-match:hover {\r\n          background: rgba(255, 255, 255, 0.05);\r\n        }\r\n        .file-name {\r\n          font-weight: 600;\r\n        }\r\n        .file-path {\r\n          font-size: 11px;\r\n          opacity: 0.6;\r\n          overflow: hidden;\r\n          text-overflow: ellipsis;\r\n          white-space: nowrap;\r\n          flex: 1;\r\n        }\r\n        .match-count {\r\n          font-size: 11px;\r\n          opacity: 0.6;\r\n        }\r\n        .result-match {\r\n          gap: 12px;\r\n          padding: 2px 24px;\r\n          font-family: var(--font-mono, monospace);\r\n          font-size: 12px;\r\n        }\r\n        .line-number {\r\n          opacity: 0.5;\r\n          min-width: 32px;\r\n          text-align: right;\r\n        }\r\n        .match-content {\r\n          overflow: hidden;\r\n          text-overflow: ellipsis;\r\n          white-space: nowrap;\r\n        }\r\n        .highlight {\r\n          background: rgba(255, 255, 0, 0.2);\r\n          color: #ffca28;\r\n        }\r\n        .no-results {\r\n          padding: 20px;\r\n          text-align: center;\r\n          opacity: 0.5;\r\n        }\r\n      `}</style>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\ide\\Terminal.tsx","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":149,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":149,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[5170,5208],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\nimport { useRef, useState, useCallback, useEffect } from 'react'\nimport { TerminalProps, ContextMenuState } from './terminal/types'\nimport { useTerminalManager } from './terminal/useTerminalManager'\nimport { useTerminalSession } from './terminal/useTerminalSession'\nimport { useTerminalIO } from './terminal/useTerminalIO'\nimport { TerminalHeader } from './terminal/TerminalHeader'\nimport { TerminalSearch } from './terminal/TerminalSearch'\nimport { TerminalContextMenu } from './terminal/TerminalContextMenu'\nimport { TerminalStatusBar } from './terminal/TerminalStatusBar'\nimport { CommandPalette } from './terminal/CommandPalette'\nimport '@xterm/xterm/css/xterm.css'\n\n// Command history item type\ninterface CommandHistoryItem {\n    command: string\n    timestamp: number\n    exitCode?: number\n    frequency: number\n    isBookmarked?: boolean\n}\n\nexport default function Terminal({ cwd }: Readonly<TerminalProps>) {\n    const containerRef = useRef<HTMLDivElement>(null)\n    const [searchVisible, setSearchVisible] = useState(false)\n    const [commandPaletteOpen, setCommandPaletteOpen] = useState(false)\n    const [contextMenu, setContextMenu] = useState<ContextMenuState>({\n        visible: false,\n        x: 0,\n        y: 0\n    })\n\n    // Terminal state\n    const [commandHistory, setCommandHistory] = useState<CommandHistoryItem[]>([])\n    const [bookmarks, setBookmarks] = useState<string[]>([])\n    const [isConnected, setIsConnected] = useState(false)\n    const [commandCount, setCommandCount] = useState(0)\n    const [lastExitCode] = useState<number | undefined>()\n    const [isRunning] = useState(false)\n\n    // Terminal tab management\n    const {\n        tabs,\n        activeTabId,\n        addTab,\n        closeTab,\n        switchTab\n    } = useTerminalManager()\n\n    // Terminal session management (xterm instances)\n    const {\n        getCurrentTerminal,\n        destroyTerminal,\n        clearTerminal\n    } = useTerminalSession(containerRef, activeTabId, tabs, cwd)\n\n    // Terminal I/O handling\n    useTerminalIO(getCurrentTerminal, activeTabId)\n\n    // Track connection status based on active tab\n    useEffect(() => {\n        if (activeTabId && tabs.length > 0) {\n            setIsConnected(true)\n        } else {\n            setIsConnected(false)\n        }\n    }, [activeTabId, tabs.length])\n\n    // Handle context menu\n    useEffect(() => {\n        const container = containerRef.current\n        if (!container) return\n\n        const handleContextMenu = (e: MouseEvent) => {\n            e.preventDefault()\n            setContextMenu({\n                visible: true,\n                x: e.clientX,\n                y: e.clientY\n            })\n        }\n\n        const handleClick = () => {\n            if (contextMenu.visible) {\n                setContextMenu({ visible: false, x: 0, y: 0 })\n            }\n        }\n\n        container.addEventListener('contextmenu', handleContextMenu)\n        document.addEventListener('click', handleClick)\n\n        return () => {\n            container.removeEventListener('contextmenu', handleContextMenu)\n            document.removeEventListener('click', handleClick)\n        }\n    }, [contextMenu.visible])\n\n    // Handle keyboard shortcuts\n    useEffect(() => {\n        const handleKeyDown = (e: KeyboardEvent) => {\n            // Ctrl+Shift+F - Toggle search\n            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'F') {\n                e.preventDefault()\n                setSearchVisible(prev => !prev)\n            }\n            // Ctrl+K - Clear terminal\n            if ((e.ctrlKey || e.metaKey) && e.key === 'k' && !e.shiftKey) {\n                e.preventDefault()\n                handleClearTerminal()\n            }\n            // Ctrl+Shift+P - Command palette\n            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'P') {\n                e.preventDefault()\n                setCommandPaletteOpen(prev => !prev)\n            }\n            // Ctrl+Shift+T - New terminal\n            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'T') {\n                e.preventDefault()\n                addTab()\n            }\n            // Escape - Close modals\n            if (e.key === 'Escape') {\n                if (searchVisible) setSearchVisible(false)\n                if (commandPaletteOpen) setCommandPaletteOpen(false)\n            }\n        }\n\n        window.addEventListener('keydown', handleKeyDown)\n        return () => window.removeEventListener('keydown', handleKeyDown)\n    }, [searchVisible, commandPaletteOpen, addTab])\n\n    // Context menu handlers\n    const handleCopy = useCallback(async () => {\n        const instance = getCurrentTerminal()\n        const selection = instance?.xterm?.getSelection()\n        if (selection) {\n            await navigator.clipboard.writeText(selection)\n        }\n        setContextMenu({ visible: false, x: 0, y: 0 })\n    }, [getCurrentTerminal])\n\n    const handlePaste = useCallback(async () => {\n        try {\n            const text = await navigator.clipboard.readText()\n            window.electronAPI?.terminal.write({ id: activeTabId, data: text })\n        } catch (err) {\n            console.error('Failed to paste:', err)\n        }\n        setContextMenu({ visible: false, x: 0, y: 0 })\n    }, [activeTabId])\n\n    const handleClearTerminal = useCallback(() => {\n        clearTerminal()\n        setContextMenu({ visible: false, x: 0, y: 0 })\n    }, [clearTerminal])\n\n    const handleCloseTab = useCallback((id: string) => {\n        destroyTerminal(id)\n        closeTab(id)\n    }, [closeTab, destroyTerminal])\n\n    // Command palette handlers\n    const handleSelectCommand = useCallback((command: string) => {\n        window.electronAPI?.terminal.write({ id: activeTabId, data: command + '\\n' })\n        setCommandCount(prev => prev + 1)\n    }, [activeTabId])\n\n    const handleBookmark = useCallback((command: string) => {\n        setBookmarks(prev => {\n            if (prev.includes(command)) {\n                return prev.filter(c => c !== command)\n            }\n            return [...prev, command]\n        })\n        setCommandHistory(prev => prev.map(item =>\n            item.command === command\n                ? { ...item, isBookmarked: !item.isBookmarked }\n                : item\n        ))\n    }, [])\n\n    const currentTab = tabs.find(t => t.id === activeTabId)\n\n    return (\n        <div style={{\n            display: 'flex',\n            flexDirection: 'column',\n            height: '100%',\n            width: '100%',\n            flex: 1,\n            background: 'linear-gradient(180deg, #09090b 0%, #000000 100%)',\n            fontFamily: \"'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif\",\n            position: 'relative',\n            borderRadius: '12px',\n            overflow: 'hidden',\n            border: '1px solid rgba(139, 92, 246, 0.1)',\n            boxShadow: '0 4px 24px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.03)'\n        }}>\n            {/* Header with tabs and actions */}\n            <TerminalHeader\n                tabs={tabs}\n                activeTabId={activeTabId}\n                onSwitchTab={switchTab}\n                onCloseTab={handleCloseTab}\n                onAddTab={addTab}\n                onToggleSearch={() => setSearchVisible(!searchVisible)}\n                onClearTerminal={handleClearTerminal}\n                searchVisible={searchVisible}\n            />\n\n            {/* Search bar */}\n            {searchVisible && (\n                <TerminalSearch\n                    searchAddon={getCurrentTerminal()?.searchAddon || null}\n                    onClose={() => setSearchVisible(false)}\n                />\n            )}\n\n            {/* Terminal container */}\n            <div\n                ref={containerRef}\n                style={{\n                    flex: 1,\n                    padding: '8px',\n                    overflow: 'hidden',\n                    position: 'relative'\n                }}\n            />\n\n            {/* Status bar */}\n            <TerminalStatusBar\n                shell={currentTab?.shell}\n                cwd={cwd}\n                isRunning={isRunning}\n                lastExitCode={lastExitCode}\n                commandCount={commandCount}\n                isConnected={isConnected}\n            />\n\n            {/* Context menu */}\n            <TerminalContextMenu\n                contextMenu={contextMenu}\n                onCopy={handleCopy}\n                onPaste={handlePaste}\n                onClear={handleClearTerminal}\n            />\n\n            {/* Command palette */}\n            <CommandPalette\n                isOpen={commandPaletteOpen}\n                onClose={() => setCommandPaletteOpen(false)}\n                onSelectCommand={handleSelectCommand}\n                history={commandHistory}\n                bookmarks={bookmarks}\n                onBookmark={handleBookmark}\n            />\n        </div>\n    )\n}\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\ide\\terminal\\CommandBlock.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\ide\\terminal\\CommandPalette.tsx","messages":[{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":114,"column":17,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":114,"endColumn":91},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":115,"column":17,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":115,"endColumn":61},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":222,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":222,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8004,8007],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8004,8007],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n\r\nimport React, { useState, useCallback, useEffect, useRef } from 'react'\r\nimport {\r\n    Search,\r\n    Clock,\r\n    Star,\r\n    Sparkles,\r\n    ArrowUp,\r\n    ArrowDown,\r\n    CornerDownLeft,\r\n    Command,\r\n    Bookmark\r\n} from 'lucide-react'\r\n\r\ninterface CommandHistoryItem {\r\n    command: string\r\n    timestamp: number\r\n    exitCode?: number\r\n    frequency: number\r\n    isBookmarked?: boolean\r\n}\r\n\r\ninterface CommandPaletteProps {\r\n    isOpen: boolean\r\n    onClose: () => void\r\n    onSelectCommand: (command: string) => void\r\n    history: CommandHistoryItem[]\r\n    bookmarks: string[]\r\n    onBookmark: (command: string) => void\r\n}\r\n\r\nexport const CommandPalette: React.FC<CommandPaletteProps> = ({\r\n    isOpen,\r\n    onClose,\r\n    onSelectCommand,\r\n    history,\r\n    bookmarks: _bookmarks,\r\n    onBookmark\r\n}) => {\r\n    const [query, setQuery] = useState('')\r\n    const [selectedIndex, setSelectedIndex] = useState(0)\r\n    const [activeTab, setActiveTab] = useState<'all' | 'bookmarks' | 'ai'>('all')\r\n    const inputRef = useRef<HTMLInputElement>(null)\r\n\r\n    // Filter commands based on query\r\n    const filteredCommands = history.filter(item =>\r\n        item.command.toLowerCase().includes(query.toLowerCase())\r\n    ).sort((a, b) => {\r\n        // Bookmarked first, then by frequency, then by recency\r\n        if (a.isBookmarked && !b.isBookmarked) return -1\r\n        if (!a.isBookmarked && b.isBookmarked) return 1\r\n        if (a.frequency !== b.frequency) return b.frequency - a.frequency\r\n        return b.timestamp - a.timestamp\r\n    })\r\n\r\n    const bookmarkedCommands = filteredCommands.filter(c => c.isBookmarked)\r\n\r\n    const displayCommands = activeTab === 'bookmarks'\r\n        ? bookmarkedCommands\r\n        : filteredCommands\r\n\r\n    // AI suggestions placeholder\r\n    const aiSuggestions = [\r\n        'git status',\r\n        'npm run build',\r\n        'docker ps -a',\r\n        'kubectl get pods'\r\n    ].filter(s => s.toLowerCase().includes(query.toLowerCase()))\r\n\r\n    useEffect(() => {\r\n        if (isOpen) {\r\n            inputRef.current?.focus()\r\n            setQuery('')\r\n            setSelectedIndex(0)\r\n        }\r\n    }, [isOpen])\r\n\r\n    const handleKeyDown = useCallback((e: React.KeyboardEvent) => {\r\n        const maxIndex = activeTab === 'ai'\r\n            ? aiSuggestions.length - 1\r\n            : displayCommands.length - 1\r\n\r\n        switch (e.key) {\r\n            case 'ArrowDown':\r\n                e.preventDefault()\r\n                setSelectedIndex(prev => Math.min(prev + 1, maxIndex))\r\n                break\r\n            case 'ArrowUp':\r\n                e.preventDefault()\r\n                setSelectedIndex(prev => Math.max(prev - 1, 0))\r\n                break\r\n            case 'Enter':\r\n                e.preventDefault()\r\n                if (activeTab === 'ai') {\r\n                    if (aiSuggestions[selectedIndex]) {\r\n                        onSelectCommand(aiSuggestions[selectedIndex])\r\n                        onClose()\r\n                    }\r\n                } else {\r\n                    if (displayCommands[selectedIndex]) {\r\n                        onSelectCommand(displayCommands[selectedIndex].command)\r\n                        onClose()\r\n                    }\r\n                }\r\n                break\r\n            case 'Escape':\r\n                onClose()\r\n                break\r\n            case 'Tab':\r\n                e.preventDefault()\r\n                const tabs: Array<'all' | 'bookmarks' | 'ai'> = ['all', 'bookmarks', 'ai']\r\n                const currentIndex = tabs.indexOf(activeTab)\r\n                setActiveTab(tabs[(currentIndex + 1) % tabs.length])\r\n                setSelectedIndex(0)\r\n                break\r\n        }\r\n    }, [activeTab, displayCommands, aiSuggestions, selectedIndex, onSelectCommand, onClose])\r\n\r\n    if (!isOpen) return null\r\n\r\n    const formatTime = (timestamp: number) => {\r\n        const diff = Date.now() - timestamp\r\n        const mins = Math.floor(diff / 60000)\r\n        const hours = Math.floor(diff / 3600000)\r\n        const days = Math.floor(diff / 86400000)\r\n\r\n        if (days > 0) return `${days}d ago`\r\n        if (hours > 0) return `${hours}h ago`\r\n        if (mins > 0) return `${mins}m ago`\r\n        return 'just now'\r\n    }\r\n\r\n    return (\r\n        <div style={{\r\n            position: 'fixed',\r\n            inset: 0,\r\n            background: 'rgba(0, 0, 0, 0.6)',\r\n            backdropFilter: 'blur(4px)',\r\n            display: 'flex',\r\n            alignItems: 'flex-start',\r\n            justifyContent: 'center',\r\n            paddingTop: '100px',\r\n            zIndex: 1000\r\n        }} onClick={onClose}>\r\n            <div\r\n                onClick={e => e.stopPropagation()}\r\n                style={{\r\n                    width: '600px',\r\n                    maxHeight: '500px',\r\n                    background: 'linear-gradient(180deg, rgba(24, 24, 27, 0.98) 0%, rgba(9, 9, 11, 0.99) 100%)',\r\n                    backdropFilter: 'blur(20px)',\r\n                    borderRadius: '16px',\r\n                    border: '1px solid rgba(139, 92, 246, 0.2)',\r\n                    boxShadow: '0 24px 48px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.03)',\r\n                    overflow: 'hidden',\r\n                    display: 'flex',\r\n                    flexDirection: 'column'\r\n                }}\r\n            >\r\n                {/* Search Header */}\r\n                <div style={{\r\n                    display: 'flex',\r\n                    alignItems: 'center',\r\n                    padding: '14px 16px',\r\n                    borderBottom: '1px solid rgba(255, 255, 255, 0.06)',\r\n                    gap: '12px'\r\n                }}>\r\n                    <Search size={18} style={{ color: '#71717a' }} />\r\n                    <input\r\n                        ref={inputRef}\r\n                        type=\"text\"\r\n                        value={query}\r\n                        onChange={e => {\r\n                            setQuery(e.target.value)\r\n                            setSelectedIndex(0)\r\n                        }}\r\n                        onKeyDown={handleKeyDown}\r\n                        placeholder=\"Search commands...\"\r\n                        style={{\r\n                            flex: 1,\r\n                            background: 'transparent',\r\n                            border: 'none',\r\n                            outline: 'none',\r\n                            color: '#e4e4e7',\r\n                            fontSize: '15px',\r\n                            fontFamily: \"'JetBrains Mono', monospace\"\r\n                        }}\r\n                    />\r\n                    <div style={{\r\n                        display: 'flex',\r\n                        alignItems: 'center',\r\n                        gap: '4px',\r\n                        padding: '4px 8px',\r\n                        background: 'rgba(255, 255, 255, 0.05)',\r\n                        borderRadius: '6px',\r\n                        fontSize: '11px',\r\n                        color: '#71717a'\r\n                    }}>\r\n                        <Command size={10} />\r\n                        <span>P</span>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Tabs */}\r\n                <div style={{\r\n                    display: 'flex',\r\n                    padding: '8px 16px',\r\n                    gap: '8px',\r\n                    borderBottom: '1px solid rgba(255, 255, 255, 0.04)'\r\n                }}>\r\n                    {[\r\n                        { id: 'all', label: 'All', icon: Clock, count: filteredCommands.length },\r\n                        { id: 'bookmarks', label: 'Bookmarks', icon: Star, count: bookmarkedCommands.length },\r\n                        { id: 'ai', label: 'AI Suggest', icon: Sparkles, count: aiSuggestions.length }\r\n                    ].map(tab => (\r\n                        <button\r\n                            key={tab.id}\r\n                            onClick={() => {\r\n                                setActiveTab(tab.id as any)\r\n                                setSelectedIndex(0)\r\n                            }}\r\n                            style={{\r\n                                display: 'flex',\r\n                                alignItems: 'center',\r\n                                gap: '6px',\r\n                                padding: '6px 12px',\r\n                                background: activeTab === tab.id\r\n                                    ? 'rgba(139, 92, 246, 0.15)'\r\n                                    : 'transparent',\r\n                                border: activeTab === tab.id\r\n                                    ? '1px solid rgba(139, 92, 246, 0.3)'\r\n                                    : '1px solid transparent',\r\n                                borderRadius: '8px',\r\n                                color: activeTab === tab.id ? '#a78bfa' : '#71717a',\r\n                                cursor: 'pointer',\r\n                                fontSize: '12px',\r\n                                fontWeight: 500,\r\n                                transition: 'all 0.15s ease'\r\n                            }}\r\n                        >\r\n                            <tab.icon size={12} />\r\n                            {tab.label}\r\n                            <span style={{\r\n                                padding: '1px 5px',\r\n                                background: 'rgba(255, 255, 255, 0.05)',\r\n                                borderRadius: '8px',\r\n                                fontSize: '10px'\r\n                            }}>\r\n                                {tab.count}\r\n                            </span>\r\n                        </button>\r\n                    ))}\r\n                </div>\r\n\r\n                {/* Command List */}\r\n                <div style={{\r\n                    flex: 1,\r\n                    overflowY: 'auto',\r\n                    padding: '8px'\r\n                }}>\r\n                    {activeTab === 'ai' ? (\r\n                        // AI Suggestions\r\n                        aiSuggestions.map((suggestion, index) => (\r\n                            <div\r\n                                key={suggestion}\r\n                                onClick={() => {\r\n                                    onSelectCommand(suggestion)\r\n                                    onClose()\r\n                                }}\r\n                                style={{\r\n                                    display: 'flex',\r\n                                    alignItems: 'center',\r\n                                    padding: '10px 12px',\r\n                                    borderRadius: '8px',\r\n                                    cursor: 'pointer',\r\n                                    background: selectedIndex === index\r\n                                        ? 'rgba(139, 92, 246, 0.15)'\r\n                                        : 'transparent',\r\n                                    gap: '10px',\r\n                                    transition: 'background 0.1s ease'\r\n                                }}\r\n                            >\r\n                                <Sparkles size={14} style={{ color: '#a78bfa' }} />\r\n                                <span style={{\r\n                                    fontFamily: \"'JetBrains Mono', monospace\",\r\n                                    fontSize: '13px',\r\n                                    color: '#e4e4e7'\r\n                                }}>\r\n                                    {suggestion}\r\n                                </span>\r\n                            </div>\r\n                        ))\r\n                    ) : (\r\n                        // History/Bookmarks\r\n                        displayCommands.slice(0, 20).map((item, index) => (\r\n                            <div\r\n                                key={item.command + item.timestamp}\r\n                                onClick={() => {\r\n                                    onSelectCommand(item.command)\r\n                                    onClose()\r\n                                }}\r\n                                style={{\r\n                                    display: 'flex',\r\n                                    alignItems: 'center',\r\n                                    padding: '10px 12px',\r\n                                    borderRadius: '8px',\r\n                                    cursor: 'pointer',\r\n                                    background: selectedIndex === index\r\n                                        ? 'rgba(139, 92, 246, 0.15)'\r\n                                        : 'transparent',\r\n                                    gap: '10px',\r\n                                    transition: 'background 0.1s ease'\r\n                                }}\r\n                            >\r\n                                <span style={{ color: '#a78bfa' }}>$</span>\r\n                                <span style={{\r\n                                    flex: 1,\r\n                                    fontFamily: \"'JetBrains Mono', monospace\",\r\n                                    fontSize: '13px',\r\n                                    color: '#e4e4e7',\r\n                                    overflow: 'hidden',\r\n                                    textOverflow: 'ellipsis',\r\n                                    whiteSpace: 'nowrap'\r\n                                }}>\r\n                                    {item.command}\r\n                                </span>\r\n                                {item.isBookmarked && (\r\n                                    <Star size={12} style={{ color: '#fbbf24', fill: '#fbbf24' }} />\r\n                                )}\r\n                                <span style={{\r\n                                    fontSize: '10px',\r\n                                    color: '#52525b',\r\n                                    whiteSpace: 'nowrap'\r\n                                }}>\r\n                                    {formatTime(item.timestamp)}\r\n                                </span>\r\n                                <button\r\n                                    onClick={(e) => {\r\n                                        e.stopPropagation()\r\n                                        onBookmark(item.command)\r\n                                    }}\r\n                                    style={{\r\n                                        background: 'transparent',\r\n                                        border: 'none',\r\n                                        padding: '4px',\r\n                                        cursor: 'pointer',\r\n                                        color: item.isBookmarked ? '#fbbf24' : '#52525b',\r\n                                        display: 'flex'\r\n                                    }}\r\n                                >\r\n                                    <Bookmark size={12} />\r\n                                </button>\r\n                            </div>\r\n                        ))\r\n                    )}\r\n\r\n                    {displayCommands.length === 0 && activeTab !== 'ai' && (\r\n                        <div style={{\r\n                            padding: '24px',\r\n                            textAlign: 'center',\r\n                            color: '#52525b',\r\n                            fontSize: '13px'\r\n                        }}>\r\n                            No commands found\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                {/* Footer */}\r\n                <div style={{\r\n                    display: 'flex',\r\n                    alignItems: 'center',\r\n                    justifyContent: 'space-between',\r\n                    padding: '10px 16px',\r\n                    borderTop: '1px solid rgba(255, 255, 255, 0.04)',\r\n                    fontSize: '11px',\r\n                    color: '#52525b'\r\n                }}>\r\n                    <div style={{ display: 'flex', gap: '12px' }}>\r\n                        <span style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>\r\n                            <ArrowUp size={10} />\r\n                            <ArrowDown size={10} />\r\n                            navigate\r\n                        </span>\r\n                        <span style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>\r\n                            <CornerDownLeft size={10} />\r\n                            select\r\n                        </span>\r\n                        <span>Tab switch</span>\r\n                    </div>\r\n                    <span>esc to close</span>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\ide\\terminal\\TerminalContextMenu.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\ide\\terminal\\TerminalHeader.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\ide\\terminal\\TerminalSearch.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":9,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":9,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[212,215],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[212,215],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-expressions","severity":2,"message":"Expected an assignment or function call and instead saw an expression.","line":50,"column":25,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":50,"endColumn":65}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n\r\nimport React, { useState, useEffect } from 'react'\r\nimport { ArrowUp, ArrowDown, X } from 'lucide-react'\r\n\r\ninterface TerminalSearchProps {\r\n    searchAddon: any // SearchAddon\r\n    onClose: () => void\r\n}\r\n\r\nexport const TerminalSearch: React.FC<TerminalSearchProps> = ({ searchAddon, onClose }) => {\r\n    const [term, setTerm] = useState('')\r\n\r\n    useEffect(() => {\r\n        if (!searchAddon) return\r\n        if (term) {\r\n            searchAddon.findNext(term)\r\n        }\r\n    }, [term, searchAddon])\r\n\r\n    const findNext = () => searchAddon?.findNext(term)\r\n    const findPrevious = () => searchAddon?.findPrevious(term)\r\n\r\n    return (\r\n        <div style={{\r\n            position: 'absolute',\r\n            top: '48px',\r\n            right: '16px',\r\n            zIndex: 10,\r\n            background: 'linear-gradient(135deg, rgba(24, 24, 27, 0.95) 0%, rgba(0, 0, 0, 0.98) 100%)',\r\n            backdropFilter: 'blur(16px)',\r\n            padding: '8px',\r\n            borderRadius: '10px',\r\n            boxShadow: '0 8px 32px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.05)',\r\n            display: 'flex',\r\n            alignItems: 'center',\r\n            gap: '6px',\r\n            border: '1px solid rgba(139, 92, 246, 0.2)'\r\n        }}>\r\n            <input\r\n                autoFocus\r\n                type=\"text\"\r\n                value={term}\r\n                onChange={(e) => setTerm(e.target.value)}\r\n                placeholder=\"Find...\"\r\n                onKeyDown={(e) => {\r\n                    if (e.key === 'Enter') {\r\n                        e.shiftKey ? findPrevious() : findNext()\r\n                    }\r\n                    if (e.key === 'Escape') onClose()\r\n                }}\r\n                style={{\r\n                    background: 'rgba(255, 255, 255, 0.05)',\r\n                    border: '1px solid rgba(139, 92, 246, 0.3)',\r\n                    color: '#e4e4e7',\r\n                    padding: '6px 12px',\r\n                    borderRadius: '6px',\r\n                    outline: 'none',\r\n                    fontSize: '13px',\r\n                    width: '180px',\r\n                    fontFamily: 'inherit',\r\n                    transition: 'all 0.2s ease'\r\n                }}\r\n            />\r\n            <button\r\n                onClick={findPrevious}\r\n                style={{\r\n                    background: 'rgba(255, 255, 255, 0.05)',\r\n                    border: 'none',\r\n                    borderRadius: '6px',\r\n                    cursor: 'pointer',\r\n                    color: '#a1a1aa',\r\n                    padding: '6px',\r\n                    display: 'flex',\r\n                    transition: 'all 0.15s ease'\r\n                }}\r\n                title=\"Previous (Shift+Enter)\"\r\n                onMouseOver={(e) => e.currentTarget.style.color = '#a78bfa'}\r\n                onMouseOut={(e) => e.currentTarget.style.color = '#a1a1aa'}\r\n            >\r\n                <ArrowUp size={16} />\r\n            </button>\r\n            <button\r\n                onClick={findNext}\r\n                style={{\r\n                    background: 'rgba(255, 255, 255, 0.05)',\r\n                    border: 'none',\r\n                    borderRadius: '6px',\r\n                    cursor: 'pointer',\r\n                    color: '#a1a1aa',\r\n                    padding: '6px',\r\n                    display: 'flex',\r\n                    transition: 'all 0.15s ease'\r\n                }}\r\n                title=\"Next (Enter)\"\r\n                onMouseOver={(e) => e.currentTarget.style.color = '#a78bfa'}\r\n                onMouseOut={(e) => e.currentTarget.style.color = '#a1a1aa'}\r\n            >\r\n                <ArrowDown size={16} />\r\n            </button>\r\n            <button\r\n                onClick={onClose}\r\n                style={{\r\n                    background: 'rgba(255, 255, 255, 0.05)',\r\n                    border: 'none',\r\n                    borderRadius: '6px',\r\n                    cursor: 'pointer',\r\n                    color: '#a1a1aa',\r\n                    padding: '6px',\r\n                    display: 'flex',\r\n                    transition: 'all 0.15s ease'\r\n                }}\r\n                title=\"Close (Escape)\"\r\n                onMouseOver={(e) => e.currentTarget.style.color = '#f87171'}\r\n                onMouseOut={(e) => e.currentTarget.style.color = '#a1a1aa'}\r\n            >\r\n                <X size={16} />\r\n            </button>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\ide\\terminal\\TerminalSplitView.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\ide\\terminal\\TerminalStatusBar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\ide\\terminal\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\ide\\terminal\\useTerminalIO.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\ide\\terminal\\useTerminalManager.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\ide\\terminal\\useTerminalSession.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":46,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":46,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[1862,1923],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":117,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":117,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[4277,4326],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":194,"column":58,"nodeType":"MemberExpression","messageId":"unexpected","endLine":194,"endColumn":71}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n\r\nimport { useEffect, useRef, useCallback } from 'react'\r\nimport { Terminal } from '@xterm/xterm'\r\nimport { FitAddon } from '@xterm/addon-fit'\r\nimport { SearchAddon } from '@xterm/addon-search'\r\nimport { WebLinksAddon } from '@xterm/addon-web-links'\r\nimport { Unicode11Addon } from '@xterm/addon-unicode11'\r\nimport { TerminalTab, TerminalState, DEFAULT_THEME } from './types'\r\n\r\nexport function useTerminalSession(\r\n    containerRef: React.RefObject<HTMLDivElement>,\r\n    activeTabId: string,\r\n    tabs: TerminalTab[],\r\n    initialCwd?: string\r\n) {\r\n    const terminals = useRef<Map<string, TerminalState>>(new Map())\r\n    const terminalElements = useRef<Map<string, HTMLDivElement>>(new Map()) // Store DOM elements\r\n    const resizeObserver = useRef<ResizeObserver | null>(null)\r\n    const dataListenerSet = useRef(false)\r\n\r\n    // Helper to get current terminal instance\r\n    const getCurrentTerminal = useCallback((): TerminalState | null => {\r\n        return terminals.current.get(activeTabId) || null\r\n    }, [activeTabId])\r\n\r\n    // Setup global data listener once\r\n    useEffect(() => {\r\n        if (dataListenerSet.current) return\r\n        dataListenerSet.current = true\r\n\r\n        // Handle output from backend - routes to correct terminal\r\n        window.electronAPI?.terminal.onData((data: { id: string; data: string; type: string }) => {\r\n            const { id, data: output } = data\r\n            const terminal = terminals.current.get(id)\r\n            if (terminal?.xterm) {\r\n                terminal.xterm.write(output)\r\n            }\r\n        })\r\n\r\n        // Handle spawned event\r\n        window.electronAPI?.terminal.onSpawned((data: { id: string; pid: number; title: string; cwd: string; shell: string }) => {\r\n            // Tab spawned notification - can update UI if needed\r\n            console.log('[Terminal] Spawned:', data.id, 'PID:', data.pid)\r\n        })\r\n\r\n        // Cleanup on unmount\r\n        return () => {\r\n            window.electronAPI?.terminal.removeListeners()\r\n            dataListenerSet.current = false\r\n        }\r\n    }, [])\r\n\r\n    // Create terminal instance\r\n    const createTerminal = useCallback(async (tabId: string) => {\r\n        if (terminals.current.has(tabId)) return terminals.current.get(tabId)\r\n\r\n        const term = new Terminal({\r\n            fontFamily: \"'JetBrains Mono', 'Fira Code', monospace\",\r\n            fontSize: 14,\r\n            cursorBlink: true,\r\n            theme: DEFAULT_THEME,\r\n            allowProposedApi: true\r\n        })\r\n\r\n        const fitAddon = new FitAddon()\r\n        const searchAddon = new SearchAddon()\r\n        const webLinksAddon = new WebLinksAddon()\r\n        const unicode11Addon = new Unicode11Addon()\r\n\r\n        term.loadAddon(fitAddon)\r\n        term.loadAddon(searchAddon)\r\n        term.loadAddon(webLinksAddon)\r\n        term.loadAddon(unicode11Addon)\r\n        term.options.allowProposedApi = true\r\n        term.unicode.activeVersion = '11'\r\n\r\n        // Create a dedicated element for this terminal\r\n        const terminalElement = document.createElement('div')\r\n        terminalElement.style.width = '100%'\r\n        terminalElement.style.height = '100%'\r\n        terminalElements.current.set(tabId, terminalElement)\r\n\r\n        terminals.current.set(tabId, {\r\n            xterm: term,\r\n            fitAddon,\r\n            searchAddon,\r\n            webLinksAddon,\r\n            unicode11Addon,\r\n            element: terminalElement // Store element reference\r\n        })\r\n\r\n        // Spawn backend process\r\n        const tab = tabs.find(t => t.id === tabId)\r\n        try {\r\n            await window.electronAPI?.terminal.spawn({\r\n                id: tabId,\r\n                cwd: tab?.cwd || initialCwd,\r\n                shell: tab?.shell,\r\n                cols: term.cols,\r\n                rows: term.rows\r\n            })\r\n\r\n            // Handle resize - send to backend\r\n            term.onResize(({ cols, rows }) => {\r\n                window.electronAPI?.terminal.resize({ id: tabId, cols, rows })\r\n            })\r\n\r\n            // Handle input - send to backend\r\n            term.onData(data => {\r\n                window.electronAPI?.terminal.write({ id: tabId, data })\r\n            })\r\n\r\n        } catch (error) {\r\n            console.error('Failed to spawn terminal:', error)\r\n            term.write('\\r\\nFailed to start terminal session.\\r\\n')\r\n        }\r\n\r\n        return terminals.current.get(tabId)\r\n    }, [tabs, initialCwd])\r\n\r\n    // Effect to mount/unmount terminal in container\r\n    useEffect(() => {\r\n        const container = containerRef.current\r\n        if (!container || !activeTabId) return\r\n\r\n        // Create terminal if not exists\r\n        if (!terminals.current.has(activeTabId)) {\r\n            createTerminal(activeTabId).then(terminal => {\r\n                if (terminal && container) {\r\n                    // Open terminal in its element (only once!)\r\n                    terminal.xterm?.open(terminal.element)\r\n\r\n                    // NOTE: Direct DOM manipulation is intentional here\r\n                    // React doesn't manage xterm elements, so manual DOM ops are safe\r\n                    // Clear container and append terminal element\r\n                    while (container.firstChild) {\r\n                        container.removeChild(container.firstChild)\r\n                    }\r\n                    container.appendChild(terminal.element)\r\n\r\n                    terminal.fitAddon?.fit()\r\n                    terminal.xterm?.focus()\r\n                }\r\n            })\r\n        } else {\r\n            // Reattach existing terminal by moving its element\r\n            const terminal = terminals.current.get(activeTabId)\r\n            if (terminal && terminal.element) {\r\n                // Clear container (safe - xterm manages its own internals)\r\n                while (container.firstChild) {\r\n                    container.removeChild(container.firstChild)\r\n                }\r\n\r\n                // Append existing terminal element\r\n                container.appendChild(terminal.element)\r\n                terminal.fitAddon?.fit()\r\n                terminal.xterm?.focus()\r\n            }\r\n        }\r\n\r\n        // SECURITY FIX: Setup/cleanup resize observer properly to prevent memory leaks\r\n        if (!resizeObserver.current) {\r\n            resizeObserver.current = new ResizeObserver(() => {\r\n                const terminal = terminals.current.get(activeTabId)\r\n                terminal?.fitAddon?.fit()\r\n            })\r\n        }\r\n        // Observe the current container\r\n        resizeObserver.current.observe(container)\r\n\r\n        return () => {\r\n            // Cleanup: unobserve container when active tab changes\r\n            if (resizeObserver.current && container) {\r\n                resizeObserver.current.unobserve(container)\r\n            }\r\n        }\r\n    }, [activeTabId, createTerminal, containerRef])\r\n\r\n    const destroyTerminal = useCallback((id: string) => {\r\n        const terminal = terminals.current.get(id)\r\n        if (terminal) {\r\n            terminal.xterm?.dispose()\r\n            terminals.current.delete(id)\r\n\r\n            // Clean up element\r\n            const element = terminalElements.current.get(id)\r\n            element?.remove()\r\n            terminalElements.current.delete(id)\r\n\r\n            // SECURITY FIX: Add optional chaining to prevent crash\r\n            window.electronAPI?.terminal?.kill(id).catch(console.error)\r\n        }\r\n    }, [])\r\n\r\n    const clearTerminal = useCallback(() => {\r\n        const terminal = terminals.current.get(activeTabId)\r\n        terminal?.xterm?.clear()\r\n    }, [activeTabId])\r\n\r\n    return {\r\n        getCurrentTerminal,\r\n        destroyTerminal,\r\n        clearTerminal\r\n    }\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\workspaces\\ResearchWorkspace.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\components\\workspaces\\WorkspaceRouter.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\config\\api.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\config\\constants.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\config\\editorModes.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\config\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\hooks\\useAI.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\hooks\\useAgent.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\hooks\\useEncryption.tsx","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":64,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":64,"endColumn":34,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[2023,2087],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n// useEncryption - Centralized encryption hook for app-wide E2E encryption\r\n// Fixed: Uses LRU cache, network-layer encryption, no raw password storage\r\n\r\nimport { useState, useEffect, useCallback, createContext, useContext, ReactNode } from 'react'\r\nimport {\r\n    isRoomEncryptionReady,\r\n    getRoomEncryptionState,\r\n    LRUCache,\r\n    decryptionCache\r\n} from '../services/encryptedProvider'\r\n\r\n// Encryption context for the entire app\r\ninterface EncryptionContextType {\r\n    isEnabled: boolean\r\n    isReady: boolean\r\n    roomId: string | null\r\n    getEncryptionStatus: () => EncryptionStatus\r\n}\r\n\r\ninterface EncryptionStatus {\r\n    enabled: boolean\r\n    algorithm: string\r\n    keyStrength: number\r\n    ready: boolean\r\n}\r\n\r\nconst EncryptionContext = createContext<EncryptionContextType | null>(null)\r\n\r\n// Provider component for encryption context\r\n// Note: Actual encryption happens at network layer in encryptedProvider.ts\r\nexport function EncryptionProvider({\r\n    children,\r\n    spaceId\r\n}: {\r\n    children: ReactNode\r\n    spaceId: string | null\r\n}) {\r\n    const [isEnabled, setIsEnabled] = useState(false)\r\n    const [isReady, setIsReady] = useState(false)\r\n\r\n    // Check encryption state (key is derived in useYjs, not here)\r\n    useEffect(() => {\r\n        if (!spaceId) {\r\n            setIsEnabled(false)\r\n            setIsReady(false)\r\n            return\r\n        }\r\n\r\n        // Clear cache when space changes\r\n        decryptionCache.clear()\r\n\r\n        // Check if encryption is configured for this space\r\n        const checkEncryption = () => {\r\n            const settings = localStorage.getItem(`space-settings-${spaceId}`)\r\n            if (settings) {\r\n                try {\r\n                    const parsed = JSON.parse(settings)\r\n                    // Only check if settings exist, key derivation happens in useYjs\r\n                    setIsEnabled(parsed.encryptionEnabled && !!parsed.roomPassword)\r\n                } catch (e) {\r\n                    console.error('[Encryption] Failed to parse space settings:', e)\r\n                    setIsEnabled(false)\r\n                }\r\n            }\r\n            setIsReady(true)\r\n        }\r\n\r\n        checkEncryption()\r\n\r\n        // Re-check when encryption state might change\r\n        const checkReady = () => {\r\n            if (spaceId && isRoomEncryptionReady(spaceId)) {\r\n                setIsEnabled(true)\r\n            }\r\n        }\r\n\r\n        // Check periodically until ready\r\n        const interval = setInterval(checkReady, 100)\r\n        setTimeout(() => clearInterval(interval), 5000) // Stop after 5s\r\n\r\n        return () => {\r\n            clearInterval(interval)\r\n        }\r\n    }, [spaceId])\r\n\r\n    // Get encryption status for UI\r\n    const getEncryptionStatus = useCallback((): EncryptionStatus => {\r\n        const state = spaceId ? getRoomEncryptionState(spaceId) : null\r\n        return {\r\n            enabled: state?.enabled ?? false,\r\n            algorithm: 'AES-GCM',\r\n            keyStrength: 256,\r\n            ready: isReady && (state?.key !== null || !isEnabled)\r\n        }\r\n    }, [isEnabled, isReady, spaceId])\r\n\r\n    const contextValue: EncryptionContextType = {\r\n        isEnabled,\r\n        isReady,\r\n        roomId: spaceId,\r\n        getEncryptionStatus\r\n    }\r\n\r\n    return (\r\n        <EncryptionContext.Provider value={contextValue}>\r\n            {children}\r\n        </EncryptionContext.Provider>\r\n    )\r\n}\r\n\r\n// Hook to use encryption context\r\nexport function useEncryption() {\r\n    const context = useContext(EncryptionContext)\r\n    if (!context) {\r\n        // Return a no-op encryption context if not inside provider\r\n        return {\r\n            isEnabled: false,\r\n            isReady: true,\r\n            roomId: null,\r\n            getEncryptionStatus: () => ({ enabled: false, algorithm: 'none', keyStrength: 0, ready: true })\r\n        }\r\n    }\r\n    return context\r\n}\r\n\r\n// LRU Cache for decrypted messages (re-export for convenience)\r\nexport { LRUCache, decryptionCache }\r\n\r\nimport { Lock, Unlock } from 'lucide-react'\r\n\r\n// Encryption badge component for UI\r\nexport function EncryptionBadge({ showDetails = false }: { showDetails?: boolean }) {\r\n    const { isEnabled, isReady, getEncryptionStatus\r\n    } = useEncryption()\r\n    const status = getEncryptionStatus()\r\n\r\n    if (!isReady) {\r\n        return null\r\n    }\r\n\r\n    if (!isEnabled) {\r\n        return showDetails ? (\r\n            <span className=\"encryption-badge disabled\" title=\"Encryption disabled\" style={{ display: 'inline-flex', alignItems: 'center', gap: '4px' }}>\r\n                <Unlock size={12} /> Unencrypted\r\n            </span>\r\n        ) : null\r\n    }\r\n\r\n    return (\r\n        <span className=\"encryption-badge enabled\" title={`${status.algorithm}-${status.keyStrength}`} style={{ display: 'inline-flex', alignItems: 'center', gap: '4px' }}>\r\n            <Lock size={12} /> {showDetails ? `Encrypted (${status.algorithm})` : 'Encrypted'}\r\n        </span>\r\n    )\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\hooks\\useGhostText.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":47,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":47,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1761,1764],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1761,1764],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":55,"column":68,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":55,"endColumn":71,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2293,2296],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2293,2296],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":7,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":7,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[261,264],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[261,264],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n// Ghost Text / Inline Completion Standalone Function for Monaco Editor\r\n// Provides Copilot-like AI code suggestions as you type\r\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\r\ntype Monaco = any\r\n\r\nimport { logger } from '../utils/logger'\r\n\r\n// Import aiService dynamically to avoid path issues\r\nconst getAiService = async () => {\r\n    try {\r\n        const module = await import('../services/aiService')\r\n        return module.aiService\r\n    } catch (error) {\r\n        logger.ai.warn('Failed to load AI service for ghost text', error)\r\n        return null\r\n    }\r\n}\r\n\r\n// Standalone function to register ghost text with Monaco instance\r\nexport async function registerGhostTextProvider(\r\n    monaco: Monaco,\r\n    aiEnabled: boolean = true\r\n) {\r\n    if (!aiEnabled) return null\r\n\r\n    const aiService = await getAiService()\r\n    if (!aiService) {\r\n        logger.ai.warn('AI service not available for ghost text')\r\n        return null\r\n    }\r\n\r\n    try {\r\n        const languages = [\r\n            'typescript', 'javascript', 'typescriptreact', 'javascriptreact',\r\n            'python', 'rust', 'go', 'cpp', 'c', 'html', 'css', 'json', 'yaml', 'plaintext'\r\n        ]\r\n\r\n        // BUG-062: Register for all supported languages individually to handle version differences\r\n        const disposables = languages.map(lang =>\r\n            monaco.languages.registerInlineCompletionsProvider(lang, {\r\n                provideInlineCompletions: async (\r\n                    model: { getValueInRange: (range: object) => string; getLineContent: (line: number) => string; getLanguageId: () => string; },\r\n                    position: { lineNumber: number; column: number },\r\n                    _context: any,\r\n                    token: { isCancellationRequested: boolean }\r\n                ) => {\r\n                    // ... implementation moved to a shared function or kept here ...\r\n                    // For brevity and to ensure correctness, I'll keep the implementation here for each\r\n\r\n                    // Debounce: Wait 500ms to avoid flooding AI with requests on every keystroke\r\n                    await new Promise(resolve => setTimeout(resolve, 500))\r\n                    if (token.isCancellationRequested || (model as any).isDisposed()) {\r\n                        return { items: [] }\r\n                    }\r\n\r\n                    const textBeforeCursor = model.getValueInRange({\r\n                        startLineNumber: Math.max(1, position.lineNumber - 10),\r\n                        startColumn: 1,\r\n                        endLineNumber: position.lineNumber,\r\n                        endColumn: position.column\r\n                    })\r\n\r\n                    const currentLine = model.getLineContent(position.lineNumber)\r\n                    if (currentLine.trim().length < 5) {\r\n                        return { items: [] }\r\n                    }\r\n\r\n                    try {\r\n                        const response = await aiService.chat([\r\n                            {\r\n                                role: 'system' as const,\r\n                                content: 'Complete the code. Return ONLY the completion, no markdown, no explanation, just the code continuation.'\r\n                            },\r\n                            {\r\n                                role: 'user' as const,\r\n                                content: `Complete this ${model.getLanguageId()} code:\\n${textBeforeCursor}`\r\n                            }\r\n                        ])\r\n\r\n                        const completion = response.content?.trim() || ''\r\n                        if (!completion || completion.startsWith('```') || completion.length > 200) {\r\n                            return { items: [] }\r\n                        }\r\n\r\n                        return {\r\n                            items: [{\r\n                                insertText: completion,\r\n                                range: {\r\n                                    startLineNumber: position.lineNumber,\r\n                                    startColumn: position.column,\r\n                                    endLineNumber: position.lineNumber,\r\n                                    endColumn: position.column\r\n                                }\r\n                            }]\r\n                        }\r\n                    } catch (error) {\r\n                        logger.ai.debug('Failed to generate inline completion', error)\r\n                        return { items: [] }\r\n                    }\r\n                },\r\n                freeInlineCompletions: () => { }\r\n            })\r\n        )\r\n\r\n        return {\r\n            dispose: () => {\r\n                disposables.forEach(d => d.dispose())\r\n            }\r\n        }\r\n    } catch (error) {\r\n        logger.ai.error('Failed to register ghost text provider', error)\r\n        return null\r\n    }\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\hooks\\useP2P.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":26,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":26,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[926,999],"text":""},"desc":"Remove the console.log()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n// useP2P - React hook for P2P networking\r\nimport { useState, useEffect, useCallback, useRef } from 'react'\r\nimport * as Y from 'yjs'\r\nimport { p2pService, PeerInfo } from '../services/p2pService'\r\nimport { WebrtcProvider } from 'y-webrtc'\r\n\r\nexport function useP2P(roomId: string | null, doc: Y.Doc | null) {\r\n    const [provider, setProvider] = useState<WebrtcProvider | null>(null)\r\n    const [synced, setSynced] = useState(false)\r\n    const [peers, setPeers] = useState<PeerInfo[]>([])\r\n    const [peerCount, setPeerCount] = useState(0)\r\n    const [isConnected, setIsConnected] = useState(false)\r\n\r\n    const isInitialized = useRef(false)\r\n\r\n    // Connect to room\r\n    useEffect(() => {\r\n        if (!roomId || !doc || isInitialized.current) return\r\n\r\n        // Set up callbacks\r\n        p2pService.setCallbacks(\r\n            (peerId, connected) => {\r\n                console.log(`Peer ${peerId} ${connected ? 'connected' : 'disconnected'}`)\r\n            },\r\n            (synced) => {\r\n                setSynced(synced)\r\n            },\r\n            (peerList) => {\r\n                setPeers(peerList)\r\n                setPeerCount(peerList.length)\r\n            }\r\n        )\r\n\r\n        // Connect\r\n        const webrtcProvider = p2pService.connect(roomId, doc)\r\n        setProvider(webrtcProvider)\r\n        setIsConnected(true)\r\n        isInitialized.current = true\r\n\r\n        return () => {\r\n            if (isInitialized.current && roomId) {\r\n                p2pService.disconnect(roomId)\r\n                isInitialized.current = false\r\n            }\r\n        }\r\n    }, [roomId, doc])\r\n\r\n    // Update peer count when provider changes\r\n    useEffect(() => {\r\n        if (provider) {\r\n            const updatePeers = () => {\r\n                const count = p2pService.getPeerCount(roomId || '')\r\n                setPeerCount(count)\r\n                setPeers(p2pService.getConnectedPeers(roomId || ''))\r\n            }\r\n\r\n            provider.awareness.on('change', updatePeers)\r\n            updatePeers()\r\n\r\n            return () => {\r\n                provider.awareness.off('change', updatePeers)\r\n            }\r\n        }\r\n    }, [provider, roomId])\r\n\r\n    // Set local user info\r\n    const setLocalUser = useCallback((name: string, color: string) => {\r\n        p2pService.setLocalUser(name, color)\r\n    }, [])\r\n\r\n    // Disconnect from room\r\n    const disconnect = useCallback(() => {\r\n        if (roomId) {\r\n            p2pService.disconnect(roomId)\r\n            setProvider(null)\r\n            setIsConnected(false)\r\n            setPeers([])\r\n            setPeerCount(0)\r\n            isInitialized.current = false\r\n        }\r\n    }, [roomId])\r\n\r\n    // Generate shareable link\r\n    const getShareLink = useCallback((password?: string) => {\r\n        if (!roomId) return ''\r\n        return p2pService.generateRoomLink(roomId, password)\r\n    }, [roomId])\r\n\r\n    return {\r\n        provider,\r\n        synced,\r\n        peers,\r\n        peerCount,\r\n        isConnected,\r\n        setLocalUser,\r\n        disconnect,\r\n        getShareLink\r\n    }\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\hooks\\usePermissions.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":97,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":97,"endColumn":25,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[3037,3103],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":105,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":105,"endColumn":25,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[3266,3333],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":113,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":113,"endColumn":25,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[3491,3557],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":121,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":121,"endColumn":25,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[3723,3790],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":129,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":129,"endColumn":25,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[3956,4023],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":137,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":137,"endColumn":25,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[4205,4257],"text":""},"desc":"Remove the console.warn()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n// usePermissions - Hook for checking and enforcing member permissions\r\nimport { useEffect, useState, useRef } from 'react'\r\nimport { useAppStore } from '../stores/appStore'\r\nimport { useMemberStore } from '../stores/memberStore'\r\nimport { MemberPermissions, DEFAULT_PERMISSIONS, isPathRestricted } from '../types/permissions'\r\n\r\ninterface PermissionState {\r\n    // Permission flags\r\n    canEdit: boolean\r\n    canUseAgent: boolean\r\n    canChat: boolean\r\n    canManageTasks: boolean\r\n    canManageFiles: boolean\r\n\r\n    // Role info\r\n    isOwner: boolean\r\n    isAdmin: boolean\r\n    isViewer: boolean\r\n\r\n    // Utilities\r\n    isPathAllowed: (path: string) => boolean\r\n    isBanned: boolean\r\n}\r\n\r\n/**\r\n * Hook to get current user's permissions for a space\r\n * Automatically updates when permissions change via P2P sync\r\n */\r\nexport function usePermissions(): PermissionState {\r\n    const { currentSpace } = useAppStore()\r\n    const { getMyRole, getMyPermissions, userId, isUserBanned } = useMemberStore()\r\n\r\n    const [permissions, setPermissions] = useState<MemberPermissions>(DEFAULT_PERMISSIONS.member)\r\n\r\n    const spaceId = currentSpace?.id\r\n    const myRole = spaceId ? getMyRole(spaceId) : 'member'\r\n\r\n    const permissionsRef = useRef(permissions)\r\n    useEffect(() => {\r\n        permissionsRef.current = permissions\r\n    }, [permissions])\r\n\r\n    useEffect(() => {\r\n        if (!spaceId) {\r\n            setPermissions(DEFAULT_PERMISSIONS.member)\r\n            return\r\n        }\r\n\r\n        const perms = getMyPermissions(spaceId)\r\n        setPermissions(perms)\r\n\r\n        // Subscribe to permission changes from store\r\n        const unsubscribe = useMemberStore.subscribe((state) => {\r\n            const updated = state.getMyPermissions(spaceId)\r\n            // Use ref to compare to avoid stale closure in subscription\r\n            if (JSON.stringify(updated) !== JSON.stringify(permissionsRef.current)) {\r\n                setPermissions(updated)\r\n            }\r\n        })\r\n\r\n        return unsubscribe\r\n    }, [spaceId, getMyPermissions])\r\n\r\n    const isPathAllowed = (path: string): boolean => {\r\n        if (!permissions.canEdit) return false\r\n        return !isPathRestricted(path, permissions)\r\n    }\r\n\r\n    return {\r\n        canEdit: permissions.canEdit,\r\n        canUseAgent: permissions.canUseAgent,\r\n        canChat: permissions.canChat,\r\n        canManageTasks: permissions.canManageTasks,\r\n        canManageFiles: permissions.canManageFiles,\r\n\r\n        isOwner: myRole === 'owner',\r\n        isAdmin: myRole === 'owner' || myRole === 'admin',\r\n        isViewer: myRole === 'viewer',\r\n\r\n        isPathAllowed,\r\n        isBanned: spaceId ? isUserBanned(spaceId, userId) : false\r\n    }\r\n}\r\n\r\n/**\r\n * Hook to check if user can perform a specific action\r\n * Shows toast/alert if action is blocked\r\n */\r\nexport function usePermissionCheck() {\r\n    const permissions = usePermissions()\r\n\r\n    const checkEdit = (): boolean => {\r\n        if (!permissions.canEdit) {\r\n            console.warn('[Permissions] Edit blocked - user lacks permission')\r\n            return false\r\n        }\r\n        return true\r\n    }\r\n\r\n    const checkAgent = (): boolean => {\r\n        if (!permissions.canUseAgent) {\r\n            console.warn('[Permissions] Agent blocked - user lacks permission')\r\n            return false\r\n        }\r\n        return true\r\n    }\r\n\r\n    const checkChat = (): boolean => {\r\n        if (!permissions.canChat) {\r\n            console.warn('[Permissions] Chat blocked - user lacks permission')\r\n            return false\r\n        }\r\n        return true\r\n    }\r\n\r\n    const checkTasks = (): boolean => {\r\n        if (!permissions.canManageTasks) {\r\n            console.warn('[Permissions] Tasks blocked - user lacks permission')\r\n            return false\r\n        }\r\n        return true\r\n    }\r\n\r\n    const checkFiles = (): boolean => {\r\n        if (!permissions.canManageFiles) {\r\n            console.warn('[Permissions] Files blocked - user lacks permission')\r\n            return false\r\n        }\r\n        return true\r\n    }\r\n\r\n    const checkPath = (path: string): boolean => {\r\n        if (!permissions.isPathAllowed(path)) {\r\n            console.warn('[Permissions] Path restricted:', path)\r\n            return false\r\n        }\r\n        return true\r\n    }\r\n\r\n    return {\r\n        checkEdit,\r\n        checkAgent,\r\n        checkChat,\r\n        checkTasks,\r\n        checkFiles,\r\n        checkPath,\r\n        permissions\r\n    }\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\hooks\\useStorage.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\hooks\\useYjs.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":88,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":88,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2916,2919],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2916,2919],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":89,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":89,"endColumn":30,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[2943,3011],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":91,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":91,"endColumn":33,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[3093,3132],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":96,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":96,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[3224,3284],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":108,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":108,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[3693,3757],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":152,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":152,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[5122,5194],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":165,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":165,"endColumn":33,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[5674,5713],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":169,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":169,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[5759,5809],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":187,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":187,"endColumn":25,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[6246,6312],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":207,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":207,"endColumn":25,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[6832,6904],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":222,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":222,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[7173,7239],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":286,"column":29,"nodeType":"MemberExpression","messageId":"unexpected","endLine":286,"endColumn":40,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[9479,9544],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":290,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":290,"endColumn":34,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[9647,9706],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":296,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":296,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9884,9887],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9884,9887],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":326,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":326,"endColumn":33,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[11124,11189],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":346,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":346,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[11771,11837],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":380,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":380,"endColumn":34,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"debug"},"fix":{"range":[13087,13144],"text":""},"desc":"Remove the console.debug()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":389,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":389,"endColumn":30,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[13473,13531],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":547,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":547,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17882,17885],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17882,17885],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":566,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":566,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18395,18398],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18395,18398],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":20,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\nimport { useEffect, useRef, useState, useCallback } from 'react'\r\nimport * as Y from 'yjs'\r\nimport { IndexeddbPersistence } from 'y-indexeddb'\r\nimport { WebrtcProvider } from 'y-webrtc'\r\nimport { memberSyncService } from '../services/memberSyncService'\r\nimport { useMemberStore } from '../stores/memberStore'\r\n\r\n// Store for Yjs documents per space\r\nconst documents = new Map<string, Y.Doc>()\r\nconst providers = new Map<string, WebrtcProvider>()\r\nconst persistences = new Map<string, IndexeddbPersistence>()\r\n// Reference counting for cleanup\r\nconst refCounts = new Map<string, number>()\r\n\r\n// Signaling servers for WebRTC\r\nconst SIGNALING_SERVERS = [\r\n    'wss://signaling.yjs.dev',\r\n    'wss://y-webrtc-signaling-eu.herokuapp.com',\r\n    'wss://y-webrtc-signaling-us.herokuapp.com'\r\n]\r\n\r\n// ICE servers for NAT traversal (STUN discovers public IP, TURN relays traffic)\r\n// TURN servers are essential for users behind symmetric NAT, firewalls, or corporate networks\r\nconst ICE_SERVERS: RTCIceServer[] = [\r\n    // STUN servers\r\n    { urls: 'stun:stun.l.google.com:19302' },\r\n    { urls: 'stun:stun1.l.google.com:19302' },\r\n    { urls: 'stun:stun2.l.google.com:19302' },\r\n    { urls: 'stun:stun3.l.google.com:19302' },\r\n    { urls: 'stun:stun4.l.google.com:19302' },\r\n    // OpenRelay TURN servers (free, for when STUN fails)\r\n    {\r\n        urls: 'turn:openrelay.metered.ca:80',\r\n        username: 'openrelayproject',\r\n        credential: 'openrelayproject'\r\n    },\r\n    {\r\n        urls: 'turn:openrelay.metered.ca:443',\r\n        username: 'openrelayproject',\r\n        credential: 'openrelayproject'\r\n    },\r\n    {\r\n        urls: 'turn:openrelay.metered.ca:443?transport=tcp',\r\n        username: 'openrelayproject',\r\n        credential: 'openrelayproject'\r\n    },\r\n    // Metered.ca free TURN (backup)\r\n    {\r\n        urls: 'turn:a.relay.metered.ca:80',\r\n        username: 'e8dd65b92f62d5eedb7e1b12',\r\n        credential: 'uWdWNmkhvyqTmFfm'\r\n    },\r\n    {\r\n        urls: 'turn:a.relay.metered.ca:443',\r\n        username: 'e8dd65b92f62d5eedb7e1b12',\r\n        credential: 'uWdWNmkhvyqTmFfm'\r\n    },\r\n    {\r\n        urls: 'turn:a.relay.metered.ca:443?transport=tcp',\r\n        username: 'e8dd65b92f62d5eedb7e1b12',\r\n        credential: 'uWdWNmkhvyqTmFfm'\r\n    }\r\n]\r\n\r\n// Helper interface for objects with cleanup method\r\ninterface CleanupCapable {\r\n    _cleanup?: () => void\r\n}\r\n\r\n/**\r\n * Get or create a Yjs document for a space\r\n */\r\nexport function getSpaceDocument(spaceId: string): Y.Doc {\r\n    let doc = documents.get(spaceId)\r\n\r\n    if (!doc) {\r\n        doc = new Y.Doc()\r\n        documents.set(spaceId, doc)\r\n\r\n        // Set up IndexedDB persistence with quota handling\r\n        try {\r\n            const persistence = new IndexeddbPersistence(`kalynt-${spaceId}`, doc)\r\n            persistences.set(spaceId, persistence)\r\n\r\n            const onError = (error: any) => {\r\n                console.error(`[CRDT] IndexedDB error for space ${spaceId}:`, error)\r\n                if (error.name === 'QuotaExceededError') {\r\n                    console.warn('Storage quota exceeded!')\r\n                }\r\n            }\r\n\r\n            const onSynced = () => {\r\n                console.log(`[CRDT] Space ${spaceId} synced from IndexedDB`)\r\n            }\r\n\r\n            persistence.on('error', onError)\r\n            persistence.on('synced', onSynced)\r\n\r\n                // Store cleanup function\r\n                ; (persistence as unknown as CleanupCapable)._cleanup = () => {\r\n                    persistence.off('synced', onSynced)\r\n                    persistence.off('error', onError)\r\n                }\r\n        } catch (error) {\r\n            console.error(`[CRDT] Failed to initialize persistence:`, error)\r\n        }\r\n    }\r\n\r\n    return doc\r\n}\r\n\r\n/**\r\n * Connect a space to P2P network with optional encryption\r\n */\r\nexport function connectSpace(spaceId: string, password?: string): WebrtcProvider {\r\n    let provider = providers.get(spaceId)\r\n\r\n    if (!provider) {\r\n        const doc = getSpaceDocument(spaceId)\r\n\r\n        // y-webrtc: Append password to room name for built-in AES-GCM encryption\r\n        // The signaling server only sees the part before #\r\n        const roomName = password ? `kalynt-${spaceId}#${password}` : `kalynt-${spaceId}`\r\n\r\n        provider = new WebrtcProvider(roomName, doc, {\r\n            signaling: SIGNALING_SERVERS,\r\n            maxConns: 20,\r\n            filterBcConns: true,\r\n            peerOpts: {\r\n                config: {\r\n                    iceServers: ICE_SERVERS\r\n                }\r\n            }\r\n        })\r\n        providers.set(spaceId, provider)\r\n\r\n        // Set local awareness state\r\n        provider.awareness.setLocalStateField('user', {\r\n            name: 'Local User',\r\n            color: generateColor()\r\n        })\r\n\r\n        // Optional: Add encryption logging for updates\r\n        const updateHandler = (_update: Uint8Array, _origin: unknown) => {\r\n            // Future encryption tracing logic can be added here\r\n        }\r\n\r\n        const syncedHandler = (synced: { synced: boolean }) => {\r\n            console.log(`[P2P] Sync state: ${synced.synced ? 'synced' : 'syncing'}`)\r\n        }\r\n\r\n        doc.on('update', updateHandler)\r\n        provider.on('synced', syncedHandler)\r\n\r\n            // Store cleanup functions\r\n            ; (provider as unknown as CleanupCapable)._cleanup = () => {\r\n                try {\r\n                    doc.off('update', updateHandler)\r\n                    provider?.off('synced', syncedHandler)\r\n                } catch (e) {\r\n                    // Ignore errors during cleanup of destroyed objects\r\n                    console.warn('[P2P] Cleanup error:', e)\r\n                }\r\n            }\r\n\r\n        console.log(`[P2P] Connected to space ${spaceId}`)\r\n    }\r\n\r\n    return provider\r\n}\r\n\r\n// ... (lines 129-142 omitted)\r\n\r\n/**\r\n * Disconnect from a space (provider only, keeps doc for potential reconnection)\r\n */\r\nexport function disconnectSpace(spaceId: string): void {\r\n    const provider = providers.get(spaceId)\r\n    if (provider) {\r\n        try {\r\n            (provider as unknown as CleanupCapable)._cleanup?.()\r\n            provider.destroy()\r\n        } catch (err) {\r\n            console.warn(`[P2P] Error during disconnect for ${spaceId}:`, err)\r\n        }\r\n        providers.delete(spaceId)\r\n    }\r\n}\r\n\r\n/**\r\n * Completely destroy a space's resources (use when no components need it)\r\n */\r\nexport function destroySpace(spaceId: string): void {\r\n    // Disconnect provider\r\n    disconnectSpace(spaceId)\r\n\r\n    // Destroy persistence\r\n    const persistence = persistences.get(spaceId)\r\n    if (persistence) {\r\n        try {\r\n            (persistence as unknown as CleanupCapable)._cleanup?.()\r\n            persistence.destroy()\r\n        } catch (err) {\r\n            console.warn(`[CRDT] Error destroying persistence for ${spaceId}:`, err)\r\n        }\r\n        persistences.delete(spaceId)\r\n    }\r\n\r\n    // Destroy document\r\n    const doc = documents.get(spaceId)\r\n    if (doc) {\r\n        doc.destroy()\r\n        documents.delete(spaceId)\r\n    }\r\n\r\n    // Clear ref count\r\n    refCounts.delete(spaceId)\r\n\r\n    console.log(`[CRDT] Destroyed all resources for space ${spaceId}`)\r\n}\r\n\r\n/**\r\n * Increment reference count for a space\r\n */\r\nfunction refSpace(spaceId: string): void {\r\n    refCounts.set(spaceId, (refCounts.get(spaceId) || 0) + 1)\r\n}\r\n\r\n/**\r\n * Decrement reference count and destroy if no refs remain\r\n */\r\nfunction unrefSpace(spaceId: string): void {\r\n    const count = refCounts.get(spaceId) || 0\r\n    if (count <= 1) {\r\n        // Last reference, destroy everything\r\n        destroySpace(spaceId)\r\n    } else {\r\n        refCounts.set(spaceId, count - 1)\r\n    }\r\n}\r\n\r\n/**\r\n * Hook to use a Yjs document for a space\r\n * Integrates with encryption if enabled in space settings\r\n */\r\nexport function useYDoc(spaceId: string | null) {\r\n    const [doc, setDoc] = useState<Y.Doc | null>(null)\r\n    const [provider, setProvider] = useState<WebrtcProvider | null>(null)\r\n    const [synced, setSynced] = useState(false)\r\n    const [peerCount, setPeerCount] = useState(0)\r\n    const [encrypted, setEncrypted] = useState(false)\r\n    const updatePeersRef = useRef<(() => void) | null>(null)\r\n    const isMountedRef = useRef(true)\r\n    const setupRef = useRef<string | null>(null)\r\n\r\n    useEffect(() => {\r\n        isMountedRef.current = true\r\n\r\n        if (!spaceId) {\r\n            setDoc(null)\r\n            setProvider(null)\r\n            setSynced(false)\r\n            setPeerCount(0)\r\n            setEncrypted(false)\r\n            return\r\n        }\r\n\r\n        if (setupRef.current === spaceId) return\r\n        setupRef.current = spaceId\r\n\r\n        // Initialize encryption BEFORE connecting (fix race condition)\r\n        const initEncryption = async () => {\r\n            const settings = localStorage.getItem(`space-settings-${spaceId}`)\r\n            if (settings) {\r\n                try {\r\n                    const parsed = JSON.parse(settings)\r\n                    if (parsed.encryptionEnabled && parsed.roomPassword) {\r\n                        // Import and initialize encrypted provider\r\n                        const { initializeRoomEncryption } = await import('../services/encryptedProvider')\r\n                        await initializeRoomEncryption(spaceId, parsed.roomPassword)\r\n                        if (isMountedRef.current) {\r\n                            setEncrypted(true)\r\n                            console.log(`[CRDT] Encryption initialized for space ${spaceId}`)\r\n                        }\r\n                    }\r\n                } catch (e) {\r\n                    console.error('[CRDT] Failed to initialize encryption:', e)\r\n                }\r\n            }\r\n        }\r\n\r\n        // Helper to track peers (defined here to avoid deep nesting inside setup)\r\n        const updatePeers = (targetProvider: any) => {\r\n            const awareness = targetProvider.awareness\r\n            if (!awareness || !isMountedRef.current) return\r\n\r\n            const currentIds = Array.from(awareness.getStates().keys())\r\n            const count = currentIds.filter(id => id !== awareness.clientID).length\r\n            setPeerCount(count)\r\n        }\r\n\r\n        // Await encryption before connecting to avoid race condition\r\n        const setup = async () => {\r\n            await initEncryption()\r\n\r\n            if (!isMountedRef.current || setupRef.current !== spaceId) return\r\n\r\n            // Increment reference count\r\n            refSpace(spaceId)\r\n\r\n            const ydoc = getSpaceDocument(spaceId)\r\n\r\n            // Fetch password if encryption is enabled to reconnect with correct room\r\n            let passwordValue: string | undefined = undefined\r\n            const settings = localStorage.getItem(`space-settings-${spaceId}`)\r\n            if (settings) {\r\n                try {\r\n                    const parsed = JSON.parse(settings)\r\n                    if (parsed.encryptionEnabled && parsed.roomPassword) {\r\n                        passwordValue = parsed.roomPassword\r\n                    }\r\n                } catch (e) {\r\n                    console.warn('[P2P] Failed to parse settings for encryption:', e)\r\n                }\r\n            }\r\n\r\n            const yprovider = connectSpace(spaceId, passwordValue)\r\n\r\n            setDoc(ydoc)\r\n            setProvider(yprovider)\r\n\r\n            if (!isMountedRef.current) return\r\n\r\n            // Initialize member sync for P2P role/permission management\r\n            const { userId, displayName } = useMemberStore.getState()\r\n            memberSyncService.initializeSpace(\r\n                spaceId,\r\n                ydoc,\r\n                yprovider.awareness,\r\n                userId,\r\n                displayName\r\n            )\r\n            console.log(`[Members] Initialized P2P sync for space ${spaceId}`)\r\n\r\n            // Track sync state\r\n            const persistence = persistences.get(spaceId)\r\n            if (persistence) {\r\n                persistence.on('synced', () => {\r\n                    if (isMountedRef.current) setSynced(true)\r\n                })\r\n            }\r\n\r\n            // Track peer count avoiding deep nesting callback (ESL-040)\r\n            const listener = () => updatePeers(yprovider)\r\n            updatePeersRef.current = listener\r\n            yprovider.awareness.on('change', listener)\r\n\r\n            // Check again before initial call to avoid state updates on unmounted component\r\n            if (isMountedRef.current && setupRef.current === spaceId) {\r\n                listener()\r\n            }\r\n        }\r\n\r\n        setup()\r\n\r\n        return () => {\r\n            isMountedRef.current = false\r\n            setupRef.current = null\r\n\r\n            // Cleanup peer listener carefully\r\n            const currentProvider = provider || providers.get(spaceId)\r\n            const currentCallback = updatePeersRef.current\r\n            if (currentProvider && currentCallback) {\r\n                try {\r\n                    currentProvider.awareness.off('change', currentCallback)\r\n                } catch (e) {\r\n                    console.debug('[P2P] Failed to remove peer listener:', e)\r\n                }\r\n            }\r\n            updatePeersRef.current = null\r\n\r\n            // Clean up encryption state with error handling\r\n            import('../services/encryptedProvider').then(({ disableRoomEncryption }) => {\r\n                disableRoomEncryption(spaceId)\r\n            }).catch(err => {\r\n                console.error('[CRDT] Failed to disable encryption:', err)\r\n            })\r\n\r\n            // Clean up member sync\r\n            memberSyncService.cleanup(spaceId)\r\n\r\n            // Decrement ref count - will destroy if this was the last user\r\n            unrefSpace(spaceId)\r\n        }\r\n    }, [spaceId])\r\n\r\n    return { doc, provider, synced, peerCount, encrypted }\r\n}\r\n\r\n/**\r\n * Hook to use a Yjs Text type\r\n */\r\nexport function useYText(doc: Y.Doc | null, key: string) {\r\n    const [text, setText] = useState('')\r\n    const yTextRef = useRef<Y.Text | null>(null)\r\n\r\n    useEffect(() => {\r\n        if (!doc) {\r\n            setText('')\r\n            return\r\n        }\r\n\r\n        const yText = doc.getText(key)\r\n        yTextRef.current = yText\r\n        setText(yText.toJSON())\r\n\r\n        const observer = () => {\r\n            setText(yText.toJSON())\r\n        }\r\n\r\n        yText.observe(observer)\r\n        return () => yText.unobserve(observer)\r\n    }, [doc, key])\r\n\r\n    const updateText = useCallback((newText: string) => {\r\n        if (!yTextRef.current || !doc) return\r\n\r\n        doc.transact(() => {\r\n            yTextRef.current!.delete(0, yTextRef.current!.length)\r\n            yTextRef.current!.insert(0, newText)\r\n        })\r\n    }, [doc])\r\n\r\n    const insertText = useCallback((index: number, content: string) => {\r\n        if (!yTextRef.current) return\r\n        yTextRef.current.insert(index, content)\r\n    }, [])\r\n\r\n    const deleteText = useCallback((index: number, length: number) => {\r\n        if (!yTextRef.current) return\r\n        yTextRef.current.delete(index, length)\r\n    }, [])\r\n\r\n    return { text, updateText, insertText, deleteText, yText: yTextRef.current }\r\n}\r\n\r\n/**\r\n * Hook to use a Yjs Array type\r\n */\r\nexport function useYArray<T>(doc: Y.Doc | null, key: string) {\r\n    const [items, setItems] = useState<T[]>([])\r\n    const yArrayRef = useRef<Y.Array<T> | null>(null)\r\n\r\n    useEffect(() => {\r\n        if (!doc) {\r\n            setItems([])\r\n            return\r\n        }\r\n\r\n        const yArray = doc.getArray<T>(key)\r\n        yArrayRef.current = yArray\r\n        setItems(yArray.toArray())\r\n\r\n        const observer = () => {\r\n            setItems(yArray.toArray())\r\n        }\r\n\r\n        yArray.observe(observer)\r\n        return () => yArray.unobserve(observer)\r\n    }, [doc, key])\r\n\r\n    const push = useCallback((item: T) => {\r\n        if (!yArrayRef.current) return\r\n        yArrayRef.current.push([item])\r\n    }, [])\r\n\r\n    const insert = useCallback((index: number, item: T) => {\r\n        if (!yArrayRef.current) return\r\n        yArrayRef.current.insert(index, [item])\r\n    }, [])\r\n\r\n    const remove = useCallback((index: number) => {\r\n        if (!yArrayRef.current) return\r\n        yArrayRef.current.delete(index, 1)\r\n    }, [])\r\n\r\n    const update = useCallback((index: number, item: T) => {\r\n        if (!yArrayRef.current || !doc) return\r\n        doc.transact(() => {\r\n            yArrayRef.current!.delete(index, 1)\r\n            yArrayRef.current!.insert(index, [item])\r\n        })\r\n    }, [doc])\r\n\r\n    return { items, push, insert, remove, update, yArray: yArrayRef.current }\r\n}\r\n\r\n/**\r\n * Hook to use a Yjs Map type\r\n */\r\nexport function useYMap<T>(doc: Y.Doc | null, key: string) {\r\n    const [data, setData] = useState<Map<string, T>>(new Map())\r\n    const yMapRef = useRef<Y.Map<T> | null>(null)\r\n\r\n    useEffect(() => {\r\n        if (!doc) {\r\n            setData(new Map())\r\n            return\r\n        }\r\n\r\n        const yMap = doc.getMap<T>(key)\r\n        yMapRef.current = yMap\r\n        setData(new Map(yMap.entries()))\r\n\r\n        const observer = () => {\r\n            setData(new Map(yMap.entries()))\r\n        }\r\n\r\n        yMap.observe(observer)\r\n        return () => yMap.unobserve(observer)\r\n    }, [doc, key])\r\n\r\n    const set = useCallback((k: string, value: T) => {\r\n        if (!yMapRef.current) return\r\n        yMapRef.current.set(k, value)\r\n    }, [])\r\n\r\n    const remove = useCallback((k: string) => {\r\n        if (!yMapRef.current) return\r\n        yMapRef.current.delete(k)\r\n    }, [])\r\n\r\n    const get = useCallback((k: string): T | undefined => {\r\n        return yMapRef.current?.get(k)\r\n    }, [])\r\n\r\n    return { data, set, remove, get, yMap: yMapRef.current }\r\n}\r\n\r\n/**\r\n * Hook for awareness (cursor positions, presence)\r\n */\r\nexport function useAwareness(provider: WebrtcProvider | null) {\r\n    const [users, setUsers] = useState<Map<number, any>>(new Map())\r\n\r\n    useEffect(() => {\r\n        if (!provider) {\r\n            setUsers(new Map())\r\n            return\r\n        }\r\n\r\n        const updateUsers = () => {\r\n            const states = provider.awareness.getStates()\r\n            setUsers(new Map(states))\r\n        }\r\n\r\n        provider.awareness.on('change', updateUsers)\r\n        updateUsers()\r\n\r\n        return () => provider.awareness.off('change', updateUsers)\r\n    }, [provider])\r\n\r\n    const setLocalState = useCallback((field: string, value: any) => {\r\n        if (!provider) return\r\n        provider.awareness.setLocalStateField(field, value)\r\n    }, [provider])\r\n\r\n    return { users, setLocalState, localClientId: provider?.awareness.clientID }\r\n}\r\n\r\n// Helper function\r\nfunction generateColor(): string {\r\n    const colors = ['#3b82f6', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899']\r\n    return colors[Math.floor(Math.random() * colors.length)]\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\main.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\services\\agentService.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":55,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":55,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2083,2086],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2083,2086],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":95,"column":99,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":95,"endColumn":102,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3181,3184],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3181,3184],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":290,"column":68,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":290,"endColumn":71,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9458,9461],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9458,9461],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":428,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":428,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15326,15329],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15326,15329],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"prefer-const","severity":2,"message":"'cleanedResponse' is never reassigned. Use 'const' instead.","line":533,"column":17,"nodeType":"Identifier","messageId":"useConst","endLine":533,"endColumn":32,"fix":{"range":[20013,20267],"text":"const cleanedResponse = response\r\n                .replaceAll(/<think>[\\s\\S]*?<\\/think>/gi, '')\r\n                .replaceAll(/<thinking>[\\s\\S]*?<\\/thinking>/gi, '')\r\n                .replaceAll(/<thought>[\\s\\S]*?<\\/thought>/gi, '')\r\n                .trim()"}},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":675,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":675,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[25381,25384],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[25381,25384],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":684,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":684,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[25792,25795],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[25792,25795],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":690,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":690,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[26038,26041],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[26038,26041],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":1,"fixableWarningCount":0,"source":"/**\r\n * Copyright 2026 Hermes Lekkas.\r\n * PROPRIETARY & CONFIDENTIAL.\r\n * \r\n * This file is part of the Kalynt \"Pro\" Edition.\r\n * Unauthorized copying, distribution, or modification of this file, \r\n * via any medium, is strictly prohibited.\r\n */\r\n\r\n// Agent Service - Autonomous AI agent with Yjs observation\r\nimport * as Y from 'yjs'\r\nimport { aiService, AIProvider, AIMessage } from './aiService'\r\nimport { offlineLLMService, ChatMessage as OfflineChatMessage } from './offlineLLMService'\r\nimport { getModeConfig, EditorMode } from '../config/editorModes'\r\nimport { executeTool, ToolContext, getToolsDescription } from './ideAgentTools'\r\nimport { logger } from '../utils/logger'\r\nimport {\r\n    AgentState,\r\n    AgentSuggestion,\r\n    AgentAIResponse,\r\n    AgentConfig,\r\n    DEFAULT_AGENT_CONFIG,\r\n    ActivityLogEntry,\r\n    WorkspaceContext,\r\n    CreateTaskPayload,\r\n    EditPayload,\r\n    ToolCallPayload\r\n} from '../types/agentTypes'\r\n\r\ntype StateCallback = (state: AgentState) => void\r\ntype SuggestionsCallback = (suggestions: AgentSuggestion[]) => void\r\ntype ActivityCallback = (entry: ActivityLogEntry) => void\r\n\r\nclass AgentService {\r\n    private doc: Y.Doc | null = null\r\n    private config: AgentConfig = DEFAULT_AGENT_CONFIG\r\n    private state: AgentState = 'disabled'\r\n    private lastEditTime: number = 0\r\n    private analysisTimer: ReturnType<typeof setTimeout> | null = null\r\n    private idleTimer: ReturnType<typeof setTimeout> | null = null\r\n    private suggestions: AgentSuggestion[] = []\r\n    private activityLog: ActivityLogEntry[] = []\r\n    private currentMode: EditorMode = 'general'\r\n    private provider: AIProvider = 'openai'\r\n    private useOfflineAI: boolean = false\r\n    private workspacePath: string = ''\r\n\r\n    // Callbacks\r\n    private onStateChange: StateCallback | null = null\r\n    private onSuggestions: SuggestionsCallback | null = null\r\n    private onActivity: ActivityCallback | null = null\r\n\r\n    // Observation handlers\r\n    private editorObserver: ((event: Y.YTextEvent) => void) | null = null\r\n    private tasksObserver: ((event: Y.YArrayEvent<any>) => void) | null = null\r\n\r\n    // AbortController for cancelling in-flight AI requests\r\n    private abortController: AbortController | null = null\r\n\r\n    setCallbacks(\r\n        onStateChange: StateCallback,\r\n        onSuggestions: SuggestionsCallback,\r\n        onActivity: ActivityCallback\r\n    ) {\r\n        this.onStateChange = onStateChange\r\n        this.onSuggestions = onSuggestions\r\n        this.onActivity = onActivity\r\n    }\r\n\r\n    setConfig(config: Partial<AgentConfig>) {\r\n        this.config = { ...this.config, ...config }\r\n    }\r\n\r\n    setProvider(provider: AIProvider) {\r\n        this.provider = provider\r\n    }\r\n\r\n    setMode(mode: EditorMode) {\r\n        this.currentMode = mode\r\n    }\r\n\r\n    setUseOfflineAI(useOffline: boolean) {\r\n        this.useOfflineAI = useOffline\r\n    }\r\n\r\n    setWorkspacePath(path: string) {\r\n        this.workspacePath = path\r\n    }\r\n\r\n    private setState(state: AgentState) {\r\n        this.state = state\r\n        this.onStateChange?.(state)\r\n    }\r\n\r\n    private addActivity(type: ActivityLogEntry['type'], message: string, details?: Record<string, any>) {\r\n        const entry: ActivityLogEntry = {\r\n            id: crypto.randomUUID(),\r\n            timestamp: Date.now(),\r\n            type,\r\n            message,\r\n            details\r\n        }\r\n        this.activityLog.unshift(entry)\r\n        // Keep last 50 entries\r\n        if (this.activityLog.length > 50) {\r\n            this.activityLog = this.activityLog.slice(0, 50)\r\n        }\r\n        this.onActivity?.(entry)\r\n    }\r\n\r\n    start(doc: Y.Doc) {\r\n        if (!this.config.enabled) return\r\n\r\n        this.doc = doc\r\n        this.setState('observing')\r\n        this.addActivity('analysis', 'Agent started observing workspace')\r\n\r\n        // Observe editor content\r\n        const editorText = doc.getText('editor-content')\r\n        this.editorObserver = () => {\r\n            this.handleEdit()\r\n        }\r\n        editorText.observe(this.editorObserver)\r\n\r\n        // Observe tasks\r\n        const tasksArray = doc.getArray('tasks')\r\n        this.tasksObserver = () => {\r\n            // React to task changes if needed\r\n            this.handleEdit()\r\n        }\r\n        tasksArray.observe(this.tasksObserver)\r\n\r\n        // BUG-044: Load persisted suggestions\r\n        this.loadSuggestions()\r\n\r\n        // Start periodic analysis\r\n        this.startAnalysisTimer()\r\n    }\r\n\r\n    // BUG-044: IndexedDB persistence for suggestions\r\n    private async loadSuggestions() {\r\n        try {\r\n            const db = await this.openDB()\r\n            const transaction = db.transaction(['suggestions'], 'readonly')\r\n            const store = transaction.objectStore('suggestions')\r\n            const request = store.getAll()\r\n\r\n            request.onsuccess = () => {\r\n                if (Array.isArray(request.result)) {\r\n                    this.suggestions = request.result\r\n                    this.onSuggestions?.(this.suggestions)\r\n                }\r\n            }\r\n        } catch (e) {\r\n            logger.agent.warn('Failed to load agent suggestions from IndexedDB', e)\r\n            // Fallback to localStorage if IDB fails? No, let's stick to IDB as requested.\r\n        }\r\n    }\r\n\r\n    private async saveSuggestions() {\r\n        try {\r\n            const db = await this.openDB()\r\n            const transaction = db.transaction(['suggestions'], 'readwrite')\r\n            const store = transaction.objectStore('suggestions')\r\n\r\n            // Clear old suggestions and save new ones\r\n            await new Promise((resolve, reject) => {\r\n                const clearRequest = store.clear()\r\n                clearRequest.onsuccess = () => resolve(true)\r\n                clearRequest.onerror = () => reject(new Error('IndexedDB clear failed'))\r\n            })\r\n\r\n            for (const suggestion of this.suggestions) {\r\n                store.add(suggestion)\r\n            }\r\n        } catch (e) {\r\n            logger.agent.warn('Failed to save agent suggestions to IndexedDB', e)\r\n        }\r\n    }\r\n\r\n    private openDB(): Promise<IDBDatabase> {\r\n        return new Promise((resolve, reject) => {\r\n            const request = indexedDB.open('kalynt-agent-db', 1)\r\n\r\n            request.onupgradeneeded = () => {\r\n                const db = request.result\r\n                if (!db.objectStoreNames.contains('suggestions')) {\r\n                    db.createObjectStore('suggestions', { keyPath: 'id' })\r\n                }\r\n            }\r\n\r\n            request.onsuccess = () => resolve(request.result)\r\n            request.onerror = () => reject(new Error(request.error?.message || 'IndexedDB failed to open'))\r\n        })\r\n    }\r\n\r\n    stop() {\r\n        if (!this.doc) return\r\n\r\n        // Abort any in-flight AI requests\r\n        if (this.abortController) {\r\n            this.abortController.abort()\r\n            this.abortController = null\r\n        }\r\n\r\n        // Remove observers\r\n        if (this.editorObserver) {\r\n            this.doc.getText('editor-content').unobserve(this.editorObserver)\r\n            this.editorObserver = null\r\n        }\r\n        if (this.tasksObserver) {\r\n            this.doc.getArray('tasks').unobserve(this.tasksObserver)\r\n            this.tasksObserver = null\r\n        }\r\n\r\n        this.clearTimers()\r\n        this.doc = null\r\n        this.setState('disabled')\r\n        this.addActivity('analysis', 'Agent stopped')\r\n    }\r\n\r\n    private clearTimers() {\r\n        if (this.analysisTimer) {\r\n            clearTimeout(this.analysisTimer)\r\n            this.analysisTimer = null\r\n        }\r\n        if (this.idleTimer) {\r\n            clearTimeout(this.idleTimer)\r\n            this.idleTimer = null\r\n        }\r\n    }\r\n\r\n    private startAnalysisTimer() {\r\n        this.clearTimers()\r\n        if (this.state === 'disabled') return\r\n\r\n        // BUG-084: Ensure we don't stack timers\r\n        if (this.analysisTimer) return\r\n\r\n        this.analysisTimer = setTimeout(() => {\r\n            this.analysisTimer = null // Clear ref when running\r\n            this.checkIdleAndAnalyze()\r\n        }, this.config.analysisInterval)\r\n    }\r\n\r\n    private handleEdit() {\r\n        this.lastEditTime = Date.now()\r\n\r\n        // Reset idle timer\r\n        if (this.idleTimer) {\r\n            clearTimeout(this.idleTimer)\r\n        }\r\n\r\n        // Set new idle timer\r\n        this.idleTimer = setTimeout(() => {\r\n            this.checkIdleAndAnalyze()\r\n        }, this.config.minIdleTime)\r\n    }\r\n\r\n    private async checkIdleAndAnalyze() {\r\n        // BUG-085: Null check\r\n        if (!this.doc || this.state === 'disabled') return\r\n\r\n        // BUG-086: Race condition prevention\r\n        if (this.state === 'thinking') return\r\n\r\n        const idleTime = Date.now() - this.lastEditTime\r\n\r\n        // Only analyze if user has been idle\r\n        if (idleTime < this.config.minIdleTime) {\r\n            this.startAnalysisTimer()\r\n            return\r\n        }\r\n\r\n        // Don't analyze if already have pending suggestions\r\n        if (this.suggestions.some(s => s.status === 'pending')) {\r\n            this.startAnalysisTimer()\r\n            return\r\n        }\r\n\r\n        await this.analyze()\r\n\r\n        this.startAnalysisTimer()\r\n    }\r\n\r\n    private buildContext(): WorkspaceContext | null {\r\n        if (!this.doc) return null\r\n\r\n        const editorContent = this.doc.getText('editor-content').toJSON()\r\n        const tasksArray = this.doc.getArray('tasks').toArray() as any[]\r\n\r\n        const tasks = {\r\n            total: tasksArray.length,\r\n            todo: tasksArray.filter(t => t.status === 'todo').length,\r\n            inProgress: tasksArray.filter(t => t.status === 'in-progress').length,\r\n            done: tasksArray.filter(t => t.status === 'done').length,\r\n            items: tasksArray.slice(0, 10).map(t => ({ title: t.title, status: t.status }))\r\n        }\r\n\r\n        return {\r\n            mode: this.currentMode,\r\n            editorContent: editorContent.slice(0, this.config.maxContextChars), // BUG-054: Configurable limit\r\n            editorWordCount: editorContent.split(/\\s+/).filter(Boolean).length,\r\n            tasks,\r\n            recentActivity: this.activityLog.slice(0, 5).map(a => a.message),\r\n            lastEditTime: this.lastEditTime,\r\n            idleTime: Date.now() - this.lastEditTime\r\n        }\r\n    }\r\n\r\n    private buildPrompt(context: WorkspaceContext): AIMessage[] {\r\n        const modeConfig = getModeConfig(context.mode)\r\n\r\n        const systemPrompt = `You are an autonomous AI assistant integrated into a collaborative workspace.\r\nYour persona: ${modeConfig.systemPrompt}\r\n\r\nYou are observing a \"${modeConfig.name}\" workspace. Your job is to proactively help the user by:\r\n1. DETECTING BUGS: Identify syntax errors, logic errors, type mismatches, null reference errors, etc.\r\n2. SUGGESTING FIXES: Provide concrete code fixes or improvements\r\n3. CODE QUALITY: Find code smells, unused variables, missing error handling, potential performance issues\r\n4. BEST PRACTICES: Suggest improvements for readability, maintainability, and security\r\n\r\nAVAILABLE TOOLS: You can call these tools using JSON format.\r\n\r\nWORKSPACE PATH: ${this.workspacePath || 'Not set'}\r\n\r\nTool Definitions:\r\n${getToolsDescription()}\r\n\r\nTo use a tool, create a suggestion with action \"tool-call\" and payload:\r\n<tool_call>\r\n{\"tool\": \"toolName\", \"params\": {\"param1\": \"value1\"}}\r\n</tool_call>\r\n\r\nOr use the action format: { \"action\": \"tool-call\", \"payload\": { \"tool\": \"toolName\", \"params\": {...} } }\r\n\r\nIMPORTANT: Respond ONLY with valid JSON in this exact format:\r\n{\r\n  \"suggestions\": [\r\n    {\r\n      \"action\": \"edit\" | \"create-task\" | \"suggest\" | \"comment\" | \"organize\" | \"tool-call\",\r\n      \"target\": \"editor-content\" | \"tasks\" | \"messages\" | \"file-system\",\r\n      \"description\": \"Short description of what to do\",\r\n      \"reasoning\": \"Why this would help the user\",\r\n      \"confidence\": 0.0-1.0,\r\n      \"payload\": { ... action-specific data ... }\r\n    }\r\n  ],\r\n  \"summary\": \"Brief summary of workspace state\"\r\n}\r\n\r\nAction payloads:\r\n- edit: { \"content\": \"text to add/replace\", \"position\": \"append\" | \"prepend\" | \"replace\" }\r\n- create-task: { \"title\": \"task title\", \"status\": \"todo\", \"priority\": \"high\" | \"medium\" | \"low\" }\r\n- suggest: { \"message\": \"suggestion text\", \"category\": \"bug\" | \"improvement\" | \"refactor\" | \"performance\" | \"security\" }\r\n- comment: { \"content\": \"comment text\", \"position\": 0, \"length\": 0 }\r\n- organize: { \"sections\": [{ \"title\": \"...\", \"content\": \"...\" }] }\r\n- tool-call: { \"tool\": \"toolName\", \"params\": { ... } }\r\n\r\nGuidelines:\r\n- PRIORITY: Focus on bugs and errors first\r\n- Suggest 1-3 actions maximum\r\n- Be specific and actionable\r\n- For bugs: Explain the issue clearly and provide the fix\r\n- For improvements: Explain the benefit\r\n- Use tools when you need to read files, check project structure, or analyze dependencies\r\n- If the code is well-written, suggest few or no changes`\r\n\r\n        const userPrompt = `Analyze this workspace for bugs, errors, and improvements:\r\n\r\n## Current Mode: ${modeConfig.name}\r\n${modeConfig.icon}\r\n\r\n## Editor Content (${context.editorWordCount} words):\r\n${context.editorContent || '(empty)'}\r\n\r\n## Tasks: ${context.tasks.total} total (${context.tasks.todo} todo, ${context.tasks.inProgress} in progress, ${context.tasks.done} done)\r\n${context.tasks.items.map(t => `- [${t.status}] ${t.title}`).join('\\n') || '(no tasks)'}\r\n\r\n## User has been idle for ${Math.round(context.idleTime / 1000)} seconds\r\n\r\nFOCUS ON:\r\n1. Syntax errors or bugs in the code\r\n2. Logic errors that could cause runtime issues\r\n3. Code quality issues (unused variables, missing error handling)\r\n4. Potential performance or security problems\r\n5. Incomplete or inconsistent task implementations\r\n\r\nProvide your suggestions as JSON:`\r\n\r\n        return [\r\n            { role: 'system', content: systemPrompt },\r\n            { role: 'user', content: userPrompt }\r\n        ]\r\n    }\r\n\r\n    private async analyze() {\r\n        const context = this.buildContext()\r\n        if (!context) return\r\n\r\n        // Skip analysis if content is too small\r\n        if (context.editorWordCount < 5 && context.tasks.total === 0) {\r\n            return\r\n        }\r\n\r\n        this.setState('thinking')\r\n        this.addActivity('analysis', 'Analyzing workspace...')\r\n\r\n        // Create new AbortController for this request\r\n        this.abortController = new AbortController()\r\n        const abortSignal = this.abortController.signal\r\n\r\n        // Retry logic with exponential backoff\r\n        const MAX_RETRIES = 3\r\n        let lastError: Error | null = null\r\n\r\n        for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {\r\n            try {\r\n                // Wait with exponential backoff before retry (skip first attempt)\r\n                if (attempt > 0) {\r\n                    const backoffMs = Math.min(1000 * Math.pow(2, attempt - 1), 8000)\r\n                    this.addActivity('analysis', `Retrying analysis (attempt ${attempt + 1}/${MAX_RETRIES})...`)\r\n                    await new Promise(resolve => setTimeout(resolve, backoffMs))\r\n                }\r\n\r\n                // BUG-089: Timeout for AI calls - increased for large context analysis\r\n                const timeoutMs = this.useOfflineAI ? 90000 : 60000 // 90s for offline, 60s for cloud\r\n                const timeoutPromise = new Promise<any>((_, reject) => {\r\n                    const timeoutId = setTimeout(() => reject(new Error('AI request timed out')), timeoutMs)\r\n                    // Clear timeout if aborted\r\n                    abortSignal.addEventListener('abort', () => clearTimeout(timeoutId))\r\n                })\r\n\r\n                const messages = this.buildPrompt(context)\r\n                let responseContent: string\r\n\r\n                if (this.useOfflineAI) {\r\n                    // Use offline LLM - no JSON schema (causes small models to stall)\r\n                    // No thinking instruction - thinking models already do this internally\r\n                    const offlineMessages: OfflineChatMessage[] = messages.map(m => ({\r\n                        role: m.role,\r\n                        content: m.content\r\n                    }))\r\n\r\n                    const offlinePromise = offlineLLMService.generate(offlineMessages, {\r\n                        temperature: 0.3,\r\n                        maxTokens: 1000  // Lower for faster response\r\n                    })\r\n\r\n                    responseContent = await Promise.race([offlinePromise, timeoutPromise])\r\n                } else {\r\n                    // Use cloud AI with thinking mode enabled\r\n                    const chatPromise = aiService.chat(messages, this.provider, {\r\n                        temperature: 0.3,\r\n                        maxTokens: 1500,\r\n                        thinking: true  // Enable extended thinking mode\r\n                    })\r\n\r\n                    const response = await Promise.race([chatPromise, timeoutPromise])\r\n\r\n                    if (response.error) {\r\n                        throw new Error(response.error)\r\n                    }\r\n                    responseContent = response.content\r\n                }\r\n\r\n                // Parse JSON response\r\n                const parsed = this.parseResponse(responseContent)\r\n\r\n                if (parsed.suggestions.length === 0) {\r\n                    this.setState('idle')\r\n                    return\r\n                }\r\n\r\n                // Create suggestion objects\r\n                const newSuggestions: AgentSuggestion[] = parsed.suggestions\r\n                    .slice(0, this.config.maxSuggestions)\r\n                    .filter(s => this.config.enabledActions.includes(s.action))\r\n                    .map(s => ({\r\n                        id: crypto.randomUUID(),\r\n                        action: s.action,\r\n                        target: s.target,\r\n                        description: s.description,\r\n                        reasoning: s.reasoning,\r\n                        confidence: Math.min(1, Math.max(0, s.confidence)),\r\n                        payload: s.payload,\r\n                        timestamp: Date.now(),\r\n                        status: 'pending' as const\r\n                    }))\r\n\r\n                if (newSuggestions.length > 0) {\r\n                    this.suggestions = [...newSuggestions, ...this.suggestions.filter(s => s.status !== 'pending')]\r\n\r\n                    // BUG-088: Cap suggestions array to prevent unbounded growth\r\n                    if (this.suggestions.length > 100) {\r\n                        this.suggestions = this.suggestions.slice(0, 100)\r\n                    }\r\n\r\n                    this.saveSuggestions() // BUG-044\r\n                    this.onSuggestions?.(this.suggestions)\r\n                    this.setState('waiting-approval')\r\n                    this.addActivity('suggestion', `Generated ${newSuggestions.length} suggestion(s)`)\r\n                } else {\r\n                    this.setState('idle')\r\n                }\r\n\r\n                // Success - exit retry loop\r\n                return\r\n\r\n            } catch (error) {\r\n                lastError = error instanceof Error ? error : new Error(String(error))\r\n                logger.agent.warn(`Agent analysis attempt ${attempt + 1} failed`, error)\r\n\r\n                // Don't retry on abort or certain errors\r\n                if (abortSignal.aborted ||\r\n                    lastError.message.includes('API key') ||\r\n                    lastError.message.includes('unauthorized') ||\r\n                    lastError.message.includes('No model loaded')) {\r\n                    break\r\n                }\r\n            }\r\n        }\r\n\r\n        // All retries failed\r\n        logger.agent.error('Agent analysis failed after retries', lastError)\r\n        this.setState('error')\r\n        this.addActivity('error', `Analysis failed: ${lastError?.message || 'Unknown error'}`)\r\n    }\r\n\r\n    private parseResponse(response: string): AgentAIResponse {\r\n        try {\r\n            // Normalize thinking tags: strip <think>, <thinking>, and variations\r\n            let cleanedResponse = response\r\n                .replaceAll(/<think>[\\s\\S]*?<\\/think>/gi, '')\r\n                .replaceAll(/<thinking>[\\s\\S]*?<\\/thinking>/gi, '')\r\n                .replaceAll(/<thought>[\\s\\S]*?<\\/thought>/gi, '')\r\n                .trim()\r\n\r\n            // BUG-087: Robust JSON parsing\r\n            // Extract JSON from markdown blocks if present\r\n            const jsonMatch = /```json\\n([\\s\\S]*?)\\n```/.exec(cleanedResponse) ||\r\n                /```\\n([\\s\\S]*?)\\n```/.exec(cleanedResponse) ||\r\n                /{[\\s\\S]*}/.exec(cleanedResponse)\r\n\r\n            const jsonStr = jsonMatch ? jsonMatch[1] || jsonMatch[0] : cleanedResponse\r\n\r\n            const parsed = JSON.parse(jsonStr)\r\n\r\n            // Validate structure\r\n            if (!parsed.suggestions || !Array.isArray(parsed.suggestions)) {\r\n                return { suggestions: [], summary: 'Failed to parse response structure' }\r\n            }\r\n\r\n            return parsed\r\n        } catch (error) {\r\n            logger.agent.error('Failed to parse AI response', error)\r\n            return {\r\n                suggestions: [],\r\n                summary: 'Start working to generate suggestions.'\r\n            }\r\n        }\r\n    }\r\n\r\n    approveSuggestion(id: string) {\r\n        const suggestion = this.suggestions.find(s => s.id === id)\r\n        if (suggestion?.status !== 'pending') return\r\n\r\n        suggestion.status = 'approved'\r\n        this.saveSuggestions() // BUG-044\r\n        this.onSuggestions?.(this.suggestions)\r\n        this.addActivity('approval', `Approved: ${suggestion.description}`, { suggestionId: id })\r\n\r\n        // Execute the action\r\n        this.executeSuggestion(suggestion)\r\n    }\r\n\r\n    rejectSuggestion(id: string) {\r\n        const suggestion = this.suggestions.find(s => s.id === id)\r\n        if (suggestion?.status !== 'pending') return\r\n\r\n        suggestion.status = 'rejected'\r\n        this.saveSuggestions() // BUG-044\r\n        this.onSuggestions?.(this.suggestions)\r\n        this.addActivity('rejection', `Rejected: ${suggestion.description}`, { suggestionId: id })\r\n\r\n        // Check if all suggestions are handled\r\n        if (!this.suggestions.some(s => s.status === 'pending')) {\r\n            this.setState('idle')\r\n        }\r\n    }\r\n\r\n    rejectAll() {\r\n        this.suggestions.forEach(s => {\r\n            if (s.status === 'pending') {\r\n                s.status = 'rejected'\r\n            }\r\n        })\r\n        this.saveSuggestions() // BUG-044\r\n        this.onSuggestions?.(this.suggestions)\r\n        this.addActivity('rejection', 'Rejected all pending suggestions')\r\n        this.setState('idle')\r\n    }\r\n\r\n    private async executeSuggestion(suggestion: AgentSuggestion) {\r\n        if (!this.doc) return\r\n\r\n        this.setState('executing')\r\n\r\n        try {\r\n            switch (suggestion.action) {\r\n                case 'edit':\r\n                    this.executeEdit(suggestion.payload as EditPayload)\r\n                    break\r\n                case 'create-task':\r\n                    this.executeCreateTask(suggestion.payload as CreateTaskPayload)\r\n                    break\r\n                case 'suggest':\r\n                    // Suggestions are just displayed, no execution needed\r\n                    break\r\n                case 'comment':\r\n                    this.executeComment(suggestion.payload)\r\n                    break\r\n                case 'organize':\r\n                    this.executeOrganize(suggestion.payload)\r\n                    break\r\n                case 'tool-call':\r\n                    await this.executeToolCall(suggestion.payload as ToolCallPayload)\r\n                    break\r\n            }\r\n\r\n            suggestion.status = 'executed'\r\n            this.saveSuggestions() // BUG-044\r\n            this.onSuggestions?.(this.suggestions)\r\n            this.addActivity('execution', `Executed: ${suggestion.description}`, { suggestionId: suggestion.id })\r\n\r\n        } catch (error) {\r\n            logger.agent.error('Failed to execute suggestion', error)\r\n            this.addActivity('error', `Execution failed: ${error instanceof Error ? error.message : 'Unknown error'}`)\r\n        }\r\n\r\n        // Check if all suggestions are handled\r\n        if (!this.suggestions.some(s => s.status === 'pending')) {\r\n            this.setState('idle')\r\n        }\r\n    }\r\n\r\n    private executeEdit(payload: EditPayload) {\r\n        if (!this.doc) return\r\n\r\n        const editorText = this.doc.getText('editor-content')\r\n        const currentContent = editorText.toJSON()\r\n\r\n        switch (payload.position) {\r\n            case 'append':\r\n                editorText.insert(currentContent.length, '\\n\\n' + payload.content)\r\n                break\r\n            case 'prepend':\r\n                editorText.insert(0, payload.content + '\\n\\n')\r\n                break\r\n            case 'replace':\r\n                editorText.delete(0, currentContent.length)\r\n                editorText.insert(0, payload.content)\r\n                break\r\n            case 'insert':\r\n                if (payload.insertAt !== undefined) {\r\n                    editorText.insert(payload.insertAt, payload.content)\r\n                }\r\n                break\r\n            default:\r\n                editorText.insert(currentContent.length, '\\n\\n' + payload.content)\r\n        }\r\n    }\r\n\r\n    // BUG-055: Implement missing actions\r\n    private executeComment(payload: any) {\r\n        if (!this.doc) return\r\n        const editorText = this.doc.getText('editor-content')\r\n        const comment = `\\n// ${payload.content}`\r\n        // Default to append if no position\r\n        const pos = typeof payload.position === 'number' ? payload.position : editorText.length\r\n        editorText.insert(Math.min(pos, editorText.length), comment)\r\n    }\r\n\r\n    private executeOrganize(payload: any) {\r\n        if (!this.doc) return\r\n        const editorText = this.doc.getText('editor-content')\r\n\r\n        if (payload.sections && Array.isArray(payload.sections)) {\r\n            const newContent = payload.sections\r\n                .map((s: any) => `// MARK: ${s.title}\\n${s.content}`)\r\n                .join('\\n\\n')\r\n\r\n            // Delete all and replace\r\n            if (newContent) {\r\n                editorText.delete(0, editorText.length)\r\n                editorText.insert(0, newContent)\r\n            }\r\n        }\r\n    }\r\n\r\n    private executeCreateTask(payload: CreateTaskPayload) {\r\n        if (!this.doc) return\r\n\r\n        const tasksArray = this.doc.getArray('tasks')\r\n        tasksArray.push([{\r\n            id: crypto.randomUUID(),\r\n            title: payload.title,\r\n            status: payload.status || 'todo',\r\n            priority: payload.priority || 'medium',\r\n            createdAt: Date.now(),\r\n            createdBy: 'AI Agent'\r\n        }])\r\n    }\r\n\r\n    private async executeToolCall(payload: ToolCallPayload) {\r\n        logger.agent.info('Executing tool call', { tool: payload.tool, params: payload.params })\r\n\r\n        // Create tool context using the configured workspace path\r\n        const context: ToolContext = {\r\n            workspacePath: this.workspacePath || ''\r\n        }\r\n\r\n        try {\r\n            const result = await executeTool(payload.tool, payload.params, context)\r\n\r\n            if (result.success) {\r\n                this.addActivity('execution', `Tool executed: ${payload.tool}`, {\r\n                    tool: payload.tool,\r\n                    result: result.data\r\n                })\r\n                logger.agent.info('Tool call succeeded', { tool: payload.tool, data: result.data })\r\n            } else {\r\n                this.addActivity('error', `Tool failed: ${payload.tool} - ${result.error}`, {\r\n                    tool: payload.tool,\r\n                    error: result.error\r\n                })\r\n                logger.agent.error('Tool call failed', { tool: payload.tool, error: result.error })\r\n            }\r\n        } catch (error) {\r\n            const errorMsg = error instanceof Error ? error.message : 'Unknown error'\r\n            this.addActivity('error', `Tool exception: ${payload.tool} - ${errorMsg}`)\r\n            logger.agent.error('Tool call exception', { tool: payload.tool, error })\r\n        }\r\n    }\r\n\r\n    getState(): AgentState {\r\n        return this.state\r\n    }\r\n\r\n    getSuggestions(): AgentSuggestion[] {\r\n        return this.suggestions\r\n    }\r\n\r\n    getActivityLog(): ActivityLogEntry[] {\r\n        return this.activityLog\r\n    }\r\n\r\n    clearActivityLog() {\r\n        this.activityLog = []\r\n    }\r\n\r\n    /**\r\n     * Add external suggestions (e.g., from workspace scan)\r\n     */\r\n    addExternalSuggestions(suggestions: Omit<AgentSuggestion, 'id' | 'timestamp' | 'status'>[]) {\r\n        const newSuggestions: AgentSuggestion[] = suggestions.map(s => ({\r\n            ...s,\r\n            id: crypto.randomUUID(),\r\n            timestamp: Date.now(),\r\n            status: 'pending' as const\r\n        }))\r\n\r\n        if (newSuggestions.length > 0) {\r\n            this.suggestions = [...newSuggestions, ...this.suggestions]\r\n\r\n            // Cap suggestions array\r\n            if (this.suggestions.length > 100) {\r\n                this.suggestions = this.suggestions.slice(0, 100)\r\n            }\r\n\r\n            this.saveSuggestions()\r\n            this.onSuggestions?.(this.suggestions)\r\n            this.setState('waiting-approval')\r\n            this.addActivity('suggestion', `Added ${newSuggestions.length} suggestion(s) from workspace scan`)\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Trigger manual analysis (e.g., when user clicks a button)\r\n     */\r\n    async triggerAnalysis() {\r\n        if (this.state === 'thinking' || this.state === 'disabled') {\r\n            return\r\n        }\r\n        await this.analyze()\r\n    }\r\n\r\n    /**\r\n     * Clear all suggestions\r\n     */\r\n    clearSuggestions() {\r\n        this.suggestions = []\r\n        this.saveSuggestions()\r\n        this.onSuggestions?.(this.suggestions)\r\n        this.setState('idle')\r\n        this.addActivity('analysis', 'Cleared all suggestions')\r\n    }\r\n}\r\n\r\n// Singleton instance\r\nexport const agentService = new AgentService()\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\services\\aiService.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":236,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":236,"endColumn":30,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"debug"},"fix":{"range":[7818,7868],"text":""},"desc":"Remove the console.debug()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":398,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":398,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13931,13934],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13931,13934],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":446,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":446,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15818,15821],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15818,15821],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Copyright 2026 Hermes Lekkas.\r\n * PROPRIETARY & CONFIDENTIAL.\r\n * \r\n * This file is part of the Kalynt \"Pro\" Edition.\r\n * Unauthorized copying, distribution, or modification of this file, \r\n * via any medium, is strictly prohibited.\r\n */\r\n\r\n// AI Service - Multi-provider AI integration with streaming support\r\n// Supports OpenAI, Anthropic, and Google AI\r\n\r\nimport { logger } from '../utils/logger'\r\n\r\nexport type AIProvider = 'openai' | 'anthropic' | 'google'\r\n\r\nexport interface AIMessage {\r\n    role: 'user' | 'assistant' | 'system'\r\n    content: string\r\n}\r\n\r\nexport interface AIResponse {\r\n    content: string\r\n    provider: AIProvider\r\n    model: string\r\n    error?: string\r\n    usage?: {\r\n        promptTokens: number\r\n        completionTokens: number\r\n        totalTokens: number\r\n    }\r\n}\r\n\r\nexport interface ImageGenerationResponse {\r\n    url?: string\r\n    base64?: string\r\n    error?: string\r\n}\r\n\r\nexport interface StreamCallbacks {\r\n    onToken: (token: string) => void\r\n    onComplete: (content: string) => void\r\n    onError: (error: string) => void\r\n}\r\n\r\n// Provider-specific API configurations\r\nconst PROVIDER_CONFIG = {\r\n    openai: {\r\n        baseUrl: 'https://api.openai.com/v1',\r\n        models: {\r\n            chat: 'gpt-4o-mini',\r\n            chatPro: 'gpt-4o',\r\n            image: 'dall-e-3'\r\n        }\r\n    },\r\n    anthropic: {\r\n        baseUrl: 'https://api.anthropic.com/v1',\r\n        models: {\r\n            chat: 'claude-3-haiku-20240307',\r\n            chatPro: 'claude-3-5-sonnet-20241022'\r\n        }\r\n    },\r\n    google: {\r\n        baseUrl: 'https://generativelanguage.googleapis.com/v1beta',\r\n        models: {\r\n            chat: 'gemini-1.5-flash',\r\n            chatPro: 'gemini-1.5-pro'\r\n        }\r\n    }\r\n}\r\n\r\nclass AIService {\r\n    private apiKeys: Record<string, string> = {}\r\n    private readonly abortControllers: Map<string, AbortController> = new Map()\r\n\r\n    setAPIKey(provider: AIProvider, key: string) {\r\n        this.apiKeys[provider] = key\r\n    }\r\n\r\n    removeAPIKey(provider: AIProvider) {\r\n        delete this.apiKeys[provider]\r\n    }\r\n\r\n    hasKey(provider: AIProvider): boolean {\r\n        return !!this.apiKeys[provider]\r\n    }\r\n\r\n    getAvailableProviders(): AIProvider[] {\r\n        return Object.keys(this.apiKeys).filter(k => this.apiKeys[k]) as AIProvider[]\r\n    }\r\n\r\n    // Non-streaming chat\r\n    async chat(\r\n        messages: AIMessage[],\r\n        provider: AIProvider = 'openai',\r\n        options?: { model?: string; maxTokens?: number; temperature?: number; thinking?: boolean }\r\n    ): Promise<AIResponse> {\r\n        const key = this.apiKeys[provider]\r\n        if (!key) {\r\n            return { content: '', provider, model: '', error: `No API key for ${provider}` }\r\n        }\r\n\r\n        try {\r\n            if (provider === 'openai') return await this.chatOpenAI(messages, key, options)\r\n            if (provider === 'anthropic') return await this.chatAnthropic(messages, key, options)\r\n            if (provider === 'google') return await this.chatGoogle(messages, key, options)\r\n            return { content: '', provider, model: '', error: 'Unknown provider' }\r\n        } catch (error) {\r\n            return {\r\n                content: '',\r\n                provider,\r\n                model: '',\r\n                error: error instanceof Error ? error.message : 'Unknown error'\r\n            }\r\n        }\r\n    }\r\n\r\n    // Streaming chat\r\n    async chatStream(\r\n        messages: AIMessage[],\r\n        callbacks: StreamCallbacks,\r\n        provider: AIProvider = 'openai',\r\n        options?: { model?: string; maxTokens?: number; temperature?: number; thinking?: boolean }\r\n    ): Promise<string> {\r\n        const key = this.apiKeys[provider]\r\n        if (!key) {\r\n            callbacks.onError(`No API key for ${provider}`)\r\n            return ''\r\n        }\r\n\r\n        const requestId = crypto.randomUUID()\r\n        const abortController = new AbortController()\r\n        this.abortControllers.set(requestId, abortController)\r\n\r\n        try {\r\n            let fullContent = ''\r\n\r\n            if (provider === 'openai') {\r\n                fullContent = await this.streamOpenAI(messages, key, callbacks, abortController.signal, options)\r\n            } else if (provider === 'anthropic') {\r\n                fullContent = await this.streamAnthropic(messages, key, callbacks, abortController.signal, options)\r\n            } else if (provider === 'google') {\r\n                fullContent = await this.streamGoogle(messages, key, callbacks, abortController.signal, options)\r\n            } else {\r\n                callbacks.onError('Unknown provider')\r\n            }\r\n\r\n            callbacks.onComplete(fullContent)\r\n            return fullContent\r\n        } catch (error) {\r\n            if (error instanceof Error && error.name === 'AbortError') {\r\n                return ''\r\n            }\r\n            const errorMsg = error instanceof Error ? error.message : 'Unknown error'\r\n            callbacks.onError(errorMsg)\r\n            return ''\r\n        } finally {\r\n            this.abortControllers.delete(requestId)\r\n        }\r\n    }\r\n\r\n    // Cancel active stream\r\n    cancelStream(requestId?: string) {\r\n        if (requestId) {\r\n            this.abortControllers.get(requestId)?.abort()\r\n        } else {\r\n            // Cancel all\r\n            this.abortControllers.forEach(controller => controller.abort())\r\n            this.abortControllers.clear()\r\n        }\r\n    }\r\n\r\n    private async streamOpenAI(\r\n        messages: AIMessage[],\r\n        apiKey: string,\r\n        callbacks: StreamCallbacks,\r\n        signal: AbortSignal,\r\n        options?: { model?: string; maxTokens?: number; temperature?: number }\r\n    ): Promise<string> {\r\n        const model = options?.model || PROVIDER_CONFIG.openai.models.chat\r\n\r\n        const response = await fetch(`${PROVIDER_CONFIG.openai.baseUrl}/chat/completions`, {\r\n            method: 'POST',\r\n            headers: {\r\n                'Content-Type': 'application/json',\r\n                'Authorization': `Bearer ${apiKey}`\r\n            },\r\n            body: JSON.stringify({\r\n                model,\r\n                messages: messages.map(m => ({ role: m.role, content: m.content })),\r\n                max_tokens: options?.maxTokens || 2048,\r\n                temperature: options?.temperature ?? 0.7,\r\n                stream: true\r\n            }),\r\n            signal\r\n        })\r\n\r\n        if (!response.ok) {\r\n            const error = await response.json().catch(() => ({}))\r\n            throw new Error(error.error?.message || `OpenAI API error: ${response.status}`)\r\n        }\r\n\r\n        const reader = response.body?.getReader()\r\n        if (!reader) throw new Error('No response body')\r\n\r\n        const decoder = new TextDecoder()\r\n        let fullContent = ''\r\n        let iterations = 0\r\n\r\n        while (iterations++ < 1000000) {\r\n            const { done, value } = await reader.read()\r\n            if (done) break\r\n\r\n            const chunk = decoder.decode(value, { stream: true })\r\n            fullContent += this.processOpenAILines(chunk, callbacks)\r\n        }\r\n\r\n        if (iterations >= 1000000) throw new Error('Streaming timeout')\r\n        return fullContent\r\n    }\r\n\r\n    private processOpenAILines(chunk: string, callbacks: StreamCallbacks): string {\r\n        let content = ''\r\n        const lines = chunk.split('\\n').filter(line => line.startsWith('data: '))\r\n        for (const line of lines) {\r\n            const data = line.slice(6)\r\n            if (data === '[DONE]') continue\r\n            try {\r\n                const json = JSON.parse(data)\r\n                const token = json.choices[0]?.delta?.content || ''\r\n                if (token) {\r\n                    content += token\r\n                    callbacks.onToken(token)\r\n                }\r\n            } catch (e) {\r\n                console.debug('[AI] Malformed JSON in stream:', e)\r\n            }\r\n        }\r\n        return content\r\n    }\r\n\r\n    private async streamAnthropic(\r\n        messages: AIMessage[],\r\n        apiKey: string,\r\n        callbacks: StreamCallbacks,\r\n        signal: AbortSignal,\r\n        options?: { model?: string; maxTokens?: number; temperature?: number }\r\n    ): Promise<string> {\r\n        const model = options?.model || PROVIDER_CONFIG.anthropic.models.chat\r\n        const systemMsg = messages.find(m => m.role === 'system')\r\n        const chatMessages = messages.filter(m => m.role !== 'system')\r\n\r\n        const response = await fetch(`${PROVIDER_CONFIG.anthropic.baseUrl}/messages`, {\r\n            method: 'POST',\r\n            headers: {\r\n                'Content-Type': 'application/json',\r\n                'x-api-key': apiKey,\r\n                'anthropic-version': '2023-06-01',\r\n                'anthropic-dangerous-direct-browser-access': 'true'\r\n            },\r\n            body: JSON.stringify({\r\n                model,\r\n                max_tokens: options?.maxTokens || 2048,\r\n                system: systemMsg?.content || 'You are a helpful AI assistant.',\r\n                messages: chatMessages.map(m => ({ role: m.role, content: m.content })),\r\n                stream: true\r\n            }),\r\n            signal\r\n        })\r\n\r\n        if (!response.ok) {\r\n            const error = await response.json().catch(() => ({}))\r\n            throw new Error(error.error?.message || `Anthropic API error: ${response.status}`)\r\n        }\r\n\r\n        const reader = response.body?.getReader()\r\n        if (!reader) throw new Error('No response body')\r\n\r\n        const decoder = new TextDecoder()\r\n        let fullContent = ''\r\n        let iterations = 0\r\n\r\n        while (iterations++ < 1000000) {\r\n            const { done, value } = await reader.read()\r\n            if (done) break\r\n\r\n            const chunk = decoder.decode(value, { stream: true })\r\n            fullContent += this.processAnthropicLines(chunk, callbacks)\r\n        }\r\n\r\n        if (iterations >= 1000000) throw new Error('Streaming timeout')\r\n        return fullContent\r\n    }\r\n\r\n    private processAnthropicLines(chunk: string, callbacks: StreamCallbacks): string {\r\n        let content = ''\r\n        const lines = chunk.split('\\n').filter(line => line.startsWith('data: '))\r\n        for (const line of lines) {\r\n            try {\r\n                const json = JSON.parse(line.slice(6))\r\n                if (json.type === 'content_block_delta') {\r\n                    const token = json.delta?.text || ''\r\n                    if (token) {\r\n                        content += token\r\n                        callbacks.onToken(token)\r\n                    }\r\n                }\r\n            } catch (error) {\r\n                logger.ai.debug('Failed to parse Anthropic stream chunk', { line, error })\r\n            }\r\n        }\r\n        return content\r\n    }\r\n\r\n    private async streamGoogle(\r\n        messages: AIMessage[],\r\n        apiKey: string,\r\n        callbacks: StreamCallbacks,\r\n        signal: AbortSignal,\r\n        options?: { model?: string; maxTokens?: number; temperature?: number }\r\n    ): Promise<string> {\r\n        const model = options?.model || PROVIDER_CONFIG.google.models.chat\r\n\r\n        const contents = messages\r\n            .filter(m => m.role !== 'system')\r\n            .map(m => ({\r\n                role: m.role === 'assistant' ? 'model' : 'user',\r\n                parts: [{ text: m.content }]\r\n            }))\r\n\r\n        const systemInstruction = messages.find(m => m.role === 'system')\r\n\r\n        const response = await fetch(\r\n            `${PROVIDER_CONFIG.google.baseUrl}/models/${model}:streamGenerateContent?key=${apiKey}&alt=sse`,\r\n            {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({\r\n                    contents,\r\n                    systemInstruction: systemInstruction ? { parts: [{ text: systemInstruction.content }] } : undefined,\r\n                    generationConfig: {\r\n                        maxOutputTokens: options?.maxTokens || 2048,\r\n                        temperature: options?.temperature ?? 0.7\r\n                    }\r\n                }),\r\n                signal\r\n            }\r\n        )\r\n\r\n        if (!response.ok) {\r\n            const error = await response.json().catch(() => ({}))\r\n            throw new Error(error.error?.message || `Google AI error: ${response.status}`)\r\n        }\r\n\r\n        const reader = response.body?.getReader()\r\n        const decoder = new TextDecoder()\r\n        let fullContent = ''\r\n\r\n        if (!reader) throw new Error('No response body')\r\n\r\n        // Safety limit (ESL-031)\r\n        let maxIterations = 1000000\r\n        while (maxIterations-- > 0) {\r\n            const { done, value } = await reader.read()\r\n            if (done) break\r\n\r\n            const chunk = decoder.decode(value, { stream: true })\r\n            const lines = chunk.split('\\n').filter(line => line.startsWith('data: '))\r\n\r\n            for (const line of lines) {\r\n                try {\r\n                    const json = JSON.parse(line.slice(6))\r\n                    const token = json.candidates?.[0]?.content?.parts?.[0]?.text || ''\r\n                    if (token) {\r\n                        fullContent += token\r\n                        callbacks.onToken(token)\r\n                    }\r\n                } catch (error) {\r\n                    logger.ai.debug('Failed to parse Google stream chunk', { line, error })\r\n                }\r\n            }\r\n        }\r\n        if (maxIterations <= 0) {\r\n            throw new Error('Streaming timeout: Max iterations reached')\r\n        }\r\n\r\n        return fullContent\r\n    }\r\n\r\n    // Non-streaming implementations\r\n    private async chatOpenAI(\r\n        messages: AIMessage[],\r\n        apiKey: string,\r\n        options?: { model?: string; maxTokens?: number; temperature?: number; thinking?: boolean }\r\n    ): Promise<AIResponse> {\r\n        const model = options?.model || PROVIDER_CONFIG.openai.models.chat\r\n\r\n        const requestBody: any = {\r\n            model,\r\n            messages: messages.map(m => ({ role: m.role, content: m.content })),\r\n            max_tokens: options?.maxTokens || 2048,\r\n            temperature: options?.temperature ?? 0.7\r\n        }\r\n\r\n        // Add reasoning_effort for o1/o3 models with thinking enabled\r\n        if (options?.thinking && (model.includes('o1') || model.includes('o3'))) {\r\n            requestBody.reasoning_effort = 'high'\r\n        }\r\n\r\n        const response = await fetch(`${PROVIDER_CONFIG.openai.baseUrl}/chat/completions`, {\r\n            method: 'POST',\r\n            headers: {\r\n                'Content-Type': 'application/json',\r\n                'Authorization': `Bearer ${apiKey}`\r\n            },\r\n            body: JSON.stringify(requestBody)\r\n        })\r\n\r\n        if (!response.ok) {\r\n            const error = await response.json().catch(() => ({}))\r\n            throw new Error(error.error?.message || `OpenAI API error: ${response.status}`)\r\n        }\r\n\r\n        const data = await response.json()\r\n        return {\r\n            content: data.choices[0]?.message?.content || '',\r\n            provider: 'openai',\r\n            model,\r\n            usage: data.usage ? {\r\n                promptTokens: data.usage.prompt_tokens,\r\n                completionTokens: data.usage.completion_tokens,\r\n                totalTokens: data.usage.total_tokens\r\n            } : undefined\r\n        }\r\n    }\r\n\r\n    private async chatAnthropic(\r\n        messages: AIMessage[],\r\n        apiKey: string,\r\n        options?: { model?: string; maxTokens?: number; temperature?: number; thinking?: boolean }\r\n    ): Promise<AIResponse> {\r\n        const model = options?.model || PROVIDER_CONFIG.anthropic.models.chat\r\n        const systemMsg = messages.find(m => m.role === 'system')\r\n        const chatMessages = messages.filter(m => m.role !== 'system')\r\n\r\n        const requestBody: any = {\r\n            model,\r\n            max_tokens: options?.maxTokens || 2048,\r\n            system: systemMsg?.content || 'You are a helpful AI assistant.',\r\n            messages: chatMessages.map(m => ({ role: m.role, content: m.content }))\r\n        }\r\n\r\n        // Add extended thinking for Claude models\r\n        if (options?.thinking) {\r\n            requestBody.thinking = {\r\n                type: 'enabled',\r\n                budget_tokens: 1024\r\n            }\r\n        }\r\n\r\n        const response = await fetch(`${PROVIDER_CONFIG.anthropic.baseUrl}/messages`, {\r\n            method: 'POST',\r\n            headers: {\r\n                'Content-Type': 'application/json',\r\n                'x-api-key': apiKey,\r\n                'anthropic-version': '2023-06-01',\r\n                'anthropic-dangerous-direct-browser-access': 'true'\r\n            },\r\n            body: JSON.stringify(requestBody)\r\n        })\r\n\r\n        if (!response.ok) {\r\n            const error = await response.json().catch(() => ({}))\r\n            throw new Error(error.error?.message || `Anthropic API error: ${response.status}`)\r\n        }\r\n\r\n        const data = await response.json()\r\n        return {\r\n            content: data.content[0]?.text || '',\r\n            provider: 'anthropic',\r\n            model,\r\n            usage: data.usage ? {\r\n                promptTokens: data.usage.input_tokens,\r\n                completionTokens: data.usage.output_tokens,\r\n                totalTokens: data.usage.input_tokens + data.usage.output_tokens\r\n            } : undefined\r\n        }\r\n    }\r\n\r\n    private async chatGoogle(\r\n        messages: AIMessage[],\r\n        apiKey: string,\r\n        options?: { model?: string; maxTokens?: number; temperature?: number }\r\n    ): Promise<AIResponse> {\r\n        const model = options?.model || PROVIDER_CONFIG.google.models.chat\r\n\r\n        const contents = messages\r\n            .filter(m => m.role !== 'system')\r\n            .map(m => ({\r\n                role: m.role === 'assistant' ? 'model' : 'user',\r\n                parts: [{ text: m.content }]\r\n            }))\r\n\r\n        const systemInstruction = messages.find(m => m.role === 'system')\r\n\r\n        const response = await fetch(\r\n            `${PROVIDER_CONFIG.google.baseUrl}/models/${model}:generateContent?key=${apiKey}`,\r\n            {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({\r\n                    contents,\r\n                    systemInstruction: systemInstruction ? { parts: [{ text: systemInstruction.content }] } : undefined,\r\n                    generationConfig: {\r\n                        maxOutputTokens: options?.maxTokens || 2048,\r\n                        temperature: options?.temperature ?? 0.7\r\n                    }\r\n                })\r\n            }\r\n        )\r\n\r\n        if (!response.ok) {\r\n            const error = await response.json().catch(() => ({}))\r\n            throw new Error(error.error?.message || `Google AI error: ${response.status}`)\r\n        }\r\n\r\n        const data = await response.json()\r\n        return {\r\n            content: data.candidates[0]?.content?.parts[0]?.text || '',\r\n            provider: 'google',\r\n            model,\r\n            usage: data.usageMetadata ? {\r\n                promptTokens: data.usageMetadata.promptTokenCount || 0,\r\n                completionTokens: data.usageMetadata.candidatesTokenCount || 0,\r\n                totalTokens: data.usageMetadata.totalTokenCount || 0\r\n            } : undefined\r\n        }\r\n    }\r\n\r\n    async generateImage(\r\n        prompt: string,\r\n        options?: { size?: string; quality?: string }\r\n    ): Promise<ImageGenerationResponse> {\r\n        const key = this.apiKeys.openai\r\n        if (!key) {\r\n            return { error: 'OpenAI API key required for image generation' }\r\n        }\r\n\r\n        try {\r\n            const response = await fetch(`${PROVIDER_CONFIG.openai.baseUrl}/images/generations`, {\r\n                method: 'POST',\r\n                headers: {\r\n                    'Content-Type': 'application/json',\r\n                    'Authorization': `Bearer ${key}`\r\n                },\r\n                body: JSON.stringify({\r\n                    model: 'dall-e-3',\r\n                    prompt,\r\n                    n: 1,\r\n                    size: options?.size || '1024x1024',\r\n                    quality: options?.quality || 'standard',\r\n                    response_format: 'url'\r\n                })\r\n            })\r\n\r\n            if (!response.ok) {\r\n                const error = await response.json().catch(() => ({}))\r\n                throw new Error(error.error?.message || `DALL-E error: ${response.status}`)\r\n            }\r\n\r\n            const data = await response.json()\r\n            return { url: data.data[0]?.url }\r\n        } catch (error) {\r\n            return { error: error instanceof Error ? error.message : 'Image generation failed' }\r\n        }\r\n    }\r\n\r\n    // Quick helper methods\r\n    async summarize(text: string, provider: AIProvider = 'openai'): Promise<string> {\r\n        const response = await this.chat([\r\n            { role: 'system', content: 'Summarize the following text concisely.' },\r\n            { role: 'user', content: text }\r\n        ], provider)\r\n        return response.content || response.error || ''\r\n    }\r\n\r\n    async fixGrammar(text: string, provider: AIProvider = 'openai'): Promise<string> {\r\n        const response = await this.chat([\r\n            { role: 'system', content: 'Fix any grammar and spelling errors in this text. Return only the corrected text.' },\r\n            { role: 'user', content: text }\r\n        ], provider)\r\n        return response.content || response.error || ''\r\n    }\r\n\r\n    async generateCode(prompt: string, language: string, provider: AIProvider = 'openai'): Promise<string> {\r\n        const response = await this.chat([\r\n            { role: 'system', content: `You are a helpful coding assistant. Generate ${language} code based on the user's request. Return only code, no explanations.` },\r\n            { role: 'user', content: prompt }\r\n        ], provider)\r\n        return response.content || response.error || ''\r\n    }\r\n\r\n    async expandText(text: string, provider: AIProvider = 'openai'): Promise<string> {\r\n        const response = await this.chat([\r\n            { role: 'system', content: 'Expand and elaborate on the following text while maintaining its tone and style.' },\r\n            { role: 'user', content: text }\r\n        ], provider)\r\n        return response.content || response.error || ''\r\n    }\r\n}\r\n\r\n// Singleton instance\r\nexport const aiService = new AIService()\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\services\\collabEngine.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":24,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":24,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[648,651],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[648,651],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":66,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":66,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1921,1924],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1921,1924],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":75,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":75,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2257,2260],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2257,2260],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":297,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":297,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[8990,9050],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":344,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":344,"endColumn":25,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[10752,10816],"text":""},"desc":"Remove the console.warn()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n\r\n// Collaborative Editing Engine - Enhanced Yjs wrapper with advanced features\r\nimport * as Y from 'yjs'\r\nimport { IndexeddbPersistence } from 'y-indexeddb'\r\nimport { WebrtcProvider } from 'y-webrtc'\r\n\r\nexport interface CursorPosition {\r\n    clientId: number\r\n    user: { name: string; color: string }\r\n    anchor: number\r\n    head: number\r\n    selection?: { from: number; to: number }\r\n}\r\n\r\nexport interface EditOperation {\r\n    id: string\r\n    type: 'insert' | 'delete' | 'format' | 'undo' | 'redo'\r\n    position: number\r\n    content?: string\r\n    length?: number\r\n    format?: Record<string, any>\r\n    timestamp: number\r\n    userId: string\r\n}\r\n\r\nexport interface DocumentSnapshot {\r\n    id: string\r\n    docId: string\r\n    timestamp: number\r\n    userId: string\r\n    label?: string\r\n    state: Uint8Array\r\n}\r\n\r\nexport interface CollabConfig {\r\n    enableHistory: boolean\r\n    maxHistoryItems: number\r\n    autoSaveInterval: number\r\n    enablePresence: boolean\r\n}\r\n\r\nconst DEFAULT_CONFIG: CollabConfig = {\r\n    enableHistory: true,\r\n    maxHistoryItems: 50,\r\n    autoSaveInterval: 5000,\r\n    enablePresence: true\r\n}\r\n\r\nclass CollaborativeEngine {\r\n    private docs: Map<string, Y.Doc> = new Map()\r\n    private providers: Map<string, WebrtcProvider> = new Map()\r\n    private persistence: Map<string, IndexeddbPersistence> = new Map()\r\n    private undoManagers: Map<string, Y.UndoManager> = new Map()\r\n    private snapshots: Map<string, DocumentSnapshot[]> = new Map()\r\n\r\n    private config: CollabConfig = DEFAULT_CONFIG\r\n    // BUG-078: Creation lock to prevent race conditions\r\n    private creationLocks: Set<string> = new Set()\r\n\r\n    // Callbacks\r\n    private onUpdate: ((docId: string, update: Uint8Array) => void) | null = null\r\n    private onCursor: ((docId: string, cursors: CursorPosition[]) => void) | null = null\r\n    private onStats: ((docId: string, stats: any) => void) | null = null\r\n\r\n    setConfig(config: Partial<CollabConfig>) {\r\n        this.config = { ...this.config, ...config }\r\n    }\r\n\r\n    setCallbacks(\r\n        onUpdate: (docId: string, update: Uint8Array) => void,\r\n        onCursor: (docId: string, cursors: CursorPosition[]) => void,\r\n        onStats?: (docId: string, stats: any) => void\r\n    ) {\r\n        this.onUpdate = onUpdate\r\n        this.onCursor = onCursor\r\n        this.onStats = onStats || null\r\n    }\r\n\r\n    // Create or get a document\r\n    getDocument(docId: string): Y.Doc {\r\n        // BUG-079: Validation\r\n        if (!/^[a-zA-Z0-9_\\-./]+$/.test(docId)) {\r\n            throw new Error(`Invalid docId format: ${docId}`)\r\n        }\r\n\r\n        if (this.docs.has(docId)) {\r\n            return this.docs.get(docId)!\r\n        }\r\n\r\n        // BUG-078: Check creation lock\r\n        if (this.creationLocks.has(docId)) {\r\n            // In a sync environment, this shouldn't happen unless called recursively or if init became async.\r\n            // We'll throw to be safe or return existing if we could (but we can't wait synchronously).\r\n            // Given the architecture, if we hit this, something is wrong.\r\n            throw new Error(`Document ${docId} is being initialized`)\r\n        }\r\n\r\n        this.creationLocks.add(docId)\r\n\r\n        try {\r\n            const doc = new Y.Doc()\r\n            this.docs.set(docId, doc)\r\n\r\n            // Set up persistence\r\n            const persistence = new IndexeddbPersistence(docId, doc)\r\n            this.persistence.set(docId, persistence)\r\n\r\n            // Set up undo manager for editor content\r\n            const editorText = doc.getText('editor-content')\r\n            const undoManager = new Y.UndoManager(editorText, {\r\n                captureTimeout: 500\r\n            })\r\n            this.undoManagers.set(docId, undoManager)\r\n\r\n            // Track updates\r\n            doc.on('update', (update: Uint8Array) => {\r\n                this.onUpdate?.(docId, update)\r\n                // BUG-057: Trigger stats update on content change\r\n                this.onStats?.(docId, this.getStats(docId))\r\n            })\r\n\r\n\r\n            return doc\r\n\r\n        } finally {\r\n            this.creationLocks.delete(docId)\r\n        }\r\n    }\r\n\r\n    destroyDocument(docId: string) {\r\n        this.disconnectP2P(docId)\r\n\r\n        const persistence = this.persistence.get(docId)\r\n        if (persistence) {\r\n            persistence.destroy()\r\n            this.persistence.delete(docId)\r\n        }\r\n\r\n        const undoManager = this.undoManagers.get(docId)\r\n        if (undoManager) {\r\n            undoManager.destroy()\r\n            this.undoManagers.delete(docId)\r\n        }\r\n\r\n        const doc = this.docs.get(docId)\r\n        if (doc) {\r\n            doc.destroy()\r\n            this.docs.delete(docId)\r\n        }\r\n\r\n        this.snapshots.delete(docId)\r\n    }\r\n\r\n    // Connect to P2P network\r\n    connectP2P(docId: string, roomId: string, signalingServers?: string[]): WebrtcProvider {\r\n        const doc = this.getDocument(docId)\r\n\r\n        if (this.providers.has(docId)) {\r\n            return this.providers.get(docId)!\r\n        }\r\n\r\n        const provider = new WebrtcProvider(roomId, doc, {\r\n            signaling: signalingServers || [\r\n                'wss://signaling.yjs.dev',\r\n                'wss://y-webrtc-signaling-eu.herokuapp.com'\r\n            ]\r\n        })\r\n\r\n        // Track cursor positions\r\n        if (this.config.enablePresence) {\r\n            provider.awareness.on('change', () => {\r\n                const cursors = this.getCursors(docId)\r\n                this.onCursor?.(docId, cursors)\r\n                // BUG-057: Trigger stats update on peer change\r\n                this.onStats?.(docId, this.getStats(docId))\r\n            })\r\n        }\r\n\r\n        this.providers.set(docId, provider)\r\n        return provider\r\n    }\r\n\r\n    // Disconnect from P2P\r\n    disconnectP2P(docId: string) {\r\n        const provider = this.providers.get(docId)\r\n        if (provider) {\r\n            provider.destroy()\r\n            this.providers.delete(docId)\r\n        }\r\n    }\r\n\r\n    // Get text content\r\n    getText(docId: string, name: string = 'editor-content'): Y.Text {\r\n        const doc = this.getDocument(docId)\r\n        return doc.getText(name)\r\n    }\r\n\r\n    // Get array\r\n    getArray<T>(docId: string, name: string): Y.Array<T> {\r\n        const doc = this.getDocument(docId)\r\n        return doc.getArray<T>(name)\r\n    }\r\n\r\n    // Get map\r\n    getMap<T>(docId: string, name: string): Y.Map<T> {\r\n        const doc = this.getDocument(docId)\r\n        return doc.getMap<T>(name)\r\n    }\r\n\r\n    // Undo\r\n    undo(docId: string): boolean {\r\n        const manager = this.undoManagers.get(docId)\r\n        if (manager && manager.canUndo()) {\r\n            manager.undo()\r\n            return true\r\n        }\r\n        return false\r\n    }\r\n\r\n    // Redo\r\n    redo(docId: string): boolean {\r\n        const manager = this.undoManagers.get(docId)\r\n        if (manager && manager.canRedo()) {\r\n            manager.redo()\r\n            return true\r\n        }\r\n        return false\r\n    }\r\n\r\n    // Check undo/redo availability\r\n    canUndo(docId: string): boolean {\r\n        return this.undoManagers.get(docId)?.canUndo() || false\r\n    }\r\n\r\n    canRedo(docId: string): boolean {\r\n        return this.undoManagers.get(docId)?.canRedo() || false\r\n    }\r\n\r\n    // Create snapshot\r\n    createSnapshot(docId: string, userId: string, label?: string): DocumentSnapshot {\r\n        const doc = this.docs.get(docId)\r\n        if (!doc) throw new Error('Document not found')\r\n\r\n        const snapshot: DocumentSnapshot = {\r\n            id: crypto.randomUUID(),\r\n            docId,\r\n            timestamp: Date.now(),\r\n            userId,\r\n            label,\r\n            state: Y.encodeStateAsUpdate(doc)\r\n        }\r\n\r\n        // Store snapshot\r\n        if (!this.snapshots.has(docId)) {\r\n            this.snapshots.set(docId, [])\r\n        }\r\n        const snaps = this.snapshots.get(docId)!\r\n        snaps.push(snapshot)\r\n\r\n        // Limit snapshots (BUG-082)\r\n        const limit = this.config.maxHistoryItems\r\n        if (snaps.length > limit) {\r\n            // Remove all excess items, not just one\r\n            snaps.splice(0, snaps.length - limit)\r\n        }\r\n\r\n        return snapshot\r\n    }\r\n\r\n    // Get snapshots\r\n    getSnapshots(docId: string): DocumentSnapshot[] {\r\n        return this.snapshots.get(docId) || []\r\n    }\r\n\r\n    // Restore from snapshot\r\n    restoreSnapshot(docId: string, snapshotId: string): boolean {\r\n        const snaps = this.snapshots.get(docId)\r\n        const snapshot = snaps?.find(s => s.id === snapshotId)\r\n\r\n        if (!snapshot) return false\r\n\r\n        const doc = this.docs.get(docId)\r\n        if (!doc) return false\r\n\r\n        // Create backup before restore\r\n        this.createSnapshot(docId, 'system', 'Auto-backup before restore')\r\n\r\n        // Apply snapshot\r\n        try {\r\n            Y.applyUpdate(doc, snapshot.state)\r\n            return true\r\n        } catch (error) {\r\n            // BUG-080: Improved error handling\r\n            console.error('[Collab] Failed to restore snapshot:', error)\r\n            // Attempt to restore backup if simple apply failed? \r\n            // For now, at least strictly return false so caller knows.\r\n            return false\r\n        }\r\n    }\r\n\r\n    // Get cursors\r\n    getCursors(docId: string): CursorPosition[] {\r\n        const provider = this.providers.get(docId)\r\n        // BUG-081: Check connection status to avoid stuck loops\r\n        if (!provider || !provider.connected) return []\r\n\r\n        const cursors: CursorPosition[] = []\r\n        provider.awareness.getStates().forEach((state, clientId) => {\r\n            if (clientId !== provider.awareness.clientID && state.cursor) {\r\n                cursors.push({\r\n                    clientId,\r\n                    user: state.user || { name: 'Anonymous', color: '#888' },\r\n                    anchor: state.cursor.anchor,\r\n                    head: state.cursor.head,\r\n                    selection: state.cursor.selection\r\n                })\r\n            }\r\n        })\r\n        return cursors\r\n    }\r\n\r\n    // Set local cursor\r\n    setCursor(docId: string, anchor: number, head: number) {\r\n        const provider = this.providers.get(docId)\r\n        if (provider) {\r\n            provider.awareness.setLocalStateField('cursor', { anchor, head })\r\n        }\r\n    }\r\n\r\n    // Set local user\r\n    setLocalUser(docId: string, name: string, color: string) {\r\n        const provider = this.providers.get(docId)\r\n        if (provider) {\r\n            provider.awareness.setLocalStateField('user', { name, color })\r\n        }\r\n    }\r\n\r\n    // Merge documents (for conflict resolution)\r\n    mergeDocuments(targetDocId: string, sourceDocId: string): void {\r\n        if (targetDocId === sourceDocId) {\r\n            console.warn('[Collab] Attempted to merge document with itself')\r\n            return\r\n        }\r\n\r\n        const target = this.docs.get(targetDocId)\r\n        const source = this.docs.get(sourceDocId)\r\n\r\n        if (!target || !source) throw new Error('Documents not found')\r\n\r\n        const sourceState = Y.encodeStateAsUpdate(source)\r\n        Y.applyUpdate(target, sourceState)\r\n    }\r\n\r\n    // Export document state\r\n    exportState(docId: string): Uint8Array | null {\r\n        const doc = this.docs.get(docId)\r\n        if (!doc) return null\r\n        return Y.encodeStateAsUpdate(doc)\r\n    }\r\n\r\n    // Import document state\r\n    importState(docId: string, state: Uint8Array): void {\r\n        const doc = this.getDocument(docId)\r\n        Y.applyUpdate(doc, state)\r\n    }\r\n\r\n\r\n\r\n    // Get stats\r\n    getStats(docId: string): {\r\n        textLength: number\r\n        taskCount: number\r\n        messageCount: number\r\n        snapshotCount: number\r\n        peerCount: number\r\n    } {\r\n        const doc = this.docs.get(docId)\r\n        const provider = this.providers.get(docId)\r\n\r\n        return {\r\n            textLength: doc?.getText('editor-content').length || 0,\r\n            taskCount: doc?.getArray('tasks').length || 0,\r\n            messageCount: doc?.getArray('messages').length || 0,\r\n            snapshotCount: this.snapshots.get(docId)?.length || 0,\r\n            peerCount: provider ? provider.awareness.getStates().size - 1 : 0\r\n        }\r\n    }\r\n}\r\n\r\n// Singleton\r\nexport const collabEngine = new CollaborativeEngine()\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\services\\encryptedProvider.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":150,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":150,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[4351,4416],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":158,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":158,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[4565,4627],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":191,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":191,"endColumn":22,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[5453,5504],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":218,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":218,"endColumn":22,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[6156,6207],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":234,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":234,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[6768,6837],"text":""},"desc":"Remove the console.log()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n// Encrypted WebRTC Provider - Encrypts Yjs updates at the network layer\r\n// This wraps y-webrtc to encrypt/decrypt binary update messages\r\n\r\nimport * as Y from 'yjs'\r\n\r\n// Encryption key storage (derived keys, never raw passwords)\r\nconst derivedKeys = new Map<string, CryptoKey>()\r\n\r\n// Encryption config\r\nconst ALGORITHM = 'AES-GCM'\r\nconst KEY_LENGTH = 256\r\nconst PBKDF2_ITERATIONS = 100000\r\n\r\n/**\r\n * Derive encryption key from password using PBKDF2\r\n * Key is derived once and cached - never store raw password\r\n */\r\nexport async function deriveRoomKey(roomId: string, password: string): Promise<CryptoKey> {\r\n    // Check cache first\r\n    const cacheKey = `${roomId}:${await hashPassword(password)}`\r\n    const cached = derivedKeys.get(cacheKey)\r\n    if (cached) return cached\r\n\r\n    // Create salt from roomId (deterministic for same room)\r\n    const saltString = roomId.padEnd(16, '0').slice(0, 16)\r\n    const salt = new TextEncoder().encode(saltString)\r\n\r\n    // Import password as key material\r\n    const keyMaterial = await crypto.subtle.importKey(\r\n        'raw',\r\n        new TextEncoder().encode(password),\r\n        'PBKDF2',\r\n        false,\r\n        ['deriveBits', 'deriveKey']\r\n    )\r\n\r\n    // Derive AES key\r\n    const key = await crypto.subtle.deriveKey(\r\n        {\r\n            name: 'PBKDF2',\r\n            salt,\r\n            iterations: PBKDF2_ITERATIONS,\r\n            hash: 'SHA-256'\r\n        },\r\n        keyMaterial,\r\n        { name: ALGORITHM, length: KEY_LENGTH },\r\n        false, // not extractable - more secure\r\n        ['encrypt', 'decrypt']\r\n    )\r\n\r\n    derivedKeys.set(cacheKey, key)\r\n    return key\r\n}\r\n\r\n/**\r\n * Hash password for cache key (not for storage)\r\n */\r\nasync function hashPassword(password: string): Promise<string> {\r\n    const data = new TextEncoder().encode(password)\r\n    const hash = await crypto.subtle.digest('SHA-256', data)\r\n    return Array.from(new Uint8Array(hash))\r\n        .map(b => b.toString(16).padStart(2, '0'))\r\n        .join('')\r\n        .substring(0, 16) // Truncate for cache key\r\n}\r\n\r\n/**\r\n * Encrypt Yjs update (binary data) - SYNCHRONOUS after key is derived\r\n * Uses streaming encryption for real-time updates\r\n */\r\nexport async function encryptUpdate(update: Uint8Array, key: CryptoKey): Promise<Uint8Array> {\r\n    // Generate random IV (12 bytes for GCM)\r\n    const iv = crypto.getRandomValues(new Uint8Array(12))\r\n\r\n    // Encrypt the update\r\n    const encrypted = await crypto.subtle.encrypt(\r\n        { name: ALGORITHM, iv },\r\n        key,\r\n        update as BufferSource\r\n    )\r\n\r\n    // Combine: [iv (12 bytes)][encrypted data]\r\n    const result = new Uint8Array(12 + encrypted.byteLength)\r\n    result.set(iv, 0)\r\n    result.set(new Uint8Array(encrypted), 12)\r\n\r\n    return result\r\n}\r\n\r\n/**\r\n * Decrypt Yjs update (binary data)\r\n */\r\nexport async function decryptUpdate(encryptedData: Uint8Array, key: CryptoKey): Promise<Uint8Array> {\r\n    // Extract IV (first 12 bytes)\r\n    const iv = encryptedData.slice(0, 12)\r\n    const ciphertext = encryptedData.slice(12)\r\n\r\n    // Decrypt\r\n    const decrypted = await crypto.subtle.decrypt(\r\n        { name: ALGORITHM, iv },\r\n        key,\r\n        ciphertext\r\n    )\r\n\r\n    return new Uint8Array(decrypted)\r\n}\r\n\r\n/**\r\n * Check if an update is encrypted (has valid structure)\r\n */\r\nexport function isEncryptedUpdate(data: Uint8Array): boolean {\r\n    // Encrypted updates have at least 12 bytes IV + some ciphertext\r\n    // Unencrypted Yjs updates start with specific byte patterns\r\n    return data.length > 12 && data[0] !== 0 // Yjs updates typically start with 0\r\n}\r\n\r\n/**\r\n * Encryption state for a room\r\n */\r\ninterface RoomEncryptionState {\r\n    enabled: boolean\r\n    key: CryptoKey | null\r\n    pendingKey: Promise<CryptoKey> | null\r\n}\r\n\r\nconst roomStates = new Map<string, RoomEncryptionState>()\r\n\r\n/**\r\n * Initialize encryption for a room\r\n */\r\nexport async function initializeRoomEncryption(\r\n    roomId: string,\r\n    password: string\r\n): Promise<void> {\r\n    const state: RoomEncryptionState = {\r\n        enabled: true,\r\n        key: null,\r\n        pendingKey: null\r\n    }\r\n    roomStates.set(roomId, state)\r\n\r\n    // Derive key in background\r\n    state.pendingKey = deriveRoomKey(roomId, password)\r\n    state.key = await state.pendingKey\r\n    state.pendingKey = null\r\n\r\n    console.log(`[Encryption] Room ${roomId} encryption initialized`)\r\n}\r\n\r\n/**\r\n * Disable encryption for a room\r\n */\r\nexport function disableRoomEncryption(roomId: string): void {\r\n    roomStates.delete(roomId)\r\n    console.log(`[Encryption] Room ${roomId} encryption disabled`)\r\n}\r\n\r\n/**\r\n * Get encryption state for a room\r\n */\r\nexport function getRoomEncryptionState(roomId: string): RoomEncryptionState | null {\r\n    return roomStates.get(roomId) || null\r\n}\r\n\r\n/**\r\n * Check if room has encryption ready (key derived)\r\n */\r\nexport function isRoomEncryptionReady(roomId: string): boolean {\r\n    const state = roomStates.get(roomId)\r\n    return state?.enabled === true && state?.key !== null\r\n}\r\n\r\n/**\r\n * Encrypt outgoing message for a room\r\n */\r\nexport async function encryptRoomMessage(\r\n    roomId: string,\r\n    data: Uint8Array\r\n): Promise<Uint8Array> {\r\n    const state = roomStates.get(roomId)\r\n    if (!state?.enabled || !state.key) {\r\n        return data // Return unencrypted if not enabled\r\n    }\r\n\r\n    try {\r\n        return await encryptUpdate(data, state.key)\r\n    } catch (e) {\r\n        console.error('[Encryption] Failed to encrypt:', e)\r\n        return data // Fallback to unencrypted on error\r\n    }\r\n}\r\n\r\n/**\r\n * Decrypt incoming message for a room\r\n */\r\nexport async function decryptRoomMessage(\r\n    roomId: string,\r\n    data: Uint8Array\r\n): Promise<Uint8Array> {\r\n    const state = roomStates.get(roomId)\r\n\r\n    // If encryption not enabled, return as-is\r\n    if (!state?.enabled || !state.key) {\r\n        return data\r\n    }\r\n\r\n    // Check if data looks encrypted\r\n    if (!isEncryptedUpdate(data)) {\r\n        return data // Unencrypted message (legacy or from non-encrypted peer)\r\n    }\r\n\r\n    try {\r\n        return await decryptUpdate(data, state.key)\r\n    } catch (e) {\r\n        console.error('[Encryption] Failed to decrypt:', e)\r\n        throw new Error('Decryption failed - wrong key?')\r\n    }\r\n}\r\n\r\n/**\r\n * Create encrypted document with update interception\r\n * This wraps a Y.Doc to encrypt/decrypt updates\r\n */\r\nexport function createEncryptedDoc(roomId: string, baseDoc?: Y.Doc): Y.Doc {\r\n    const doc = baseDoc || new Y.Doc()\r\n    const state = roomStates.get(roomId)\r\n\r\n    if (state?.enabled && state.key) {\r\n        // Note: Full encryption happens at the y-webrtc provider level\r\n        // This doc instance will have its updates encrypted before network transmission\r\n        console.log('[Encryption] Created encrypted doc wrapper for', roomId)\r\n    }\r\n\r\n    return doc\r\n}\r\n\r\n/**\r\n * LRU Cache with size limit for decrypted data\r\n */\r\nexport class LRUCache<K, V> {\r\n    private cache = new Map<K, { value: V; timestamp: number }>()\r\n    private maxSize: number\r\n    private ttlMs: number\r\n\r\n    constructor(maxSize: number = 1000, ttlMs: number = 5 * 60 * 1000) {\r\n        this.maxSize = maxSize\r\n        this.ttlMs = ttlMs\r\n    }\r\n\r\n    get(key: K): V | undefined {\r\n        const entry = this.cache.get(key)\r\n        if (!entry) return undefined\r\n\r\n        // Check TTL\r\n        if (Date.now() - entry.timestamp > this.ttlMs) {\r\n            this.cache.delete(key)\r\n            return undefined\r\n        }\r\n\r\n        // Move to end (most recently used)\r\n        this.cache.delete(key)\r\n        this.cache.set(key, { ...entry, timestamp: Date.now() })\r\n\r\n        return entry.value\r\n    }\r\n\r\n    set(key: K, value: V): void {\r\n        // Remove oldest if at capacity\r\n        if (this.cache.size >= this.maxSize) {\r\n            const firstKey = this.cache.keys().next().value\r\n            if (firstKey !== undefined) {\r\n                this.cache.delete(firstKey)\r\n            }\r\n        }\r\n\r\n        this.cache.set(key, { value, timestamp: Date.now() })\r\n    }\r\n\r\n    has(key: K): boolean {\r\n        return this.get(key) !== undefined\r\n    }\r\n\r\n    clear(): void {\r\n        this.cache.clear()\r\n    }\r\n\r\n    size(): number {\r\n        return this.cache.size\r\n    }\r\n}\r\n\r\n// Export singleton cache for message decryption\r\nexport const decryptionCache = new LRUCache<string, string>(1000, 5 * 60 * 1000)\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\services\\encryptionService.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":198,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":198,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[6880,6950],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":258,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":258,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[9197,9235],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n// Encryption Service - E2E encryption for P2P communication\r\n// Uses Web Crypto API for browser-native encryption\r\n\r\nexport interface EncryptedPayload {\r\n    iv: string // Base64 initialization vector\r\n    data: string // Base64 encrypted data\r\n    // Note: For AES-GCM, the authentication tag is embedded in the ciphertext\r\n    // returned by crypto.subtle.encrypt, so we don't need a separate tag field\r\n}\r\n\r\nexport interface KeyPair {\r\n    publicKey: CryptoKey\r\n    privateKey: CryptoKey\r\n}\r\n\r\nexport interface EncryptionConfig {\r\n    algorithm: 'AES-GCM' | 'AES-CBC'\r\n    keyLength: 128 | 256\r\n    pbkdf2Iterations: number\r\n}\r\n\r\nconst DEFAULT_CONFIG: EncryptionConfig = {\r\n    algorithm: 'AES-GCM',\r\n    keyLength: 256,\r\n    pbkdf2Iterations: 100000\r\n}\r\n\r\n// Maximum number of room keys to keep in memory (LRU eviction)\r\nconst MAX_ROOM_KEYS = 50\r\n\r\nclass EncryptionService {\r\n    private config: EncryptionConfig = DEFAULT_CONFIG\r\n    private roomKeys: Map<string, CryptoKey> = new Map()\r\n    private keyAccessOrder: string[] = [] // Track access order for LRU eviction\r\n\r\n    setConfig(config: Partial<EncryptionConfig>) {\r\n        this.config = { ...this.config, ...config }\r\n    }\r\n\r\n    // Generate a random encryption key\r\n    // Note: extractable is set to false for security - keys cannot be exported from JS context\r\n    async generateKey(): Promise<CryptoKey> {\r\n        return crypto.subtle.generateKey(\r\n            {\r\n                name: this.config.algorithm,\r\n                length: this.config.keyLength\r\n            },\r\n            false, // NOT extractable - keys stay in CryptoKey form only\r\n            ['encrypt', 'decrypt']\r\n        )\r\n    }\r\n\r\n    // Derive key from password (for room passwords)\r\n    async deriveKeyFromPassword(password: string, salt?: Uint8Array): Promise<{ key: CryptoKey; salt: Uint8Array }> {\r\n        const useSalt = salt || crypto.getRandomValues(new Uint8Array(16))\r\n\r\n        // Import password as key material\r\n        const keyMaterial = await crypto.subtle.importKey(\r\n            'raw',\r\n            new TextEncoder().encode(password),\r\n            'PBKDF2',\r\n            false,\r\n            ['deriveBits', 'deriveKey']\r\n        )\r\n\r\n        // Derive actual key\r\n        // Note: extractable is false for security - derived keys cannot be exported\r\n        const key = await crypto.subtle.deriveKey(\r\n            {\r\n                name: 'PBKDF2',\r\n                salt: useSalt as BufferSource,\r\n                iterations: this.config.pbkdf2Iterations,\r\n                hash: 'SHA-256'\r\n            },\r\n            keyMaterial,\r\n            { name: this.config.algorithm, length: this.config.keyLength } as AesDerivedKeyParams,\r\n            false, // NOT extractable for better security\r\n            ['encrypt', 'decrypt'] as KeyUsage[]\r\n        )\r\n\r\n        return { key, salt: useSalt }\r\n    }\r\n\r\n    // Generate RSA key pair for peer-to-peer key exchange\r\n    async generateKeyPair(): Promise<KeyPair> {\r\n        const keyPair = await crypto.subtle.generateKey(\r\n            {\r\n                name: 'RSA-OAEP',\r\n                modulusLength: 2048,\r\n                publicExponent: new Uint8Array([1, 0, 1]),\r\n                hash: 'SHA-256'\r\n            },\r\n            true,\r\n            ['encrypt', 'decrypt']\r\n        )\r\n\r\n        return {\r\n            publicKey: keyPair.publicKey,\r\n            privateKey: keyPair.privateKey\r\n        }\r\n    }\r\n\r\n    // Export public key for sharing\r\n    async exportPublicKey(publicKey: CryptoKey): Promise<string> {\r\n        const exported = await crypto.subtle.exportKey('spki', publicKey)\r\n        return this.arrayBufferToBase64(exported)\r\n    }\r\n\r\n    // Import public key from peer\r\n    async importPublicKey(base64Key: string): Promise<CryptoKey> {\r\n        const keyData = this.base64ToArrayBuffer(base64Key)\r\n        return crypto.subtle.importKey(\r\n            'spki',\r\n            keyData,\r\n            { name: 'RSA-OAEP', hash: 'SHA-256' },\r\n            true,\r\n            ['encrypt']\r\n        )\r\n    }\r\n\r\n    // Encrypt session key with peer's public key\r\n    async encryptSessionKey(sessionKey: CryptoKey, peerPublicKey: CryptoKey): Promise<string> {\r\n        const rawKey = await crypto.subtle.exportKey('raw', sessionKey)\r\n        const encrypted = await crypto.subtle.encrypt(\r\n            { name: 'RSA-OAEP' },\r\n            peerPublicKey,\r\n            rawKey\r\n        )\r\n        return this.arrayBufferToBase64(encrypted)\r\n    }\r\n\r\n    // Decrypt session key with our private key\r\n    async decryptSessionKey(encryptedKey: string, privateKey: CryptoKey): Promise<CryptoKey> {\r\n        const keyData = this.base64ToArrayBuffer(encryptedKey)\r\n        const rawKey = await crypto.subtle.decrypt(\r\n            { name: 'RSA-OAEP' },\r\n            privateKey,\r\n            keyData\r\n        )\r\n        return crypto.subtle.importKey(\r\n            'raw',\r\n            rawKey,\r\n            { name: this.config.algorithm, length: this.config.keyLength },\r\n            true,\r\n            ['encrypt', 'decrypt']\r\n        )\r\n    }\r\n\r\n    // Encrypt data\r\n    async encrypt(data: string | Uint8Array, key: CryptoKey): Promise<EncryptedPayload> {\r\n        const iv = crypto.getRandomValues(new Uint8Array(12)) // GCM uses 12 bytes\r\n        const encodedData = typeof data === 'string'\r\n            ? new TextEncoder().encode(data)\r\n            : data\r\n\r\n        const encrypted = await crypto.subtle.encrypt(\r\n            { name: this.config.algorithm, iv: iv as BufferSource },\r\n            key,\r\n            encodedData as BufferSource\r\n        )\r\n\r\n        return {\r\n            iv: this.arrayBufferToBase64(iv.buffer as ArrayBuffer),\r\n            data: this.arrayBufferToBase64(encrypted)\r\n        }\r\n    }\r\n\r\n    // Decrypt data\r\n    async decrypt(payload: EncryptedPayload, key: CryptoKey): Promise<Uint8Array> {\r\n        const iv = this.base64ToArrayBuffer(payload.iv)\r\n        const data = this.base64ToArrayBuffer(payload.data)\r\n\r\n        const decrypted = await crypto.subtle.decrypt(\r\n            { name: this.config.algorithm, iv: new Uint8Array(iv) },\r\n            key,\r\n            data\r\n        )\r\n\r\n        return new Uint8Array(decrypted)\r\n    }\r\n\r\n    // Decrypt to string\r\n    async decryptToString(payload: EncryptedPayload, key: CryptoKey): Promise<string> {\r\n        const decrypted = await this.decrypt(payload, key)\r\n        return new TextDecoder().decode(decrypted)\r\n    }\r\n\r\n    // Room key management with LRU eviction\r\n    async setRoomKey(roomId: string, password: string): Promise<void> {\r\n        // Evict oldest keys if at capacity\r\n        while (this.roomKeys.size >= MAX_ROOM_KEYS && this.keyAccessOrder.length > 0) {\r\n            const oldestRoomId = this.keyAccessOrder.shift()\r\n            if (oldestRoomId) {\r\n                this.roomKeys.delete(oldestRoomId)\r\n                console.log(`[Encryption] Evicted key for room ${oldestRoomId} (LRU)`)\r\n            }\r\n        }\r\n\r\n        // Use roomId as salt for deterministic key derivation\r\n        // Note: Using roomId as salt is acceptable for PBKDF2 since it still\r\n        // slows down brute-force attacks. For higher security, use random salt\r\n        // stored alongside room metadata.\r\n        const saltString = roomId.padEnd(16, '0').slice(0, 16)\r\n        const saltArray = new Uint8Array(16)\r\n        for (let i = 0; i < 16; i++) {\r\n            saltArray[i] = saltString.charCodeAt(i)\r\n        }\r\n        const { key } = await this.deriveKeyFromPassword(password, saltArray)\r\n        this.roomKeys.set(roomId, key)\r\n\r\n        // Update access order (most recently accessed at end)\r\n        this.keyAccessOrder = this.keyAccessOrder.filter(id => id !== roomId)\r\n        this.keyAccessOrder.push(roomId)\r\n    }\r\n\r\n    getRoomKey(roomId: string): CryptoKey | undefined {\r\n        // Update access order on read\r\n        if (this.roomKeys.has(roomId)) {\r\n            this.keyAccessOrder = this.keyAccessOrder.filter(id => id !== roomId)\r\n            this.keyAccessOrder.push(roomId)\r\n        }\r\n        return this.roomKeys.get(roomId)\r\n    }\r\n\r\n    // Check if room key exists (useful for UI to decide whether to prompt password)\r\n    hasRoomKey(roomId: string): boolean {\r\n        return this.roomKeys.has(roomId)\r\n    }\r\n\r\n    removeRoomKey(roomId: string): void {\r\n        this.roomKeys.delete(roomId)\r\n        this.keyAccessOrder = this.keyAccessOrder.filter(id => id !== roomId)\r\n    }\r\n\r\n    // Clear all room keys (for security, e.g., on logout or after inactivity)\r\n    clearAllRoomKeys(): void {\r\n        this.roomKeys.clear()\r\n        this.keyAccessOrder = []\r\n    }\r\n\r\n    // Encrypt for room\r\n    async encryptForRoom(roomId: string, data: string): Promise<EncryptedPayload | null> {\r\n        const key = this.roomKeys.get(roomId)\r\n        if (!key) return null\r\n        return this.encrypt(data, key)\r\n    }\r\n\r\n    // Decrypt from room\r\n    async decryptFromRoom(roomId: string, payload: EncryptedPayload): Promise<string | null> {\r\n        const key = this.roomKeys.get(roomId)\r\n        if (!key) return null\r\n        try {\r\n            return await this.decryptToString(payload, key)\r\n        } catch (e) {\r\n            console.error('Decryption failed:', e)\r\n            return null\r\n        }\r\n    }\r\n\r\n    // Generate secure random ID\r\n    generateSecureId(length: number = 32): string {\r\n        const bytes = crypto.getRandomValues(new Uint8Array(length))\r\n        return Array.from(bytes, b => b.toString(16).padStart(2, '0')).join('')\r\n    }\r\n\r\n    // Hash data (for integrity verification)\r\n    async hash(data: string | Uint8Array): Promise<string> {\r\n        const encodedData = typeof data === 'string'\r\n            ? new TextEncoder().encode(data)\r\n            : data\r\n        const hashBuffer = await crypto.subtle.digest('SHA-256', encodedData as BufferSource)\r\n        return this.arrayBufferToBase64(hashBuffer)\r\n    }\r\n\r\n    // Verify integrity\r\n    async verifyHash(data: string | Uint8Array, expectedHash: string): Promise<boolean> {\r\n        const actualHash = await this.hash(data)\r\n        return actualHash === expectedHash\r\n    }\r\n\r\n    // Utility: ArrayBuffer to Base64\r\n    private arrayBufferToBase64(buffer: ArrayBuffer): string {\r\n        const bytes = new Uint8Array(buffer)\r\n        let binary = ''\r\n        for (let i = 0; i < bytes.length; i++) {\r\n            binary += String.fromCharCode(bytes[i])\r\n        }\r\n        return btoa(binary)\r\n    }\r\n\r\n    // Utility: Base64 to ArrayBuffer\r\n    private base64ToArrayBuffer(base64: string): ArrayBuffer {\r\n        const binary = atob(base64)\r\n        const bytes = new Uint8Array(binary.length)\r\n        for (let i = 0; i < binary.length; i++) {\r\n            bytes[i] = binary.charCodeAt(i)\r\n        }\r\n        return bytes.buffer\r\n    }\r\n}\r\n\r\n// Singleton\r\nexport const encryptionService = new EncryptionService()\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\services\\fileTransferService.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":92,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":92,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[2876,2935],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":222,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":222,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[8116,8185],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":225,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":225,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[8274,8332],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":282,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":282,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[10274,10358],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":304,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":304,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[10873,10920],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":358,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":358,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[12916,12969],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n// P2P File Transfer Service - Tiered transfer with chunking\r\nimport * as Y from 'yjs'\r\nimport { collabEngine } from './collabEngine'\r\nimport { p2pService, PeerInfo } from './p2pService'\r\n\r\nexport type TransferTier = 'small' | 'medium' | 'large'\r\n\r\nexport interface SharedFile {\r\n    id: string\r\n    name: string\r\n    size: number\r\n    type: string\r\n    uploadedAt: number\r\n    uploadedBy: string\r\n    ownerId: string\r\n    tier: TransferTier\r\n    // For small files: full content. For medium/large: chunk references\r\n    content?: string\r\n    chunkCount?: number\r\n    isLocal: boolean\r\n}\r\n\r\nexport interface FileChunk {\r\n    fileId: string\r\n    index: number\r\n    data: string // Base64\r\n}\r\n\r\nexport type FileTransferCallback = (files: SharedFile[]) => void\r\nexport type PeersCallback = (peers: PeerInfo[]) => void\r\nexport type ProgressCallback = (fileId: string, progress: number) => void\r\n\r\n// Tier size limits\r\nconst TIER_LIMITS = {\r\n    small: 5 * 1024 * 1024,      // 5MB\r\n    medium: 50 * 1024 * 1024,    // 50MB\r\n    large: 200 * 1024 * 1024     // 200MB\r\n}\r\n\r\nconst CHUNK_SIZE = 256 * 1024 // 256KB chunks\r\n\r\nclass FileTransferService {\r\n    private docId: string | null = null\r\n    private roomId: string | null = null\r\n    private localUserId: string = crypto.randomUUID()\r\n    private onFilesChange: FileTransferCallback | null = null\r\n    private onPeersChange: PeersCallback | null = null\r\n    private onProgress: ProgressCallback | null = null\r\n    private initialized: boolean = false\r\n\r\n    init(roomId: string, docId: string) {\r\n        // Prevent double init or stale observer issues\r\n        if (this.initialized && this.roomId === roomId) return\r\n\r\n        // Set state FIRST before any async operations\r\n        this.roomId = roomId\r\n        this.docId = docId\r\n        this.initialized = true\r\n\r\n        collabEngine.connectP2P(docId, roomId)\r\n\r\n        // Defer observer setup to next tick to avoid race conditions\r\n        // with Yjs triggering observers immediately from persisted IndexedDB data\r\n        setTimeout(() => {\r\n            if (!this.initialized || this.docId !== docId) return\r\n\r\n            const filesMap = this.getFilesMap()\r\n            if (filesMap) {\r\n                filesMap.observe(() => {\r\n                    if (this.initialized && this.docId) this.notifyFilesChange()\r\n                })\r\n            }\r\n\r\n            const chunksMap = this.getChunksMap()\r\n            if (chunksMap) {\r\n                chunksMap.observe(() => {\r\n                    if (this.initialized && this.docId) this.notifyFilesChange()\r\n                })\r\n            }\r\n\r\n            // Trigger initial load\r\n            this.notifyFilesChange()\r\n        }, 0)\r\n\r\n        p2pService.setRoomCallbacks(roomId, {\r\n            onPeers: (peers) => this.onPeersChange?.(peers)\r\n        })\r\n\r\n        console.log('[FileTransfer] Initialized for room:', roomId)\r\n    }\r\n\r\n    destroy() {\r\n        this.initialized = false\r\n        if (this.docId) collabEngine.disconnectP2P(this.docId)\r\n        this.docId = null\r\n        this.roomId = null\r\n    }\r\n\r\n    setCallbacks(onFiles: FileTransferCallback, onPeers: PeersCallback, onProgress?: ProgressCallback) {\r\n        this.onFilesChange = onFiles\r\n        this.onPeersChange = onPeers\r\n        this.onProgress = onProgress || null\r\n    }\r\n\r\n    private getFilesMap(): Y.Map<SharedFile> | null {\r\n        if (!this.docId || !this.initialized) return null\r\n        return collabEngine.getMap<SharedFile>(this.docId, 'shared-files')\r\n    }\r\n\r\n    private getChunksMap(): Y.Map<FileChunk> | null {\r\n        if (!this.docId || !this.initialized) return null\r\n        return collabEngine.getMap<FileChunk>(this.docId, 'file-chunks')\r\n    }\r\n\r\n    private notifyFilesChange() {\r\n        if (!this.onFilesChange || !this.initialized) return\r\n\r\n        const filesMap = this.getFilesMap()\r\n        if (!filesMap) return\r\n\r\n        const files: SharedFile[] = []\r\n\r\n        filesMap.forEach((file) => {\r\n            files.push({\r\n                ...file,\r\n                isLocal: file.ownerId === this.localUserId\r\n            })\r\n        })\r\n\r\n        files.sort((a, b) => b.uploadedAt - a.uploadedAt)\r\n        this.onFilesChange(files)\r\n    }\r\n\r\n    // Determine the actual tier based on file size (with fallback)\r\n    determineTier(fileSize: number, requestedTier: TransferTier): TransferTier {\r\n        if (fileSize <= TIER_LIMITS.small) return 'small'\r\n        if (fileSize <= TIER_LIMITS.medium) return requestedTier === 'small' ? 'medium' : requestedTier\r\n        if (fileSize <= TIER_LIMITS.large) return 'large'\r\n\r\n        // File too large\r\n        throw new Error(`File size ${(fileSize / 1024 / 1024).toFixed(1)}MB exceeds maximum of 200MB`)\r\n    }\r\n\r\n    // Get tier info for UI\r\n    getTierInfo(tier: TransferTier): { label: string; maxSize: string; description: string } {\r\n        switch (tier) {\r\n            case 'small':\r\n                return { label: 'Quick', maxSize: '5MB', description: 'Instant sync (â‰¤5MB)' }\r\n            case 'medium':\r\n                return { label: 'Standard', maxSize: '50MB', description: 'Chunked transfer (â‰¤50MB)' }\r\n            case 'large':\r\n                return { label: 'Large', maxSize: '200MB', description: 'Streaming (â‰¤200MB)' }\r\n        }\r\n    }\r\n\r\n    async shareFile(file: File, uploaderName: string, requestedTier: TransferTier = 'small'): Promise<{ success: boolean; actualTier?: TransferTier; error?: string }> {\r\n        if (!this.docId) return { success: false, error: 'Not initialized' }\r\n\r\n        try {\r\n            const actualTier = this.determineTier(file.size, requestedTier)\r\n            const fileId = crypto.randomUUID()\r\n\r\n            if (actualTier === 'small') {\r\n                // Direct inline transfer\r\n                const content = await this.fileToBase64(file)\r\n                const sharedFile: SharedFile = {\r\n                    id: fileId,\r\n                    name: file.name,\r\n                    size: file.size,\r\n                    type: file.type || 'application/octet-stream',\r\n                    uploadedAt: Date.now(),\r\n                    uploadedBy: uploaderName,\r\n                    ownerId: this.localUserId,\r\n                    tier: actualTier,\r\n                    content,\r\n                    isLocal: true\r\n                }\r\n\r\n                const filesMap = this.getFilesMap()\r\n                if (!filesMap) return { success: false, error: 'Not initialized' }\r\n                filesMap.set(fileId, sharedFile)\r\n            } else {\r\n                // Chunked transfer for medium/large\r\n                const chunks = await this.splitFileIntoChunks(file, fileId)\r\n\r\n                // Store file metadata first\r\n                const sharedFile: SharedFile = {\r\n                    id: fileId,\r\n                    name: file.name,\r\n                    size: file.size,\r\n                    type: file.type || 'application/octet-stream',\r\n                    uploadedAt: Date.now(),\r\n                    uploadedBy: uploaderName,\r\n                    ownerId: this.localUserId,\r\n                    tier: actualTier,\r\n                    chunkCount: chunks.length,\r\n                    isLocal: true\r\n                }\r\n\r\n                const filesMap = this.getFilesMap()\r\n                if (!filesMap) return { success: false, error: 'Not initialized' }\r\n                filesMap.set(fileId, sharedFile)\r\n\r\n                // Upload chunks with progress\r\n                const chunksMap = this.getChunksMap()\r\n                if (chunksMap) {\r\n                    for (let i = 0; i < chunks.length; i++) {\r\n                        chunksMap.set(`${fileId}-${i}`, chunks[i])\r\n                        this.onProgress?.(fileId, ((i + 1) / chunks.length) * 100)\r\n\r\n                        // Small delay to prevent overwhelming the sync\r\n                        if (actualTier === 'large' && i % 10 === 0) {\r\n                            await new Promise(r => setTimeout(r, 50))\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n\r\n            console.log(`[FileTransfer] Shared file (${actualTier}):`, file.name)\r\n            return { success: true, actualTier }\r\n        } catch (err) {\r\n            console.error('[FileTransfer] Failed to share file:', err)\r\n            return { success: false, error: String(err) }\r\n        }\r\n    }\r\n\r\n    private async splitFileIntoChunks(file: File, fileId: string): Promise<FileChunk[]> {\r\n        const chunks: FileChunk[] = []\r\n        const totalChunks = Math.ceil(file.size / CHUNK_SIZE)\r\n\r\n        for (let i = 0; i < totalChunks; i++) {\r\n            const start = i * CHUNK_SIZE\r\n            const end = Math.min(start + CHUNK_SIZE, file.size)\r\n            const blob = file.slice(start, end)\r\n            const data = await this.blobToBase64(blob)\r\n\r\n            chunks.push({\r\n                fileId,\r\n                index: i,\r\n                data\r\n            })\r\n        }\r\n\r\n        return chunks\r\n    }\r\n\r\n    private blobToBase64(blob: Blob): Promise<string> {\r\n        return new Promise((resolve, reject) => {\r\n            const reader = new FileReader()\r\n            reader.readAsDataURL(blob)\r\n            reader.onload = () => {\r\n                const result = reader.result as string\r\n                resolve(result.split(',')[1])\r\n            }\r\n            reader.onerror = () => reject(new Error('FileReader error'))\r\n        })\r\n    }\r\n\r\n    removeFile(fileId: string, isAdmin: boolean = false): boolean {\r\n        if (!this.docId || !this.initialized) return false\r\n\r\n        const filesMap = this.getFilesMap()\r\n        if (!filesMap) return false\r\n        const file = filesMap.get(fileId)\r\n\r\n        // Only the owner or an admin can remove a file\r\n        if (file && (file.ownerId === this.localUserId || isAdmin)) {\r\n            // Remove chunks if it's a chunked file\r\n            if (file.chunkCount) {\r\n                const chunksMap = this.getChunksMap()\r\n                if (chunksMap) {\r\n                    for (let i = 0; i < file.chunkCount; i++) {\r\n                        chunksMap.delete(`${fileId}-${i}`)\r\n                    }\r\n                }\r\n            }\r\n\r\n            filesMap.delete(fileId)\r\n            console.log(`[FileTransfer] Removed file (${isAdmin ? 'Admin' : 'Owner'}):`, fileId)\r\n            return true\r\n        }\r\n\r\n        return false\r\n    }\r\n\r\n    // Clear all files in the space (admin only)\r\n    clearAllFiles(): boolean {\r\n        if (!this.docId || !this.initialized) return false\r\n\r\n        const filesMap = this.getFilesMap()\r\n        const chunksMap = this.getChunksMap()\r\n        if (!filesMap) return false\r\n\r\n        // Clear all chunks first\r\n        if (chunksMap) {\r\n            chunksMap.clear()\r\n        }\r\n\r\n        // Clear files index\r\n        filesMap.clear()\r\n        console.log('[FileTransfer] Cleared all files')\r\n        return true\r\n    }\r\n\r\n    async downloadFile(file: SharedFile): Promise<boolean> {\r\n        try {\r\n            let fullContent: string\r\n\r\n            if (file.tier === 'small' && file.content) {\r\n                fullContent = file.content\r\n            } else if (file.chunkCount) {\r\n                // Reassemble from chunks\r\n                const chunksMap = this.getChunksMap()\r\n                if (!chunksMap) {\r\n                    alert('File transfer not initialized')\r\n                    return false\r\n                }\r\n                const chunks: string[] = []\r\n\r\n                for (let i = 0; i < file.chunkCount; i++) {\r\n                    const chunk = chunksMap.get(`${file.id}-${i}`)\r\n                    if (!chunk) {\r\n                        alert(`Missing chunk ${i + 1}/${file.chunkCount}. Transfer may be incomplete.`)\r\n                        return false\r\n                    }\r\n                    chunks.push(chunk.data)\r\n                    this.onProgress?.(file.id, ((i + 1) / file.chunkCount) * 100)\r\n                }\r\n\r\n                fullContent = chunks.join('')\r\n            } else {\r\n                alert('File content not available')\r\n                return false\r\n            }\r\n\r\n            // Decode and download\r\n            const byteCharacters = atob(fullContent)\r\n            const byteNumbers = new Uint8Array(byteCharacters.length)\r\n            for (let i = 0; i < byteCharacters.length; i++) {\r\n                byteNumbers[i] = byteCharacters.charCodeAt(i)\r\n            }\r\n            const blob = new Blob([byteNumbers], { type: file.type })\r\n\r\n            const url = window.URL.createObjectURL(blob)\r\n            const a = document.createElement('a')\r\n            a.href = url\r\n            a.download = file.name\r\n            document.body.appendChild(a)\r\n            a.click()\r\n            document.body.removeChild(a)\r\n            window.URL.revokeObjectURL(url)\r\n\r\n            return true\r\n        } catch (err) {\r\n            console.error('[FileTransfer] Download failed:', err)\r\n            return false\r\n        }\r\n    }\r\n\r\n    getFiles(): SharedFile[] {\r\n        if (!this.docId || !this.initialized) return []\r\n\r\n        const filesMap = this.getFilesMap()\r\n        if (!filesMap) return []\r\n        const files: SharedFile[] = []\r\n\r\n        filesMap.forEach((file) => {\r\n            files.push({\r\n                ...file,\r\n                isLocal: file.ownerId === this.localUserId\r\n            })\r\n        })\r\n\r\n        return files.sort((a, b) => b.uploadedAt - a.uploadedAt)\r\n    }\r\n\r\n    getPeers(): PeerInfo[] {\r\n        if (!this.roomId) return []\r\n        return p2pService.getConnectedPeers(this.roomId)\r\n    }\r\n\r\n    private fileToBase64(file: File): Promise<string> {\r\n        return new Promise((resolve, reject) => {\r\n            const reader = new FileReader()\r\n            reader.readAsDataURL(file)\r\n            reader.onload = () => {\r\n                const result = reader.result as string\r\n                resolve(result.split(',')[1])\r\n            }\r\n            reader.onerror = () => reject(new Error('FileReader error'))\r\n        })\r\n    }\r\n\r\n    getLocalUserId(): string {\r\n        return this.localUserId\r\n    }\r\n}\r\n\r\nexport const fileTransferService = new FileTransferService()\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\services\\hardwareService.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":45,"column":63,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":45,"endColumn":66,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1353,1356],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1353,1356],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":53,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":53,"endColumn":30,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[1635,1705],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":65,"column":63,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":65,"endColumn":66,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2030,2033],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2030,2033],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":70,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":70,"endColumn":30,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[2203,2275],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n// Hardware Detection Service\n// Detects system hardware capabilities for AIME optimization\n\nimport type { HardwareInfo } from '../types/aime'\n\nexport interface RealTimeStats {\n    cpuUsage: number\n    ramUsage: number\n    ramTotal: number\n    gpuUsage: number      // Current GPU load %\n    vramUsage: number     // VRAM used in MB\n    vramTotal: number     // VRAM total in MB\n    diskUsage: number\n    diskTotal: number\n    diskIOSpeed: number   // MB/s\n    networkConnected: boolean\n    networkLatency?: number\n}\n\n/**\n * Hardware Detection Service\n * Queries system information from Electron main process\n */\nclass HardwareService {\n    private cachedInfo: HardwareInfo | null = null\n    private lastUpdate: number = 0\n    private readonly CACHE_DURATION = 30000 // 30 seconds\n\n    /**\n     * Get current hardware information\n     * @param forceRefresh - Force a refresh even if cached\n     */\n    async getHardwareInfo(forceRefresh: boolean = false): Promise<HardwareInfo> {\n        const now = Date.now()\n\n        // Return cached if still valid\n        if (!forceRefresh && this.cachedInfo && (now - this.lastUpdate) < this.CACHE_DURATION) {\n            return this.cachedInfo\n        }\n\n        // Query hardware from main process\n        const electronAPI = globalThis.window?.electronAPI as any\n        if (electronAPI?.getHardwareInfo) {\n            try {\n                const info = await electronAPI.getHardwareInfo()\n                this.cachedInfo = info\n                this.lastUpdate = now\n                return info\n            } catch (error) {\n                console.error('[HardwareService] Failed to get hardware info:', error)\n            }\n        }\n\n        // Fallback to defaults if IPC not available\n        return this.getFallbackHardwareInfo()\n    }\n\n    /**\n     * Get real-time system stats (CPU, RAM, Disk, Network)\n     */\n    async getRealTimeStats(): Promise<RealTimeStats> {\n        const electronAPI = globalThis.window?.electronAPI as any\n        if (electronAPI?.getRealTimeStats) {\n            try {\n                return await electronAPI.getRealTimeStats()\n            } catch (error) {\n                console.error('[HardwareService] Failed to get real-time stats:', error)\n            }\n        }\n\n        // Fallback\n        return {\n            cpuUsage: 0,\n            ramUsage: 4096,\n            ramTotal: 8192,\n            gpuUsage: 0,\n            vramUsage: 0,\n            vramTotal: 4096,\n            diskUsage: 400000,\n            diskTotal: 500000,\n            diskIOSpeed: 0,\n            networkConnected: true\n        }\n    }\n\n    /**\n     * Get GPU information specifically\n     */\n    async getGPUInfo(): Promise<{ hasGPU: boolean; gpuName?: string; totalVRAM?: number; availableVRAM?: number }> {\n        const info = await this.getHardwareInfo()\n        return {\n            hasGPU: info.hasGPU,\n            gpuName: info.gpuName,\n            totalVRAM: info.totalVRAM,\n            availableVRAM: info.availableVRAM\n        }\n    }\n\n    /**\n     * Get RAM information specifically\n     */\n    async getRAMInfo(): Promise<{ totalRAM: number; availableRAM: number; usedRAM: number }> {\n        const info = await this.getHardwareInfo()\n        return {\n            totalRAM: info.totalRAM,\n            availableRAM: info.availableRAM,\n            usedRAM: info.usedRAM\n        }\n    }\n\n    /**\n     * Check if GPU acceleration is available\n     */\n    async isGPUAvailable(): Promise<boolean> {\n        const info = await this.getHardwareInfo()\n        return info.hasGPU && (info.totalVRAM ?? 0) > 0\n    }\n\n    /**\n     * Get recommended GPU layers based on available VRAM\n     */\n    async getRecommendedGPULayers(modelSizeMB: number): Promise<number> {\n        const gpuInfo = await this.getGPUInfo()\n\n        if (!gpuInfo.hasGPU || !gpuInfo.availableVRAM) {\n            return 0 // No GPU or no VRAM info\n        }\n\n        // Rough estimate: each layer uses ~modelSize/32 MB of VRAM\n        const vramPerLayer = modelSizeMB / 32\n        const safeVRAM = gpuInfo.availableVRAM * 0.8 // Use 80% of available VRAM\n        const maxLayers = Math.floor(safeVRAM / vramPerLayer)\n\n        // Cap at reasonable numbers\n        return Math.min(maxLayers, 64)\n    }\n\n    /**\n     * Monitor RAM usage in real-time\n     * @param callback - Called with RAM info every second\n     * @returns Cleanup function to stop monitoring\n     */\n    startRAMMonitoring(callback: (ramInfo: { totalRAM: number; availableRAM: number; usedRAM: number }) => void): () => void {\n        const intervalId = setInterval(async () => {\n            const ramInfo = await this.getRAMInfo()\n            callback(ramInfo)\n        }, 1000)\n\n        return () => clearInterval(intervalId)\n    }\n\n    /**\n     * Monitor all resources in real-time\n     * @param callback - Called with stats every second\n     * @returns Cleanup function to stop monitoring\n     */\n    startResourceMonitoring(callback: (stats: RealTimeStats) => void): () => void {\n        const intervalId = setInterval(async () => {\n            const stats = await this.getRealTimeStats()\n            callback(stats)\n        }, 1000)\n\n        return () => clearInterval(intervalId)\n    }\n\n    /**\n     * Fallback hardware info for when IPC is not available\n     */\n    private getFallbackHardwareInfo(): HardwareInfo {\n        // Try to get some basic info from browser APIs\n        const cpuCores = navigator.hardwareConcurrency || 4\n\n        return {\n            cpuCores: cpuCores,\n            cpuThreads: cpuCores,\n            cpuModel: 'Unknown CPU',\n            totalRAM: 8192,      // Assume 8GB\n            availableRAM: 4096,  // Assume 4GB available\n            usedRAM: 4096,\n            hasGPU: false,\n            totalDiskSpace: 500000,      // Assume 500GB\n            availableDiskSpace: 100000   // Assume 100GB free\n        }\n    }\n\n    /**\n     * Clear cache (useful for testing)\n     */\n    clearCache(): void {\n        this.cachedInfo = null\n        this.lastUpdate = 0\n    }\n}\n\n// Export singleton instance\nexport const hardwareService = new HardwareService()\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\services\\ideAgentTools.ts","messages":[{"ruleId":"prefer-const","severity":2,"message":"'searchPath' is never reassigned. Use 'const' instead.","line":588,"column":17,"nodeType":"Identifier","messageId":"useConst","endLine":588,"endColumn":27,"fix":{"range":[21133,21196],"text":"const searchPath = params.path as string || context.workspacePath"}},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":1024,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1024,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[36718,36721],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[36718,36721],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":1027,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1027,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[36808,36811],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[36808,36811],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":1,"fixableWarningCount":0,"source":"/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n\r\n/**\r\n * IDE Agent Tools - File system and code execution tools for AI agents\r\n * These tools allow AI agents to interact with the IDE's file system,\r\n * execute code, and perform other IDE operations.\r\n */\r\n\r\nimport { logger } from '../utils/logger'\r\nimport { validatePath } from '../utils/path-validator'\r\n\r\nexport interface ToolResult {\r\n    success: boolean\r\n    data?: unknown\r\n    error?: string\r\n}\r\n\r\nexport interface ToolContext {\r\n    workspacePath: string\r\n}\r\n\r\nexport interface ToolCallRequest {\r\n    id: string\r\n    toolName: string\r\n    params: Record<string, unknown>\r\n    timestamp: number\r\n}\r\n\r\n// Tool Permission Middleware\r\nclass ToolPermissionManager {\r\n    private readonly alwaysAllowedTools: Set<string> = new Set()\r\n    private readOnlyAutoAllow: boolean = false\r\n    private trustedMode: boolean = false\r\n    private confirmationHandler: ((request: ToolCallRequest) => Promise<{ approved: boolean; alwaysAllow: boolean }>) | null = null\r\n\r\n    setConfirmationHandler(handler: (request: ToolCallRequest) => Promise<{ approved: boolean; alwaysAllow: boolean }>) {\r\n        this.confirmationHandler = handler\r\n    }\r\n\r\n    setReadOnlyAutoAllow(enabled: boolean) {\r\n        this.readOnlyAutoAllow = enabled\r\n    }\r\n\r\n    /**\r\n     * Enable trusted mode - automatically approve all tool calls\r\n     * This gives the agent full IDE access like Cursor's agent\r\n     */\r\n    setTrustedMode(enabled: boolean) {\r\n        this.trustedMode = enabled\r\n        logger.agent.info(`Trusted mode ${enabled ? 'enabled' : 'disabled'}`)\r\n    }\r\n\r\n    isTrustedMode(): boolean {\r\n        return this.trustedMode\r\n    }\r\n\r\n    isReadOnlyTool(toolName: string): boolean {\r\n        return ['readFile', 'listDirectory', 'gitStatus', 'searchFiles', 'fileStats'].includes(toolName)\r\n    }\r\n\r\n    isDestructiveTool(toolName: string): boolean {\r\n        return ['delete', 'writeFile', 'runCommand', 'executeCode', 'replaceInFile', 'insertAtLine'].includes(toolName)\r\n    }\r\n\r\n    async requestPermission(toolName: string, params: Record<string, unknown>): Promise<boolean> {\r\n        // Trusted mode: auto-approve everything\r\n        if (this.trustedMode) {\r\n            logger.agent.debug('Auto-approved in trusted mode', { toolName })\r\n            return true\r\n        }\r\n\r\n        // Check if always allowed\r\n        if (this.alwaysAllowedTools.has(toolName)) {\r\n            return true\r\n        }\r\n\r\n        // Auto-allow read-only tools if configured\r\n        if (this.readOnlyAutoAllow && this.isReadOnlyTool(toolName)) {\r\n            return true\r\n        }\r\n\r\n        // Request confirmation\r\n        if (!this.confirmationHandler) {\r\n            // No handler set, deny by default for safety\r\n            logger.agent.warn('No confirmation handler set, denying tool call', { toolName })\r\n            return false\r\n        }\r\n\r\n        const request: ToolCallRequest = {\r\n            id: crypto.randomUUID(),\r\n            toolName,\r\n            params,\r\n            timestamp: Date.now()\r\n        }\r\n\r\n        try {\r\n            const result = await this.confirmationHandler(request)\r\n            if (result.approved && result.alwaysAllow) {\r\n                this.alwaysAllowedTools.add(toolName)\r\n            }\r\n            return result.approved\r\n        } catch (err) {\r\n            logger.agent.error('Confirmation error', { toolName, error: err })\r\n            return false\r\n        }\r\n    }\r\n\r\n    clearSession() {\r\n        this.alwaysAllowedTools.clear()\r\n    }\r\n\r\n    getAlwaysAllowedTools(): string[] {\r\n        return Array.from(this.alwaysAllowedTools)\r\n    }\r\n}\r\n\r\nexport const toolPermissionManager = new ToolPermissionManager()\r\n\r\nexport interface Tool {\r\n    name: string\r\n    description: string\r\n    parameters: {\r\n        name: string\r\n        type: 'string' | 'number' | 'boolean' | 'array'\r\n        description: string\r\n        required: boolean\r\n    }[]\r\n    execute: (params: Record<string, unknown>, context: ToolContext) => Promise<ToolResult>\r\n}\r\n\r\n// Helper to check environment\r\nconst ensureElectron = () => {\r\n    if (!globalThis.window.electronAPI) {\r\n        throw new Error('This tool is only available in the desktop application')\r\n    }\r\n}\r\n\r\n// Read file tool\r\nconst readFileTool: Tool = {\r\n    name: 'readFile',\r\n    description: 'Read the contents of a file at the given path',\r\n    parameters: [\r\n        {\r\n            name: 'path',\r\n            type: 'string',\r\n            description: 'Path to the file to read (relative if workspace is set, or absolute)',\r\n            required: true\r\n        }\r\n    ],\r\n    execute: async (params, context) => {\r\n        try {\r\n            ensureElectron()\r\n            const path = params.path as string\r\n            if (!path) return { success: false, error: 'Path is required' }\r\n\r\n            // SECURITY FIX: Validate path to prevent traversal attacks\r\n            const validation = validatePath(path, context.workspacePath)\r\n            if (!validation.valid) {\r\n                logger.agent.warn('Path validation failed in readFile', { path, error: validation.error })\r\n                return { success: false, error: validation.error || 'Invalid file path' }\r\n            }\r\n\r\n            const validatedPath = validation.normalizedPath!\r\n\r\n            // BUG-046: Check file size before reading to prevent memory exhaustion\r\n            const stats = await globalThis.window.electronAPI?.fs.stat(validatedPath)\r\n            if (stats?.success) {\r\n                // 50MB limit\r\n                if (stats.size > 50 * 1024 * 1024) {\r\n                    return { success: false, error: `File is too large to read (Size: ${(stats.size / 1024 / 1024).toFixed(2)}MB, Limit: 50MB)` }\r\n                }\r\n            }\r\n\r\n            const result = await globalThis.window.electronAPI?.fs.readFile(validatedPath)\r\n            if (result?.success) {\r\n                return { success: true, data: result.content }\r\n            }\r\n            return { success: false, error: result?.error || 'Failed to read file' }\r\n        } catch (err) {\r\n            return { success: false, error: String(err) }\r\n        }\r\n    }\r\n}\r\n\r\n// Write file tool\r\nconst writeFileTool: Tool = {\r\n    name: 'writeFile',\r\n    description: 'Write content to a file, creating it if it does not exist',\r\n    parameters: [\r\n        {\r\n            name: 'path',\r\n            type: 'string',\r\n            description: 'Path to the file to write',\r\n            required: true\r\n        },\r\n        {\r\n            name: 'content',\r\n            type: 'string',\r\n            description: 'Content to write to the file',\r\n            required: true\r\n        }\r\n    ],\r\n    execute: async (params, context) => {\r\n        try {\r\n            ensureElectron()\r\n            const path = params.path as string\r\n            const content = params.content as string\r\n            if (!path) return { success: false, error: 'Path is required' }\r\n\r\n            // SECURITY FIX: Validate path to prevent traversal attacks\r\n            const validation = validatePath(path, context.workspacePath)\r\n            if (!validation.valid) {\r\n                logger.agent.warn('Path validation failed in writeFile', { path, error: validation.error })\r\n                return { success: false, error: validation.error || 'Invalid file path' }\r\n            }\r\n\r\n            const validatedPath = validation.normalizedPath!\r\n\r\n            const result = await globalThis.window.electronAPI?.fs.writeFile({ path: validatedPath, content: content || '' })\r\n            if (result?.success) {\r\n                return { success: true, data: { path: validatedPath, bytesWritten: content?.length || 0 } }\r\n            }\r\n            return { success: false, error: result?.error || 'Failed to write file' }\r\n        } catch (err) {\r\n            return { success: false, error: String(err) }\r\n        }\r\n    }\r\n}\r\n\r\n// List directory tool\r\nconst listDirectoryTool: Tool = {\r\n    name: 'listDirectory',\r\n    description: 'List files and folders in a directory',\r\n    parameters: [\r\n        {\r\n            name: 'path',\r\n            type: 'string',\r\n            description: 'Path to the directory',\r\n            required: true\r\n        },\r\n        // BUG-047: Add pagination support\r\n        {\r\n            name: 'limit',\r\n            type: 'number',\r\n            description: 'Maximum number of items to return (default: 100)',\r\n            required: false\r\n        },\r\n        {\r\n            name: 'offset',\r\n            type: 'number',\r\n            description: 'Number of items to skip (default: 0)',\r\n            required: false\r\n        }\r\n    ],\r\n    execute: async (params, context) => {\r\n        try {\r\n            ensureElectron()\r\n            let path = params.path as string\r\n            if (!path) path = context.workspacePath || ''\r\n            if (!path) return { success: false, error: 'Path is required' }\r\n\r\n            // SECURITY FIX: Validate path to prevent traversal attacks\r\n            const validation = validatePath(path, context.workspacePath)\r\n            if (!validation.valid) {\r\n                logger.agent.warn('Path validation failed in listDirectory', { path, error: validation.error })\r\n                return { success: false, error: validation.error || 'Invalid directory path' }\r\n            }\r\n\r\n            const validatedPath = validation.normalizedPath!\r\n\r\n            const limit = typeof params.limit === 'number' ? params.limit : 100\r\n            const offset = typeof params.offset === 'number' ? params.offset : 0\r\n\r\n            const result = await globalThis.window.electronAPI?.fs.readDir(validatedPath)\r\n            if (result?.success && result.items) {\r\n                const total = result.items.length\r\n                const paginatedItems = result.items.slice(offset, offset + limit)\r\n\r\n                // Capacity warning for very large directories\r\n                if (total > 10000) {\r\n                    logger.agent.warn('Very large directory detected', {\r\n                        path: validatedPath,\r\n                        total,\r\n                        message: 'Consider refining your search or using more specific paths'\r\n                    })\r\n                }\r\n\r\n                return {\r\n                    success: true,\r\n                    data: {\r\n                        path: validatedPath,\r\n                        items: paginatedItems,\r\n                        total,\r\n                        offset,\r\n                        limit,\r\n                        hasMore: offset + limit < total\r\n                    }\r\n                }\r\n            }\r\n            return { success: false, error: result?.error || 'Failed to read directory' }\r\n        } catch (err) {\r\n            return { success: false, error: String(err) }\r\n        }\r\n    }\r\n}\r\n\r\n// Create file tool\r\nconst createFileTool: Tool = {\r\n    name: 'createFile',\r\n    description: 'Create a new empty file',\r\n    parameters: [\r\n        {\r\n            name: 'path',\r\n            type: 'string',\r\n            description: 'Path for the new file',\r\n            required: true\r\n        }\r\n    ],\r\n    execute: async (params, context) => {\r\n        try {\r\n            ensureElectron()\r\n            const path = params.path as string\r\n            if (!path) return { success: false, error: 'Path is required' }\r\n\r\n            // SECURITY FIX: Validate path to prevent traversal attacks\r\n            const validation = validatePath(path, context.workspacePath)\r\n            if (!validation.valid) {\r\n                logger.agent.warn('Path validation failed in createFile', { path, error: validation.error })\r\n                return { success: false, error: validation.error || 'Invalid file path' }\r\n            }\r\n\r\n            const validatedPath = validation.normalizedPath!\r\n\r\n            const result = await globalThis.window.electronAPI?.fs.createFile(validatedPath)\r\n            if (result?.success) {\r\n                return { success: true, data: { path: validatedPath } }\r\n            }\r\n            return { success: false, error: result?.error || 'Failed to create file' }\r\n        } catch (err) {\r\n            return { success: false, error: String(err) }\r\n        }\r\n    }\r\n}\r\n\r\n// Create directory tool\r\nconst createDirectoryTool: Tool = {\r\n    name: 'createDirectory',\r\n    description: 'Create a new directory',\r\n    parameters: [\r\n        {\r\n            name: 'path',\r\n            type: 'string',\r\n            description: 'Path for the new directory',\r\n            required: true\r\n        }\r\n    ],\r\n    execute: async (params, context) => {\r\n        try {\r\n            ensureElectron()\r\n            const path = params.path as string\r\n            if (!path) return { success: false, error: 'Path is required' }\r\n\r\n            // SECURITY FIX: Validate path to prevent traversal attacks\r\n            const validation = validatePath(path, context.workspacePath)\r\n            if (!validation.valid) {\r\n                logger.agent.warn('Path validation failed in createDirectory', { path, error: validation.error })\r\n                return { success: false, error: validation.error || 'Invalid directory path' }\r\n            }\r\n\r\n            const validatedPath = validation.normalizedPath!\r\n\r\n            const result = await globalThis.window.electronAPI?.fs.createDir(validatedPath)\r\n            if (result?.success) {\r\n                return { success: true, data: { path: validatedPath } }\r\n            }\r\n            return { success: false, error: result?.error || 'Failed to create directory' }\r\n        } catch (err) {\r\n            return { success: false, error: String(err) }\r\n        }\r\n    }\r\n}\r\n\r\n// Delete file/directory tool\r\nconst deleteTool: Tool = {\r\n    name: 'delete',\r\n    description: 'Delete a file or empty directory',\r\n    parameters: [\r\n        {\r\n            name: 'path',\r\n            type: 'string',\r\n            description: 'Path to delete',\r\n            required: true\r\n        }\r\n    ],\r\n    execute: async (params, context) => {\r\n        try {\r\n            ensureElectron()\r\n            const path = params.path as string\r\n            if (!path) return { success: false, error: 'Path is required' }\r\n\r\n            // SECURITY FIX: Validate path to prevent traversal attacks\r\n            const validation = validatePath(path, context.workspacePath)\r\n            if (!validation.valid) {\r\n                logger.agent.warn('Path validation failed in delete', { path, error: validation.error })\r\n                return { success: false, error: validation.error || 'Invalid path' }\r\n            }\r\n\r\n            const validatedPath = validation.normalizedPath!\r\n\r\n            const result = await globalThis.window.electronAPI?.fs.delete(validatedPath)\r\n            if (result?.success) {\r\n                return { success: true, data: { deleted: validatedPath } }\r\n            }\r\n            return { success: false, error: result?.error || 'Failed to delete' }\r\n        } catch (err) {\r\n            return { success: false, error: String(err) }\r\n        }\r\n    }\r\n}\r\n\r\n// Execute code tool\r\nconst executeCodeTool: Tool = {\r\n    name: 'executeCode',\r\n    description: 'Execute code in any supported programming language',\r\n    parameters: [\r\n        {\r\n            name: 'code',\r\n            type: 'string',\r\n            description: 'The code to execute',\r\n            required: true\r\n        },\r\n        {\r\n            name: 'language',\r\n            type: 'string',\r\n            description: 'Programming language: javascript, typescript, python, node, deno, bun, rust, go, java, dotnet, csharp, fsharp, ruby, php, gcc, cpp, c, kotlin, swift, scala, perl, lua, haskell, elixir, r, julia, dart, zig, clojure, groovy, ocaml, erlang, v, nim, html',\r\n            required: true\r\n        },\r\n        {\r\n            name: 'cwd',\r\n            type: 'string',\r\n            description: 'Working directory for execution',\r\n            required: false\r\n        }\r\n    ],\r\n    execute: async (params, context) => {\r\n        try {\r\n            ensureElectron()\r\n            const code = params.code as string\r\n            const language = params.language as string\r\n            let cwd = params.cwd as string | undefined\r\n\r\n            if (!cwd && context.workspacePath) cwd = context.workspacePath\r\n            if (!code) return { success: false, error: 'Code is required' }\r\n\r\n            const supportedLanguages = [\r\n                'javascript', 'typescript', 'python', 'node', 'deno', 'bun',\r\n                'rust', 'go', 'java', 'dotnet', 'csharp', 'fsharp', 'ruby', 'php',\r\n                'gcc', 'cpp', 'c', 'kotlin', 'swift', 'scala', 'perl', 'lua',\r\n                'haskell', 'elixir', 'r', 'julia', 'dart', 'zig', 'clojure',\r\n                'groovy', 'ocaml', 'erlang', 'v', 'nim', 'html'\r\n            ]\r\n\r\n            if (!supportedLanguages.includes(language.toLowerCase())) {\r\n                return {\r\n                    success: false,\r\n                    error: `Unsupported language: ${language}. Supported languages: ${supportedLanguages.join(', ')}`\r\n                }\r\n            }\r\n\r\n            const execId = `agent-exec-${Date.now()}`\r\n            const result = await globalThis.window.electronAPI?.code.execute({ id: execId, code, language, cwd })\r\n\r\n            if (result?.success) {\r\n                return {\r\n                    success: true,\r\n                    data: {\r\n                        stdout: result.stdout,\r\n                        stderr: result.stderr,\r\n                        exitCode: result.exitCode\r\n                    }\r\n                }\r\n            }\r\n            return { success: false, error: result?.error || 'Execution failed' }\r\n        } catch (err) {\r\n            return { success: false, error: String(err) }\r\n        }\r\n    }\r\n}\r\n\r\n// Run generic command tool\r\nconst runCommandTool: Tool = {\r\n    name: 'runCommand',\r\n    description: 'Run a shell command (ALLOWED: npm, git, node, python, ls, dir, echo, cat, type)',\r\n    parameters: [\r\n        {\r\n            name: 'command',\r\n            type: 'string',\r\n            description: 'The full command to run (e.g., \"npm install\")',\r\n            required: true\r\n        },\r\n        {\r\n            name: 'cwd',\r\n            type: 'string',\r\n            description: 'Working directory',\r\n            required: false\r\n        }\r\n    ],\r\n    execute: async (params, context) => {\r\n        try {\r\n            ensureElectron()\r\n            const command = params.command as string\r\n            let cwd = params.cwd as string | undefined\r\n            if (!cwd && context.workspacePath) cwd = context.workspacePath\r\n            if (!cwd) return { success: false, error: 'Working directory is required' }\r\n            if (!command) return { success: false, error: 'Command is required' }\r\n\r\n            const result = await globalThis.window.electronAPI?.code.runCommand(cwd, command)\r\n            if (result?.success) {\r\n                return { success: true, data: result.output }\r\n            }\r\n            return { success: false, error: result?.error || 'Command failed' }\r\n        } catch (err) {\r\n            return { success: false, error: String(err) }\r\n        }\r\n    }\r\n}\r\n\r\n// Git status tool\r\nconst gitStatusTool: Tool = {\r\n    name: 'gitStatus',\r\n    description: 'Get the Git status of a repository',\r\n    parameters: [\r\n        {\r\n            name: 'repoPath',\r\n            type: 'string',\r\n            description: 'Path to the Git repository',\r\n            required: false\r\n        }\r\n    ],\r\n    execute: async (params, context) => {\r\n        try {\r\n            ensureElectron()\r\n            let repoPath = params.repoPath as string\r\n            if (!repoPath) repoPath = context.workspacePath\r\n            if (!repoPath) return { success: false, error: 'Repository path is required' }\r\n\r\n            const result = await globalThis.window.electronAPI?.git.status(repoPath)\r\n            if (result?.success) {\r\n                return { success: true, data: result.status }\r\n            }\r\n            return { success: false, error: result?.error || 'Failed to get status' }\r\n        } catch (err) {\r\n            return { success: false, error: String(err) }\r\n        }\r\n    }\r\n}\r\n\r\n// Search files tool (grep-like)\r\nconst searchFilesTool: Tool = {\r\n    name: 'searchFiles',\r\n    description: 'Search for a pattern in files within a directory (like grep). Returns matching lines with file paths and line numbers.',\r\n    parameters: [\r\n        {\r\n            name: 'pattern',\r\n            type: 'string',\r\n            description: 'Text pattern or regex to search for',\r\n            required: true\r\n        },\r\n        {\r\n            name: 'path',\r\n            type: 'string',\r\n            description: 'Directory to search in (defaults to workspace)',\r\n            required: false\r\n        },\r\n        {\r\n            name: 'filePattern',\r\n            type: 'string',\r\n            description: 'Glob pattern to filter files (e.g., \"*.ts\", \"*.py\")',\r\n            required: false\r\n        }\r\n    ],\r\n    execute: async (params, context) => {\r\n        try {\r\n            ensureElectron()\r\n            const pattern = params.pattern as string\r\n            let searchPath = params.path as string || context.workspacePath\r\n            const filePattern = params.filePattern as string\r\n\r\n            if (!pattern) return { success: false, error: 'Search pattern is required' }\r\n            if (!searchPath) return { success: false, error: 'Search path is required' }\r\n\r\n            // Use runCommand to execute grep-like search\r\n            const command = filePattern\r\n                ? `findstr /S /N /C:\"${pattern}\" ${filePattern}`\r\n                : `findstr /S /N /C:\"${pattern}\" *.*`\r\n\r\n            const result = await globalThis.window.electronAPI?.code.runCommand(searchPath, command)\r\n            if (result?.success) {\r\n                // Limit results to prevent overwhelming output\r\n                const lines = (result.output || '').split('\\n').slice(0, 50)\r\n                return {\r\n                    success: true,\r\n                    data: {\r\n                        matches: lines.filter((l: string) => l.trim()),\r\n                        truncated: (result.output || '').split('\\n').length > 50\r\n                    }\r\n                }\r\n            }\r\n            // No matches found is not an error\r\n            if (result?.error?.includes('errorlevel 1') || result?.output === '') {\r\n                return { success: true, data: { matches: [], message: 'No matches found' } }\r\n            }\r\n            return { success: false, error: result?.error || 'Search failed' }\r\n        } catch (err) {\r\n            return { success: false, error: String(err) }\r\n        }\r\n    }\r\n}\r\n\r\n// Replace in file tool (find and replace)\r\nconst replaceInFileTool: Tool = {\r\n    name: 'replaceInFile',\r\n    description: 'Find and replace text in a file. Use this for precise edits instead of rewriting the whole file.',\r\n    parameters: [\r\n        {\r\n            name: 'path',\r\n            type: 'string',\r\n            description: 'Path to the file to edit',\r\n            required: true\r\n        },\r\n        {\r\n            name: 'find',\r\n            type: 'string',\r\n            description: 'The exact text to find (will replace first occurrence)',\r\n            required: true\r\n        },\r\n        {\r\n            name: 'replace',\r\n            type: 'string',\r\n            description: 'The text to replace it with',\r\n            required: true\r\n        },\r\n        {\r\n            name: 'replaceAll',\r\n            type: 'boolean',\r\n            description: 'If true, replace all occurrences (default: false)',\r\n            required: false\r\n        }\r\n    ],\r\n    execute: async (params, _context) => {\r\n        try {\r\n            ensureElectron()\r\n            const path = params.path as string\r\n            const find = params.find as string\r\n            const replace = params.replace as string\r\n            const replaceAll = params.replaceAll as boolean || false\r\n\r\n            if (!path) return { success: false, error: 'Path is required' }\r\n            if (!find) return { success: false, error: 'Find text is required' }\r\n\r\n            // Read the file first\r\n            const readResult = await globalThis.window.electronAPI?.fs.readFile(path)\r\n            if (!readResult?.success) {\r\n                return { success: false, error: readResult?.error || 'Failed to read file' }\r\n            }\r\n\r\n            const content = readResult.content as string\r\n            if (!content.includes(find)) {\r\n                return { success: false, error: `Text \"${find.substring(0, 50)}...\" not found in file` }\r\n            }\r\n\r\n            // Perform replacement\r\n            const newContent = replaceAll\r\n                ? content.split(find).join(replace)\r\n                : content.replace(find, replace)\r\n\r\n            const replacements = replaceAll\r\n                ? content.split(find).length - 1\r\n                : 1\r\n\r\n            // Write back\r\n            const writeResult = await globalThis.window.electronAPI?.fs.writeFile({ path, content: newContent })\r\n            if (writeResult?.success) {\r\n                return {\r\n                    success: true,\r\n                    data: {\r\n                        path,\r\n                        replacements,\r\n                        message: `Replaced ${replacements} occurrence(s)`\r\n                    }\r\n                }\r\n            }\r\n            return { success: false, error: writeResult?.error || 'Failed to write file' }\r\n        } catch (err) {\r\n            return { success: false, error: String(err) }\r\n        }\r\n    }\r\n}\r\n\r\n// Insert at line tool\r\nconst insertAtLineTool: Tool = {\r\n    name: 'insertAtLine',\r\n    description: 'Insert content at a specific line number in a file',\r\n    parameters: [\r\n        {\r\n            name: 'path',\r\n            type: 'string',\r\n            description: 'Path to the file',\r\n            required: true\r\n        },\r\n        {\r\n            name: 'line',\r\n            type: 'number',\r\n            description: 'Line number to insert at (1-indexed). Content is inserted BEFORE this line.',\r\n            required: true\r\n        },\r\n        {\r\n            name: 'content',\r\n            type: 'string',\r\n            description: 'Content to insert',\r\n            required: true\r\n        }\r\n    ],\r\n    execute: async (params, _context) => {\r\n        try {\r\n            ensureElectron()\r\n            const path = params.path as string\r\n            const line = params.line as number\r\n            const insertContent = params.content as string\r\n\r\n            if (!path) return { success: false, error: 'Path is required' }\r\n            if (!line || line < 1) return { success: false, error: 'Valid line number is required (1-indexed)' }\r\n            if (insertContent === undefined) return { success: false, error: 'Content is required' }\r\n\r\n            // Read file\r\n            const readResult = await globalThis.window.electronAPI?.fs.readFile(path)\r\n            if (!readResult?.success) {\r\n                return { success: false, error: readResult?.error || 'Failed to read file' }\r\n            }\r\n\r\n            const lines = (readResult.content as string).split('\\n')\r\n            const insertIndex = Math.min(line - 1, lines.length)\r\n\r\n            // Insert the new content\r\n            lines.splice(insertIndex, 0, insertContent)\r\n\r\n            // Write back\r\n            const writeResult = await globalThis.window.electronAPI?.fs.writeFile({ path, content: lines.join('\\n') })\r\n            if (writeResult?.success) {\r\n                return {\r\n                    success: true,\r\n                    data: {\r\n                        path,\r\n                        insertedAtLine: insertIndex + 1,\r\n                        newTotalLines: lines.length\r\n                    }\r\n                }\r\n            }\r\n            return { success: false, error: writeResult?.error || 'Failed to write file' }\r\n        } catch (err) {\r\n            return { success: false, error: String(err) }\r\n        }\r\n    }\r\n}\r\n\r\n// File stats tool\r\nconst fileStatsTool: Tool = {\r\n    name: 'fileStats',\r\n    description: 'Get metadata about a file or directory (size, modified date, type)',\r\n    parameters: [\r\n        {\r\n            name: 'path',\r\n            type: 'string',\r\n            description: 'Path to the file or directory',\r\n            required: true\r\n        }\r\n    ],\r\n    execute: async (params, _context) => {\r\n        try {\r\n            ensureElectron()\r\n            const path = params.path as string\r\n            if (!path) return { success: false, error: 'Path is required' }\r\n\r\n            const result = await globalThis.window.electronAPI?.fs.stat(path)\r\n            if (result?.success) {\r\n                return {\r\n                    success: true,\r\n                    data: {\r\n                        path,\r\n                        size: result.size,\r\n                        sizeHuman: result.size > 1024 * 1024\r\n                            ? `${(result.size / 1024 / 1024).toFixed(2)} MB`\r\n                            : result.size > 1024\r\n                                ? `${(result.size / 1024).toFixed(2)} KB`\r\n                                : `${result.size} bytes`,\r\n                        isDirectory: result.isDirectory,\r\n                        isFile: result.isFile,\r\n                        modified: result.mtime,\r\n                        created: result.birthtime\r\n                    }\r\n                }\r\n            }\r\n            return { success: false, error: result?.error || 'Failed to get file stats' }\r\n        } catch (err) {\r\n            return { success: false, error: String(err) }\r\n        }\r\n    }\r\n}\r\n\r\n// All available tools\r\nexport const ideTools: Tool[] = [\r\n    readFileTool,\r\n    writeFileTool,\r\n    listDirectoryTool,\r\n    createFileTool,\r\n    createDirectoryTool,\r\n    deleteTool,\r\n    executeCodeTool,\r\n    runCommandTool,\r\n    gitStatusTool,\r\n    searchFilesTool,\r\n    replaceInFileTool,\r\n    insertAtLineTool,\r\n    fileStatsTool\r\n]\r\n\r\n// Get tool by name\r\nexport function getTool(name: string): Tool | undefined {\r\n    return ideTools.find(t => t.name === name)\r\n}\r\n\r\n/**\r\n * Normalize tool parameters to handle common LLM naming mistakes.\r\n * LLMs often use synonyms for parameter names - this maps them to the correct ones.\r\n */\r\nfunction normalizeParams(toolName: string, params: Record<string, unknown>): Record<string, unknown> {\r\n    const normalized = { ...params }\r\n\r\n    // Common parameter name mappings (LLM mistake → correct name)\r\n    const paramMappings: Record<string, Record<string, string>> = {\r\n        replaceInFile: {\r\n            'search': 'find',\r\n            'pattern': 'find',\r\n            'searchText': 'find',\r\n            'findText': 'find',\r\n            'oldText': 'find',\r\n            'old': 'find',\r\n            'newText': 'replace',\r\n            'new': 'replace',\r\n            'replacement': 'replace',\r\n            'text': 'replace',\r\n            'all': 'replaceAll',\r\n            'global': 'replaceAll',\r\n            'replaceAllOccurrences': 'replaceAll',\r\n        },\r\n        readFile: {\r\n            'filePath': 'path',\r\n            'file': 'path',\r\n            'filename': 'path',\r\n        },\r\n        writeFile: {\r\n            'filePath': 'path',\r\n            'file': 'path',\r\n            'filename': 'path',\r\n            'text': 'content',\r\n            'data': 'content',\r\n        },\r\n        listDirectory: {\r\n            'directory': 'path',\r\n            'dir': 'path',\r\n            'folder': 'path',\r\n        },\r\n        createFile: {\r\n            'filePath': 'path',\r\n            'file': 'path',\r\n            'filename': 'path',\r\n            'name': 'path',\r\n        },\r\n        createDirectory: {\r\n            'directory': 'path',\r\n            'dir': 'path',\r\n            'folder': 'path',\r\n            'name': 'path',\r\n        },\r\n        delete: {\r\n            'filePath': 'path',\r\n            'file': 'path',\r\n            'target': 'path',\r\n        },\r\n        executeCode: {\r\n            'lang': 'language',\r\n            'runtime': 'language',\r\n            'script': 'code',\r\n            'source': 'code',\r\n            'workingDirectory': 'cwd',\r\n            'workDir': 'cwd',\r\n        },\r\n        runCommand: {\r\n            'cmd': 'command',\r\n            'shell': 'command',\r\n            'workingDirectory': 'cwd',\r\n            'workDir': 'cwd',\r\n        },\r\n        gitStatus: {\r\n            'path': 'repoPath',\r\n            'repository': 'repoPath',\r\n            'repo': 'repoPath',\r\n        },\r\n        searchFiles: {\r\n            'query': 'pattern',\r\n            'search': 'pattern',\r\n            'text': 'pattern',\r\n            'regex': 'pattern',\r\n            'glob': 'filePattern',\r\n            'filter': 'filePattern',\r\n        },\r\n        insertAtLine: {\r\n            'lineNumber': 'line',\r\n            'at': 'line',\r\n            'text': 'content',\r\n            'insert': 'content',\r\n            'filePath': 'path',\r\n        },\r\n        fileStats: {\r\n            'filePath': 'path',\r\n            'file': 'path',\r\n        },\r\n    }\r\n\r\n    const mappings = paramMappings[toolName]\r\n    if (mappings) {\r\n        for (const [wrongName, correctName] of Object.entries(mappings)) {\r\n            if (wrongName in normalized && !(correctName in normalized)) {\r\n                normalized[correctName] = normalized[wrongName]\r\n                delete normalized[wrongName]\r\n                logger.agent.debug(`Normalized param: ${wrongName} → ${correctName}`, { toolName })\r\n            }\r\n        }\r\n    }\r\n\r\n    return normalized\r\n}\r\n\r\n// Execute a tool by name (with permission check and parameter normalization)\r\nexport async function executeTool(name: string, params: Record<string, unknown>, context: ToolContext): Promise<ToolResult> {\r\n    const tool = getTool(name)\r\n    if (!tool) {\r\n        // Try to find similar tool name (common typos)\r\n        const similarTool = ideTools.find(t =>\r\n            t.name.toLowerCase() === name.toLowerCase() ||\r\n            t.name.toLowerCase().includes(name.toLowerCase()) ||\r\n            name.toLowerCase().includes(t.name.toLowerCase())\r\n        )\r\n        if (similarTool) {\r\n            return { success: false, error: `Tool not found: \"${name}\". Did you mean \"${similarTool.name}\"?` }\r\n        }\r\n        return { success: false, error: `Tool not found: ${name}. Available tools: ${ideTools.map(t => t.name).join(', ')}` }\r\n    }\r\n\r\n    // Normalize parameters to handle common LLM mistakes\r\n    const normalizedParams = normalizeParams(name, params)\r\n\r\n    // Validate required parameters\r\n    const missingParams = tool.parameters\r\n        .filter(p => p.required && !(p.name in normalizedParams))\r\n        .map(p => p.name)\r\n\r\n    if (missingParams.length > 0) {\r\n        return {\r\n            success: false,\r\n            error: `Missing required parameters for \"${name}\": ${missingParams.join(', ')}. Expected: ${tool.parameters.filter(p => p.required).map(p => p.name).join(', ')}`\r\n        }\r\n    }\r\n\r\n    // Check permission before executing\r\n    const permitted = await toolPermissionManager.requestPermission(name, normalizedParams)\r\n    if (!permitted) {\r\n        return { success: false, error: `Permission denied: User rejected tool \"${name}\"` }\r\n    }\r\n\r\n    return tool.execute(normalizedParams, context)\r\n}\r\n\r\n// Format tools for AI prompt (OpenAI function calling format)\r\nexport function getToolsForPrompt(): object[] {\r\n    return ideTools.map(tool => ({\r\n        type: 'function',\r\n        function: {\r\n            name: tool.name,\r\n            description: tool.description,\r\n            parameters: {\r\n                type: 'object',\r\n                properties: Object.fromEntries(\r\n                    tool.parameters.map(p => [\r\n                        p.name,\r\n                        { type: p.type, description: p.description }\r\n                    ])\r\n                ),\r\n                required: tool.parameters.filter(p => p.required).map(p => p.name)\r\n            }\r\n        }\r\n    }))\r\n}\r\n\r\n// Format tools description for system prompt\r\nexport function getToolsDescription(): string {\r\n    return ideTools.map(tool => {\r\n        const params = tool.parameters.map(p =>\r\n            `  - ${p.name} (${p.type}${p.required ? ', required' : ''}): ${p.description}`\r\n        ).join('\\n')\r\n        return `${tool.name}: ${tool.description}\\nParameters:\\n${params}`\r\n    }).join('\\n\\n')\r\n}\r\n\r\n/**\r\n * Generate JSON Schema for grammar-based sampling\r\n * This enforces 100% valid tool call JSON at the token level\r\n * Used with LlamaJsonSchemaGrammar for Cursor-like reliability\r\n */\r\nexport function getToolCallJsonSchema(): object {\r\n    // Build properties for each tool's parameters\r\n    const toolDefinitions: Record<string, any> = {}\r\n\r\n    for (const tool of ideTools) {\r\n        const properties: Record<string, any> = {}\r\n        const required: string[] = []\r\n\r\n        for (const param of tool.parameters) {\r\n            // Map our parameter types to JSON Schema types\r\n            let jsonType: string\r\n            switch (param.type) {\r\n                case 'string':\r\n                    jsonType = 'string'\r\n                    break\r\n                case 'number':\r\n                    jsonType = 'number'\r\n                    break\r\n                case 'boolean':\r\n                    jsonType = 'boolean'\r\n                    break\r\n                case 'array':\r\n                    jsonType = 'array'\r\n                    break\r\n                default:\r\n                    jsonType = 'string'\r\n            }\r\n\r\n            properties[param.name] = {\r\n                type: jsonType,\r\n                description: param.description\r\n            }\r\n\r\n            if (param.required) {\r\n                required.push(param.name)\r\n            }\r\n        }\r\n\r\n        toolDefinitions[tool.name] = {\r\n            type: 'object',\r\n            description: tool.description,\r\n            properties,\r\n            required,\r\n            additionalProperties: false\r\n        }\r\n    }\r\n\r\n    // Main schema: union of all possible tool calls\r\n    return {\r\n        type: 'object',\r\n        properties: {\r\n            thought: {\r\n                type: 'string',\r\n                description: 'Brief reasoning about why this tool is needed (optional)'\r\n            },\r\n            name: {\r\n                type: 'string',\r\n                enum: ideTools.map(t => t.name),\r\n                description: 'The name of the tool to call'\r\n            },\r\n            params: {\r\n                type: 'object',\r\n                description: 'Parameters for the tool call'\r\n            }\r\n        },\r\n        required: ['name', 'params'],  // thought is optional\r\n        additionalProperties: false,\r\n        // Add tool definitions as definitions for reference\r\n        definitions: toolDefinitions\r\n    }\r\n}\r\n\r\n/**\r\n * Generate a system prompt that TEACHES the LLM how to call tools.\r\n * This is critical - small models need explicit format instructions.\r\n * \r\n * @param workspacePath - Current workspace directory\r\n * @param compact - If true, use minimal prompt for very limited context models\r\n */\r\nexport function getToolSystemPrompt(workspacePath: string, compact: boolean = false): string {\r\n    const toolNames = ideTools.map(t => t.name).join(', ')\r\n\r\n    if (compact) {\r\n        // Ultra-compact version for very small models or limited context\r\n        return `You are Kalynt, an AI coding assistant. Workspace: ${workspacePath || 'None'}\r\n\r\nWhen asked to perform file/code operations, respond ONLY with JSON:\r\n{\"name\": \"TOOL_NAME\", \"params\": {\"param1\": \"value1\"}}\r\n\r\nTools: ${toolNames}\r\n\r\nCRITICAL RULES:\r\n- executeCode REQUIRES \"language\" parameter (supported: python, javascript, typescript, node, deno, bun, rust, go, java, dotnet, csharp, fsharp, ruby, php, c, cpp, gcc, kotlin, swift, scala, perl, lua, haskell, elixir, r, julia, dart, zig, clojure, groovy, ocaml, erlang, v, nim, html)\r\n- For multi-line code, use \\\\n for newlines (NOT one-liners!)\r\n- readFile/writeFile need \"path\" parameter\r\n\r\nExamples:\r\nUser: \"list files\" → {\"name\": \"listDirectory\", \"params\": {\"path\": \".\"}}\r\nUser: \"read package.json\" → {\"name\": \"readFile\", \"params\": {\"path\": \"package.json\"}}\r\nUser: \"run python code\" → {\"name\": \"executeCode\", \"params\": {\"language\": \"python\", \"code\": \"print('hello')\\\\nprint('world')\"}}\r\nUser: \"execute rust code\" → {\"name\": \"executeCode\", \"params\": {\"language\": \"rust\", \"code\": \"fn main() {\\\\n    println!(\\\\\"Hello\\\\\");\\\\n}\"}}\r\nUser: \"remove comments from file.py\" → {\"name\": \"readFile\", \"params\": {\"path\": \"file.py\"}}\r\n\r\nFor questions/chat, respond normally. For actions, use JSON tool format.`\r\n    }\r\n\r\n    // Full version with detailed tool descriptions for larger models\r\n    return `You are Kalynt, an AI coding assistant with file system access.\r\n\r\nWORKSPACE: ${workspacePath || 'Not set'}\r\n\r\n## TOOL CALLING FORMAT\r\nWhen you need to perform an action (read files, list directories, run commands, etc.), respond with ONLY a JSON object:\r\n\r\n{\"name\": \"TOOL_NAME\", \"params\": {\"param1\": \"value1\", \"param2\": \"value2\"}}\r\n\r\n## AVAILABLE TOOLS\r\n${ideTools.map(tool => {\r\n        const params = tool.parameters.map(p => `  - ${p.name} (${p.type}${p.required ? ', REQUIRED' : ''}): ${p.description}`).join('\\n')\r\n        return `### ${tool.name}\r\n${tool.description}\r\nParameters:\r\n${params}`\r\n    }).join('\\n\\n')}\r\n\r\n## EXAMPLES\r\n\r\nUser: \"What files are in the src folder?\"\r\nAssistant: {\"name\": \"listDirectory\", \"params\": {\"path\": \"src\"}}\r\n\r\nUser: \"Show me the contents of README.md\"\r\nAssistant: {\"name\": \"readFile\", \"params\": {\"path\": \"README.md\"}}\r\n\r\nUser: \"Run npm install\"\r\nAssistant: {\"name\": \"runCommand\", \"params\": {\"command\": \"npm install\"}}\r\n\r\nUser: \"Create a new file called utils.ts\"\r\nAssistant: {\"name\": \"createFile\", \"params\": {\"path\": \"utils.ts\"}}\r\n\r\nUser: \"Run this Python code to print numbers\"\r\nAssistant: {\"name\": \"executeCode\", \"params\": {\"language\": \"python\", \"code\": \"for i in range(5):\\\\n    print(i)\"}}\r\n\r\nUser: \"Execute this Rust code\"\r\nAssistant: {\"name\": \"executeCode\", \"params\": {\"language\": \"rust\", \"code\": \"fn main() {\\\\n    println!(\\\\\"Hello from Rust!\\\\\");\\\\n}\"}}\r\n\r\n## IMPORTANT RULES\r\n1. When an action is requested, respond with ONLY the JSON tool call - no other text\r\n2. For questions or conversation, respond normally in natural language\r\n3. After a tool executes, I'll give you the result - then summarize what happened\r\n4. Use relative paths when inside the workspace\r\n5. executeCode supports ALL major languages: python, javascript, typescript, node, deno, bun, rust, go, java, dotnet, csharp, fsharp, ruby, php, c, cpp, gcc, kotlin, swift, scala, perl, lua, haskell, elixir, r, julia, dart, zig, clojure, groovy, ocaml, erlang, v, nim, html\r\n6. For multi-line code, use \\\\n for newlines (e.g., \"line1\\\\nline2\\\\nline3\")\r\n7. To modify a file, first use readFile to get contents, then writeFile with changes`\r\n}\r\n\r\n/**\r\n * Simplified JSON schema for small models (under 7B parameters).\r\n * Removes complex nesting and uses simpler structure.\r\n */\r\nexport function getSimplifiedToolSchema(): object {\r\n    return {\r\n        type: 'object',\r\n        properties: {\r\n            name: {\r\n                type: 'string',\r\n                enum: ideTools.map(t => t.name)\r\n            },\r\n            params: {\r\n                type: 'object'\r\n            }\r\n        },\r\n        required: ['name', 'params']\r\n    }\r\n}\r\n\r\n/**\r\n * Detect model size category based on model ID.\r\n * Used to choose appropriate prompt/schema complexity.\r\n */\r\nexport function getModelSizeCategory(modelId: string): 'small' | 'medium' | 'large' {\r\n    const lower = modelId.toLowerCase()\r\n\r\n    // Check for size indicators in model name\r\n    if (/1\\.5b|1b|0\\.5b|500m|tiny|mini/.test(lower)) return 'small'\r\n    if (/3b|4b|7b|8b/.test(lower)) return 'medium'\r\n    if (/13b|14b|32b|70b|72b|large|xl/.test(lower)) return 'large'\r\n\r\n    // Default to medium if unknown\r\n    return 'medium'\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\services\\ideCommands.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":28,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":28,"endColumn":33,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[943,1049],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":118,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":118,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5782,5785],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5782,5785],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n// IDE Commands Registry\r\n// Central registry for all IDE commands accessible via Command Palette\r\n\r\nimport type { IDECommand } from '../components/ide/CommandPalette'\r\n\r\ntype CommandHandler = () => void | Promise<void>\r\n\r\ninterface CommandRegistry {\r\n    commands: Map<string, IDECommand>\r\n    register: (command: IDECommand) => void\r\n    unregister: (id: string) => void\r\n    getAll: () => IDECommand[]\r\n    execute: (id: string) => boolean\r\n}\r\n\r\n// Create a singleton command registry\r\nclass IDECommandRegistry implements CommandRegistry {\r\n    commands: Map<string, IDECommand> = new Map()\r\n\r\n    register(command: IDECommand) {\r\n        // BUG-091: Add key shortcut validation\r\n        if (command.shortcut) {\r\n            for (const existing of this.commands.values()) {\r\n                if (existing.shortcut === command.shortcut && existing.id !== command.id) {\r\n                    console.warn(`[CommandRegistry] Shortcut conflict: ${command.shortcut} is already used by ${existing.id}`)\r\n                    // We could throw here, but for now just warn to avoid crashing app startup if config is messy\r\n                    // throw new Error(...) \r\n                }\r\n            }\r\n        }\r\n        this.commands.set(command.id, command)\r\n    }\r\n\r\n    unregister(id: string) {\r\n        this.commands.delete(id)\r\n    }\r\n\r\n    getAll(): IDECommand[] {\r\n        return Array.from(this.commands.values())\r\n    }\r\n\r\n    execute(id: string): boolean {\r\n        const command = this.commands.get(id)\r\n        if (command) {\r\n            command.action()\r\n            return true\r\n        }\r\n        return false\r\n    }\r\n}\r\n\r\nexport const commandRegistry = new IDECommandRegistry()\r\n\r\n// Default IDE commands factory - creates commands with provided handlers\r\nexport function createDefaultCommands(handlers: {\r\n    newFile?: CommandHandler\r\n    saveFile?: CommandHandler\r\n    closeFile?: CommandHandler\r\n    closeAllFiles?: CommandHandler\r\n    openFolder?: CommandHandler\r\n    toggleTerminal?: CommandHandler\r\n    toggleSidebar?: CommandHandler\r\n    toggleGitPanel?: CommandHandler\r\n    toggleAIPanel?: CommandHandler\r\n    runCode?: CommandHandler\r\n    debugCode?: CommandHandler\r\n    buildCode?: CommandHandler\r\n    formatDocument?: CommandHandler\r\n    goToLine?: CommandHandler\r\n    findInFiles?: CommandHandler\r\n    gitCommit?: CommandHandler\r\n    gitPush?: CommandHandler\r\n    gitPull?: CommandHandler\r\n    aiChat?: CommandHandler\r\n    aiExplain?: CommandHandler\r\n    aiRefactor?: CommandHandler\r\n}): IDECommand[] {\r\n    const configs: Array<{\r\n        key: keyof typeof handlers\r\n        id: string\r\n        title: string\r\n        category: string\r\n        icon: string\r\n        shortcut?: string\r\n    }> = [\r\n            { key: 'newFile', id: 'file.new', title: 'New File', shortcut: 'Ctrl+N', category: 'file', icon: 'FilePlus' },\r\n            { key: 'saveFile', id: 'file.save', title: 'Save File', shortcut: 'Ctrl+S', category: 'file', icon: 'Save' },\r\n            { key: 'closeFile', id: 'file.close', title: 'Close File', shortcut: 'Ctrl+W', category: 'file', icon: 'X' },\r\n            { key: 'closeAllFiles', id: 'file.closeAll', title: 'Close All Files', shortcut: 'Ctrl+Shift+W', category: 'file', icon: 'X' },\r\n            { key: 'openFolder', id: 'file.openFolder', title: 'Open Folder', shortcut: 'Ctrl+K Ctrl+O', category: 'file', icon: 'Folder' },\r\n            { key: 'toggleTerminal', id: 'view.terminal', title: 'Toggle Terminal', shortcut: 'Ctrl+`', category: 'view', icon: 'Terminal' },\r\n            { key: 'toggleSidebar', id: 'view.sidebar', title: 'Toggle Sidebar', shortcut: 'Ctrl+B', category: 'view', icon: 'FolderOpen' },\r\n            { key: 'toggleGitPanel', id: 'view.git', title: 'Toggle Git Panel', shortcut: 'Ctrl+Shift+G', category: 'view', icon: 'GitBranch' },\r\n            { key: 'toggleAIPanel', id: 'view.ai', title: 'Toggle AI Assistant', shortcut: 'Ctrl+Shift+A', category: 'view', icon: 'Bot' },\r\n            { key: 'runCode', id: 'terminal.run', title: 'Run Current File', shortcut: 'F5', category: 'terminal', icon: 'Play' },\r\n            { key: 'debugCode', id: 'terminal.debug', title: 'Debug Current File', shortcut: 'F9', category: 'terminal', icon: 'Bug' },\r\n            { key: 'buildCode', id: 'terminal.build', title: 'Build Project', shortcut: 'Ctrl+Shift+B', category: 'terminal', icon: 'Hammer' },\r\n            { key: 'formatDocument', id: 'edit.format', title: 'Format Document', shortcut: 'Shift+Alt+F', category: 'edit', icon: 'Sparkles' },\r\n            { key: 'goToLine', id: 'edit.goToLine', title: 'Go to Line', shortcut: 'Ctrl+G', category: 'edit', icon: 'MoveVertical' },\r\n            { key: 'findInFiles', id: 'edit.findInFiles', title: 'Find in Files', shortcut: 'Ctrl+Shift+F', category: 'edit', icon: 'Search' },\r\n            { key: 'gitCommit', id: 'git.commit', title: 'Git: Commit', category: 'git', icon: 'CheckCircle2' },\r\n            { key: 'gitPush', id: 'git.push', title: 'Git: Push', category: 'git', icon: 'ArrowUp' },\r\n            { key: 'gitPull', id: 'git.pull', title: 'Git: Pull', category: 'git', icon: 'ArrowDown' },\r\n            { key: 'aiChat', id: 'ai.chat', title: 'AI: Open Chat', shortcut: 'Ctrl+L', category: 'ai', icon: 'MessageSquare' },\r\n            { key: 'aiExplain', id: 'ai.explain', title: 'AI: Explain Selection', category: 'ai', icon: 'Lightbulb' },\r\n            { key: 'aiRefactor', id: 'ai.refactor', title: 'AI: Refactor Selection', shortcut: 'Ctrl+K', category: 'ai', icon: 'Wrench' }\r\n        ]\r\n\r\n    return configs\r\n        .filter(cfg => handlers[cfg.key])\r\n        .map(cfg => ({\r\n            id: cfg.id,\r\n            title: cfg.title,\r\n            shortcut: cfg.shortcut,\r\n            category: cfg.category as any,\r\n            icon: cfg.icon,\r\n            action: handlers[cfg.key]!\r\n        }))\r\n}\r\n\r\nexport type { CommandHandler }\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\services\\integrationService.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":327,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":327,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[10033,10068],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n// Integration APIs - External service connectors and webhooks\r\n// Designed for future integrations with third-party services\r\n\r\nexport interface IntegrationConfig {\r\n    id: string\r\n    type: IntegrationType\r\n    name: string\r\n    enabled: boolean\r\n    credentials: Record<string, string>\r\n    settings: Record<string, unknown>\r\n    lastSync?: number\r\n}\r\n\r\nexport type IntegrationType =\r\n    | 'github'\r\n    | 'gitlab'\r\n    | 'jira'\r\n    | 'slack'\r\n    | 'discord'\r\n    | 'notion'\r\n    | 'linear'\r\n    | 'trello'\r\n    | 'webhook'\r\n    | 'api'\r\n\r\nexport interface WebhookConfig {\r\n    id: string\r\n    url: string\r\n    secret?: string\r\n    events: WebhookEvent[]\r\n    enabled: boolean\r\n    retryCount: number\r\n    lastTrigger?: number\r\n}\r\n\r\nexport type WebhookEvent =\r\n    | 'project.created'\r\n    | 'project.updated'\r\n    | 'project.deleted'\r\n    | 'task.created'\r\n    | 'task.updated'\r\n    | 'task.completed'\r\n    | 'document.changed'\r\n    | 'member.joined'\r\n    | 'member.left'\r\n    | 'version.created'\r\n\r\nexport interface IntegrationEventPayload {\r\n    title?: string\r\n    description?: string\r\n    name?: string\r\n    project?: string\r\n    label?: string\r\n    channel?: string\r\n    text?: string\r\n    sender?: string\r\n    [key: string]: unknown\r\n}\r\n\r\nexport interface APIEndpoint {\r\n    method: 'GET' | 'POST' | 'PUT' | 'PATCH' | 'DELETE'\r\n    path: string\r\n    description: string\r\n    requiresAuth: boolean\r\n    rateLimit: number\r\n    handler: (req: APIRequest) => Promise<APIResponse>\r\n}\r\n\r\nexport interface APIRequest {\r\n    method: string\r\n    path: string\r\n    params: Record<string, string>\r\n    query: Record<string, string>\r\n    body: unknown\r\n    headers: Record<string, string>\r\n    userId?: string\r\n}\r\n\r\nexport interface APIResponse {\r\n    status: number\r\n    data?: unknown\r\n    error?: string\r\n    headers?: Record<string, string>\r\n}\r\n\r\n// Integration adapters\r\ninterface IntegrationAdapter {\r\n    type: IntegrationType\r\n    connect(config: IntegrationConfig): Promise<boolean>\r\n    disconnect(): Promise<void>\r\n    sync(): Promise<void>\r\n    sendEvent(event: WebhookEvent, payload: IntegrationEventPayload): Promise<void>\r\n}\r\n\r\n// GitHub adapter\r\nclass GitHubAdapter implements IntegrationAdapter {\r\n    type: IntegrationType = 'github'\r\n    private accessToken: string = ''\r\n    private repo: string = ''\r\n\r\n    async connect(config: IntegrationConfig): Promise<boolean> {\r\n        this.accessToken = config.credentials.accessToken || ''\r\n        this.repo = (config.settings.repo as string) || ''\r\n        return !!this.accessToken\r\n    }\r\n\r\n    async disconnect(): Promise<void> {\r\n        this.accessToken = ''\r\n    }\r\n\r\n    async sync(): Promise<void> {\r\n        // Sync issues, PRs, etc.\r\n    }\r\n\r\n    async sendEvent(event: WebhookEvent, payload: IntegrationEventPayload): Promise<void> {\r\n        // Create GitHub issue/comment\r\n        if (event === 'task.created') {\r\n            await fetch(`https://api.github.com/repos/${this.repo}/issues`, {\r\n                method: 'POST',\r\n                headers: {\r\n                    'Authorization': `token ${this.accessToken}`,\r\n                    'Content-Type': 'application/json'\r\n                },\r\n                body: JSON.stringify({\r\n                    title: payload.title,\r\n                    body: payload.description\r\n                })\r\n            })\r\n        }\r\n    }\r\n}\r\n\r\n// Slack adapter\r\nclass SlackAdapter implements IntegrationAdapter {\r\n    type: IntegrationType = 'slack'\r\n    private webhookUrl: string = ''\r\n    private channel: string = ''\r\n\r\n    async connect(config: IntegrationConfig): Promise<boolean> {\r\n        this.webhookUrl = config.credentials.webhookUrl || ''\r\n        this.channel = (config.settings.channel as string) || ''\r\n        return !!this.webhookUrl\r\n    }\r\n\r\n    async disconnect(): Promise<void> {\r\n        this.webhookUrl = ''\r\n    }\r\n\r\n    async sync(): Promise<void> {\r\n        // No sync needed for Slack\r\n    }\r\n\r\n    async sendEvent(event: WebhookEvent, payload: IntegrationEventPayload): Promise<void> {\r\n        const messages: Record<WebhookEvent, string> = {\r\n            'project.created': `New project created: ${payload.name}`,\r\n            'project.updated': `Project updated: ${payload.name}`,\r\n            'project.deleted': `Project deleted: ${payload.name}`,\r\n            'task.created': `New task: ${payload.title}`,\r\n            'task.updated': `Task updated: ${payload.title}`,\r\n            'task.completed': `Task completed: ${payload.title}`,\r\n            'document.changed': `Document changed in ${payload.project}`,\r\n            'member.joined': `${payload.name} joined the project`,\r\n            'member.left': `${payload.name} left the project`,\r\n            'version.created': `New version: ${payload.label}`\r\n        }\r\n\r\n        await fetch(this.webhookUrl, {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n                channel: this.channel,\r\n                text: messages[event] || `Event: ${event}`\r\n            })\r\n        })\r\n    }\r\n}\r\n\r\n// Generic webhook adapter\r\nclass WebhookAdapter implements IntegrationAdapter {\r\n    type: IntegrationType = 'webhook'\r\n    private url: string = ''\r\n    private secret: string = ''\r\n\r\n    async connect(config: IntegrationConfig): Promise<boolean> {\r\n        this.url = config.credentials.url || ''\r\n        this.secret = config.credentials.secret || ''\r\n        return !!this.url\r\n    }\r\n\r\n    async disconnect(): Promise<void> {\r\n        this.url = ''\r\n    }\r\n\r\n    async sync(): Promise<void> { }\r\n\r\n    async sendEvent(event: WebhookEvent, payload: IntegrationEventPayload): Promise<void> {\r\n        const body = JSON.stringify({ event, payload, timestamp: Date.now() })\r\n\r\n        const headers: Record<string, string> = {\r\n            'Content-Type': 'application/json'\r\n        }\r\n\r\n        if (this.secret) {\r\n            // Sign the payload\r\n            const encoder = new TextEncoder()\r\n            const key = await crypto.subtle.importKey(\r\n                'raw',\r\n                encoder.encode(this.secret),\r\n                { name: 'HMAC', hash: 'SHA-256' },\r\n                false,\r\n                ['sign']\r\n            )\r\n            const signature = await crypto.subtle.sign('HMAC', key, encoder.encode(body))\r\n            headers['X-Signature'] = Array.from(new Uint8Array(signature))\r\n                .map(b => b.toString(16).padStart(2, '0'))\r\n                .join('')\r\n        }\r\n\r\n        await fetch(this.url, { method: 'POST', headers, body })\r\n    }\r\n}\r\n\r\n// Main integration service\r\nclass IntegrationService {\r\n    private integrations: Map<string, IntegrationConfig> = new Map()\r\n    private adapters: Map<string, IntegrationAdapter> = new Map()\r\n    private webhooks: Map<string, WebhookConfig> = new Map()\r\n    private apiEndpoints: Map<string, APIEndpoint> = new Map()\r\n\r\n    // Initialize default adapters\r\n    constructor() {\r\n        this.registerAdapter('github', new GitHubAdapter())\r\n        this.registerAdapter('slack', new SlackAdapter())\r\n        this.registerAdapter('webhook', new WebhookAdapter())\r\n    }\r\n\r\n    // Register adapter\r\n    registerAdapter(type: string, adapter: IntegrationAdapter): void {\r\n        this.adapters.set(type, adapter)\r\n    }\r\n\r\n    // Add integration\r\n    async addIntegration(config: IntegrationConfig): Promise<boolean> {\r\n        const adapter = this.adapters.get(config.type)\r\n        if (!adapter) return false\r\n\r\n        const connected = await adapter.connect(config)\r\n        if (connected) {\r\n            this.integrations.set(config.id, config)\r\n        }\r\n        return connected\r\n    }\r\n\r\n    // Remove integration\r\n    async removeIntegration(id: string): Promise<void> {\r\n        const config = this.integrations.get(id)\r\n        if (!config) return\r\n\r\n        const adapter = this.adapters.get(config.type)\r\n        if (adapter) {\r\n            await adapter.disconnect()\r\n        }\r\n        this.integrations.delete(id)\r\n    }\r\n\r\n    // Get integrations\r\n    getIntegrations(): IntegrationConfig[] {\r\n        return Array.from(this.integrations.values())\r\n    }\r\n\r\n    // Emit event to all integrations\r\n    async emitEvent(event: WebhookEvent, payload: IntegrationEventPayload): Promise<void> {\r\n        const promises: Promise<void>[] = []\r\n\r\n        // Send to integrations\r\n        this.integrations.forEach((config, _id) => {\r\n            if (config.enabled) {\r\n                const adapter = this.adapters.get(config.type)\r\n                if (adapter) {\r\n                    promises.push(adapter.sendEvent(event, payload))\r\n                }\r\n            }\r\n        })\r\n\r\n        // Send to webhooks\r\n        this.webhooks.forEach((webhook) => {\r\n            if (webhook.enabled && webhook.events.includes(event)) {\r\n                promises.push(this.triggerWebhook(webhook, event, payload))\r\n            }\r\n        })\r\n\r\n        await Promise.allSettled(promises)\r\n    }\r\n\r\n    // Add webhook\r\n    addWebhook(config: WebhookConfig): void {\r\n        this.webhooks.set(config.id, config)\r\n    }\r\n\r\n    // Remove webhook\r\n    removeWebhook(id: string): void {\r\n        this.webhooks.delete(id)\r\n    }\r\n\r\n    // Trigger webhook\r\n    private async triggerWebhook(webhook: WebhookConfig, event: WebhookEvent, payload: IntegrationEventPayload): Promise<void> {\r\n        try {\r\n            const response = await fetch(webhook.url, {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({ event, payload, timestamp: Date.now() })\r\n            })\r\n\r\n            webhook.lastTrigger = Date.now()\r\n\r\n            if (!response.ok && webhook.retryCount > 0) {\r\n                // Retry after delay\r\n                setTimeout(() => {\r\n                    webhook.retryCount--\r\n                    this.triggerWebhook(webhook, event, payload)\r\n                }, 5000)\r\n            }\r\n        } catch (e) {\r\n            console.error('Webhook failed:', e)\r\n        }\r\n    }\r\n\r\n    // Register API endpoint\r\n    registerEndpoint(endpoint: APIEndpoint): void {\r\n        const key = `${endpoint.method}:${endpoint.path}`\r\n        this.apiEndpoints.set(key, endpoint)\r\n    }\r\n\r\n    // Handle API request\r\n    async handleRequest(req: APIRequest): Promise<APIResponse> {\r\n        const key = `${req.method}:${req.path}`\r\n        const endpoint = this.apiEndpoints.get(key)\r\n\r\n        if (!endpoint) {\r\n            return { status: 404, error: 'Not found' }\r\n        }\r\n\r\n        if (endpoint.requiresAuth && !req.userId) {\r\n            return { status: 401, error: 'Unauthorized' }\r\n        }\r\n\r\n        try {\r\n            return await endpoint.handler(req)\r\n        } catch (e) {\r\n            return { status: 500, error: e instanceof Error ? e.message : 'Internal error' }\r\n        }\r\n    }\r\n\r\n    // Get API schema\r\n    getAPISchema(): Array<{ method: string; path: string; description: string }> {\r\n        return Array.from(this.apiEndpoints.values()).map(e => ({\r\n            method: e.method,\r\n            path: e.path,\r\n            description: e.description\r\n        }))\r\n    }\r\n}\r\n\r\n// Singleton\r\nexport const integrationService = new IntegrationService()\r\n\r\n// Register default API endpoints\r\nintegrationService.registerEndpoint({\r\n    method: 'GET',\r\n    path: '/api/projects',\r\n    description: 'List all projects',\r\n    requiresAuth: true,\r\n    rateLimit: 100,\r\n    handler: async (_req) => {\r\n        // Would integrate with projectService\r\n        return { status: 200, data: [] }\r\n    }\r\n})\r\n\r\nintegrationService.registerEndpoint({\r\n    method: 'GET',\r\n    path: '/api/projects/:id',\r\n    description: 'Get project by ID',\r\n    requiresAuth: true,\r\n    rateLimit: 100,\r\n    handler: async (_req) => {\r\n        return { status: 200, data: null }\r\n    }\r\n})\r\n\r\nintegrationService.registerEndpoint({\r\n    method: 'POST',\r\n    path: '/api/projects/:id/tasks',\r\n    description: 'Create task in project',\r\n    requiresAuth: true,\r\n    rateLimit: 50,\r\n    handler: async (_req) => {\r\n        return { status: 201, data: { id: 'new-task' } }\r\n    }\r\n})\r\n\r\nintegrationService.registerEndpoint({\r\n    method: 'POST',\r\n    path: '/api/webhooks',\r\n    description: 'Register webhook',\r\n    requiresAuth: true,\r\n    rateLimit: 10,\r\n    handler: async (_req) => {\r\n        return { status: 201, data: { id: 'new-webhook' } }\r\n    }\r\n})\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\services\\languageRuntimeService.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":102,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":102,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[3589,3660],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":187,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":187,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[7224,7325],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":193,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":193,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[7479,7552],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n// Language Runtime Installation Service\r\n// Handles downloading and installing programming language runtimes\r\n\r\nexport interface RuntimeDownloadProgress {\r\n    runtimeId: string\r\n    bytesDownloaded: number\r\n    totalBytes: number\r\n    speed: number\r\n    status: 'downloading' | 'installing' | 'completed' | 'failed'\r\n}\r\n\r\nexport interface RuntimeInstallation {\r\n    id: string\r\n    name: string\r\n    version: string\r\n    path: string\r\n    isInstalled: boolean\r\n}\r\n\r\nclass LanguageRuntimeService {\r\n    private installations: Map<string, RuntimeInstallation> = new Map()\r\n    private _progressCallback: ((progress: RuntimeDownloadProgress) => void) | null = null\r\n\r\n    setProgressCallback(callback: (progress: RuntimeDownloadProgress) => void) {\r\n        this._progressCallback = callback\r\n    }\r\n\r\n    // Notify progress callback if set\r\n    private notifyProgress(progress: RuntimeDownloadProgress) {\r\n        this._progressCallback?.(progress)\r\n    }\r\n\r\n    async checkInstallation(runtimeId: string): Promise<RuntimeInstallation | null> {\r\n        try {\r\n            if (!window.electronAPI?.code?.runCommand) {\r\n                return null\r\n            }\r\n\r\n            const commands: Record<string, string> = {\r\n                node: 'node --version',\r\n                python: 'python --version',\r\n                rust: 'rustc --version',\r\n                go: 'go version',\r\n                java: 'java -version',\r\n                dotnet: 'dotnet --version',\r\n                ruby: 'ruby --version',\r\n                php: 'php --version',\r\n                gcc: 'gcc --version',\r\n                kotlin: 'kotlin -version',\r\n                swift: 'swift --version',\r\n                scala: 'scala -version',\r\n                perl: 'perl --version',\r\n                lua: 'lua -v',\r\n                haskell: 'ghc --version',\r\n                elixir: 'elixir --version',\r\n                r: 'R --version',\r\n                julia: 'julia --version',\r\n                dart: 'dart --version',\r\n                zig: 'zig version',\r\n                clojure: 'clojure --version',\r\n                deno: 'deno --version',\r\n                bun: 'bun --version',\r\n                nasm: 'nasm -v',\r\n                sass: 'sass --version',\r\n                emscripten: 'emcc --version',\r\n                wabt: 'wasm2wat --version',\r\n                groovy: 'groovy --version',\r\n                ocaml: 'ocaml -version',\r\n                erlang: 'erl -eval \"erlang:display(erlang:system_info(otp_release)), halt().\" -noshell',\r\n                fsharp: 'dotnet fsi --version',\r\n                v: 'v version',\r\n                nim: 'nim --version',\r\n                html: 'echo HTML5'\r\n            }\r\n\r\n            const command = commands[runtimeId]\r\n            if (!command) return null\r\n\r\n            const result = await window.electronAPI.code.runCommand('.', command)\r\n\r\n            if (result.success && result.output) {\r\n                const versionMatch = result.output.match(/(\\d+\\.\\d+\\.\\d+)/)\r\n                const version = versionMatch ? versionMatch[1] : 'installed'\r\n\r\n                const installation: RuntimeInstallation = {\r\n                    id: runtimeId,\r\n                    name: runtimeId,\r\n                    version,\r\n                    path: command.split(' ')[0],\r\n                    isInstalled: true\r\n                }\r\n\r\n                this.installations.set(runtimeId, installation)\r\n                return installation\r\n            }\r\n\r\n            return null\r\n        } catch (error) {\r\n            console.error(`[RuntimeService] Check failed for ${runtimeId}:`, error)\r\n            return null\r\n        }\r\n    }\r\n\r\n    async checkAllInstallations(): Promise<Map<string, RuntimeInstallation>> {\r\n        const runtimeIds = [\r\n            'node', 'python', 'rust', 'go', 'java', 'dotnet', 'ruby', 'php',\r\n            'gcc', 'kotlin', 'swift', 'scala', 'perl', 'lua', 'haskell',\r\n            'elixir', 'r', 'julia', 'dart', 'zig', 'clojure',\r\n            'deno', 'bun', 'nasm', 'sass', 'emscripten', 'wabt',\r\n            'groovy', 'ocaml', 'erlang', 'fsharp', 'v', 'nim', 'html'\r\n        ]\r\n\r\n        await Promise.all(\r\n            runtimeIds.map(id => this.checkInstallation(id))\r\n        )\r\n\r\n        return this.installations\r\n    }\r\n\r\n    async installRuntime(runtimeId: string, platform: NodeJS.Platform): Promise<{ success: boolean; error?: string }> {\r\n        try {\r\n            if (!window.electronAPI?.runtimeMgmt?.downloadAndInstall) {\r\n                // Fallback to browser if runtime API not available\r\n                return this.openBrowserInstall(runtimeId, platform)\r\n            }\r\n\r\n            // Setup progress listener\r\n            if (window.electronAPI?.runtimeMgmt?.onDownloadProgress) {\r\n                window.electronAPI.runtimeMgmt.onDownloadProgress((data: {\r\n                    runtimeId: string\r\n                    version?: string\r\n                    bytesDownloaded?: number\r\n                    totalBytes?: number\r\n                    progress?: number\r\n                    speed: number\r\n                }) => {\r\n                    if (data.runtimeId === runtimeId) {\r\n                        this.notifyProgress({\r\n                            runtimeId: data.runtimeId,\r\n                            bytesDownloaded: data.bytesDownloaded ?? 0,\r\n                            totalBytes: data.totalBytes ?? 100,\r\n                            speed: data.speed,\r\n                            status: 'downloading'\r\n                        })\r\n                    }\r\n                })\r\n            }\r\n\r\n            // Setup status listener\r\n            if (window.electronAPI?.runtimeMgmt?.onStatus) {\r\n                window.electronAPI.runtimeMgmt.onStatus((data: {\r\n                    runtimeId: string\r\n                    version?: string\r\n                    status: 'downloading' | 'installing' | 'completed' | 'failed'\r\n                    message?: string\r\n                    error?: string\r\n                }) => {\r\n                    if (data.runtimeId === runtimeId) {\r\n                        this.notifyProgress({\r\n                            runtimeId: data.runtimeId,\r\n                            bytesDownloaded: data.status === 'completed' ? 100 : 0,\r\n                            totalBytes: 100,\r\n                            speed: 0,\r\n                            status: data.status\r\n                        })\r\n                    }\r\n                })\r\n            }\r\n\r\n            // Start download and installation\r\n            const result = await window.electronAPI.runtimeMgmt.downloadAndInstall(runtimeId)\r\n\r\n            // Cleanup listeners\r\n            if (window.electronAPI?.runtimeMgmt?.removeListeners) {\r\n                window.electronAPI.runtimeMgmt.removeListeners()\r\n            }\r\n\r\n            if (result.success) {\r\n                // Refresh installation status\r\n                await this.checkInstallation(runtimeId)\r\n                return result\r\n            } else if (result.error?.includes('not available for automatic download')) {\r\n                // Fallback to browser download for languages without direct download support\r\n                console.log(`[RuntimeService] Automatic download not available for ${runtimeId}, opening browser...`)\r\n                return this.openBrowserInstall(runtimeId, platform)\r\n            }\r\n\r\n            return result\r\n        } catch (error) {\r\n            console.error(`[RuntimeService] Install failed for ${runtimeId}:`, error)\r\n            this.notifyProgress({\r\n                runtimeId,\r\n                bytesDownloaded: 0,\r\n                totalBytes: 0,\r\n                speed: 0,\r\n                status: 'failed'\r\n            })\r\n            return {\r\n                success: false,\r\n                error: error instanceof Error ? error.message : 'Installation failed'\r\n            }\r\n        }\r\n    }\r\n\r\n    private async openBrowserInstall(runtimeId: string, platform: NodeJS.Platform): Promise<{ success: boolean; error?: string }> {\r\n        const downloadInfo = this.getDownloadInfo(runtimeId, platform)\r\n\r\n        if (!downloadInfo) {\r\n            return { success: false, error: 'No download information available for this platform' }\r\n        }\r\n\r\n        this.notifyProgress({\r\n            runtimeId,\r\n            bytesDownloaded: 0,\r\n            totalBytes: 0,\r\n            speed: 0,\r\n            status: 'installing'\r\n        })\r\n\r\n        if (window.electronAPI?.shell?.openExternal) {\r\n            await window.electronAPI.shell.openExternal(downloadInfo.url)\r\n            this.notifyProgress({\r\n                runtimeId,\r\n                bytesDownloaded: 100,\r\n                totalBytes: 100,\r\n                speed: 0,\r\n                status: 'completed'\r\n            })\r\n            return { success: true }\r\n        }\r\n\r\n        return { success: false, error: 'Cannot open external links' }\r\n    }\r\n\r\n    private getDownloadInfo(runtimeId: string, platform: NodeJS.Platform): { url: string; filename: string } | null {\r\n        const downloads: Record<string, Record<string, { url: string; filename: string }>> = {\r\n            node: {\r\n                win32: { url: 'https://nodejs.org/en/download/prebuilt-installer', filename: 'node-installer.msi' },\r\n                darwin: { url: 'https://nodejs.org/en/download/prebuilt-installer', filename: 'node-installer.pkg' },\r\n                linux: { url: 'https://nodejs.org/en/download/package-manager', filename: 'node-install' }\r\n            },\r\n            python: {\r\n                win32: { url: 'https://www.python.org/downloads/windows/', filename: 'python-installer.exe' },\r\n                darwin: { url: 'https://www.python.org/downloads/macos/', filename: 'python-installer.pkg' },\r\n                linux: { url: 'https://www.python.org/downloads/', filename: 'python-install' }\r\n            },\r\n            rust: {\r\n                win32: { url: 'https://static.rust-lang.org/rustup/dist/x86_64-pc-windows-msvc/rustup-init.exe', filename: 'rustup-init.exe' },\r\n                darwin: { url: 'https://rustup.rs/', filename: 'rustup-init.sh' },\r\n                linux: { url: 'https://rustup.rs/', filename: 'rustup-init.sh' }\r\n            },\r\n            go: {\r\n                win32: { url: 'https://go.dev/dl/', filename: 'go-installer.msi' },\r\n                darwin: { url: 'https://go.dev/dl/', filename: 'go-installer.pkg' },\r\n                linux: { url: 'https://go.dev/dl/', filename: 'go-linux.tar.gz' }\r\n            },\r\n            java: {\r\n                win32: { url: 'https://adoptium.net/temurin/releases/?os=windows&arch=x64&package=jdk', filename: 'temurin-jdk.msi' },\r\n                darwin: { url: 'https://adoptium.net/temurin/releases/?os=mac&package=jdk', filename: 'temurin-jdk.pkg' },\r\n                linux: { url: 'https://adoptium.net/temurin/releases/?os=linux&package=jdk', filename: 'temurin-jdk.tar.gz' }\r\n            },\r\n            dotnet: {\r\n                win32: { url: 'https://dotnet.microsoft.com/en-us/download', filename: 'dotnet-sdk-installer.exe' },\r\n                darwin: { url: 'https://dotnet.microsoft.com/en-us/download', filename: 'dotnet-sdk-installer.pkg' },\r\n                linux: { url: 'https://dotnet.microsoft.com/en-us/download', filename: 'dotnet-sdk-install' }\r\n            },\r\n            ruby: {\r\n                win32: { url: 'https://rubyinstaller.org/downloads/', filename: 'rubyinstaller-devkit.exe' },\r\n                darwin: { url: 'https://www.ruby-lang.org/en/downloads/', filename: 'ruby-install' },\r\n                linux: { url: 'https://www.ruby-lang.org/en/downloads/', filename: 'ruby-install' }\r\n            },\r\n            php: {\r\n                win32: { url: 'https://windows.php.net/download/', filename: 'php-windows.zip' },\r\n                darwin: { url: 'https://www.php.net/downloads', filename: 'php-source.tar.gz' },\r\n                linux: { url: 'https://www.php.net/downloads', filename: 'php-source.tar.gz' }\r\n            },\r\n            gcc: {\r\n                win32: { url: 'https://www.msys2.org/', filename: 'msys2-installer.exe' },\r\n                darwin: { url: 'https://developer.apple.com/xcode/', filename: 'xcode-install' },\r\n                linux: { url: 'https://gcc.gnu.org/install/', filename: 'gcc-build-essential' }\r\n            },\r\n            kotlin: {\r\n                win32: { url: 'https://github.com/JetBrains/kotlin/releases/latest', filename: 'kotlin-compiler.zip' },\r\n                darwin: { url: 'https://github.com/JetBrains/kotlin/releases/latest', filename: 'kotlin-compiler.zip' },\r\n                linux: { url: 'https://github.com/JetBrains/kotlin/releases/latest', filename: 'kotlin-compiler.zip' }\r\n            },\r\n            swift: {\r\n                win32: { url: 'https://www.swift.org/install/windows/', filename: 'swift-installer.exe' },\r\n                darwin: { url: 'https://developer.apple.com/xcode/', filename: 'xcode-install' },\r\n                linux: { url: 'https://www.swift.org/install/linux/', filename: 'swift-linux.tar.gz' }\r\n            },\r\n            scala: {\r\n                win32: { url: 'https://www.scala-lang.org/download/', filename: 'scala-installer.msi' },\r\n                darwin: { url: 'https://www.scala-lang.org/download/', filename: 'scala-install' },\r\n                linux: { url: 'https://www.scala-lang.org/download/', filename: 'scala-install' }\r\n            },\r\n            perl: {\r\n                win32: { url: 'https://strawberryperl.com/', filename: 'strawberry-perl-installer.msi' },\r\n                darwin: { url: 'https://www.perl.org/get.html', filename: 'perl-install' },\r\n                linux: { url: 'https://www.perl.org/get.html', filename: 'perl-install' }\r\n            },\r\n            lua: {\r\n                win32: { url: 'https://github.com/rjpcomputing/luaforwindows/releases', filename: 'lua-for-windows.exe' },\r\n                darwin: { url: 'https://www.lua.org/download.html', filename: 'lua-source.tar.gz' },\r\n                linux: { url: 'https://www.lua.org/download.html', filename: 'lua-source.tar.gz' }\r\n            },\r\n            haskell: {\r\n                win32: { url: 'https://www.haskell.org/ghcup/', filename: 'ghcup-installer.exe' },\r\n                darwin: { url: 'https://www.haskell.org/ghcup/', filename: 'ghcup-install.sh' },\r\n                linux: { url: 'https://www.haskell.org/ghcup/', filename: 'ghcup-install.sh' }\r\n            },\r\n            elixir: {\r\n                win32: { url: 'https://github.com/elixir-lang/elixir-windows-setup/releases', filename: 'elixir-installer.exe' },\r\n                darwin: { url: 'https://elixir-lang.org/install.html', filename: 'elixir-install' },\r\n                linux: { url: 'https://elixir-lang.org/install.html', filename: 'elixir-install' }\r\n            },\r\n            r: {\r\n                win32: { url: 'https://cran.r-project.org/bin/windows/base/', filename: 'R-installer.exe' },\r\n                darwin: { url: 'https://cran.r-project.org/bin/macosx/', filename: 'R-installer.pkg' },\r\n                linux: { url: 'https://cran.r-project.org/', filename: 'r-install' }\r\n            },\r\n            julia: {\r\n                win32: { url: 'https://julialang.org/downloads/', filename: 'julia-installer.exe' },\r\n                darwin: { url: 'https://julialang.org/downloads/', filename: 'julia-installer.dmg' },\r\n                linux: { url: 'https://julialang.org/downloads/', filename: 'julia-linux.tar.gz' }\r\n            },\r\n            dart: {\r\n                win32: { url: 'https://dart.dev/get-dart', filename: 'dart-sdk.zip' },\r\n                darwin: { url: 'https://dart.dev/get-dart', filename: 'dart-sdk.zip' },\r\n                linux: { url: 'https://dart.dev/get-dart', filename: 'dart-sdk.tar.gz' }\r\n            },\r\n            zig: {\r\n                win32: { url: 'https://ziglang.org/download/', filename: 'zig-windows.zip' },\r\n                darwin: { url: 'https://ziglang.org/download/', filename: 'zig-macos.tar.xz' },\r\n                linux: { url: 'https://ziglang.org/download/', filename: 'zig-linux.tar.xz' }\r\n            },\r\n            clojure: {\r\n                win32: { url: 'https://clojure.org/guides/install_clojure', filename: 'clojure-installer.ps1' },\r\n                darwin: { url: 'https://clojure.org/guides/install_clojure', filename: 'clojure-install.sh' },\r\n                linux: { url: 'https://clojure.org/guides/install_clojure', filename: 'clojure-install.sh' }\r\n            },\r\n            deno: {\r\n                win32: { url: 'https://github.com/denoland/deno/releases/latest', filename: 'deno-x86_64-pc-windows-msvc.zip' },\r\n                darwin: { url: 'https://github.com/denoland/deno/releases/latest', filename: 'deno-x86_64-apple-darwin.zip' },\r\n                linux: { url: 'https://github.com/denoland/deno/releases/latest', filename: 'deno-x86_64-unknown-linux-gnu.zip' }\r\n            },\r\n            bun: {\r\n                win32: { url: 'https://bun.sh/docs/installation', filename: 'bun-windows.zip' },\r\n                darwin: { url: 'https://bun.sh/docs/installation', filename: 'bun-install.sh' },\r\n                linux: { url: 'https://bun.sh/docs/installation', filename: 'bun-install.sh' }\r\n            },\r\n            nasm: {\r\n                win32: { url: 'https://www.nasm.us/pub/nasm/releasebuilds/?C=M;O=D', filename: 'nasm-installer.exe' },\r\n                darwin: { url: 'https://www.nasm.us/pub/nasm/releasebuilds/?C=M;O=D', filename: 'nasm-macos' },\r\n                linux: { url: 'https://www.nasm.us/pub/nasm/releasebuilds/?C=M;O=D', filename: 'nasm-linux.tar.gz' }\r\n            },\r\n            sass: {\r\n                win32: { url: 'https://github.com/sass/dart-sass/releases/latest', filename: 'dart-sass-windows.zip' },\r\n                darwin: { url: 'https://github.com/sass/dart-sass/releases/latest', filename: 'dart-sass-macos.tar.gz' },\r\n                linux: { url: 'https://github.com/sass/dart-sass/releases/latest', filename: 'dart-sass-linux.tar.gz' }\r\n            },\r\n            emscripten: {\r\n                win32: { url: 'https://emscripten.org/docs/getting_started/downloads.html', filename: 'emsdk-portable.zip' },\r\n                darwin: { url: 'https://emscripten.org/docs/getting_started/downloads.html', filename: 'emsdk-install' },\r\n                linux: { url: 'https://emscripten.org/docs/getting_started/downloads.html', filename: 'emsdk-install' }\r\n            },\r\n            wabt: {\r\n                win32: { url: 'https://github.com/WebAssembly/wabt/releases/latest', filename: 'wabt-windows.tar.gz' },\r\n                darwin: { url: 'https://github.com/WebAssembly/wabt/releases/latest', filename: 'wabt-macos.tar.gz' },\r\n                linux: { url: 'https://github.com/WebAssembly/wabt/releases/latest', filename: 'wabt-linux.tar.gz' }\r\n            },\r\n            groovy: {\r\n                win32: { url: 'https://groovy.apache.org/download.html', filename: 'apache-groovy-sdk.zip' },\r\n                darwin: { url: 'https://groovy.apache.org/download.html', filename: 'apache-groovy-sdk.zip' },\r\n                linux: { url: 'https://groovy.apache.org/download.html', filename: 'apache-groovy-sdk.zip' }\r\n            },\r\n            ocaml: {\r\n                win32: { url: 'https://ocaml.org/install', filename: 'ocaml-installer.exe' },\r\n                darwin: { url: 'https://ocaml.org/install', filename: 'ocaml-install' },\r\n                linux: { url: 'https://ocaml.org/install', filename: 'ocaml-install' }\r\n            },\r\n            erlang: {\r\n                win32: { url: 'https://www.erlang.org/downloads', filename: 'otp_win64_installer.exe' },\r\n                darwin: { url: 'https://www.erlang.org/downloads', filename: 'erlang-install' },\r\n                linux: { url: 'https://www.erlang.org/downloads', filename: 'erlang-install' }\r\n            },\r\n            fsharp: {\r\n                win32: { url: 'https://dotnet.microsoft.com/en-us/download', filename: 'dotnet-sdk-installer.exe' },\r\n                darwin: { url: 'https://dotnet.microsoft.com/en-us/download', filename: 'dotnet-sdk-installer.pkg' },\r\n                linux: { url: 'https://dotnet.microsoft.com/en-us/download', filename: 'dotnet-sdk-install' }\r\n            },\r\n            v: {\r\n                win32: { url: 'https://github.com/vlang/v/releases/latest', filename: 'v_windows.zip' },\r\n                darwin: { url: 'https://github.com/vlang/v/releases/latest', filename: 'v-install.sh' },\r\n                linux: { url: 'https://github.com/vlang/v/releases/latest', filename: 'v-install.sh' }\r\n            },\r\n            nim: {\r\n                win32: { url: 'https://nim-lang.org/install_windows.html', filename: 'nim-installer.exe' },\r\n                darwin: { url: 'https://nim-lang.org/install.html', filename: 'nim-install' },\r\n                linux: { url: 'https://nim-lang.org/install.html', filename: 'nim-install' }\r\n            },\r\n            html: {\r\n                win32: { url: 'https://developer.mozilla.org/en-US/docs/Web/HTML', filename: 'html-browser' },\r\n                darwin: { url: 'https://developer.mozilla.org/en-US/docs/Web/HTML', filename: 'html-browser' },\r\n                linux: { url: 'https://developer.mozilla.org/en-US/docs/Web/HTML', filename: 'html-browser' }\r\n            }\r\n        }\r\n\r\n        return downloads[runtimeId]?.[platform] || null\r\n    }\r\n\r\n    getInstallation(runtimeId: string): RuntimeInstallation | null {\r\n        return this.installations.get(runtimeId) || null\r\n    }\r\n\r\n    getAllInstallations(): RuntimeInstallation[] {\r\n        return Array.from(this.installations.values())\r\n    }\r\n}\r\n\r\nexport const languageRuntimeService = new LanguageRuntimeService()\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\services\\memberSyncService.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":77,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":77,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[2412,2478],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":79,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":79,"endColumn":29,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[2518,2585],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":94,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":94,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[2860,2920],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":106,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":106,"endColumn":25,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[3327,3387],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":116,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":116,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[3674,3723],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":137,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":137,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[4418,4481],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":177,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":177,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[5918,5983],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":226,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":226,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[7312,7402],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":252,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":252,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[8099,8162],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":256,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":256,"endColumn":29,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[8274,8316],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":259,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":259,"endColumn":29,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[8427,8469],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":314,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":314,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[9963,10025],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":344,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":344,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[10857,10913],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":357,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":357,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[11309,11375],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":387,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":387,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[12225,12289],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":400,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":400,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[12622,12678],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":423,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":423,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[13369,13427],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":434,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":434,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[13698,13754],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":450,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":450,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[14208,14269],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":465,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":465,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[14608,14664],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":480,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":480,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[15100,15175],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":542,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":542,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[16827,16875],"text":""},"desc":"Remove the console.log()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":22,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n// Member Sync Service - P2P synchronization of member data via Yjs\r\nimport * as Y from 'yjs'\r\nimport { Awareness } from 'y-protocols/awareness'\r\nimport {\r\n    WorkspaceRole,\r\n    WorkspaceMember,\r\n    MemberPermissions,\r\n    DEFAULT_PERMISSIONS,\r\n    ModerationAction\r\n} from '../types/permissions'\r\nimport { useMemberStore } from '../stores/memberStore'\r\n\r\n// Types for awareness state\r\ninterface AwarenessState {\r\n    user?: {\r\n        id: string\r\n        name: string\r\n        role?: WorkspaceRole\r\n    }\r\n    moderation?: ModerationAction\r\n}\r\n\r\n// Serializable member data for Y.Map\r\ninterface SyncedMember {\r\n    userId: string\r\n    displayName: string\r\n    role: WorkspaceRole\r\n    permissions: MemberPermissions\r\n    joinedAt: number\r\n    isBanned: boolean\r\n    bannedAt?: number\r\n    bannedBy?: string\r\n    banReason?: string\r\n}\r\n\r\nclass MemberSyncService {\r\n    private spaceDocs: Map<string, Y.Doc> = new Map()\r\n    private spaceAwareness: Map<string, Awareness> = new Map()\r\n    private unsubscribers: Map<string, () => void> = new Map()\r\n\r\n    constructor() {\r\n        // BUG-048: Process pending actions from store\r\n        useMemberStore.subscribe((state) => {\r\n            Object.entries(state.spaceMembers).forEach(([spaceId, spaceInfo]) => {\r\n                if (spaceInfo.pendingActions.length > 0) {\r\n                    const action = spaceInfo.pendingActions[0]\r\n                    this.processAction(spaceId, action)\r\n                }\r\n            })\r\n        })\r\n    }\r\n\r\n    private processAction(spaceId: string, action: ModerationAction) {\r\n        const store = useMemberStore.getState()\r\n\r\n        // Execute action via sync service\r\n        let success = false\r\n        switch (action.type) {\r\n            case 'kick':\r\n                success = this.kickMember(spaceId, action.targetUserId)\r\n                break\r\n            case 'ban':\r\n                success = this.banMember(spaceId, action.targetUserId, action.reason)\r\n                break\r\n            case 'unban':\r\n                success = this.unbanMember(spaceId, action.targetUserId)\r\n                break\r\n        }\r\n\r\n        // Always pop the action to prevent infinite loop/stuck queue\r\n        // We do this via the store action which handles the removal safely\r\n        if (store.popPendingAction(spaceId)) {\r\n            if (success) {\r\n                console.log('[MemberSync] Processed pending action:', action.type)\r\n            } else {\r\n                console.warn('[MemberSync] Failed to process action:', action.type)\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Initialize member sync for a space\r\n     */\r\n    initializeSpace(\r\n        spaceId: string,\r\n        doc: Y.Doc,\r\n        awareness: Awareness,\r\n        userId: string,\r\n        displayName: string\r\n    ): void {\r\n        console.log('[MemberSync] Initializing for space:', spaceId)\r\n\r\n        this.spaceDocs.set(spaceId, doc)\r\n        this.spaceAwareness.set(spaceId, awareness)\r\n\r\n        // Get or create members Y.Map\r\n        const membersMap = doc.getMap<SyncedMember>('members')\r\n        const bannedMap = doc.getMap<boolean>('banned')\r\n        const ownerRef = doc.getMap<string>('metadata')\r\n\r\n        // Check if user is banned\r\n        if (bannedMap.get(userId)) {\r\n            console.warn('[MemberSync] User is banned from this space!')\r\n            this.handleBanned(spaceId)\r\n            return\r\n        }\r\n\r\n        // Set owner if not set (first user becomes owner)\r\n        if (!ownerRef.get('ownerId')) {\r\n            doc.transact(() => {\r\n                ownerRef.set('ownerId', userId)\r\n            })\r\n            console.log('[MemberSync] Set as owner:', userId)\r\n        }\r\n\r\n        const ownerId = ownerRef.get('ownerId')\r\n        const isOwner = ownerId === userId\r\n        const role: WorkspaceRole = isOwner ? 'owner' :\r\n            membersMap.get(userId)?.role || 'member'\r\n\r\n        // Add self to members\r\n        const existingMember = membersMap.get(userId)\r\n        if (!existingMember) {\r\n            doc.transact(() => {\r\n                membersMap.set(userId, {\r\n                    userId,\r\n                    displayName,\r\n                    role,\r\n                    permissions: DEFAULT_PERMISSIONS[role],\r\n                    joinedAt: Date.now(),\r\n                    isBanned: false\r\n                })\r\n            })\r\n            console.log('[MemberSync] Added self as member:', userId, role)\r\n        }\r\n\r\n        // Update awareness with user info\r\n        awareness.setLocalStateField('user', {\r\n            id: userId,\r\n            name: displayName,\r\n            role\r\n        })\r\n\r\n        // Subscribe to member changes\r\n        const memberObserver = () => {\r\n            this.syncMembersToStore(spaceId, membersMap, bannedMap, ownerId || userId)\r\n        }\r\n        membersMap.observe(memberObserver)\r\n        bannedMap.observe(memberObserver)\r\n\r\n        // Subscribe to awareness for moderation actions\r\n        const awarenessHandler = ({ added, updated }: { added: number[], updated: number[], removed: number[] }) => {\r\n            const states = awareness.getStates() as Map<number, AwarenessState>\r\n\r\n            for (const clientId of [...added, ...updated]) {\r\n                const state = states.get(clientId)\r\n                if (state?.moderation) {\r\n                    this.handleModerationAction(spaceId, state.moderation, doc, userId)\r\n                }\r\n            }\r\n        }\r\n        awareness.on('change', awarenessHandler)\r\n\r\n        // Initial sync\r\n        this.syncMembersToStore(spaceId, membersMap, bannedMap, ownerId || userId)\r\n\r\n        // Store cleanup function\r\n        this.unsubscribers.set(spaceId, () => {\r\n            membersMap.unobserve(memberObserver)\r\n            bannedMap.unobserve(memberObserver)\r\n            awareness.off('change', awarenessHandler)\r\n        })\r\n\r\n        console.log('[MemberSync] Initialization complete for:', spaceId)\r\n    }\r\n\r\n    /**\r\n     * Sync Y.Map members to Zustand store\r\n     */\r\n    private syncMembersToStore(\r\n        spaceId: string,\r\n        membersMap: Y.Map<SyncedMember>,\r\n        bannedMap: Y.Map<boolean>,\r\n        ownerId: string\r\n    ): void {\r\n        const store = useMemberStore.getState()\r\n\r\n        // Convert Y.Map to array\r\n        const members: WorkspaceMember[] = []\r\n        membersMap.forEach((member, _key) => {\r\n            members.push({\r\n                ...member,\r\n                isOnline: this.isUserOnline(spaceId, member.userId)\r\n            })\r\n        })\r\n\r\n        // Get banned users\r\n        const bannedUsers: string[] = []\r\n        bannedMap.forEach((_, userId) => {\r\n            bannedUsers.push(userId)\r\n        })\r\n\r\n        // Update store\r\n        const currentInfo = store.spaceMembers[spaceId]\r\n        if (!currentInfo) {\r\n            // Initialize space in store\r\n            store.spaceMembers[spaceId] = {\r\n                ownerId,\r\n                members,\r\n                bannedUsers,\r\n                pendingActions: []\r\n            }\r\n        } else {\r\n            // Update existing\r\n            store.spaceMembers[spaceId] = {\r\n                ...currentInfo,\r\n                ownerId,\r\n                members,\r\n                bannedUsers\r\n            }\r\n        }\r\n\r\n        console.log('[MemberSync] Synced members:', members.length, 'banned:', bannedUsers.length)\r\n    }\r\n\r\n    /**\r\n     * Check if user is online via awareness\r\n     */\r\n    private isUserOnline(spaceId: string, userId: string): boolean {\r\n        const awareness = this.spaceAwareness.get(spaceId)\r\n        if (!awareness) return false\r\n\r\n        const states = awareness.getStates() as Map<number, AwarenessState>\r\n        for (const [, state] of states) {\r\n            if (state.user?.id === userId) return true\r\n        }\r\n        return false\r\n    }\r\n\r\n    /**\r\n     * Handle moderation action from awareness\r\n     */\r\n    private handleModerationAction(\r\n        spaceId: string,\r\n        action: ModerationAction,\r\n        doc: Y.Doc,\r\n        myUserId: string\r\n    ): void {\r\n        console.log('[MemberSync] Received moderation action:', action)\r\n\r\n        if (action.targetUserId === myUserId) {\r\n            if (action.type === 'kick') {\r\n                console.warn('[MemberSync] I was kicked!')\r\n                this.handleKicked(spaceId)\r\n            } else if (action.type === 'ban') {\r\n                console.warn('[MemberSync] I was banned!')\r\n                // Add to banned list\r\n                doc.transact(() => {\r\n                    const bannedMap = doc.getMap<boolean>('banned')\r\n                    bannedMap.set(myUserId, true)\r\n                })\r\n                this.handleBanned(spaceId)\r\n            }\r\n        }\r\n\r\n        // Handle unban\r\n        if (action.type === 'unban') {\r\n            doc.transact(() => {\r\n                const bannedMap = doc.getMap<boolean>('banned')\r\n                bannedMap.delete(action.targetUserId)\r\n            })\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Handle being kicked\r\n     */\r\n    private handleKicked(spaceId: string): void {\r\n        // Show notification\r\n        alert('You have been kicked from this workspace.')\r\n\r\n        // Disconnect from space\r\n        this.cleanup(spaceId)\r\n\r\n        // Reload to reset state\r\n        window.location.reload()\r\n    }\r\n\r\n    /**\r\n     * Handle being banned\r\n     */\r\n    private handleBanned(spaceId: string): void {\r\n        // Show notification\r\n        alert('You have been banned from this workspace.')\r\n\r\n        // Disconnect from space\r\n        this.cleanup(spaceId)\r\n\r\n        // Reload to reset state\r\n        window.location.reload()\r\n    }\r\n\r\n    /**\r\n     * Kick a member (broadcast via awareness)\r\n     */\r\n    kickMember(spaceId: string, targetUserId: string): boolean {\r\n        const awareness = this.spaceAwareness.get(spaceId)\r\n        const store = useMemberStore.getState()\r\n\r\n        if (!awareness) {\r\n            console.error('[MemberSync] No awareness for space:', spaceId)\r\n            return false\r\n        }\r\n\r\n        const myUserId = store.userId\r\n\r\n        // Broadcast kick action\r\n        const kickAction: ModerationAction = {\r\n            type: 'kick',\r\n            targetUserId,\r\n            initiatorId: myUserId,\r\n            timestamp: Date.now()\r\n        }\r\n\r\n        awareness.setLocalStateField('moderation', kickAction)\r\n\r\n        // Remove from local members map\r\n        const doc = this.spaceDocs.get(spaceId)\r\n        if (doc) {\r\n            doc.transact(() => {\r\n                const membersMap = doc.getMap<SyncedMember>('members')\r\n                membersMap.delete(targetUserId)\r\n            })\r\n        }\r\n\r\n        // Clear moderation field after broadcast\r\n        setTimeout(() => {\r\n            awareness.setLocalStateField('moderation', null)\r\n        }, 1000)\r\n\r\n        console.log('[MemberSync] Kicked member:', targetUserId)\r\n        return true\r\n    }\r\n\r\n    /**\r\n     * Ban a member (broadcast via awareness + persist)\r\n     */\r\n    banMember(spaceId: string, targetUserId: string, reason?: string): boolean {\r\n        const awareness = this.spaceAwareness.get(spaceId)\r\n        const doc = this.spaceDocs.get(spaceId)\r\n        const store = useMemberStore.getState()\r\n\r\n        if (!awareness || !doc) {\r\n            console.error('[MemberSync] No awareness/doc for space:', spaceId)\r\n            return false\r\n        }\r\n\r\n        const myUserId = store.userId\r\n\r\n        // Add to banned list\r\n        doc.transact(() => {\r\n            const bannedMap = doc.getMap<boolean>('banned')\r\n            const membersMap = doc.getMap<SyncedMember>('members')\r\n            bannedMap.set(targetUserId, true)\r\n            membersMap.delete(targetUserId)\r\n        })\r\n\r\n        // Broadcast ban action\r\n        const banAction: ModerationAction = {\r\n            type: 'ban',\r\n            targetUserId,\r\n            initiatorId: myUserId,\r\n            reason,\r\n            timestamp: Date.now()\r\n        }\r\n\r\n        awareness.setLocalStateField('moderation', banAction)\r\n\r\n        // Clear moderation field after broadcast\r\n        setTimeout(() => {\r\n            awareness.setLocalStateField('moderation', null)\r\n        }, 1000)\r\n\r\n        console.log('[MemberSync] Banned member:', targetUserId, reason)\r\n        return true\r\n    }\r\n\r\n    /**\r\n     * Unban a member\r\n     */\r\n    unbanMember(spaceId: string, targetUserId: string): boolean {\r\n        const doc = this.spaceDocs.get(spaceId)\r\n        const awareness = this.spaceAwareness.get(spaceId)\r\n        const store = useMemberStore.getState()\r\n\r\n        if (!doc) {\r\n            console.error('[MemberSync] No doc for space:', spaceId)\r\n            return false\r\n        }\r\n\r\n        doc.transact(() => {\r\n            const bannedMap = doc.getMap<boolean>('banned')\r\n            bannedMap.delete(targetUserId)\r\n        })\r\n\r\n        // Broadcast unban if awareness available\r\n        if (awareness) {\r\n            const unbanAction: ModerationAction = {\r\n                type: 'unban',\r\n                targetUserId,\r\n                initiatorId: store.userId,\r\n                timestamp: Date.now()\r\n            }\r\n            awareness.setLocalStateField('moderation', unbanAction)\r\n            setTimeout(() => {\r\n                awareness.setLocalStateField('moderation', null)\r\n            }, 1000)\r\n        }\r\n\r\n        console.log('[MemberSync] Unbanned member:', targetUserId)\r\n        return true\r\n    }\r\n\r\n    /**\r\n     * Update member role (sync via Y.Map)\r\n     */\r\n    updateMemberRole(spaceId: string, targetUserId: string, role: WorkspaceRole): boolean {\r\n        const doc = this.spaceDocs.get(spaceId)\r\n\r\n        if (!doc) {\r\n            console.error('[MemberSync] No doc for space:', spaceId)\r\n            return false\r\n        }\r\n\r\n        doc.transact(() => {\r\n            const membersMap = doc.getMap<SyncedMember>('members')\r\n            const member = membersMap.get(targetUserId)\r\n            if (member) {\r\n                membersMap.set(targetUserId, {\r\n                    ...member,\r\n                    role,\r\n                    permissions: { ...DEFAULT_PERMISSIONS[role] }\r\n                })\r\n            }\r\n        })\r\n\r\n        console.log('[MemberSync] Updated role:', targetUserId, role)\r\n        return true\r\n    }\r\n\r\n    /**\r\n     * Update member permissions (sync via Y.Map)\r\n     */\r\n    updateMemberPermissions(\r\n        spaceId: string,\r\n        targetUserId: string,\r\n        permissions: Partial<MemberPermissions>\r\n    ): boolean {\r\n        const doc = this.spaceDocs.get(spaceId)\r\n\r\n        if (!doc) {\r\n            console.error('[MemberSync] No doc for space:', spaceId)\r\n            return false\r\n        }\r\n\r\n        doc.transact(() => {\r\n            const membersMap = doc.getMap<SyncedMember>('members')\r\n            const member = membersMap.get(targetUserId)\r\n            if (member) {\r\n                membersMap.set(targetUserId, {\r\n                    ...member,\r\n                    permissions: { ...member.permissions, ...permissions }\r\n                })\r\n            }\r\n        })\r\n\r\n        console.log('[MemberSync] Updated permissions:', targetUserId, permissions)\r\n        return true\r\n    }\r\n\r\n    /**\r\n     * Get member permissions for enforcement\r\n     */\r\n    getMemberPermissions(spaceId: string, userId: string): MemberPermissions {\r\n        const doc = this.spaceDocs.get(spaceId)\r\n\r\n        if (!doc) {\r\n            return DEFAULT_PERMISSIONS.member\r\n        }\r\n\r\n        const membersMap = doc.getMap<SyncedMember>('members')\r\n        const member = membersMap.get(userId)\r\n\r\n        return member?.permissions || DEFAULT_PERMISSIONS.member\r\n    }\r\n\r\n    /**\r\n     * Check if user is banned\r\n     */\r\n    isUserBanned(spaceId: string, userId: string): boolean {\r\n        const doc = this.spaceDocs.get(spaceId)\r\n\r\n        if (!doc) return false\r\n\r\n        const bannedMap = doc.getMap<boolean>('banned')\r\n        return bannedMap.get(userId) || false\r\n    }\r\n\r\n    /**\r\n     * Get all online users\r\n     */\r\n    getOnlineUsers(spaceId: string): string[] {\r\n        const awareness = this.spaceAwareness.get(spaceId)\r\n        if (!awareness) return []\r\n\r\n        const online: string[] = []\r\n        const states = awareness.getStates() as Map<number, AwarenessState>\r\n        states.forEach(state => {\r\n            if (state.user?.id) {\r\n                online.push(state.user.id)\r\n            }\r\n        })\r\n        return online\r\n    }\r\n\r\n    /**\r\n     * Cleanup when leaving a space\r\n     */\r\n    cleanup(spaceId: string): void {\r\n        const unsubscribe = this.unsubscribers.get(spaceId)\r\n        if (unsubscribe) {\r\n            unsubscribe()\r\n            this.unsubscribers.delete(spaceId)\r\n        }\r\n\r\n        this.spaceDocs.delete(spaceId)\r\n        this.spaceAwareness.delete(spaceId)\r\n\r\n        console.log('[MemberSync] Cleaned up:', spaceId)\r\n    }\r\n}\r\n\r\nexport const memberSyncService = new MemberSyncService()\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\services\\modelDownloadService.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":16,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":16,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[499,553],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":44,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":44,"endColumn":22,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[1155,1213],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":52,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":52,"endColumn":21,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[1406,1467],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":58,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":58,"endColumn":21,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[1589,1649],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":70,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":70,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[1915,1976],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":71,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":71,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[1986,2040],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":92,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":92,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[2897,2939],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":97,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":97,"endColumn":22,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[3060,3106],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":116,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":116,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[3616,3666],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":127,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":127,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[3950,3997],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":134,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":134,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[4119,4168],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":145,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":145,"endColumn":22,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[4551,4611],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":147,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":147,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[4635,4696],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":159,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":159,"endColumn":21,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[4958,5020],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":168,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":168,"endColumn":30,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[5282,5336],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":175,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":175,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[5480,5528],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":178,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":178,"endColumn":22,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[5582,5635],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":17,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n// Model Download Service - Download GGUF models from Hugging Face\r\nimport { OfflineModel, getModelById } from '../types/offlineModels'\r\nimport { useModelStore } from '../stores/modelStore'\r\n\r\n// Models directory path (will be set by Electron main process)\r\nlet modelsDirectory = ''\r\n\r\n/**\r\n * Set the models directory path (called from main process)\r\n */\r\nexport function setModelsDirectory(path: string): void {\r\n    modelsDirectory = path\r\n    console.log('[ModelDownload] Models directory:', path)\r\n}\r\n\r\n/**\r\n * Get the models directory path\r\n */\r\nexport function getModelsDirectory(): string {\r\n    return modelsDirectory\r\n}\r\n\r\n/**\r\n * Get full path for a model file\r\n */\r\nexport function getModelPath(model: OfflineModel): string {\r\n    return `${modelsDirectory}/${model.filename}`\r\n}\r\n\r\n/**\r\n * Download controller for cancel/pause\r\n */\r\nconst downloadControllers = new Map<string, AbortController>()\r\n\r\n/**\r\n * Download a model from Hugging Face\r\n */\r\nexport async function downloadModel(modelId: string): Promise<boolean> {\r\n    const model = getModelById(modelId)\r\n    if (!model) {\r\n        console.error('[ModelDownload] Model not found:', modelId)\r\n        return false\r\n    }\r\n\r\n    const store = useModelStore.getState()\r\n\r\n    // Check if already downloading\r\n    if (store.activeDownloads[modelId]?.status === 'downloading') {\r\n        console.warn('[ModelDownload] Already downloading:', modelId)\r\n        return false\r\n    }\r\n\r\n    // Check if already downloaded\r\n    if (store.isModelDownloaded(modelId)) {\r\n        console.warn('[ModelDownload] Already downloaded:', modelId)\r\n        return true\r\n    }\r\n\r\n    // Create abort controller\r\n    const controller = new AbortController()\r\n    downloadControllers.set(modelId, controller)\r\n\r\n    // Start download tracking\r\n    store.startDownload(modelId, model.sizeBytes)\r\n\r\n    try {\r\n        console.log('[ModelDownload] Starting download:', model.name)\r\n        console.log('[ModelDownload] URL:', model.downloadUrl)\r\n\r\n        // Use Electron IPC if available, otherwise use fetch (for demo)\r\n        if (window.electronAPI?.downloadModel) {\r\n            // Electron main process handles download\r\n            const result = await window.electronAPI.downloadModel({\r\n                modelId,\r\n                url: model.downloadUrl,\r\n                filename: model.filename,\r\n                expectedSize: model.sizeBytes\r\n            })\r\n\r\n            if (result.success && result.path) {\r\n                store.completeDownload(modelId, result.path)\r\n                return true\r\n            } else {\r\n                store.failDownload(modelId, result.error || 'Download failed')\r\n                return false\r\n            }\r\n        } else {\r\n            const errorMsg = 'Offline AI is not available in this environment. Please run in the desktop app.'\r\n            console.error('[ModelDownload]', errorMsg)\r\n            store.failDownload(modelId, errorMsg)\r\n            return false\r\n        }\r\n    } catch (error) {\r\n        console.error('[ModelDownload] Error:', error)\r\n        store.failDownload(modelId, error instanceof Error ? error.message : 'Unknown error')\r\n        return false\r\n    } finally {\r\n        downloadControllers.delete(modelId)\r\n    }\r\n}\r\n\r\n\r\n/**\r\n * Cancel an active download\r\n */\r\nexport function cancelDownload(modelId: string): void {\r\n    const controller = downloadControllers.get(modelId)\r\n    if (controller) {\r\n        controller.abort()\r\n        downloadControllers.delete(modelId)\r\n    }\r\n    useModelStore.getState().cancelDownload(modelId)\r\n    console.log('[ModelDownload] Cancelled:', modelId)\r\n}\r\n\r\n/**\r\n * Pause an active download\r\n */\r\nexport async function pauseDownload(modelId: string): Promise<void> {\r\n    if (window.electronAPI?.pauseDownload) {\r\n        await window.electronAPI.pauseDownload(modelId)\r\n    }\r\n    useModelStore.getState().pauseDownload(modelId)\r\n    console.log('[ModelDownload] Paused:', modelId)\r\n}\r\n\r\n/**\r\n * Resume a paused download\r\n */\r\nexport async function resumeDownload(modelId: string): Promise<void> {\r\n    console.log('[ModelDownload] Resuming:', modelId)\r\n\r\n    // Update UI state to show resuming\r\n    useModelStore.getState().resumeDownload(modelId)\r\n\r\n    // Trigger actual download (main process will use Range header for partial download)\r\n    const success = await downloadModel(modelId)\r\n\r\n    if (!success) {\r\n        // If resume failed, revert to paused status\r\n        useModelStore.getState().pauseDownload(modelId)\r\n        console.error('[ModelDownload] Resume failed for:', modelId)\r\n    } else {\r\n        console.log('[ModelDownload] Successfully resumed:', modelId)\r\n    }\r\n}\r\n\r\n/**\r\n * Delete a downloaded model\r\n */\r\nexport async function deleteModel(modelId: string): Promise<boolean> {\r\n    const store = useModelStore.getState()\r\n    const downloaded = store.getDownloadedModel(modelId)\r\n\r\n    if (!downloaded) {\r\n        console.warn('[ModelDownload] Model not downloaded:', modelId)\r\n        return false\r\n    }\r\n\r\n    try {\r\n        // Use Electron IPC if available\r\n        if (window.electronAPI?.deleteModel) {\r\n            const success = await window.electronAPI.deleteModel(downloaded.path)\r\n            if (!success) {\r\n                console.error('[ModelDownload] Failed to delete file')\r\n                return false\r\n            }\r\n        }\r\n\r\n        // Remove from store\r\n        store.removeDownloadedModel(modelId)\r\n        console.log('[ModelDownload] Deleted:', modelId)\r\n        return true\r\n    } catch (error) {\r\n        console.error('[ModelDownload] Delete error:', error)\r\n        return false\r\n    }\r\n}\r\n\r\n/**\r\n * Check if a model file exists on disk\r\n */\r\nexport async function verifyModelExists(modelId: string): Promise<boolean> {\r\n    const store = useModelStore.getState()\r\n    const downloaded = store.getDownloadedModel(modelId)\r\n\r\n    if (!downloaded) return false\r\n\r\n    if (window.electronAPI?.fileExists) {\r\n        return await window.electronAPI.fileExists(downloaded.path)\r\n    }\r\n\r\n    return false\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\services\\offlineLLMService.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":170,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":170,"endColumn":17,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[5695,5770],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":194,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":194,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[6494,6530],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":202,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":202,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[6828,6864],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":207,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":207,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[6952,7191],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":219,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":219,"endColumn":30,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[7528,7564],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":223,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":223,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[7666,7721],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":232,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":232,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[7986,8044],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":237,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":237,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[8124,8178],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":243,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":243,"endColumn":30,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[8442,8481],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":257,"column":25,"nodeType":"MemberExpression","messageId":"unexpected","endLine":257,"endColumn":36,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[9080,9161],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":261,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":261,"endColumn":29,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[9248,9319],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":265,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":265,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9406,9409],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9406,9409],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":270,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":270,"endColumn":32,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[9626,9691],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":273,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":273,"endColumn":29,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[9755,9821],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":276,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":276,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9905,9908],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9905,9908],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":294,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":294,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[10467,10533],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":297,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":297,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[10599,10647],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":310,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":310,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[10964,11029],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":361,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":361,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[12632,12692],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":362,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":362,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[12702,12760],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":397,"column":33,"nodeType":"MemberExpression","messageId":"unexpected","endLine":397,"endColumn":44,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[14199,14271],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":412,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":412,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[14831,14884],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":442,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":442,"endColumn":30,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[15534,15604],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":448,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":448,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[15764,15836],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":454,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":454,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[15993,16043],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":25,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Copyright 2026 Hermes Lekkas.\r\n * PROPRIETARY & CONFIDENTIAL.\r\n * \r\n * This file is part of the Kalynt \"Pro\" Edition.\r\n * Unauthorized copying, distribution, or modification of this file, \r\n * via any medium, is strictly prohibited.\r\n */\r\n\r\n// Offline LLM Service - Run local inference with downloaded GGUF models\r\nimport { OfflineModel, getModelById } from '../types/offlineModels'\r\nimport { useModelStore } from '../stores/modelStore'\r\n\r\n/**\r\n * Message format for chat\r\n */\r\nexport interface ChatMessage {\r\n    role: 'system' | 'user' | 'assistant'\r\n    content: string\r\n}\r\n\r\n/**\r\n * Inference options\r\n */\r\nexport interface InferenceOptions {\r\n    maxTokens?: number\r\n    temperature?: number\r\n    topP?: number\r\n    stopSequences?: string[]\r\n    jsonSchema?: object  // For grammar-based sampling (Cursor-like reliability)\r\n    onToken?: (token: string) => void  // For streaming\r\n}\r\n\r\n/**\r\n * Default inference options\r\n */\r\nconst DEFAULT_OPTIONS: InferenceOptions = {\r\n    maxTokens: 2048,\r\n    temperature: 0.7,\r\n    topP: 0.9,\r\n    stopSequences: []\r\n}\r\n\r\n/**\r\n * Clean response by stripping stop tokens and template markers\r\n */\r\nfunction cleanResponse(text: string): string {\r\n    return text\r\n        // Qwen/ChatML tokens\r\n        .replace(/<\\|im_end\\|>/g, '')\r\n        .replace(/<\\|im_start\\|>/g, '')\r\n        .replace(/<\\|im_end\\|/g, '')  // Partial tokens\r\n        .replace(/<\\|im_start\\|/g, '')\r\n        // Granite tokens\r\n        .replace(/<\\|end_of_text\\|>/g, '')\r\n        .replace(/<\\|start_of_role\\|>/g, '')\r\n        // Mistral/Devstral tokens\r\n        .replace(/<\\/s>/g, '')\r\n        .replace(/<s>/g, '')\r\n        .replace(/\\[INST\\]/g, '')\r\n        .replace(/\\[\\/INST\\]/g, '')\r\n        // Clean up any remaining role indicators at the end\r\n        .replace(/\\n?(user|assistant|system)\\s*$/gi, '')\r\n        .trim()\r\n}\r\n\r\n/**\r\n * Get stop sequences for a model's template type\r\n */\r\nfunction getStopSequences(model: OfflineModel): string[] {\r\n    const template = model.promptTemplate\r\n\r\n    // Qwen/ChatML format - only use im_end as stop (im_start would stop at beginning!)\r\n    if (template.includes('<|im_start|>')) {\r\n        return ['<|im_end|>']\r\n    }\r\n\r\n    // Devstral/Mistral format - only use end token\r\n    if (template.includes('[INST]')) {\r\n        return ['</s>']\r\n    }\r\n\r\n    // IBM Granite format - only use end token\r\n    if (template.includes('<|start_of_role|>')) {\r\n        return ['<|end_of_text|>']\r\n    }\r\n\r\n    return []\r\n}\r\n\r\n/**\r\n * Format messages using model's prompt template\r\n * Properly handles conversation history for different model types\r\n */\r\nfunction formatPrompt(model: OfflineModel, messages: ChatMessage[]): string {\r\n    const template = model.promptTemplate\r\n\r\n    // Detect template type based on markers\r\n    const isQwen = template.includes('<|im_start|>')\r\n    const isDevstral = template.includes('[INST]')\r\n    const isGranite = template.includes('<|start_of_role|>')\r\n\r\n    // Extract system messages (concatenate all system messages)\r\n    const systemMessages = messages.filter(m => m.role === 'system')\r\n    const systemContent = systemMessages.map(m => m.content).join('\\n').trim()\r\n\r\n    // Get conversation history (user and assistant messages)\r\n    const conversationMessages = messages.filter(m => m.role !== 'system')\r\n\r\n    // Qwen/ChatML format: <|im_start|>role\\ncontent<|im_end|>\r\n    if (isQwen) {\r\n        let formatted = ''\r\n        if (systemContent) {\r\n            formatted += `<|im_start|>system\\n${systemContent}<|im_end|>\\n`\r\n        }\r\n        for (const msg of conversationMessages) {\r\n            formatted += `<|im_start|>${msg.role}\\n${msg.content}<|im_end|>\\n`\r\n        }\r\n        formatted += '<|im_start|>assistant\\n'\r\n        return formatted\r\n    }\r\n\r\n    // Devstral/Mistral format: <s>[INST] system\\n\\nuser [/INST] assistant</s> [INST] user [/INST]\r\n    if (isDevstral) {\r\n        let formatted = '<s>'\r\n\r\n        // First turn includes system message\r\n        const firstUserMsg = conversationMessages.find(m => m.role === 'user')\r\n        if (firstUserMsg) {\r\n            const systemPrefix = systemContent ? `${systemContent}\\n\\n` : ''\r\n            formatted += `[INST] ${systemPrefix}${firstUserMsg.content} [/INST]`\r\n\r\n            // Add subsequent conversation turns\r\n            let skipNext = true // Skip the first user message we already added\r\n            for (let i = 0; i < conversationMessages.length; i++) {\r\n                const msg = conversationMessages[i]\r\n                if (msg.role === 'user' && skipNext) {\r\n                    skipNext = false\r\n                    continue\r\n                }\r\n\r\n                if (msg.role === 'assistant') {\r\n                    formatted += ` ${msg.content}</s>`\r\n                } else if (msg.role === 'user') {\r\n                    formatted += ` [INST] ${msg.content} [/INST]`\r\n                }\r\n            }\r\n        } else {\r\n            // No user message yet, just format system\r\n            formatted += `[INST] ${systemContent} [/INST]`\r\n        }\r\n\r\n        return formatted\r\n    }\r\n\r\n    // IBM Granite format: <|start_of_role|>role<|end_of_role|>content<|end_of_text|>\r\n    if (isGranite) {\r\n        let formatted = ''\r\n        if (systemContent) {\r\n            formatted += `<|start_of_role|>system<|end_of_role|>${systemContent}<|end_of_text|>\\n`\r\n        }\r\n        for (const msg of conversationMessages) {\r\n            formatted += `<|start_of_role|>${msg.role}<|end_of_role|>${msg.content}<|end_of_text|>\\n`\r\n        }\r\n        formatted += '<|start_of_role|>assistant<|end_of_role|>'\r\n        return formatted\r\n    }\r\n\r\n    // Fallback: use simple template replacement (shouldn't reach here)\r\n    console.warn('[OfflineLLM] Unknown prompt template format, using fallback')\r\n    const lastUser = conversationMessages.filter(m => m.role === 'user').pop()?.content || ''\r\n    return template\r\n        .replace('{system}', systemContent)\r\n        .replace('{user}', lastUser)\r\n}\r\n\r\n/**\r\n * Offline LLM Service class\r\n */\r\nclass OfflineLLMService {\r\n    private isModelLoaded = false\r\n    private currentModelId: string | null = null\r\n    private currentRequestId: string | null = null\r\n\r\n    /**\r\n     * Load a model for inference\r\n     */\r\n    async loadModel(modelId: string): Promise<boolean> {\r\n        const model = getModelById(modelId)\r\n        const store = useModelStore.getState()\r\n\r\n        if (!model) {\r\n            const error = `Model configuration not found: ${modelId}`\r\n            console.error('[OfflineLLM]', error)\r\n            store.setLoadError(error)\r\n            return false\r\n        }\r\n\r\n        const downloaded = store.getDownloadedModel(modelId)\r\n        if (!downloaded) {\r\n            const error = `Model not downloaded: ${model.name}. Please download it first from the settings panel.`\r\n            console.error('[OfflineLLM]', error)\r\n            store.setLoadError(error)\r\n            return false\r\n        }\r\n\r\n        console.log('[OfflineLLM] Attempting to load model:', {\r\n            modelId,\r\n            name: model.name,\r\n            path: downloaded.path,\r\n            size: (downloaded.sizeBytes / 1024 / 1024 / 1024).toFixed(2) + ' GB',\r\n        })\r\n\r\n        // Verify file exists before trying to load\r\n        if (window.electronAPI?.fileExists) {\r\n            const exists = await window.electronAPI.fileExists(downloaded.path)\r\n            if (!exists) {\r\n                const error = `Model file not found at: ${downloaded.path}. Try re-downloading the model.`\r\n                console.error('[OfflineLLM]', error)\r\n                store.setLoadError(error)\r\n                return false\r\n            }\r\n            console.log('[OfflineLLM] Model file verified on disk')\r\n        }\r\n\r\n        // Unload current model if different\r\n        if (this.currentModelId && this.currentModelId !== modelId) {\r\n            await this.unloadModel()\r\n        }\r\n\r\n        if (this.currentModelId === modelId && this.isModelLoaded) {\r\n            console.log('[OfflineLLM] Model already loaded:', modelId)\r\n            return true\r\n        }\r\n\r\n        store.setLoading(true)\r\n        console.log('[OfflineLLM] Loading model:', model.name)\r\n\r\n        try {\r\n            // Check if Electron IPC is available\r\n            if (!globalThis.window.electronAPI?.loadModel) {\r\n                const errorMsg = 'Offline AI is not available in this environment. Please run in the desktop app.'\r\n                console.error('[OfflineLLM]', errorMsg)\r\n                store.setLoadError(errorMsg)\r\n                store.setLoading(false)\r\n                return false\r\n            }\r\n\r\n            // Check for custom context length in settings\r\n            let contextLength = model.contextLength // Default\r\n            try {\r\n                const storedContexts = localStorage.getItem('model-context-settings')\r\n                if (storedContexts) {\r\n                    const contexts = JSON.parse(storedContexts)\r\n                    if (contexts[modelId]) {\r\n                        contextLength = contexts[modelId]\r\n                        console.log('[OfflineLLM] Using custom context length:', contextLength, 'tokens')\r\n                    }\r\n                }\r\n            } catch (e) {\r\n                console.warn('[OfflineLLM] Failed to read custom context settings:', e)\r\n            }\r\n\r\n            // Load AIME configuration\r\n            let aimeConfig: any = undefined\r\n            try {\r\n                const storedAIME = localStorage.getItem('aime-config')\r\n                if (storedAIME) {\r\n                    aimeConfig = JSON.parse(storedAIME)\r\n                    console.log('[OfflineLLM] Using AIME configuration:', aimeConfig)\r\n                }\r\n            } catch (e) {\r\n                console.warn('[OfflineLLM] Failed to read AIME configuration:', e)\r\n            }\r\n\r\n            const electronAPI = globalThis.window.electronAPI as any\r\n            const result = await electronAPI.loadModel({\r\n                modelId,\r\n                path: downloaded.path,\r\n                contextLength,\r\n                expectedSizeBytes: model.sizeBytes,\r\n                aimeConfig\r\n            })\r\n\r\n            if (!result.success) {\r\n                throw new Error(result.error || 'Failed to load model')\r\n            }\r\n\r\n            this.isModelLoaded = true\r\n            this.currentModelId = modelId\r\n            store.setLoadedModel(modelId)\r\n            store.setLoading(false)\r\n\r\n            console.log('[OfflineLLM] Model loaded successfully:', model.name)\r\n            return true\r\n        } catch (error) {\r\n            console.error('[OfflineLLM] Load error:', error)\r\n            store.setLoadError(error instanceof Error ? error.message : 'Load failed')\r\n            store.setLoading(false)\r\n            return false\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Unload the current model\r\n     */\r\n    async unloadModel(): Promise<void> {\r\n        if (!this.isModelLoaded) return\r\n\r\n        console.log('[OfflineLLM] Unloading model:', this.currentModelId)\r\n\r\n        if (globalThis.window.electronAPI?.unloadModel) {\r\n            await globalThis.window.electronAPI.unloadModel()\r\n        }\r\n\r\n        this.isModelLoaded = false\r\n        this.currentModelId = null\r\n        useModelStore.getState().setLoadedModel(null)\r\n    }\r\n\r\n    /**\r\n     * Generate a response from the loaded model\r\n     */\r\n    async generate(\r\n        messages: ChatMessage[],\r\n        options: InferenceOptions = {}\r\n    ): Promise<string> {\r\n        // Use streaming API internally for cancellation support\r\n        // Just accumulate tokens without calling onToken callback\r\n        return await this.generateStream(\r\n            messages,\r\n            () => { }, // No-op token callback\r\n            options\r\n        )\r\n    }\r\n\r\n    /**\r\n     * Generate streaming response\r\n     */\r\n    async generateStream(\r\n        messages: ChatMessage[],\r\n        onToken: (token: string) => void,\r\n        options: InferenceOptions = {}\r\n    ): Promise<string> {\r\n        if (!this.isModelLoaded || !this.currentModelId) {\r\n            throw new Error('No model loaded')\r\n        }\r\n\r\n        const model = getModelById(this.currentModelId)\r\n        if (!model) {\r\n            throw new Error('Model configuration not found')\r\n        }\r\n\r\n        const opts = { ...DEFAULT_OPTIONS, ...options, onToken }\r\n        const prompt = formatPrompt(model, messages)\r\n\r\n        // Merge model-specific stop sequences with user-provided ones\r\n        const modelStopSequences = getStopSequences(model)\r\n        const stopSequences = [...modelStopSequences, ...(opts.stopSequences || [])]\r\n\r\n        console.log('[OfflineLLM] Starting streaming generation...')\r\n        console.log('[OfflineLLM] Stop sequences:', stopSequences)\r\n\r\n        try {\r\n            // Ensure we use the robust stream implementation\r\n            const streamFn = globalThis.window.electronAPI?.generateCompletionStream\r\n            if (!streamFn) {\r\n                // Feature detection failed\r\n                throw new Error('Streaming generation is not supported by the current app version.')\r\n            }\r\n\r\n            return await new Promise((resolve, reject) => {\r\n                let fullText = ''\r\n                let completed = false\r\n\r\n                const requestId = streamFn(\r\n                    {\r\n                        prompt,\r\n                        maxTokens: opts.maxTokens!,\r\n                        temperature: opts.temperature!,\r\n                        topP: opts.topP!,\r\n                        stopSequences,\r\n                        jsonSchema: opts.jsonSchema\r\n                    },\r\n                    (token) => {\r\n                        fullText += token\r\n                        onToken(token)\r\n                    },\r\n                    (error) => {\r\n                        if (completed) return // Prevent double resolution\r\n                        completed = true\r\n                        this.currentRequestId = null\r\n\r\n                        if (error) {\r\n                            // Check if it's an abort error\r\n                            if (error.includes('Aborted') || error.includes('abort')) {\r\n                                console.log('[OfflineLLM] Generation aborted, returning partial result')\r\n                                resolve(cleanResponse(fullText)) // Return partial result on abort\r\n                            } else {\r\n                                reject(new Error(error))\r\n                            }\r\n                        } else {\r\n                            resolve(cleanResponse(fullText))\r\n                        }\r\n                    }\r\n                )\r\n\r\n                // Track the request ID for cancellation\r\n                this.currentRequestId = requestId\r\n            })\r\n        } catch (error) {\r\n            console.error('[OfflineLLM] Streaming error:', error)\r\n            throw error\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Check if a model is currently loaded\r\n     */\r\n    isLoaded(): boolean {\r\n        return this.isModelLoaded\r\n    }\r\n\r\n    /**\r\n     * Get the currently loaded model ID\r\n     */\r\n    getLoadedModelId(): string | null {\r\n        return this.currentModelId\r\n    }\r\n\r\n    /**\r\n     * Cancel the current generation\r\n     */\r\n    async cancelGeneration(): Promise<boolean> {\r\n        if (!this.currentRequestId) {\r\n            return false\r\n        }\r\n\r\n        try {\r\n            const cancelFn = globalThis.window.electronAPI?.cancelGeneration\r\n            if (!cancelFn) {\r\n                console.error('[OfflineLLM] Cancel not supported in this environment')\r\n                return false\r\n            }\r\n\r\n            const success = await cancelFn(this.currentRequestId)\r\n            if (success) {\r\n                console.log('[OfflineLLM] Generation cancelled:', this.currentRequestId)\r\n                this.currentRequestId = null\r\n                return true\r\n            }\r\n            return false\r\n        } catch (error) {\r\n            console.error('[OfflineLLM] Cancel error:', error)\r\n            return false\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Check if a generation is currently in progress\r\n     */\r\n    isGenerating(): boolean {\r\n        return this.currentRequestId !== null\r\n    }\r\n}\r\n\r\n// Singleton instance\r\nexport const offlineLLMService = new OfflineLLMService()\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\services\\p2pService.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":180,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":180,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[6129,6202],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n// P2P Service - WebRTC peer-to-peer networking with signaling\r\nimport * as Y from 'yjs'\r\nimport { WebrtcProvider } from 'y-webrtc'\r\nimport { logger } from '../utils/logger'\r\n\r\nexport interface PeerInfo {\r\n    id: string\r\n    name: string\r\n    color: string\r\n    lastSeen: number\r\n    isOnline: boolean\r\n}\r\n\r\nexport interface P2PConfig {\r\n    signalingServers: string[]\r\n    iceServers: RTCIceServer[]\r\n    maxPeers: number\r\n    password?: string\r\n}\r\n\r\nexport interface P2PStats {\r\n    connectedPeers: number\r\n    totalBytesReceived: number\r\n    totalBytesSent: number\r\n    averageLatency: number\r\n}\r\n\r\ntype ConnectionCallback = (peerId: string, connected: boolean) => void\r\ntype SyncCallback = (synced: boolean) => void\r\ntype PeersCallback = (peers: PeerInfo[]) => void\r\n\r\nconst DEFAULT_CONFIG: P2PConfig = {\r\n    signalingServers: [\r\n        'wss://signaling.yjs.dev',\r\n        'wss://y-webrtc-signaling-eu.herokuapp.com',\r\n        'wss://y-webrtc-signaling-us.herokuapp.com'\r\n    ],\r\n    iceServers: [\r\n        // STUN servers for NAT traversal (discovers public IP)\r\n        { urls: 'stun:stun.l.google.com:19302' },\r\n        { urls: 'stun:stun1.l.google.com:19302' },\r\n        { urls: 'stun:stun2.l.google.com:19302' },\r\n        { urls: 'stun:stun3.l.google.com:19302' },\r\n        { urls: 'stun:stun4.l.google.com:19302' },\r\n        // OpenRelay TURN servers (free, for when STUN fails - symmetric NAT, firewalls)\r\n        // These are essential for cross-network connectivity\r\n        {\r\n            urls: 'turn:openrelay.metered.ca:80',\r\n            username: 'openrelayproject',\r\n            credential: 'openrelayproject'\r\n        },\r\n        {\r\n            urls: 'turn:openrelay.metered.ca:443',\r\n            username: 'openrelayproject',\r\n            credential: 'openrelayproject'\r\n        },\r\n        {\r\n            urls: 'turn:openrelay.metered.ca:443?transport=tcp',\r\n            username: 'openrelayproject',\r\n            credential: 'openrelayproject'\r\n        },\r\n        // Metered.ca free TURN (backup)\r\n        {\r\n            urls: 'turn:a.relay.metered.ca:80',\r\n            username: 'e8dd65b92f62d5eedb7e1b12',\r\n            credential: 'uWdWNmkhvyqTmFfm'\r\n        },\r\n        {\r\n            urls: 'turn:a.relay.metered.ca:443',\r\n            username: 'e8dd65b92f62d5eedb7e1b12',\r\n            credential: 'uWdWNmkhvyqTmFfm'\r\n        },\r\n        {\r\n            urls: 'turn:a.relay.metered.ca:443?transport=tcp',\r\n            username: 'e8dd65b92f62d5eedb7e1b12',\r\n            credential: 'uWdWNmkhvyqTmFfm'\r\n        }\r\n    ],\r\n    maxPeers: 15\r\n}\r\n\r\nclass P2PService {\r\n    private providers: Map<string, WebrtcProvider> = new Map()\r\n    private config: P2PConfig = DEFAULT_CONFIG\r\n    private localUser: { name: string; color: string } = { name: 'Anonymous', color: '#3b82f6' }\r\n\r\n    // Per-room callbacks for better isolation when managing multiple rooms\r\n    private roomCallbacks: Map<string, {\r\n        onConnection?: ConnectionCallback\r\n        onSync?: SyncCallback\r\n        onPeers?: PeersCallback\r\n    }> = new Map()\r\n\r\n    setConfig(config: Partial<P2PConfig>) {\r\n        this.config = { ...this.config, ...config }\r\n    }\r\n\r\n    setLocalUser(name: string, color: string) {\r\n        this.localUser = { name, color }\r\n        // Update awareness for all active providers\r\n        this.providers.forEach(provider => {\r\n            provider.awareness.setLocalStateField('user', this.localUser)\r\n        })\r\n    }\r\n\r\n    // Set callbacks for a specific room\r\n    setRoomCallbacks(\r\n        roomId: string,\r\n        callbacks: {\r\n            onConnection?: ConnectionCallback\r\n            onSync?: SyncCallback\r\n            onPeers?: PeersCallback\r\n        }\r\n    ) {\r\n        this.roomCallbacks.set(roomId, callbacks)\r\n    }\r\n\r\n    // Legacy: set global callbacks (applies to all rooms without specific callbacks)\r\n    setCallbacks(\r\n        onConnection: ConnectionCallback,\r\n        onSync: SyncCallback,\r\n        onPeers: PeersCallback\r\n    ) {\r\n        // Store as default callbacks\r\n        this.roomCallbacks.set('__default__', { onConnection, onSync, onPeers })\r\n    }\r\n\r\n    private getCallbacks(roomId: string) {\r\n        return this.roomCallbacks.get(roomId) || this.roomCallbacks.get('__default__') || {}\r\n    }\r\n\r\n    connect(roomId: string, doc: Y.Doc): WebrtcProvider | null {\r\n        // Check if already connected\r\n        if (this.providers.has(roomId)) {\r\n            return this.providers.get(roomId)!\r\n        }\r\n\r\n        try {\r\n            // Create WebRTC provider with error handling\r\n            const provider = new WebrtcProvider(roomId, doc, {\r\n                signaling: this.config.signalingServers,\r\n                password: this.config.password,\r\n                maxConns: this.config.maxPeers,\r\n                // filterBcConns: true filters broadcast connections to only allow\r\n                // connections established via signaling, providing better control\r\n                // over peer discovery and preventing unwanted broadcast joins\r\n                filterBcConns: true,\r\n                peerOpts: {\r\n                    config: {\r\n                        iceServers: this.config.iceServers\r\n                    }\r\n                }\r\n            })\r\n\r\n            // Set local user info\r\n            provider.awareness.setLocalStateField('user', this.localUser)\r\n\r\n            const callbacks = this.getCallbacks(roomId)\r\n\r\n            // Handle sync events\r\n            provider.on('synced', ({ synced }: { synced: boolean }) => {\r\n                callbacks.onSync?.(synced)\r\n            })\r\n\r\n            // Handle peer connections\r\n            provider.on('peers', ({ added, removed }: { added: string[]; removed: string[] }) => {\r\n                added.forEach(id => callbacks.onConnection?.(id, true))\r\n                removed.forEach(id => callbacks.onConnection?.(id, false))\r\n                this.updatePeerList(provider, roomId)\r\n            })\r\n\r\n            // Track provider\r\n            this.providers.set(roomId, provider)\r\n\r\n            return provider\r\n        } catch (err) {\r\n            console.error(`[P2P] Failed to create provider for room ${roomId}:`, err)\r\n            return null\r\n        }\r\n    }\r\n\r\n    disconnect(roomId: string) {\r\n        const provider = this.providers.get(roomId)\r\n        if (provider) {\r\n            provider.destroy()\r\n            this.providers.delete(roomId)\r\n            this.roomCallbacks.delete(roomId)\r\n        }\r\n    }\r\n\r\n    disconnectAll() {\r\n        this.providers.forEach((provider, _roomId) => {\r\n            provider.destroy()\r\n        })\r\n        this.providers.clear()\r\n        this.roomCallbacks.clear()\r\n    }\r\n\r\n    private updatePeerList(provider: WebrtcProvider, roomId: string) {\r\n        const peers: PeerInfo[] = []\r\n        const now = Date.now()\r\n\r\n        provider.awareness.getStates().forEach((state, clientId) => {\r\n            if (clientId !== provider.awareness.clientID) {\r\n                const user = state.user as { name?: string; color?: string } | undefined\r\n                peers.push({\r\n                    id: String(clientId),\r\n                    name: user?.name || 'Anonymous',\r\n                    color: user?.color || '#888',\r\n                    lastSeen: now,\r\n                    isOnline: true\r\n                })\r\n            }\r\n        })\r\n\r\n        this.getCallbacks(roomId).onPeers?.(peers)\r\n    }\r\n\r\n    getConnectedPeers(roomId: string): PeerInfo[] {\r\n        const provider = this.providers.get(roomId)\r\n        if (!provider) return []\r\n\r\n        const peers: PeerInfo[] = []\r\n        const now = Date.now()\r\n\r\n        provider.awareness.getStates().forEach((state, clientId) => {\r\n            if (clientId !== provider.awareness.clientID) {\r\n                const user = state.user as { name?: string; color?: string } | undefined\r\n                peers.push({\r\n                    id: String(clientId),\r\n                    name: user?.name || 'Anonymous',\r\n                    color: user?.color || '#888',\r\n                    lastSeen: now,\r\n                    isOnline: true\r\n                })\r\n            }\r\n        })\r\n\r\n        return peers\r\n    }\r\n\r\n    getPeerCount(roomId: string): number {\r\n        const provider = this.providers.get(roomId)\r\n        if (!provider) return 0\r\n        return provider.awareness.getStates().size - 1 // Exclude self\r\n    }\r\n\r\n    isConnected(roomId: string): boolean {\r\n        return this.providers.has(roomId)\r\n    }\r\n\r\n    getProvider(roomId: string): WebrtcProvider | undefined {\r\n        return this.providers.get(roomId)\r\n    }\r\n\r\n    // Generate a shareable room link (updated branding to kalynt)\r\n    generateRoomLink(roomId: string, password?: string): string {\r\n        const base = `kalynt://join/${roomId}`\r\n        if (password) {\r\n            return `${base}?p=${encodeURIComponent(password)}`\r\n        }\r\n        return base\r\n    }\r\n\r\n    // Parse a room link (supports both kalynt and legacy collabforge)\r\n    parseRoomLink(link: string): { roomId: string; password?: string } | null {\r\n        try {\r\n            const url = new URL(link)\r\n            const roomId = url.pathname.split('/').pop()\r\n            const password = url.searchParams.get('p') || undefined\r\n            if (roomId) {\r\n                return { roomId, password }\r\n            }\r\n        } catch (error) {\r\n            // URL parsing failed, try simple regex format for both kalynt and legacy collabforge\r\n            logger.p2p.debug('Failed to parse room link as URL, trying regex', { link, error })\r\n            const match = link.match(/(?:kalynt|collabforge):\\/\\/join\\/([^?]+)/)\r\n            if (match) {\r\n                const passwordMatch = link.match(/[?&]p=([^&]+)/)\r\n                return {\r\n                    roomId: match[1],\r\n                    password: passwordMatch ? decodeURIComponent(passwordMatch[1]) : undefined\r\n                }\r\n            }\r\n        }\r\n        return null\r\n    }\r\n\r\n    // Get stats for a room\r\n    getStats(roomId: string): P2PStats {\r\n        return {\r\n            connectedPeers: this.getPeerCount(roomId),\r\n            totalBytesReceived: 0, // Would need custom tracking\r\n            totalBytesSent: 0,\r\n            averageLatency: 0\r\n        }\r\n    }\r\n\r\n    // Test ICE connectivity to diagnose P2P issues\r\n    async testConnectivity(): Promise<{\r\n        stun: boolean\r\n        turn: boolean\r\n        candidates: { type: string; protocol: string; address?: string }[]\r\n        error?: string\r\n    }> {\r\n        const result = {\r\n            stun: false,\r\n            turn: false,\r\n            candidates: [] as { type: string; protocol: string; address?: string }[]\r\n        }\r\n\r\n        try {\r\n            const pc = new RTCPeerConnection({ iceServers: this.config.iceServers })\r\n\r\n            // Create a data channel to trigger ICE gathering\r\n            pc.createDataChannel('test')\r\n\r\n            const gatheringComplete = new Promise<void>((resolve) => {\r\n                const timeout = setTimeout(() => resolve(), 10000) // 10s timeout\r\n\r\n                pc.onicecandidate = (event) => {\r\n                    if (event.candidate) {\r\n                        const candidate = event.candidate\r\n                        const candidateInfo = {\r\n                            type: candidate.type || 'unknown',\r\n                            protocol: candidate.protocol || 'unknown',\r\n                            address: candidate.address || undefined\r\n                        }\r\n                        result.candidates.push(candidateInfo)\r\n\r\n                        // Check candidate types\r\n                        if (candidate.type === 'srflx') {\r\n                            result.stun = true // Server reflexive = STUN working\r\n                        } else if (candidate.type === 'relay') {\r\n                            result.turn = true // Relay = TURN working\r\n                        }\r\n                    } else {\r\n                        // Gathering complete\r\n                        clearTimeout(timeout)\r\n                        resolve()\r\n                    }\r\n                }\r\n\r\n                pc.onicegatheringstatechange = () => {\r\n                    if (pc.iceGatheringState === 'complete') {\r\n                        clearTimeout(timeout)\r\n                        resolve()\r\n                    }\r\n                }\r\n            })\r\n\r\n            // Create offer to start ICE gathering\r\n            const offer = await pc.createOffer()\r\n            await pc.setLocalDescription(offer)\r\n\r\n            // Wait for gathering to complete\r\n            await gatheringComplete\r\n\r\n            pc.close()\r\n\r\n            logger.p2p.info('ICE connectivity test complete', result)\r\n            return result\r\n        } catch (error) {\r\n            logger.p2p.error('ICE connectivity test failed', { error })\r\n            return { ...result, error: String(error) }\r\n        }\r\n    }\r\n\r\n    // Get detailed connection info for a room\r\n    getConnectionInfo(roomId: string): {\r\n        connected: boolean\r\n        peerCount: number\r\n        signalingState: string\r\n        iceServers: number\r\n        turnEnabled: boolean\r\n    } {\r\n        const provider = this.providers.get(roomId)\r\n        const hasTurn = this.config.iceServers.some(server =>\r\n            (typeof server.urls === 'string' ? server.urls : server.urls?.[0])?.startsWith('turn:')\r\n        )\r\n\r\n        return {\r\n            connected: !!provider,\r\n            peerCount: provider ? this.getPeerCount(roomId) : 0,\r\n            signalingState: provider ? 'connected' : 'disconnected',\r\n            iceServers: this.config.iceServers.length,\r\n            turnEnabled: hasTurn\r\n        }\r\n    }\r\n}\r\n\r\n// Singleton\r\nexport const p2pService = new P2PService()\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\services\\projectService.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":421,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":421,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[12636,12681],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n// Project Management Service - Spaces, tasks, and collaboration\r\nimport { collabEngine } from './collabEngine'\r\nimport { storageService } from './storageService'\r\nimport { encryptionService } from './encryptionService'\r\n\r\nexport interface Project {\r\n    id: string\r\n    name: string\r\n    icon: string\r\n    description: string\r\n    createdAt: number\r\n    updatedAt: number\r\n    ownerId: string\r\n    settings: ProjectSettings\r\n    members: ProjectMember[]\r\n}\r\n\r\nexport interface ProjectSettings {\r\n    isPublic: boolean\r\n    requirePassword: boolean\r\n    passwordHash?: string\r\n    allowAnonymous: boolean\r\n    editorMode: string\r\n    theme: string\r\n}\r\n\r\nexport interface ProjectMember {\r\n    id: string\r\n    name: string\r\n    email?: string\r\n    role: 'owner' | 'admin' | 'editor' | 'viewer'\r\n    color: string\r\n    joinedAt: number\r\n    lastSeenAt: number\r\n}\r\n\r\nexport interface Task {\r\n    id: string\r\n    projectId: string\r\n    title: string\r\n    description: string\r\n    status: 'todo' | 'in-progress' | 'review' | 'done'\r\n    priority: 'low' | 'medium' | 'high' | 'urgent'\r\n    assigneeId?: string\r\n    dueDate?: number\r\n    tags: string[]\r\n    createdAt: number\r\n    updatedAt: number\r\n    createdBy: string\r\n    subtasks: Subtask[]\r\n    comments: Comment[]\r\n}\r\n\r\nexport interface Subtask {\r\n    id: string\r\n    title: string\r\n    completed: boolean\r\n}\r\n\r\nexport interface Comment {\r\n    id: string\r\n    userId: string\r\n    userName: string\r\n    content: string\r\n    timestamp: number\r\n}\r\n\r\nexport interface Activity {\r\n    id: string\r\n    projectId: string\r\n    userId: string\r\n    userName: string\r\n    type: 'create' | 'update' | 'delete' | 'comment' | 'join' | 'leave'\r\n    target: 'project' | 'task' | 'document' | 'member'\r\n    targetId: string\r\n    description: string\r\n    timestamp: number\r\n}\r\n\r\ntype ProjectCallback = (project: Project) => void\r\ntype TasksCallback = (tasks: Task[]) => void\r\ntype ActivityCallback = (activity: Activity) => void\r\n\r\nclass ProjectService {\r\n    private projects: Map<string, Project> = new Map()\r\n    private currentUserId: string = ''\r\n    private currentUserName: string = 'Anonymous'\r\n\r\n    // Callbacks\r\n    private onProjectUpdate: ProjectCallback | null = null\r\n    private onTasksUpdate: TasksCallback | null = null\r\n    private onActivity: ActivityCallback | null = null\r\n\r\n    setUser(userId: string, userName: string) {\r\n        this.currentUserId = userId\r\n        this.currentUserName = userName\r\n    }\r\n\r\n    setCallbacks(\r\n        onProjectUpdate: ProjectCallback,\r\n        onTasksUpdate: TasksCallback,\r\n        onActivity: ActivityCallback\r\n    ) {\r\n        this.onProjectUpdate = onProjectUpdate\r\n        this.onTasksUpdate = onTasksUpdate\r\n        this.onActivity = onActivity\r\n    }\r\n\r\n    // Create project\r\n    createProject(name: string, icon: string, description: string = ''): Project {\r\n        const project: Project = {\r\n            id: crypto.randomUUID(),\r\n            name,\r\n            icon,\r\n            description,\r\n            createdAt: Date.now(),\r\n            updatedAt: Date.now(),\r\n            ownerId: this.currentUserId,\r\n            settings: {\r\n                isPublic: false,\r\n                requirePassword: false,\r\n                allowAnonymous: false,\r\n                editorMode: 'general',\r\n                theme: 'dark'\r\n            },\r\n            members: [{\r\n                id: this.currentUserId,\r\n                name: this.currentUserName,\r\n                role: 'owner',\r\n                color: this.generateColor(),\r\n                joinedAt: Date.now(),\r\n                lastSeenAt: Date.now()\r\n            }]\r\n        }\r\n\r\n        this.projects.set(project.id, project)\r\n\r\n        // Initialize collaborative document\r\n        collabEngine.getDocument(project.id)\r\n\r\n        // Save to storage\r\n        storageService.saveSpace({\r\n            id: project.id,\r\n            name: project.name,\r\n            icon: project.icon,\r\n            createdAt: project.createdAt,\r\n            lastModified: project.updatedAt\r\n        })\r\n\r\n        // Log activity\r\n        this.logActivity(project.id, 'create', 'project', project.id, `Created project \"${name}\"`)\r\n\r\n        return project\r\n    }\r\n\r\n    // Get project\r\n    getProject(projectId: string): Project | undefined {\r\n        return this.projects.get(projectId)\r\n    }\r\n\r\n    // Update project\r\n    updateProject(projectId: string, updates: Partial<Project>): Project | null {\r\n        const project = this.projects.get(projectId)\r\n        if (!project) return null\r\n\r\n        const updated = { ...project, ...updates, updatedAt: Date.now() }\r\n        this.projects.set(projectId, updated)\r\n        this.onProjectUpdate?.(updated)\r\n\r\n        this.logActivity(projectId, 'update', 'project', projectId, `Updated project settings`)\r\n\r\n        return updated\r\n    }\r\n\r\n    // Delete project\r\n    deleteProject(projectId: string): boolean {\r\n        const project = this.projects.get(projectId)\r\n        if (!project) return false\r\n\r\n        this.projects.delete(projectId)\r\n        collabEngine.destroyDocument(projectId)\r\n        storageService.deleteSpace(projectId)\r\n\r\n        return true\r\n    }\r\n\r\n    // Set project password\r\n    async setProjectPassword(projectId: string, password: string): Promise<void> {\r\n        const hash = await encryptionService.hash(password)\r\n        await encryptionService.setRoomKey(projectId, password)\r\n\r\n        this.updateProject(projectId, {\r\n            settings: {\r\n                ...this.projects.get(projectId)!.settings,\r\n                requirePassword: true,\r\n                passwordHash: hash\r\n            }\r\n        })\r\n    }\r\n\r\n    // Verify project password\r\n    async verifyPassword(projectId: string, password: string): Promise<boolean> {\r\n        const project = this.projects.get(projectId)\r\n        if (!project?.settings.passwordHash) return true\r\n\r\n        return encryptionService.verifyHash(password, project.settings.passwordHash)\r\n    }\r\n\r\n    // Add member\r\n    addMember(projectId: string, member: Omit<ProjectMember, 'joinedAt' | 'lastSeenAt'>): boolean {\r\n        const project = this.projects.get(projectId)\r\n        if (!project) return false\r\n\r\n        const newMember: ProjectMember = {\r\n            ...member,\r\n            joinedAt: Date.now(),\r\n            lastSeenAt: Date.now()\r\n        }\r\n\r\n        project.members.push(newMember)\r\n        project.updatedAt = Date.now()\r\n        this.onProjectUpdate?.(project)\r\n\r\n        this.logActivity(projectId, 'join', 'member', member.id, `${member.name} joined the project`)\r\n\r\n        return true\r\n    }\r\n\r\n    // Remove member\r\n    removeMember(projectId: string, memberId: string): boolean {\r\n        const project = this.projects.get(projectId)\r\n        if (!project) return false\r\n\r\n        const member = project.members.find(m => m.id === memberId)\r\n        if (!member) return false\r\n\r\n        project.members = project.members.filter(m => m.id !== memberId)\r\n        project.updatedAt = Date.now()\r\n        this.onProjectUpdate?.(project)\r\n\r\n        this.logActivity(projectId, 'leave', 'member', memberId, `${member.name} left the project`)\r\n\r\n        return true\r\n    }\r\n\r\n    // Get tasks from Yjs\r\n    getTasks(projectId: string): Task[] {\r\n        const doc = collabEngine.getDocument(projectId)\r\n        const tasksArray = doc.getArray<Task>('tasks')\r\n        return tasksArray.toArray()\r\n    }\r\n\r\n    // Create task\r\n    createTask(projectId: string, task: Omit<Task, 'id' | 'createdAt' | 'updatedAt' | 'createdBy' | 'comments'>): Task {\r\n        const doc = collabEngine.getDocument(projectId)\r\n        const tasksArray = doc.getArray<Task>('tasks')\r\n\r\n        const newTask: Task = {\r\n            ...task,\r\n            id: crypto.randomUUID(),\r\n            createdAt: Date.now(),\r\n            updatedAt: Date.now(),\r\n            createdBy: this.currentUserId,\r\n            comments: []\r\n        }\r\n\r\n        tasksArray.push([newTask])\r\n        this.onTasksUpdate?.(tasksArray.toArray())\r\n\r\n        this.logActivity(projectId, 'create', 'task', newTask.id, `Created task \"${task.title}\"`)\r\n\r\n        return newTask\r\n    }\r\n\r\n    // Update task\r\n    updateTask(projectId: string, taskId: string, updates: Partial<Task>): boolean {\r\n        const doc = collabEngine.getDocument(projectId)\r\n        const tasksArray = doc.getArray<Task>('tasks')\r\n\r\n        const index = tasksArray.toArray().findIndex(t => t.id === taskId)\r\n        if (index === -1) return false\r\n\r\n        const task = tasksArray.get(index)\r\n        const updated = { ...task, ...updates, updatedAt: Date.now() }\r\n\r\n        doc.transact(() => {\r\n            tasksArray.delete(index)\r\n            tasksArray.insert(index, [updated])\r\n        })\r\n\r\n        this.onTasksUpdate?.(tasksArray.toArray())\r\n        this.logActivity(projectId, 'update', 'task', taskId, `Updated task \"${updated.title}\"`)\r\n\r\n        return true\r\n    }\r\n\r\n    // Delete task\r\n    deleteTask(projectId: string, taskId: string): boolean {\r\n        const doc = collabEngine.getDocument(projectId)\r\n        const tasksArray = doc.getArray<Task>('tasks')\r\n\r\n        const index = tasksArray.toArray().findIndex(t => t.id === taskId)\r\n        if (index === -1) return false\r\n\r\n        const task = tasksArray.get(index)\r\n        tasksArray.delete(index)\r\n\r\n        this.onTasksUpdate?.(tasksArray.toArray())\r\n        this.logActivity(projectId, 'delete', 'task', taskId, `Deleted task \"${task.title}\"`)\r\n\r\n        return true\r\n    }\r\n\r\n    // Add comment to task\r\n    addTaskComment(projectId: string, taskId: string, content: string): boolean {\r\n        const doc = collabEngine.getDocument(projectId)\r\n        const tasksArray = doc.getArray<Task>('tasks')\r\n\r\n        const index = tasksArray.toArray().findIndex(t => t.id === taskId)\r\n        if (index === -1) return false\r\n\r\n        const task = tasksArray.get(index)\r\n        const comment: Comment = {\r\n            id: crypto.randomUUID(),\r\n            userId: this.currentUserId,\r\n            userName: this.currentUserName,\r\n            content,\r\n            timestamp: Date.now()\r\n        }\r\n\r\n        const updated = {\r\n            ...task,\r\n            comments: [...task.comments, comment],\r\n            updatedAt: Date.now()\r\n        }\r\n\r\n        doc.transact(() => {\r\n            tasksArray.delete(index)\r\n            tasksArray.insert(index, [updated])\r\n        })\r\n\r\n        this.logActivity(projectId, 'comment', 'task', taskId, `Commented on \"${task.title}\"`)\r\n\r\n        return true\r\n    }\r\n\r\n    // Log activity\r\n    private logActivity(\r\n        projectId: string,\r\n        type: Activity['type'],\r\n        target: Activity['target'],\r\n        targetId: string,\r\n        description: string\r\n    ): void {\r\n        const activity: Activity = {\r\n            id: crypto.randomUUID(),\r\n            projectId,\r\n            userId: this.currentUserId,\r\n            userName: this.currentUserName,\r\n            type,\r\n            target,\r\n            targetId,\r\n            description,\r\n            timestamp: Date.now()\r\n        }\r\n\r\n        this.onActivity?.(activity)\r\n    }\r\n\r\n    // Generate random color for user\r\n    private generateColor(): string {\r\n        const colors = [\r\n            '#ef4444', '#f97316', '#eab308', '#22c55e',\r\n            '#06b6d4', '#3b82f6', '#8b5cf6', '#ec4899'\r\n        ]\r\n        return colors[Math.floor(Math.random() * colors.length)]\r\n    }\r\n\r\n    // Get all projects\r\n    getAllProjects(): Project[] {\r\n        return Array.from(this.projects.values())\r\n    }\r\n\r\n    // Export project data\r\n    exportProject(projectId: string): string | null {\r\n        const project = this.projects.get(projectId)\r\n        if (!project) return null\r\n\r\n        const state = collabEngine.exportState(projectId)\r\n        const data = {\r\n            project,\r\n            documentState: state ? Array.from(state) : null,\r\n            exportedAt: Date.now()\r\n        }\r\n\r\n        return JSON.stringify(data, null, 2)\r\n    }\r\n\r\n    // Import project data\r\n    importProject(json: string): Project | null {\r\n        try {\r\n            const data = JSON.parse(json)\r\n            const project = data.project as Project\r\n\r\n            // Generate new ID to avoid conflicts\r\n            project.id = crypto.randomUUID()\r\n            project.createdAt = Date.now()\r\n            project.updatedAt = Date.now()\r\n\r\n            this.projects.set(project.id, project)\r\n\r\n            if (data.documentState) {\r\n                collabEngine.importState(project.id, new Uint8Array(data.documentState))\r\n            }\r\n\r\n            return project\r\n        } catch (e) {\r\n            console.error('Failed to import project:', e)\r\n            return null\r\n        }\r\n    }\r\n}\r\n\r\n// Singleton\r\nexport const projectService = new ProjectService()\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\services\\storageService.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":150,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":150,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[4634,4680],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":162,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":162,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5082,5085],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5082,5085],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":179,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":179,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[5882,5925],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":207,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":207,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6702,6705],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6702,6705],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":216,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":216,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[6969,7011],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":275,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":275,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[8742,8825],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n// SQLite Service - Offline persistence layer for Electron\r\n// Uses better-sqlite3 in main process, IPC bridge for renderer\r\n\r\nexport interface StorageSpace {\r\n    id: string\r\n    name: string\r\n    icon: string\r\n    createdAt: number\r\n    lastModified: number\r\n    ydocData?: Uint8Array // Serialized Y.Doc\r\n}\r\n\r\nexport interface StorageTask {\r\n    id: string\r\n    spaceId: string\r\n    title: string\r\n    status: string\r\n    priority: string\r\n    createdAt: number\r\n    createdBy: string\r\n}\r\n\r\nexport interface StorageMessage {\r\n    id: string\r\n    spaceId: string\r\n    channelId: string\r\n    senderId: string\r\n    senderName: string\r\n    content: string\r\n    timestamp: number\r\n}\r\n\r\nexport interface StorageSettings {\r\n    key: string\r\n    value: string\r\n}\r\n\r\nexport type StorageItem = StorageSpace | StorageTask | StorageMessage | Uint8Array | string\r\n\r\n// In-memory fallback storage (used in renderer when SQLite not available)\r\nclass MemoryStorage {\r\n    private readonly data: Map<string, Map<string, StorageItem>> = new Map()\r\n\r\n    constructor() {\r\n        // Initialize tables\r\n        this.data.set('spaces', new Map())\r\n        this.data.set('tasks', new Map())\r\n        this.data.set('messages', new Map())\r\n        this.data.set('settings', new Map())\r\n        this.data.set('ydocs', new Map())\r\n    }\r\n\r\n    // Spaces\r\n    saveSpace(space: StorageSpace): void {\r\n        this.data.get('spaces')!.set(space.id, space)\r\n        this.persist()\r\n    }\r\n\r\n    getSpace(id: string): StorageSpace | null {\r\n        return (this.data.get('spaces')!.get(id) as StorageSpace) || null\r\n    }\r\n\r\n    getAllSpaces(): StorageSpace[] {\r\n        return Array.from(this.data.get('spaces')!.values()) as StorageSpace[]\r\n    }\r\n\r\n    deleteSpace(id: string): void {\r\n        this.data.get('spaces')!.delete(id)\r\n        // Also delete related data\r\n        this.data.get('tasks')!.forEach((task, taskId) => {\r\n            if ((task as StorageTask).spaceId === id) this.data.get('tasks')!.delete(taskId)\r\n        })\r\n        this.data.get('messages')!.forEach((msg, msgId) => {\r\n            if ((msg as StorageMessage).spaceId === id) this.data.get('messages')!.delete(msgId)\r\n        })\r\n        this.data.get('ydocs')!.delete(id)\r\n        this.persist()\r\n    }\r\n\r\n    // Y.Doc persistence\r\n    saveYDoc(spaceId: string, data: Uint8Array): void {\r\n        this.data.get('ydocs')!.set(spaceId, data)\r\n        this.persist()\r\n    }\r\n\r\n    getYDoc(spaceId: string): Uint8Array | null {\r\n        return (this.data.get('ydocs')!.get(spaceId) as Uint8Array) || null\r\n    }\r\n\r\n    // Tasks\r\n    saveTask(task: StorageTask): void {\r\n        this.data.get('tasks')!.set(task.id, task)\r\n        this.persist()\r\n    }\r\n\r\n    getTasksForSpace(spaceId: string): StorageTask[] {\r\n        return Array.from(this.data.get('tasks')!.values())\r\n            .map(t => t as StorageTask)\r\n            .filter(t => t.spaceId === spaceId)\r\n    }\r\n\r\n    deleteTask(id: string): void {\r\n        this.data.get('tasks')!.delete(id)\r\n        this.persist()\r\n    }\r\n\r\n    // Messages\r\n    saveMessage(message: StorageMessage): void {\r\n        this.data.get('messages')!.set(message.id, message)\r\n        this.persist()\r\n    }\r\n\r\n    getMessagesForChannel(spaceId: string, channelId: string): StorageMessage[] {\r\n        return Array.from(this.data.get('messages')!.values())\r\n            .map(m => m as StorageMessage)\r\n            .filter(m => m.spaceId === spaceId && m.channelId === channelId)\r\n            .sort((a, b) => a.timestamp - b.timestamp)\r\n    }\r\n\r\n    // Settings\r\n    setSetting(key: string, value: string): void {\r\n        this.data.get('settings')!.set(key, value)\r\n        this.persist()\r\n    }\r\n\r\n    getSetting(key: string): string | null {\r\n        return (this.data.get('settings')!.get(key) as string) || null\r\n    }\r\n\r\n    // Persist to localStorage\r\n    private persist(): void {\r\n        try {\r\n            const serializable: Record<string, [string, StorageItem | null][]> = {}\r\n            this.data.forEach((map, table) => {\r\n                if (table === 'ydocs') {\r\n                    // Convert Uint8Array to base64\r\n                    serializable[table] = Array.from(map.entries()).map(([k, v]) => [\r\n                        k,\r\n                        v ? btoa(String.fromCodePoint(...(v as Uint8Array))) : null\r\n                    ])\r\n                } else {\r\n                    serializable[table] = Array.from(map.entries())\r\n                }\r\n            })\r\n            localStorage.setItem('kalynt_db', JSON.stringify(serializable))\r\n        } catch (e) {\r\n            console.error('Failed to persist storage:', e)\r\n        }\r\n    }\r\n\r\n    // Load from localStorage\r\n    load(): void {\r\n        try {\r\n            const raw = localStorage.getItem('kalynt_db')\r\n            if (raw) {\r\n                const parsed = JSON.parse(raw)\r\n                Object.entries(parsed).forEach(([table, entries]) => {\r\n                    const map = new Map<string, StorageItem>()\r\n                        ; (entries as [string, any][]).forEach(([k, v]) => {\r\n                            if (table === 'ydocs' && v) {\r\n                                // Convert base64 back to Uint8Array\r\n                                const binary = atob(v as string)\r\n                                const bytes = new Uint8Array(binary.length)\r\n                                for (let i = 0; i < binary.length; i++) {\r\n                                    bytes[i] = binary.codePointAt(i) || 0\r\n                                }\r\n                                map.set(k, bytes)\r\n                            } else {\r\n                                map.set(k, v)\r\n                            }\r\n                        })\r\n                    this.data.set(table, map)\r\n                })\r\n            }\r\n        } catch (e) {\r\n            console.error('Failed to load storage:', e)\r\n        }\r\n    }\r\n\r\n    // Clear all data\r\n    clear(): void {\r\n        this.data.forEach(map => map.clear())\r\n        localStorage.removeItem('kalynt_db')\r\n    }\r\n\r\n    // Export all data\r\n    export(): string {\r\n        const data: Record<string, StorageItem[]> = {}\r\n        this.data.forEach((map, table) => {\r\n            if (table !== 'ydocs') {\r\n                data[table] = Array.from(map.values())\r\n            }\r\n        })\r\n        return JSON.stringify(data, null, 2)\r\n    }\r\n\r\n    // Import data\r\n    import(json: string): void {\r\n        try {\r\n            const data = JSON.parse(json)\r\n            Object.entries(data).forEach(([table, items]) => {\r\n                const map = this.data.get(table)\r\n                if (map) {\r\n                    (items as any[]).forEach(item => {\r\n                        if (item.id) {\r\n                            map.set(item.id, item)\r\n                        }\r\n                    })\r\n                }\r\n            })\r\n            this.persist()\r\n        } catch (e) {\r\n            console.error('Failed to import data:', e)\r\n        }\r\n    }\r\n}\r\n\r\n// SQLite wrapper for Electron main process\r\n// This would be used via IPC in the actual Electron app\r\nclass SQLiteStorage {\r\n    private readonly isElectron: boolean = false\r\n\r\n    constructor() {\r\n        // Check if running in Electron\r\n        this.isElectron = globalThis.window !== undefined &&\r\n            !!globalThis.window.electronAPI\r\n    }\r\n\r\n    async init(dbPath: string): Promise<void> {\r\n        if (this.isElectron) {\r\n            // Would call Electron main process to init SQLite\r\n            await globalThis.window.electronAPI?.initDB?.(dbPath)\r\n        }\r\n    }\r\n\r\n    // These methods would delegate to IPC calls in real Electron app\r\n    async query(sql: string, params: unknown[] = []): Promise<unknown[]> {\r\n        if (this.isElectron) {\r\n            return globalThis.window.electronAPI?.dbQuery?.(sql, params) || []\r\n        }\r\n        return []\r\n    }\r\n\r\n    async run(sql: string, params: unknown[] = []): Promise<void> {\r\n        if (this.isElectron) {\r\n            await globalThis.window.electronAPI?.dbRun?.(sql, params)\r\n        }\r\n    }\r\n}\r\n\r\n// Storage service that uses SQLite in Electron, memory in browser\r\nclass StorageService {\r\n    private readonly memory: MemoryStorage\r\n    private readonly sqlite: SQLiteStorage\r\n    private initialized: boolean = false\r\n\r\n    constructor() {\r\n        this.memory = new MemoryStorage()\r\n        this.sqlite = new SQLiteStorage()\r\n    }\r\n\r\n    async init(): Promise<void> {\r\n        if (this.initialized) return\r\n\r\n        // Load from localStorage\r\n        this.memory.load()\r\n\r\n        // Try to init SQLite if in Electron\r\n        try {\r\n            await this.sqlite.init('kalynt.db')\r\n        } catch (e) {\r\n            console.error('[Storage] SQLite initialization failed, falling back to memory:', e)\r\n        }\r\n\r\n        this.initialized = true\r\n    }\r\n\r\n    // Spaces\r\n    saveSpace(space: StorageSpace): void {\r\n        this.memory.saveSpace(space)\r\n    }\r\n\r\n    getSpace(id: string): StorageSpace | null {\r\n        return this.memory.getSpace(id)\r\n    }\r\n\r\n    getAllSpaces(): StorageSpace[] {\r\n        return this.memory.getAllSpaces()\r\n    }\r\n\r\n    deleteSpace(id: string): void {\r\n        this.memory.deleteSpace(id)\r\n    }\r\n\r\n    // Y.Doc\r\n    saveYDoc(spaceId: string, data: Uint8Array): void {\r\n        this.memory.saveYDoc(spaceId, data)\r\n    }\r\n\r\n    getYDoc(spaceId: string): Uint8Array | null {\r\n        return this.memory.getYDoc(spaceId)\r\n    }\r\n\r\n    // Tasks\r\n    saveTask(task: StorageTask): void {\r\n        this.memory.saveTask(task)\r\n    }\r\n\r\n    getTasksForSpace(spaceId: string): StorageTask[] {\r\n        return this.memory.getTasksForSpace(spaceId)\r\n    }\r\n\r\n    deleteTask(id: string): void {\r\n        this.memory.deleteTask(id)\r\n    }\r\n\r\n    // Messages\r\n    saveMessage(message: StorageMessage): void {\r\n        this.memory.saveMessage(message)\r\n    }\r\n\r\n    getMessagesForChannel(spaceId: string, channelId: string): StorageMessage[] {\r\n        return this.memory.getMessagesForChannel(spaceId, channelId)\r\n    }\r\n\r\n    // Settings\r\n    setSetting(key: string, value: string): void {\r\n        this.memory.setSetting(key, value)\r\n    }\r\n\r\n    getSetting(key: string): string | null {\r\n        return this.memory.getSetting(key)\r\n    }\r\n\r\n    // Utility\r\n    clear(): void {\r\n        this.memory.clear()\r\n    }\r\n\r\n    export(): string {\r\n        return this.memory.export()\r\n    }\r\n\r\n    import(json: string): void {\r\n        this.memory.import(json)\r\n    }\r\n}\r\n\r\n// Singleton\r\nexport const storageService = new StorageService()\r\n\r\n// Initialize on load\r\nstorageService.init()\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\services\\versionControlService.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":267,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":267,"endColumn":25,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[8742,8815],"text":""},"desc":"Remove the console.warn()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n// Version Control Service - Document history and conflict resolution\r\nimport * as Y from 'yjs'\r\nimport { collabEngine } from './collabEngine'\r\n\r\nexport interface Version {\r\n    id: string\r\n    docId: string\r\n    number: number\r\n    label: string\r\n    description: string\r\n    author: string\r\n    authorName: string\r\n    timestamp: number\r\n    state: Uint8Array\r\n    parentId?: string\r\n    isBranch: boolean\r\n    branchName?: string\r\n}\r\n\r\nexport interface Diff {\r\n    type: 'insert' | 'delete' | 'retain'\r\n    position: number\r\n    content?: string\r\n    length?: number\r\n}\r\n\r\nexport interface Conflict {\r\n    id: string\r\n    docId: string\r\n    type: 'concurrent-edit' | 'merge-conflict' | 'diverged'\r\n    description: string\r\n    localState: Uint8Array\r\n    remoteState: Uint8Array\r\n    resolvedState?: Uint8Array\r\n    status: 'pending' | 'resolved' | 'dismissed'\r\n    timestamp: number\r\n}\r\n\r\nexport interface MergeResult {\r\n    success: boolean\r\n    conflicts: Conflict[]\r\n    mergedState?: Uint8Array\r\n}\r\n\r\nclass VersionControlService {\r\n    private readonly versions: Map<string, Version[]> = new Map()\r\n    private readonly branches: Map<string, Map<string, string | undefined>> = new Map() // docId -> branchName -> headVersionId\r\n    private readonly conflicts: Map<string, Conflict[]> = new Map()\r\n    private readonly currentBranch: Map<string, string> = new Map() // docId -> branchName\r\n\r\n    // Create a new version (commit)\r\n    createVersion(\r\n        docId: string,\r\n        label: string,\r\n        description: string,\r\n        author: string,\r\n        authorName: string\r\n    ): Version {\r\n        const doc = collabEngine.getDocument(docId)\r\n        if (!doc) throw new Error('Document not found')\r\n\r\n        const versions = this.versions.get(docId) || []\r\n        const branchName = this.currentBranch.get(docId) || 'main'\r\n\r\n        // Get parent version\r\n        const branchHeads = this.branches.get(docId) || new Map()\r\n        const parentId = branchHeads.get(branchName)\r\n\r\n        const version: Version = {\r\n            id: crypto.randomUUID(),\r\n            docId,\r\n            number: versions.filter(v => v.branchName === branchName).length + 1,\r\n            label,\r\n            description,\r\n            author,\r\n            authorName,\r\n            timestamp: Date.now(),\r\n            state: Y.encodeStateAsUpdate(doc),\r\n            parentId,\r\n            isBranch: false,\r\n            branchName\r\n        }\r\n\r\n        versions.push(version)\r\n        this.versions.set(docId, versions)\r\n\r\n        // Update branch head\r\n        branchHeads.set(branchName, version.id)\r\n        this.branches.set(docId, branchHeads)\r\n\r\n        return version\r\n    }\r\n\r\n    // Get all versions for a document\r\n    getVersions(docId: string): Version[] {\r\n        return this.versions.get(docId) || []\r\n    }\r\n\r\n    // Get version by ID\r\n    getVersion(docId: string, versionId: string): Version | undefined {\r\n        return this.versions.get(docId)?.find(v => v.id === versionId)\r\n    }\r\n\r\n    // Get latest version\r\n    getLatestVersion(docId: string, branchName: string = 'main'): Version | undefined {\r\n        const versions = this.versions.get(docId) || []\r\n        return versions\r\n            .filter(v => v.branchName === branchName)\r\n            .sort((a, b) => b.timestamp - a.timestamp)[0]\r\n    }\r\n\r\n    // Restore to a specific version\r\n    restoreVersion(docId: string, versionId: string): boolean {\r\n        const version = this.getVersion(docId, versionId)\r\n        if (!version) return false\r\n\r\n        const doc = collabEngine.getDocument(docId)\r\n        if (!doc) return false\r\n\r\n        // Apply the version state (restores editor content only)\r\n        Y.applyUpdate(doc, version.state)\r\n        return true\r\n    }\r\n\r\n    // Create a branch\r\n    createBranch(docId: string, branchName: string, fromVersionId?: string): boolean {\r\n        const branchHeads = this.branches.get(docId) || new Map<string, string | undefined>()\r\n\r\n        if (branchHeads.has(branchName)) {\r\n            return false // Branch already exists\r\n        }\r\n\r\n        const sourceBranch = this.currentBranch.get(docId) || 'main'\r\n        const sourceVersionId = fromVersionId || branchHeads.get(sourceBranch)\r\n\r\n        // Initialize branch with source version ID, or undefined if no versions exist\r\n        branchHeads.set(branchName, sourceVersionId)\r\n\r\n        // Ensure current branch map is initialized\r\n        if (!this.currentBranch.has(docId)) {\r\n            this.currentBranch.set(docId, 'main')\r\n        }\r\n\r\n        this.branches.set(docId, branchHeads)\r\n        return true\r\n    }\r\n\r\n    // Delete a version\r\n    deleteVersion(docId: string, versionId: string): boolean {\r\n        const versions = this.versions.get(docId)\r\n        if (!versions) return false\r\n\r\n        const index = versions.findIndex(v => v.id === versionId)\r\n        if (index === -1) return false\r\n\r\n        versions.splice(index, 1)\r\n        this.versions.set(docId, versions)\r\n\r\n        // Update branch heads if this version was a head\r\n        const branchHeads = this.branches.get(docId)\r\n        if (branchHeads) {\r\n            for (const [branch, headId] of branchHeads.entries()) {\r\n                if (headId === versionId) {\r\n                    // Find new head (most recent version in that branch)\r\n                    const newHead = this.getLatestVersion(docId, branch)\r\n                    if (newHead) {\r\n                        branchHeads.set(branch, newHead.id)\r\n                    } else {\r\n                        branchHeads.delete(branch)\r\n                        // If it's main, we might want to keep it empty\r\n                        if (branch === 'main') {\r\n                            branchHeads.set('main', undefined)\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return true\r\n    }\r\n\r\n    // Switch branch\r\n    switchBranch(docId: string, branchName: string): boolean {\r\n        const branchHeads = this.branches.get(docId)\r\n        if (!branchHeads?.has(branchName)) return false\r\n\r\n        this.currentBranch.set(docId, branchName)\r\n\r\n        // Restore to branch head\r\n        const headVersionId = branchHeads.get(branchName)\r\n        if (headVersionId) {\r\n            this.restoreVersion(docId, headVersionId)\r\n        }\r\n\r\n        return true\r\n    }\r\n\r\n    // Get branches\r\n    getBranches(docId: string): string[] {\r\n        const branchHeads = this.branches.get(docId)\r\n        if (!branchHeads) return ['main']\r\n        return Array.from(branchHeads.keys())\r\n    }\r\n\r\n    // Get current branch\r\n    getCurrentBranch(docId: string): string {\r\n        return this.currentBranch.get(docId) || 'main'\r\n    }\r\n\r\n    // Merge branches\r\n    mergeBranches(docId: string, sourceBranch: string, targetBranch: string): MergeResult {\r\n        const branchHeads = this.branches.get(docId)\r\n        if (!branchHeads) {\r\n            return { success: false, conflicts: [] }\r\n        }\r\n\r\n        const sourceHeadId = branchHeads.get(sourceBranch)\r\n        const targetHeadId = branchHeads.get(targetBranch)\r\n\r\n        if (!sourceHeadId || !targetHeadId) {\r\n            return { success: false, conflicts: [] }\r\n        }\r\n\r\n        const sourceVersion = this.getVersion(docId, sourceHeadId)\r\n        const targetVersion = this.getVersion(docId, targetHeadId)\r\n\r\n        if (!sourceVersion || !targetVersion) {\r\n            return { success: false, conflicts: [] }\r\n        }\r\n\r\n        return this.applyMerge(docId, sourceVersion, targetVersion, sourceBranch, targetBranch)\r\n    }\r\n\r\n    private applyMerge(docId: string, sourceVersion: Version, targetVersion: Version, sourceBranch: string, targetBranch: string): MergeResult {\r\n        // Create a new document for merging\r\n        const mergeDoc = new Y.Doc()\r\n\r\n        // Apply target state first\r\n        Y.applyUpdate(mergeDoc, targetVersion.state)\r\n\r\n        // Try to apply source state (Yjs handles CRDT merge automatically)\r\n        try {\r\n            Y.applyUpdate(mergeDoc, sourceVersion.state)\r\n\r\n            const mergedState = Y.encodeStateAsUpdate(mergeDoc)\r\n\r\n            // Update the document\r\n            const doc = collabEngine.getDocument(docId)\r\n            if (doc) {\r\n                Y.applyUpdate(doc, mergedState)\r\n            }\r\n\r\n            // Create merge version\r\n            this.createVersion(\r\n                docId,\r\n                `Merge ${sourceBranch} into ${targetBranch}`,\r\n                `Merged branch ${sourceBranch} into ${targetBranch}`,\r\n                'system',\r\n                'System'\r\n            )\r\n\r\n            return { success: true, conflicts: [], mergedState }\r\n        } catch (e) {\r\n            console.warn('[VersionControl] Auto-merge failed, creating conflict:', e)\r\n            // If merge fails, create conflict\r\n            const conflict: Conflict = {\r\n                id: crypto.randomUUID(),\r\n                docId,\r\n                type: 'merge-conflict',\r\n                description: `Conflict merging ${sourceBranch} into ${targetBranch}`,\r\n                localState: targetVersion.state,\r\n                remoteState: sourceVersion.state,\r\n                status: 'pending',\r\n                timestamp: Date.now()\r\n            }\r\n\r\n            const conflicts = this.conflicts.get(docId) || []\r\n            conflicts.push(conflict)\r\n            this.conflicts.set(docId, conflicts)\r\n\r\n            return { success: false, conflicts: [conflict] }\r\n        }\r\n    }\r\n\r\n    // Get conflicts\r\n    getConflicts(docId: string): Conflict[] {\r\n        return this.conflicts.get(docId)?.filter(c => c.status === 'pending') || []\r\n    }\r\n\r\n    // Resolve conflict\r\n    resolveConflict(docId: string, conflictId: string, resolution: 'local' | 'remote' | 'manual', manualState?: Uint8Array): boolean {\r\n        const conflicts = this.conflicts.get(docId) || []\r\n        const conflict = conflicts.find(c => c.id === conflictId)\r\n\r\n        if (!conflict) return false\r\n\r\n        const doc = collabEngine.getDocument(docId)\r\n        if (!doc) return false\r\n\r\n        let resolvedState: Uint8Array\r\n\r\n        switch (resolution) {\r\n            case 'local':\r\n                resolvedState = conflict.localState\r\n                break\r\n            case 'remote':\r\n                resolvedState = conflict.remoteState\r\n                break\r\n            case 'manual':\r\n                if (!manualState) return false\r\n                resolvedState = manualState\r\n                break\r\n        }\r\n\r\n        // Apply resolved state\r\n        Y.applyUpdate(doc, resolvedState)\r\n\r\n        conflict.resolvedState = resolvedState\r\n        conflict.status = 'resolved'\r\n\r\n        return true\r\n    }\r\n\r\n    // Dismiss conflict\r\n    dismissConflict(docId: string, conflictId: string): boolean {\r\n        const conflicts = this.conflicts.get(docId) || []\r\n        const conflict = conflicts.find(c => c.id === conflictId)\r\n\r\n        if (!conflict) return false\r\n\r\n        conflict.status = 'dismissed'\r\n        return true\r\n    }\r\n\r\n    // Compare two versions\r\n    compareVersions(docId: string, versionAId: string, versionBId: string): {\r\n        aContent: string\r\n        bContent: string\r\n        additions: number\r\n        deletions: number\r\n    } | null {\r\n        const versionA = this.getVersion(docId, versionAId)\r\n        const versionB = this.getVersion(docId, versionBId)\r\n\r\n        if (!versionA || !versionB) return null\r\n\r\n        // Create temp docs to extract content\r\n        const docA = new Y.Doc()\r\n        const docB = new Y.Doc()\r\n\r\n        Y.applyUpdate(docA, versionA.state)\r\n        Y.applyUpdate(docB, versionB.state)\r\n\r\n        const aContent = docA.getText('editor-content').toJSON()\r\n        const bContent = docB.getText('editor-content').toJSON()\r\n\r\n        // Simple diff counts\r\n        const additions = Math.max(0, bContent.length - aContent.length)\r\n        const deletions = Math.max(0, aContent.length - bContent.length)\r\n\r\n        docA.destroy()\r\n        docB.destroy()\r\n\r\n        return { aContent, bContent, additions, deletions }\r\n    }\r\n\r\n    // Get version history for timeline\r\n    getTimeline(docId: string): Array<{\r\n        id: string\r\n        label: string\r\n        description: string\r\n        author: string\r\n        timestamp: number\r\n        branch: string\r\n    }> {\r\n        const versions = this.versions.get(docId) || []\r\n        return [...versions]\r\n            .sort((a, b) => b.timestamp - a.timestamp)\r\n            .map(v => ({\r\n                id: v.id,\r\n                label: v.label,\r\n                description: v.description,\r\n                author: v.authorName,\r\n                timestamp: v.timestamp,\r\n                branch: v.branchName || 'main'\r\n            }))\r\n    }\r\n\r\n    // Auto-save as version (debounced)\r\n    private readonly autoSaveTimers: Map<string, ReturnType<typeof setTimeout>> = new Map()\r\n\r\n    scheduleAutoSave(docId: string, author: string, authorName: string, delay: number = 30000): void {\r\n        // Clear existing timer\r\n        const existing = this.autoSaveTimers.get(docId)\r\n        if (existing) clearTimeout(existing)\r\n\r\n        // Set new timer\r\n        const timer = setTimeout(() => {\r\n            this.createVersion(docId, 'Auto-save', 'Automatic save', author, authorName)\r\n            this.autoSaveTimers.delete(docId)\r\n        }, delay)\r\n\r\n        this.autoSaveTimers.set(docId, timer)\r\n    }\r\n\r\n    cancelAutoSave(docId: string): void {\r\n        const timer = this.autoSaveTimers.get(docId)\r\n        if (timer) {\r\n            clearTimeout(timer)\r\n            this.autoSaveTimers.delete(docId)\r\n        }\r\n    }\r\n}\r\n\r\n// Singleton\r\nexport const versionControlService = new VersionControlService()\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\stores\\appStore.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":267,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":267,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[9773,9820],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":270,"column":25,"nodeType":"MemberExpression","messageId":"unexpected","endLine":270,"endColumn":38,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[9924,9975],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":272,"column":25,"nodeType":"MemberExpression","messageId":"unexpected","endLine":272,"endColumn":36,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[10031,10089],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":273,"column":25,"nodeType":"MemberExpression","messageId":"unexpected","endLine":273,"endColumn":36,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[10115,10183],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":274,"column":25,"nodeType":"MemberExpression","messageId":"unexpected","endLine":274,"endColumn":36,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[10209,10286],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":275,"column":25,"nodeType":"MemberExpression","messageId":"unexpected","endLine":275,"endColumn":36,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[10312,10377],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":294,"column":1,"nodeType":"MemberExpression","messageId":"unexpected","endLine":294,"endColumn":12,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[11022,11124],"text":""},"desc":"Remove the console.log()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\nimport { create } from 'zustand'\r\nimport { persist, createJSONStorage } from 'zustand/middleware'\r\nimport { WorkspaceCategoryId } from '../types/workspaceCategories'\r\nimport { logger } from '../utils/logger'\r\n\r\nexport interface AIProvider {\r\n    id: string\r\n    name: string\r\n    models: string[]\r\n    keyPlaceholder: string\r\n}\r\n\r\n// AI Providers - All available in free beta\r\nexport const AI_PROVIDERS: Record<string, AIProvider> = {\r\n    openai: {\r\n        id: 'openai',\r\n        name: 'OpenAI',\r\n        models: ['GPT-4o mini', 'GPT-4o', 'GPT-4 Turbo', 'DALL-E 3', 'Whisper'],\r\n        keyPlaceholder: 'sk-...'\r\n    },\r\n    anthropic: {\r\n        id: 'anthropic',\r\n        name: 'Anthropic',\r\n        models: ['Claude 4.5 Haiku', 'Claude 4.5 Sonnet', 'Claude 4.5 Opus'],\r\n        keyPlaceholder: 'sk-ant-...'\r\n    },\r\n    google: {\r\n        id: 'google',\r\n        name: 'Google AI',\r\n        models: ['Gemini 3 Flash', 'Gemini 3 Pro'],\r\n        keyPlaceholder: 'AIza...'\r\n    }\r\n}\r\n\r\n// Free beta configuration - no limits\r\nexport const BETA_CONFIG = {\r\n    maxWorkspaces: Infinity,\r\n    maxCollaborators: 100,\r\n    offlineModelsAllowed: Infinity\r\n}\r\n\r\n// Tier types for model gating (legacy - all models now free in beta)\r\nexport type TierType = 'starter' | 'pro' | 'enterprise' | 'beta'\r\n\r\nexport interface Space {\r\n    id: string\r\n    name: string\r\n    createdAt: number\r\n    category: WorkspaceCategoryId\r\n}\r\n\r\nexport interface APIKeys {\r\n    openai?: string\r\n    anthropic?: string\r\n    google?: string\r\n}\r\n\r\nexport interface Peer {\r\n    id: string\r\n    name: string\r\n    status: 'online' | 'away' | 'offline'\r\n}\r\n\r\ninterface AppState {\r\n    isInitialized: boolean\r\n    version: string\r\n    spaces: Space[]\r\n    currentSpace: Space | null\r\n    apiKeys: APIKeys\r\n    userName: string\r\n    connectedPeers: Peer[]\r\n    sidebarCollapsed: boolean\r\n    _hasHydrated: boolean\r\n    startupStatus: string // [NEW] Real-time status for splash screen\r\n\r\n    // Actions\r\n    initialize: () => Promise<void>\r\n    setCurrentSpace: (space: Space | null) => void\r\n    createSpace: (name: string, spaceId?: string, category?: WorkspaceCategoryId) => Space\r\n    deleteSpace: (id: string) => void\r\n    setConnectedPeers: (peers: Peer[]) => void\r\n    toggleSidebarCollapsed: () => void\r\n    setStartupStatus: (status: string) => void // [NEW]\r\n\r\n    // API Key actions (now async for safeStorage)\r\n    setAPIKey: (provider: string, key: string) => Promise<void>\r\n    removeAPIKey: (provider: string) => Promise<void>\r\n    getAPIKey: (provider: string) => string | undefined\r\n    loadAPIKeys: () => Promise<void>\r\n    hasRequiredKeys: () => boolean\r\n    setUserName: (name: string) => void\r\n\r\n    // Provider access check (always returns true in beta)\r\n    canUseProvider: (provider: string) => boolean\r\n\r\n    // Subscription status (free beta - always active)\r\n    getSubscriptionStatus: () => { isActive: boolean; tier: string }\r\n}\r\n\r\nexport const useAppStore = create<AppState>()(\r\n    persist(\r\n        (set, get) => ({\r\n            isInitialized: false,\r\n            version: 'v1.0 beta',\r\n            spaces: [],\r\n            currentSpace: null,\r\n            apiKeys: {},\r\n            userName: 'Local User',\r\n            connectedPeers: [],\r\n            sidebarCollapsed: false,\r\n            _hasHydrated: false,\r\n            startupStatus: 'Initializing Agent Core...', // Default start message\r\n\r\n            setStartupStatus: (status) => set({ startupStatus: status }),\r\n\r\n            initialize: async () => {\r\n                set({ startupStatus: 'Connecting to Secure Local Interface...' })\r\n\r\n                // Get version from Electron if available\r\n                if (globalThis.electronAPI) {\r\n                    try {\r\n                        set({ startupStatus: 'Verifying Environment Integrity...' })\r\n                        const version = await globalThis.electronAPI.getVersion()\r\n                        set({ version })\r\n                    } catch (error) {\r\n                        logger.general.warn('Failed to get app version from Electron', error)\r\n                    }\r\n\r\n                    // Load API keys from secure storage\r\n                    set({ startupStatus: 'Decryption Secure Storage...' })\r\n                    await get().loadAPIKeys()\r\n                }\r\n\r\n                set({ startupStatus: 'Starting Kalynt Environment...' })\r\n                // Artificial delay to let the user see the animation and read the status\r\n                await new Promise(resolve => setTimeout(resolve, 2000));\r\n\r\n                set({ isInitialized: true, startupStatus: 'Ready' })\r\n            },\r\n\r\n            setCurrentSpace: (space) => set({ currentSpace: space }),\r\n\r\n            createSpace: (name, spaceId, category = 'programming') => {\r\n                const { spaces, connectedPeers } = get()\r\n\r\n                // Free beta - check collaborator limit only\r\n                if (connectedPeers.length >= BETA_CONFIG.maxCollaborators) {\r\n                    throw new Error(`Maximum ${BETA_CONFIG.maxCollaborators} collaborators per workspace.`)\r\n                }\r\n\r\n                // Check if space with this ID already exists (for joining)\r\n                const existing = spaces.find(s => s.id === spaceId)\r\n                if (existing) {\r\n                    return existing\r\n                }\r\n\r\n                const newSpace: Space = {\r\n                    id: spaceId || (typeof crypto !== 'undefined' && crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).substring(2)),\r\n                    name,\r\n                    createdAt: Date.now(),\r\n                    category\r\n                }\r\n\r\n                set({ spaces: [...spaces, newSpace] })\r\n                return newSpace\r\n            },\r\n\r\n            deleteSpace: (id) => {\r\n                const { spaces, currentSpace } = get()\r\n                set({\r\n                    spaces: spaces.filter(s => s.id !== id),\r\n                    currentSpace: currentSpace?.id === id ? null : currentSpace\r\n                })\r\n            },\r\n\r\n            setConnectedPeers: (peers) => set({ connectedPeers: peers }),\r\n\r\n            toggleSidebarCollapsed: () => set((state) => ({ sidebarCollapsed: !state.sidebarCollapsed })),\r\n\r\n            // API Key management - now uses secure storage\r\n            setAPIKey: async (provider, key) => {\r\n                // Store in secure storage\r\n                if (globalThis.electronAPI?.safeStorage) {\r\n                    await globalThis.electronAPI.safeStorage.set({\r\n                        key: `apiKey_${provider}`,\r\n                        value: key\r\n                    })\r\n                }\r\n                // Also update in-memory state for immediate access\r\n                const { apiKeys } = get()\r\n                set({ apiKeys: { ...apiKeys, [provider]: key } })\r\n            },\r\n\r\n            removeAPIKey: async (provider) => {\r\n                // Remove from secure storage\r\n                if (globalThis.electronAPI?.safeStorage) {\r\n                    await globalThis.electronAPI.safeStorage.delete(`apiKey_${provider}`)\r\n                }\r\n                // Update in-memory state\r\n                const { apiKeys } = get()\r\n                const newKeys = { ...apiKeys }\r\n                delete newKeys[provider as keyof APIKeys]\r\n                set({ apiKeys: newKeys })\r\n            },\r\n\r\n            getAPIKey: (provider) => {\r\n                return get().apiKeys[provider as keyof APIKeys]\r\n            },\r\n\r\n            loadAPIKeys: async () => {\r\n                if (!globalThis.electronAPI?.safeStorage) return\r\n\r\n                const providers = ['openai', 'anthropic', 'google']\r\n                const loadedKeys: APIKeys = {}\r\n\r\n                for (const provider of providers) {\r\n                    try {\r\n                        const result = await globalThis.electronAPI.safeStorage.get(`apiKey_${provider}`)\r\n                        if (result.success && result.value) {\r\n                            loadedKeys[provider as keyof APIKeys] = result.value\r\n                        }\r\n                    } catch (error) {\r\n                        logger.general.warn(`Failed to load API key for ${provider}`, error)\r\n                    }\r\n                }\r\n\r\n                set({ apiKeys: loadedKeys })\r\n            },\r\n\r\n            hasRequiredKeys: () => {\r\n                const { apiKeys } = get()\r\n                // Check if at least one provider has a key\r\n                return Object.keys(apiKeys).some(k => apiKeys[k as keyof APIKeys])\r\n            },\r\n\r\n            setUserName: (name) => {\r\n                set({ userName: name })\r\n                // Sync to memberStore for P2P display name\r\n                import('../stores/memberStore').then(({ useMemberStore }) => {\r\n                    useMemberStore.getState().setDisplayName(name)\r\n                })\r\n            },\r\n\r\n            // Provider access check - always returns true in beta\r\n            canUseProvider: (_provider: string) => true,\r\n\r\n            // Free beta - always active with unlimited access\r\n            getSubscriptionStatus: () => ({\r\n                isActive: true,\r\n                tier: 'beta'\r\n            })\r\n        }),\r\n        {\r\n            name: 'kalynt-app',\r\n            storage: createJSONStorage(() => localStorage),\r\n            partialize: (state) => ({\r\n                spaces: state.spaces,\r\n                currentSpace: state.currentSpace,\r\n                // Note: apiKeys are now stored in safeStorage, not localStorage\r\n                userName: state.userName,\r\n                sidebarCollapsed: state.sidebarCollapsed\r\n            }),\r\n            onRehydrateStorage: () => {\r\n                console.log('[AppStore] Starting hydration...')\r\n                return (state, error) => {\r\n                    if (error) {\r\n                        console.error('[AppStore] Hydration error:', error)\r\n                    } else {\r\n                        console.log('[AppStore] Hydration completed successfully')\r\n                        console.log('[AppStore] Loaded spaces:', state?.spaces?.length || 0)\r\n                        console.log('[AppStore] Current space:', state?.currentSpace?.name || 'None')\r\n                        console.log('[AppStore] Username:', state?.userName || 'Not set')\r\n\r\n                        // Sync userName to memberStore for P2P display name\r\n                        if (state?.userName && state.userName !== 'Local User') {\r\n                            import('../stores/memberStore').then(({ useMemberStore }) => {\r\n                                useMemberStore.getState().setDisplayName(state.userName)\r\n                            })\r\n                        }\r\n                    }\r\n                    if (state) {\r\n                        state._hasHydrated = true\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    )\r\n)\r\n\r\n// Log immediately after store creation to verify\r\nconsole.log('[AppStore] Store created, initial hydration state:', useAppStore.getState()._hasHydrated)\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\stores\\memberStore.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":154,"column":25,"nodeType":"MemberExpression","messageId":"unexpected","endLine":154,"endColumn":37,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[5712,5768],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":160,"column":25,"nodeType":"MemberExpression","messageId":"unexpected","endLine":160,"endColumn":37,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[5982,6047],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":207,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":207,"endColumn":34,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[7698,7744],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":276,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":276,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[10323,10374],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":311,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":311,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[11690,11749],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":342,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":342,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[12832,12885],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":441,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":441,"endColumn":32,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[16862,16960],"text":""},"desc":"Remove the console.log()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n// Member Store - Workspace member management with roles and permissions\r\nimport { create } from 'zustand'\r\nimport { persist } from 'zustand/middleware'\r\nimport {\r\n    WorkspaceRole,\r\n    WorkspaceMember,\r\n    MemberPermissions,\r\n    DEFAULT_PERMISSIONS,\r\n    canManageRole,\r\n    canKick,\r\n    canBan,\r\n    ModerationAction\r\n} from '../types/permissions'\r\n\r\n// Storage limits to prevent localStorage overflow\r\nconst MAX_SPACES_PERSISTED = 20\r\nconst MAX_MEMBERS_PER_SPACE = 100\r\n\r\n// Generate a stable user ID for this device\r\nfunction getOrCreateUserId(): string {\r\n    const stored = localStorage.getItem('kalynt-user-id')\r\n    if (stored) return stored\r\n\r\n    const newId = crypto.randomUUID()\r\n    localStorage.setItem('kalynt-user-id', newId)\r\n    return newId\r\n}\r\n\r\n// Get display name\r\nfunction getDisplayName(): string {\r\n    return localStorage.getItem('kalynt-display-name') || 'Anonymous User'\r\n}\r\n\r\nexport interface SpaceMemberInfo {\r\n    ownerId: string               // User who created the space\r\n    members: WorkspaceMember[]    // All members\r\n    bannedUsers: string[]         // Banned user IDs\r\n    pendingActions: ModerationAction[]  // Actions to broadcast\r\n}\r\n\r\nexport interface MemberState {\r\n    userId: string                          // Current user's ID\r\n    displayName: string                     // Current user's display name\r\n    spaceMembers: Record<string, SpaceMemberInfo>  // spaceId -> members\r\n\r\n    // Actions\r\n    setDisplayName: (name: string) => void\r\n    initializeSpace: (spaceId: string) => void\r\n    setSpaceOwner: (spaceId: string, ownerId: string) => void\r\n\r\n    // Member management\r\n    addMember: (spaceId: string, member: WorkspaceMember) => void\r\n    removeMember: (spaceId: string, userId: string) => void\r\n    updateMemberRole: (spaceId: string, userId: string, role: WorkspaceRole) => void\r\n    updateMemberPermissions: (spaceId: string, userId: string, permissions: Partial<MemberPermissions>) => void\r\n\r\n    // Moderation\r\n    kickMember: (spaceId: string, targetUserId: string, reason?: string) => boolean\r\n    banMember: (spaceId: string, targetUserId: string, reason?: string) => boolean\r\n    unbanMember: (spaceId: string, targetUserId: string) => boolean\r\n    isUserBanned: (spaceId: string, userId: string) => boolean\r\n\r\n    // Getters\r\n    getMyRole: (spaceId: string) => WorkspaceRole\r\n    getMember: (spaceId: string, userId: string) => WorkspaceMember | undefined\r\n    getMembers: (spaceId: string) => WorkspaceMember[]\r\n    canIManage: (spaceId: string, targetUserId: string) => boolean\r\n    getMyPermissions: (spaceId: string) => MemberPermissions\r\n\r\n    // Action queue\r\n    popPendingAction: (spaceId: string) => ModerationAction | undefined\r\n}\r\n\r\nexport const useMemberStore = create<MemberState>()(\r\n    persist(\r\n        (set, get) => ({\r\n            userId: getOrCreateUserId(),\r\n            displayName: getDisplayName(),\r\n            spaceMembers: {},\r\n\r\n            setDisplayName: (name) => {\r\n                localStorage.setItem('kalynt-display-name', name)\r\n                const { spaceMembers, userId } = get()\r\n\r\n                // Update display name in all existing memberships\r\n                const updatedSpaces: Record<string, SpaceMemberInfo> = {}\r\n                Object.entries(spaceMembers).forEach(([spaceId, info]) => {\r\n                    updatedSpaces[spaceId] = {\r\n                        ...info,\r\n                        members: info.members.map(m =>\r\n                            m.userId === userId\r\n                                ? { ...m, displayName: name }\r\n                                : m\r\n                        )\r\n                    }\r\n                })\r\n\r\n                set({ displayName: name, spaceMembers: updatedSpaces })\r\n            },\r\n\r\n            initializeSpace: (spaceId) => {\r\n                const { spaceMembers, userId, displayName } = get()\r\n\r\n                if (!spaceMembers[spaceId]) {\r\n                    // Create new space membership - creator is owner\r\n                    const ownerMember: WorkspaceMember = {\r\n                        userId: userId,\r\n                        displayName,\r\n                        role: 'owner',\r\n                        permissions: { ...DEFAULT_PERMISSIONS.owner },\r\n                        joinedAt: Date.now(),\r\n                        isOnline: true,\r\n                        isBanned: false\r\n                    }\r\n\r\n                    set({\r\n                        spaceMembers: {\r\n                            ...spaceMembers,\r\n                            [spaceId]: {\r\n                                ownerId: userId,\r\n                                members: [ownerMember],\r\n                                bannedUsers: [],\r\n                                pendingActions: []\r\n                            }\r\n                        }\r\n                    })\r\n                }\r\n            },\r\n\r\n            setSpaceOwner: (spaceId, ownerId) => {\r\n                const { spaceMembers } = get()\r\n                const space = spaceMembers[spaceId]\r\n\r\n                if (space) {\r\n                    set({\r\n                        spaceMembers: {\r\n                            ...spaceMembers,\r\n                            [spaceId]: { ...space, ownerId }\r\n                        }\r\n                    })\r\n                }\r\n            },\r\n\r\n            addMember: (spaceId, member) => {\r\n                const { spaceMembers } = get()\r\n                const space = spaceMembers[spaceId]\r\n\r\n                if (space) {\r\n                    // Don't add if banned\r\n                    if (space.bannedUsers.includes(member.userId)) {\r\n                        console.warn('[Members] User is banned:', member.userId)\r\n                        return\r\n                    }\r\n\r\n                    // BUG-050: Max members enforcement\r\n                    if (space.members.length >= MAX_MEMBERS_PER_SPACE) {\r\n                        console.warn('[Members] Max members reached for space:', spaceId)\r\n                        return\r\n                    }\r\n\r\n                    // Don't add duplicates\r\n                    if (space.members.find(m => m.userId === member.userId)) {\r\n                        return\r\n                    }\r\n\r\n                    set({\r\n                        spaceMembers: {\r\n                            ...spaceMembers,\r\n                            [spaceId]: {\r\n                                ...space,\r\n                                members: [...space.members, member]\r\n                            }\r\n                        }\r\n                    })\r\n                }\r\n            },\r\n\r\n            removeMember: (spaceId, userId) => {\r\n                const { spaceMembers } = get()\r\n                const space = spaceMembers[spaceId]\r\n\r\n                if (space) {\r\n                    set({\r\n                        spaceMembers: {\r\n                            ...spaceMembers,\r\n                            [spaceId]: {\r\n                                ...space,\r\n                                members: space.members.filter(m => m.userId !== userId)\r\n                            }\r\n                        }\r\n                    })\r\n                }\r\n            },\r\n\r\n            updateMemberRole: (spaceId, userId, role) => {\r\n                const { spaceMembers, canIManage } = get()\r\n                const space = spaceMembers[spaceId]\r\n\r\n                if (!space || !canIManage(spaceId, userId)) return\r\n\r\n                // Validate role\r\n                const validRoles: WorkspaceRole[] = ['admin', 'member', 'viewer']\r\n                if (!validRoles.includes(role)) {\r\n                    console.error('[Members] Invalid role:', role)\r\n                    return\r\n                }\r\n\r\n                set({\r\n                    spaceMembers: {\r\n                        ...spaceMembers,\r\n                        [spaceId]: {\r\n                            ...space,\r\n                            members: space.members.map(m =>\r\n                                m.userId === userId\r\n                                    ? { ...m, role, permissions: { ...DEFAULT_PERMISSIONS[role] } }\r\n                                    : m\r\n                            )\r\n                        }\r\n                    }\r\n                })\r\n            },\r\n\r\n            updateMemberPermissions: (spaceId, userId, permissions) => {\r\n                const { spaceMembers, canIManage } = get()\r\n                const space = spaceMembers[spaceId]\r\n\r\n                if (!space || !canIManage(spaceId, userId)) return\r\n\r\n                set({\r\n                    spaceMembers: {\r\n                        ...spaceMembers,\r\n                        [spaceId]: {\r\n                            ...space,\r\n                            members: space.members.map(m =>\r\n                                m.userId === userId\r\n                                    ? { ...m, permissions: { ...m.permissions, ...permissions } }\r\n                                    : m\r\n                            )\r\n                        }\r\n                    }\r\n                })\r\n            },\r\n\r\n            kickMember: (spaceId, targetUserId, _reason) => {\r\n                const { spaceMembers, userId, getMyRole, getMember } = get()\r\n                const space = spaceMembers[spaceId]\r\n                const myRole = getMyRole(spaceId)\r\n                const target = getMember(spaceId, targetUserId)\r\n\r\n                if (!space || !target || !canKick(myRole, target.role)) {\r\n                    return false\r\n                }\r\n\r\n                // Add kick action to pending\r\n                const kickAction: ModerationAction = {\r\n                    type: 'kick',\r\n                    targetUserId,\r\n                    initiatorId: userId,\r\n                    timestamp: Date.now()\r\n                }\r\n\r\n                set({\r\n                    spaceMembers: {\r\n                        ...spaceMembers,\r\n                        [spaceId]: {\r\n                            ...space,\r\n                            members: space.members.filter(m => m.userId !== targetUserId),\r\n                            pendingActions: [...space.pendingActions, kickAction]\r\n                        }\r\n                    }\r\n                })\r\n\r\n                console.log('[Members] Kicked user:', targetUserId)\r\n                return true\r\n            },\r\n\r\n            banMember: (spaceId, targetUserId, reason) => {\r\n                const { spaceMembers, userId, getMyRole, getMember } = get()\r\n                const space = spaceMembers[spaceId]\r\n                const myRole = getMyRole(spaceId)\r\n                const target = getMember(spaceId, targetUserId)\r\n\r\n                if (!space || !canBan(myRole, target?.role || 'member')) {\r\n                    return false\r\n                }\r\n\r\n                // Add ban action to pending\r\n                const banAction: ModerationAction = {\r\n                    type: 'ban',\r\n                    targetUserId,\r\n                    initiatorId: userId,\r\n                    reason,\r\n                    timestamp: Date.now()\r\n                }\r\n\r\n                set({\r\n                    spaceMembers: {\r\n                        ...spaceMembers,\r\n                        [spaceId]: {\r\n                            ...space,\r\n                            members: space.members.filter(m => m.userId !== targetUserId),\r\n                            bannedUsers: [...space.bannedUsers, targetUserId],\r\n                            pendingActions: [...space.pendingActions, banAction]\r\n                        }\r\n                    }\r\n                })\r\n\r\n                console.log('[Members] Banned user:', targetUserId, reason)\r\n                return true\r\n            },\r\n\r\n            unbanMember: (spaceId, targetUserId) => {\r\n                const { spaceMembers, userId, getMyRole } = get()\r\n                const space = spaceMembers[spaceId]\r\n                const myRole = getMyRole(spaceId)\r\n\r\n                if (!space || !['owner', 'admin'].includes(myRole)) {\r\n                    return false\r\n                }\r\n\r\n                const unbanAction: ModerationAction = {\r\n                    type: 'unban',\r\n                    targetUserId,\r\n                    initiatorId: userId,\r\n                    timestamp: Date.now()\r\n                }\r\n\r\n                set({\r\n                    spaceMembers: {\r\n                        ...spaceMembers,\r\n                        [spaceId]: {\r\n                            ...space,\r\n                            bannedUsers: space.bannedUsers.filter(id => id !== targetUserId),\r\n                            pendingActions: [...space.pendingActions, unbanAction]\r\n                        }\r\n                    }\r\n                })\r\n\r\n                console.log('[Members] Unbanned user:', targetUserId)\r\n                return true\r\n            },\r\n\r\n            isUserBanned: (spaceId, userId) => {\r\n                const { spaceMembers } = get()\r\n                const space = spaceMembers[spaceId]\r\n                if (!space) return false\r\n\r\n                // BUG-049: Consistent check across both list and member flags\r\n                const fromList = space.bannedUsers.includes(userId)\r\n                const fromMember = space.members.find(m => m.userId === userId)?.isBanned || false\r\n                return fromList || fromMember\r\n            },\r\n\r\n            getMyRole: (spaceId) => {\r\n                const { spaceMembers, userId } = get()\r\n                const space = spaceMembers[spaceId]\r\n\r\n                if (!space) return 'member'\r\n                if (space.ownerId === userId) return 'owner'\r\n\r\n                const member = space.members.find(m => m.userId === userId)\r\n                return member?.role || 'member'\r\n            },\r\n\r\n            getMember: (spaceId, userId) => {\r\n                const { spaceMembers } = get()\r\n                const space = spaceMembers[spaceId]\r\n                return space?.members.find(m => m.userId === userId)\r\n            },\r\n\r\n            getMembers: (spaceId) => {\r\n                const { spaceMembers } = get()\r\n                return spaceMembers[spaceId]?.members || []\r\n            },\r\n\r\n            canIManage: (spaceId, targetUserId) => {\r\n                const { getMyRole, getMember } = get()\r\n                const myRole = getMyRole(spaceId)\r\n                const target = getMember(spaceId, targetUserId)\r\n\r\n                if (!target) return false\r\n                return canManageRole(myRole, target.role)\r\n            },\r\n\r\n            getMyPermissions: (spaceId) => {\r\n                const { spaceMembers, userId } = get()\r\n                const space = spaceMembers[spaceId]\r\n\r\n                if (!space) return DEFAULT_PERMISSIONS.member\r\n\r\n                const member = space.members.find(m => m.userId === userId)\r\n                return member?.permissions || DEFAULT_PERMISSIONS.member\r\n            },\r\n\r\n            popPendingAction: (spaceId) => {\r\n                const { spaceMembers } = get()\r\n                const space = spaceMembers[spaceId]\r\n\r\n                if (!space || space.pendingActions.length === 0) return undefined\r\n\r\n                const [action, ...rest] = space.pendingActions\r\n                set({\r\n                    spaceMembers: {\r\n                        ...spaceMembers,\r\n                        [spaceId]: { ...space, pendingActions: rest }\r\n                    }\r\n                })\r\n\r\n                return action\r\n            }\r\n        }),\r\n        {\r\n            name: 'kalynt-members',\r\n            partialize: (state) => {\r\n                // Limit storage size by keeping only recent spaces\r\n                const spaceIds = Object.keys(state.spaceMembers)\r\n                let limitedSpaceMembers = state.spaceMembers\r\n\r\n                if (spaceIds.length > MAX_SPACES_PERSISTED) {\r\n                    // Sort by most recent activity (newest first)\r\n                    const sorted = spaceIds.sort((a, b) => {\r\n                        const aMembers = state.spaceMembers[a]?.members || []\r\n                        const bMembers = state.spaceMembers[b]?.members || []\r\n\r\n                        // Safe max calculation without spread\r\n                        const aLatest = aMembers.reduce((max, m) => Math.max(max, m.joinedAt || 0), 0)\r\n                        const bLatest = bMembers.reduce((max, m) => Math.max(max, m.joinedAt || 0), 0)\r\n\r\n                        return bLatest - aLatest\r\n                    })\r\n\r\n                    // Keep only the most recent spaces\r\n                    const toKeep = sorted.slice(0, MAX_SPACES_PERSISTED)\r\n                    limitedSpaceMembers = Object.fromEntries(\r\n                        toKeep.map(id => [id, state.spaceMembers[id]])\r\n                    )\r\n\r\n                    console.log(`[Members] Evicted ${spaceIds.length - MAX_SPACES_PERSISTED} old spaces from storage`)\r\n                }\r\n\r\n                // Also limit members per space\r\n                const clampedSpaceMembers: Record<string, typeof state.spaceMembers[string]> = {}\r\n                for (const [spaceId, spaceInfo] of Object.entries(limitedSpaceMembers)) {\r\n                    clampedSpaceMembers[spaceId] = {\r\n                        ...spaceInfo,\r\n                        members: spaceInfo.members.slice(0, MAX_MEMBERS_PER_SPACE),\r\n                        pendingActions: [] // Don't persist pending actions\r\n                    }\r\n                }\r\n\r\n                return {\r\n                    userId: state.userId,\r\n                    displayName: state.displayName,\r\n                    spaceMembers: clampedSpaceMembers\r\n                }\r\n            }\r\n        }\r\n    )\r\n)\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\stores\\modelStore.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":81,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":81,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[2793,2854],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":89,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":89,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[3128,3179],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":115,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":115,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[4010,4064],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":160,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":160,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[5935,5988],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":175,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":175,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[6518,6572],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":183,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":183,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[6837,6893],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":209,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":209,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[7807,7863],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":228,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":228,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[8527,8587],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":233,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":233,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[8733,8783],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":258,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":258,"endColumn":32,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[9580,9638],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":262,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":262,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[9705,9785],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":272,"column":33,"nodeType":"MemberExpression","messageId":"unexpected","endLine":272,"endColumn":45,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[10212,10272],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":276,"column":29,"nodeType":"MemberExpression","messageId":"unexpected","endLine":276,"endColumn":41,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[10435,10504],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":284,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":284,"endColumn":32,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[10752,10851],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":293,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":293,"endColumn":32,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[11274,11345],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":309,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":309,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[11728,11777],"text":""},"desc":"Remove the console.log()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":16,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n// Model Store - Track downloaded models and download progress\r\nimport { create } from 'zustand'\r\nimport { persist } from 'zustand/middleware'\r\nimport {\r\n    DownloadedModel,\r\n    DownloadProgress,\r\n    DownloadStatus,\r\n    getModelById\r\n} from '../types/offlineModels'\r\n\r\ninterface ModelState {\r\n    // Downloaded models\r\n    downloadedModels: Record<string, DownloadedModel>\r\n\r\n    // Active downloads\r\n    activeDownloads: Record<string, DownloadProgress>\r\n\r\n    // Currently loaded model\r\n    loadedModelId: string | null\r\n    isLoading: boolean\r\n    loadError: string | null\r\n\r\n    // Actions\r\n    addDownloadedModel: (model: DownloadedModel) => void\r\n    removeDownloadedModel: (modelId: string) => void\r\n    isModelDownloaded: (modelId: string) => boolean\r\n    getDownloadedModel: (modelId: string) => DownloadedModel | undefined\r\n\r\n    // Download progress\r\n    startDownload: (modelId: string, totalBytes: number) => void\r\n    updateDownloadProgress: (modelId: string, progress: Partial<DownloadProgress>) => void\r\n    pauseDownload: (modelId: string) => void\r\n    resumeDownload: (modelId: string) => void\r\n    cancelDownload: (modelId: string) => void\r\n    completeDownload: (modelId: string, path: string) => void\r\n    failDownload: (modelId: string, error: string) => void\r\n\r\n    // Model loading\r\n    setLoadedModel: (modelId: string | null) => void\r\n    setLoading: (loading: boolean) => void\r\n    setLoadError: (error: string | null) => void\r\n\r\n    // Utilities\r\n    getDownloadProgress: (modelId: string) => DownloadProgress | undefined\r\n    getTotalDownloadedSize: () => number\r\n    setupListeners: () => void\r\n    verifyDownloadedModels: () => Promise<void>\r\n}\r\n\r\nexport const useModelStore = create<ModelState>()(\r\n    persist(\r\n        (set, get) => ({\r\n            downloadedModels: {},\r\n            activeDownloads: {},\r\n            loadedModelId: null,\r\n            isLoading: false,\r\n            loadError: null,\r\n\r\n            setupListeners: () => {\r\n                if (window.electronAPI?.onDownloadProgress) {\r\n                    window.electronAPI.onDownloadProgress((progress) => {\r\n                        get().updateDownloadProgress(progress.modelId, {\r\n                            bytesDownloaded: progress.bytesDownloaded,\r\n                            totalBytes: progress.totalBytes,\r\n                            speed: progress.speed\r\n                        })\r\n                    })\r\n                }\r\n            },\r\n\r\n            addDownloadedModel: (model) => {\r\n                set((state) => ({\r\n                    downloadedModels: {\r\n                        ...state.downloadedModels,\r\n                        [model.id]: model\r\n                    }\r\n                }))\r\n                console.log('[ModelStore] Added downloaded model:', model.id)\r\n            },\r\n\r\n            removeDownloadedModel: (modelId) => {\r\n                set((state) => {\r\n                    const { [modelId]: _, ...rest } = state.downloadedModels\r\n                    return { downloadedModels: rest }\r\n                })\r\n                console.log('[ModelStore] Removed model:', modelId)\r\n            },\r\n\r\n            isModelDownloaded: (modelId) => {\r\n                return !!get().downloadedModels[modelId]\r\n            },\r\n\r\n            getDownloadedModel: (modelId) => {\r\n                return get().downloadedModels[modelId]\r\n            },\r\n\r\n            startDownload: (modelId, totalBytes) => {\r\n                const progress: DownloadProgress = {\r\n                    modelId,\r\n                    status: 'downloading',\r\n                    bytesDownloaded: 0,\r\n                    totalBytes,\r\n                    speed: 0,\r\n                    eta: 0\r\n                }\r\n                set((state) => ({\r\n                    activeDownloads: {\r\n                        ...state.activeDownloads,\r\n                        [modelId]: progress\r\n                    }\r\n                }))\r\n                console.log('[ModelStore] Started download:', modelId)\r\n            },\r\n\r\n            updateDownloadProgress: (modelId, progress) => {\r\n                set((state) => {\r\n                    const existing = state.activeDownloads[modelId]\r\n                    if (!existing) return state\r\n\r\n                    // Use provided values or fall back to existing\r\n                    const bytesDownloaded = progress.bytesDownloaded ?? existing.bytesDownloaded\r\n                    const totalBytes = progress.totalBytes ?? existing.totalBytes\r\n                    const speed = progress.speed ?? existing.speed\r\n\r\n                    // Calculate ETA: remaining bytes / speed (in seconds)\r\n                    const remaining = totalBytes - bytesDownloaded\r\n                    const eta = speed > 0 ? Math.round(remaining / speed) : 0\r\n\r\n                    return {\r\n                        activeDownloads: {\r\n                            ...state.activeDownloads,\r\n                            [modelId]: {\r\n                                ...existing,\r\n                                bytesDownloaded,\r\n                                totalBytes,\r\n                                speed,\r\n                                eta,\r\n                                status: existing.status, // Preserve status\r\n                            }\r\n                        }\r\n                    }\r\n                })\r\n            },\r\n\r\n            pauseDownload: (modelId) => {\r\n                set((state) => {\r\n                    const existing = state.activeDownloads[modelId]\r\n                    if (!existing) return state\r\n\r\n                    return {\r\n                        activeDownloads: {\r\n                            ...state.activeDownloads,\r\n                            [modelId]: { ...existing, status: 'paused' as DownloadStatus }\r\n                        }\r\n                    }\r\n                })\r\n                console.log('[ModelStore] Paused download:', modelId)\r\n            },\r\n\r\n            resumeDownload: (modelId) => {\r\n                set((state) => {\r\n                    const existing = state.activeDownloads[modelId]\r\n                    if (!existing) return state\r\n\r\n                    return {\r\n                        activeDownloads: {\r\n                            ...state.activeDownloads,\r\n                            [modelId]: { ...existing, status: 'downloading' as DownloadStatus }\r\n                        }\r\n                    }\r\n                })\r\n                console.log('[ModelStore] Resumed download:', modelId)\r\n            },\r\n\r\n            cancelDownload: (modelId) => {\r\n                set((state) => {\r\n                    const { [modelId]: _, ...rest } = state.activeDownloads\r\n                    return { activeDownloads: rest }\r\n                })\r\n                console.log('[ModelStore] Cancelled download:', modelId)\r\n            },\r\n\r\n            completeDownload: (modelId, path) => {\r\n                const model = getModelById(modelId)\r\n                if (!model) return\r\n\r\n                // Add to downloaded models\r\n                const downloadedModel: DownloadedModel = {\r\n                    id: modelId,\r\n                    path,\r\n                    downloadedAt: Date.now(),\r\n                    sizeBytes: model.sizeBytes,\r\n                    verified: true\r\n                }\r\n\r\n                set((state) => {\r\n                    const { [modelId]: _, ...rest } = state.activeDownloads\r\n                    return {\r\n                        activeDownloads: rest,\r\n                        downloadedModels: {\r\n                            ...state.downloadedModels,\r\n                            [modelId]: downloadedModel\r\n                        }\r\n                    }\r\n                })\r\n                console.log('[ModelStore] Completed download:', modelId)\r\n            },\r\n\r\n            failDownload: (modelId, error) => {\r\n                set((state) => {\r\n                    const existing = state.activeDownloads[modelId]\r\n                    if (!existing) return state\r\n\r\n                    return {\r\n                        activeDownloads: {\r\n                            ...state.activeDownloads,\r\n                            [modelId]: {\r\n                                ...existing,\r\n                                status: 'error' as DownloadStatus,\r\n                                error\r\n                            }\r\n                        }\r\n                    }\r\n                })\r\n                console.log('[ModelStore] Download failed:', modelId, error)\r\n            },\r\n\r\n            setLoadedModel: (modelId) => {\r\n                set({ loadedModelId: modelId, loadError: null })\r\n                console.log('[ModelStore] Loaded model:', modelId)\r\n            },\r\n\r\n            setLoading: (loading) => {\r\n                set({ isLoading: loading })\r\n            },\r\n\r\n            setLoadError: (error) => {\r\n                set({ loadError: error, isLoading: false })\r\n            },\r\n\r\n            getDownloadProgress: (modelId) => {\r\n                return get().activeDownloads[modelId]\r\n            },\r\n\r\n            getTotalDownloadedSize: () => {\r\n                const models = get().downloadedModels\r\n                return Object.values(models).reduce((sum, m) => sum + m.sizeBytes, 0)\r\n            },\r\n\r\n            verifyDownloadedModels: async () => {\r\n                const models = get().downloadedModels\r\n                const modelIds = Object.keys(models)\r\n\r\n                if (modelIds.length === 0) {\r\n                    console.log('[ModelStore] No downloaded models to verify')\r\n                    return\r\n                }\r\n\r\n                console.log('[ModelStore] Verifying', modelIds.length, 'downloaded model(s)...')\r\n\r\n                const invalidModels: string[] = []\r\n\r\n                for (const modelId of modelIds) {\r\n                    const model = models[modelId]\r\n                    if (model && window.electronAPI?.fileExists) {\r\n                        try {\r\n                            const exists = await window.electronAPI.fileExists(model.path)\r\n                            if (!exists) {\r\n                                console.warn('[ModelStore] Model file missing:', model.path)\r\n                                invalidModels.push(modelId)\r\n                            }\r\n                        } catch (err) {\r\n                            console.warn('[ModelStore] Error checking model file:', modelId, err)\r\n                            invalidModels.push(modelId)\r\n                        }\r\n                    }\r\n                }\r\n\r\n                // Remove invalid model entries\r\n                if (invalidModels.length > 0) {\r\n                    console.log('[ModelStore] Removing', invalidModels.length, 'invalid model entries:', invalidModels)\r\n                    set((state) => {\r\n                        const newDownloadedModels = { ...state.downloadedModels }\r\n                        for (const modelId of invalidModels) {\r\n                            delete newDownloadedModels[modelId]\r\n                        }\r\n                        return { downloadedModels: newDownloadedModels }\r\n                    })\r\n                } else {\r\n                    console.log('[ModelStore] All downloaded models verified successfully')\r\n                }\r\n            }\r\n        }),\r\n        {\r\n            name: 'kalynt-models',\r\n            partialize: (state) => ({\r\n                downloadedModels: state.downloadedModels\r\n            })\r\n        }\r\n    )\r\n)\r\n\r\n// Initialize listeners when the module loads (browser only)\r\nif (typeof window !== 'undefined') {\r\n    useModelStore.getState().setupListeners()\r\n    console.log('[ModelStore] Listeners initialized')\r\n\r\n    // Verify downloaded models on startup (async, runs in background)\r\n    // This removes stale entries for models whose files no longer exist\r\n    setTimeout(() => {\r\n        useModelStore.getState().verifyDownloadedModels()\r\n    }, 1000) // Delay to allow electronAPI to be ready\r\n}\r\n\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\stores\\notificationStore.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\stores\\updateStore.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":108,"column":25,"nodeType":"MemberExpression","messageId":"unexpected","endLine":108,"endColumn":36,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[3646,3719],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":114,"column":25,"nodeType":"MemberExpression","messageId":"unexpected","endLine":114,"endColumn":36,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[3934,3982],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":117,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":117,"endColumn":34,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[4062,4112],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":136,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":136,"endColumn":32,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[4786,4831],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":138,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":138,"endColumn":34,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[4888,4941],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":150,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":150,"endColumn":32,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[5325,5389],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":160,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":160,"endColumn":34,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[5747,5799],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":194,"column":29,"nodeType":"MemberExpression","messageId":"unexpected","endLine":194,"endColumn":40,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[7263,7315],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":197,"column":25,"nodeType":"MemberExpression","messageId":"unexpected","endLine":197,"endColumn":36,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[7398,7469],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":204,"column":25,"nodeType":"MemberExpression","messageId":"unexpected","endLine":204,"endColumn":36,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[7792,7844],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":209,"column":25,"nodeType":"MemberExpression","messageId":"unexpected","endLine":209,"endColumn":36,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[8041,8093],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":219,"column":25,"nodeType":"MemberExpression","messageId":"unexpected","endLine":219,"endColumn":36,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[8488,8543],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":228,"column":25,"nodeType":"MemberExpression","messageId":"unexpected","endLine":228,"endColumn":36,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[8892,8971],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":236,"column":25,"nodeType":"MemberExpression","messageId":"unexpected","endLine":236,"endColumn":36,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[9270,9323],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":246,"column":25,"nodeType":"MemberExpression","messageId":"unexpected","endLine":246,"endColumn":38,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[9712,9763],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":254,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":254,"endColumn":32,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[10019,10072],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":256,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":256,"endColumn":34,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[10129,10188],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":17,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\nimport { create } from 'zustand'\r\nimport { persist, createJSONStorage } from 'zustand/middleware'\r\n\r\n/**\r\n * Update Store\r\n * Manages application auto-update state and interactions\r\n */\r\n\r\nexport interface UpdateInfo {\r\n    version: string\r\n    releaseNotes?: string\r\n    releaseDate: string\r\n    releaseName?: string\r\n}\r\n\r\nexport interface DownloadProgress {\r\n    bytesPerSecond: number\r\n    percent: number\r\n    transferred: number\r\n    total: number\r\n}\r\n\r\nexport type UpdateStatus =\r\n    | 'idle'              // No update operation in progress\r\n    | 'checking'          // Checking for updates\r\n    | 'available'         // Update is available\r\n    | 'not-available'     // No update available\r\n    | 'downloading'       // Downloading update\r\n    | 'downloaded'        // Update downloaded, ready to install\r\n    | 'error'             // Error occurred\r\n\r\ninterface UpdateState {\r\n    // State\r\n    status: UpdateStatus\r\n    currentVersion: string\r\n    updateInfo: UpdateInfo | null\r\n    downloadProgress: DownloadProgress | null\r\n    error: string | null\r\n    lastChecked: number | null\r\n    showUpdateModal: boolean\r\n    isConfigured: boolean\r\n\r\n    // Actions\r\n    setStatus: (status: UpdateStatus) => void\r\n    setUpdateInfo: (info: UpdateInfo | null) => void\r\n    setDownloadProgress: (progress: DownloadProgress | null) => void\r\n    setError: (error: string | null) => void\r\n    setLastChecked: (timestamp: number) => void\r\n    setShowUpdateModal: (show: boolean) => void\r\n    setIsConfigured: (configured: boolean) => void\r\n    setCurrentVersion: (version: string) => void\r\n\r\n    // Actions - Update operations\r\n    checkForUpdates: () => Promise<void>\r\n    downloadUpdate: () => Promise<void>\r\n    installUpdate: () => Promise<void>\r\n    dismissUpdate: () => void\r\n\r\n    // Initialization\r\n    initialize: () => Promise<void>\r\n}\r\n\r\nexport const useUpdateStore = create<UpdateState>()(\r\n    persist(\r\n        (set) => ({\r\n            // Initial state\r\n            status: 'idle',\r\n            currentVersion: 'v1.0 beta',\r\n            updateInfo: null,\r\n            downloadProgress: null,\r\n            error: null,\r\n            lastChecked: null,\r\n            showUpdateModal: false,\r\n            isConfigured: false,\r\n\r\n            // Setters\r\n            setStatus: (status) => set({ status }),\r\n            setUpdateInfo: (updateInfo) => set({ updateInfo }),\r\n            setDownloadProgress: (downloadProgress) => set({ downloadProgress }),\r\n            setError: (error) => set({ error }),\r\n            setLastChecked: (lastChecked) => set({ lastChecked }),\r\n            setShowUpdateModal: (showUpdateModal) => set({ showUpdateModal }),\r\n            setIsConfigured: (isConfigured) => set({ isConfigured }),\r\n            setCurrentVersion: (currentVersion) => set({ currentVersion }),\r\n\r\n            // Check for updates\r\n            checkForUpdates: async () => {\r\n                try {\r\n                    set({ status: 'checking', error: null })\r\n\r\n                    const result = await window.electronAPI?.update?.checkForUpdates()\r\n\r\n                    if (!result?.success) {\r\n                        throw new Error(result?.error || 'Failed to check for updates')\r\n                    }\r\n\r\n                    set({ lastChecked: Date.now() })\r\n\r\n                    if (result.updateAvailable && result.updateInfo) {\r\n                        set({\r\n                            status: 'available',\r\n                            updateInfo: result.updateInfo,\r\n                            showUpdateModal: true\r\n                        })\r\n                        console.log('[UpdateStore] Update available:', result.updateInfo.version)\r\n                    } else {\r\n                        set({\r\n                            status: 'not-available',\r\n                            updateInfo: null\r\n                        })\r\n                        console.log('[UpdateStore] No update available')\r\n                    }\r\n                } catch (error) {\r\n                    console.error('[UpdateStore] Check error:', error)\r\n                    set({\r\n                        status: 'error',\r\n                        error: error instanceof Error ? error.message : String(error)\r\n                    })\r\n                }\r\n            },\r\n\r\n            // Download update\r\n            downloadUpdate: async () => {\r\n                try {\r\n                    set({ status: 'downloading', error: null, downloadProgress: null })\r\n\r\n                    const result = await window.electronAPI?.update?.downloadUpdate()\r\n\r\n                    if (!result?.success) {\r\n                        throw new Error(result?.error || 'Failed to download update')\r\n                    }\r\n\r\n                    console.log('[UpdateStore] Download started')\r\n                } catch (error) {\r\n                    console.error('[UpdateStore] Download error:', error)\r\n                    set({\r\n                        status: 'error',\r\n                        error: error instanceof Error ? error.message : String(error),\r\n                        downloadProgress: null\r\n                    })\r\n                }\r\n            },\r\n\r\n            // Install update\r\n            installUpdate: async () => {\r\n                try {\r\n                    console.log('[UpdateStore] Installing update and restarting...')\r\n\r\n                    const result = await window.electronAPI?.update?.installUpdate()\r\n\r\n                    if (!result?.success) {\r\n                        throw new Error(result?.error || 'Failed to install update')\r\n                    }\r\n\r\n                    // App will restart automatically\r\n                } catch (error) {\r\n                    console.error('[UpdateStore] Install error:', error)\r\n                    set({\r\n                        status: 'error',\r\n                        error: error instanceof Error ? error.message : String(error)\r\n                    })\r\n                }\r\n            },\r\n\r\n            // Dismiss update notification\r\n            dismissUpdate: () => {\r\n                set({\r\n                    showUpdateModal: false,\r\n                    status: 'idle',\r\n                    updateInfo: null,\r\n                    downloadProgress: null,\r\n                    error: null\r\n                })\r\n            },\r\n\r\n            // Initialize update system\r\n            initialize: async () => {\r\n                try {\r\n                    // Get current version\r\n                    const versionResult = await window.electronAPI?.update?.getVersion()\r\n                    if (versionResult?.success && versionResult.version) {\r\n                        set({ currentVersion: versionResult.version })\r\n                    }\r\n\r\n                    // Configure GitHub token from safe storage\r\n                    const tokenResult = await window.electronAPI?.safeStorage?.get('github-update-token')\r\n                    if (tokenResult?.success && tokenResult.value) {\r\n                        const configResult = await window.electronAPI?.update?.configureToken(tokenResult.value)\r\n                        if (configResult?.success) {\r\n                            set({ isConfigured: true })\r\n                            console.log('[UpdateStore] GitHub token configured')\r\n                        }\r\n                    } else {\r\n                        console.log('[UpdateStore] No GitHub token found, using public access')\r\n                        // Configure with empty token for public access\r\n                        await window.electronAPI?.update?.configureToken('')\r\n                    }\r\n\r\n                    // Set up event listeners\r\n                    window.electronAPI?.update?.onUpdateChecking(() => {\r\n                        console.log('[UpdateStore] Checking for updates...')\r\n                        set({ status: 'checking', error: null })\r\n                    })\r\n\r\n                    window.electronAPI?.update?.onUpdateAvailable((info) => {\r\n                        console.log('[UpdateStore] Update available:', info)\r\n                        set({\r\n                            status: 'available',\r\n                            updateInfo: info,\r\n                            showUpdateModal: true,\r\n                            lastChecked: Date.now()\r\n                        })\r\n                    })\r\n\r\n                    window.electronAPI?.update?.onUpdateNotAvailable((info) => {\r\n                        console.log('[UpdateStore] No update available:', info)\r\n                        set({\r\n                            status: 'not-available',\r\n                            updateInfo: null,\r\n                            lastChecked: Date.now()\r\n                        })\r\n                    })\r\n\r\n                    window.electronAPI?.update?.onDownloadProgress((progress) => {\r\n                        console.log(`[UpdateStore] Download progress: ${progress.percent.toFixed(2)}%`)\r\n                        set({\r\n                            status: 'downloading',\r\n                            downloadProgress: progress\r\n                        })\r\n                    })\r\n\r\n                    window.electronAPI?.update?.onUpdateDownloaded((info) => {\r\n                        console.log('[UpdateStore] Update downloaded:', info)\r\n                        set({\r\n                            status: 'downloaded',\r\n                            updateInfo: info,\r\n                            downloadProgress: null,\r\n                            showUpdateModal: true\r\n                        })\r\n                    })\r\n\r\n                    window.electronAPI?.update?.onUpdateError((error) => {\r\n                        console.error('[UpdateStore] Update error:', error)\r\n                        set({\r\n                            status: 'error',\r\n                            error: error.message,\r\n                            downloadProgress: null\r\n                        })\r\n                    })\r\n\r\n                    console.log('[UpdateStore] Initialized successfully')\r\n                } catch (error) {\r\n                    console.error('[UpdateStore] Initialization error:', error)\r\n                    set({\r\n                        error: error instanceof Error ? error.message : String(error)\r\n                    })\r\n                }\r\n            }\r\n        }),\r\n        {\r\n            name: 'kalynt-update-storage',\r\n            storage: createJSONStorage(() => localStorage),\r\n            partialize: (state) => ({\r\n                // Only persist these fields\r\n                lastChecked: state.lastChecked,\r\n                isConfigured: state.isConfigured,\r\n                currentVersion: state.currentVersion\r\n            })\r\n        }\r\n    )\r\n)\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\types\\agentTypes.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":100,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":100,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2331,2334],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2331,2334],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n// Agent Types - Type definitions for autonomous AI agent\r\n\r\nimport { EditorMode } from '../config/editorModes'\r\n\r\n// Agent states\r\nexport type AgentState =\r\n    | 'disabled'\r\n    | 'idle'\r\n    | 'observing'\r\n    | 'thinking'\r\n    | 'waiting-approval'\r\n    | 'executing'\r\n    | 'error'\r\n\r\n// Action types the agent can perform\r\nexport type AgentActionType =\r\n    | 'edit'\r\n    | 'create-task'\r\n    | 'suggest'\r\n    | 'comment'\r\n    | 'organize'\r\n    | 'tool-call'\r\n\r\n// Target Yjs documents\r\nexport type AgentTarget =\r\n    | 'editor-content'\r\n    | 'tasks'\r\n    | 'messages'\r\n    | 'file-system'\r\n\r\n// Task status for created tasks\r\nexport type TaskStatus = 'todo' | 'in-progress' | 'done'\r\n\r\n// Payload types for different actions\r\nexport interface EditPayload {\r\n    content: string\r\n    position?: 'append' | 'prepend' | 'replace' | 'insert'\r\n    insertAt?: number\r\n}\r\n\r\nexport interface CreateTaskPayload {\r\n    title: string\r\n    status: TaskStatus\r\n    priority?: 'low' | 'medium' | 'high'\r\n}\r\n\r\nexport interface SuggestPayload {\r\n    message: string\r\n    category?: 'improvement' | 'warning' | 'info' | 'tip' | 'bug' | 'security' | 'performance' | 'refactor'\r\n    filePath?: string\r\n    lineNumber?: number\r\n}\r\n\r\nexport interface CommentPayload {\r\n    content: string\r\n    position: number\r\n    length: number\r\n}\r\n\r\nexport interface OrganizePayload {\r\n    sections: { title: string; content: string }[]\r\n}\r\n\r\nexport interface ToolCallPayload {\r\n    tool: string\r\n    params: Record<string, unknown>\r\n}\r\n\r\nexport type AgentPayload =\r\n    | EditPayload\r\n    | CreateTaskPayload\r\n    | SuggestPayload\r\n    | CommentPayload\r\n    | OrganizePayload\r\n    | ToolCallPayload\r\n\r\n// Agent suggestion with confidence\r\nexport interface AgentSuggestion {\r\n    id: string\r\n    action: AgentActionType\r\n    target: AgentTarget\r\n    description: string\r\n    reasoning: string\r\n    confidence: number // 0-1\r\n    payload: AgentPayload\r\n    timestamp: number\r\n    status: 'pending' | 'approved' | 'rejected' | 'executed'\r\n}\r\n\r\n// Activity log entry\r\nexport interface ActivityLogEntry {\r\n    id: string\r\n    timestamp: number\r\n    type: 'suggestion' | 'approval' | 'rejection' | 'execution' | 'error' | 'analysis'\r\n    message: string\r\n    suggestionId?: string\r\n    details?: Record<string, any>\r\n}\r\n\r\n// Workspace context sent to AI\r\nexport interface WorkspaceContext {\r\n    mode: EditorMode\r\n    editorContent: string\r\n    editorWordCount: number\r\n    tasks: {\r\n        total: number\r\n        todo: number\r\n        inProgress: number\r\n        done: number\r\n        items: { title: string; status: string }[]\r\n    }\r\n    recentActivity: string[]\r\n    lastEditTime: number\r\n    idleTime: number\r\n}\r\n\r\n// AI response format for agent\r\nexport interface AgentAIResponse {\r\n    suggestions: {\r\n        action: AgentActionType\r\n        target: AgentTarget\r\n        description: string\r\n        reasoning: string\r\n        confidence: number\r\n        payload: AgentPayload\r\n    }[]\r\n    summary?: string\r\n}\r\n\r\n// Agent configuration\r\nexport interface AgentConfig {\r\n    enabled: boolean\r\n    analysisInterval: number // ms, default 30000\r\n    minIdleTime: number // ms, default 30000\r\n    maxSuggestions: number // default 3\r\n    autoApproveThreshold?: number // confidence threshold for auto-approve (disabled by default)\r\n    enabledActions: AgentActionType[]\r\n    maxContextChars: number // BUG-054: Limit context length sent to AI\r\n}\r\n\r\n// Default agent config\r\nexport const DEFAULT_AGENT_CONFIG: AgentConfig = {\r\n    enabled: true,\r\n    analysisInterval: 30000,\r\n    minIdleTime: 30000,\r\n    maxSuggestions: 3,\r\n    autoApproveThreshold: undefined,\r\n    enabledActions: ['edit', 'create-task', 'suggest', 'comment', 'organize', 'tool-call'],\r\n    maxContextChars: 8000 // BUG-054: Larger default limit\r\n}\r\n\r\n// Agent store state\r\nexport interface AgentStoreState {\r\n    state: AgentState\r\n    config: AgentConfig\r\n    suggestions: AgentSuggestion[]\r\n    activityLog: ActivityLogEntry[]\r\n    lastAnalysisTime: number | null\r\n    currentSpaceId: string | null\r\n    error: string | null\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\types\\aime.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\types\\offlineModels.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\types\\permissions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\types\\workspaceCategories.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\utils\\keybindings.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\utils\\logger.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":49,"column":47,"nodeType":"MemberExpression","messageId":"unexpected","endLine":49,"endColumn":60},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":50,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":50,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"debug"},"fix":{"range":[1357,1445],"text":""},"desc":"Remove the console.debug()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":62,"column":47,"nodeType":"MemberExpression","messageId":"unexpected","endLine":62,"endColumn":60},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":63,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":63,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"debug"},"fix":{"range":[1898,1968],"text":""},"desc":"Remove the console.debug()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":96,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":96,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"debug"},"fix":{"range":[2770,2825],"text":""},"desc":"Remove the console.debug()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":102,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":102,"endColumn":25,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"info"},"fix":{"range":[2930,2984],"text":""},"desc":"Remove the console.info()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":108,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":108,"endColumn":25,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[3089,3143],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":114,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":114,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[3250,3305],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":155,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":155,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4698,4701],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4698,4701],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":9,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\n// Centralized Logger for Kalynt\r\n// Provides togglable debug logging per subsystem\r\n\r\ntype LogLevel = 'debug' | 'info' | 'warn' | 'error'\r\ntype Subsystem = 'crdt' | 'p2p' | 'crypto' | 'agent' | 'ide' | 'ai' | 'general'\r\n\r\ninterface LoggerConfig {\r\n    enabled: boolean\r\n    level: LogLevel\r\n    subsystems: Partial<Record<Subsystem, boolean>>\r\n}\r\n\r\nconst LOG_LEVELS: Record<LogLevel, number> = {\r\n    debug: 0,\r\n    info: 1,\r\n    warn: 2,\r\n    error: 3\r\n}\r\n\r\n// Default config - can be overridden\r\nconst config: LoggerConfig = {\r\n    enabled: true,\r\n    level: 'info',\r\n    subsystems: {\r\n        crdt: true,\r\n        p2p: true,\r\n        crypto: true,\r\n        agent: true,\r\n        ide: true,\r\n        ai: true,\r\n        general: true\r\n    }\r\n}\r\n\r\n// Load config from localStorage if available\r\nfunction loadConfig() {\r\n    try {\r\n        const stored = localStorage.getItem('kalynt-logger-config')\r\n        if (stored) {\r\n            const parsed = JSON.parse(stored)\r\n            Object.assign(config, parsed)\r\n        }\r\n    } catch (error) {\r\n        // Intentionally ignore errors in logger infrastructure to avoid circular logging\r\n        // Falls back to default config if localStorage is unavailable or parsing fails\r\n        if (typeof console !== 'undefined' && console.debug) {\r\n            console.debug('[Logger] Failed to load config from localStorage, using defaults', error)\r\n        }\r\n    }\r\n}\r\n\r\n// Save config to localStorage\r\nfunction saveConfig() {\r\n    try {\r\n        localStorage.setItem('kalynt-logger-config', JSON.stringify(config))\r\n    } catch (error) {\r\n        // Intentionally ignore errors in logger infrastructure to avoid circular logging\r\n        // Silent failure is acceptable here as logger will continue with in-memory config\r\n        if (typeof console !== 'undefined' && console.debug) {\r\n            console.debug('[Logger] Failed to save config to localStorage', error)\r\n        }\r\n    }\r\n}\r\n\r\n// Initialize config\r\nif (typeof localStorage !== 'undefined') {\r\n    loadConfig()\r\n}\r\n\r\n// Formatted timestamp\r\nfunction timestamp(): string {\r\n    return new Date().toISOString().split('T')[1].slice(0, 12)\r\n}\r\n\r\n// Main logger class\r\nclass Logger {\r\n    private subsystem: Subsystem\r\n    private prefix: string\r\n\r\n    constructor(subsystem: Subsystem) {\r\n        this.subsystem = subsystem\r\n        this.prefix = `[${subsystem.toUpperCase()}]`\r\n    }\r\n\r\n    private shouldLog(level: LogLevel): boolean {\r\n        if (!config.enabled) return false\r\n        if (config.subsystems[this.subsystem] === false) return false\r\n        return LOG_LEVELS[level] >= LOG_LEVELS[config.level]\r\n    }\r\n\r\n    debug(...args: unknown[]) {\r\n        if (this.shouldLog('debug')) {\r\n            console.debug(`${timestamp()} ${this.prefix}`, ...args)\r\n        }\r\n    }\r\n\r\n    info(...args: unknown[]) {\r\n        if (this.shouldLog('info')) {\r\n            console.info(`${timestamp()} ${this.prefix}`, ...args)\r\n        }\r\n    }\r\n\r\n    warn(...args: unknown[]) {\r\n        if (this.shouldLog('warn')) {\r\n            console.warn(`${timestamp()} ${this.prefix}`, ...args)\r\n        }\r\n    }\r\n\r\n    error(...args: unknown[]) {\r\n        if (this.shouldLog('error')) {\r\n            console.error(`${timestamp()} ${this.prefix}`, ...args)\r\n        }\r\n    }\r\n\r\n    // Log with specific level\r\n    log(level: LogLevel, ...args: unknown[]) {\r\n        switch (level) {\r\n            case 'debug': this.debug(...args); break\r\n            case 'info': this.info(...args); break\r\n            case 'warn': this.warn(...args); break\r\n            case 'error': this.error(...args); break\r\n        }\r\n    }\r\n}\r\n\r\n// Create loggers for each subsystem\r\nexport const logger = {\r\n    crdt: new Logger('crdt'),\r\n    p2p: new Logger('p2p'),\r\n    crypto: new Logger('crypto'),\r\n    agent: new Logger('agent'),\r\n    ide: new Logger('ide'),\r\n    ai: new Logger('ai'),\r\n    general: new Logger('general')\r\n}\r\n\r\n// Config controls (for dev console)\r\nexport const loggerConfig = {\r\n    enable: () => { config.enabled = true; saveConfig() },\r\n    disable: () => { config.enabled = false; saveConfig() },\r\n    setLevel: (level: LogLevel) => { config.level = level; saveConfig() },\r\n    enableSubsystem: (sub: Subsystem) => { config.subsystems[sub] = true; saveConfig() },\r\n    disableSubsystem: (sub: Subsystem) => { config.subsystems[sub] = false; saveConfig() },\r\n    getConfig: () => ({ ...config }),\r\n    // Quick toggle for dev\r\n    verbose: () => { config.level = 'debug'; saveConfig() },\r\n    quiet: () => { config.level = 'error'; saveConfig() }\r\n}\r\n\r\n// Expose to window for dev console access\r\nif (typeof window !== 'undefined') {\r\n    (window as any).kalyntLogger = loggerConfig\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\utils\\path-validator.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\src\\utils\\uuid.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Kalynt\\apps\\desktop\\vite.config.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Use \"@ts-expect-error\" instead of \"@ts-ignore\", as \"@ts-ignore\" will do nothing if the following line is error-free.","line":8,"column":1,"nodeType":"Line","messageId":"tsIgnoreInsteadOfExpectError","endLine":8,"endColumn":73,"suggestions":[{"messageId":"replaceTsIgnoreWithTsExpectError","fix":{"range":[213,285],"text":"// @ts-expect-error - rollup-plugin-javascript-obfuscator lacks built-in types"},"desc":"Replace \"@ts-ignore\" with \"@ts-expect-error\"."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿/*\r\n * SPDX-License-Identifier: AGPL-3.0-only\r\n */\r\nimport { defineConfig } from 'vite'\r\nimport react from '@vitejs/plugin-react'\r\nimport electron from 'vite-plugin-electron/simple'\r\nimport path from 'node:path'\r\n// @ts-ignore - rollup-plugin-javascript-obfuscator lacks built-in types\r\nimport obfuscator from 'rollup-plugin-javascript-obfuscator'\r\n\r\n// Check if obfuscation should be applied\r\nconst isProduction = process.env.NODE_ENV === 'production'\r\nconst shouldObfuscate = process.env.OBFUSCATE === 'true'\r\n\r\n// ============================================================================\r\n// PROPRIETARY FILES WHITELIST\r\n// These are the ONLY files that will be obfuscated\r\n// ============================================================================\r\nconst PROPRIETARY_FILES = [\r\n    // Backend Services\r\n    'electron/handlers/llm-inference.ts',\r\n\r\n    // Frontend Services\r\n    'src/services/agentService.ts',\r\n    'src/services/offlineLLMService.ts',\r\n    'src/services/aiService.ts',\r\n\r\n    // UI Components\r\n    'src/components/AIMESettings.tsx',\r\n\r\n    // Core Types/Logic\r\n    'src/types/aime.ts'\r\n].map(p => path.resolve(__dirname, p))\r\n\r\n// ============================================================================\r\n// HEAVY OBFUSCATION CONFIGURATION\r\n// Applied only when OBFUSCATE=true environment variable is set\r\n// ============================================================================\r\nconst HEAVY_OBFUSCATION_OPTIONS = {\r\n    // Variable/Function names\r\n    compact: true,\r\n    simplify: true,\r\n    identifierNamesGenerator: 'hexadecimal',\r\n    renameGlobals: false,\r\n\r\n    // String protection (RC4 - strongest)\r\n    stringArray: true,\r\n    stringArrayCallsTransform: true,\r\n    stringArrayCallsTransformThreshold: 0.75,\r\n    stringArrayEncoding: ['rc4'],\r\n    stringArrayIndexShift: true,\r\n    stringArrayRotate: true,\r\n    stringArrayShuffle: true,\r\n    stringArrayWrappersCount: 3,\r\n    stringArrayWrappersChainedCalls: true,\r\n    stringArrayWrappersParametersMaxCount: 5,\r\n    stringArrayWrappersType: 'function',\r\n    stringArrayThreshold: 0.8,\r\n    splitStrings: true,\r\n    splitStringsChunkLength: 8,\r\n\r\n    // Control flow\r\n    controlFlowFlattening: true,\r\n    controlFlowFlatteningThreshold: 0.9,\r\n    deadCodeInjection: true,\r\n    deadCodeInjectionThreshold: 0.5,\r\n\r\n    // Anti-debugging\r\n    selfDefending: true,\r\n    debugProtection: true,\r\n    debugProtectionInterval: 3000,\r\n    disableConsoleOutput: true,\r\n\r\n    // Numbers/expressions\r\n    numbersToExpressions: true,\r\n    transformObjectKeys: true,\r\n    unicodeEscapeSequence: false,\r\n\r\n    // Target browser for React frontend\r\n    target: 'browser',\r\n\r\n    // No source maps in production!\r\n    sourceMap: false\r\n}\r\n\r\nexport default defineConfig({\r\n    plugins: [\r\n        react(),\r\n        // Apply obfuscation ONLY to proprietary files\r\n        shouldObfuscate ? obfuscator({\r\n            include: PROPRIETARY_FILES,\r\n            ...HEAVY_OBFUSCATION_OPTIONS\r\n        }) : null,\r\n        electron({\r\n            main: {\r\n                entry: 'electron/main.ts',\r\n                vite: {\r\n                    build: {\r\n                        outDir: 'dist-electron',\r\n                        // Use terser for production builds\r\n                        minify: isProduction ? 'terser' : false,\r\n                        terserOptions: isProduction ? {\r\n                            mangle: {\r\n                                toplevel: true,\r\n                                properties: {\r\n                                    regex: /^_private_/\r\n                                }\r\n                            },\r\n                            compress: {\r\n                                drop_console: true,\r\n                                drop_debugger: true,\r\n                                passes: 3,\r\n                                pure_funcs: ['console.log', 'console.info', 'console.debug', 'console.warn']\r\n                            },\r\n                            format: {\r\n                                comments: false\r\n                            }\r\n                        } : undefined,\r\n                        rollupOptions: {\r\n                            external: [\r\n                                'electron',\r\n                                'better-sqlite3',\r\n                                'node-pty',\r\n                                'simple-git',\r\n                                'node-llama-cpp',\r\n                                'chokidar'\r\n                            ],\r\n                            // Inject obfuscator specifically for Electron build too\r\n                            plugins: [\r\n                                shouldObfuscate ? obfuscator({\r\n                                    include: PROPRIETARY_FILES,\r\n                                    ...HEAVY_OBFUSCATION_OPTIONS,\r\n                                    target: 'node'\r\n                                }) : null\r\n                            ]\r\n                        }\r\n                    }\r\n                }\r\n            },\r\n            preload: {\r\n                input: 'electron/preload.ts',\r\n                vite: {\r\n                    build: {\r\n                        outDir: 'dist-electron',\r\n                        minify: isProduction ? 'terser' : false,\r\n                        terserOptions: isProduction ? {\r\n                            mangle: { toplevel: true },\r\n                            compress: {\r\n                                drop_console: true,\r\n                                drop_debugger: true\r\n                            },\r\n                            format: { comments: false }\r\n                        } : undefined\r\n                    }\r\n                }\r\n            },\r\n            renderer: {}\r\n        })\r\n    ],\r\n    resolve: {\r\n        alias: {\r\n            '@': path.resolve(__dirname, './src'),\r\n            '@collabforge/crdt': path.resolve(__dirname, '../../packages/crdt/src'),\r\n            '@collabforge/networking': path.resolve(__dirname, '../../packages/networking/src'),\r\n            '@collabforge/crypto': path.resolve(__dirname, '../../packages/crypto/src'),\r\n            '@collabforge/shared': path.resolve(__dirname, '../../packages/shared/src')\r\n        }\r\n    },\r\n    optimizeDeps: {\r\n        include: ['react-window', 'lodash.debounce']\r\n    },\r\n    build: {\r\n        rollupOptions: {\r\n            external: ['better-sqlite3'],\r\n            output: {\r\n                // Mangle chunk names in production\r\n                chunkFileNames: isProduction ? 'assets/[hash].js' : 'assets/[name]-[hash].js',\r\n                entryFileNames: isProduction ? 'assets/[hash].js' : 'assets/[name]-[hash].js',\r\n                assetFileNames: isProduction ? 'assets/[hash][extname]' : 'assets/[name]-[hash][extname]'\r\n            }\r\n        },\r\n        // Use terser for React bundle\r\n        minify: isProduction ? 'terser' : 'esbuild',\r\n        terserOptions: isProduction ? {\r\n            mangle: {\r\n                toplevel: true\r\n            },\r\n            compress: {\r\n                drop_console: true,\r\n                drop_debugger: true,\r\n                passes: 2\r\n            },\r\n            format: {\r\n                comments: false\r\n            }\r\n        } : undefined,\r\n        // Never generate source maps in production\r\n        sourcemap: !isProduction\r\n    },\r\n    // Drop console.* and debugger statements in production builds\r\n    esbuild: isProduction ? {\r\n        drop: ['console', 'debugger'],\r\n        legalComments: 'none'\r\n    } : {}\r\n})\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]}]